var v7=Object.defineProperty;var R7=(s,c,h)=>c in s?v7(s,c,{enumerable:!0,configurable:!0,writable:!0,value:h}):s[c]=h;var lh=(s,c,h)=>(R7(s,typeof c!="symbol"?c+"":c,h),h);(function(){const c=document.createElement("link").relList;if(c&&c.supports&&c.supports("modulepreload"))return;for(const g of document.querySelectorAll('link[rel="modulepreload"]'))_(g);new MutationObserver(g=>{for(const v of g)if(v.type==="childList")for(const b of v.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&_(b)}).observe(document,{childList:!0,subtree:!0});function h(g){const v={};return g.integrity&&(v.integrity=g.integrity),g.referrerPolicy&&(v.referrerPolicy=g.referrerPolicy),g.crossOrigin==="use-credentials"?v.credentials="include":g.crossOrigin==="anonymous"?v.credentials="omit":v.credentials="same-origin",v}function _(g){if(g.ep)return;g.ep=!0;const v=h(g);fetch(g.href,v)}})();function C7(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var JU={exports:{}},Lf={},XU={exports:{}},It={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Xh=Symbol.for("react.element"),y7=Symbol.for("react.portal"),I7=Symbol.for("react.fragment"),w7=Symbol.for("react.strict_mode"),A7=Symbol.for("react.profiler"),O7=Symbol.for("react.provider"),b7=Symbol.for("react.context"),N7=Symbol.for("react.forward_ref"),D7=Symbol.for("react.suspense"),P7=Symbol.for("react.memo"),k7=Symbol.for("react.lazy"),FM=Symbol.iterator;function L7(s){return s===null||typeof s!="object"?null:(s=FM&&s[FM]||s["@@iterator"],typeof s=="function"?s:null)}var QU={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},ZU=Object.assign,$U={};function xd(s,c,h){this.props=s,this.context=c,this.refs=$U,this.updater=h||QU}xd.prototype.isReactComponent={};xd.prototype.setState=function(s,c){if(typeof s!="object"&&typeof s!="function"&&s!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,s,c,"setState")};xd.prototype.forceUpdate=function(s){this.updater.enqueueForceUpdate(this,s,"forceUpdate")};function e2(){}e2.prototype=xd.prototype;function dC(s,c,h){this.props=s,this.context=c,this.refs=$U,this.updater=h||QU}var uC=dC.prototype=new e2;uC.constructor=dC;ZU(uC,xd.prototype);uC.isPureReactComponent=!0;var jM=Array.isArray,t2=Object.prototype.hasOwnProperty,hC={current:null},i2={key:!0,ref:!0,__self:!0,__source:!0};function r2(s,c,h){var _,g={},v=null,b=null;if(c!=null)for(_ in c.ref!==void 0&&(b=c.ref),c.key!==void 0&&(v=""+c.key),c)t2.call(c,_)&&!i2.hasOwnProperty(_)&&(g[_]=c[_]);var L=arguments.length-2;if(L===1)g.children=h;else if(1<L){for(var x=Array(L),W=0;W<L;W++)x[W]=arguments[W+2];g.children=x}if(s&&s.defaultProps)for(_ in L=s.defaultProps,L)g[_]===void 0&&(g[_]=L[_]);return{$$typeof:Xh,type:s,key:v,ref:b,props:g,_owner:hC.current}}function M7(s,c){return{$$typeof:Xh,type:s.type,key:c,ref:s.ref,props:s.props,_owner:s._owner}}function pC(s){return typeof s=="object"&&s!==null&&s.$$typeof===Xh}function U7(s){var c={"=":"=0",":":"=2"};return"$"+s.replace(/[=:]/g,function(h){return c[h]})}var BM=/\/+/g;function Hv(s,c){return typeof s=="object"&&s!==null&&s.key!=null?U7(""+s.key):c.toString(36)}function J_(s,c,h,_,g){var v=typeof s;(v==="undefined"||v==="boolean")&&(s=null);var b=!1;if(s===null)b=!0;else switch(v){case"string":case"number":b=!0;break;case"object":switch(s.$$typeof){case Xh:case y7:b=!0}}if(b)return b=s,g=g(b),s=_===""?"."+Hv(b,0):_,jM(g)?(h="",s!=null&&(h=s.replace(BM,"$&/")+"/"),J_(g,c,h,"",function(W){return W})):g!=null&&(pC(g)&&(g=M7(g,h+(!g.key||b&&b.key===g.key?"":(""+g.key).replace(BM,"$&/")+"/")+s)),c.push(g)),1;if(b=0,_=_===""?".":_+":",jM(s))for(var L=0;L<s.length;L++){v=s[L];var x=_+Hv(v,L);b+=J_(v,c,h,x,g)}else if(x=L7(s),typeof x=="function")for(s=x.call(s),L=0;!(v=s.next()).done;)v=v.value,x=_+Hv(v,L++),b+=J_(v,c,h,x,g);else if(v==="object")throw c=String(s),Error("Objects are not valid as a React child (found: "+(c==="[object Object]"?"object with keys {"+Object.keys(s).join(", ")+"}":c)+"). If you meant to render a collection of children, use an array instead.");return b}function P_(s,c,h){if(s==null)return s;var _=[],g=0;return J_(s,_,"","",function(v){return c.call(h,v,g++)}),_}function x7(s){if(s._status===-1){var c=s._result;c=c(),c.then(function(h){(s._status===0||s._status===-1)&&(s._status=1,s._result=h)},function(h){(s._status===0||s._status===-1)&&(s._status=2,s._result=h)}),s._status===-1&&(s._status=0,s._result=c)}if(s._status===1)return s._result.default;throw s._result}var Hr={current:null},X_={transition:null},V7={ReactCurrentDispatcher:Hr,ReactCurrentBatchConfig:X_,ReactCurrentOwner:hC};function n2(){throw Error("act(...) is not supported in production builds of React.")}It.Children={map:P_,forEach:function(s,c,h){P_(s,function(){c.apply(this,arguments)},h)},count:function(s){var c=0;return P_(s,function(){c++}),c},toArray:function(s){return P_(s,function(c){return c})||[]},only:function(s){if(!pC(s))throw Error("React.Children.only expected to receive a single React element child.");return s}};It.Component=xd;It.Fragment=I7;It.Profiler=A7;It.PureComponent=dC;It.StrictMode=w7;It.Suspense=D7;It.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=V7;It.act=n2;It.cloneElement=function(s,c,h){if(s==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+s+".");var _=ZU({},s.props),g=s.key,v=s.ref,b=s._owner;if(c!=null){if(c.ref!==void 0&&(v=c.ref,b=hC.current),c.key!==void 0&&(g=""+c.key),s.type&&s.type.defaultProps)var L=s.type.defaultProps;for(x in c)t2.call(c,x)&&!i2.hasOwnProperty(x)&&(_[x]=c[x]===void 0&&L!==void 0?L[x]:c[x])}var x=arguments.length-2;if(x===1)_.children=h;else if(1<x){L=Array(x);for(var W=0;W<x;W++)L[W]=arguments[W+2];_.children=L}return{$$typeof:Xh,type:s.type,key:g,ref:v,props:_,_owner:b}};It.createContext=function(s){return s={$$typeof:b7,_currentValue:s,_currentValue2:s,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},s.Provider={$$typeof:O7,_context:s},s.Consumer=s};It.createElement=r2;It.createFactory=function(s){var c=r2.bind(null,s);return c.type=s,c};It.createRef=function(){return{current:null}};It.forwardRef=function(s){return{$$typeof:N7,render:s}};It.isValidElement=pC;It.lazy=function(s){return{$$typeof:k7,_payload:{_status:-1,_result:s},_init:x7}};It.memo=function(s,c){return{$$typeof:P7,type:s,compare:c===void 0?null:c}};It.startTransition=function(s){var c=X_.transition;X_.transition={};try{s()}finally{X_.transition=c}};It.unstable_act=n2;It.useCallback=function(s,c){return Hr.current.useCallback(s,c)};It.useContext=function(s){return Hr.current.useContext(s)};It.useDebugValue=function(){};It.useDeferredValue=function(s){return Hr.current.useDeferredValue(s)};It.useEffect=function(s,c){return Hr.current.useEffect(s,c)};It.useId=function(){return Hr.current.useId()};It.useImperativeHandle=function(s,c,h){return Hr.current.useImperativeHandle(s,c,h)};It.useInsertionEffect=function(s,c){return Hr.current.useInsertionEffect(s,c)};It.useLayoutEffect=function(s,c){return Hr.current.useLayoutEffect(s,c)};It.useMemo=function(s,c){return Hr.current.useMemo(s,c)};It.useReducer=function(s,c,h){return Hr.current.useReducer(s,c,h)};It.useRef=function(s){return Hr.current.useRef(s)};It.useState=function(s){return Hr.current.useState(s)};It.useSyncExternalStore=function(s,c,h){return Hr.current.useSyncExternalStore(s,c,h)};It.useTransition=function(){return Hr.current.useTransition()};It.version="18.3.1";XU.exports=It;var Ie=XU.exports;const F7=C7(Ie);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var j7=Ie,B7=Symbol.for("react.element"),G7=Symbol.for("react.fragment"),W7=Object.prototype.hasOwnProperty,H7=j7.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,K7={key:!0,ref:!0,__self:!0,__source:!0};function o2(s,c,h){var _,g={},v=null,b=null;h!==void 0&&(v=""+h),c.key!==void 0&&(v=""+c.key),c.ref!==void 0&&(b=c.ref);for(_ in c)W7.call(c,_)&&!K7.hasOwnProperty(_)&&(g[_]=c[_]);if(s&&s.defaultProps)for(_ in c=s.defaultProps,c)g[_]===void 0&&(g[_]=c[_]);return{$$typeof:B7,type:s,key:v,ref:b,props:g,_owner:H7.current}}Lf.Fragment=G7;Lf.jsx=o2;Lf.jsxs=o2;JU.exports=Lf;var $e=JU.exports,fR={},s2={exports:{}},On={},a2={exports:{}},c2={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(s){function c(Ne,Le){var lt=Ne.length;Ne.push(Le);e:for(;0<lt;){var Si=lt-1>>>1,Vi=Ne[Si];if(0<g(Vi,Le))Ne[Si]=Le,Ne[lt]=Vi,lt=Si;else break e}}function h(Ne){return Ne.length===0?null:Ne[0]}function _(Ne){if(Ne.length===0)return null;var Le=Ne[0],lt=Ne.pop();if(lt!==Le){Ne[0]=lt;e:for(var Si=0,Vi=Ne.length,Yc=Vi>>>1;Si<Yc;){var gr=2*(Si+1)-1,Us=Ne[gr],Sr=gr+1,qc=Ne[Sr];if(0>g(Us,lt))Sr<Vi&&0>g(qc,Us)?(Ne[Si]=qc,Ne[Sr]=lt,Si=Sr):(Ne[Si]=Us,Ne[gr]=lt,Si=gr);else if(Sr<Vi&&0>g(qc,lt))Ne[Si]=qc,Ne[Sr]=lt,Si=Sr;else break e}}return Le}function g(Ne,Le){var lt=Ne.sortIndex-Le.sortIndex;return lt!==0?lt:Ne.id-Le.id}if(typeof performance=="object"&&typeof performance.now=="function"){var v=performance;s.unstable_now=function(){return v.now()}}else{var b=Date,L=b.now();s.unstable_now=function(){return b.now()-L}}var x=[],W=[],ee=1,K=null,$=3,ge=!1,le=!1,X=!1,ve=typeof setTimeout=="function"?setTimeout:null,H=typeof clearTimeout=="function"?clearTimeout:null,G=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function q(Ne){for(var Le=h(W);Le!==null;){if(Le.callback===null)_(W);else if(Le.startTime<=Ne)_(W),Le.sortIndex=Le.expirationTime,c(x,Le);else break;Le=h(W)}}function Ee(Ne){if(X=!1,q(Ne),!le)if(h(x)!==null)le=!0,dr(we);else{var Le=h(W);Le!==null&&jd(Ee,Le.startTime-Ne)}}function we(Ne,Le){le=!1,X&&(X=!1,H(ze),ze=-1),ge=!0;var lt=$;try{for(q(Le),K=h(x);K!==null&&(!(K.expirationTime>Le)||Ne&&!kr());){var Si=K.callback;if(typeof Si=="function"){K.callback=null,$=K.priorityLevel;var Vi=Si(K.expirationTime<=Le);Le=s.unstable_now(),typeof Vi=="function"?K.callback=Vi:K===h(x)&&_(x),q(Le)}else _(x);K=h(x)}if(K!==null)var Yc=!0;else{var gr=h(W);gr!==null&&jd(Ee,gr.startTime-Le),Yc=!1}return Yc}finally{K=null,$=lt,ge=!1}}var Fe=!1,De=null,ze=-1,wi=5,pt=-1;function kr(){return!(s.unstable_now()-pt<wi)}function Po(){if(De!==null){var Ne=s.unstable_now();pt=Ne;var Le=!0;try{Le=De(!0,Ne)}finally{Le?Ga():(Fe=!1,De=null)}}else Fe=!1}var Ga;if(typeof G=="function")Ga=function(){G(Po)};else if(typeof MessageChannel<"u"){var ui=new MessageChannel,Wa=ui.port2;ui.port1.onmessage=Po,Ga=function(){Wa.postMessage(null)}}else Ga=function(){ve(Po,0)};function dr(Ne){De=Ne,Fe||(Fe=!0,Ga())}function jd(Ne,Le){ze=ve(function(){Ne(s.unstable_now())},Le)}s.unstable_IdlePriority=5,s.unstable_ImmediatePriority=1,s.unstable_LowPriority=4,s.unstable_NormalPriority=3,s.unstable_Profiling=null,s.unstable_UserBlockingPriority=2,s.unstable_cancelCallback=function(Ne){Ne.callback=null},s.unstable_continueExecution=function(){le||ge||(le=!0,dr(we))},s.unstable_forceFrameRate=function(Ne){0>Ne||125<Ne?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):wi=0<Ne?Math.floor(1e3/Ne):5},s.unstable_getCurrentPriorityLevel=function(){return $},s.unstable_getFirstCallbackNode=function(){return h(x)},s.unstable_next=function(Ne){switch($){case 1:case 2:case 3:var Le=3;break;default:Le=$}var lt=$;$=Le;try{return Ne()}finally{$=lt}},s.unstable_pauseExecution=function(){},s.unstable_requestPaint=function(){},s.unstable_runWithPriority=function(Ne,Le){switch(Ne){case 1:case 2:case 3:case 4:case 5:break;default:Ne=3}var lt=$;$=Ne;try{return Le()}finally{$=lt}},s.unstable_scheduleCallback=function(Ne,Le,lt){var Si=s.unstable_now();switch(typeof lt=="object"&&lt!==null?(lt=lt.delay,lt=typeof lt=="number"&&0<lt?Si+lt:Si):lt=Si,Ne){case 1:var Vi=-1;break;case 2:Vi=250;break;case 5:Vi=1073741823;break;case 4:Vi=1e4;break;default:Vi=5e3}return Vi=lt+Vi,Ne={id:ee++,callback:Le,priorityLevel:Ne,startTime:lt,expirationTime:Vi,sortIndex:-1},lt>Si?(Ne.sortIndex=lt,c(W,Ne),h(x)===null&&Ne===h(W)&&(X?(H(ze),ze=-1):X=!0,jd(Ee,lt-Si))):(Ne.sortIndex=Vi,c(x,Ne),le||ge||(le=!0,dr(we))),Ne},s.unstable_shouldYield=kr,s.unstable_wrapCallback=function(Ne){var Le=$;return function(){var lt=$;$=Le;try{return Ne.apply(this,arguments)}finally{$=lt}}}})(c2);a2.exports=c2;var z7=a2.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Y7=Ie,An=z7;function Te(s){for(var c="https://reactjs.org/docs/error-decoder.html?invariant="+s,h=1;h<arguments.length;h++)c+="&args[]="+encodeURIComponent(arguments[h]);return"Minified React error #"+s+"; visit "+c+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var l2=new Set,kh={};function Bc(s,c){Nd(s,c),Nd(s+"Capture",c)}function Nd(s,c){for(kh[s]=c,s=0;s<c.length;s++)l2.add(c[s])}var Ns=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),ER=Object.prototype.hasOwnProperty,q7=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,GM={},WM={};function J7(s){return ER.call(WM,s)?!0:ER.call(GM,s)?!1:q7.test(s)?WM[s]=!0:(GM[s]=!0,!1)}function X7(s,c,h,_){if(h!==null&&h.type===0)return!1;switch(typeof c){case"function":case"symbol":return!0;case"boolean":return _?!1:h!==null?!h.acceptsBooleans:(s=s.toLowerCase().slice(0,5),s!=="data-"&&s!=="aria-");default:return!1}}function Q7(s,c,h,_){if(c===null||typeof c>"u"||X7(s,c,h,_))return!0;if(_)return!1;if(h!==null)switch(h.type){case 3:return!c;case 4:return c===!1;case 5:return isNaN(c);case 6:return isNaN(c)||1>c}return!1}function Kr(s,c,h,_,g,v,b){this.acceptsBooleans=c===2||c===3||c===4,this.attributeName=_,this.attributeNamespace=g,this.mustUseProperty=h,this.propertyName=s,this.type=c,this.sanitizeURL=v,this.removeEmptyString=b}var Er={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(s){Er[s]=new Kr(s,0,!1,s,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(s){var c=s[0];Er[c]=new Kr(c,1,!1,s[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(s){Er[s]=new Kr(s,2,!1,s.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(s){Er[s]=new Kr(s,2,!1,s,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(s){Er[s]=new Kr(s,3,!1,s.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(s){Er[s]=new Kr(s,3,!0,s,null,!1,!1)});["capture","download"].forEach(function(s){Er[s]=new Kr(s,4,!1,s,null,!1,!1)});["cols","rows","size","span"].forEach(function(s){Er[s]=new Kr(s,6,!1,s,null,!1,!1)});["rowSpan","start"].forEach(function(s){Er[s]=new Kr(s,5,!1,s.toLowerCase(),null,!1,!1)});var mC=/[\-:]([a-z])/g;function _C(s){return s[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(s){var c=s.replace(mC,_C);Er[c]=new Kr(c,1,!1,s,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(s){var c=s.replace(mC,_C);Er[c]=new Kr(c,1,!1,s,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(s){var c=s.replace(mC,_C);Er[c]=new Kr(c,1,!1,s,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(s){Er[s]=new Kr(s,1,!1,s.toLowerCase(),null,!1,!1)});Er.xlinkHref=new Kr("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(s){Er[s]=new Kr(s,1,!1,s.toLowerCase(),null,!0,!0)});function fC(s,c,h,_){var g=Er.hasOwnProperty(c)?Er[c]:null;(g!==null?g.type!==0:_||!(2<c.length)||c[0]!=="o"&&c[0]!=="O"||c[1]!=="n"&&c[1]!=="N")&&(Q7(c,h,g,_)&&(h=null),_||g===null?J7(c)&&(h===null?s.removeAttribute(c):s.setAttribute(c,""+h)):g.mustUseProperty?s[g.propertyName]=h===null?g.type===3?!1:"":h:(c=g.attributeName,_=g.attributeNamespace,h===null?s.removeAttribute(c):(g=g.type,h=g===3||g===4&&h===!0?"":""+h,_?s.setAttributeNS(_,c,h):s.setAttribute(c,h))))}var Ls=Y7.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,k_=Symbol.for("react.element"),hd=Symbol.for("react.portal"),pd=Symbol.for("react.fragment"),EC=Symbol.for("react.strict_mode"),gR=Symbol.for("react.profiler"),d2=Symbol.for("react.provider"),u2=Symbol.for("react.context"),gC=Symbol.for("react.forward_ref"),SR=Symbol.for("react.suspense"),TR=Symbol.for("react.suspense_list"),SC=Symbol.for("react.memo"),Ra=Symbol.for("react.lazy"),h2=Symbol.for("react.offscreen"),HM=Symbol.iterator;function dh(s){return s===null||typeof s!="object"?null:(s=HM&&s[HM]||s["@@iterator"],typeof s=="function"?s:null)}var Di=Object.assign,Kv;function gh(s){if(Kv===void 0)try{throw Error()}catch(h){var c=h.stack.trim().match(/\n( *(at )?)/);Kv=c&&c[1]||""}return`
`+Kv+s}var zv=!1;function Yv(s,c){if(!s||zv)return"";zv=!0;var h=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(c)if(c=function(){throw Error()},Object.defineProperty(c.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(c,[])}catch(W){var _=W}Reflect.construct(s,[],c)}else{try{c.call()}catch(W){_=W}s.call(c.prototype)}else{try{throw Error()}catch(W){_=W}s()}}catch(W){if(W&&_&&typeof W.stack=="string"){for(var g=W.stack.split(`
`),v=_.stack.split(`
`),b=g.length-1,L=v.length-1;1<=b&&0<=L&&g[b]!==v[L];)L--;for(;1<=b&&0<=L;b--,L--)if(g[b]!==v[L]){if(b!==1||L!==1)do if(b--,L--,0>L||g[b]!==v[L]){var x=`
`+g[b].replace(" at new "," at ");return s.displayName&&x.includes("<anonymous>")&&(x=x.replace("<anonymous>",s.displayName)),x}while(1<=b&&0<=L);break}}}finally{zv=!1,Error.prepareStackTrace=h}return(s=s?s.displayName||s.name:"")?gh(s):""}function Z7(s){switch(s.tag){case 5:return gh(s.type);case 16:return gh("Lazy");case 13:return gh("Suspense");case 19:return gh("SuspenseList");case 0:case 2:case 15:return s=Yv(s.type,!1),s;case 11:return s=Yv(s.type.render,!1),s;case 1:return s=Yv(s.type,!0),s;default:return""}}function vR(s){if(s==null)return null;if(typeof s=="function")return s.displayName||s.name||null;if(typeof s=="string")return s;switch(s){case pd:return"Fragment";case hd:return"Portal";case gR:return"Profiler";case EC:return"StrictMode";case SR:return"Suspense";case TR:return"SuspenseList"}if(typeof s=="object")switch(s.$$typeof){case u2:return(s.displayName||"Context")+".Consumer";case d2:return(s._context.displayName||"Context")+".Provider";case gC:var c=s.render;return s=s.displayName,s||(s=c.displayName||c.name||"",s=s!==""?"ForwardRef("+s+")":"ForwardRef"),s;case SC:return c=s.displayName||null,c!==null?c:vR(s.type)||"Memo";case Ra:c=s._payload,s=s._init;try{return vR(s(c))}catch{}}return null}function $7(s){var c=s.type;switch(s.tag){case 24:return"Cache";case 9:return(c.displayName||"Context")+".Consumer";case 10:return(c._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return s=c.render,s=s.displayName||s.name||"",c.displayName||(s!==""?"ForwardRef("+s+")":"ForwardRef");case 7:return"Fragment";case 5:return c;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return vR(c);case 8:return c===EC?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof c=="function")return c.displayName||c.name||null;if(typeof c=="string")return c}return null}function Ua(s){switch(typeof s){case"boolean":case"number":case"string":case"undefined":return s;case"object":return s;default:return""}}function p2(s){var c=s.type;return(s=s.nodeName)&&s.toLowerCase()==="input"&&(c==="checkbox"||c==="radio")}function eJ(s){var c=p2(s)?"checked":"value",h=Object.getOwnPropertyDescriptor(s.constructor.prototype,c),_=""+s[c];if(!s.hasOwnProperty(c)&&typeof h<"u"&&typeof h.get=="function"&&typeof h.set=="function"){var g=h.get,v=h.set;return Object.defineProperty(s,c,{configurable:!0,get:function(){return g.call(this)},set:function(b){_=""+b,v.call(this,b)}}),Object.defineProperty(s,c,{enumerable:h.enumerable}),{getValue:function(){return _},setValue:function(b){_=""+b},stopTracking:function(){s._valueTracker=null,delete s[c]}}}}function L_(s){s._valueTracker||(s._valueTracker=eJ(s))}function m2(s){if(!s)return!1;var c=s._valueTracker;if(!c)return!0;var h=c.getValue(),_="";return s&&(_=p2(s)?s.checked?"true":"false":s.value),s=_,s!==h?(c.setValue(s),!0):!1}function df(s){if(s=s||(typeof document<"u"?document:void 0),typeof s>"u")return null;try{return s.activeElement||s.body}catch{return s.body}}function RR(s,c){var h=c.checked;return Di({},c,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:h??s._wrapperState.initialChecked})}function KM(s,c){var h=c.defaultValue==null?"":c.defaultValue,_=c.checked!=null?c.checked:c.defaultChecked;h=Ua(c.value!=null?c.value:h),s._wrapperState={initialChecked:_,initialValue:h,controlled:c.type==="checkbox"||c.type==="radio"?c.checked!=null:c.value!=null}}function _2(s,c){c=c.checked,c!=null&&fC(s,"checked",c,!1)}function CR(s,c){_2(s,c);var h=Ua(c.value),_=c.type;if(h!=null)_==="number"?(h===0&&s.value===""||s.value!=h)&&(s.value=""+h):s.value!==""+h&&(s.value=""+h);else if(_==="submit"||_==="reset"){s.removeAttribute("value");return}c.hasOwnProperty("value")?yR(s,c.type,h):c.hasOwnProperty("defaultValue")&&yR(s,c.type,Ua(c.defaultValue)),c.checked==null&&c.defaultChecked!=null&&(s.defaultChecked=!!c.defaultChecked)}function zM(s,c,h){if(c.hasOwnProperty("value")||c.hasOwnProperty("defaultValue")){var _=c.type;if(!(_!=="submit"&&_!=="reset"||c.value!==void 0&&c.value!==null))return;c=""+s._wrapperState.initialValue,h||c===s.value||(s.value=c),s.defaultValue=c}h=s.name,h!==""&&(s.name=""),s.defaultChecked=!!s._wrapperState.initialChecked,h!==""&&(s.name=h)}function yR(s,c,h){(c!=="number"||df(s.ownerDocument)!==s)&&(h==null?s.defaultValue=""+s._wrapperState.initialValue:s.defaultValue!==""+h&&(s.defaultValue=""+h))}var Sh=Array.isArray;function yd(s,c,h,_){if(s=s.options,c){c={};for(var g=0;g<h.length;g++)c["$"+h[g]]=!0;for(h=0;h<s.length;h++)g=c.hasOwnProperty("$"+s[h].value),s[h].selected!==g&&(s[h].selected=g),g&&_&&(s[h].defaultSelected=!0)}else{for(h=""+Ua(h),c=null,g=0;g<s.length;g++){if(s[g].value===h){s[g].selected=!0,_&&(s[g].defaultSelected=!0);return}c!==null||s[g].disabled||(c=s[g])}c!==null&&(c.selected=!0)}}function IR(s,c){if(c.dangerouslySetInnerHTML!=null)throw Error(Te(91));return Di({},c,{value:void 0,defaultValue:void 0,children:""+s._wrapperState.initialValue})}function YM(s,c){var h=c.value;if(h==null){if(h=c.children,c=c.defaultValue,h!=null){if(c!=null)throw Error(Te(92));if(Sh(h)){if(1<h.length)throw Error(Te(93));h=h[0]}c=h}c==null&&(c=""),h=c}s._wrapperState={initialValue:Ua(h)}}function f2(s,c){var h=Ua(c.value),_=Ua(c.defaultValue);h!=null&&(h=""+h,h!==s.value&&(s.value=h),c.defaultValue==null&&s.defaultValue!==h&&(s.defaultValue=h)),_!=null&&(s.defaultValue=""+_)}function qM(s){var c=s.textContent;c===s._wrapperState.initialValue&&c!==""&&c!==null&&(s.value=c)}function E2(s){switch(s){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function wR(s,c){return s==null||s==="http://www.w3.org/1999/xhtml"?E2(c):s==="http://www.w3.org/2000/svg"&&c==="foreignObject"?"http://www.w3.org/1999/xhtml":s}var M_,g2=function(s){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(c,h,_,g){MSApp.execUnsafeLocalFunction(function(){return s(c,h,_,g)})}:s}(function(s,c){if(s.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in s)s.innerHTML=c;else{for(M_=M_||document.createElement("div"),M_.innerHTML="<svg>"+c.valueOf().toString()+"</svg>",c=M_.firstChild;s.firstChild;)s.removeChild(s.firstChild);for(;c.firstChild;)s.appendChild(c.firstChild)}});function Lh(s,c){if(c){var h=s.firstChild;if(h&&h===s.lastChild&&h.nodeType===3){h.nodeValue=c;return}}s.textContent=c}var yh={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},tJ=["Webkit","ms","Moz","O"];Object.keys(yh).forEach(function(s){tJ.forEach(function(c){c=c+s.charAt(0).toUpperCase()+s.substring(1),yh[c]=yh[s]})});function S2(s,c,h){return c==null||typeof c=="boolean"||c===""?"":h||typeof c!="number"||c===0||yh.hasOwnProperty(s)&&yh[s]?(""+c).trim():c+"px"}function T2(s,c){s=s.style;for(var h in c)if(c.hasOwnProperty(h)){var _=h.indexOf("--")===0,g=S2(h,c[h],_);h==="float"&&(h="cssFloat"),_?s.setProperty(h,g):s[h]=g}}var iJ=Di({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function AR(s,c){if(c){if(iJ[s]&&(c.children!=null||c.dangerouslySetInnerHTML!=null))throw Error(Te(137,s));if(c.dangerouslySetInnerHTML!=null){if(c.children!=null)throw Error(Te(60));if(typeof c.dangerouslySetInnerHTML!="object"||!("__html"in c.dangerouslySetInnerHTML))throw Error(Te(61))}if(c.style!=null&&typeof c.style!="object")throw Error(Te(62))}}function OR(s,c){if(s.indexOf("-")===-1)return typeof c.is=="string";switch(s){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var bR=null;function TC(s){return s=s.target||s.srcElement||window,s.correspondingUseElement&&(s=s.correspondingUseElement),s.nodeType===3?s.parentNode:s}var NR=null,Id=null,wd=null;function JM(s){if(s=$h(s)){if(typeof NR!="function")throw Error(Te(280));var c=s.stateNode;c&&(c=Ff(c),NR(s.stateNode,s.type,c))}}function v2(s){Id?wd?wd.push(s):wd=[s]:Id=s}function R2(){if(Id){var s=Id,c=wd;if(wd=Id=null,JM(s),c)for(s=0;s<c.length;s++)JM(c[s])}}function C2(s,c){return s(c)}function y2(){}var qv=!1;function I2(s,c,h){if(qv)return s(c,h);qv=!0;try{return C2(s,c,h)}finally{qv=!1,(Id!==null||wd!==null)&&(y2(),R2())}}function Mh(s,c){var h=s.stateNode;if(h===null)return null;var _=Ff(h);if(_===null)return null;h=_[c];e:switch(c){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(_=!_.disabled)||(s=s.type,_=!(s==="button"||s==="input"||s==="select"||s==="textarea")),s=!_;break e;default:s=!1}if(s)return null;if(h&&typeof h!="function")throw Error(Te(231,c,typeof h));return h}var DR=!1;if(Ns)try{var uh={};Object.defineProperty(uh,"passive",{get:function(){DR=!0}}),window.addEventListener("test",uh,uh),window.removeEventListener("test",uh,uh)}catch{DR=!1}function rJ(s,c,h,_,g,v,b,L,x){var W=Array.prototype.slice.call(arguments,3);try{c.apply(h,W)}catch(ee){this.onError(ee)}}var Ih=!1,uf=null,hf=!1,PR=null,nJ={onError:function(s){Ih=!0,uf=s}};function oJ(s,c,h,_,g,v,b,L,x){Ih=!1,uf=null,rJ.apply(nJ,arguments)}function sJ(s,c,h,_,g,v,b,L,x){if(oJ.apply(this,arguments),Ih){if(Ih){var W=uf;Ih=!1,uf=null}else throw Error(Te(198));hf||(hf=!0,PR=W)}}function Gc(s){var c=s,h=s;if(s.alternate)for(;c.return;)c=c.return;else{s=c;do c=s,c.flags&4098&&(h=c.return),s=c.return;while(s)}return c.tag===3?h:null}function w2(s){if(s.tag===13){var c=s.memoizedState;if(c===null&&(s=s.alternate,s!==null&&(c=s.memoizedState)),c!==null)return c.dehydrated}return null}function XM(s){if(Gc(s)!==s)throw Error(Te(188))}function aJ(s){var c=s.alternate;if(!c){if(c=Gc(s),c===null)throw Error(Te(188));return c!==s?null:s}for(var h=s,_=c;;){var g=h.return;if(g===null)break;var v=g.alternate;if(v===null){if(_=g.return,_!==null){h=_;continue}break}if(g.child===v.child){for(v=g.child;v;){if(v===h)return XM(g),s;if(v===_)return XM(g),c;v=v.sibling}throw Error(Te(188))}if(h.return!==_.return)h=g,_=v;else{for(var b=!1,L=g.child;L;){if(L===h){b=!0,h=g,_=v;break}if(L===_){b=!0,_=g,h=v;break}L=L.sibling}if(!b){for(L=v.child;L;){if(L===h){b=!0,h=v,_=g;break}if(L===_){b=!0,_=v,h=g;break}L=L.sibling}if(!b)throw Error(Te(189))}}if(h.alternate!==_)throw Error(Te(190))}if(h.tag!==3)throw Error(Te(188));return h.stateNode.current===h?s:c}function A2(s){return s=aJ(s),s!==null?O2(s):null}function O2(s){if(s.tag===5||s.tag===6)return s;for(s=s.child;s!==null;){var c=O2(s);if(c!==null)return c;s=s.sibling}return null}var b2=An.unstable_scheduleCallback,QM=An.unstable_cancelCallback,cJ=An.unstable_shouldYield,lJ=An.unstable_requestPaint,Wi=An.unstable_now,dJ=An.unstable_getCurrentPriorityLevel,vC=An.unstable_ImmediatePriority,N2=An.unstable_UserBlockingPriority,pf=An.unstable_NormalPriority,uJ=An.unstable_LowPriority,D2=An.unstable_IdlePriority,Mf=null,ss=null;function hJ(s){if(ss&&typeof ss.onCommitFiberRoot=="function")try{ss.onCommitFiberRoot(Mf,s,void 0,(s.current.flags&128)===128)}catch{}}var Oo=Math.clz32?Math.clz32:_J,pJ=Math.log,mJ=Math.LN2;function _J(s){return s>>>=0,s===0?32:31-(pJ(s)/mJ|0)|0}var U_=64,x_=4194304;function Th(s){switch(s&-s){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return s&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return s&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return s}}function mf(s,c){var h=s.pendingLanes;if(h===0)return 0;var _=0,g=s.suspendedLanes,v=s.pingedLanes,b=h&268435455;if(b!==0){var L=b&~g;L!==0?_=Th(L):(v&=b,v!==0&&(_=Th(v)))}else b=h&~g,b!==0?_=Th(b):v!==0&&(_=Th(v));if(_===0)return 0;if(c!==0&&c!==_&&!(c&g)&&(g=_&-_,v=c&-c,g>=v||g===16&&(v&4194240)!==0))return c;if(_&4&&(_|=h&16),c=s.entangledLanes,c!==0)for(s=s.entanglements,c&=_;0<c;)h=31-Oo(c),g=1<<h,_|=s[h],c&=~g;return _}function fJ(s,c){switch(s){case 1:case 2:case 4:return c+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return c+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function EJ(s,c){for(var h=s.suspendedLanes,_=s.pingedLanes,g=s.expirationTimes,v=s.pendingLanes;0<v;){var b=31-Oo(v),L=1<<b,x=g[b];x===-1?(!(L&h)||L&_)&&(g[b]=fJ(L,c)):x<=c&&(s.expiredLanes|=L),v&=~L}}function kR(s){return s=s.pendingLanes&-1073741825,s!==0?s:s&1073741824?1073741824:0}function P2(){var s=U_;return U_<<=1,!(U_&4194240)&&(U_=64),s}function Jv(s){for(var c=[],h=0;31>h;h++)c.push(s);return c}function Qh(s,c,h){s.pendingLanes|=c,c!==536870912&&(s.suspendedLanes=0,s.pingedLanes=0),s=s.eventTimes,c=31-Oo(c),s[c]=h}function gJ(s,c){var h=s.pendingLanes&~c;s.pendingLanes=c,s.suspendedLanes=0,s.pingedLanes=0,s.expiredLanes&=c,s.mutableReadLanes&=c,s.entangledLanes&=c,c=s.entanglements;var _=s.eventTimes;for(s=s.expirationTimes;0<h;){var g=31-Oo(h),v=1<<g;c[g]=0,_[g]=-1,s[g]=-1,h&=~v}}function RC(s,c){var h=s.entangledLanes|=c;for(s=s.entanglements;h;){var _=31-Oo(h),g=1<<_;g&c|s[_]&c&&(s[_]|=c),h&=~g}}var $t=0;function k2(s){return s&=-s,1<s?4<s?s&268435455?16:536870912:4:1}var L2,CC,M2,U2,x2,LR=!1,V_=[],Oa=null,ba=null,Na=null,Uh=new Map,xh=new Map,ya=[],SJ="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function ZM(s,c){switch(s){case"focusin":case"focusout":Oa=null;break;case"dragenter":case"dragleave":ba=null;break;case"mouseover":case"mouseout":Na=null;break;case"pointerover":case"pointerout":Uh.delete(c.pointerId);break;case"gotpointercapture":case"lostpointercapture":xh.delete(c.pointerId)}}function hh(s,c,h,_,g,v){return s===null||s.nativeEvent!==v?(s={blockedOn:c,domEventName:h,eventSystemFlags:_,nativeEvent:v,targetContainers:[g]},c!==null&&(c=$h(c),c!==null&&CC(c)),s):(s.eventSystemFlags|=_,c=s.targetContainers,g!==null&&c.indexOf(g)===-1&&c.push(g),s)}function TJ(s,c,h,_,g){switch(c){case"focusin":return Oa=hh(Oa,s,c,h,_,g),!0;case"dragenter":return ba=hh(ba,s,c,h,_,g),!0;case"mouseover":return Na=hh(Na,s,c,h,_,g),!0;case"pointerover":var v=g.pointerId;return Uh.set(v,hh(Uh.get(v)||null,s,c,h,_,g)),!0;case"gotpointercapture":return v=g.pointerId,xh.set(v,hh(xh.get(v)||null,s,c,h,_,g)),!0}return!1}function V2(s){var c=Dc(s.target);if(c!==null){var h=Gc(c);if(h!==null){if(c=h.tag,c===13){if(c=w2(h),c!==null){s.blockedOn=c,x2(s.priority,function(){M2(h)});return}}else if(c===3&&h.stateNode.current.memoizedState.isDehydrated){s.blockedOn=h.tag===3?h.stateNode.containerInfo:null;return}}}s.blockedOn=null}function Q_(s){if(s.blockedOn!==null)return!1;for(var c=s.targetContainers;0<c.length;){var h=MR(s.domEventName,s.eventSystemFlags,c[0],s.nativeEvent);if(h===null){h=s.nativeEvent;var _=new h.constructor(h.type,h);bR=_,h.target.dispatchEvent(_),bR=null}else return c=$h(h),c!==null&&CC(c),s.blockedOn=h,!1;c.shift()}return!0}function $M(s,c,h){Q_(s)&&h.delete(c)}function vJ(){LR=!1,Oa!==null&&Q_(Oa)&&(Oa=null),ba!==null&&Q_(ba)&&(ba=null),Na!==null&&Q_(Na)&&(Na=null),Uh.forEach($M),xh.forEach($M)}function ph(s,c){s.blockedOn===c&&(s.blockedOn=null,LR||(LR=!0,An.unstable_scheduleCallback(An.unstable_NormalPriority,vJ)))}function Vh(s){function c(g){return ph(g,s)}if(0<V_.length){ph(V_[0],s);for(var h=1;h<V_.length;h++){var _=V_[h];_.blockedOn===s&&(_.blockedOn=null)}}for(Oa!==null&&ph(Oa,s),ba!==null&&ph(ba,s),Na!==null&&ph(Na,s),Uh.forEach(c),xh.forEach(c),h=0;h<ya.length;h++)_=ya[h],_.blockedOn===s&&(_.blockedOn=null);for(;0<ya.length&&(h=ya[0],h.blockedOn===null);)V2(h),h.blockedOn===null&&ya.shift()}var Ad=Ls.ReactCurrentBatchConfig,_f=!0;function RJ(s,c,h,_){var g=$t,v=Ad.transition;Ad.transition=null;try{$t=1,yC(s,c,h,_)}finally{$t=g,Ad.transition=v}}function CJ(s,c,h,_){var g=$t,v=Ad.transition;Ad.transition=null;try{$t=4,yC(s,c,h,_)}finally{$t=g,Ad.transition=v}}function yC(s,c,h,_){if(_f){var g=MR(s,c,h,_);if(g===null)oR(s,c,_,ff,h),ZM(s,_);else if(TJ(g,s,c,h,_))_.stopPropagation();else if(ZM(s,_),c&4&&-1<SJ.indexOf(s)){for(;g!==null;){var v=$h(g);if(v!==null&&L2(v),v=MR(s,c,h,_),v===null&&oR(s,c,_,ff,h),v===g)break;g=v}g!==null&&_.stopPropagation()}else oR(s,c,_,null,h)}}var ff=null;function MR(s,c,h,_){if(ff=null,s=TC(_),s=Dc(s),s!==null)if(c=Gc(s),c===null)s=null;else if(h=c.tag,h===13){if(s=w2(c),s!==null)return s;s=null}else if(h===3){if(c.stateNode.current.memoizedState.isDehydrated)return c.tag===3?c.stateNode.containerInfo:null;s=null}else c!==s&&(s=null);return ff=s,null}function F2(s){switch(s){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(dJ()){case vC:return 1;case N2:return 4;case pf:case uJ:return 16;case D2:return 536870912;default:return 16}default:return 16}}var wa=null,IC=null,Z_=null;function j2(){if(Z_)return Z_;var s,c=IC,h=c.length,_,g="value"in wa?wa.value:wa.textContent,v=g.length;for(s=0;s<h&&c[s]===g[s];s++);var b=h-s;for(_=1;_<=b&&c[h-_]===g[v-_];_++);return Z_=g.slice(s,1<_?1-_:void 0)}function $_(s){var c=s.keyCode;return"charCode"in s?(s=s.charCode,s===0&&c===13&&(s=13)):s=c,s===10&&(s=13),32<=s||s===13?s:0}function F_(){return!0}function eU(){return!1}function bn(s){function c(h,_,g,v,b){this._reactName=h,this._targetInst=g,this.type=_,this.nativeEvent=v,this.target=b,this.currentTarget=null;for(var L in s)s.hasOwnProperty(L)&&(h=s[L],this[L]=h?h(v):v[L]);return this.isDefaultPrevented=(v.defaultPrevented!=null?v.defaultPrevented:v.returnValue===!1)?F_:eU,this.isPropagationStopped=eU,this}return Di(c.prototype,{preventDefault:function(){this.defaultPrevented=!0;var h=this.nativeEvent;h&&(h.preventDefault?h.preventDefault():typeof h.returnValue!="unknown"&&(h.returnValue=!1),this.isDefaultPrevented=F_)},stopPropagation:function(){var h=this.nativeEvent;h&&(h.stopPropagation?h.stopPropagation():typeof h.cancelBubble!="unknown"&&(h.cancelBubble=!0),this.isPropagationStopped=F_)},persist:function(){},isPersistent:F_}),c}var Vd={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(s){return s.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},wC=bn(Vd),Zh=Di({},Vd,{view:0,detail:0}),yJ=bn(Zh),Xv,Qv,mh,Uf=Di({},Zh,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:AC,button:0,buttons:0,relatedTarget:function(s){return s.relatedTarget===void 0?s.fromElement===s.srcElement?s.toElement:s.fromElement:s.relatedTarget},movementX:function(s){return"movementX"in s?s.movementX:(s!==mh&&(mh&&s.type==="mousemove"?(Xv=s.screenX-mh.screenX,Qv=s.screenY-mh.screenY):Qv=Xv=0,mh=s),Xv)},movementY:function(s){return"movementY"in s?s.movementY:Qv}}),tU=bn(Uf),IJ=Di({},Uf,{dataTransfer:0}),wJ=bn(IJ),AJ=Di({},Zh,{relatedTarget:0}),Zv=bn(AJ),OJ=Di({},Vd,{animationName:0,elapsedTime:0,pseudoElement:0}),bJ=bn(OJ),NJ=Di({},Vd,{clipboardData:function(s){return"clipboardData"in s?s.clipboardData:window.clipboardData}}),DJ=bn(NJ),PJ=Di({},Vd,{data:0}),iU=bn(PJ),kJ={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},LJ={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},MJ={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function UJ(s){var c=this.nativeEvent;return c.getModifierState?c.getModifierState(s):(s=MJ[s])?!!c[s]:!1}function AC(){return UJ}var xJ=Di({},Zh,{key:function(s){if(s.key){var c=kJ[s.key]||s.key;if(c!=="Unidentified")return c}return s.type==="keypress"?(s=$_(s),s===13?"Enter":String.fromCharCode(s)):s.type==="keydown"||s.type==="keyup"?LJ[s.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:AC,charCode:function(s){return s.type==="keypress"?$_(s):0},keyCode:function(s){return s.type==="keydown"||s.type==="keyup"?s.keyCode:0},which:function(s){return s.type==="keypress"?$_(s):s.type==="keydown"||s.type==="keyup"?s.keyCode:0}}),VJ=bn(xJ),FJ=Di({},Uf,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),rU=bn(FJ),jJ=Di({},Zh,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:AC}),BJ=bn(jJ),GJ=Di({},Vd,{propertyName:0,elapsedTime:0,pseudoElement:0}),WJ=bn(GJ),HJ=Di({},Uf,{deltaX:function(s){return"deltaX"in s?s.deltaX:"wheelDeltaX"in s?-s.wheelDeltaX:0},deltaY:function(s){return"deltaY"in s?s.deltaY:"wheelDeltaY"in s?-s.wheelDeltaY:"wheelDelta"in s?-s.wheelDelta:0},deltaZ:0,deltaMode:0}),KJ=bn(HJ),zJ=[9,13,27,32],OC=Ns&&"CompositionEvent"in window,wh=null;Ns&&"documentMode"in document&&(wh=document.documentMode);var YJ=Ns&&"TextEvent"in window&&!wh,B2=Ns&&(!OC||wh&&8<wh&&11>=wh),nU=String.fromCharCode(32),oU=!1;function G2(s,c){switch(s){case"keyup":return zJ.indexOf(c.keyCode)!==-1;case"keydown":return c.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function W2(s){return s=s.detail,typeof s=="object"&&"data"in s?s.data:null}var md=!1;function qJ(s,c){switch(s){case"compositionend":return W2(c);case"keypress":return c.which!==32?null:(oU=!0,nU);case"textInput":return s=c.data,s===nU&&oU?null:s;default:return null}}function JJ(s,c){if(md)return s==="compositionend"||!OC&&G2(s,c)?(s=j2(),Z_=IC=wa=null,md=!1,s):null;switch(s){case"paste":return null;case"keypress":if(!(c.ctrlKey||c.altKey||c.metaKey)||c.ctrlKey&&c.altKey){if(c.char&&1<c.char.length)return c.char;if(c.which)return String.fromCharCode(c.which)}return null;case"compositionend":return B2&&c.locale!=="ko"?null:c.data;default:return null}}var XJ={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function sU(s){var c=s&&s.nodeName&&s.nodeName.toLowerCase();return c==="input"?!!XJ[s.type]:c==="textarea"}function H2(s,c,h,_){v2(_),c=Ef(c,"onChange"),0<c.length&&(h=new wC("onChange","change",null,h,_),s.push({event:h,listeners:c}))}var Ah=null,Fh=null;function QJ(s){tx(s,0)}function xf(s){var c=Ed(s);if(m2(c))return s}function ZJ(s,c){if(s==="change")return c}var K2=!1;if(Ns){var $v;if(Ns){var eR="oninput"in document;if(!eR){var aU=document.createElement("div");aU.setAttribute("oninput","return;"),eR=typeof aU.oninput=="function"}$v=eR}else $v=!1;K2=$v&&(!document.documentMode||9<document.documentMode)}function cU(){Ah&&(Ah.detachEvent("onpropertychange",z2),Fh=Ah=null)}function z2(s){if(s.propertyName==="value"&&xf(Fh)){var c=[];H2(c,Fh,s,TC(s)),I2(QJ,c)}}function $J(s,c,h){s==="focusin"?(cU(),Ah=c,Fh=h,Ah.attachEvent("onpropertychange",z2)):s==="focusout"&&cU()}function eX(s){if(s==="selectionchange"||s==="keyup"||s==="keydown")return xf(Fh)}function tX(s,c){if(s==="click")return xf(c)}function iX(s,c){if(s==="input"||s==="change")return xf(c)}function rX(s,c){return s===c&&(s!==0||1/s===1/c)||s!==s&&c!==c}var No=typeof Object.is=="function"?Object.is:rX;function jh(s,c){if(No(s,c))return!0;if(typeof s!="object"||s===null||typeof c!="object"||c===null)return!1;var h=Object.keys(s),_=Object.keys(c);if(h.length!==_.length)return!1;for(_=0;_<h.length;_++){var g=h[_];if(!ER.call(c,g)||!No(s[g],c[g]))return!1}return!0}function lU(s){for(;s&&s.firstChild;)s=s.firstChild;return s}function dU(s,c){var h=lU(s);s=0;for(var _;h;){if(h.nodeType===3){if(_=s+h.textContent.length,s<=c&&_>=c)return{node:h,offset:c-s};s=_}e:{for(;h;){if(h.nextSibling){h=h.nextSibling;break e}h=h.parentNode}h=void 0}h=lU(h)}}function Y2(s,c){return s&&c?s===c?!0:s&&s.nodeType===3?!1:c&&c.nodeType===3?Y2(s,c.parentNode):"contains"in s?s.contains(c):s.compareDocumentPosition?!!(s.compareDocumentPosition(c)&16):!1:!1}function q2(){for(var s=window,c=df();c instanceof s.HTMLIFrameElement;){try{var h=typeof c.contentWindow.location.href=="string"}catch{h=!1}if(h)s=c.contentWindow;else break;c=df(s.document)}return c}function bC(s){var c=s&&s.nodeName&&s.nodeName.toLowerCase();return c&&(c==="input"&&(s.type==="text"||s.type==="search"||s.type==="tel"||s.type==="url"||s.type==="password")||c==="textarea"||s.contentEditable==="true")}function nX(s){var c=q2(),h=s.focusedElem,_=s.selectionRange;if(c!==h&&h&&h.ownerDocument&&Y2(h.ownerDocument.documentElement,h)){if(_!==null&&bC(h)){if(c=_.start,s=_.end,s===void 0&&(s=c),"selectionStart"in h)h.selectionStart=c,h.selectionEnd=Math.min(s,h.value.length);else if(s=(c=h.ownerDocument||document)&&c.defaultView||window,s.getSelection){s=s.getSelection();var g=h.textContent.length,v=Math.min(_.start,g);_=_.end===void 0?v:Math.min(_.end,g),!s.extend&&v>_&&(g=_,_=v,v=g),g=dU(h,v);var b=dU(h,_);g&&b&&(s.rangeCount!==1||s.anchorNode!==g.node||s.anchorOffset!==g.offset||s.focusNode!==b.node||s.focusOffset!==b.offset)&&(c=c.createRange(),c.setStart(g.node,g.offset),s.removeAllRanges(),v>_?(s.addRange(c),s.extend(b.node,b.offset)):(c.setEnd(b.node,b.offset),s.addRange(c)))}}for(c=[],s=h;s=s.parentNode;)s.nodeType===1&&c.push({element:s,left:s.scrollLeft,top:s.scrollTop});for(typeof h.focus=="function"&&h.focus(),h=0;h<c.length;h++)s=c[h],s.element.scrollLeft=s.left,s.element.scrollTop=s.top}}var oX=Ns&&"documentMode"in document&&11>=document.documentMode,_d=null,UR=null,Oh=null,xR=!1;function uU(s,c,h){var _=h.window===h?h.document:h.nodeType===9?h:h.ownerDocument;xR||_d==null||_d!==df(_)||(_=_d,"selectionStart"in _&&bC(_)?_={start:_.selectionStart,end:_.selectionEnd}:(_=(_.ownerDocument&&_.ownerDocument.defaultView||window).getSelection(),_={anchorNode:_.anchorNode,anchorOffset:_.anchorOffset,focusNode:_.focusNode,focusOffset:_.focusOffset}),Oh&&jh(Oh,_)||(Oh=_,_=Ef(UR,"onSelect"),0<_.length&&(c=new wC("onSelect","select",null,c,h),s.push({event:c,listeners:_}),c.target=_d)))}function j_(s,c){var h={};return h[s.toLowerCase()]=c.toLowerCase(),h["Webkit"+s]="webkit"+c,h["Moz"+s]="moz"+c,h}var fd={animationend:j_("Animation","AnimationEnd"),animationiteration:j_("Animation","AnimationIteration"),animationstart:j_("Animation","AnimationStart"),transitionend:j_("Transition","TransitionEnd")},tR={},J2={};Ns&&(J2=document.createElement("div").style,"AnimationEvent"in window||(delete fd.animationend.animation,delete fd.animationiteration.animation,delete fd.animationstart.animation),"TransitionEvent"in window||delete fd.transitionend.transition);function Vf(s){if(tR[s])return tR[s];if(!fd[s])return s;var c=fd[s],h;for(h in c)if(c.hasOwnProperty(h)&&h in J2)return tR[s]=c[h];return s}var X2=Vf("animationend"),Q2=Vf("animationiteration"),Z2=Vf("animationstart"),$2=Vf("transitionend"),ex=new Map,hU="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function Va(s,c){ex.set(s,c),Bc(c,[s])}for(var iR=0;iR<hU.length;iR++){var rR=hU[iR],sX=rR.toLowerCase(),aX=rR[0].toUpperCase()+rR.slice(1);Va(sX,"on"+aX)}Va(X2,"onAnimationEnd");Va(Q2,"onAnimationIteration");Va(Z2,"onAnimationStart");Va("dblclick","onDoubleClick");Va("focusin","onFocus");Va("focusout","onBlur");Va($2,"onTransitionEnd");Nd("onMouseEnter",["mouseout","mouseover"]);Nd("onMouseLeave",["mouseout","mouseover"]);Nd("onPointerEnter",["pointerout","pointerover"]);Nd("onPointerLeave",["pointerout","pointerover"]);Bc("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));Bc("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));Bc("onBeforeInput",["compositionend","keypress","textInput","paste"]);Bc("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));Bc("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));Bc("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var vh="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),cX=new Set("cancel close invalid load scroll toggle".split(" ").concat(vh));function pU(s,c,h){var _=s.type||"unknown-event";s.currentTarget=h,sJ(_,c,void 0,s),s.currentTarget=null}function tx(s,c){c=(c&4)!==0;for(var h=0;h<s.length;h++){var _=s[h],g=_.event;_=_.listeners;e:{var v=void 0;if(c)for(var b=_.length-1;0<=b;b--){var L=_[b],x=L.instance,W=L.currentTarget;if(L=L.listener,x!==v&&g.isPropagationStopped())break e;pU(g,L,W),v=x}else for(b=0;b<_.length;b++){if(L=_[b],x=L.instance,W=L.currentTarget,L=L.listener,x!==v&&g.isPropagationStopped())break e;pU(g,L,W),v=x}}}if(hf)throw s=PR,hf=!1,PR=null,s}function Ei(s,c){var h=c[GR];h===void 0&&(h=c[GR]=new Set);var _=s+"__bubble";h.has(_)||(ix(c,s,2,!1),h.add(_))}function nR(s,c,h){var _=0;c&&(_|=4),ix(h,s,_,c)}var B_="_reactListening"+Math.random().toString(36).slice(2);function Bh(s){if(!s[B_]){s[B_]=!0,l2.forEach(function(h){h!=="selectionchange"&&(cX.has(h)||nR(h,!1,s),nR(h,!0,s))});var c=s.nodeType===9?s:s.ownerDocument;c===null||c[B_]||(c[B_]=!0,nR("selectionchange",!1,c))}}function ix(s,c,h,_){switch(F2(c)){case 1:var g=RJ;break;case 4:g=CJ;break;default:g=yC}h=g.bind(null,c,h,s),g=void 0,!DR||c!=="touchstart"&&c!=="touchmove"&&c!=="wheel"||(g=!0),_?g!==void 0?s.addEventListener(c,h,{capture:!0,passive:g}):s.addEventListener(c,h,!0):g!==void 0?s.addEventListener(c,h,{passive:g}):s.addEventListener(c,h,!1)}function oR(s,c,h,_,g){var v=_;if(!(c&1)&&!(c&2)&&_!==null)e:for(;;){if(_===null)return;var b=_.tag;if(b===3||b===4){var L=_.stateNode.containerInfo;if(L===g||L.nodeType===8&&L.parentNode===g)break;if(b===4)for(b=_.return;b!==null;){var x=b.tag;if((x===3||x===4)&&(x=b.stateNode.containerInfo,x===g||x.nodeType===8&&x.parentNode===g))return;b=b.return}for(;L!==null;){if(b=Dc(L),b===null)return;if(x=b.tag,x===5||x===6){_=v=b;continue e}L=L.parentNode}}_=_.return}I2(function(){var W=v,ee=TC(h),K=[];e:{var $=ex.get(s);if($!==void 0){var ge=wC,le=s;switch(s){case"keypress":if($_(h)===0)break e;case"keydown":case"keyup":ge=VJ;break;case"focusin":le="focus",ge=Zv;break;case"focusout":le="blur",ge=Zv;break;case"beforeblur":case"afterblur":ge=Zv;break;case"click":if(h.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":ge=tU;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":ge=wJ;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":ge=BJ;break;case X2:case Q2:case Z2:ge=bJ;break;case $2:ge=WJ;break;case"scroll":ge=yJ;break;case"wheel":ge=KJ;break;case"copy":case"cut":case"paste":ge=DJ;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":ge=rU}var X=(c&4)!==0,ve=!X&&s==="scroll",H=X?$!==null?$+"Capture":null:$;X=[];for(var G=W,q;G!==null;){q=G;var Ee=q.stateNode;if(q.tag===5&&Ee!==null&&(q=Ee,H!==null&&(Ee=Mh(G,H),Ee!=null&&X.push(Gh(G,Ee,q)))),ve)break;G=G.return}0<X.length&&($=new ge($,le,null,h,ee),K.push({event:$,listeners:X}))}}if(!(c&7)){e:{if($=s==="mouseover"||s==="pointerover",ge=s==="mouseout"||s==="pointerout",$&&h!==bR&&(le=h.relatedTarget||h.fromElement)&&(Dc(le)||le[Ds]))break e;if((ge||$)&&($=ee.window===ee?ee:($=ee.ownerDocument)?$.defaultView||$.parentWindow:window,ge?(le=h.relatedTarget||h.toElement,ge=W,le=le?Dc(le):null,le!==null&&(ve=Gc(le),le!==ve||le.tag!==5&&le.tag!==6)&&(le=null)):(ge=null,le=W),ge!==le)){if(X=tU,Ee="onMouseLeave",H="onMouseEnter",G="mouse",(s==="pointerout"||s==="pointerover")&&(X=rU,Ee="onPointerLeave",H="onPointerEnter",G="pointer"),ve=ge==null?$:Ed(ge),q=le==null?$:Ed(le),$=new X(Ee,G+"leave",ge,h,ee),$.target=ve,$.relatedTarget=q,Ee=null,Dc(ee)===W&&(X=new X(H,G+"enter",le,h,ee),X.target=q,X.relatedTarget=ve,Ee=X),ve=Ee,ge&&le)t:{for(X=ge,H=le,G=0,q=X;q;q=dd(q))G++;for(q=0,Ee=H;Ee;Ee=dd(Ee))q++;for(;0<G-q;)X=dd(X),G--;for(;0<q-G;)H=dd(H),q--;for(;G--;){if(X===H||H!==null&&X===H.alternate)break t;X=dd(X),H=dd(H)}X=null}else X=null;ge!==null&&mU(K,$,ge,X,!1),le!==null&&ve!==null&&mU(K,ve,le,X,!0)}}e:{if($=W?Ed(W):window,ge=$.nodeName&&$.nodeName.toLowerCase(),ge==="select"||ge==="input"&&$.type==="file")var we=ZJ;else if(sU($))if(K2)we=iX;else{we=eX;var Fe=$J}else(ge=$.nodeName)&&ge.toLowerCase()==="input"&&($.type==="checkbox"||$.type==="radio")&&(we=tX);if(we&&(we=we(s,W))){H2(K,we,h,ee);break e}Fe&&Fe(s,$,W),s==="focusout"&&(Fe=$._wrapperState)&&Fe.controlled&&$.type==="number"&&yR($,"number",$.value)}switch(Fe=W?Ed(W):window,s){case"focusin":(sU(Fe)||Fe.contentEditable==="true")&&(_d=Fe,UR=W,Oh=null);break;case"focusout":Oh=UR=_d=null;break;case"mousedown":xR=!0;break;case"contextmenu":case"mouseup":case"dragend":xR=!1,uU(K,h,ee);break;case"selectionchange":if(oX)break;case"keydown":case"keyup":uU(K,h,ee)}var De;if(OC)e:{switch(s){case"compositionstart":var ze="onCompositionStart";break e;case"compositionend":ze="onCompositionEnd";break e;case"compositionupdate":ze="onCompositionUpdate";break e}ze=void 0}else md?G2(s,h)&&(ze="onCompositionEnd"):s==="keydown"&&h.keyCode===229&&(ze="onCompositionStart");ze&&(B2&&h.locale!=="ko"&&(md||ze!=="onCompositionStart"?ze==="onCompositionEnd"&&md&&(De=j2()):(wa=ee,IC="value"in wa?wa.value:wa.textContent,md=!0)),Fe=Ef(W,ze),0<Fe.length&&(ze=new iU(ze,s,null,h,ee),K.push({event:ze,listeners:Fe}),De?ze.data=De:(De=W2(h),De!==null&&(ze.data=De)))),(De=YJ?qJ(s,h):JJ(s,h))&&(W=Ef(W,"onBeforeInput"),0<W.length&&(ee=new iU("onBeforeInput","beforeinput",null,h,ee),K.push({event:ee,listeners:W}),ee.data=De))}tx(K,c)})}function Gh(s,c,h){return{instance:s,listener:c,currentTarget:h}}function Ef(s,c){for(var h=c+"Capture",_=[];s!==null;){var g=s,v=g.stateNode;g.tag===5&&v!==null&&(g=v,v=Mh(s,h),v!=null&&_.unshift(Gh(s,v,g)),v=Mh(s,c),v!=null&&_.push(Gh(s,v,g))),s=s.return}return _}function dd(s){if(s===null)return null;do s=s.return;while(s&&s.tag!==5);return s||null}function mU(s,c,h,_,g){for(var v=c._reactName,b=[];h!==null&&h!==_;){var L=h,x=L.alternate,W=L.stateNode;if(x!==null&&x===_)break;L.tag===5&&W!==null&&(L=W,g?(x=Mh(h,v),x!=null&&b.unshift(Gh(h,x,L))):g||(x=Mh(h,v),x!=null&&b.push(Gh(h,x,L)))),h=h.return}b.length!==0&&s.push({event:c,listeners:b})}var lX=/\r\n?/g,dX=/\u0000|\uFFFD/g;function _U(s){return(typeof s=="string"?s:""+s).replace(lX,`
`).replace(dX,"")}function G_(s,c,h){if(c=_U(c),_U(s)!==c&&h)throw Error(Te(425))}function gf(){}var VR=null,FR=null;function jR(s,c){return s==="textarea"||s==="noscript"||typeof c.children=="string"||typeof c.children=="number"||typeof c.dangerouslySetInnerHTML=="object"&&c.dangerouslySetInnerHTML!==null&&c.dangerouslySetInnerHTML.__html!=null}var BR=typeof setTimeout=="function"?setTimeout:void 0,uX=typeof clearTimeout=="function"?clearTimeout:void 0,fU=typeof Promise=="function"?Promise:void 0,hX=typeof queueMicrotask=="function"?queueMicrotask:typeof fU<"u"?function(s){return fU.resolve(null).then(s).catch(pX)}:BR;function pX(s){setTimeout(function(){throw s})}function sR(s,c){var h=c,_=0;do{var g=h.nextSibling;if(s.removeChild(h),g&&g.nodeType===8)if(h=g.data,h==="/$"){if(_===0){s.removeChild(g),Vh(c);return}_--}else h!=="$"&&h!=="$?"&&h!=="$!"||_++;h=g}while(h);Vh(c)}function Da(s){for(;s!=null;s=s.nextSibling){var c=s.nodeType;if(c===1||c===3)break;if(c===8){if(c=s.data,c==="$"||c==="$!"||c==="$?")break;if(c==="/$")return null}}return s}function EU(s){s=s.previousSibling;for(var c=0;s;){if(s.nodeType===8){var h=s.data;if(h==="$"||h==="$!"||h==="$?"){if(c===0)return s;c--}else h==="/$"&&c++}s=s.previousSibling}return null}var Fd=Math.random().toString(36).slice(2),os="__reactFiber$"+Fd,Wh="__reactProps$"+Fd,Ds="__reactContainer$"+Fd,GR="__reactEvents$"+Fd,mX="__reactListeners$"+Fd,_X="__reactHandles$"+Fd;function Dc(s){var c=s[os];if(c)return c;for(var h=s.parentNode;h;){if(c=h[Ds]||h[os]){if(h=c.alternate,c.child!==null||h!==null&&h.child!==null)for(s=EU(s);s!==null;){if(h=s[os])return h;s=EU(s)}return c}s=h,h=s.parentNode}return null}function $h(s){return s=s[os]||s[Ds],!s||s.tag!==5&&s.tag!==6&&s.tag!==13&&s.tag!==3?null:s}function Ed(s){if(s.tag===5||s.tag===6)return s.stateNode;throw Error(Te(33))}function Ff(s){return s[Wh]||null}var WR=[],gd=-1;function Fa(s){return{current:s}}function gi(s){0>gd||(s.current=WR[gd],WR[gd]=null,gd--)}function di(s,c){gd++,WR[gd]=s.current,s.current=c}var xa={},Pr=Fa(xa),ln=Fa(!1),Uc=xa;function Dd(s,c){var h=s.type.contextTypes;if(!h)return xa;var _=s.stateNode;if(_&&_.__reactInternalMemoizedUnmaskedChildContext===c)return _.__reactInternalMemoizedMaskedChildContext;var g={},v;for(v in h)g[v]=c[v];return _&&(s=s.stateNode,s.__reactInternalMemoizedUnmaskedChildContext=c,s.__reactInternalMemoizedMaskedChildContext=g),g}function dn(s){return s=s.childContextTypes,s!=null}function Sf(){gi(ln),gi(Pr)}function gU(s,c,h){if(Pr.current!==xa)throw Error(Te(168));di(Pr,c),di(ln,h)}function rx(s,c,h){var _=s.stateNode;if(c=c.childContextTypes,typeof _.getChildContext!="function")return h;_=_.getChildContext();for(var g in _)if(!(g in c))throw Error(Te(108,$7(s)||"Unknown",g));return Di({},h,_)}function Tf(s){return s=(s=s.stateNode)&&s.__reactInternalMemoizedMergedChildContext||xa,Uc=Pr.current,di(Pr,s),di(ln,ln.current),!0}function SU(s,c,h){var _=s.stateNode;if(!_)throw Error(Te(169));h?(s=rx(s,c,Uc),_.__reactInternalMemoizedMergedChildContext=s,gi(ln),gi(Pr),di(Pr,s)):gi(ln),di(ln,h)}var ws=null,jf=!1,aR=!1;function nx(s){ws===null?ws=[s]:ws.push(s)}function fX(s){jf=!0,nx(s)}function ja(){if(!aR&&ws!==null){aR=!0;var s=0,c=$t;try{var h=ws;for($t=1;s<h.length;s++){var _=h[s];do _=_(!0);while(_!==null)}ws=null,jf=!1}catch(g){throw ws!==null&&(ws=ws.slice(s+1)),b2(vC,ja),g}finally{$t=c,aR=!1}}return null}var Sd=[],Td=0,vf=null,Rf=0,eo=[],to=0,xc=null,As=1,Os="";function bc(s,c){Sd[Td++]=Rf,Sd[Td++]=vf,vf=s,Rf=c}function ox(s,c,h){eo[to++]=As,eo[to++]=Os,eo[to++]=xc,xc=s;var _=As;s=Os;var g=32-Oo(_)-1;_&=~(1<<g),h+=1;var v=32-Oo(c)+g;if(30<v){var b=g-g%5;v=(_&(1<<b)-1).toString(32),_>>=b,g-=b,As=1<<32-Oo(c)+g|h<<g|_,Os=v+s}else As=1<<v|h<<g|_,Os=s}function NC(s){s.return!==null&&(bc(s,1),ox(s,1,0))}function DC(s){for(;s===vf;)vf=Sd[--Td],Sd[Td]=null,Rf=Sd[--Td],Sd[Td]=null;for(;s===xc;)xc=eo[--to],eo[to]=null,Os=eo[--to],eo[to]=null,As=eo[--to],eo[to]=null}var wn=null,In=null,Ii=!1,Ao=null;function sx(s,c){var h=io(5,null,null,0);h.elementType="DELETED",h.stateNode=c,h.return=s,c=s.deletions,c===null?(s.deletions=[h],s.flags|=16):c.push(h)}function TU(s,c){switch(s.tag){case 5:var h=s.type;return c=c.nodeType!==1||h.toLowerCase()!==c.nodeName.toLowerCase()?null:c,c!==null?(s.stateNode=c,wn=s,In=Da(c.firstChild),!0):!1;case 6:return c=s.pendingProps===""||c.nodeType!==3?null:c,c!==null?(s.stateNode=c,wn=s,In=null,!0):!1;case 13:return c=c.nodeType!==8?null:c,c!==null?(h=xc!==null?{id:As,overflow:Os}:null,s.memoizedState={dehydrated:c,treeContext:h,retryLane:1073741824},h=io(18,null,null,0),h.stateNode=c,h.return=s,s.child=h,wn=s,In=null,!0):!1;default:return!1}}function HR(s){return(s.mode&1)!==0&&(s.flags&128)===0}function KR(s){if(Ii){var c=In;if(c){var h=c;if(!TU(s,c)){if(HR(s))throw Error(Te(418));c=Da(h.nextSibling);var _=wn;c&&TU(s,c)?sx(_,h):(s.flags=s.flags&-4097|2,Ii=!1,wn=s)}}else{if(HR(s))throw Error(Te(418));s.flags=s.flags&-4097|2,Ii=!1,wn=s}}}function vU(s){for(s=s.return;s!==null&&s.tag!==5&&s.tag!==3&&s.tag!==13;)s=s.return;wn=s}function W_(s){if(s!==wn)return!1;if(!Ii)return vU(s),Ii=!0,!1;var c;if((c=s.tag!==3)&&!(c=s.tag!==5)&&(c=s.type,c=c!=="head"&&c!=="body"&&!jR(s.type,s.memoizedProps)),c&&(c=In)){if(HR(s))throw ax(),Error(Te(418));for(;c;)sx(s,c),c=Da(c.nextSibling)}if(vU(s),s.tag===13){if(s=s.memoizedState,s=s!==null?s.dehydrated:null,!s)throw Error(Te(317));e:{for(s=s.nextSibling,c=0;s;){if(s.nodeType===8){var h=s.data;if(h==="/$"){if(c===0){In=Da(s.nextSibling);break e}c--}else h!=="$"&&h!=="$!"&&h!=="$?"||c++}s=s.nextSibling}In=null}}else In=wn?Da(s.stateNode.nextSibling):null;return!0}function ax(){for(var s=In;s;)s=Da(s.nextSibling)}function Pd(){In=wn=null,Ii=!1}function PC(s){Ao===null?Ao=[s]:Ao.push(s)}var EX=Ls.ReactCurrentBatchConfig;function _h(s,c,h){if(s=h.ref,s!==null&&typeof s!="function"&&typeof s!="object"){if(h._owner){if(h=h._owner,h){if(h.tag!==1)throw Error(Te(309));var _=h.stateNode}if(!_)throw Error(Te(147,s));var g=_,v=""+s;return c!==null&&c.ref!==null&&typeof c.ref=="function"&&c.ref._stringRef===v?c.ref:(c=function(b){var L=g.refs;b===null?delete L[v]:L[v]=b},c._stringRef=v,c)}if(typeof s!="string")throw Error(Te(284));if(!h._owner)throw Error(Te(290,s))}return s}function H_(s,c){throw s=Object.prototype.toString.call(c),Error(Te(31,s==="[object Object]"?"object with keys {"+Object.keys(c).join(", ")+"}":s))}function RU(s){var c=s._init;return c(s._payload)}function cx(s){function c(H,G){if(s){var q=H.deletions;q===null?(H.deletions=[G],H.flags|=16):q.push(G)}}function h(H,G){if(!s)return null;for(;G!==null;)c(H,G),G=G.sibling;return null}function _(H,G){for(H=new Map;G!==null;)G.key!==null?H.set(G.key,G):H.set(G.index,G),G=G.sibling;return H}function g(H,G){return H=Ma(H,G),H.index=0,H.sibling=null,H}function v(H,G,q){return H.index=q,s?(q=H.alternate,q!==null?(q=q.index,q<G?(H.flags|=2,G):q):(H.flags|=2,G)):(H.flags|=1048576,G)}function b(H){return s&&H.alternate===null&&(H.flags|=2),H}function L(H,G,q,Ee){return G===null||G.tag!==6?(G=mR(q,H.mode,Ee),G.return=H,G):(G=g(G,q),G.return=H,G)}function x(H,G,q,Ee){var we=q.type;return we===pd?ee(H,G,q.props.children,Ee,q.key):G!==null&&(G.elementType===we||typeof we=="object"&&we!==null&&we.$$typeof===Ra&&RU(we)===G.type)?(Ee=g(G,q.props),Ee.ref=_h(H,G,q),Ee.return=H,Ee):(Ee=af(q.type,q.key,q.props,null,H.mode,Ee),Ee.ref=_h(H,G,q),Ee.return=H,Ee)}function W(H,G,q,Ee){return G===null||G.tag!==4||G.stateNode.containerInfo!==q.containerInfo||G.stateNode.implementation!==q.implementation?(G=_R(q,H.mode,Ee),G.return=H,G):(G=g(G,q.children||[]),G.return=H,G)}function ee(H,G,q,Ee,we){return G===null||G.tag!==7?(G=Mc(q,H.mode,Ee,we),G.return=H,G):(G=g(G,q),G.return=H,G)}function K(H,G,q){if(typeof G=="string"&&G!==""||typeof G=="number")return G=mR(""+G,H.mode,q),G.return=H,G;if(typeof G=="object"&&G!==null){switch(G.$$typeof){case k_:return q=af(G.type,G.key,G.props,null,H.mode,q),q.ref=_h(H,null,G),q.return=H,q;case hd:return G=_R(G,H.mode,q),G.return=H,G;case Ra:var Ee=G._init;return K(H,Ee(G._payload),q)}if(Sh(G)||dh(G))return G=Mc(G,H.mode,q,null),G.return=H,G;H_(H,G)}return null}function $(H,G,q,Ee){var we=G!==null?G.key:null;if(typeof q=="string"&&q!==""||typeof q=="number")return we!==null?null:L(H,G,""+q,Ee);if(typeof q=="object"&&q!==null){switch(q.$$typeof){case k_:return q.key===we?x(H,G,q,Ee):null;case hd:return q.key===we?W(H,G,q,Ee):null;case Ra:return we=q._init,$(H,G,we(q._payload),Ee)}if(Sh(q)||dh(q))return we!==null?null:ee(H,G,q,Ee,null);H_(H,q)}return null}function ge(H,G,q,Ee,we){if(typeof Ee=="string"&&Ee!==""||typeof Ee=="number")return H=H.get(q)||null,L(G,H,""+Ee,we);if(typeof Ee=="object"&&Ee!==null){switch(Ee.$$typeof){case k_:return H=H.get(Ee.key===null?q:Ee.key)||null,x(G,H,Ee,we);case hd:return H=H.get(Ee.key===null?q:Ee.key)||null,W(G,H,Ee,we);case Ra:var Fe=Ee._init;return ge(H,G,q,Fe(Ee._payload),we)}if(Sh(Ee)||dh(Ee))return H=H.get(q)||null,ee(G,H,Ee,we,null);H_(G,Ee)}return null}function le(H,G,q,Ee){for(var we=null,Fe=null,De=G,ze=G=0,wi=null;De!==null&&ze<q.length;ze++){De.index>ze?(wi=De,De=null):wi=De.sibling;var pt=$(H,De,q[ze],Ee);if(pt===null){De===null&&(De=wi);break}s&&De&&pt.alternate===null&&c(H,De),G=v(pt,G,ze),Fe===null?we=pt:Fe.sibling=pt,Fe=pt,De=wi}if(ze===q.length)return h(H,De),Ii&&bc(H,ze),we;if(De===null){for(;ze<q.length;ze++)De=K(H,q[ze],Ee),De!==null&&(G=v(De,G,ze),Fe===null?we=De:Fe.sibling=De,Fe=De);return Ii&&bc(H,ze),we}for(De=_(H,De);ze<q.length;ze++)wi=ge(De,H,ze,q[ze],Ee),wi!==null&&(s&&wi.alternate!==null&&De.delete(wi.key===null?ze:wi.key),G=v(wi,G,ze),Fe===null?we=wi:Fe.sibling=wi,Fe=wi);return s&&De.forEach(function(kr){return c(H,kr)}),Ii&&bc(H,ze),we}function X(H,G,q,Ee){var we=dh(q);if(typeof we!="function")throw Error(Te(150));if(q=we.call(q),q==null)throw Error(Te(151));for(var Fe=we=null,De=G,ze=G=0,wi=null,pt=q.next();De!==null&&!pt.done;ze++,pt=q.next()){De.index>ze?(wi=De,De=null):wi=De.sibling;var kr=$(H,De,pt.value,Ee);if(kr===null){De===null&&(De=wi);break}s&&De&&kr.alternate===null&&c(H,De),G=v(kr,G,ze),Fe===null?we=kr:Fe.sibling=kr,Fe=kr,De=wi}if(pt.done)return h(H,De),Ii&&bc(H,ze),we;if(De===null){for(;!pt.done;ze++,pt=q.next())pt=K(H,pt.value,Ee),pt!==null&&(G=v(pt,G,ze),Fe===null?we=pt:Fe.sibling=pt,Fe=pt);return Ii&&bc(H,ze),we}for(De=_(H,De);!pt.done;ze++,pt=q.next())pt=ge(De,H,ze,pt.value,Ee),pt!==null&&(s&&pt.alternate!==null&&De.delete(pt.key===null?ze:pt.key),G=v(pt,G,ze),Fe===null?we=pt:Fe.sibling=pt,Fe=pt);return s&&De.forEach(function(Po){return c(H,Po)}),Ii&&bc(H,ze),we}function ve(H,G,q,Ee){if(typeof q=="object"&&q!==null&&q.type===pd&&q.key===null&&(q=q.props.children),typeof q=="object"&&q!==null){switch(q.$$typeof){case k_:e:{for(var we=q.key,Fe=G;Fe!==null;){if(Fe.key===we){if(we=q.type,we===pd){if(Fe.tag===7){h(H,Fe.sibling),G=g(Fe,q.props.children),G.return=H,H=G;break e}}else if(Fe.elementType===we||typeof we=="object"&&we!==null&&we.$$typeof===Ra&&RU(we)===Fe.type){h(H,Fe.sibling),G=g(Fe,q.props),G.ref=_h(H,Fe,q),G.return=H,H=G;break e}h(H,Fe);break}else c(H,Fe);Fe=Fe.sibling}q.type===pd?(G=Mc(q.props.children,H.mode,Ee,q.key),G.return=H,H=G):(Ee=af(q.type,q.key,q.props,null,H.mode,Ee),Ee.ref=_h(H,G,q),Ee.return=H,H=Ee)}return b(H);case hd:e:{for(Fe=q.key;G!==null;){if(G.key===Fe)if(G.tag===4&&G.stateNode.containerInfo===q.containerInfo&&G.stateNode.implementation===q.implementation){h(H,G.sibling),G=g(G,q.children||[]),G.return=H,H=G;break e}else{h(H,G);break}else c(H,G);G=G.sibling}G=_R(q,H.mode,Ee),G.return=H,H=G}return b(H);case Ra:return Fe=q._init,ve(H,G,Fe(q._payload),Ee)}if(Sh(q))return le(H,G,q,Ee);if(dh(q))return X(H,G,q,Ee);H_(H,q)}return typeof q=="string"&&q!==""||typeof q=="number"?(q=""+q,G!==null&&G.tag===6?(h(H,G.sibling),G=g(G,q),G.return=H,H=G):(h(H,G),G=mR(q,H.mode,Ee),G.return=H,H=G),b(H)):h(H,G)}return ve}var kd=cx(!0),lx=cx(!1),Cf=Fa(null),yf=null,vd=null,kC=null;function LC(){kC=vd=yf=null}function MC(s){var c=Cf.current;gi(Cf),s._currentValue=c}function zR(s,c,h){for(;s!==null;){var _=s.alternate;if((s.childLanes&c)!==c?(s.childLanes|=c,_!==null&&(_.childLanes|=c)):_!==null&&(_.childLanes&c)!==c&&(_.childLanes|=c),s===h)break;s=s.return}}function Od(s,c){yf=s,kC=vd=null,s=s.dependencies,s!==null&&s.firstContext!==null&&(s.lanes&c&&(cn=!0),s.firstContext=null)}function no(s){var c=s._currentValue;if(kC!==s)if(s={context:s,memoizedValue:c,next:null},vd===null){if(yf===null)throw Error(Te(308));vd=s,yf.dependencies={lanes:0,firstContext:s}}else vd=vd.next=s;return c}var Pc=null;function UC(s){Pc===null?Pc=[s]:Pc.push(s)}function dx(s,c,h,_){var g=c.interleaved;return g===null?(h.next=h,UC(c)):(h.next=g.next,g.next=h),c.interleaved=h,Ps(s,_)}function Ps(s,c){s.lanes|=c;var h=s.alternate;for(h!==null&&(h.lanes|=c),h=s,s=s.return;s!==null;)s.childLanes|=c,h=s.alternate,h!==null&&(h.childLanes|=c),h=s,s=s.return;return h.tag===3?h.stateNode:null}var Ca=!1;function xC(s){s.updateQueue={baseState:s.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function ux(s,c){s=s.updateQueue,c.updateQueue===s&&(c.updateQueue={baseState:s.baseState,firstBaseUpdate:s.firstBaseUpdate,lastBaseUpdate:s.lastBaseUpdate,shared:s.shared,effects:s.effects})}function bs(s,c){return{eventTime:s,lane:c,tag:0,payload:null,callback:null,next:null}}function Pa(s,c,h){var _=s.updateQueue;if(_===null)return null;if(_=_.shared,Ft&2){var g=_.pending;return g===null?c.next=c:(c.next=g.next,g.next=c),_.pending=c,Ps(s,h)}return g=_.interleaved,g===null?(c.next=c,UC(_)):(c.next=g.next,g.next=c),_.interleaved=c,Ps(s,h)}function ef(s,c,h){if(c=c.updateQueue,c!==null&&(c=c.shared,(h&4194240)!==0)){var _=c.lanes;_&=s.pendingLanes,h|=_,c.lanes=h,RC(s,h)}}function CU(s,c){var h=s.updateQueue,_=s.alternate;if(_!==null&&(_=_.updateQueue,h===_)){var g=null,v=null;if(h=h.firstBaseUpdate,h!==null){do{var b={eventTime:h.eventTime,lane:h.lane,tag:h.tag,payload:h.payload,callback:h.callback,next:null};v===null?g=v=b:v=v.next=b,h=h.next}while(h!==null);v===null?g=v=c:v=v.next=c}else g=v=c;h={baseState:_.baseState,firstBaseUpdate:g,lastBaseUpdate:v,shared:_.shared,effects:_.effects},s.updateQueue=h;return}s=h.lastBaseUpdate,s===null?h.firstBaseUpdate=c:s.next=c,h.lastBaseUpdate=c}function If(s,c,h,_){var g=s.updateQueue;Ca=!1;var v=g.firstBaseUpdate,b=g.lastBaseUpdate,L=g.shared.pending;if(L!==null){g.shared.pending=null;var x=L,W=x.next;x.next=null,b===null?v=W:b.next=W,b=x;var ee=s.alternate;ee!==null&&(ee=ee.updateQueue,L=ee.lastBaseUpdate,L!==b&&(L===null?ee.firstBaseUpdate=W:L.next=W,ee.lastBaseUpdate=x))}if(v!==null){var K=g.baseState;b=0,ee=W=x=null,L=v;do{var $=L.lane,ge=L.eventTime;if((_&$)===$){ee!==null&&(ee=ee.next={eventTime:ge,lane:0,tag:L.tag,payload:L.payload,callback:L.callback,next:null});e:{var le=s,X=L;switch($=c,ge=h,X.tag){case 1:if(le=X.payload,typeof le=="function"){K=le.call(ge,K,$);break e}K=le;break e;case 3:le.flags=le.flags&-65537|128;case 0:if(le=X.payload,$=typeof le=="function"?le.call(ge,K,$):le,$==null)break e;K=Di({},K,$);break e;case 2:Ca=!0}}L.callback!==null&&L.lane!==0&&(s.flags|=64,$=g.effects,$===null?g.effects=[L]:$.push(L))}else ge={eventTime:ge,lane:$,tag:L.tag,payload:L.payload,callback:L.callback,next:null},ee===null?(W=ee=ge,x=K):ee=ee.next=ge,b|=$;if(L=L.next,L===null){if(L=g.shared.pending,L===null)break;$=L,L=$.next,$.next=null,g.lastBaseUpdate=$,g.shared.pending=null}}while(1);if(ee===null&&(x=K),g.baseState=x,g.firstBaseUpdate=W,g.lastBaseUpdate=ee,c=g.shared.interleaved,c!==null){g=c;do b|=g.lane,g=g.next;while(g!==c)}else v===null&&(g.shared.lanes=0);Fc|=b,s.lanes=b,s.memoizedState=K}}function yU(s,c,h){if(s=c.effects,c.effects=null,s!==null)for(c=0;c<s.length;c++){var _=s[c],g=_.callback;if(g!==null){if(_.callback=null,_=h,typeof g!="function")throw Error(Te(191,g));g.call(_)}}}var ep={},as=Fa(ep),Hh=Fa(ep),Kh=Fa(ep);function kc(s){if(s===ep)throw Error(Te(174));return s}function VC(s,c){switch(di(Kh,c),di(Hh,s),di(as,ep),s=c.nodeType,s){case 9:case 11:c=(c=c.documentElement)?c.namespaceURI:wR(null,"");break;default:s=s===8?c.parentNode:c,c=s.namespaceURI||null,s=s.tagName,c=wR(c,s)}gi(as),di(as,c)}function Ld(){gi(as),gi(Hh),gi(Kh)}function hx(s){kc(Kh.current);var c=kc(as.current),h=wR(c,s.type);c!==h&&(di(Hh,s),di(as,h))}function FC(s){Hh.current===s&&(gi(as),gi(Hh))}var bi=Fa(0);function wf(s){for(var c=s;c!==null;){if(c.tag===13){var h=c.memoizedState;if(h!==null&&(h=h.dehydrated,h===null||h.data==="$?"||h.data==="$!"))return c}else if(c.tag===19&&c.memoizedProps.revealOrder!==void 0){if(c.flags&128)return c}else if(c.child!==null){c.child.return=c,c=c.child;continue}if(c===s)break;for(;c.sibling===null;){if(c.return===null||c.return===s)return null;c=c.return}c.sibling.return=c.return,c=c.sibling}return null}var cR=[];function jC(){for(var s=0;s<cR.length;s++)cR[s]._workInProgressVersionPrimary=null;cR.length=0}var tf=Ls.ReactCurrentDispatcher,lR=Ls.ReactCurrentBatchConfig,Vc=0,Ni=null,$i=null,cr=null,Af=!1,bh=!1,zh=0,gX=0;function Or(){throw Error(Te(321))}function BC(s,c){if(c===null)return!1;for(var h=0;h<c.length&&h<s.length;h++)if(!No(s[h],c[h]))return!1;return!0}function GC(s,c,h,_,g,v){if(Vc=v,Ni=c,c.memoizedState=null,c.updateQueue=null,c.lanes=0,tf.current=s===null||s.memoizedState===null?RX:CX,s=h(_,g),bh){v=0;do{if(bh=!1,zh=0,25<=v)throw Error(Te(301));v+=1,cr=$i=null,c.updateQueue=null,tf.current=yX,s=h(_,g)}while(bh)}if(tf.current=Of,c=$i!==null&&$i.next!==null,Vc=0,cr=$i=Ni=null,Af=!1,c)throw Error(Te(300));return s}function WC(){var s=zh!==0;return zh=0,s}function ns(){var s={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return cr===null?Ni.memoizedState=cr=s:cr=cr.next=s,cr}function oo(){if($i===null){var s=Ni.alternate;s=s!==null?s.memoizedState:null}else s=$i.next;var c=cr===null?Ni.memoizedState:cr.next;if(c!==null)cr=c,$i=s;else{if(s===null)throw Error(Te(310));$i=s,s={memoizedState:$i.memoizedState,baseState:$i.baseState,baseQueue:$i.baseQueue,queue:$i.queue,next:null},cr===null?Ni.memoizedState=cr=s:cr=cr.next=s}return cr}function Yh(s,c){return typeof c=="function"?c(s):c}function dR(s){var c=oo(),h=c.queue;if(h===null)throw Error(Te(311));h.lastRenderedReducer=s;var _=$i,g=_.baseQueue,v=h.pending;if(v!==null){if(g!==null){var b=g.next;g.next=v.next,v.next=b}_.baseQueue=g=v,h.pending=null}if(g!==null){v=g.next,_=_.baseState;var L=b=null,x=null,W=v;do{var ee=W.lane;if((Vc&ee)===ee)x!==null&&(x=x.next={lane:0,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null}),_=W.hasEagerState?W.eagerState:s(_,W.action);else{var K={lane:ee,action:W.action,hasEagerState:W.hasEagerState,eagerState:W.eagerState,next:null};x===null?(L=x=K,b=_):x=x.next=K,Ni.lanes|=ee,Fc|=ee}W=W.next}while(W!==null&&W!==v);x===null?b=_:x.next=L,No(_,c.memoizedState)||(cn=!0),c.memoizedState=_,c.baseState=b,c.baseQueue=x,h.lastRenderedState=_}if(s=h.interleaved,s!==null){g=s;do v=g.lane,Ni.lanes|=v,Fc|=v,g=g.next;while(g!==s)}else g===null&&(h.lanes=0);return[c.memoizedState,h.dispatch]}function uR(s){var c=oo(),h=c.queue;if(h===null)throw Error(Te(311));h.lastRenderedReducer=s;var _=h.dispatch,g=h.pending,v=c.memoizedState;if(g!==null){h.pending=null;var b=g=g.next;do v=s(v,b.action),b=b.next;while(b!==g);No(v,c.memoizedState)||(cn=!0),c.memoizedState=v,c.baseQueue===null&&(c.baseState=v),h.lastRenderedState=v}return[v,_]}function px(){}function mx(s,c){var h=Ni,_=oo(),g=c(),v=!No(_.memoizedState,g);if(v&&(_.memoizedState=g,cn=!0),_=_.queue,HC(Ex.bind(null,h,_,s),[s]),_.getSnapshot!==c||v||cr!==null&&cr.memoizedState.tag&1){if(h.flags|=2048,qh(9,fx.bind(null,h,_,g,c),void 0,null),lr===null)throw Error(Te(349));Vc&30||_x(h,c,g)}return g}function _x(s,c,h){s.flags|=16384,s={getSnapshot:c,value:h},c=Ni.updateQueue,c===null?(c={lastEffect:null,stores:null},Ni.updateQueue=c,c.stores=[s]):(h=c.stores,h===null?c.stores=[s]:h.push(s))}function fx(s,c,h,_){c.value=h,c.getSnapshot=_,gx(c)&&Sx(s)}function Ex(s,c,h){return h(function(){gx(c)&&Sx(s)})}function gx(s){var c=s.getSnapshot;s=s.value;try{var h=c();return!No(s,h)}catch{return!0}}function Sx(s){var c=Ps(s,1);c!==null&&bo(c,s,1,-1)}function IU(s){var c=ns();return typeof s=="function"&&(s=s()),c.memoizedState=c.baseState=s,s={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:Yh,lastRenderedState:s},c.queue=s,s=s.dispatch=vX.bind(null,Ni,s),[c.memoizedState,s]}function qh(s,c,h,_){return s={tag:s,create:c,destroy:h,deps:_,next:null},c=Ni.updateQueue,c===null?(c={lastEffect:null,stores:null},Ni.updateQueue=c,c.lastEffect=s.next=s):(h=c.lastEffect,h===null?c.lastEffect=s.next=s:(_=h.next,h.next=s,s.next=_,c.lastEffect=s)),s}function Tx(){return oo().memoizedState}function rf(s,c,h,_){var g=ns();Ni.flags|=s,g.memoizedState=qh(1|c,h,void 0,_===void 0?null:_)}function Bf(s,c,h,_){var g=oo();_=_===void 0?null:_;var v=void 0;if($i!==null){var b=$i.memoizedState;if(v=b.destroy,_!==null&&BC(_,b.deps)){g.memoizedState=qh(c,h,v,_);return}}Ni.flags|=s,g.memoizedState=qh(1|c,h,v,_)}function wU(s,c){return rf(8390656,8,s,c)}function HC(s,c){return Bf(2048,8,s,c)}function vx(s,c){return Bf(4,2,s,c)}function Rx(s,c){return Bf(4,4,s,c)}function Cx(s,c){if(typeof c=="function")return s=s(),c(s),function(){c(null)};if(c!=null)return s=s(),c.current=s,function(){c.current=null}}function yx(s,c,h){return h=h!=null?h.concat([s]):null,Bf(4,4,Cx.bind(null,c,s),h)}function KC(){}function Ix(s,c){var h=oo();c=c===void 0?null:c;var _=h.memoizedState;return _!==null&&c!==null&&BC(c,_[1])?_[0]:(h.memoizedState=[s,c],s)}function wx(s,c){var h=oo();c=c===void 0?null:c;var _=h.memoizedState;return _!==null&&c!==null&&BC(c,_[1])?_[0]:(s=s(),h.memoizedState=[s,c],s)}function Ax(s,c,h){return Vc&21?(No(h,c)||(h=P2(),Ni.lanes|=h,Fc|=h,s.baseState=!0),c):(s.baseState&&(s.baseState=!1,cn=!0),s.memoizedState=h)}function SX(s,c){var h=$t;$t=h!==0&&4>h?h:4,s(!0);var _=lR.transition;lR.transition={};try{s(!1),c()}finally{$t=h,lR.transition=_}}function Ox(){return oo().memoizedState}function TX(s,c,h){var _=La(s);if(h={lane:_,action:h,hasEagerState:!1,eagerState:null,next:null},bx(s))Nx(c,h);else if(h=dx(s,c,h,_),h!==null){var g=Gr();bo(h,s,_,g),Dx(h,c,_)}}function vX(s,c,h){var _=La(s),g={lane:_,action:h,hasEagerState:!1,eagerState:null,next:null};if(bx(s))Nx(c,g);else{var v=s.alternate;if(s.lanes===0&&(v===null||v.lanes===0)&&(v=c.lastRenderedReducer,v!==null))try{var b=c.lastRenderedState,L=v(b,h);if(g.hasEagerState=!0,g.eagerState=L,No(L,b)){var x=c.interleaved;x===null?(g.next=g,UC(c)):(g.next=x.next,x.next=g),c.interleaved=g;return}}catch{}finally{}h=dx(s,c,g,_),h!==null&&(g=Gr(),bo(h,s,_,g),Dx(h,c,_))}}function bx(s){var c=s.alternate;return s===Ni||c!==null&&c===Ni}function Nx(s,c){bh=Af=!0;var h=s.pending;h===null?c.next=c:(c.next=h.next,h.next=c),s.pending=c}function Dx(s,c,h){if(h&4194240){var _=c.lanes;_&=s.pendingLanes,h|=_,c.lanes=h,RC(s,h)}}var Of={readContext:no,useCallback:Or,useContext:Or,useEffect:Or,useImperativeHandle:Or,useInsertionEffect:Or,useLayoutEffect:Or,useMemo:Or,useReducer:Or,useRef:Or,useState:Or,useDebugValue:Or,useDeferredValue:Or,useTransition:Or,useMutableSource:Or,useSyncExternalStore:Or,useId:Or,unstable_isNewReconciler:!1},RX={readContext:no,useCallback:function(s,c){return ns().memoizedState=[s,c===void 0?null:c],s},useContext:no,useEffect:wU,useImperativeHandle:function(s,c,h){return h=h!=null?h.concat([s]):null,rf(4194308,4,Cx.bind(null,c,s),h)},useLayoutEffect:function(s,c){return rf(4194308,4,s,c)},useInsertionEffect:function(s,c){return rf(4,2,s,c)},useMemo:function(s,c){var h=ns();return c=c===void 0?null:c,s=s(),h.memoizedState=[s,c],s},useReducer:function(s,c,h){var _=ns();return c=h!==void 0?h(c):c,_.memoizedState=_.baseState=c,s={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:s,lastRenderedState:c},_.queue=s,s=s.dispatch=TX.bind(null,Ni,s),[_.memoizedState,s]},useRef:function(s){var c=ns();return s={current:s},c.memoizedState=s},useState:IU,useDebugValue:KC,useDeferredValue:function(s){return ns().memoizedState=s},useTransition:function(){var s=IU(!1),c=s[0];return s=SX.bind(null,s[1]),ns().memoizedState=s,[c,s]},useMutableSource:function(){},useSyncExternalStore:function(s,c,h){var _=Ni,g=ns();if(Ii){if(h===void 0)throw Error(Te(407));h=h()}else{if(h=c(),lr===null)throw Error(Te(349));Vc&30||_x(_,c,h)}g.memoizedState=h;var v={value:h,getSnapshot:c};return g.queue=v,wU(Ex.bind(null,_,v,s),[s]),_.flags|=2048,qh(9,fx.bind(null,_,v,h,c),void 0,null),h},useId:function(){var s=ns(),c=lr.identifierPrefix;if(Ii){var h=Os,_=As;h=(_&~(1<<32-Oo(_)-1)).toString(32)+h,c=":"+c+"R"+h,h=zh++,0<h&&(c+="H"+h.toString(32)),c+=":"}else h=gX++,c=":"+c+"r"+h.toString(32)+":";return s.memoizedState=c},unstable_isNewReconciler:!1},CX={readContext:no,useCallback:Ix,useContext:no,useEffect:HC,useImperativeHandle:yx,useInsertionEffect:vx,useLayoutEffect:Rx,useMemo:wx,useReducer:dR,useRef:Tx,useState:function(){return dR(Yh)},useDebugValue:KC,useDeferredValue:function(s){var c=oo();return Ax(c,$i.memoizedState,s)},useTransition:function(){var s=dR(Yh)[0],c=oo().memoizedState;return[s,c]},useMutableSource:px,useSyncExternalStore:mx,useId:Ox,unstable_isNewReconciler:!1},yX={readContext:no,useCallback:Ix,useContext:no,useEffect:HC,useImperativeHandle:yx,useInsertionEffect:vx,useLayoutEffect:Rx,useMemo:wx,useReducer:uR,useRef:Tx,useState:function(){return uR(Yh)},useDebugValue:KC,useDeferredValue:function(s){var c=oo();return $i===null?c.memoizedState=s:Ax(c,$i.memoizedState,s)},useTransition:function(){var s=uR(Yh)[0],c=oo().memoizedState;return[s,c]},useMutableSource:px,useSyncExternalStore:mx,useId:Ox,unstable_isNewReconciler:!1};function Io(s,c){if(s&&s.defaultProps){c=Di({},c),s=s.defaultProps;for(var h in s)c[h]===void 0&&(c[h]=s[h]);return c}return c}function YR(s,c,h,_){c=s.memoizedState,h=h(_,c),h=h==null?c:Di({},c,h),s.memoizedState=h,s.lanes===0&&(s.updateQueue.baseState=h)}var Gf={isMounted:function(s){return(s=s._reactInternals)?Gc(s)===s:!1},enqueueSetState:function(s,c,h){s=s._reactInternals;var _=Gr(),g=La(s),v=bs(_,g);v.payload=c,h!=null&&(v.callback=h),c=Pa(s,v,g),c!==null&&(bo(c,s,g,_),ef(c,s,g))},enqueueReplaceState:function(s,c,h){s=s._reactInternals;var _=Gr(),g=La(s),v=bs(_,g);v.tag=1,v.payload=c,h!=null&&(v.callback=h),c=Pa(s,v,g),c!==null&&(bo(c,s,g,_),ef(c,s,g))},enqueueForceUpdate:function(s,c){s=s._reactInternals;var h=Gr(),_=La(s),g=bs(h,_);g.tag=2,c!=null&&(g.callback=c),c=Pa(s,g,_),c!==null&&(bo(c,s,_,h),ef(c,s,_))}};function AU(s,c,h,_,g,v,b){return s=s.stateNode,typeof s.shouldComponentUpdate=="function"?s.shouldComponentUpdate(_,v,b):c.prototype&&c.prototype.isPureReactComponent?!jh(h,_)||!jh(g,v):!0}function Px(s,c,h){var _=!1,g=xa,v=c.contextType;return typeof v=="object"&&v!==null?v=no(v):(g=dn(c)?Uc:Pr.current,_=c.contextTypes,v=(_=_!=null)?Dd(s,g):xa),c=new c(h,v),s.memoizedState=c.state!==null&&c.state!==void 0?c.state:null,c.updater=Gf,s.stateNode=c,c._reactInternals=s,_&&(s=s.stateNode,s.__reactInternalMemoizedUnmaskedChildContext=g,s.__reactInternalMemoizedMaskedChildContext=v),c}function OU(s,c,h,_){s=c.state,typeof c.componentWillReceiveProps=="function"&&c.componentWillReceiveProps(h,_),typeof c.UNSAFE_componentWillReceiveProps=="function"&&c.UNSAFE_componentWillReceiveProps(h,_),c.state!==s&&Gf.enqueueReplaceState(c,c.state,null)}function qR(s,c,h,_){var g=s.stateNode;g.props=h,g.state=s.memoizedState,g.refs={},xC(s);var v=c.contextType;typeof v=="object"&&v!==null?g.context=no(v):(v=dn(c)?Uc:Pr.current,g.context=Dd(s,v)),g.state=s.memoizedState,v=c.getDerivedStateFromProps,typeof v=="function"&&(YR(s,c,v,h),g.state=s.memoizedState),typeof c.getDerivedStateFromProps=="function"||typeof g.getSnapshotBeforeUpdate=="function"||typeof g.UNSAFE_componentWillMount!="function"&&typeof g.componentWillMount!="function"||(c=g.state,typeof g.componentWillMount=="function"&&g.componentWillMount(),typeof g.UNSAFE_componentWillMount=="function"&&g.UNSAFE_componentWillMount(),c!==g.state&&Gf.enqueueReplaceState(g,g.state,null),If(s,h,g,_),g.state=s.memoizedState),typeof g.componentDidMount=="function"&&(s.flags|=4194308)}function Md(s,c){try{var h="",_=c;do h+=Z7(_),_=_.return;while(_);var g=h}catch(v){g=`
Error generating stack: `+v.message+`
`+v.stack}return{value:s,source:c,stack:g,digest:null}}function hR(s,c,h){return{value:s,source:null,stack:h??null,digest:c??null}}function JR(s,c){try{console.error(c.value)}catch(h){setTimeout(function(){throw h})}}var IX=typeof WeakMap=="function"?WeakMap:Map;function kx(s,c,h){h=bs(-1,h),h.tag=3,h.payload={element:null};var _=c.value;return h.callback=function(){Nf||(Nf=!0,oC=_),JR(s,c)},h}function Lx(s,c,h){h=bs(-1,h),h.tag=3;var _=s.type.getDerivedStateFromError;if(typeof _=="function"){var g=c.value;h.payload=function(){return _(g)},h.callback=function(){JR(s,c)}}var v=s.stateNode;return v!==null&&typeof v.componentDidCatch=="function"&&(h.callback=function(){JR(s,c),typeof _!="function"&&(ka===null?ka=new Set([this]):ka.add(this));var b=c.stack;this.componentDidCatch(c.value,{componentStack:b!==null?b:""})}),h}function bU(s,c,h){var _=s.pingCache;if(_===null){_=s.pingCache=new IX;var g=new Set;_.set(c,g)}else g=_.get(c),g===void 0&&(g=new Set,_.set(c,g));g.has(h)||(g.add(h),s=FX.bind(null,s,c,h),c.then(s,s))}function NU(s){do{var c;if((c=s.tag===13)&&(c=s.memoizedState,c=c!==null?c.dehydrated!==null:!0),c)return s;s=s.return}while(s!==null);return null}function DU(s,c,h,_,g){return s.mode&1?(s.flags|=65536,s.lanes=g,s):(s===c?s.flags|=65536:(s.flags|=128,h.flags|=131072,h.flags&=-52805,h.tag===1&&(h.alternate===null?h.tag=17:(c=bs(-1,1),c.tag=2,Pa(h,c,1))),h.lanes|=1),s)}var wX=Ls.ReactCurrentOwner,cn=!1;function Br(s,c,h,_){c.child=s===null?lx(c,null,h,_):kd(c,s.child,h,_)}function PU(s,c,h,_,g){h=h.render;var v=c.ref;return Od(c,g),_=GC(s,c,h,_,v,g),h=WC(),s!==null&&!cn?(c.updateQueue=s.updateQueue,c.flags&=-2053,s.lanes&=~g,ks(s,c,g)):(Ii&&h&&NC(c),c.flags|=1,Br(s,c,_,g),c.child)}function kU(s,c,h,_,g){if(s===null){var v=h.type;return typeof v=="function"&&!$C(v)&&v.defaultProps===void 0&&h.compare===null&&h.defaultProps===void 0?(c.tag=15,c.type=v,Mx(s,c,v,_,g)):(s=af(h.type,null,_,c,c.mode,g),s.ref=c.ref,s.return=c,c.child=s)}if(v=s.child,!(s.lanes&g)){var b=v.memoizedProps;if(h=h.compare,h=h!==null?h:jh,h(b,_)&&s.ref===c.ref)return ks(s,c,g)}return c.flags|=1,s=Ma(v,_),s.ref=c.ref,s.return=c,c.child=s}function Mx(s,c,h,_,g){if(s!==null){var v=s.memoizedProps;if(jh(v,_)&&s.ref===c.ref)if(cn=!1,c.pendingProps=_=v,(s.lanes&g)!==0)s.flags&131072&&(cn=!0);else return c.lanes=s.lanes,ks(s,c,g)}return XR(s,c,h,_,g)}function Ux(s,c,h){var _=c.pendingProps,g=_.children,v=s!==null?s.memoizedState:null;if(_.mode==="hidden")if(!(c.mode&1))c.memoizedState={baseLanes:0,cachePool:null,transitions:null},di(Cd,yn),yn|=h;else{if(!(h&1073741824))return s=v!==null?v.baseLanes|h:h,c.lanes=c.childLanes=1073741824,c.memoizedState={baseLanes:s,cachePool:null,transitions:null},c.updateQueue=null,di(Cd,yn),yn|=s,null;c.memoizedState={baseLanes:0,cachePool:null,transitions:null},_=v!==null?v.baseLanes:h,di(Cd,yn),yn|=_}else v!==null?(_=v.baseLanes|h,c.memoizedState=null):_=h,di(Cd,yn),yn|=_;return Br(s,c,g,h),c.child}function xx(s,c){var h=c.ref;(s===null&&h!==null||s!==null&&s.ref!==h)&&(c.flags|=512,c.flags|=2097152)}function XR(s,c,h,_,g){var v=dn(h)?Uc:Pr.current;return v=Dd(c,v),Od(c,g),h=GC(s,c,h,_,v,g),_=WC(),s!==null&&!cn?(c.updateQueue=s.updateQueue,c.flags&=-2053,s.lanes&=~g,ks(s,c,g)):(Ii&&_&&NC(c),c.flags|=1,Br(s,c,h,g),c.child)}function LU(s,c,h,_,g){if(dn(h)){var v=!0;Tf(c)}else v=!1;if(Od(c,g),c.stateNode===null)nf(s,c),Px(c,h,_),qR(c,h,_,g),_=!0;else if(s===null){var b=c.stateNode,L=c.memoizedProps;b.props=L;var x=b.context,W=h.contextType;typeof W=="object"&&W!==null?W=no(W):(W=dn(h)?Uc:Pr.current,W=Dd(c,W));var ee=h.getDerivedStateFromProps,K=typeof ee=="function"||typeof b.getSnapshotBeforeUpdate=="function";K||typeof b.UNSAFE_componentWillReceiveProps!="function"&&typeof b.componentWillReceiveProps!="function"||(L!==_||x!==W)&&OU(c,b,_,W),Ca=!1;var $=c.memoizedState;b.state=$,If(c,_,b,g),x=c.memoizedState,L!==_||$!==x||ln.current||Ca?(typeof ee=="function"&&(YR(c,h,ee,_),x=c.memoizedState),(L=Ca||AU(c,h,L,_,$,x,W))?(K||typeof b.UNSAFE_componentWillMount!="function"&&typeof b.componentWillMount!="function"||(typeof b.componentWillMount=="function"&&b.componentWillMount(),typeof b.UNSAFE_componentWillMount=="function"&&b.UNSAFE_componentWillMount()),typeof b.componentDidMount=="function"&&(c.flags|=4194308)):(typeof b.componentDidMount=="function"&&(c.flags|=4194308),c.memoizedProps=_,c.memoizedState=x),b.props=_,b.state=x,b.context=W,_=L):(typeof b.componentDidMount=="function"&&(c.flags|=4194308),_=!1)}else{b=c.stateNode,ux(s,c),L=c.memoizedProps,W=c.type===c.elementType?L:Io(c.type,L),b.props=W,K=c.pendingProps,$=b.context,x=h.contextType,typeof x=="object"&&x!==null?x=no(x):(x=dn(h)?Uc:Pr.current,x=Dd(c,x));var ge=h.getDerivedStateFromProps;(ee=typeof ge=="function"||typeof b.getSnapshotBeforeUpdate=="function")||typeof b.UNSAFE_componentWillReceiveProps!="function"&&typeof b.componentWillReceiveProps!="function"||(L!==K||$!==x)&&OU(c,b,_,x),Ca=!1,$=c.memoizedState,b.state=$,If(c,_,b,g);var le=c.memoizedState;L!==K||$!==le||ln.current||Ca?(typeof ge=="function"&&(YR(c,h,ge,_),le=c.memoizedState),(W=Ca||AU(c,h,W,_,$,le,x)||!1)?(ee||typeof b.UNSAFE_componentWillUpdate!="function"&&typeof b.componentWillUpdate!="function"||(typeof b.componentWillUpdate=="function"&&b.componentWillUpdate(_,le,x),typeof b.UNSAFE_componentWillUpdate=="function"&&b.UNSAFE_componentWillUpdate(_,le,x)),typeof b.componentDidUpdate=="function"&&(c.flags|=4),typeof b.getSnapshotBeforeUpdate=="function"&&(c.flags|=1024)):(typeof b.componentDidUpdate!="function"||L===s.memoizedProps&&$===s.memoizedState||(c.flags|=4),typeof b.getSnapshotBeforeUpdate!="function"||L===s.memoizedProps&&$===s.memoizedState||(c.flags|=1024),c.memoizedProps=_,c.memoizedState=le),b.props=_,b.state=le,b.context=x,_=W):(typeof b.componentDidUpdate!="function"||L===s.memoizedProps&&$===s.memoizedState||(c.flags|=4),typeof b.getSnapshotBeforeUpdate!="function"||L===s.memoizedProps&&$===s.memoizedState||(c.flags|=1024),_=!1)}return QR(s,c,h,_,v,g)}function QR(s,c,h,_,g,v){xx(s,c);var b=(c.flags&128)!==0;if(!_&&!b)return g&&SU(c,h,!1),ks(s,c,v);_=c.stateNode,wX.current=c;var L=b&&typeof h.getDerivedStateFromError!="function"?null:_.render();return c.flags|=1,s!==null&&b?(c.child=kd(c,s.child,null,v),c.child=kd(c,null,L,v)):Br(s,c,L,v),c.memoizedState=_.state,g&&SU(c,h,!0),c.child}function Vx(s){var c=s.stateNode;c.pendingContext?gU(s,c.pendingContext,c.pendingContext!==c.context):c.context&&gU(s,c.context,!1),VC(s,c.containerInfo)}function MU(s,c,h,_,g){return Pd(),PC(g),c.flags|=256,Br(s,c,h,_),c.child}var ZR={dehydrated:null,treeContext:null,retryLane:0};function $R(s){return{baseLanes:s,cachePool:null,transitions:null}}function Fx(s,c,h){var _=c.pendingProps,g=bi.current,v=!1,b=(c.flags&128)!==0,L;if((L=b)||(L=s!==null&&s.memoizedState===null?!1:(g&2)!==0),L?(v=!0,c.flags&=-129):(s===null||s.memoizedState!==null)&&(g|=1),di(bi,g&1),s===null)return KR(c),s=c.memoizedState,s!==null&&(s=s.dehydrated,s!==null)?(c.mode&1?s.data==="$!"?c.lanes=8:c.lanes=1073741824:c.lanes=1,null):(b=_.children,s=_.fallback,v?(_=c.mode,v=c.child,b={mode:"hidden",children:b},!(_&1)&&v!==null?(v.childLanes=0,v.pendingProps=b):v=Kf(b,_,0,null),s=Mc(s,_,h,null),v.return=c,s.return=c,v.sibling=s,c.child=v,c.child.memoizedState=$R(h),c.memoizedState=ZR,s):zC(c,b));if(g=s.memoizedState,g!==null&&(L=g.dehydrated,L!==null))return AX(s,c,b,_,L,g,h);if(v){v=_.fallback,b=c.mode,g=s.child,L=g.sibling;var x={mode:"hidden",children:_.children};return!(b&1)&&c.child!==g?(_=c.child,_.childLanes=0,_.pendingProps=x,c.deletions=null):(_=Ma(g,x),_.subtreeFlags=g.subtreeFlags&14680064),L!==null?v=Ma(L,v):(v=Mc(v,b,h,null),v.flags|=2),v.return=c,_.return=c,_.sibling=v,c.child=_,_=v,v=c.child,b=s.child.memoizedState,b=b===null?$R(h):{baseLanes:b.baseLanes|h,cachePool:null,transitions:b.transitions},v.memoizedState=b,v.childLanes=s.childLanes&~h,c.memoizedState=ZR,_}return v=s.child,s=v.sibling,_=Ma(v,{mode:"visible",children:_.children}),!(c.mode&1)&&(_.lanes=h),_.return=c,_.sibling=null,s!==null&&(h=c.deletions,h===null?(c.deletions=[s],c.flags|=16):h.push(s)),c.child=_,c.memoizedState=null,_}function zC(s,c){return c=Kf({mode:"visible",children:c},s.mode,0,null),c.return=s,s.child=c}function K_(s,c,h,_){return _!==null&&PC(_),kd(c,s.child,null,h),s=zC(c,c.pendingProps.children),s.flags|=2,c.memoizedState=null,s}function AX(s,c,h,_,g,v,b){if(h)return c.flags&256?(c.flags&=-257,_=hR(Error(Te(422))),K_(s,c,b,_)):c.memoizedState!==null?(c.child=s.child,c.flags|=128,null):(v=_.fallback,g=c.mode,_=Kf({mode:"visible",children:_.children},g,0,null),v=Mc(v,g,b,null),v.flags|=2,_.return=c,v.return=c,_.sibling=v,c.child=_,c.mode&1&&kd(c,s.child,null,b),c.child.memoizedState=$R(b),c.memoizedState=ZR,v);if(!(c.mode&1))return K_(s,c,b,null);if(g.data==="$!"){if(_=g.nextSibling&&g.nextSibling.dataset,_)var L=_.dgst;return _=L,v=Error(Te(419)),_=hR(v,_,void 0),K_(s,c,b,_)}if(L=(b&s.childLanes)!==0,cn||L){if(_=lr,_!==null){switch(b&-b){case 4:g=2;break;case 16:g=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:g=32;break;case 536870912:g=268435456;break;default:g=0}g=g&(_.suspendedLanes|b)?0:g,g!==0&&g!==v.retryLane&&(v.retryLane=g,Ps(s,g),bo(_,s,g,-1))}return ZC(),_=hR(Error(Te(421))),K_(s,c,b,_)}return g.data==="$?"?(c.flags|=128,c.child=s.child,c=jX.bind(null,s),g._reactRetry=c,null):(s=v.treeContext,In=Da(g.nextSibling),wn=c,Ii=!0,Ao=null,s!==null&&(eo[to++]=As,eo[to++]=Os,eo[to++]=xc,As=s.id,Os=s.overflow,xc=c),c=zC(c,_.children),c.flags|=4096,c)}function UU(s,c,h){s.lanes|=c;var _=s.alternate;_!==null&&(_.lanes|=c),zR(s.return,c,h)}function pR(s,c,h,_,g){var v=s.memoizedState;v===null?s.memoizedState={isBackwards:c,rendering:null,renderingStartTime:0,last:_,tail:h,tailMode:g}:(v.isBackwards=c,v.rendering=null,v.renderingStartTime=0,v.last=_,v.tail=h,v.tailMode=g)}function jx(s,c,h){var _=c.pendingProps,g=_.revealOrder,v=_.tail;if(Br(s,c,_.children,h),_=bi.current,_&2)_=_&1|2,c.flags|=128;else{if(s!==null&&s.flags&128)e:for(s=c.child;s!==null;){if(s.tag===13)s.memoizedState!==null&&UU(s,h,c);else if(s.tag===19)UU(s,h,c);else if(s.child!==null){s.child.return=s,s=s.child;continue}if(s===c)break e;for(;s.sibling===null;){if(s.return===null||s.return===c)break e;s=s.return}s.sibling.return=s.return,s=s.sibling}_&=1}if(di(bi,_),!(c.mode&1))c.memoizedState=null;else switch(g){case"forwards":for(h=c.child,g=null;h!==null;)s=h.alternate,s!==null&&wf(s)===null&&(g=h),h=h.sibling;h=g,h===null?(g=c.child,c.child=null):(g=h.sibling,h.sibling=null),pR(c,!1,g,h,v);break;case"backwards":for(h=null,g=c.child,c.child=null;g!==null;){if(s=g.alternate,s!==null&&wf(s)===null){c.child=g;break}s=g.sibling,g.sibling=h,h=g,g=s}pR(c,!0,h,null,v);break;case"together":pR(c,!1,null,null,void 0);break;default:c.memoizedState=null}return c.child}function nf(s,c){!(c.mode&1)&&s!==null&&(s.alternate=null,c.alternate=null,c.flags|=2)}function ks(s,c,h){if(s!==null&&(c.dependencies=s.dependencies),Fc|=c.lanes,!(h&c.childLanes))return null;if(s!==null&&c.child!==s.child)throw Error(Te(153));if(c.child!==null){for(s=c.child,h=Ma(s,s.pendingProps),c.child=h,h.return=c;s.sibling!==null;)s=s.sibling,h=h.sibling=Ma(s,s.pendingProps),h.return=c;h.sibling=null}return c.child}function OX(s,c,h){switch(c.tag){case 3:Vx(c),Pd();break;case 5:hx(c);break;case 1:dn(c.type)&&Tf(c);break;case 4:VC(c,c.stateNode.containerInfo);break;case 10:var _=c.type._context,g=c.memoizedProps.value;di(Cf,_._currentValue),_._currentValue=g;break;case 13:if(_=c.memoizedState,_!==null)return _.dehydrated!==null?(di(bi,bi.current&1),c.flags|=128,null):h&c.child.childLanes?Fx(s,c,h):(di(bi,bi.current&1),s=ks(s,c,h),s!==null?s.sibling:null);di(bi,bi.current&1);break;case 19:if(_=(h&c.childLanes)!==0,s.flags&128){if(_)return jx(s,c,h);c.flags|=128}if(g=c.memoizedState,g!==null&&(g.rendering=null,g.tail=null,g.lastEffect=null),di(bi,bi.current),_)break;return null;case 22:case 23:return c.lanes=0,Ux(s,c,h)}return ks(s,c,h)}var Bx,eC,Gx,Wx;Bx=function(s,c){for(var h=c.child;h!==null;){if(h.tag===5||h.tag===6)s.appendChild(h.stateNode);else if(h.tag!==4&&h.child!==null){h.child.return=h,h=h.child;continue}if(h===c)break;for(;h.sibling===null;){if(h.return===null||h.return===c)return;h=h.return}h.sibling.return=h.return,h=h.sibling}};eC=function(){};Gx=function(s,c,h,_){var g=s.memoizedProps;if(g!==_){s=c.stateNode,kc(as.current);var v=null;switch(h){case"input":g=RR(s,g),_=RR(s,_),v=[];break;case"select":g=Di({},g,{value:void 0}),_=Di({},_,{value:void 0}),v=[];break;case"textarea":g=IR(s,g),_=IR(s,_),v=[];break;default:typeof g.onClick!="function"&&typeof _.onClick=="function"&&(s.onclick=gf)}AR(h,_);var b;h=null;for(W in g)if(!_.hasOwnProperty(W)&&g.hasOwnProperty(W)&&g[W]!=null)if(W==="style"){var L=g[W];for(b in L)L.hasOwnProperty(b)&&(h||(h={}),h[b]="")}else W!=="dangerouslySetInnerHTML"&&W!=="children"&&W!=="suppressContentEditableWarning"&&W!=="suppressHydrationWarning"&&W!=="autoFocus"&&(kh.hasOwnProperty(W)?v||(v=[]):(v=v||[]).push(W,null));for(W in _){var x=_[W];if(L=g!=null?g[W]:void 0,_.hasOwnProperty(W)&&x!==L&&(x!=null||L!=null))if(W==="style")if(L){for(b in L)!L.hasOwnProperty(b)||x&&x.hasOwnProperty(b)||(h||(h={}),h[b]="");for(b in x)x.hasOwnProperty(b)&&L[b]!==x[b]&&(h||(h={}),h[b]=x[b])}else h||(v||(v=[]),v.push(W,h)),h=x;else W==="dangerouslySetInnerHTML"?(x=x?x.__html:void 0,L=L?L.__html:void 0,x!=null&&L!==x&&(v=v||[]).push(W,x)):W==="children"?typeof x!="string"&&typeof x!="number"||(v=v||[]).push(W,""+x):W!=="suppressContentEditableWarning"&&W!=="suppressHydrationWarning"&&(kh.hasOwnProperty(W)?(x!=null&&W==="onScroll"&&Ei("scroll",s),v||L===x||(v=[])):(v=v||[]).push(W,x))}h&&(v=v||[]).push("style",h);var W=v;(c.updateQueue=W)&&(c.flags|=4)}};Wx=function(s,c,h,_){h!==_&&(c.flags|=4)};function fh(s,c){if(!Ii)switch(s.tailMode){case"hidden":c=s.tail;for(var h=null;c!==null;)c.alternate!==null&&(h=c),c=c.sibling;h===null?s.tail=null:h.sibling=null;break;case"collapsed":h=s.tail;for(var _=null;h!==null;)h.alternate!==null&&(_=h),h=h.sibling;_===null?c||s.tail===null?s.tail=null:s.tail.sibling=null:_.sibling=null}}function br(s){var c=s.alternate!==null&&s.alternate.child===s.child,h=0,_=0;if(c)for(var g=s.child;g!==null;)h|=g.lanes|g.childLanes,_|=g.subtreeFlags&14680064,_|=g.flags&14680064,g.return=s,g=g.sibling;else for(g=s.child;g!==null;)h|=g.lanes|g.childLanes,_|=g.subtreeFlags,_|=g.flags,g.return=s,g=g.sibling;return s.subtreeFlags|=_,s.childLanes=h,c}function bX(s,c,h){var _=c.pendingProps;switch(DC(c),c.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return br(c),null;case 1:return dn(c.type)&&Sf(),br(c),null;case 3:return _=c.stateNode,Ld(),gi(ln),gi(Pr),jC(),_.pendingContext&&(_.context=_.pendingContext,_.pendingContext=null),(s===null||s.child===null)&&(W_(c)?c.flags|=4:s===null||s.memoizedState.isDehydrated&&!(c.flags&256)||(c.flags|=1024,Ao!==null&&(cC(Ao),Ao=null))),eC(s,c),br(c),null;case 5:FC(c);var g=kc(Kh.current);if(h=c.type,s!==null&&c.stateNode!=null)Gx(s,c,h,_,g),s.ref!==c.ref&&(c.flags|=512,c.flags|=2097152);else{if(!_){if(c.stateNode===null)throw Error(Te(166));return br(c),null}if(s=kc(as.current),W_(c)){_=c.stateNode,h=c.type;var v=c.memoizedProps;switch(_[os]=c,_[Wh]=v,s=(c.mode&1)!==0,h){case"dialog":Ei("cancel",_),Ei("close",_);break;case"iframe":case"object":case"embed":Ei("load",_);break;case"video":case"audio":for(g=0;g<vh.length;g++)Ei(vh[g],_);break;case"source":Ei("error",_);break;case"img":case"image":case"link":Ei("error",_),Ei("load",_);break;case"details":Ei("toggle",_);break;case"input":KM(_,v),Ei("invalid",_);break;case"select":_._wrapperState={wasMultiple:!!v.multiple},Ei("invalid",_);break;case"textarea":YM(_,v),Ei("invalid",_)}AR(h,v),g=null;for(var b in v)if(v.hasOwnProperty(b)){var L=v[b];b==="children"?typeof L=="string"?_.textContent!==L&&(v.suppressHydrationWarning!==!0&&G_(_.textContent,L,s),g=["children",L]):typeof L=="number"&&_.textContent!==""+L&&(v.suppressHydrationWarning!==!0&&G_(_.textContent,L,s),g=["children",""+L]):kh.hasOwnProperty(b)&&L!=null&&b==="onScroll"&&Ei("scroll",_)}switch(h){case"input":L_(_),zM(_,v,!0);break;case"textarea":L_(_),qM(_);break;case"select":case"option":break;default:typeof v.onClick=="function"&&(_.onclick=gf)}_=g,c.updateQueue=_,_!==null&&(c.flags|=4)}else{b=g.nodeType===9?g:g.ownerDocument,s==="http://www.w3.org/1999/xhtml"&&(s=E2(h)),s==="http://www.w3.org/1999/xhtml"?h==="script"?(s=b.createElement("div"),s.innerHTML="<script><\/script>",s=s.removeChild(s.firstChild)):typeof _.is=="string"?s=b.createElement(h,{is:_.is}):(s=b.createElement(h),h==="select"&&(b=s,_.multiple?b.multiple=!0:_.size&&(b.size=_.size))):s=b.createElementNS(s,h),s[os]=c,s[Wh]=_,Bx(s,c,!1,!1),c.stateNode=s;e:{switch(b=OR(h,_),h){case"dialog":Ei("cancel",s),Ei("close",s),g=_;break;case"iframe":case"object":case"embed":Ei("load",s),g=_;break;case"video":case"audio":for(g=0;g<vh.length;g++)Ei(vh[g],s);g=_;break;case"source":Ei("error",s),g=_;break;case"img":case"image":case"link":Ei("error",s),Ei("load",s),g=_;break;case"details":Ei("toggle",s),g=_;break;case"input":KM(s,_),g=RR(s,_),Ei("invalid",s);break;case"option":g=_;break;case"select":s._wrapperState={wasMultiple:!!_.multiple},g=Di({},_,{value:void 0}),Ei("invalid",s);break;case"textarea":YM(s,_),g=IR(s,_),Ei("invalid",s);break;default:g=_}AR(h,g),L=g;for(v in L)if(L.hasOwnProperty(v)){var x=L[v];v==="style"?T2(s,x):v==="dangerouslySetInnerHTML"?(x=x?x.__html:void 0,x!=null&&g2(s,x)):v==="children"?typeof x=="string"?(h!=="textarea"||x!=="")&&Lh(s,x):typeof x=="number"&&Lh(s,""+x):v!=="suppressContentEditableWarning"&&v!=="suppressHydrationWarning"&&v!=="autoFocus"&&(kh.hasOwnProperty(v)?x!=null&&v==="onScroll"&&Ei("scroll",s):x!=null&&fC(s,v,x,b))}switch(h){case"input":L_(s),zM(s,_,!1);break;case"textarea":L_(s),qM(s);break;case"option":_.value!=null&&s.setAttribute("value",""+Ua(_.value));break;case"select":s.multiple=!!_.multiple,v=_.value,v!=null?yd(s,!!_.multiple,v,!1):_.defaultValue!=null&&yd(s,!!_.multiple,_.defaultValue,!0);break;default:typeof g.onClick=="function"&&(s.onclick=gf)}switch(h){case"button":case"input":case"select":case"textarea":_=!!_.autoFocus;break e;case"img":_=!0;break e;default:_=!1}}_&&(c.flags|=4)}c.ref!==null&&(c.flags|=512,c.flags|=2097152)}return br(c),null;case 6:if(s&&c.stateNode!=null)Wx(s,c,s.memoizedProps,_);else{if(typeof _!="string"&&c.stateNode===null)throw Error(Te(166));if(h=kc(Kh.current),kc(as.current),W_(c)){if(_=c.stateNode,h=c.memoizedProps,_[os]=c,(v=_.nodeValue!==h)&&(s=wn,s!==null))switch(s.tag){case 3:G_(_.nodeValue,h,(s.mode&1)!==0);break;case 5:s.memoizedProps.suppressHydrationWarning!==!0&&G_(_.nodeValue,h,(s.mode&1)!==0)}v&&(c.flags|=4)}else _=(h.nodeType===9?h:h.ownerDocument).createTextNode(_),_[os]=c,c.stateNode=_}return br(c),null;case 13:if(gi(bi),_=c.memoizedState,s===null||s.memoizedState!==null&&s.memoizedState.dehydrated!==null){if(Ii&&In!==null&&c.mode&1&&!(c.flags&128))ax(),Pd(),c.flags|=98560,v=!1;else if(v=W_(c),_!==null&&_.dehydrated!==null){if(s===null){if(!v)throw Error(Te(318));if(v=c.memoizedState,v=v!==null?v.dehydrated:null,!v)throw Error(Te(317));v[os]=c}else Pd(),!(c.flags&128)&&(c.memoizedState=null),c.flags|=4;br(c),v=!1}else Ao!==null&&(cC(Ao),Ao=null),v=!0;if(!v)return c.flags&65536?c:null}return c.flags&128?(c.lanes=h,c):(_=_!==null,_!==(s!==null&&s.memoizedState!==null)&&_&&(c.child.flags|=8192,c.mode&1&&(s===null||bi.current&1?er===0&&(er=3):ZC())),c.updateQueue!==null&&(c.flags|=4),br(c),null);case 4:return Ld(),eC(s,c),s===null&&Bh(c.stateNode.containerInfo),br(c),null;case 10:return MC(c.type._context),br(c),null;case 17:return dn(c.type)&&Sf(),br(c),null;case 19:if(gi(bi),v=c.memoizedState,v===null)return br(c),null;if(_=(c.flags&128)!==0,b=v.rendering,b===null)if(_)fh(v,!1);else{if(er!==0||s!==null&&s.flags&128)for(s=c.child;s!==null;){if(b=wf(s),b!==null){for(c.flags|=128,fh(v,!1),_=b.updateQueue,_!==null&&(c.updateQueue=_,c.flags|=4),c.subtreeFlags=0,_=h,h=c.child;h!==null;)v=h,s=_,v.flags&=14680066,b=v.alternate,b===null?(v.childLanes=0,v.lanes=s,v.child=null,v.subtreeFlags=0,v.memoizedProps=null,v.memoizedState=null,v.updateQueue=null,v.dependencies=null,v.stateNode=null):(v.childLanes=b.childLanes,v.lanes=b.lanes,v.child=b.child,v.subtreeFlags=0,v.deletions=null,v.memoizedProps=b.memoizedProps,v.memoizedState=b.memoizedState,v.updateQueue=b.updateQueue,v.type=b.type,s=b.dependencies,v.dependencies=s===null?null:{lanes:s.lanes,firstContext:s.firstContext}),h=h.sibling;return di(bi,bi.current&1|2),c.child}s=s.sibling}v.tail!==null&&Wi()>Ud&&(c.flags|=128,_=!0,fh(v,!1),c.lanes=4194304)}else{if(!_)if(s=wf(b),s!==null){if(c.flags|=128,_=!0,h=s.updateQueue,h!==null&&(c.updateQueue=h,c.flags|=4),fh(v,!0),v.tail===null&&v.tailMode==="hidden"&&!b.alternate&&!Ii)return br(c),null}else 2*Wi()-v.renderingStartTime>Ud&&h!==1073741824&&(c.flags|=128,_=!0,fh(v,!1),c.lanes=4194304);v.isBackwards?(b.sibling=c.child,c.child=b):(h=v.last,h!==null?h.sibling=b:c.child=b,v.last=b)}return v.tail!==null?(c=v.tail,v.rendering=c,v.tail=c.sibling,v.renderingStartTime=Wi(),c.sibling=null,h=bi.current,di(bi,_?h&1|2:h&1),c):(br(c),null);case 22:case 23:return QC(),_=c.memoizedState!==null,s!==null&&s.memoizedState!==null!==_&&(c.flags|=8192),_&&c.mode&1?yn&1073741824&&(br(c),c.subtreeFlags&6&&(c.flags|=8192)):br(c),null;case 24:return null;case 25:return null}throw Error(Te(156,c.tag))}function NX(s,c){switch(DC(c),c.tag){case 1:return dn(c.type)&&Sf(),s=c.flags,s&65536?(c.flags=s&-65537|128,c):null;case 3:return Ld(),gi(ln),gi(Pr),jC(),s=c.flags,s&65536&&!(s&128)?(c.flags=s&-65537|128,c):null;case 5:return FC(c),null;case 13:if(gi(bi),s=c.memoizedState,s!==null&&s.dehydrated!==null){if(c.alternate===null)throw Error(Te(340));Pd()}return s=c.flags,s&65536?(c.flags=s&-65537|128,c):null;case 19:return gi(bi),null;case 4:return Ld(),null;case 10:return MC(c.type._context),null;case 22:case 23:return QC(),null;case 24:return null;default:return null}}var z_=!1,Nr=!1,DX=typeof WeakSet=="function"?WeakSet:Set,ke=null;function Rd(s,c){var h=s.ref;if(h!==null)if(typeof h=="function")try{h(null)}catch(_){xi(s,c,_)}else h.current=null}function tC(s,c,h){try{h()}catch(_){xi(s,c,_)}}var xU=!1;function PX(s,c){if(VR=_f,s=q2(),bC(s)){if("selectionStart"in s)var h={start:s.selectionStart,end:s.selectionEnd};else e:{h=(h=s.ownerDocument)&&h.defaultView||window;var _=h.getSelection&&h.getSelection();if(_&&_.rangeCount!==0){h=_.anchorNode;var g=_.anchorOffset,v=_.focusNode;_=_.focusOffset;try{h.nodeType,v.nodeType}catch{h=null;break e}var b=0,L=-1,x=-1,W=0,ee=0,K=s,$=null;t:for(;;){for(var ge;K!==h||g!==0&&K.nodeType!==3||(L=b+g),K!==v||_!==0&&K.nodeType!==3||(x=b+_),K.nodeType===3&&(b+=K.nodeValue.length),(ge=K.firstChild)!==null;)$=K,K=ge;for(;;){if(K===s)break t;if($===h&&++W===g&&(L=b),$===v&&++ee===_&&(x=b),(ge=K.nextSibling)!==null)break;K=$,$=K.parentNode}K=ge}h=L===-1||x===-1?null:{start:L,end:x}}else h=null}h=h||{start:0,end:0}}else h=null;for(FR={focusedElem:s,selectionRange:h},_f=!1,ke=c;ke!==null;)if(c=ke,s=c.child,(c.subtreeFlags&1028)!==0&&s!==null)s.return=c,ke=s;else for(;ke!==null;){c=ke;try{var le=c.alternate;if(c.flags&1024)switch(c.tag){case 0:case 11:case 15:break;case 1:if(le!==null){var X=le.memoizedProps,ve=le.memoizedState,H=c.stateNode,G=H.getSnapshotBeforeUpdate(c.elementType===c.type?X:Io(c.type,X),ve);H.__reactInternalSnapshotBeforeUpdate=G}break;case 3:var q=c.stateNode.containerInfo;q.nodeType===1?q.textContent="":q.nodeType===9&&q.documentElement&&q.removeChild(q.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(Te(163))}}catch(Ee){xi(c,c.return,Ee)}if(s=c.sibling,s!==null){s.return=c.return,ke=s;break}ke=c.return}return le=xU,xU=!1,le}function Nh(s,c,h){var _=c.updateQueue;if(_=_!==null?_.lastEffect:null,_!==null){var g=_=_.next;do{if((g.tag&s)===s){var v=g.destroy;g.destroy=void 0,v!==void 0&&tC(c,h,v)}g=g.next}while(g!==_)}}function Wf(s,c){if(c=c.updateQueue,c=c!==null?c.lastEffect:null,c!==null){var h=c=c.next;do{if((h.tag&s)===s){var _=h.create;h.destroy=_()}h=h.next}while(h!==c)}}function iC(s){var c=s.ref;if(c!==null){var h=s.stateNode;switch(s.tag){case 5:s=h;break;default:s=h}typeof c=="function"?c(s):c.current=s}}function Hx(s){var c=s.alternate;c!==null&&(s.alternate=null,Hx(c)),s.child=null,s.deletions=null,s.sibling=null,s.tag===5&&(c=s.stateNode,c!==null&&(delete c[os],delete c[Wh],delete c[GR],delete c[mX],delete c[_X])),s.stateNode=null,s.return=null,s.dependencies=null,s.memoizedProps=null,s.memoizedState=null,s.pendingProps=null,s.stateNode=null,s.updateQueue=null}function Kx(s){return s.tag===5||s.tag===3||s.tag===4}function VU(s){e:for(;;){for(;s.sibling===null;){if(s.return===null||Kx(s.return))return null;s=s.return}for(s.sibling.return=s.return,s=s.sibling;s.tag!==5&&s.tag!==6&&s.tag!==18;){if(s.flags&2||s.child===null||s.tag===4)continue e;s.child.return=s,s=s.child}if(!(s.flags&2))return s.stateNode}}function rC(s,c,h){var _=s.tag;if(_===5||_===6)s=s.stateNode,c?h.nodeType===8?h.parentNode.insertBefore(s,c):h.insertBefore(s,c):(h.nodeType===8?(c=h.parentNode,c.insertBefore(s,h)):(c=h,c.appendChild(s)),h=h._reactRootContainer,h!=null||c.onclick!==null||(c.onclick=gf));else if(_!==4&&(s=s.child,s!==null))for(rC(s,c,h),s=s.sibling;s!==null;)rC(s,c,h),s=s.sibling}function nC(s,c,h){var _=s.tag;if(_===5||_===6)s=s.stateNode,c?h.insertBefore(s,c):h.appendChild(s);else if(_!==4&&(s=s.child,s!==null))for(nC(s,c,h),s=s.sibling;s!==null;)nC(s,c,h),s=s.sibling}var _r=null,wo=!1;function va(s,c,h){for(h=h.child;h!==null;)zx(s,c,h),h=h.sibling}function zx(s,c,h){if(ss&&typeof ss.onCommitFiberUnmount=="function")try{ss.onCommitFiberUnmount(Mf,h)}catch{}switch(h.tag){case 5:Nr||Rd(h,c);case 6:var _=_r,g=wo;_r=null,va(s,c,h),_r=_,wo=g,_r!==null&&(wo?(s=_r,h=h.stateNode,s.nodeType===8?s.parentNode.removeChild(h):s.removeChild(h)):_r.removeChild(h.stateNode));break;case 18:_r!==null&&(wo?(s=_r,h=h.stateNode,s.nodeType===8?sR(s.parentNode,h):s.nodeType===1&&sR(s,h),Vh(s)):sR(_r,h.stateNode));break;case 4:_=_r,g=wo,_r=h.stateNode.containerInfo,wo=!0,va(s,c,h),_r=_,wo=g;break;case 0:case 11:case 14:case 15:if(!Nr&&(_=h.updateQueue,_!==null&&(_=_.lastEffect,_!==null))){g=_=_.next;do{var v=g,b=v.destroy;v=v.tag,b!==void 0&&(v&2||v&4)&&tC(h,c,b),g=g.next}while(g!==_)}va(s,c,h);break;case 1:if(!Nr&&(Rd(h,c),_=h.stateNode,typeof _.componentWillUnmount=="function"))try{_.props=h.memoizedProps,_.state=h.memoizedState,_.componentWillUnmount()}catch(L){xi(h,c,L)}va(s,c,h);break;case 21:va(s,c,h);break;case 22:h.mode&1?(Nr=(_=Nr)||h.memoizedState!==null,va(s,c,h),Nr=_):va(s,c,h);break;default:va(s,c,h)}}function FU(s){var c=s.updateQueue;if(c!==null){s.updateQueue=null;var h=s.stateNode;h===null&&(h=s.stateNode=new DX),c.forEach(function(_){var g=BX.bind(null,s,_);h.has(_)||(h.add(_),_.then(g,g))})}}function yo(s,c){var h=c.deletions;if(h!==null)for(var _=0;_<h.length;_++){var g=h[_];try{var v=s,b=c,L=b;e:for(;L!==null;){switch(L.tag){case 5:_r=L.stateNode,wo=!1;break e;case 3:_r=L.stateNode.containerInfo,wo=!0;break e;case 4:_r=L.stateNode.containerInfo,wo=!0;break e}L=L.return}if(_r===null)throw Error(Te(160));zx(v,b,g),_r=null,wo=!1;var x=g.alternate;x!==null&&(x.return=null),g.return=null}catch(W){xi(g,c,W)}}if(c.subtreeFlags&12854)for(c=c.child;c!==null;)Yx(c,s),c=c.sibling}function Yx(s,c){var h=s.alternate,_=s.flags;switch(s.tag){case 0:case 11:case 14:case 15:if(yo(c,s),rs(s),_&4){try{Nh(3,s,s.return),Wf(3,s)}catch(X){xi(s,s.return,X)}try{Nh(5,s,s.return)}catch(X){xi(s,s.return,X)}}break;case 1:yo(c,s),rs(s),_&512&&h!==null&&Rd(h,h.return);break;case 5:if(yo(c,s),rs(s),_&512&&h!==null&&Rd(h,h.return),s.flags&32){var g=s.stateNode;try{Lh(g,"")}catch(X){xi(s,s.return,X)}}if(_&4&&(g=s.stateNode,g!=null)){var v=s.memoizedProps,b=h!==null?h.memoizedProps:v,L=s.type,x=s.updateQueue;if(s.updateQueue=null,x!==null)try{L==="input"&&v.type==="radio"&&v.name!=null&&_2(g,v),OR(L,b);var W=OR(L,v);for(b=0;b<x.length;b+=2){var ee=x[b],K=x[b+1];ee==="style"?T2(g,K):ee==="dangerouslySetInnerHTML"?g2(g,K):ee==="children"?Lh(g,K):fC(g,ee,K,W)}switch(L){case"input":CR(g,v);break;case"textarea":f2(g,v);break;case"select":var $=g._wrapperState.wasMultiple;g._wrapperState.wasMultiple=!!v.multiple;var ge=v.value;ge!=null?yd(g,!!v.multiple,ge,!1):$!==!!v.multiple&&(v.defaultValue!=null?yd(g,!!v.multiple,v.defaultValue,!0):yd(g,!!v.multiple,v.multiple?[]:"",!1))}g[Wh]=v}catch(X){xi(s,s.return,X)}}break;case 6:if(yo(c,s),rs(s),_&4){if(s.stateNode===null)throw Error(Te(162));g=s.stateNode,v=s.memoizedProps;try{g.nodeValue=v}catch(X){xi(s,s.return,X)}}break;case 3:if(yo(c,s),rs(s),_&4&&h!==null&&h.memoizedState.isDehydrated)try{Vh(c.containerInfo)}catch(X){xi(s,s.return,X)}break;case 4:yo(c,s),rs(s);break;case 13:yo(c,s),rs(s),g=s.child,g.flags&8192&&(v=g.memoizedState!==null,g.stateNode.isHidden=v,!v||g.alternate!==null&&g.alternate.memoizedState!==null||(JC=Wi())),_&4&&FU(s);break;case 22:if(ee=h!==null&&h.memoizedState!==null,s.mode&1?(Nr=(W=Nr)||ee,yo(c,s),Nr=W):yo(c,s),rs(s),_&8192){if(W=s.memoizedState!==null,(s.stateNode.isHidden=W)&&!ee&&s.mode&1)for(ke=s,ee=s.child;ee!==null;){for(K=ke=ee;ke!==null;){switch($=ke,ge=$.child,$.tag){case 0:case 11:case 14:case 15:Nh(4,$,$.return);break;case 1:Rd($,$.return);var le=$.stateNode;if(typeof le.componentWillUnmount=="function"){_=$,h=$.return;try{c=_,le.props=c.memoizedProps,le.state=c.memoizedState,le.componentWillUnmount()}catch(X){xi(_,h,X)}}break;case 5:Rd($,$.return);break;case 22:if($.memoizedState!==null){BU(K);continue}}ge!==null?(ge.return=$,ke=ge):BU(K)}ee=ee.sibling}e:for(ee=null,K=s;;){if(K.tag===5){if(ee===null){ee=K;try{g=K.stateNode,W?(v=g.style,typeof v.setProperty=="function"?v.setProperty("display","none","important"):v.display="none"):(L=K.stateNode,x=K.memoizedProps.style,b=x!=null&&x.hasOwnProperty("display")?x.display:null,L.style.display=S2("display",b))}catch(X){xi(s,s.return,X)}}}else if(K.tag===6){if(ee===null)try{K.stateNode.nodeValue=W?"":K.memoizedProps}catch(X){xi(s,s.return,X)}}else if((K.tag!==22&&K.tag!==23||K.memoizedState===null||K===s)&&K.child!==null){K.child.return=K,K=K.child;continue}if(K===s)break e;for(;K.sibling===null;){if(K.return===null||K.return===s)break e;ee===K&&(ee=null),K=K.return}ee===K&&(ee=null),K.sibling.return=K.return,K=K.sibling}}break;case 19:yo(c,s),rs(s),_&4&&FU(s);break;case 21:break;default:yo(c,s),rs(s)}}function rs(s){var c=s.flags;if(c&2){try{e:{for(var h=s.return;h!==null;){if(Kx(h)){var _=h;break e}h=h.return}throw Error(Te(160))}switch(_.tag){case 5:var g=_.stateNode;_.flags&32&&(Lh(g,""),_.flags&=-33);var v=VU(s);nC(s,v,g);break;case 3:case 4:var b=_.stateNode.containerInfo,L=VU(s);rC(s,L,b);break;default:throw Error(Te(161))}}catch(x){xi(s,s.return,x)}s.flags&=-3}c&4096&&(s.flags&=-4097)}function kX(s,c,h){ke=s,qx(s)}function qx(s,c,h){for(var _=(s.mode&1)!==0;ke!==null;){var g=ke,v=g.child;if(g.tag===22&&_){var b=g.memoizedState!==null||z_;if(!b){var L=g.alternate,x=L!==null&&L.memoizedState!==null||Nr;L=z_;var W=Nr;if(z_=b,(Nr=x)&&!W)for(ke=g;ke!==null;)b=ke,x=b.child,b.tag===22&&b.memoizedState!==null?GU(g):x!==null?(x.return=b,ke=x):GU(g);for(;v!==null;)ke=v,qx(v),v=v.sibling;ke=g,z_=L,Nr=W}jU(s)}else g.subtreeFlags&8772&&v!==null?(v.return=g,ke=v):jU(s)}}function jU(s){for(;ke!==null;){var c=ke;if(c.flags&8772){var h=c.alternate;try{if(c.flags&8772)switch(c.tag){case 0:case 11:case 15:Nr||Wf(5,c);break;case 1:var _=c.stateNode;if(c.flags&4&&!Nr)if(h===null)_.componentDidMount();else{var g=c.elementType===c.type?h.memoizedProps:Io(c.type,h.memoizedProps);_.componentDidUpdate(g,h.memoizedState,_.__reactInternalSnapshotBeforeUpdate)}var v=c.updateQueue;v!==null&&yU(c,v,_);break;case 3:var b=c.updateQueue;if(b!==null){if(h=null,c.child!==null)switch(c.child.tag){case 5:h=c.child.stateNode;break;case 1:h=c.child.stateNode}yU(c,b,h)}break;case 5:var L=c.stateNode;if(h===null&&c.flags&4){h=L;var x=c.memoizedProps;switch(c.type){case"button":case"input":case"select":case"textarea":x.autoFocus&&h.focus();break;case"img":x.src&&(h.src=x.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(c.memoizedState===null){var W=c.alternate;if(W!==null){var ee=W.memoizedState;if(ee!==null){var K=ee.dehydrated;K!==null&&Vh(K)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(Te(163))}Nr||c.flags&512&&iC(c)}catch($){xi(c,c.return,$)}}if(c===s){ke=null;break}if(h=c.sibling,h!==null){h.return=c.return,ke=h;break}ke=c.return}}function BU(s){for(;ke!==null;){var c=ke;if(c===s){ke=null;break}var h=c.sibling;if(h!==null){h.return=c.return,ke=h;break}ke=c.return}}function GU(s){for(;ke!==null;){var c=ke;try{switch(c.tag){case 0:case 11:case 15:var h=c.return;try{Wf(4,c)}catch(x){xi(c,h,x)}break;case 1:var _=c.stateNode;if(typeof _.componentDidMount=="function"){var g=c.return;try{_.componentDidMount()}catch(x){xi(c,g,x)}}var v=c.return;try{iC(c)}catch(x){xi(c,v,x)}break;case 5:var b=c.return;try{iC(c)}catch(x){xi(c,b,x)}}}catch(x){xi(c,c.return,x)}if(c===s){ke=null;break}var L=c.sibling;if(L!==null){L.return=c.return,ke=L;break}ke=c.return}}var LX=Math.ceil,bf=Ls.ReactCurrentDispatcher,YC=Ls.ReactCurrentOwner,ro=Ls.ReactCurrentBatchConfig,Ft=0,lr=null,Yi=null,fr=0,yn=0,Cd=Fa(0),er=0,Jh=null,Fc=0,Hf=0,qC=0,Dh=null,an=null,JC=0,Ud=1/0,Is=null,Nf=!1,oC=null,ka=null,Y_=!1,Aa=null,Df=0,Ph=0,sC=null,of=-1,sf=0;function Gr(){return Ft&6?Wi():of!==-1?of:of=Wi()}function La(s){return s.mode&1?Ft&2&&fr!==0?fr&-fr:EX.transition!==null?(sf===0&&(sf=P2()),sf):(s=$t,s!==0||(s=window.event,s=s===void 0?16:F2(s.type)),s):1}function bo(s,c,h,_){if(50<Ph)throw Ph=0,sC=null,Error(Te(185));Qh(s,h,_),(!(Ft&2)||s!==lr)&&(s===lr&&(!(Ft&2)&&(Hf|=h),er===4&&Ia(s,fr)),un(s,_),h===1&&Ft===0&&!(c.mode&1)&&(Ud=Wi()+500,jf&&ja()))}function un(s,c){var h=s.callbackNode;EJ(s,c);var _=mf(s,s===lr?fr:0);if(_===0)h!==null&&QM(h),s.callbackNode=null,s.callbackPriority=0;else if(c=_&-_,s.callbackPriority!==c){if(h!=null&&QM(h),c===1)s.tag===0?fX(WU.bind(null,s)):nx(WU.bind(null,s)),hX(function(){!(Ft&6)&&ja()}),h=null;else{switch(k2(_)){case 1:h=vC;break;case 4:h=N2;break;case 16:h=pf;break;case 536870912:h=D2;break;default:h=pf}h=iV(h,Jx.bind(null,s))}s.callbackPriority=c,s.callbackNode=h}}function Jx(s,c){if(of=-1,sf=0,Ft&6)throw Error(Te(327));var h=s.callbackNode;if(bd()&&s.callbackNode!==h)return null;var _=mf(s,s===lr?fr:0);if(_===0)return null;if(_&30||_&s.expiredLanes||c)c=Pf(s,_);else{c=_;var g=Ft;Ft|=2;var v=Qx();(lr!==s||fr!==c)&&(Is=null,Ud=Wi()+500,Lc(s,c));do try{xX();break}catch(L){Xx(s,L)}while(1);LC(),bf.current=v,Ft=g,Yi!==null?c=0:(lr=null,fr=0,c=er)}if(c!==0){if(c===2&&(g=kR(s),g!==0&&(_=g,c=aC(s,g))),c===1)throw h=Jh,Lc(s,0),Ia(s,_),un(s,Wi()),h;if(c===6)Ia(s,_);else{if(g=s.current.alternate,!(_&30)&&!MX(g)&&(c=Pf(s,_),c===2&&(v=kR(s),v!==0&&(_=v,c=aC(s,v))),c===1))throw h=Jh,Lc(s,0),Ia(s,_),un(s,Wi()),h;switch(s.finishedWork=g,s.finishedLanes=_,c){case 0:case 1:throw Error(Te(345));case 2:Nc(s,an,Is);break;case 3:if(Ia(s,_),(_&130023424)===_&&(c=JC+500-Wi(),10<c)){if(mf(s,0)!==0)break;if(g=s.suspendedLanes,(g&_)!==_){Gr(),s.pingedLanes|=s.suspendedLanes&g;break}s.timeoutHandle=BR(Nc.bind(null,s,an,Is),c);break}Nc(s,an,Is);break;case 4:if(Ia(s,_),(_&4194240)===_)break;for(c=s.eventTimes,g=-1;0<_;){var b=31-Oo(_);v=1<<b,b=c[b],b>g&&(g=b),_&=~v}if(_=g,_=Wi()-_,_=(120>_?120:480>_?480:1080>_?1080:1920>_?1920:3e3>_?3e3:4320>_?4320:1960*LX(_/1960))-_,10<_){s.timeoutHandle=BR(Nc.bind(null,s,an,Is),_);break}Nc(s,an,Is);break;case 5:Nc(s,an,Is);break;default:throw Error(Te(329))}}}return un(s,Wi()),s.callbackNode===h?Jx.bind(null,s):null}function aC(s,c){var h=Dh;return s.current.memoizedState.isDehydrated&&(Lc(s,c).flags|=256),s=Pf(s,c),s!==2&&(c=an,an=h,c!==null&&cC(c)),s}function cC(s){an===null?an=s:an.push.apply(an,s)}function MX(s){for(var c=s;;){if(c.flags&16384){var h=c.updateQueue;if(h!==null&&(h=h.stores,h!==null))for(var _=0;_<h.length;_++){var g=h[_],v=g.getSnapshot;g=g.value;try{if(!No(v(),g))return!1}catch{return!1}}}if(h=c.child,c.subtreeFlags&16384&&h!==null)h.return=c,c=h;else{if(c===s)break;for(;c.sibling===null;){if(c.return===null||c.return===s)return!0;c=c.return}c.sibling.return=c.return,c=c.sibling}}return!0}function Ia(s,c){for(c&=~qC,c&=~Hf,s.suspendedLanes|=c,s.pingedLanes&=~c,s=s.expirationTimes;0<c;){var h=31-Oo(c),_=1<<h;s[h]=-1,c&=~_}}function WU(s){if(Ft&6)throw Error(Te(327));bd();var c=mf(s,0);if(!(c&1))return un(s,Wi()),null;var h=Pf(s,c);if(s.tag!==0&&h===2){var _=kR(s);_!==0&&(c=_,h=aC(s,_))}if(h===1)throw h=Jh,Lc(s,0),Ia(s,c),un(s,Wi()),h;if(h===6)throw Error(Te(345));return s.finishedWork=s.current.alternate,s.finishedLanes=c,Nc(s,an,Is),un(s,Wi()),null}function XC(s,c){var h=Ft;Ft|=1;try{return s(c)}finally{Ft=h,Ft===0&&(Ud=Wi()+500,jf&&ja())}}function jc(s){Aa!==null&&Aa.tag===0&&!(Ft&6)&&bd();var c=Ft;Ft|=1;var h=ro.transition,_=$t;try{if(ro.transition=null,$t=1,s)return s()}finally{$t=_,ro.transition=h,Ft=c,!(Ft&6)&&ja()}}function QC(){yn=Cd.current,gi(Cd)}function Lc(s,c){s.finishedWork=null,s.finishedLanes=0;var h=s.timeoutHandle;if(h!==-1&&(s.timeoutHandle=-1,uX(h)),Yi!==null)for(h=Yi.return;h!==null;){var _=h;switch(DC(_),_.tag){case 1:_=_.type.childContextTypes,_!=null&&Sf();break;case 3:Ld(),gi(ln),gi(Pr),jC();break;case 5:FC(_);break;case 4:Ld();break;case 13:gi(bi);break;case 19:gi(bi);break;case 10:MC(_.type._context);break;case 22:case 23:QC()}h=h.return}if(lr=s,Yi=s=Ma(s.current,null),fr=yn=c,er=0,Jh=null,qC=Hf=Fc=0,an=Dh=null,Pc!==null){for(c=0;c<Pc.length;c++)if(h=Pc[c],_=h.interleaved,_!==null){h.interleaved=null;var g=_.next,v=h.pending;if(v!==null){var b=v.next;v.next=g,_.next=b}h.pending=_}Pc=null}return s}function Xx(s,c){do{var h=Yi;try{if(LC(),tf.current=Of,Af){for(var _=Ni.memoizedState;_!==null;){var g=_.queue;g!==null&&(g.pending=null),_=_.next}Af=!1}if(Vc=0,cr=$i=Ni=null,bh=!1,zh=0,YC.current=null,h===null||h.return===null){er=1,Jh=c,Yi=null;break}e:{var v=s,b=h.return,L=h,x=c;if(c=fr,L.flags|=32768,x!==null&&typeof x=="object"&&typeof x.then=="function"){var W=x,ee=L,K=ee.tag;if(!(ee.mode&1)&&(K===0||K===11||K===15)){var $=ee.alternate;$?(ee.updateQueue=$.updateQueue,ee.memoizedState=$.memoizedState,ee.lanes=$.lanes):(ee.updateQueue=null,ee.memoizedState=null)}var ge=NU(b);if(ge!==null){ge.flags&=-257,DU(ge,b,L,v,c),ge.mode&1&&bU(v,W,c),c=ge,x=W;var le=c.updateQueue;if(le===null){var X=new Set;X.add(x),c.updateQueue=X}else le.add(x);break e}else{if(!(c&1)){bU(v,W,c),ZC();break e}x=Error(Te(426))}}else if(Ii&&L.mode&1){var ve=NU(b);if(ve!==null){!(ve.flags&65536)&&(ve.flags|=256),DU(ve,b,L,v,c),PC(Md(x,L));break e}}v=x=Md(x,L),er!==4&&(er=2),Dh===null?Dh=[v]:Dh.push(v),v=b;do{switch(v.tag){case 3:v.flags|=65536,c&=-c,v.lanes|=c;var H=kx(v,x,c);CU(v,H);break e;case 1:L=x;var G=v.type,q=v.stateNode;if(!(v.flags&128)&&(typeof G.getDerivedStateFromError=="function"||q!==null&&typeof q.componentDidCatch=="function"&&(ka===null||!ka.has(q)))){v.flags|=65536,c&=-c,v.lanes|=c;var Ee=Lx(v,L,c);CU(v,Ee);break e}}v=v.return}while(v!==null)}$x(h)}catch(we){c=we,Yi===h&&h!==null&&(Yi=h=h.return);continue}break}while(1)}function Qx(){var s=bf.current;return bf.current=Of,s===null?Of:s}function ZC(){(er===0||er===3||er===2)&&(er=4),lr===null||!(Fc&268435455)&&!(Hf&268435455)||Ia(lr,fr)}function Pf(s,c){var h=Ft;Ft|=2;var _=Qx();(lr!==s||fr!==c)&&(Is=null,Lc(s,c));do try{UX();break}catch(g){Xx(s,g)}while(1);if(LC(),Ft=h,bf.current=_,Yi!==null)throw Error(Te(261));return lr=null,fr=0,er}function UX(){for(;Yi!==null;)Zx(Yi)}function xX(){for(;Yi!==null&&!cJ();)Zx(Yi)}function Zx(s){var c=tV(s.alternate,s,yn);s.memoizedProps=s.pendingProps,c===null?$x(s):Yi=c,YC.current=null}function $x(s){var c=s;do{var h=c.alternate;if(s=c.return,c.flags&32768){if(h=NX(h,c),h!==null){h.flags&=32767,Yi=h;return}if(s!==null)s.flags|=32768,s.subtreeFlags=0,s.deletions=null;else{er=6,Yi=null;return}}else if(h=bX(h,c,yn),h!==null){Yi=h;return}if(c=c.sibling,c!==null){Yi=c;return}Yi=c=s}while(c!==null);er===0&&(er=5)}function Nc(s,c,h){var _=$t,g=ro.transition;try{ro.transition=null,$t=1,VX(s,c,h,_)}finally{ro.transition=g,$t=_}return null}function VX(s,c,h,_){do bd();while(Aa!==null);if(Ft&6)throw Error(Te(327));h=s.finishedWork;var g=s.finishedLanes;if(h===null)return null;if(s.finishedWork=null,s.finishedLanes=0,h===s.current)throw Error(Te(177));s.callbackNode=null,s.callbackPriority=0;var v=h.lanes|h.childLanes;if(gJ(s,v),s===lr&&(Yi=lr=null,fr=0),!(h.subtreeFlags&2064)&&!(h.flags&2064)||Y_||(Y_=!0,iV(pf,function(){return bd(),null})),v=(h.flags&15990)!==0,h.subtreeFlags&15990||v){v=ro.transition,ro.transition=null;var b=$t;$t=1;var L=Ft;Ft|=4,YC.current=null,PX(s,h),Yx(h,s),nX(FR),_f=!!VR,FR=VR=null,s.current=h,kX(h),lJ(),Ft=L,$t=b,ro.transition=v}else s.current=h;if(Y_&&(Y_=!1,Aa=s,Df=g),v=s.pendingLanes,v===0&&(ka=null),hJ(h.stateNode),un(s,Wi()),c!==null)for(_=s.onRecoverableError,h=0;h<c.length;h++)g=c[h],_(g.value,{componentStack:g.stack,digest:g.digest});if(Nf)throw Nf=!1,s=oC,oC=null,s;return Df&1&&s.tag!==0&&bd(),v=s.pendingLanes,v&1?s===sC?Ph++:(Ph=0,sC=s):Ph=0,ja(),null}function bd(){if(Aa!==null){var s=k2(Df),c=ro.transition,h=$t;try{if(ro.transition=null,$t=16>s?16:s,Aa===null)var _=!1;else{if(s=Aa,Aa=null,Df=0,Ft&6)throw Error(Te(331));var g=Ft;for(Ft|=4,ke=s.current;ke!==null;){var v=ke,b=v.child;if(ke.flags&16){var L=v.deletions;if(L!==null){for(var x=0;x<L.length;x++){var W=L[x];for(ke=W;ke!==null;){var ee=ke;switch(ee.tag){case 0:case 11:case 15:Nh(8,ee,v)}var K=ee.child;if(K!==null)K.return=ee,ke=K;else for(;ke!==null;){ee=ke;var $=ee.sibling,ge=ee.return;if(Hx(ee),ee===W){ke=null;break}if($!==null){$.return=ge,ke=$;break}ke=ge}}}var le=v.alternate;if(le!==null){var X=le.child;if(X!==null){le.child=null;do{var ve=X.sibling;X.sibling=null,X=ve}while(X!==null)}}ke=v}}if(v.subtreeFlags&2064&&b!==null)b.return=v,ke=b;else e:for(;ke!==null;){if(v=ke,v.flags&2048)switch(v.tag){case 0:case 11:case 15:Nh(9,v,v.return)}var H=v.sibling;if(H!==null){H.return=v.return,ke=H;break e}ke=v.return}}var G=s.current;for(ke=G;ke!==null;){b=ke;var q=b.child;if(b.subtreeFlags&2064&&q!==null)q.return=b,ke=q;else e:for(b=G;ke!==null;){if(L=ke,L.flags&2048)try{switch(L.tag){case 0:case 11:case 15:Wf(9,L)}}catch(we){xi(L,L.return,we)}if(L===b){ke=null;break e}var Ee=L.sibling;if(Ee!==null){Ee.return=L.return,ke=Ee;break e}ke=L.return}}if(Ft=g,ja(),ss&&typeof ss.onPostCommitFiberRoot=="function")try{ss.onPostCommitFiberRoot(Mf,s)}catch{}_=!0}return _}finally{$t=h,ro.transition=c}}return!1}function HU(s,c,h){c=Md(h,c),c=kx(s,c,1),s=Pa(s,c,1),c=Gr(),s!==null&&(Qh(s,1,c),un(s,c))}function xi(s,c,h){if(s.tag===3)HU(s,s,h);else for(;c!==null;){if(c.tag===3){HU(c,s,h);break}else if(c.tag===1){var _=c.stateNode;if(typeof c.type.getDerivedStateFromError=="function"||typeof _.componentDidCatch=="function"&&(ka===null||!ka.has(_))){s=Md(h,s),s=Lx(c,s,1),c=Pa(c,s,1),s=Gr(),c!==null&&(Qh(c,1,s),un(c,s));break}}c=c.return}}function FX(s,c,h){var _=s.pingCache;_!==null&&_.delete(c),c=Gr(),s.pingedLanes|=s.suspendedLanes&h,lr===s&&(fr&h)===h&&(er===4||er===3&&(fr&130023424)===fr&&500>Wi()-JC?Lc(s,0):qC|=h),un(s,c)}function eV(s,c){c===0&&(s.mode&1?(c=x_,x_<<=1,!(x_&130023424)&&(x_=4194304)):c=1);var h=Gr();s=Ps(s,c),s!==null&&(Qh(s,c,h),un(s,h))}function jX(s){var c=s.memoizedState,h=0;c!==null&&(h=c.retryLane),eV(s,h)}function BX(s,c){var h=0;switch(s.tag){case 13:var _=s.stateNode,g=s.memoizedState;g!==null&&(h=g.retryLane);break;case 19:_=s.stateNode;break;default:throw Error(Te(314))}_!==null&&_.delete(c),eV(s,h)}var tV;tV=function(s,c,h){if(s!==null)if(s.memoizedProps!==c.pendingProps||ln.current)cn=!0;else{if(!(s.lanes&h)&&!(c.flags&128))return cn=!1,OX(s,c,h);cn=!!(s.flags&131072)}else cn=!1,Ii&&c.flags&1048576&&ox(c,Rf,c.index);switch(c.lanes=0,c.tag){case 2:var _=c.type;nf(s,c),s=c.pendingProps;var g=Dd(c,Pr.current);Od(c,h),g=GC(null,c,_,s,g,h);var v=WC();return c.flags|=1,typeof g=="object"&&g!==null&&typeof g.render=="function"&&g.$$typeof===void 0?(c.tag=1,c.memoizedState=null,c.updateQueue=null,dn(_)?(v=!0,Tf(c)):v=!1,c.memoizedState=g.state!==null&&g.state!==void 0?g.state:null,xC(c),g.updater=Gf,c.stateNode=g,g._reactInternals=c,qR(c,_,s,h),c=QR(null,c,_,!0,v,h)):(c.tag=0,Ii&&v&&NC(c),Br(null,c,g,h),c=c.child),c;case 16:_=c.elementType;e:{switch(nf(s,c),s=c.pendingProps,g=_._init,_=g(_._payload),c.type=_,g=c.tag=WX(_),s=Io(_,s),g){case 0:c=XR(null,c,_,s,h);break e;case 1:c=LU(null,c,_,s,h);break e;case 11:c=PU(null,c,_,s,h);break e;case 14:c=kU(null,c,_,Io(_.type,s),h);break e}throw Error(Te(306,_,""))}return c;case 0:return _=c.type,g=c.pendingProps,g=c.elementType===_?g:Io(_,g),XR(s,c,_,g,h);case 1:return _=c.type,g=c.pendingProps,g=c.elementType===_?g:Io(_,g),LU(s,c,_,g,h);case 3:e:{if(Vx(c),s===null)throw Error(Te(387));_=c.pendingProps,v=c.memoizedState,g=v.element,ux(s,c),If(c,_,null,h);var b=c.memoizedState;if(_=b.element,v.isDehydrated)if(v={element:_,isDehydrated:!1,cache:b.cache,pendingSuspenseBoundaries:b.pendingSuspenseBoundaries,transitions:b.transitions},c.updateQueue.baseState=v,c.memoizedState=v,c.flags&256){g=Md(Error(Te(423)),c),c=MU(s,c,_,h,g);break e}else if(_!==g){g=Md(Error(Te(424)),c),c=MU(s,c,_,h,g);break e}else for(In=Da(c.stateNode.containerInfo.firstChild),wn=c,Ii=!0,Ao=null,h=lx(c,null,_,h),c.child=h;h;)h.flags=h.flags&-3|4096,h=h.sibling;else{if(Pd(),_===g){c=ks(s,c,h);break e}Br(s,c,_,h)}c=c.child}return c;case 5:return hx(c),s===null&&KR(c),_=c.type,g=c.pendingProps,v=s!==null?s.memoizedProps:null,b=g.children,jR(_,g)?b=null:v!==null&&jR(_,v)&&(c.flags|=32),xx(s,c),Br(s,c,b,h),c.child;case 6:return s===null&&KR(c),null;case 13:return Fx(s,c,h);case 4:return VC(c,c.stateNode.containerInfo),_=c.pendingProps,s===null?c.child=kd(c,null,_,h):Br(s,c,_,h),c.child;case 11:return _=c.type,g=c.pendingProps,g=c.elementType===_?g:Io(_,g),PU(s,c,_,g,h);case 7:return Br(s,c,c.pendingProps,h),c.child;case 8:return Br(s,c,c.pendingProps.children,h),c.child;case 12:return Br(s,c,c.pendingProps.children,h),c.child;case 10:e:{if(_=c.type._context,g=c.pendingProps,v=c.memoizedProps,b=g.value,di(Cf,_._currentValue),_._currentValue=b,v!==null)if(No(v.value,b)){if(v.children===g.children&&!ln.current){c=ks(s,c,h);break e}}else for(v=c.child,v!==null&&(v.return=c);v!==null;){var L=v.dependencies;if(L!==null){b=v.child;for(var x=L.firstContext;x!==null;){if(x.context===_){if(v.tag===1){x=bs(-1,h&-h),x.tag=2;var W=v.updateQueue;if(W!==null){W=W.shared;var ee=W.pending;ee===null?x.next=x:(x.next=ee.next,ee.next=x),W.pending=x}}v.lanes|=h,x=v.alternate,x!==null&&(x.lanes|=h),zR(v.return,h,c),L.lanes|=h;break}x=x.next}}else if(v.tag===10)b=v.type===c.type?null:v.child;else if(v.tag===18){if(b=v.return,b===null)throw Error(Te(341));b.lanes|=h,L=b.alternate,L!==null&&(L.lanes|=h),zR(b,h,c),b=v.sibling}else b=v.child;if(b!==null)b.return=v;else for(b=v;b!==null;){if(b===c){b=null;break}if(v=b.sibling,v!==null){v.return=b.return,b=v;break}b=b.return}v=b}Br(s,c,g.children,h),c=c.child}return c;case 9:return g=c.type,_=c.pendingProps.children,Od(c,h),g=no(g),_=_(g),c.flags|=1,Br(s,c,_,h),c.child;case 14:return _=c.type,g=Io(_,c.pendingProps),g=Io(_.type,g),kU(s,c,_,g,h);case 15:return Mx(s,c,c.type,c.pendingProps,h);case 17:return _=c.type,g=c.pendingProps,g=c.elementType===_?g:Io(_,g),nf(s,c),c.tag=1,dn(_)?(s=!0,Tf(c)):s=!1,Od(c,h),Px(c,_,g),qR(c,_,g,h),QR(null,c,_,!0,s,h);case 19:return jx(s,c,h);case 22:return Ux(s,c,h)}throw Error(Te(156,c.tag))};function iV(s,c){return b2(s,c)}function GX(s,c,h,_){this.tag=s,this.key=h,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=c,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=_,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function io(s,c,h,_){return new GX(s,c,h,_)}function $C(s){return s=s.prototype,!(!s||!s.isReactComponent)}function WX(s){if(typeof s=="function")return $C(s)?1:0;if(s!=null){if(s=s.$$typeof,s===gC)return 11;if(s===SC)return 14}return 2}function Ma(s,c){var h=s.alternate;return h===null?(h=io(s.tag,c,s.key,s.mode),h.elementType=s.elementType,h.type=s.type,h.stateNode=s.stateNode,h.alternate=s,s.alternate=h):(h.pendingProps=c,h.type=s.type,h.flags=0,h.subtreeFlags=0,h.deletions=null),h.flags=s.flags&14680064,h.childLanes=s.childLanes,h.lanes=s.lanes,h.child=s.child,h.memoizedProps=s.memoizedProps,h.memoizedState=s.memoizedState,h.updateQueue=s.updateQueue,c=s.dependencies,h.dependencies=c===null?null:{lanes:c.lanes,firstContext:c.firstContext},h.sibling=s.sibling,h.index=s.index,h.ref=s.ref,h}function af(s,c,h,_,g,v){var b=2;if(_=s,typeof s=="function")$C(s)&&(b=1);else if(typeof s=="string")b=5;else e:switch(s){case pd:return Mc(h.children,g,v,c);case EC:b=8,g|=8;break;case gR:return s=io(12,h,c,g|2),s.elementType=gR,s.lanes=v,s;case SR:return s=io(13,h,c,g),s.elementType=SR,s.lanes=v,s;case TR:return s=io(19,h,c,g),s.elementType=TR,s.lanes=v,s;case h2:return Kf(h,g,v,c);default:if(typeof s=="object"&&s!==null)switch(s.$$typeof){case d2:b=10;break e;case u2:b=9;break e;case gC:b=11;break e;case SC:b=14;break e;case Ra:b=16,_=null;break e}throw Error(Te(130,s==null?s:typeof s,""))}return c=io(b,h,c,g),c.elementType=s,c.type=_,c.lanes=v,c}function Mc(s,c,h,_){return s=io(7,s,_,c),s.lanes=h,s}function Kf(s,c,h,_){return s=io(22,s,_,c),s.elementType=h2,s.lanes=h,s.stateNode={isHidden:!1},s}function mR(s,c,h){return s=io(6,s,null,c),s.lanes=h,s}function _R(s,c,h){return c=io(4,s.children!==null?s.children:[],s.key,c),c.lanes=h,c.stateNode={containerInfo:s.containerInfo,pendingChildren:null,implementation:s.implementation},c}function HX(s,c,h,_,g){this.tag=c,this.containerInfo=s,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Jv(0),this.expirationTimes=Jv(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Jv(0),this.identifierPrefix=_,this.onRecoverableError=g,this.mutableSourceEagerHydrationData=null}function ey(s,c,h,_,g,v,b,L,x){return s=new HX(s,c,h,L,x),c===1?(c=1,v===!0&&(c|=8)):c=0,v=io(3,null,null,c),s.current=v,v.stateNode=s,v.memoizedState={element:_,isDehydrated:h,cache:null,transitions:null,pendingSuspenseBoundaries:null},xC(v),s}function KX(s,c,h){var _=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:hd,key:_==null?null:""+_,children:s,containerInfo:c,implementation:h}}function rV(s){if(!s)return xa;s=s._reactInternals;e:{if(Gc(s)!==s||s.tag!==1)throw Error(Te(170));var c=s;do{switch(c.tag){case 3:c=c.stateNode.context;break e;case 1:if(dn(c.type)){c=c.stateNode.__reactInternalMemoizedMergedChildContext;break e}}c=c.return}while(c!==null);throw Error(Te(171))}if(s.tag===1){var h=s.type;if(dn(h))return rx(s,h,c)}return c}function nV(s,c,h,_,g,v,b,L,x){return s=ey(h,_,!0,s,g,v,b,L,x),s.context=rV(null),h=s.current,_=Gr(),g=La(h),v=bs(_,g),v.callback=c??null,Pa(h,v,g),s.current.lanes=g,Qh(s,g,_),un(s,_),s}function zf(s,c,h,_){var g=c.current,v=Gr(),b=La(g);return h=rV(h),c.context===null?c.context=h:c.pendingContext=h,c=bs(v,b),c.payload={element:s},_=_===void 0?null:_,_!==null&&(c.callback=_),s=Pa(g,c,b),s!==null&&(bo(s,g,b,v),ef(s,g,b)),b}function kf(s){if(s=s.current,!s.child)return null;switch(s.child.tag){case 5:return s.child.stateNode;default:return s.child.stateNode}}function KU(s,c){if(s=s.memoizedState,s!==null&&s.dehydrated!==null){var h=s.retryLane;s.retryLane=h!==0&&h<c?h:c}}function ty(s,c){KU(s,c),(s=s.alternate)&&KU(s,c)}function zX(){return null}var oV=typeof reportError=="function"?reportError:function(s){console.error(s)};function iy(s){this._internalRoot=s}Yf.prototype.render=iy.prototype.render=function(s){var c=this._internalRoot;if(c===null)throw Error(Te(409));zf(s,c,null,null)};Yf.prototype.unmount=iy.prototype.unmount=function(){var s=this._internalRoot;if(s!==null){this._internalRoot=null;var c=s.containerInfo;jc(function(){zf(null,s,null,null)}),c[Ds]=null}};function Yf(s){this._internalRoot=s}Yf.prototype.unstable_scheduleHydration=function(s){if(s){var c=U2();s={blockedOn:null,target:s,priority:c};for(var h=0;h<ya.length&&c!==0&&c<ya[h].priority;h++);ya.splice(h,0,s),h===0&&V2(s)}};function ry(s){return!(!s||s.nodeType!==1&&s.nodeType!==9&&s.nodeType!==11)}function qf(s){return!(!s||s.nodeType!==1&&s.nodeType!==9&&s.nodeType!==11&&(s.nodeType!==8||s.nodeValue!==" react-mount-point-unstable "))}function zU(){}function YX(s,c,h,_,g){if(g){if(typeof _=="function"){var v=_;_=function(){var W=kf(b);v.call(W)}}var b=nV(c,_,s,0,null,!1,!1,"",zU);return s._reactRootContainer=b,s[Ds]=b.current,Bh(s.nodeType===8?s.parentNode:s),jc(),b}for(;g=s.lastChild;)s.removeChild(g);if(typeof _=="function"){var L=_;_=function(){var W=kf(x);L.call(W)}}var x=ey(s,0,!1,null,null,!1,!1,"",zU);return s._reactRootContainer=x,s[Ds]=x.current,Bh(s.nodeType===8?s.parentNode:s),jc(function(){zf(c,x,h,_)}),x}function Jf(s,c,h,_,g){var v=h._reactRootContainer;if(v){var b=v;if(typeof g=="function"){var L=g;g=function(){var x=kf(b);L.call(x)}}zf(c,b,s,g)}else b=YX(h,c,s,g,_);return kf(b)}L2=function(s){switch(s.tag){case 3:var c=s.stateNode;if(c.current.memoizedState.isDehydrated){var h=Th(c.pendingLanes);h!==0&&(RC(c,h|1),un(c,Wi()),!(Ft&6)&&(Ud=Wi()+500,ja()))}break;case 13:jc(function(){var _=Ps(s,1);if(_!==null){var g=Gr();bo(_,s,1,g)}}),ty(s,1)}};CC=function(s){if(s.tag===13){var c=Ps(s,134217728);if(c!==null){var h=Gr();bo(c,s,134217728,h)}ty(s,134217728)}};M2=function(s){if(s.tag===13){var c=La(s),h=Ps(s,c);if(h!==null){var _=Gr();bo(h,s,c,_)}ty(s,c)}};U2=function(){return $t};x2=function(s,c){var h=$t;try{return $t=s,c()}finally{$t=h}};NR=function(s,c,h){switch(c){case"input":if(CR(s,h),c=h.name,h.type==="radio"&&c!=null){for(h=s;h.parentNode;)h=h.parentNode;for(h=h.querySelectorAll("input[name="+JSON.stringify(""+c)+'][type="radio"]'),c=0;c<h.length;c++){var _=h[c];if(_!==s&&_.form===s.form){var g=Ff(_);if(!g)throw Error(Te(90));m2(_),CR(_,g)}}}break;case"textarea":f2(s,h);break;case"select":c=h.value,c!=null&&yd(s,!!h.multiple,c,!1)}};C2=XC;y2=jc;var qX={usingClientEntryPoint:!1,Events:[$h,Ed,Ff,v2,R2,XC]},Eh={findFiberByHostInstance:Dc,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},JX={bundleType:Eh.bundleType,version:Eh.version,rendererPackageName:Eh.rendererPackageName,rendererConfig:Eh.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:Ls.ReactCurrentDispatcher,findHostInstanceByFiber:function(s){return s=A2(s),s===null?null:s.stateNode},findFiberByHostInstance:Eh.findFiberByHostInstance||zX,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var q_=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!q_.isDisabled&&q_.supportsFiber)try{Mf=q_.inject(JX),ss=q_}catch{}}On.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=qX;On.createPortal=function(s,c){var h=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!ry(c))throw Error(Te(200));return KX(s,c,null,h)};On.createRoot=function(s,c){if(!ry(s))throw Error(Te(299));var h=!1,_="",g=oV;return c!=null&&(c.unstable_strictMode===!0&&(h=!0),c.identifierPrefix!==void 0&&(_=c.identifierPrefix),c.onRecoverableError!==void 0&&(g=c.onRecoverableError)),c=ey(s,1,!1,null,null,h,!1,_,g),s[Ds]=c.current,Bh(s.nodeType===8?s.parentNode:s),new iy(c)};On.findDOMNode=function(s){if(s==null)return null;if(s.nodeType===1)return s;var c=s._reactInternals;if(c===void 0)throw typeof s.render=="function"?Error(Te(188)):(s=Object.keys(s).join(","),Error(Te(268,s)));return s=A2(c),s=s===null?null:s.stateNode,s};On.flushSync=function(s){return jc(s)};On.hydrate=function(s,c,h){if(!qf(c))throw Error(Te(200));return Jf(null,s,c,!0,h)};On.hydrateRoot=function(s,c,h){if(!ry(s))throw Error(Te(405));var _=h!=null&&h.hydratedSources||null,g=!1,v="",b=oV;if(h!=null&&(h.unstable_strictMode===!0&&(g=!0),h.identifierPrefix!==void 0&&(v=h.identifierPrefix),h.onRecoverableError!==void 0&&(b=h.onRecoverableError)),c=nV(c,null,s,1,h??null,g,!1,v,b),s[Ds]=c.current,Bh(s),_)for(s=0;s<_.length;s++)h=_[s],g=h._getVersion,g=g(h._source),c.mutableSourceEagerHydrationData==null?c.mutableSourceEagerHydrationData=[h,g]:c.mutableSourceEagerHydrationData.push(h,g);return new Yf(c)};On.render=function(s,c,h){if(!qf(c))throw Error(Te(200));return Jf(null,s,c,!1,h)};On.unmountComponentAtNode=function(s){if(!qf(s))throw Error(Te(40));return s._reactRootContainer?(jc(function(){Jf(null,null,s,!1,function(){s._reactRootContainer=null,s[Ds]=null})}),!0):!1};On.unstable_batchedUpdates=XC;On.unstable_renderSubtreeIntoContainer=function(s,c,h,_){if(!qf(h))throw Error(Te(200));if(s==null||s._reactInternals===void 0)throw Error(Te(38));return Jf(s,c,h,!1,_)};On.version="18.3.1-next-f1338f8080-20240426";function sV(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(sV)}catch(s){console.error(s)}}sV(),s2.exports=On;var XX=s2.exports,YU=XX;fR.createRoot=YU.createRoot,fR.hydrateRoot=YU.hydrateRoot;/**
 * @license agora-rtc-react
 * @version 2.2.0
 *
 * Copyright (c) Agora, Inc.
 *
 * This source code is licensed under the MIT license.
 */var QX=Object.create,ny=Object.defineProperty,ZX=Object.getOwnPropertyDescriptor,$X=Object.getOwnPropertyNames,eQ=Object.getPrototypeOf,tQ=Object.prototype.hasOwnProperty,iQ=(s,c)=>()=>(c||s((c={exports:{}}).exports,c),c.exports),rQ=(s,c)=>{for(var h in c)ny(s,h,{get:c[h],enumerable:!0})},aV=(s,c,h,_)=>{if(c&&typeof c=="object"||typeof c=="function")for(let g of $X(c))!tQ.call(s,g)&&g!==h&&ny(s,g,{get:()=>c[g],enumerable:!(_=ZX(c,g))||_.enumerable});return s},nQ=(s,c,h)=>(aV(s,c,"default"),h),Wc=(s,c,h)=>(h=s!=null?QX(eQ(s)):{},aV(!s||!s.__esModule?ny(h,"default",{value:s,enumerable:!0}):h,s)),Hc=iQ((s,c)=>{(function(h,_){typeof s=="object"&&typeof c<"u"?c.exports=_():typeof define=="function"&&define.amd?define(_):(h=typeof globalThis<"u"?globalThis:h||self).AgoraRTC=_()})(s,function(){function h(e,t){return t.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(r){if(r!=="default"&&!(r in e)){var n=Object.getOwnPropertyDescriptor(i,r);Object.defineProperty(e,r,n.get?n:{enumerable:!0,get:function(){return i[r]}})}})}),Object.freeze(e)}var _=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function g(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var v=function(e){try{return!!e()}catch{return!0}},b=!v(function(){var e=(function(){}).bind();return typeof e!="function"||e.hasOwnProperty("prototype")}),L=b,x=Function.prototype,W=x.call,ee=L&&x.bind.bind(W,W),K=L?ee:function(e){return function(){return W.apply(e,arguments)}},$=K({}.isPrototypeOf),ge=function(e){return e&&e.Math==Math&&e},le=ge(typeof globalThis=="object"&&globalThis)||ge(typeof window=="object"&&window)||ge(typeof self=="object"&&self)||ge(typeof _=="object"&&_)||function(){return this}()||_||Function("return this")(),X=b,ve=Function.prototype,H=ve.apply,G=ve.call,q=typeof Reflect=="object"&&Reflect.apply||(X?G.bind(H):function(){return G.apply(H,arguments)}),Ee=K,we=Ee({}.toString),Fe=Ee("".slice),De=function(e){return Fe(we(e),8,-1)},ze=De,wi=K,pt=function(e){if(ze(e)==="Function")return wi(e)},kr=typeof document=="object"&&document.all,Po={all:kr,IS_HTMLDDA:kr===void 0&&kr!==void 0},Ga=Po.all,ui=Po.IS_HTMLDDA?function(e){return typeof e=="function"||e===Ga}:function(e){return typeof e=="function"},Wa={},dr=!v(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!=7}),jd=b,Ne=Function.prototype.call,Le=jd?Ne.bind(Ne):function(){return Ne.apply(Ne,arguments)},lt={},Si={}.propertyIsEnumerable,Vi=Object.getOwnPropertyDescriptor,Yc=Vi&&!Si.call({1:2},1);lt.f=Yc?function(e){var t=Vi(this,e);return!!t&&t.enumerable}:Si;var gr,Us,Sr=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},qc=v,NV=De,$f=Object,DV=K("".split),tp=qc(function(){return!$f("z").propertyIsEnumerable(0)})?function(e){return NV(e)=="String"?DV(e,""):$f(e)}:$f,Jc=function(e){return e==null},PV=Jc,kV=TypeError,Xc=function(e){if(PV(e))throw kV("Can't call method on "+e);return e},LV=tp,MV=Xc,xs=function(e){return LV(MV(e))},dy=ui,UV=Po.all,zr=Po.IS_HTMLDDA?function(e){return typeof e=="object"?e!==null:dy(e)||e===UV}:function(e){return typeof e=="object"?e!==null:dy(e)},so={},eE=so,tE=le,xV=ui,uy=function(e){return xV(e)?e:void 0},Lr=function(e,t){return arguments.length<2?uy(eE[e])||uy(tE[e]):eE[e]&&eE[e][t]||tE[e]&&tE[e][t]},Ha=typeof navigator<"u"&&String(navigator.userAgent)||"",hy=le,iE=Ha,py=hy.process,my=hy.Deno,_y=py&&py.versions||my&&my.version,fy=_y&&_y.v8;fy&&(Us=(gr=fy.split("."))[0]>0&&gr[0]<4?1:+(gr[0]+gr[1])),!Us&&iE&&(!(gr=iE.match(/Edge\/(\d+)/))||gr[1]>=74)&&(gr=iE.match(/Chrome\/(\d+)/))&&(Us=+gr[1]);var Ka=Us,Ey=Ka,VV=v,FV=le.String,Qc=!!Object.getOwnPropertySymbols&&!VV(function(){var e=Symbol();return!FV(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Ey&&Ey<41}),gy=Qc&&!Symbol.sham&&typeof Symbol.iterator=="symbol",jV=Lr,BV=ui,GV=$,WV=Object,Bd=gy?function(e){return typeof e=="symbol"}:function(e){var t=jV("Symbol");return BV(t)&&GV(t.prototype,WV(e))},HV=String,Zc=function(e){try{return HV(e)}catch{return"Object"}},KV=ui,zV=Zc,YV=TypeError,Nn=function(e){if(KV(e))return e;throw YV(zV(e)+" is not a function")},qV=Nn,JV=Jc,ip=function(e,t){var i=e[t];return JV(i)?void 0:qV(i)},Sy=Le,Ty=ui,vy=zr,XV=TypeError,Ry={exports:{}},Cy=le,QV=Object.defineProperty,ZV=function(e,t){try{QV(Cy,e,{value:t,configurable:!0,writable:!0})}catch{Cy[e]=t}return t},yy="__core-js_shared__",rE=le[yy]||ZV(yy,{}),Iy=rE;(Ry.exports=function(e,t){return Iy[e]||(Iy[e]=t!==void 0?t:{})})("versions",[]).push({version:"3.31.1",mode:"pure",copyright:"© 2014-2023 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.31.1/LICENSE",source:"https://github.com/zloirock/core-js"});var $c=Ry.exports,$V=Xc,eF=Object,ko=function(e){return eF($V(e))},tF=ko,iF=K({}.hasOwnProperty),Fi=Object.hasOwn||function(e,t){return iF(tF(e),t)},rF=K,nF=0,oF=Math.random(),sF=rF(1 .toString),nE=function(e){return"Symbol("+(e===void 0?"":e)+")_"+sF(++nF+oF,36)},aF=$c,wy=Fi,cF=nE,lF=Qc,dF=gy,el=le.Symbol,oE=aF("wks"),uF=dF?el.for||el:el&&el.withoutSetter||cF,qt=function(e){return wy(oE,e)||(oE[e]=lF&&wy(el,e)?el[e]:uF("Symbol."+e)),oE[e]},hF=Le,Ay=zr,Oy=Bd,pF=ip,mF=function(e,t){var i,r;if(Ty(i=e.toString)&&!vy(r=Sy(i,e))||Ty(i=e.valueOf)&&!vy(r=Sy(i,e))||t!=="string")return r;throw XV("Can't convert object to primitive value")},_F=TypeError,fF=qt("toPrimitive"),EF=function(e,t){if(!Ay(e)||Oy(e))return e;var i,r=pF(e,fF);if(r){if(i=hF(r,e,t),!Ay(i)||Oy(i))return i;throw _F("Can't convert object to primitive value")}return mF(e,t)},gF=Bd,rp=function(e){var t=EF(e,"string");return gF(t)?t:t+""},by=zr,sE=le.document,SF=by(sE)&&by(sE.createElement),aE=function(e){return SF?sE.createElement(e):{}},TF=aE,Ny=!dr&&!v(function(){return Object.defineProperty(TF("div"),"a",{get:function(){return 7}}).a!=7}),vF=dr,RF=Le,CF=lt,yF=Sr,IF=xs,wF=rp,AF=Fi,OF=Ny,Dy=Object.getOwnPropertyDescriptor;Wa.f=vF?Dy:function(e,t){if(e=IF(e),t=wF(t),OF)try{return Dy(e,t)}catch{}if(AF(e,t))return yF(!RF(CF.f,e,t),e[t])};var bF=v,NF=ui,DF=/#|\.prototype\./,Gd=function(e,t){var i=kF[PF(e)];return i==MF||i!=LF&&(NF(t)?bF(t):!!t)},PF=Gd.normalize=function(e){return String(e).replace(DF,".").toLowerCase()},kF=Gd.data={},LF=Gd.NATIVE="N",MF=Gd.POLYFILL="P",Py=Gd,UF=Nn,xF=b,VF=pt(pt.bind),Vs=function(e,t){return UF(e),t===void 0?e:xF?VF(e,t):function(){return e.apply(t,arguments)}},Dn={},ky=dr&&v(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!=42}),FF=zr,jF=String,BF=TypeError,Tr=function(e){if(FF(e))return e;throw BF(jF(e)+" is not an object")},GF=dr,WF=Ny,HF=ky,np=Tr,Ly=rp,KF=TypeError,cE=Object.defineProperty,zF=Object.getOwnPropertyDescriptor,lE="enumerable",dE="configurable",uE="writable";Dn.f=GF?HF?function(e,t,i){if(np(e),t=Ly(t),np(i),typeof e=="function"&&t==="prototype"&&"value"in i&&uE in i&&!i[uE]){var r=zF(e,t);r&&r[uE]&&(e[t]=i.value,i={configurable:dE in i?i[dE]:r[dE],enumerable:lE in i?i[lE]:r[lE],writable:!1})}return cE(e,t,i)}:cE:function(e,t,i){if(np(e),t=Ly(t),np(i),WF)try{return cE(e,t,i)}catch{}if("get"in i||"set"in i)throw KF("Accessors not supported");return"value"in i&&(e[t]=i.value),e};var YF=Dn,qF=Sr,Fs=dr?function(e,t,i){return YF.f(e,t,qF(1,i))}:function(e,t,i){return e[t]=i,e},op=le,JF=q,XF=pt,QF=ui,ZF=Wa.f,$F=Py,tl=so,ej=Vs,il=Fs,My=Fi,tj=function(e){var t=function(i,r,n){if(this instanceof t){switch(arguments.length){case 0:return new e;case 1:return new e(i);case 2:return new e(i,r)}return new e(i,r,n)}return JF(e,this,arguments)};return t.prototype=e.prototype,t},Tt=function(e,t){var i,r,n,o,a,l,d,u,p,m=e.target,f=e.global,E=e.stat,I=e.proto,T=f?op:E?op[m]:(op[m]||{}).prototype,R=f?tl:tl[m]||il(tl,m,{})[m],w=R.prototype;for(o in t)r=!(i=$F(f?o:m+(E?".":"#")+o,e.forced))&&T&&My(T,o),l=R[o],r&&(d=e.dontCallGetSet?(p=ZF(T,o))&&p.value:T[o]),a=r&&d?d:t[o],r&&typeof l==typeof a||(u=e.bind&&r?ej(a,op):e.wrap&&r?tj(a):I&&QF(a)?XF(a):a,(e.sham||a&&a.sham||l&&l.sham)&&il(u,"sham",!0),il(R,o,u),I&&(My(tl,n=m+"Prototype")||il(tl,n,{}),il(tl[n],o,a),e.real&&w&&(i||!w[o])&&il(w,o,a)))},ij=Math.ceil,rj=Math.floor,nj=Math.trunc||function(e){var t=+e;return(t>0?rj:ij)(t)},oj=nj,hE=function(e){var t=+e;return t!=t||t===0?0:oj(t)},sj=hE,aj=Math.max,cj=Math.min,pE=function(e,t){var i=sj(e);return i<0?aj(i+t,0):cj(i,t)},lj=hE,dj=Math.min,Uy=function(e){return e>0?dj(lj(e),9007199254740991):0},uj=Uy,cs=function(e){return uj(e.length)},hj=xs,pj=pE,mj=cs,xy=function(e){return function(t,i,r){var n,o=hj(t),a=mj(o),l=pj(r,a);if(e&&i!=i){for(;a>l;)if((n=o[l++])!=n)return!0}else for(;a>l;l++)if((e||l in o)&&o[l]===i)return e||l||0;return!e&&-1}},mE={includes:xy(!0),indexOf:xy(!1)},_j=mE.includes;Tt({target:"Array",proto:!0,forced:v(function(){return!Array(1).includes()})},{includes:function(e){return _j(this,e,arguments.length>1?arguments[1]:void 0)}});var fj=so,Pn=function(e){return fj[e+"Prototype"]},Ej=Pn("Array").includes,gj=zr,Sj=De,Tj=qt("match"),Vy=function(e){var t;return gj(e)&&((t=e[Tj])!==void 0?!!t:Sj(e)=="RegExp")},vj=Vy,Rj=TypeError,Fy={};Fy[qt("toStringTag")]="z";var _E=String(Fy)==="[object z]",Cj=_E,yj=ui,sp=De,Ij=qt("toStringTag"),wj=Object,Aj=sp(function(){return arguments}())=="Arguments",Lo=Cj?sp:function(e){var t,i,r;return e===void 0?"Undefined":e===null?"Null":typeof(i=function(n,o){try{return n[o]}catch{}}(t=wj(e),Ij))=="string"?i:Aj?sp(t):(r=sp(t))=="Object"&&yj(t.callee)?"Arguments":r},Oj=Lo,bj=String,hn=function(e){if(Oj(e)==="Symbol")throw TypeError("Cannot convert a Symbol value to a string");return bj(e)},Nj=qt("match"),Dj=Tt,Pj=function(e){if(vj(e))throw Rj("The method doesn't accept regular expressions");return e},kj=Xc,jy=hn,Lj=function(e){var t=/./;try{"/./"[e](t)}catch{try{return t[Nj]=!1,"/./"[e](t)}catch{}}return!1},Mj=K("".indexOf);Dj({target:"String",proto:!0,forced:!Lj("includes")},{includes:function(e){return!!~Mj(jy(kj(this)),jy(Pj(e)),arguments.length>1?arguments[1]:void 0)}});var Uj=Pn("String").includes,By=$,xj=Ej,Vj=Uj,fE=Array.prototype,EE=String.prototype,Fj=function(e){var t=e.includes;return e===fE||By(fE,e)&&t===fE.includes?xj:typeof e=="string"||e===EE||By(EE,e)&&t===EE.includes?Vj:t},se=g(Fj),jj=Nn,Bj=ko,Gj=tp,Wj=cs,Hj=TypeError,Gy=function(e){return function(t,i,r,n){jj(i);var o=Bj(t),a=Gj(o),l=Wj(o),d=e?l-1:0,u=e?-1:1;if(r<2)for(;;){if(d in a){n=a[d],d+=u;break}if(d+=u,e?d<0:l<=d)throw Hj("Reduce of empty array with no initial value")}for(;e?d>=0:l>d;d+=u)d in a&&(n=i(n,a[d],d,o));return n}},Kj={left:Gy(!1),right:Gy(!0)},zj=v,ap=function(e,t){var i=[][e];return!!i&&zj(function(){i.call(null,t||function(){return 1},1)})},Wd=typeof process<"u"&&De(process)=="process",Yj=Kj.left;Tt({target:"Array",proto:!0,forced:!Wd&&Ka>79&&Ka<83||!ap("reduce")},{reduce:function(e){var t=arguments.length;return Yj(this,e,t,t>1?arguments[1]:void 0)}});var qj=Pn("Array").reduce,Jj=$,Xj=qj,gE=Array.prototype,Qj=function(e){var t=e.reduce;return e===gE||Jj(gE,e)&&t===gE.reduce?Xj:t},Wy=Qj,ao=g(Wy);let Hy=!0,Ky=!0;function cp(e,t,i){let r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)}function za(e,t,i){if(!e.RTCPeerConnection)return;let r=e.RTCPeerConnection.prototype,n=r.addEventListener;r.addEventListener=function(a,l){if(a!==t)return n.apply(this,arguments);let d=u=>{let p=i(u);p&&(l.handleEvent?l.handleEvent(p):l(p))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(l,d),n.apply(this,[a,d])};let o=r.removeEventListener;r.removeEventListener=function(a,l){if(a!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(l))return o.apply(this,arguments);let d=this._eventMap[t].get(l);return this._eventMap[t].delete(l),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[a,d])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(a){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),a&&this.addEventListener(t,this["_on"+t]=a)},enumerable:!0,configurable:!0})}function Zj(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Hy=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function $j(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Ky=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function zy(){if(typeof window=="object"){if(Hy)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function SE(e,t){Ky&&console.warn(e+" is deprecated, please use "+t+" instead.")}function Yy(e){return Object.prototype.toString.call(e)==="[object Object]"}function qy(e){var t;return Yy(e)?ao(t=Object.keys(e)).call(t,function(i,r){let n=Yy(e[r]),o=n?qy(e[r]):e[r],a=n&&!Object.keys(o).length;return o===void 0||a?i:Object.assign(i,{[r]:o})},{}):e}function TE(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach(r=>{r.endsWith("Id")?TE(e,e.get(t[r]),i):r.endsWith("Ids")&&t[r].forEach(n=>{TE(e,e.get(n),i)})}))}function Jy(e,t,i){let r=i?"outbound-rtp":"inbound-rtp",n=new Map;if(t===null)return n;let o=[];return e.forEach(a=>{a.type==="track"&&a.trackIdentifier===t.id&&o.push(a)}),o.forEach(a=>{e.forEach(l=>{l.type===r&&l.trackId===a.id&&TE(e,l,n)})}),n}var eB=nE,Xy=$c("keys"),lp=function(e){return Xy[e]||(Xy[e]=eB(e))},tB=!v(function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}),iB=Fi,rB=ui,nB=ko,oB=tB,Qy=lp("IE_PROTO"),vE=Object,sB=vE.prototype,RE=oB?vE.getPrototypeOf:function(e){var t=nB(e);if(iB(t,Qy))return t[Qy];var i=t.constructor;return rB(i)&&t instanceof i?i.prototype:t instanceof vE?sB:null},aB=K,cB=Nn,lB=ui,dB=String,uB=TypeError,hB=function(e,t,i){try{return aB(cB(Object.getOwnPropertyDescriptor(e,t)[i]))}catch{}},pB=Tr,mB=function(e){if(typeof e=="object"||lB(e))return e;throw uB("Can't set "+dB(e)+" as a prototype")},_B=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,i={};try{(e=hB(Object.prototype,"__proto__","set"))(i,[]),t=i instanceof Array}catch{}return function(r,n){return pB(r),mB(n),t?e(r,n):r.__proto__=n,r}}():void 0),dp={},up={},CE=Fi,fB=xs,EB=mE.indexOf,gB=up,Zy=K([].push),$y=function(e,t){var i,r=fB(e),n=0,o=[];for(i in r)!CE(gB,i)&&CE(r,i)&&Zy(o,i);for(;t.length>n;)CE(r,i=t[n++])&&(~EB(o,i)||Zy(o,i));return o},yE=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],SB=$y,TB=yE.concat("length","prototype");dp.f=Object.getOwnPropertyNames||function(e){return SB(e,TB)};var Hd={};Hd.f=Object.getOwnPropertySymbols;var vB=Lr,RB=dp,CB=Hd,yB=Tr,IB=K([].concat),wB=vB("Reflect","ownKeys")||function(e){var t=RB.f(yB(e)),i=CB.f;return i?IB(t,i(e)):t},eI=Fi,AB=wB,OB=Wa,bB=Dn,IE={},NB=$y,DB=yE,hp=Object.keys||function(e){return NB(e,DB)},PB=dr,kB=ky,LB=Dn,MB=Tr,UB=xs,xB=hp;IE.f=PB&&!kB?Object.defineProperties:function(e,t){MB(e);for(var i,r=UB(t),n=xB(t),o=n.length,a=0;o>a;)LB.f(e,i=n[a++],r[i]);return e};var pp,tI=Lr("document","documentElement"),VB=Tr,FB=IE,iI=yE,jB=up,BB=tI,GB=aE,wE="prototype",AE="script",rI=lp("IE_PROTO"),OE=function(){},nI=function(e){return"<"+AE+">"+e+"</"+AE+">"},oI=function(e){e.write(nI("")),e.close();var t=e.parentWindow.Object;return e=null,t},mp=function(){try{pp=new ActiveXObject("htmlfile")}catch{}var e,t,i;mp=typeof document<"u"?document.domain&&pp?oI(pp):(t=GB("iframe"),i="java"+AE+":",t.style.display="none",BB.appendChild(t),t.src=String(i),(e=t.contentWindow.document).open(),e.write(nI("document.F=Object")),e.close(),e.F):oI(pp);for(var r=iI.length;r--;)delete mp[wE][iI[r]];return mp()};jB[rI]=!0;var Kd=Object.create||function(e,t){var i;return e!==null?(OE[wE]=VB(e),i=new OE,OE[wE]=null,i[rI]=e):i=mp(),t===void 0?i:FB.f(i,t)},WB=zr,HB=Fs,sI=Error,KB=K("".replace),zB=String(sI("zxcasd").stack),aI=/\n\s*at [^:]*:[^\n]*/,YB=aI.test(zB),qB=Sr,JB=!v(function(){var e=Error("a");return!("stack"in e)||(Object.defineProperty(e,"stack",qB(1,7)),e.stack!==7)}),XB=Fs,QB=function(e,t){if(YB&&typeof e=="string"&&!sI.prepareStackTrace)for(;t--;)e=KB(e,aI,"");return e},ZB=JB,cI=Error.captureStackTrace,Ya={},$B=Ya,e3=qt("iterator"),t3=Array.prototype,lI=function(e){return e!==void 0&&($B.Array===e||t3[e3]===e)},i3=Lo,dI=ip,r3=Jc,n3=Ya,o3=qt("iterator"),_p=function(e){if(!r3(e))return dI(e,o3)||dI(e,"@@iterator")||n3[i3(e)]},s3=Le,a3=Nn,c3=Tr,l3=Zc,d3=_p,u3=TypeError,bE=function(e,t){var i=arguments.length<2?d3(e):t;if(a3(i))return c3(s3(i,e));throw u3(l3(e)+" is not iterable")},h3=Le,uI=Tr,p3=ip,hI=function(e,t,i){var r,n;uI(e);try{if(!(r=p3(e,"return"))){if(t==="throw")throw i;return i}r=h3(r,e)}catch(o){n=!0,r=o}if(t==="throw")throw i;if(n)throw r;return uI(r),i},m3=Vs,_3=Le,f3=Tr,E3=Zc,g3=lI,S3=cs,pI=$,T3=bE,v3=_p,mI=hI,R3=TypeError,fp=function(e,t){this.stopped=e,this.result=t},_I=fp.prototype,zd=function(e,t,i){var r,n,o,a,l,d,u,p=i&&i.that,m=!(!i||!i.AS_ENTRIES),f=!(!i||!i.IS_RECORD),E=!(!i||!i.IS_ITERATOR),I=!(!i||!i.INTERRUPTED),T=m3(t,p),R=function(O){return r&&mI(r,"normal",O),new fp(!0,O)},w=function(O){return m?(f3(O),I?T(O[0],O[1],R):T(O[0],O[1])):I?T(O,R):T(O)};if(f)r=e.iterator;else if(E)r=e;else{if(!(n=v3(e)))throw R3(E3(e)+" is not iterable");if(g3(n)){for(o=0,a=S3(e);a>o;o++)if((l=w(e[o]))&&pI(_I,l))return l;return new fp(!1)}r=T3(e,n)}for(d=f?e.next:r.next;!(u=_3(d,r)).done;){try{l=w(u.value)}catch(O){mI(r,"throw",O)}if(typeof l=="object"&&l&&pI(_I,l))return l}return new fp(!1)},C3=hn,y3=Tt,I3=$,w3=RE,Ep=_B,A3=function(e,t,i){for(var r=AB(t),n=bB.f,o=OB.f,a=0;a<r.length;a++){var l=r[a];eI(e,l)||i&&eI(i,l)||n(e,l,o(t,l))}},fI=Kd,NE=Fs,DE=Sr,O3=function(e,t){WB(t)&&"cause"in t&&HB(e,"cause",t.cause)},b3=function(e,t,i,r){ZB&&(cI?cI(e,t):XB(e,"stack",QB(i,r)))},N3=zd,D3=function(e,t){return e===void 0?arguments.length<2?"":t:C3(e)},P3=qt("toStringTag"),gp=Error,k3=[].push,rl=function(e,t){var i,r=I3(PE,this);Ep?i=Ep(gp(),r?w3(this):PE):(i=r?this:fI(PE),NE(i,P3,"Error")),t!==void 0&&NE(i,"message",D3(t)),b3(i,rl,i.stack,1),arguments.length>2&&O3(i,arguments[2]);var n=[];return N3(e,k3,{that:n}),NE(i,"errors",n),i};Ep?Ep(rl,gp):A3(rl,gp,{name:!0});var PE=rl.prototype=fI(gp.prototype,{constructor:DE(1,rl),message:DE(1,""),name:DE(1,"AggregateError")});y3({global:!0,constructor:!0,arity:2},{AggregateError:rl});var Sp,Yd,Tp,L3=ui,EI=le.WeakMap,M3=L3(EI)&&/native code/.test(String(EI)),gI=le,U3=zr,x3=Fs,kE=Fi,LE=rE,V3=lp,F3=up,SI="Object already initialized",ME=gI.TypeError,j3=gI.WeakMap;if(M3||LE.state){var Mo=LE.state||(LE.state=new j3);Mo.get=Mo.get,Mo.has=Mo.has,Mo.set=Mo.set,Sp=function(e,t){if(Mo.has(e))throw ME(SI);return t.facade=e,Mo.set(e,t),t},Yd=function(e){return Mo.get(e)||{}},Tp=function(e){return Mo.has(e)}}else{var nl=V3("state");F3[nl]=!0,Sp=function(e,t){if(kE(e,nl))throw ME(SI);return t.facade=e,x3(e,nl,t),t},Yd=function(e){return kE(e,nl)?e[nl]:{}},Tp=function(e){return kE(e,nl)}}var qa,TI,vI,Ja={set:Sp,get:Yd,has:Tp,enforce:function(e){return Tp(e)?Yd(e):Sp(e,{})},getterFor:function(e){return function(t){var i;if(!U3(t)||(i=Yd(t)).type!==e)throw ME("Incompatible receiver, "+e+" required");return i}}},UE=dr,B3=Fi,RI=Function.prototype,G3=UE&&Object.getOwnPropertyDescriptor,xE=B3(RI,"name"),CI={EXISTS:xE,PROPER:xE&&(function(){}).name==="something",CONFIGURABLE:xE&&(!UE||UE&&G3(RI,"name").configurable)},W3=Fs,js=function(e,t,i,r){return r&&r.enumerable?e[t]=i:W3(e,t,i),e},H3=v,K3=ui,z3=zr,Y3=Kd,yI=RE,q3=js,VE=qt("iterator"),II=!1;[].keys&&("next"in(vI=[].keys())?(TI=yI(yI(vI)))!==Object.prototype&&(qa=TI):II=!0);var J3=!z3(qa)||H3(function(){var e={};return qa[VE].call(e)!==e});K3((qa=J3?{}:Y3(qa))[VE])||q3(qa,VE,function(){return this});var wI={IteratorPrototype:qa,BUGGY_SAFARI_ITERATORS:II},X3=Lo,Q3=_E?{}.toString:function(){return"[object "+X3(this)+"]"},Z3=_E,$3=Dn.f,eG=Fs,tG=Fi,iG=Q3,AI=qt("toStringTag"),Bs=function(e,t,i,r){if(e){var n=i?e:e.prototype;tG(n,AI)||$3(n,AI,{configurable:!0,value:t}),r&&!Z3&&eG(n,"toString",iG)}},rG=wI.IteratorPrototype,nG=Kd,oG=Sr,sG=Bs,aG=Ya,cG=function(){return this},FE=function(e,t,i,r){var n=t+" Iterator";return e.prototype=nG(rG,{next:oG(+!r,i)}),sG(e,n,!1,!0),aG[n]=cG,e},lG=Tt,dG=Le,uG=CI,hG=FE,pG=RE,mG=Bs,OI=js,bI=Ya,_G=wI,fG=uG.PROPER,vp=_G.BUGGY_SAFARI_ITERATORS,jE=qt("iterator"),NI="keys",Rp="values",DI="entries",EG=function(){return this},PI=function(e,t,i,r,n,o,a){hG(i,t,r);var l,d,u,p=function(w){if(w===n&&T)return T;if(!vp&&w in E)return E[w];switch(w){case NI:case Rp:case DI:return function(){return new i(this,w)}}return function(){return new i(this)}},m=t+" Iterator",f=!1,E=e.prototype,I=E[jE]||E["@@iterator"]||n&&E[n],T=!vp&&I||p(n),R=t=="Array"&&E.entries||I;if(R&&(l=pG(R.call(new e)))!==Object.prototype&&l.next&&(mG(l,m,!0,!0),bI[m]=EG),fG&&n==Rp&&I&&I.name!==Rp&&(f=!0,T=function(){return dG(I,this)}),n)if(d={values:p(Rp),keys:o?T:p(NI),entries:p(DI)},a)for(u in d)(vp||f||!(u in E))&&OI(E,u,d[u]);else lG({target:t,proto:!0,forced:vp||f},d);return a&&E[jE]!==T&&OI(E,jE,T,{name:n}),bI[t]=T,d},BE=function(e,t){return{value:e,done:t}},gG=xs,kI=Ya,LI=Ja;Dn.f;var SG=PI,MI=BE,UI="Array Iterator",TG=LI.set,vG=LI.getterFor(UI);SG(Array,"Array",function(e,t){TG(this,{type:UI,target:gG(e),index:0,kind:t})},function(){var e=vG(this),t=e.target,i=e.kind,r=e.index++;return!t||r>=t.length?(e.target=void 0,MI(void 0,!0)):MI(i=="keys"?r:i=="values"?t[r]:[r,t[r]],!1)},"values"),kI.Arguments=kI.Array;var RG=Dn,Cp=function(e,t,i){return RG.f(e,t,i)},CG=Lr,yG=Cp,IG=dr,xI=qt("species"),wG=$,AG=TypeError,GE=function(e,t){if(wG(t,e))return e;throw AG("Incorrect invocation")},OG=ui,WE=rE,bG=K(Function.toString);OG(WE.inspectSource)||(WE.inspectSource=function(e){return bG(e)});var VI=WE.inspectSource,NG=K,DG=v,FI=ui,PG=Lo,kG=VI,jI=function(){},LG=[],BI=Lr("Reflect","construct"),HE=/^\s*(?:class|function)\b/,MG=NG(HE.exec),UG=!HE.exec(jI),qd=function(e){if(!FI(e))return!1;try{return BI(jI,LG,e),!0}catch{return!1}},GI=function(e){if(!FI(e))return!1;switch(PG(e)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return UG||!!MG(HE,kG(e))}catch{return!0}};GI.sham=!0;var Jd,ol,WI,KE,yp=!BI||DG(function(){var e;return qd(qd.call)||!qd(Object)||!qd(function(){e=!0})||e})?GI:qd,xG=yp,VG=Zc,FG=TypeError,HI=Tr,jG=function(e){if(xG(e))return e;throw FG(VG(e)+" is not a constructor")},BG=Jc,GG=qt("species"),zE=function(e,t){var i,r=HI(e).constructor;return r===void 0||BG(i=HI(r)[GG])?t:jG(i)},YE=K([].slice),WG=TypeError,Ip=function(e,t){if(e<t)throw WG("Not enough arguments");return e},KI=/(?:ipad|iphone|ipod).*applewebkit/i.test(Ha),pn=le,HG=q,KG=Vs,zI=ui,zG=Fi,YI=v,qI=tI,YG=YE,JI=aE,qG=Ip,JG=KI,XG=Wd,qE=pn.setImmediate,JE=pn.clearImmediate,QG=pn.process,XE=pn.Dispatch,ZG=pn.Function,XI=pn.MessageChannel,$G=pn.String,QE=0,Xd={},QI="onreadystatechange";YI(function(){Jd=pn.location});var ZE=function(e){if(zG(Xd,e)){var t=Xd[e];delete Xd[e],t()}},$E=function(e){return function(){ZE(e)}},ZI=function(e){ZE(e.data)},$I=function(e){pn.postMessage($G(e),Jd.protocol+"//"+Jd.host)};qE&&JE||(qE=function(e){qG(arguments.length,1);var t=zI(e)?e:ZG(e),i=YG(arguments,1);return Xd[++QE]=function(){HG(t,void 0,i)},ol(QE),QE},JE=function(e){delete Xd[e]},XG?ol=function(e){QG.nextTick($E(e))}:XE&&XE.now?ol=function(e){XE.now($E(e))}:XI&&!JG?(KE=(WI=new XI).port2,WI.port1.onmessage=ZI,ol=KG(KE.postMessage,KE)):pn.addEventListener&&zI(pn.postMessage)&&!pn.importScripts&&Jd&&Jd.protocol!=="file:"&&!YI($I)?(ol=$I,pn.addEventListener("message",ZI,!1)):ol=QI in JI("script")?function(e){qI.appendChild(JI("script"))[QI]=function(){qI.removeChild(this),ZE(e)}}:function(e){setTimeout($E(e),0)});var e0={set:qE,clear:JE},t0=function(){this.head=null,this.tail=null};t0.prototype={add:function(e){var t={item:e,next:null},i=this.tail;i?i.next=t:this.head=t,this.tail=t},get:function(){var e=this.head;if(e)return(this.head=e.next)===null&&(this.tail=null),e.item}};var sl,eg,tg,ig,i0,r0=t0,e4=/ipad|iphone|ipod/i.test(Ha)&&typeof Pebble<"u",t4=/web0s(?!.*chrome)/i.test(Ha),Xa=le,n0=Vs,i4=Wa.f,rg=e0.set,r4=r0,n4=KI,o4=e4,s4=t4,ng=Wd,o0=Xa.MutationObserver||Xa.WebKitMutationObserver,s0=Xa.document,a0=Xa.process,wp=Xa.Promise,c0=i4(Xa,"queueMicrotask"),og=c0&&c0.value;if(!og){var Ap=new r4,Op=function(){var e,t;for(ng&&(e=a0.domain)&&e.exit();t=Ap.get();)try{t()}catch(i){throw Ap.head&&sl(),i}e&&e.enter()};n4||ng||s4||!o0||!s0?!o4&&wp&&wp.resolve?((ig=wp.resolve(void 0)).constructor=wp,i0=n0(ig.then,ig),sl=function(){i0(Op)}):ng?sl=function(){a0.nextTick(Op)}:(rg=n0(rg,Xa),sl=function(){rg(Op)}):(eg=!0,tg=s0.createTextNode(""),new o0(Op).observe(tg,{characterData:!0}),sl=function(){tg.data=eg=!eg}),og=function(e){Ap.head||sl(),Ap.add(e)}}var a4=og,al=function(e){try{return{error:!1,value:e()}}catch(t){return{error:!0,value:t}}},Qa=le.Promise,l0=typeof Deno=="object"&&Deno&&typeof Deno.version=="object",c4=!l0&&!Wd&&typeof window=="object"&&typeof document=="object",l4=le,Qd=Qa,d4=ui,u4=Py,h4=VI,p4=qt,m4=c4,_4=l0,sg=Ka,d0=Qd&&Qd.prototype,f4=p4("species"),u0=!1,h0=d4(l4.PromiseRejectionEvent),E4=u4("Promise",function(){var e=h4(Qd),t=e!==String(Qd);if(!t&&sg===66||!d0.catch||!d0.finally)return!0;if(!sg||sg<51||!/native code/.test(e)){var i=new Qd(function(n){n(1)}),r=function(n){n(function(){},function(){})};if((i.constructor={})[f4]=r,!(u0=i.then(function(){})instanceof r))return!0}return!t&&(m4||_4)&&!h0}),Zd={CONSTRUCTOR:E4,REJECTION_EVENT:h0,SUBCLASSING:u0},Uo={},p0=Nn,g4=TypeError,S4=function(e){var t,i;this.promise=new e(function(r,n){if(t!==void 0||i!==void 0)throw g4("Bad Promise constructor");t=r,i=n}),this.resolve=p0(t),this.reject=p0(i)};Uo.f=function(e){return new S4(e)};var ag,m0,T4=Tt,bp=Wd,Gs=le,$d=Le,v4=js,R4=Bs,C4=function(e){var t=CG(e);IG&&t&&!t[xI]&&yG(t,xI,{configurable:!0,get:function(){return this}})},y4=Nn,cg=ui,I4=zr,w4=GE,A4=zE,_0=e0.set,lg=a4,O4=function(e,t){try{arguments.length==1?console.error(e):console.error(e,t)}catch{}},b4=al,N4=r0,f0=Ja,dg=Qa,E0=Zd,g0=Uo,Np="Promise",S0=E0.CONSTRUCTOR,D4=E0.REJECTION_EVENT,ug=f0.getterFor(Np),P4=f0.set,k4=dg&&dg.prototype,eu=dg,hg=k4,T0=Gs.TypeError,pg=Gs.document,mg=Gs.process,_g=g0.f,L4=_g,M4=!!(pg&&pg.createEvent&&Gs.dispatchEvent),v0="unhandledrejection",R0=function(e){var t;return!(!I4(e)||!cg(t=e.then))&&t},C0=function(e,t){var i,r,n,o=t.value,a=t.state==1,l=a?e.ok:e.fail,d=e.resolve,u=e.reject,p=e.domain;try{l?(a||(t.rejection===2&&x4(t),t.rejection=1),l===!0?i=o:(p&&p.enter(),i=l(o),p&&(p.exit(),n=!0)),i===e.promise?u(T0("Promise-chain cycle")):(r=R0(i))?$d(r,i,d,u):d(i)):u(o)}catch(m){p&&!n&&p.exit(),u(m)}},y0=function(e,t){e.notified||(e.notified=!0,lg(function(){for(var i,r=e.reactions;i=r.get();)C0(i,e);e.notified=!1,t&&!e.rejection&&U4(e)}))},I0=function(e,t,i){var r,n;M4?((r=pg.createEvent("Event")).promise=t,r.reason=i,r.initEvent(e,!1,!0),Gs.dispatchEvent(r)):r={promise:t,reason:i},!D4&&(n=Gs["on"+e])?n(r):e===v0&&O4("Unhandled promise rejection",i)},U4=function(e){$d(_0,Gs,function(){var t,i=e.facade,r=e.value;if(w0(e)&&(t=b4(function(){bp?mg.emit("unhandledRejection",r,i):I0(v0,i,r)}),e.rejection=bp||w0(e)?2:1,t.error))throw t.value})},w0=function(e){return e.rejection!==1&&!e.parent},x4=function(e){$d(_0,Gs,function(){var t=e.facade;bp?mg.emit("rejectionHandled",t):I0("rejectionhandled",t,e.value)})},cl=function(e,t,i){return function(r){e(t,r,i)}},ll=function(e,t,i){e.done||(e.done=!0,i&&(e=i),e.value=t,e.state=2,y0(e,!0))},fg=function(e,t,i){if(!e.done){e.done=!0,i&&(e=i);try{if(e.facade===t)throw T0("Promise can't be resolved itself");var r=R0(t);r?lg(function(){var n={done:!1};try{$d(r,t,cl(fg,n,e),cl(ll,n,e))}catch(o){ll(n,o,e)}}):(e.value=t,e.state=1,y0(e,!1))}catch(n){ll({done:!1},n,e)}}};S0&&(hg=(eu=function(e){w4(this,hg),y4(e),$d(ag,this);var t=ug(this);try{e(cl(fg,t),cl(ll,t))}catch(i){ll(t,i)}}).prototype,(ag=function(e){P4(this,{type:Np,done:!1,notified:!1,parent:!1,reactions:new N4,rejection:!1,state:0,value:void 0})}).prototype=v4(hg,"then",function(e,t){var i=ug(this),r=_g(A4(this,eu));return i.parent=!0,r.ok=!cg(e)||e,r.fail=cg(t)&&t,r.domain=bp?mg.domain:void 0,i.state==0?i.reactions.add(r):lg(function(){C0(r,i)}),r.promise}),m0=function(){var e=new ag,t=ug(e);this.promise=e,this.resolve=cl(fg,t),this.reject=cl(ll,t)},g0.f=_g=function(e){return e===eu||e===void 0?new m0(e):L4(e)}),T4({global:!0,constructor:!0,wrap:!0,forced:S0},{Promise:eu}),R4(eu,Np,!1,!0),C4(Np);var A0=qt("iterator"),O0=!1;try{var V4=0,b0={next:function(){return{done:!!V4++}},return:function(){O0=!0}};b0[A0]=function(){return this},Array.from(b0,function(){throw 2})}catch{}var F4=Qa,j4=function(e,t){if(!O0)return!1;var i=!1;try{var r={};r[A0]=function(){return{next:function(){return{done:i=!0}}}},e(r)}catch{}return i},Dp=Zd.CONSTRUCTOR||!j4(function(e){F4.all(e).then(void 0,function(){})}),B4=Le,G4=Nn,W4=Uo,H4=al,K4=zd;Tt({target:"Promise",stat:!0,forced:Dp},{all:function(e){var t=this,i=W4.f(t),r=i.resolve,n=i.reject,o=H4(function(){var a=G4(t.resolve),l=[],d=0,u=1;K4(e,function(p){var m=d++,f=!1;u++,B4(a,t,p).then(function(E){f||(f=!0,l[m]=E,--u||r(l))},n)}),--u||r(l)});return o.error&&n(o.value),i.promise}});var z4=Tt,Y4=Zd.CONSTRUCTOR;Qa&&Qa.prototype,z4({target:"Promise",proto:!0,forced:Y4,real:!0},{catch:function(e){return this.then(void 0,e)}});var q4=Le,J4=Nn,X4=Uo,Q4=al,Z4=zd;Tt({target:"Promise",stat:!0,forced:Dp},{race:function(e){var t=this,i=X4.f(t),r=i.reject,n=Q4(function(){var o=J4(t.resolve);Z4(e,function(a){q4(o,t,a).then(i.resolve,r)})});return n.error&&r(n.value),i.promise}});var $4=Le,eW=Uo;Tt({target:"Promise",stat:!0,forced:Zd.CONSTRUCTOR},{reject:function(e){var t=eW.f(this);return $4(t.reject,void 0,e),t.promise}});var tW=Tr,iW=zr,rW=Uo,N0=function(e,t){if(tW(e),iW(t)&&t.constructor===e)return t;var i=rW.f(e);return(0,i.resolve)(t),i.promise},nW=Tt,oW=Qa,sW=Zd.CONSTRUCTOR,aW=N0,cW=Lr("Promise"),lW=!sW;nW({target:"Promise",stat:!0,forced:!0},{resolve:function(e){return aW(lW&&this===cW?oW:this,e)}});var dW=Le,uW=Nn,hW=Uo,pW=al,mW=zd;Tt({target:"Promise",stat:!0,forced:Dp},{allSettled:function(e){var t=this,i=hW.f(t),r=i.resolve,n=i.reject,o=pW(function(){var a=uW(t.resolve),l=[],d=0,u=1;mW(e,function(p){var m=d++,f=!1;u++,dW(a,t,p).then(function(E){f||(f=!0,l[m]={status:"fulfilled",value:E},--u||r(l))},function(E){f||(f=!0,l[m]={status:"rejected",reason:E},--u||r(l))})}),--u||r(l)});return o.error&&n(o.value),i.promise}});var _W=Le,fW=Nn,EW=Lr,gW=Uo,SW=al,TW=zd,D0="No one promise resolved";Tt({target:"Promise",stat:!0,forced:Dp},{any:function(e){var t=this,i=EW("AggregateError"),r=gW.f(t),n=r.resolve,o=r.reject,a=SW(function(){var l=fW(t.resolve),d=[],u=0,p=1,m=!1;TW(e,function(f){var E=u++,I=!1;p++,_W(l,t,f).then(function(T){I||m||(m=!0,n(T))},function(T){I||m||(I=!0,d[E]=T,--p||o(new i(d,D0)))})}),--p||o(new i(d,D0))});return a.error&&o(a.value),r.promise}});var vW=Tt,Eg=Qa,RW=v,CW=Lr,yW=ui,IW=zE,P0=N0,wW=Eg&&Eg.prototype;vW({target:"Promise",proto:!0,real:!0,forced:!!Eg&&RW(function(){wW.finally.call({then:function(){}},function(){})})},{finally:function(e){var t=IW(this,CW("Promise")),i=yW(e);return this.then(i?function(r){return P0(t,e()).then(function(){return r})}:e,i?function(r){return P0(t,e()).then(function(){throw r})}:e)}});var gg=K,AW=hE,OW=hn,bW=Xc,NW=gg("".charAt),k0=gg("".charCodeAt),DW=gg("".slice),L0=function(e){return function(t,i){var r,n,o=OW(bW(t)),a=AW(i),l=o.length;return a<0||a>=l?e?"":void 0:(r=k0(o,a))<55296||r>56319||a+1===l||(n=k0(o,a+1))<56320||n>57343?e?NW(o,a):r:e?DW(o,a,a+2):n-56320+(r-55296<<10)+65536}},Sg={codeAt:L0(!1),charAt:L0(!0)},PW=Sg.charAt,kW=hn,M0=Ja,LW=PI,U0=BE,x0="String Iterator",MW=M0.set,UW=M0.getterFor(x0);LW(String,"String",function(e){MW(this,{type:x0,string:kW(e),index:0})},function(){var e,t=UW(this),i=t.string,r=t.index;return r>=i.length?U0(void 0,!0):(e=PW(i,r),t.index+=e.length,U0(e,!1))});var xW=so.Promise,VW={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},FW=le,jW=Lo,BW=Fs,V0=Ya,F0=qt("toStringTag");for(var Tg in VW){var j0=FW[Tg],vg=j0&&j0.prototype;vg&&jW(vg)!==F0&&BW(vg,F0,Tg),V0[Tg]=V0.Array}var B0=xW,ne=g(B0);let G0=zy;function W0(e,t){let i=e&&e.navigator;if(!i.mediaDevices)return;let r=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;let l={};return Object.keys(a).forEach(d=>{if(d==="require"||d==="advanced"||d==="mediaSource")return;let u=typeof a[d]=="object"?a[d]:{ideal:a[d]};u.exact!==void 0&&typeof u.exact=="number"&&(u.min=u.max=u.exact);let p=function(m,f){return m?m+f.charAt(0).toUpperCase()+f.slice(1):f==="deviceId"?"sourceId":f};if(u.ideal!==void 0){l.optional=l.optional||[];let m={};typeof u.ideal=="number"?(m[p("min",d)]=u.ideal,l.optional.push(m),m={},m[p("max",d)]=u.ideal,l.optional.push(m)):(m[p("",d)]=u.ideal,l.optional.push(m))}u.exact!==void 0&&typeof u.exact!="number"?(l.mandatory=l.mandatory||{},l.mandatory[p("",d)]=u.exact):["min","max"].forEach(m=>{u[m]!==void 0&&(l.mandatory=l.mandatory||{},l.mandatory[p(m,d)]=u[m])})}),a.advanced&&(l.optional=(l.optional||[]).concat(a.advanced)),l},n=function(a,l){if(t.version>=61)return l(a);if((a=JSON.parse(JSON.stringify(a)))&&typeof a.audio=="object"){let d=function(u,p,m){p in u&&!(m in u)&&(u[m]=u[p],delete u[p])};d((a=JSON.parse(JSON.stringify(a))).audio,"autoGainControl","googAutoGainControl"),d(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=r(a.audio)}if(a&&typeof a.video=="object"){let d=a.video.facingMode;d=d&&(typeof d=="object"?d:{ideal:d});let u=t.version<66;if(d&&(d.exact==="user"||d.exact==="environment"||d.ideal==="user"||d.ideal==="environment")&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||u)){let p;if(delete a.video.facingMode,d.exact==="environment"||d.ideal==="environment"?p=["back","rear"]:d.exact!=="user"&&d.ideal!=="user"||(p=["front"]),p)return i.mediaDevices.enumerateDevices().then(m=>{let f=(m=m.filter(E=>E.kind==="videoinput")).find(E=>p.some(I=>{var T;return se(T=E.label.toLowerCase()).call(T,I)}));return!f&&m.length&&se(p).call(p,"back")&&(f=m[m.length-1]),f&&(a.video.deviceId=d.exact?{exact:f.deviceId}:{ideal:f.deviceId}),a.video=r(a.video),G0("chrome: "+JSON.stringify(a)),l(a)})}a.video=r(a.video)}return G0("chrome: "+JSON.stringify(a)),l(a)},o=function(a){return t.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=(function(a,l,d){n(a,u=>{i.webkitGetUserMedia(u,l,p=>{d&&d(o(p))})})}).bind(i),i.mediaDevices.getUserMedia){let a=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(l){return n(l,d=>a(d).then(u=>{if(d.audio&&!u.getAudioTracks().length||d.video&&!u.getVideoTracks().length)throw u.getTracks().forEach(p=>{p.stop()}),new DOMException("","NotFoundError");return u},u=>ne.reject(o(u))))}}}function H0(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function K0(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(i){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=i)},enumerable:!0,configurable:!0});let t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(a=>a.track&&a.track.id===r.track.id):{track:r.track};let o=new Event("track");o.track=r.track,o.receiver=n,o.transceiver={receiver:n},o.streams=[i.stream],this.dispatchEvent(o)}),i.stream.getTracks().forEach(r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(a=>a.track&&a.track.id===r.id):{track:r};let o=new Event("track");o.track=r,o.receiver=n,o.transceiver={receiver:n},o.streams=[i.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else za(e,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function z0(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){let t=function(n,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=n.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:n}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(a,l){let d=n.apply(this,arguments);return d||(d=t(this,a),this._senders.push(d)),d};let o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(a){o.apply(this,arguments);let l=this._senders.indexOf(a);l!==-1&&this._senders.splice(l,1)}}let i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(n){this._senders=this._senders||[],i.apply(this,[n]),n.getTracks().forEach(o=>{this._senders.push(t(this,o))})};let r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(n){this._senders=this._senders||[],r.apply(this,[n]),n.getTracks().forEach(o=>{let a=this._senders.find(l=>l.track===o);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof e=="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){let t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){let i=t.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Y0(e){if(!e.RTCPeerConnection)return;let t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){let[i,r,n]=arguments;if(arguments.length>0&&typeof i=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof i!="function"))return t.apply(this,[]);let o=function(l){let d={};return l.result().forEach(u=>{let p={id:u.id,timestamp:u.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[u.type]||u.type};u.names().forEach(m=>{p[m]=u.stat(m)}),d[p.id]=p}),d},a=function(l){return new Map(Object.keys(l).map(d=>[d,l[d]]))};if(arguments.length>=2){let l=function(d){r(a(o(d)))};return t.apply(this,[l,i])}return new ne((l,d)=>{t.apply(this,[function(u){l(a(o(u)))},d])}).then(r,n)}}function q0(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){let i=e.RTCPeerConnection.prototype.getSenders;i&&(e.RTCPeerConnection.prototype.getSenders=function(){let n=i.apply(this,[]);return n.forEach(o=>o._pc=this),n});let r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){let n=r.apply(this,arguments);return n._pc=this,n}),e.RTCRtpSender.prototype.getStats=function(){let n=this;return this._pc.getStats().then(o=>Jy(o,n.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){let i=e.RTCPeerConnection.prototype.getReceivers;i&&(e.RTCPeerConnection.prototype.getReceivers=function(){let r=i.apply(this,[]);return r.forEach(n=>n._pc=this),r}),za(e,"track",r=>(r.receiver._pc=r.srcElement,r)),e.RTCRtpReceiver.prototype.getStats=function(){let r=this;return this._pc.getStats().then(n=>Jy(n,r.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;let t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){let i=arguments[0],r,n,o;return this.getSenders().forEach(a=>{a.track===i&&(r?o=!0:r=a)}),this.getReceivers().forEach(a=>(a.track===i&&(n?o=!0:n=a),a.track===i)),o||r&&n?ne.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():n?n.getStats():ne.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function J0(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};let t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(o,a){if(!a)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let l=t.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(l)===-1&&this._shimmedLocalStreams[a.id].push(l):this._shimmedLocalStreams[a.id]=[a,l],l};let i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")});let a=this.getSenders();i.apply(this,arguments);let l=this.getSenders().filter(d=>a.indexOf(d)===-1);this._shimmedLocalStreams[o.id]=[o].concat(l)};let r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],r.apply(this,arguments)};let n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(a=>{let l=this._shimmedLocalStreams[a].indexOf(o);l!==-1&&this._shimmedLocalStreams[a].splice(l,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),n.apply(this,arguments)}}function X0(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return J0(e);let i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){let d=i.apply(this);return this._reverseStreams=this._reverseStreams||{},d.map(u=>this._reverseStreams[u.id])};let r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(d){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},d.getTracks().forEach(u=>{if(this.getSenders().find(p=>p.track===u))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[d.id]){let u=new e.MediaStream(d.getTracks());this._streams[d.id]=u,this._reverseStreams[u.id]=d,d=u}r.apply(this,[d])};let n=e.RTCPeerConnection.prototype.removeStream;function o(d,u){let p=u.sdp;return Object.keys(d._reverseStreams||[]).forEach(m=>{let f=d._reverseStreams[m],E=d._streams[f.id];p=p.replace(new RegExp(E.id,"g"),f.id)}),new RTCSessionDescription({type:u.type,sdp:p})}e.RTCPeerConnection.prototype.removeStream=function(d){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[d.id]||d]),delete this._reverseStreams[this._streams[d.id]?this._streams[d.id].id:d.id],delete this._streams[d.id]},e.RTCPeerConnection.prototype.addTrack=function(d,u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let p=[].slice.call(arguments,1);if(p.length!==1||!p[0].getTracks().find(f=>f===d))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(f=>f.track===d))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let m=this._streams[u.id];if(m)m.addTrack(d),ne.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let f=new e.MediaStream([d]);this._streams[u.id]=f,this._reverseStreams[f.id]=u,this.addStream(f)}return this.getSenders().find(f=>f.track===d)},["createOffer","createAnswer"].forEach(function(d){let u=e.RTCPeerConnection.prototype[d],p={[d](){let m=arguments;return arguments.length&&typeof arguments[0]=="function"?u.apply(this,[f=>{let E=o(this,f);m[0].apply(null,[E])},f=>{m[1]&&m[1].apply(null,f)},arguments[2]]):u.apply(this,arguments).then(f=>o(this,f))}};e.RTCPeerConnection.prototype[d]=p[d]});let a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(d,u){let p=u.sdp;return Object.keys(d._reverseStreams||[]).forEach(m=>{let f=d._reverseStreams[m],E=d._streams[f.id];p=p.replace(new RegExp(f.id,"g"),E.id)}),new RTCSessionDescription({type:u.type,sdp:p})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};let l=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){let d=l.get.apply(this);return d.type===""?d:o(this,d)}}),e.RTCPeerConnection.prototype.removeTrack=function(d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!d._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(d._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let u;this._streams=this._streams||{},Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(m=>d.track===m)&&(u=this._streams[p])}),u&&(u.getTracks().length===1?this.removeStream(this._reverseStreams[u.id]):u.removeTrack(d.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Rg(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){let r=e.RTCPeerConnection.prototype[i],n={[i](){return arguments[0]=new(i==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[i]=n[i]})}function Q0(e,t){za(e,"negotiationneeded",i=>{let r=i.target;if(!(t.version<72||r.getConfiguration&&r.getConfiguration().sdpSemantics==="plan-b")||r.signalingState==="stable")return i})}var Z0=Object.freeze({__proto__:null,fixNegotiationNeeded:Q0,shimAddTrackRemoveTrack:X0,shimAddTrackRemoveTrackWithNative:J0,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(typeof t=="function"?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(r=>{let n=i.video&&i.video.width,o=i.video&&i.video.height,a=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:a||3}},n&&(i.video.mandatory.maxWidth=n),o&&(i.video.mandatory.maxHeight=o),e.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:z0,shimGetStats:Y0,shimGetUserMedia:W0,shimMediaStream:H0,shimOnTrack:K0,shimPeerConnection:Rg,shimSenderReceiverGetStats:q0});function $0(e,t){let i=e&&e.navigator,r=e&&e.MediaStreamTrack;if(i.getUserMedia=function(n,o,a){SE("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(n).then(o,a)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){let n=function(a,l,d){l in a&&!(d in a)&&(a[d]=a[l],delete a[l])},o=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(a){return typeof a=="object"&&typeof a.audio=="object"&&(a=JSON.parse(JSON.stringify(a)),n(a.audio,"autoGainControl","mozAutoGainControl"),n(a.audio,"noiseSuppression","mozNoiseSuppression")),o(a)},r&&r.prototype.getSettings){let a=r.prototype.getSettings;r.prototype.getSettings=function(){let l=a.apply(this,arguments);return n(l,"mozAutoGainControl","autoGainControl"),n(l,"mozNoiseSuppression","noiseSuppression"),l}}if(r&&r.prototype.applyConstraints){let a=r.prototype.applyConstraints;r.prototype.applyConstraints=function(l){return this.kind==="audio"&&typeof l=="object"&&(l=JSON.parse(JSON.stringify(l)),n(l,"autoGainControl","mozAutoGainControl"),n(l,"noiseSuppression","mozNoiseSuppression")),a.apply(this,[l])}}}}function ew(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Cg(e,t){if(typeof e!="object"||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){let o=e.RTCPeerConnection.prototype[n],a={[n](){return arguments[0]=new(n==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};e.RTCPeerConnection.prototype[n]=a[n]});let i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){let[n,o,a]=arguments;return r.apply(this,[n||null]).then(l=>{if(t.version<53&&!o)try{l.forEach(d=>{d.type=i[d.type]||d.type})}catch(d){if(d.name!=="TypeError")throw d;l.forEach((u,p)=>{l.set(p,Object.assign({},u,{type:i[u.type]||u.type}))})}return l}).then(o,a)}}function tw(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;let t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){let r=t.apply(this,[]);return r.forEach(n=>n._pc=this),r});let i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){let r=i.apply(this,arguments);return r._pc=this,r}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):ne.resolve(new Map)}}function iw(e){if(typeof e!="object"||!e.RTCPeerConnection||!e.RTCRtpSender||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;let t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){let i=t.apply(this,[]);return i.forEach(r=>r._pc=this),i}),za(e,"track",i=>(i.receiver._pc=i.srcElement,i)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function rw(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(t){SE("removeStream","removeTrack"),this.getSenders().forEach(i=>{var r;i.track&&se(r=t.getTracks()).call(r,i.track)&&this.removeTrack(i)})})}function nw(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function ow(e){if(typeof e!="object"||!e.RTCPeerConnection)return;let t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];let r=i.length>0;r&&i.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let n=t.apply(this,arguments);if(r){let{sender:o}=n,a=o.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=i,o.sendEncodings=i,this.setParametersPromises.push(o.setParameters(a).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return n})}function sw(e){if(typeof e!="object"||!e.RTCRtpSender)return;let t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){let i=t.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function aw(e){if(typeof e!="object"||!e.RTCPeerConnection)return;let t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?ne.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function cw(e){if(typeof e!="object"||!e.RTCPeerConnection)return;let t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?ne.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}var lw=Object.freeze({__proto__:null,shimAddTransceiver:ow,shimCreateAnswer:cw,shimCreateOffer:aw,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){let r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,ne.reject(r)}return i.video===!0?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:sw,shimGetUserMedia:$0,shimOnTrack:ew,shimPeerConnection:Cg,shimRTCDataChannel:nw,shimReceiverGetStats:iw,shimRemoveStream:rw,shimSenderGetStats:tw});function dw(e){if(typeof e=="object"&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){let t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(i){var r;this._localStreams||(this._localStreams=[]),se(r=this._localStreams).call(r,i)||this._localStreams.push(i),i.getAudioTracks().forEach(n=>t.call(this,n,i)),i.getVideoTracks().forEach(n=>t.call(this,n,i))},e.RTCPeerConnection.prototype.addTrack=function(i){for(var r=arguments.length,n=new Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return n&&n.forEach(a=>{var l;this._localStreams?se(l=this._localStreams).call(l,a)||this._localStreams.push(a):this._localStreams=[a]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);let i=this._localStreams.indexOf(t);if(i===-1)return;this._localStreams.splice(i,1);let r=t.getTracks();this.getSenders().forEach(n=>{se(r).call(r,n.track)&&this.removeTrack(n)})})}}function uw(e){if(typeof e=="object"&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(i){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=i),this.addEventListener("track",this._onaddstreampoly=r=>{r.streams.forEach(n=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),se(o=this._remoteStreams).call(o,n))return;this._remoteStreams.push(n);let a=new Event("addstream");a.stream=n,this.dispatchEvent(a)})})}});let t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){let i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(n=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(n)>=0)return;i._remoteStreams.push(n);let o=new Event("addstream");o.stream=n,i.dispatchEvent(o)})}),t.apply(i,arguments)}}}function hw(e){if(typeof e!="object"||!e.RTCPeerConnection)return;let t=e.RTCPeerConnection.prototype,i=t.createOffer,r=t.createAnswer,n=t.setLocalDescription,o=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(d,u){let p=arguments.length>=2?arguments[2]:arguments[0],m=i.apply(this,[p]);return u?(m.then(d,u),ne.resolve()):m},t.createAnswer=function(d,u){let p=arguments.length>=2?arguments[2]:arguments[0],m=r.apply(this,[p]);return u?(m.then(d,u),ne.resolve()):m};let l=function(d,u,p){let m=n.apply(this,[d]);return p?(m.then(u,p),ne.resolve()):m};t.setLocalDescription=l,l=function(d,u,p){let m=o.apply(this,[d]);return p?(m.then(u,p),ne.resolve()):m},t.setRemoteDescription=l,l=function(d,u,p){let m=a.apply(this,[d]);return p?(m.then(u,p),ne.resolve()):m},t.addIceCandidate=l}function pw(e){let t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){let i=t.mediaDevices,r=i.getUserMedia.bind(i);t.mediaDevices.getUserMedia=n=>r(mw(n))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(i,r,n){t.mediaDevices.getUserMedia(i).then(r,n)}).bind(t))}function mw(e){return e&&e.video!==void 0?Object.assign({},e,{video:qy(e.video)}):e}function _w(e){if(!e.RTCPeerConnection)return;let t=e.RTCPeerConnection;e.RTCPeerConnection=function(i,r){if(i&&i.iceServers){let n=[];for(let o=0;o<i.iceServers.length;o++){let a=i.iceServers[o];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(SE("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,n.push(a)):n.push(i.iceServers[o])}i.iceServers=n}return new t(i,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function fw(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Ew(e){let t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(i){if(i){i.offerToReceiveAudio!==void 0&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);let r=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio!==!0||r||this.addTransceiver("audio",{direction:"recvonly"}),i.offerToReceiveVideo!==void 0&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);let n=this.getTransceivers().find(o=>o.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):i.offerToReceiveVideo!==!0||n||this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function gw(e){typeof e!="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var Sw=Object.freeze({__proto__:null,shimAudioContext:gw,shimCallbacksAPI:hw,shimConstraints:mw,shimCreateOfferLegacy:Ew,shimGetUserMedia:pw,shimLocalStreamsAPI:dw,shimRTCIceServerUrls:_w,shimRemoteStreamsAPI:uw,shimTrackEventTransceiver:fw}),Tw=`	
\v\f\r                　\u2028\u2029\uFEFF`,GW=Xc,WW=hn,yg=Tw,vw=K("".replace),HW=RegExp("^["+yg+"]+"),KW=RegExp("(^|[^"+yg+"])["+yg+"]+$"),Ig=function(e){return function(t){var i=WW(GW(t));return 1&e&&(i=vw(i,HW,"")),2&e&&(i=vw(i,KW,"$1")),i}},zW={start:Ig(1),end:Ig(2),trim:Ig(3)},YW=CI.PROPER,qW=v,Rw=Tw,JW=zW.trim;Tt({target:"String",proto:!0,forced:function(e){return qW(function(){return!!Rw[e]()||"​᠎"[e]()!=="​᠎"||YW&&Rw[e].name!==e})}("trim")},{trim:function(){return JW(this)}});var XW=Pn("String").trim,QW=$,ZW=XW,wg=String.prototype,$W=function(e){var t=e.trim;return typeof e=="string"||e===wg||QW(wg,e)&&t===wg.trim?ZW:t},qi=g($W),Cw={exports:{}};(function(e){let t={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};t.localCName=t.generateIdentifier(),t.splitLines=function(i){return i.trim().split(`
`).map(r=>r.trim())},t.splitSections=function(i){return i.split(`
m=`).map((r,n)=>(n>0?"m="+r:r).trim()+`\r
`)},t.getDescription=function(i){let r=t.splitSections(i);return r&&r[0]},t.getMediaSections=function(i){let r=t.splitSections(i);return r.shift(),r},t.matchPrefix=function(i,r){return t.splitLines(i).filter(n=>n.indexOf(r)===0)},t.parseCandidate=function(i){let r;r=i.indexOf("a=candidate:")===0?i.substring(12).split(" "):i.substring(10).split(" ");let n={foundation:r[0],component:{1:"rtp",2:"rtcp"}[r[1]]||r[1],protocol:r[2].toLowerCase(),priority:parseInt(r[3],10),ip:r[4],address:r[4],port:parseInt(r[5],10),type:r[7]};for(let o=8;o<r.length;o+=2)switch(r[o]){case"raddr":n.relatedAddress=r[o+1];break;case"rport":n.relatedPort=parseInt(r[o+1],10);break;case"tcptype":n.tcpType=r[o+1];break;case"ufrag":n.ufrag=r[o+1],n.usernameFragment=r[o+1];break;default:n[r[o]]===void 0&&(n[r[o]]=r[o+1])}return n},t.writeCandidate=function(i){let r=[];r.push(i.foundation);let n=i.component;n==="rtp"?r.push(1):n==="rtcp"?r.push(2):r.push(n),r.push(i.protocol.toUpperCase()),r.push(i.priority),r.push(i.address||i.ip),r.push(i.port);let o=i.type;return r.push("typ"),r.push(o),o!=="host"&&i.relatedAddress&&i.relatedPort&&(r.push("raddr"),r.push(i.relatedAddress),r.push("rport"),r.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(r.push("tcptype"),r.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(r.push("ufrag"),r.push(i.usernameFragment||i.ufrag)),"candidate:"+r.join(" ")},t.parseIceOptions=function(i){return i.substring(14).split(" ")},t.parseRtpMap=function(i){let r=i.substring(9).split(" "),n={payloadType:parseInt(r.shift(),10)};return r=r[0].split("/"),n.name=r[0],n.clockRate=parseInt(r[1],10),n.channels=r.length===3?parseInt(r[2],10):1,n.numChannels=n.channels,n},t.writeRtpMap=function(i){let r=i.payloadType;i.preferredPayloadType!==void 0&&(r=i.preferredPayloadType);let n=i.channels||i.numChannels||1;return"a=rtpmap:"+r+" "+i.name+"/"+i.clockRate+(n!==1?"/"+n:"")+`\r
`},t.parseExtmap=function(i){let r=i.substring(9).split(" ");return{id:parseInt(r[0],10),direction:r[0].indexOf("/")>0?r[0].split("/")[1]:"sendrecv",uri:r[1],attributes:r.slice(2).join(" ")}},t.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+(i.attributes?" "+i.attributes:"")+`\r
`},t.parseFmtp=function(i){let r={},n,o=i.substring(i.indexOf(" ")+1).split(";");for(let a=0;a<o.length;a++)n=o[a].trim().split("="),r[n[0].trim()]=n[1];return r},t.writeFmtp=function(i){let r="",n=i.payloadType;if(i.preferredPayloadType!==void 0&&(n=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){let o=[];Object.keys(i.parameters).forEach(a=>{i.parameters[a]!==void 0?o.push(a+"="+i.parameters[a]):o.push(a)}),r+="a=fmtp:"+n+" "+o.join(";")+`\r
`}return r},t.parseRtcpFb=function(i){let r=i.substring(i.indexOf(" ")+1).split(" ");return{type:r.shift(),parameter:r.join(" ")}},t.writeRtcpFb=function(i){let r="",n=i.payloadType;return i.preferredPayloadType!==void 0&&(n=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(o=>{r+="a=rtcp-fb:"+n+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),r},t.parseSsrcMedia=function(i){let r=i.indexOf(" "),n={ssrc:parseInt(i.substring(7,r),10)},o=i.indexOf(":",r);return o>-1?(n.attribute=i.substring(r+1,o),n.value=i.substring(o+1)):n.attribute=i.substring(r+1),n},t.parseSsrcGroup=function(i){let r=i.substring(13).split(" ");return{semantics:r.shift(),ssrcs:r.map(n=>parseInt(n,10))}},t.getMid=function(i){let r=t.matchPrefix(i,"a=mid:")[0];if(r)return r.substring(6)},t.parseFingerprint=function(i){let r=i.substring(14).split(" ");return{algorithm:r[0].toLowerCase(),value:r[1].toUpperCase()}},t.getDtlsParameters=function(i,r){return{role:"auto",fingerprints:t.matchPrefix(i+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(i,r){let n="a=setup:"+r+`\r
`;return i.fingerprints.forEach(o=>{n+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),n},t.parseCryptoLine=function(i){let r=i.substring(9).split(" ");return{tag:parseInt(r[0],10),cryptoSuite:r[1],keyParams:r[2],sessionParams:r.slice(3)}},t.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?t.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;let r=i.substring(7).split("|");return{keyMethod:"inline",keySalt:r[0],lifeTime:r[1],mkiValue:r[2]?r[2].split(":")[0]:void 0,mkiLength:r[2]?r[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")},t.getCryptoParameters=function(i,r){return t.matchPrefix(i+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(i,r){let n=t.matchPrefix(i+r,"a=ice-ufrag:")[0],o=t.matchPrefix(i+r,"a=ice-pwd:")[0];return n&&o?{usernameFragment:n.substring(12),password:o.substring(10)}:null},t.writeIceParameters=function(i){let r="a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`;return i.iceLite&&(r+=`a=ice-lite\r
`),r},t.parseRtpParameters=function(i){let r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(i)[0].split(" ");r.profile=n[2];for(let a=3;a<n.length;a++){let l=n[a],d=t.matchPrefix(i,"a=rtpmap:"+l+" ")[0];if(d){let u=t.parseRtpMap(d),p=t.matchPrefix(i,"a=fmtp:"+l+" ");switch(u.parameters=p.length?t.parseFmtp(p[0]):{},u.rtcpFeedback=t.matchPrefix(i,"a=rtcp-fb:"+l+" ").map(t.parseRtcpFb),r.codecs.push(u),u.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(u.name.toUpperCase())}}}t.matchPrefix(i,"a=extmap:").forEach(a=>{r.headerExtensions.push(t.parseExtmap(a))});let o=t.matchPrefix(i,"a=rtcp-fb:* ").map(t.parseRtcpFb);return r.codecs.forEach(a=>{o.forEach(l=>{a.rtcpFeedback.find(d=>d.type===l.type&&d.parameter===l.parameter)||a.rtcpFeedback.push(l)})}),r},t.writeRtpDescription=function(i,r){let n="";n+="m="+i+" ",n+=r.codecs.length>0?"9":"0",n+=" "+(r.profile||"UDP/TLS/RTP/SAVPF")+" ",n+=r.codecs.map(a=>a.preferredPayloadType!==void 0?a.preferredPayloadType:a.payloadType).join(" ")+`\r
`,n+=`c=IN IP4 0.0.0.0\r
`,n+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,r.codecs.forEach(a=>{n+=t.writeRtpMap(a),n+=t.writeFmtp(a),n+=t.writeRtcpFb(a)});let o=0;return r.codecs.forEach(a=>{a.maxptime>o&&(o=a.maxptime)}),o>0&&(n+="a=maxptime:"+o+`\r
`),r.headerExtensions&&r.headerExtensions.forEach(a=>{n+=t.writeExtmap(a)}),n},t.parseRtpEncodingParameters=function(i){let r=[],n=t.parseRtpParameters(i),o=n.fecMechanisms.indexOf("RED")!==-1,a=n.fecMechanisms.indexOf("ULPFEC")!==-1,l=t.matchPrefix(i,"a=ssrc:").map(f=>t.parseSsrcMedia(f)).filter(f=>f.attribute==="cname"),d=l.length>0&&l[0].ssrc,u,p=t.matchPrefix(i,"a=ssrc-group:FID").map(f=>f.substring(17).split(" ").map(E=>parseInt(E,10)));p.length>0&&p[0].length>1&&p[0][0]===d&&(u=p[0][1]),n.codecs.forEach(f=>{if(f.name.toUpperCase()==="RTX"&&f.parameters.apt){let E={ssrc:d,codecPayloadType:parseInt(f.parameters.apt,10)};d&&u&&(E.rtx={ssrc:u}),r.push(E),o&&(E=JSON.parse(JSON.stringify(E)),E.fec={ssrc:d,mechanism:a?"red+ulpfec":"red"},r.push(E))}}),r.length===0&&d&&r.push({ssrc:d});let m=t.matchPrefix(i,"b=");return m.length&&(m=m[0].indexOf("b=TIAS:")===0?parseInt(m[0].substring(7),10):m[0].indexOf("b=AS:")===0?1e3*parseInt(m[0].substring(5),10)*.95-16e3:void 0,r.forEach(f=>{f.maxBitrate=m})),r},t.parseRtcpParameters=function(i){let r={},n=t.matchPrefix(i,"a=ssrc:").map(l=>t.parseSsrcMedia(l)).filter(l=>l.attribute==="cname")[0];n&&(r.cname=n.value,r.ssrc=n.ssrc);let o=t.matchPrefix(i,"a=rtcp-rsize");r.reducedSize=o.length>0,r.compound=o.length===0;let a=t.matchPrefix(i,"a=rtcp-mux");return r.mux=a.length>0,r},t.writeRtcpParameters=function(i){let r="";return i.reducedSize&&(r+=`a=rtcp-rsize\r
`),i.mux&&(r+=`a=rtcp-mux\r
`),i.ssrc!==void 0&&i.cname&&(r+="a=ssrc:"+i.ssrc+" cname:"+i.cname+`\r
`),r},t.parseMsid=function(i){let r,n=t.matchPrefix(i,"a=msid:");if(n.length===1)return r=n[0].substring(7).split(" "),{stream:r[0],track:r[1]};let o=t.matchPrefix(i,"a=ssrc:").map(a=>t.parseSsrcMedia(a)).filter(a=>a.attribute==="msid");return o.length>0?(r=o[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},t.parseSctpDescription=function(i){let r=t.parseMLine(i),n=t.matchPrefix(i,"a=max-message-size:"),o;n.length>0&&(o=parseInt(n[0].substring(19),10)),isNaN(o)&&(o=65536);let a=t.matchPrefix(i,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substring(12),10),protocol:r.fmt,maxMessageSize:o};let l=t.matchPrefix(i,"a=sctpmap:");if(l.length>0){let d=l[0].substring(10).split(" ");return{port:parseInt(d[0],10),protocol:d[1],maxMessageSize:o}}},t.writeSctpDescription=function(i,r){let n=[];return n=i.protocol!=="DTLS/SCTP"?["m="+i.kind+" 9 "+i.protocol+" "+r.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+r.port+`\r
`]:["m="+i.kind+" 9 "+i.protocol+" "+r.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+r.port+" "+r.protocol+` 65535\r
`],r.maxMessageSize!==void 0&&n.push("a=max-message-size:"+r.maxMessageSize+`\r
`),n.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(i,r,n){let o,a=r!==void 0?r:2;return o=i||t.generateSessionId(),`v=0\r
o=`+(n||"thisisadapterortc")+" "+o+" "+a+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(i,r){let n=t.splitLines(i);for(let o=0;o<n.length;o++)switch(n[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[o].substring(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(i){return t.splitLines(i)[0].split(" ")[0].substring(2)},t.isRejected=function(i){return i.split(" ",2)[1]==="0"},t.parseMLine=function(i){let r=t.splitLines(i)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(i){let r=t.matchPrefix(i,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;let r=t.splitLines(i);for(let n=0;n<r.length;n++)if(r[n].length<2||r[n].charAt(1)!=="=")return!1;return!0},e.exports=t})(Cw);var yw=Cw.exports,dl=g(yw),e5=h({__proto__:null,default:dl},[yw]);function Pp(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;let t=e.RTCIceCandidate;e.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&((i=JSON.parse(JSON.stringify(i))).candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){let r=new t(i),n=dl.parseCandidate(i.candidate),o=Object.assign(r,n);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new t(i)},e.RTCIceCandidate.prototype=t.prototype,za(e,"icecandidate",i=>(i.candidate&&Object.defineProperty(i,"candidate",{value:new e.RTCIceCandidate(i.candidate),writable:"false"}),i))}function Ag(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||za(e,"icecandidate",t=>{if(t.candidate){let i=dl.parseCandidate(t.candidate.candidate);i.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[i.priority>>24])}return t})}function kp(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});let i=function(l){if(!l||!l.sdp)return!1;let d=dl.splitSections(l.sdp);return d.shift(),d.some(u=>{let p=dl.parseMLine(u);return p&&p.kind==="application"&&p.protocol.indexOf("SCTP")!==-1})},r=function(l){let d=l.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(d===null||d.length<2)return-1;let u=parseInt(d[1],10);return u!=u?-1:u},n=function(l){let d=65536;return t.browser==="firefox"&&(d=t.version<57?l===-1?16384:2147483637:t.version<60?t.version===57?65535:65536:2147483637),d},o=function(l,d){let u=65536;t.browser==="firefox"&&t.version===57&&(u=65535);let p=dl.matchPrefix(l.sdp,"a=max-message-size:");return p.length>0?u=parseInt(p[0].substr(19),10):t.browser==="firefox"&&d!==-1&&(u=2147483637),u},a=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){let{sdpSemantics:l}=this.getConfiguration();l==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){let l=r(arguments[0]),d=n(l),u=o(arguments[0],l),p;p=d===0&&u===0?Number.POSITIVE_INFINITY:d===0||u===0?Math.max(d,u):Math.min(d,u);let m={};Object.defineProperty(m,"maxMessageSize",{get:()=>p}),this._sctp=m}return a.apply(this,arguments)}}function Lp(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(r,n){let o=r.send;r.send=function(){let a=arguments[0],l=a.length||a.size||a.byteLength;if(r.readyState==="open"&&n.sctp&&l>n.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+n.sctp.maxMessageSize+" bytes)");return o.apply(r,arguments)}}let i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){let r=i.apply(this,arguments);return t(r,this),r},za(e,"datachannel",r=>(t(r.channel,r.target),r))}function Og(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;let t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(i){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),i&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=i)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(i=>{let r=t[i];t[i]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=n=>{let o=n.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;let a=new Event("connectionstatechange",n);o.dispatchEvent(a)}return n},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}})}function bg(e,t){if(!e.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;let i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let n=r.sdp.split(`
`).filter(o=>qi(o).call(o)!=="a=extmap-allow-mixed").join(`
`);e.RTCSessionDescription&&r instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:r.type,sdp:n}):r.sdp=n}return i.apply(this,arguments)}}function Mp(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;let i=e.RTCPeerConnection.prototype.addIceCandidate;i&&i.length!==0&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?ne.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),ne.resolve())})}function Up(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;let i=e.RTCPeerConnection.prototype.setLocalDescription;i&&i.length!==0&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return i.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer"}return r.sdp||r.type!=="offer"&&r.type!=="answer"?i.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(n=>i.apply(this,[n]))})}var t5=Object.freeze({__proto__:null,removeExtmapAllowMixed:bg,shimAddIceCandidateNullOrEmpty:Mp,shimConnectionState:Og,shimMaxMessageSize:kp,shimParameterlessSetLocalDescription:Up,shimRTCIceCandidate:Pp,shimRTCIceCandidateRelayProtocol:Ag,shimSendThrowTypeError:Lp});(function(){let{window:e}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},i=zy,r=function(o){let a={browser:null,version:null};if(o===void 0||!o.navigator)return a.browser="Not a browser.",a;let{navigator:l}=o;if(l.mozGetUserMedia)a.browser="firefox",a.version=cp(l.userAgent,/Firefox\/(\d+)\./,1);else if(l.webkitGetUserMedia||o.isSecureContext===!1&&o.webkitRTCPeerConnection)a.browser="chrome",a.version=cp(l.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!o.RTCPeerConnection||!l.userAgent.match(/AppleWebKit\/(\d+)\./))return a.browser="Not a supported browser.",a;a.browser="safari",a.version=cp(l.userAgent,/AppleWebKit\/(\d+)\./,1),a.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype}return a}(e),n={browserDetails:r,commonShim:t5,extractVersion:cp,disableLog:Zj,disableWarnings:$j,sdp:e5};switch(r.browser){case"chrome":if(!Z0||!Rg||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),n;if(r.version===null)return i("Chrome shim can not determine version, not shimming."),n;i("adapter.js shimming chrome."),n.browserShim=Z0,Mp(e,r),Up(e),W0(e,r),H0(e),Rg(e,r),K0(e),X0(e,r),z0(e),Y0(e),q0(e),Q0(e,r),Pp(e),Ag(e),Og(e),kp(e,r),Lp(e),bg(e,r);break;case"firefox":if(!lw||!Cg||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),n;i("adapter.js shimming firefox."),n.browserShim=lw,Mp(e,r),Up(e),$0(e,r),Cg(e,r),ew(e),rw(e),tw(e),iw(e),nw(e),ow(e),sw(e),aw(e),cw(e),Pp(e),Og(e),kp(e,r),Lp(e);break;case"safari":if(!Sw||!t.shimSafari)return i("Safari shim is not included in this adapter release."),n;i("adapter.js shimming safari."),n.browserShim=Sw,Mp(e,r),Up(e),_w(e),Ew(e),hw(e),dw(e),uw(e),fw(e),pw(e),gw(e),Pp(e),Ag(e),kp(e,r),Lp(e),bg(e,r);break;default:i("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var i5=Pn("Array").keys,r5=Lo,n5=Fi,o5=$,s5=i5,Ng=Array.prototype,a5={DOMTokenList:!0,NodeList:!0},c5=function(e){var t=e.keys;return e===Ng||o5(Ng,e)&&t===Ng.keys||n5(a5,r5(e))?s5:t},Yr=g(c5),Iw=Zc,l5=TypeError,d5=rp,u5=Dn,h5=Sr,xp=function(e,t,i){var r=d5(t);r in e?u5.f(e,r,h5(0,i)):e[r]=i},ww=pE,p5=cs,m5=xp,_5=Array,f5=Math.max,Dg=function(e,t,i){for(var r=p5(e),n=ww(t,r),o=ww(i===void 0?r:i,r),a=_5(f5(o-n,0)),l=0;n<o;n++,l++)m5(a,l,e[n]);return a.length=l,a},Aw=Dg,E5=Math.floor,Pg=function(e,t){var i=e.length,r=E5(i/2);return i<8?g5(e,t):S5(e,Pg(Aw(e,0,r),t),Pg(Aw(e,r),t),t)},g5=function(e,t){for(var i,r,n=e.length,o=1;o<n;){for(r=o,i=e[o];r&&t(e[r-1],i)>0;)e[r]=e[--r];r!==o++&&(e[r]=i)}return e},S5=function(e,t,i,r){for(var n=t.length,o=i.length,a=0,l=0;a<n||l<o;)e[a+l]=a<n&&l<o?r(t[a],i[l])<=0?t[a++]:i[l++]:a<n?t[a++]:i[l++];return e},Ow=Pg,bw=Ha.match(/firefox\/(\d+)/i),T5=!!bw&&+bw[1],v5=/MSIE|Trident/.test(Ha),Nw=Ha.match(/AppleWebKit\/(\d+)\./),R5=!!Nw&&+Nw[1],C5=Tt,Dw=K,y5=Nn,I5=ko,Pw=cs,w5=function(e,t){if(!delete e[t])throw l5("Cannot delete property "+Iw(t)+" of "+Iw(e))},kw=hn,kg=v,A5=Ow,O5=ap,Lw=T5,b5=v5,Mw=Ka,Uw=R5,Ws=[],xw=Dw(Ws.sort),N5=Dw(Ws.push),D5=kg(function(){Ws.sort(void 0)}),P5=kg(function(){Ws.sort(null)}),k5=O5("sort"),Vw=!kg(function(){if(Mw)return Mw<70;if(!(Lw&&Lw>3)){if(b5)return!0;if(Uw)return Uw<603;var e,t,i,r,n="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(r=0;r<47;r++)Ws.push({k:t+r,v:i})}for(Ws.sort(function(o,a){return a.v-o.v}),r=0;r<Ws.length;r++)t=Ws[r].k.charAt(0),n.charAt(n.length-1)!==t&&(n+=t);return n!=="DGBEFHACIJK"}});C5({target:"Array",proto:!0,forced:D5||!P5||!k5||!Vw},{sort:function(e){e!==void 0&&y5(e);var t=I5(this);if(Vw)return e===void 0?xw(t):xw(t,e);var i,r,n=[],o=Pw(t);for(r=0;r<o;r++)r in t&&N5(n,t[r]);for(A5(n,function(a){return function(l,d){return d===void 0?-1:l===void 0?1:a!==void 0?+a(l,d)||0:kw(l)>kw(d)?1:-1}}(e)),i=Pw(n),r=0;r<i;)t[r]=n[r++];for(;r<o;)w5(t,r++);return t}});var L5=Pn("Array").sort,M5=$,U5=L5,Lg=Array.prototype,x5=function(e){var t=e.sort;return e===Lg||M5(Lg,e)&&t===Lg.sort?U5:t},tu=g(x5),Mg={exports:{}};(function(e,t){(function(i,r){var n="function",o="undefined",a="object",l="string",d="major",u="model",p="name",m="type",f="vendor",E="version",I="architecture",T="console",R="mobile",w="tablet",O="smarttv",P="wearable",M="embedded",V="Amazon",F="Apple",Y="ASUS",J="BlackBerry",Z="Browser",pe="Chrome",Ke="Firefox",rt="Google",Ct="Huawei",Zt="LG",Mt="Microsoft",$n="Motorola",z="Opera",re="Samsung",he="Sharp",Pe="Sony",tt="Xiaomi",oe="Zebra",C="Facebook",D="Chromium OS",k="Mac OS",te=function(zt){for(var ni={},At=0;At<zt.length;At++)ni[zt[At].toUpperCase()]=zt[At];return ni},be=function(zt,ni){return typeof zt===l&&St(ni).indexOf(St(zt))!==-1},St=function(zt){return zt.toLowerCase()},li=function(zt,ni){if(typeof zt===l)return zt=zt.replace(/^\s\s*/,""),typeof ni===o?zt:zt.substring(0,350)},wr=function(zt,ni){for(var At,jr,is,Yt,it,Ar,Ta=0;Ta<ni.length&&!it;){var Co=ni[Ta],VM=ni[Ta+1];for(At=jr=0;At<Co.length&&!it&&Co[At];)if(it=Co[At++].exec(zt))for(is=0;is<VM.length;is++)Ar=it[++jr],typeof(Yt=VM[is])===a&&Yt.length>0?Yt.length===2?typeof Yt[1]==n?this[Yt[0]]=Yt[1].call(this,Ar):this[Yt[0]]=Yt[1]:Yt.length===3?typeof Yt[1]!==n||Yt[1].exec&&Yt[1].test?this[Yt[0]]=Ar?Ar.replace(Yt[1],Yt[2]):r:this[Yt[0]]=Ar?Yt[1].call(this,Ar,Yt[2]):r:Yt.length===4&&(this[Yt[0]]=Ar?Yt[3].call(this,Ar.replace(Yt[1],Yt[2])):r):this[Yt]=Ar||r;Ta+=2}},ys=function(zt,ni){for(var At in ni)if(typeof ni[At]===a&&ni[At].length>0){for(var jr=0;jr<ni[At].length;jr++)if(be(ni[At][jr],zt))return At==="?"?r:At}else if(be(ni[At],zt))return At==="?"?r:At;return zt},N_={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},D_={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[E,[p,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[E,[p,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[p,E],[/opios[\/ ]+([\w\.]+)/i],[E,[p,z+" Mini"]],[/\bopr\/([\w\.]+)/i],[E,[p,z]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[p,E],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[E,[p,"UC"+Z]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i],[E,[p,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[E,[p,"WeChat"]],[/konqueror\/([\w\.]+)/i],[E,[p,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[E,[p,"IE"]],[/yabrowser\/([\w\.]+)/i],[E,[p,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[p,/(.+)/,"$1 Secure "+Z],E],[/\bfocus\/([\w\.]+)/i],[E,[p,Ke+" Focus"]],[/\bopt\/([\w\.]+)/i],[E,[p,z+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[E,[p,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[E,[p,"Dolphin"]],[/coast\/([\w\.]+)/i],[E,[p,z+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[E,[p,"MIUI "+Z]],[/fxios\/([-\w\.]+)/i],[E,[p,Ke]],[/\bqihu|(qi?ho?o?|360)browser/i],[[p,"360 "+Z]],[/(oculus|samsung|sailfish|huawei)browser\/([\w\.]+)/i],[[p,/(.+)/,"$1 "+Z],E],[/(comodo_dragon)\/([\w\.]+)/i],[[p,/_/g," "],E],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[p,E],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i,/\[(linkedin)app\]/i],[p],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[p,C],E],[/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[p,E],[/\bgsa\/([\w\.]+) .*safari\//i],[E,[p,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[E,[p,pe+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[p,pe+" WebView"],E],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[E,[p,"Android "+Z]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[p,E],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[E,[p,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[E,p],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[p,[E,ys,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[p,E],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[p,"Netscape"],E],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[E,[p,Ke+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[p,E],[/(cobalt)\/([\w\.]+)/i],[p,[E,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[I,"amd64"]],[/(ia32(?=;))/i],[[I,St]],[/((?:i[346]|x)86)[;\)]/i],[[I,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[I,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[I,"armhf"]],[/windows (ce|mobile); ppc;/i],[[I,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[I,/ower/,"",St]],[/(sun4\w)[;\)]/i],[[I,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[I,St]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[u,[f,re],[m,w]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[u,[f,re],[m,R]],[/\((ip(?:hone|od)[\w ]*);/i],[u,[f,F],[m,R]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[u,[f,F],[m,w]],[/(macintosh);/i],[u,[f,F]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[u,[f,he],[m,R]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[u,[f,Ct],[m,w]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[u,[f,Ct],[m,R]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[u,/_/g," "],[f,tt],[m,R]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[u,/_/g," "],[f,tt],[m,w]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[u,[f,"OPPO"],[m,R]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[u,[f,"Vivo"],[m,R]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[u,[f,"Realme"],[m,R]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[u,[f,$n],[m,R]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[u,[f,$n],[m,w]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[u,[f,Zt],[m,w]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[u,[f,Zt],[m,R]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[u,[f,"Lenovo"],[m,w]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[u,/_/g," "],[f,"Nokia"],[m,R]],[/(pixel c)\b/i],[u,[f,rt],[m,w]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[u,[f,rt],[m,R]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[u,[f,Pe],[m,R]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[u,"Xperia Tablet"],[f,Pe],[m,w]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[u,[f,"OnePlus"],[m,R]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[u,[f,V],[m,w]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[u,/(.+)/g,"Fire Phone $1"],[f,V],[m,R]],[/(playbook);[-\w\),; ]+(rim)/i],[u,f,[m,w]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[u,[f,J],[m,R]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[u,[f,Y],[m,w]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[u,[f,Y],[m,R]],[/(nexus 9)/i],[u,[f,"HTC"],[m,w]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[f,[u,/_/g," "],[m,R]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[u,[f,"Acer"],[m,w]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[u,[f,"Meizu"],[m,R]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[f,u,[m,R]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[f,u,[m,w]],[/(surface duo)/i],[u,[f,Mt],[m,w]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[u,[f,"Fairphone"],[m,R]],[/(u304aa)/i],[u,[f,"AT&T"],[m,R]],[/\bsie-(\w*)/i],[u,[f,"Siemens"],[m,R]],[/\b(rct\w+) b/i],[u,[f,"RCA"],[m,w]],[/\b(venue[\d ]{2,7}) b/i],[u,[f,"Dell"],[m,w]],[/\b(q(?:mv|ta)\w+) b/i],[u,[f,"Verizon"],[m,w]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[u,[f,"Barnes & Noble"],[m,w]],[/\b(tm\d{3}\w+) b/i],[u,[f,"NuVision"],[m,w]],[/\b(k88) b/i],[u,[f,"ZTE"],[m,w]],[/\b(nx\d{3}j) b/i],[u,[f,"ZTE"],[m,R]],[/\b(gen\d{3}) b.+49h/i],[u,[f,"Swiss"],[m,R]],[/\b(zur\d{3}) b/i],[u,[f,"Swiss"],[m,w]],[/\b((zeki)?tb.*\b) b/i],[u,[f,"Zeki"],[m,w]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[f,"Dragon Touch"],u,[m,w]],[/\b(ns-?\w{0,9}) b/i],[u,[f,"Insignia"],[m,w]],[/\b((nxa|next)-?\w{0,9}) b/i],[u,[f,"NextBook"],[m,w]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[f,"Voice"],u,[m,R]],[/\b(lvtel\-)?(v1[12]) b/i],[[f,"LvTel"],u,[m,R]],[/\b(ph-1) /i],[u,[f,"Essential"],[m,R]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[u,[f,"Envizen"],[m,w]],[/\b(trio[-\w\. ]+) b/i],[u,[f,"MachSpeed"],[m,w]],[/\btu_(1491) b/i],[u,[f,"Rotor"],[m,w]],[/(shield[\w ]+) b/i],[u,[f,"Nvidia"],[m,w]],[/(sprint) (\w+)/i],[f,u,[m,R]],[/(kin\.[onetw]{3})/i],[[u,/\./g," "],[f,Mt],[m,R]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[u,[f,oe],[m,w]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[u,[f,oe],[m,R]],[/smart-tv.+(samsung)/i],[f,[m,O]],[/hbbtv.+maple;(\d+)/i],[[u,/^/,"SmartTV"],[f,re],[m,O]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[f,Zt],[m,O]],[/(apple) ?tv/i],[f,[u,F+" TV"],[m,O]],[/crkey/i],[[u,pe+"cast"],[f,rt],[m,O]],[/droid.+aft(\w)( bui|\))/i],[u,[f,V],[m,O]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[u,[f,he],[m,O]],[/(bravia[\w ]+)( bui|\))/i],[u,[f,Pe],[m,O]],[/(mitv-\w{5}) bui/i],[u,[f,tt],[m,O]],[/Hbbtv.*(technisat) (.*);/i],[f,u,[m,O]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[f,li],[u,li],[m,O]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[m,O]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[f,u,[m,T]],[/droid.+; (shield) bui/i],[u,[f,"Nvidia"],[m,T]],[/(playstation [345portablevi]+)/i],[u,[f,Pe],[m,T]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[u,[f,Mt],[m,T]],[/((pebble))app/i],[f,u,[m,P]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[u,[f,F],[m,P]],[/droid.+; (glass) \d/i],[u,[f,rt],[m,P]],[/droid.+; (wt63?0{2,3})\)/i],[u,[f,oe],[m,P]],[/(quest( 2| pro)?)/i],[u,[f,C],[m,P]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[f,[m,M]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[u,[m,R]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[u,[m,w]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[m,w]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[m,R]],[/(android[-\w\. ]{0,9});.+buil/i],[u,[f,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[E,[p,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[E,[p,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[p,E],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[E,p]],os:[[/microsoft (windows) (vista|xp)/i],[p,E],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[p,[E,ys,N_]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[p,"Windows"],[E,ys,N_]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[E,/_/g,"."],[p,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[p,k],[E,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[E,p],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[p,E],[/\(bb(10);/i],[E,[p,J]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[E,[p,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[E,[p,Ke+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[E,[p,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[E,[p,"watchOS"]],[/crkey\/([\d\.]+)/i],[E,[p,pe+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[p,D],E],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[p,E],[/(sunos) ?([\w\.\d]*)/i],[[p,"Solaris"],E],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[p,E]]},Cn=function(zt,ni){if(typeof zt===a&&(ni=zt,zt=r),!(this instanceof Cn))return new Cn(zt,ni).getResult();var At=typeof i!==o&&i.navigator?i.navigator:r,jr=zt||(At&&At.userAgent?At.userAgent:""),is=At&&At.userAgentData?At.userAgentData:r,Yt=ni?function(it,Ar){var Ta={};for(var Co in it)Ar[Co]&&Ar[Co].length%2==0?Ta[Co]=Ar[Co].concat(it[Co]):Ta[Co]=it[Co];return Ta}(D_,ni):D_;return this.getBrowser=function(){var it={};return it[p]=r,it[E]=r,wr.call(it,jr,Yt.browser),it[d]=function(Ar){return typeof Ar===l?Ar.replace(/[^\d\.]/g,"").split(".")[0]:r}(it[E]),At&&At.brave&&typeof At.brave.isBrave==n&&(it[p]="Brave"),it},this.getCPU=function(){var it={};return it[I]=r,wr.call(it,jr,Yt.cpu),it},this.getDevice=function(){var it={};return it[f]=r,it[u]=r,it[m]=r,wr.call(it,jr,Yt.device),!it[m]&&is&&is.mobile&&(it[m]=R),it[u]=="Macintosh"&&At&&typeof At.standalone!==o&&At.maxTouchPoints&&At.maxTouchPoints>2&&(it[u]="iPad",it[m]=w),it},this.getEngine=function(){var it={};return it[p]=r,it[E]=r,wr.call(it,jr,Yt.engine),it},this.getOS=function(){var it={};return it[p]=r,it[E]=r,wr.call(it,jr,Yt.os),!it[p]&&is&&is.platform!="Unknown"&&(it[p]=is.platform.replace(/chrome os/i,D).replace(/macos/i,k)),it},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return jr},this.setUA=function(it){return jr=typeof it===l&&it.length>350?li(it,350):it,this},this.setUA(jr),this};Cn.VERSION="0.7.34",Cn.BROWSER=te([p,E,d]),Cn.CPU=te([I]),Cn.DEVICE=te([u,f,m,T,R,O,w,P,M]),Cn.ENGINE=Cn.OS=te([p,E]),e.exports&&(t=e.exports=Cn),t.UAParser=Cn;var Sa=typeof i!==o&&(i.jQuery||i.Zepto);if(Sa&&!Sa.ua){var ld=new Cn;Sa.ua=ld.getResult(),Sa.ua.get=function(){return ld.getUA()},Sa.ua.set=function(zt){ld.setUA(zt);var ni=ld.getResult();for(var At in ni)Sa.ua[At]=ni[At]}}})(typeof window=="object"?window:_)})(Mg,Mg.exports);var V5=g(Mg.exports),F5=Lo,j5=Fi,B5=Jc,G5=Ya,W5=qt("iterator"),H5=Object,K5=function(e){if(B5(e))return!1;var t=H5(e);return t[W5]!==void 0||"@@iterator"in t||j5(G5,F5(t))},z5=g(K5),Ug=le;Tt({global:!0,forced:Ug.globalThis!==Ug},{globalThis:Ug});var Fw=g(le);function jw(e,t){return function(){return e.apply(t,arguments)}}let{toString:Y5}=Object.prototype,{getPrototypeOf:xg}=Object,Vp=(Vg=Object.create(null),e=>{let t=Y5.call(e);return Vg[t]||(Vg[t]=t.slice(8,-1).toLowerCase())});var Vg;let xo=e=>(e=e.toLowerCase(),t=>Vp(t)===e),Fp=e=>t=>typeof t===e,{isArray:ul}=Array,iu=Fp("undefined"),Bw=xo("ArrayBuffer"),q5=Fp("string"),kn=Fp("function"),Gw=Fp("number"),jp=e=>e!==null&&typeof e=="object",Bp=e=>{if(Vp(e)!=="object")return!1;let t=xg(e);return!(t!==null&&t!==Object.prototype&&Object.getPrototypeOf(t)!==null||Symbol.toStringTag in e||z5(e))},J5=xo("Date"),X5=xo("File"),Q5=xo("Blob"),Z5=xo("FileList"),$5=xo("URLSearchParams");function ru(e,t){let i,r,{allOwnKeys:n=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(e!=null)if(typeof e!="object"&&(e=[e]),ul(e))for(i=0,r=e.length;i<r;i++)t.call(null,e[i],i,e);else{let o=n?Object.getOwnPropertyNames(e):Object.keys(e),a=o.length,l;for(i=0;i<a;i++)l=o[i],t.call(null,e[l],l,e)}}function Ww(e,t){t=t.toLowerCase();let i=Object.keys(e),r,n=i.length;for(;n-- >0;)if(r=i[n],t===r.toLowerCase())return r;return null}let Hw=Fw!==void 0?Fw:typeof self<"u"?self:typeof window<"u"?window:global,Kw=e=>!iu(e)&&e!==Hw,eH=(Fg=typeof Uint8Array<"u"&&xg(Uint8Array),e=>Fg&&e instanceof Fg);var Fg;let tH=xo("HTMLFormElement"),zw=(e=>{let{hasOwnProperty:t}=e;return(i,r)=>t.call(i,r)})(Object.prototype),iH=xo("RegExp"),Yw=(e,t)=>{let i=Object.getOwnPropertyDescriptors(e),r={};ru(i,(n,o)=>{let a;(a=t(n,o,e))!==!1&&(r[o]=a||n)}),Object.defineProperties(e,r)},jg="abcdefghijklmnopqrstuvwxyz",qw="0123456789",Jw={DIGIT:qw,ALPHA:jg,ALPHA_DIGIT:jg+jg.toUpperCase()+qw},rH=xo("AsyncFunction");var ue={isArray:ul,isArrayBuffer:Bw,isBuffer:function(e){return e!==null&&!iu(e)&&e.constructor!==null&&!iu(e.constructor)&&kn(e.constructor.isBuffer)&&e.constructor.isBuffer(e)},isFormData:e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||kn(e.append)&&((t=Vp(e))==="formdata"||t==="object"&&kn(e.toString)&&e.toString()==="[object FormData]"))},isArrayBufferView:function(e){let t;return t=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&Bw(e.buffer),t},isString:q5,isNumber:Gw,isBoolean:e=>e===!0||e===!1,isObject:jp,isPlainObject:Bp,isUndefined:iu,isDate:J5,isFile:X5,isBlob:Q5,isRegExp:iH,isFunction:kn,isStream:e=>jp(e)&&kn(e.pipe),isURLSearchParams:$5,isTypedArray:eH,isFileList:Z5,forEach:ru,merge:function e(){let{caseless:t}=Kw(this)&&this||{},i={},r=(n,o)=>{let a=t&&Ww(i,o)||o;Bp(i[a])&&Bp(n)?i[a]=e(i[a],n):Bp(n)?i[a]=e({},n):ul(n)?i[a]=n.slice():i[a]=n};for(let n=0,o=arguments.length;n<o;n++)arguments[n]&&ru(arguments[n],r);return i},extend:function(e,t,i){let{allOwnKeys:r}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return ru(t,(n,o)=>{i&&kn(n)?e[o]=jw(n,i):e[o]=n},{allOwnKeys:r}),e},trim:e=>qi(e)?qi(e).call(e):e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),inherits:(e,t,i,r)=>{e.prototype=Object.create(t.prototype,r),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),i&&Object.assign(e.prototype,i)},toFlatObject:(e,t,i,r)=>{let n,o,a,l={};if(t=t||{},e==null)return t;do{for(n=Object.getOwnPropertyNames(e),o=n.length;o-- >0;)a=n[o],r&&!r(a,e,t)||l[a]||(t[a]=e[a],l[a]=!0);e=i!==!1&&xg(e)}while(e&&(!i||i(e,t))&&e!==Object.prototype);return t},kindOf:Vp,kindOfTest:xo,endsWith:(e,t,i)=>{e=String(e),(i===void 0||i>e.length)&&(i=e.length),i-=t.length;let r=e.indexOf(t,i);return r!==-1&&r===i},toArray:e=>{if(!e)return null;if(ul(e))return e;let t=e.length;if(!Gw(t))return null;let i=new Array(t);for(;t-- >0;)i[t]=e[t];return i},forEachEntry:(e,t)=>{let i=(e&&e[Symbol.iterator]).call(e),r;for(;(r=i.next())&&!r.done;){let n=r.value;t.call(e,n[0],n[1])}},matchAll:(e,t)=>{let i,r=[];for(;(i=e.exec(t))!==null;)r.push(i);return r},isHTMLForm:tH,hasOwnProperty:zw,hasOwnProp:zw,reduceDescriptors:Yw,freezeMethods:e=>{Yw(e,(t,i)=>{if(kn(e)&&["arguments","caller","callee"].indexOf(i)!==-1)return!1;let r=e[i];kn(r)&&(t.enumerable=!1,"writable"in t?t.writable=!1:t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))})},toObjectSet:(e,t)=>{let i={},r=n=>{n.forEach(o=>{i[o]=!0})};return ul(e)?r(e):r(String(e).split(t)),i},toCamelCase:e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,i,r){return i.toUpperCase()+r}),noop:()=>{},toFiniteNumber:(e,t)=>(e=+e,Number.isFinite(e)?e:t),findKey:Ww,global:Hw,isContextDefined:Kw,ALPHABET:Jw,generateString:function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Jw.ALPHA_DIGIT,i="",{length:r}=t;for(;e--;)i+=t[Math.random()*r|0];return i},isSpecCompliantForm:function(e){return!!(e&&kn(e.append)&&e[Symbol.toStringTag]==="FormData"&&e[Symbol.iterator])},toJSONObject:e=>{let t=new Array(10),i=(r,n)=>{if(jp(r)){if(t.indexOf(r)>=0)return;if(!("toJSON"in r)){t[n]=r;let o=ul(r)?[]:{};return ru(r,(a,l)=>{let d=i(a,n+1);!iu(d)&&(o[l]=d)}),t[n]=void 0,o}}return r};return i(e,0)},isAsyncFn:rH,isThenable:e=>e&&(jp(e)||kn(e))&&kn(e.then)&&kn(e.catch)};function Pt(e,t,i,r,n){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),i&&(this.config=i),r&&(this.request=r),n&&(this.response=n)}ue.inherits(Pt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:ue.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});let Xw=Pt.prototype,Qw={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(e=>{Qw[e]={value:e}}),Object.defineProperties(Pt,Qw),Object.defineProperty(Xw,"isAxiosError",{value:!0}),Pt.from=(e,t,i,r,n,o)=>{let a=Object.create(Xw);return ue.toFlatObject(e,a,function(l){return l!==Error.prototype},l=>l!=="isAxiosError"),Pt.call(a,e.message,t,i,r,n),a.cause=e,a.name=e.name,o&&Object.assign(a,o),a};function Bg(e){return ue.isPlainObject(e)||ue.isArray(e)}function Zw(e){return ue.endsWith(e,"[]")?e.slice(0,-2):e}function $w(e,t,i){return e?e.concat(t).map(function(r,n){return r=Zw(r),!i&&n?"["+r+"]":r}).join(i?".":""):t}let nH=ue.toFlatObject(ue,{},null,function(e){return/^is[A-Z]/.test(e)});function Gp(e,t,i){if(!ue.isObject(e))throw new TypeError("target must be an object");t=t||new FormData;let r=(i=ue.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,function(f,E){return!ue.isUndefined(E[f])})).metaTokens,n=i.visitor||u,o=i.dots,a=i.indexes,l=(i.Blob||typeof Blob<"u"&&Blob)&&ue.isSpecCompliantForm(t);if(!ue.isFunction(n))throw new TypeError("visitor must be a function");function d(f){if(f===null)return"";if(ue.isDate(f))return f.toISOString();if(!l&&ue.isBlob(f))throw new Pt("Blob is not supported. Use a Buffer instead.");return ue.isArrayBuffer(f)||ue.isTypedArray(f)?l&&typeof Blob=="function"?new Blob([f]):Buffer.from(f):f}function u(f,E,I){let T=f;if(f&&!I&&typeof f=="object"){if(ue.endsWith(E,"{}"))E=r?E:E.slice(0,-2),f=JSON.stringify(f);else if(ue.isArray(f)&&function(R){return ue.isArray(R)&&!R.some(Bg)}(f)||(ue.isFileList(f)||ue.endsWith(E,"[]"))&&(T=ue.toArray(f)))return E=Zw(E),T.forEach(function(R,w){!ue.isUndefined(R)&&R!==null&&t.append(a===!0?$w([E],w,o):a===null?E:E+"[]",d(R))}),!1}return!!Bg(f)||(t.append($w(I,E,o),d(f)),!1)}let p=[],m=Object.assign(nH,{defaultVisitor:u,convertValue:d,isVisitable:Bg});if(!ue.isObject(e))throw new TypeError("data must be an object");return function f(E,I){if(!ue.isUndefined(E)){if(p.indexOf(E)!==-1)throw Error("Circular reference detected in "+I.join("."));p.push(E),ue.forEach(E,function(T,R){(!(ue.isUndefined(T)||T===null)&&n.call(t,T,ue.isString(R)?qi(R).call(R):R,I,m))===!0&&f(T,I?I.concat(R):[R])}),p.pop()}}(e),t}function eA(e){let t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,function(i){return t[i]})}function Gg(e,t){this._pairs=[],e&&Gp(e,this,t)}let tA=Gg.prototype;function oH(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function iA(e,t,i){if(!t)return e;let r=i&&i.encode||oH,n=i&&i.serialize,o;if(o=n?n(t,i):ue.isURLSearchParams(t)?t.toString():new Gg(t,i).toString(r),o){let a=e.indexOf("#");a!==-1&&(e=e.slice(0,a)),e+=(e.indexOf("?")===-1?"?":"&")+o}return e}tA.append=function(e,t){this._pairs.push([e,t])},tA.toString=function(e){let t=e?function(i){return e.call(this,i,eA)}:eA;return this._pairs.map(function(i){return t(i[0])+"="+t(i[1])},"").join("&")};var rA=class{constructor(){this.handlers=[]}use(e,t,i){return this.handlers.push({fulfilled:e,rejected:t,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){ue.forEach(this.handlers,function(t){t!==null&&e(t)})}},nA={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},oA={exports:{}},sH=Tt,aH=dr,sA=Dn.f;sH({target:"Object",stat:!0,forced:Object.defineProperty!==sA,sham:!aH},{defineProperty:sA});var aA=so.Object,cH=oA.exports=function(e,t,i){return aA.defineProperty(e,t,i)};aA.defineProperty.sham&&(cH.sham=!0);var cA=g(oA.exports),lH=De,nu=Array.isArray||function(e){return lH(e)=="Array"},dH=TypeError,lA=nu,uH=yp,hH=zr,pH=qt("species"),dA=Array,mH=function(e){var t;return lA(e)&&(t=e.constructor,(uH(t)&&(t===dA||lA(t.prototype))||hH(t)&&(t=t[pH])===null)&&(t=void 0)),t===void 0?dA:t},uA=function(e,t){return new(mH(e))(t===0?0:t)},_H=v,fH=Ka,EH=qt("species"),hA=function(e){return fH>=51||!_H(function(){var t=[];return(t.constructor={})[EH]=function(){return{foo:1}},t[e](Boolean).foo!==1})},gH=Tt,SH=v,TH=nu,vH=zr,RH=ko,CH=cs,pA=function(e){if(e>9007199254740991)throw dH("Maximum allowed index exceeded");return e},mA=xp,yH=uA,IH=hA,wH=Ka,_A=qt("isConcatSpreadable"),AH=wH>=51||!SH(function(){var e=[];return e[_A]=!1,e.concat()[0]!==e}),OH=function(e){if(!vH(e))return!1;var t=e[_A];return t!==void 0?!!t:TH(e)};gH({target:"Array",proto:!0,arity:1,forced:!AH||!IH("concat")},{concat:function(e){var t,i,r,n,o,a=RH(this),l=yH(a,0),d=0;for(t=-1,r=arguments.length;t<r;t++)if(OH(o=t===-1?a:arguments[t]))for(n=CH(o),pA(d+n),i=0;i<n;i++,d++)i in o&&mA(l,d,o[i]);else pA(d+1),mA(l,d++,o);return l.length=d,l}});var fA={},bH=De,NH=xs,EA=dp.f,DH=Dg,gA=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];fA.f=function(e){return gA&&bH(e)=="Window"?function(t){try{return EA(t)}catch{return DH(gA)}}(e):EA(NH(e))};var hl={},PH=qt;hl.f=PH;var SA=so,kH=Fi,LH=hl,MH=Dn.f,Pi=function(e){var t=SA.Symbol||(SA.Symbol={});kH(t,e)||MH(t,e,{value:LH.f(e)})},UH=Le,xH=Lr,VH=qt,FH=js,TA=function(){var e=xH("Symbol"),t=e&&e.prototype,i=t&&t.valueOf,r=VH("toPrimitive");t&&!t[r]&&FH(t,r,function(n){return UH(i,this)},{arity:1})},jH=Vs,BH=tp,GH=ko,WH=cs,HH=uA,vA=K([].push),Hs=function(e){var t=e==1,i=e==2,r=e==3,n=e==4,o=e==6,a=e==7,l=e==5||o;return function(d,u,p,m){for(var f,E,I=GH(d),T=BH(I),R=jH(u,p),w=WH(T),O=0,P=m||HH,M=t?P(d,w):i||a?P(d,0):void 0;w>O;O++)if((l||O in T)&&(E=R(f=T[O],O,I),e))if(t)M[O]=E;else if(E)switch(e){case 3:return!0;case 5:return f;case 6:return O;case 2:vA(M,f)}else switch(e){case 4:return!1;case 7:vA(M,f)}return o?-1:r||n?n:M}},RA={forEach:Hs(0),map:Hs(1),filter:Hs(2),some:Hs(3),every:Hs(4),find:Hs(5),findIndex:Hs(6),filterReject:Hs(7)},Wp=Tt,Wg=le,Hg=Le,KH=K,pl=dr,ml=Qc,zH=v,tr=Fi,YH=$,Kg=Tr,Hp=xs,zg=rp,qH=hn,Yg=Sr,ou=Kd,CA=hp,JH=dp,yA=fA,XH=Hd,IA=Wa,wA=Dn,QH=IE,AA=lt,OA=js,ZH=Cp,qg=$c,bA=up,NA=nE,$H=qt,e6=hl,t6=Pi,i6=TA,r6=Bs,DA=Ja,Kp=RA.forEach,qr=lp("hidden"),zp="Symbol",su="prototype",n6=DA.set,PA=DA.getterFor(zp),co=Object[su],Za=Wg.Symbol,Yp=Za&&Za[su],o6=Wg.TypeError,Jg=Wg.QObject,kA=IA.f,$a=wA.f,LA=yA.f,s6=AA.f,MA=KH([].push),ls=qg("symbols"),au=qg("op-symbols"),a6=qg("wks"),Xg=!Jg||!Jg[su]||!Jg[su].findChild,Qg=pl&&zH(function(){return ou($a({},"a",{get:function(){return $a(this,"a",{value:7}).a}})).a!=7})?function(e,t,i){var r=kA(co,t);r&&delete co[t],$a(e,t,i),r&&e!==co&&$a(co,t,r)}:$a,Zg=function(e,t){var i=ls[e]=ou(Yp);return n6(i,{type:zp,tag:e,description:t}),pl||(i.description=t),i},qp=function(e,t,i){e===co&&qp(au,t,i),Kg(e);var r=zg(t);return Kg(i),tr(ls,r)?(i.enumerable?(tr(e,qr)&&e[qr][r]&&(e[qr][r]=!1),i=ou(i,{enumerable:Yg(0,!1)})):(tr(e,qr)||$a(e,qr,Yg(1,{})),e[qr][r]=!0),Qg(e,r,i)):$a(e,r,i)},$g=function(e,t){Kg(e);var i=Hp(t),r=CA(i).concat(FA(i));return Kp(r,function(n){pl&&!Hg(UA,i,n)||qp(e,n,i[n])}),e},UA=function(e){var t=zg(e),i=Hg(s6,this,t);return!(this===co&&tr(ls,t)&&!tr(au,t))&&(!(i||!tr(this,t)||!tr(ls,t)||tr(this,qr)&&this[qr][t])||i)},xA=function(e,t){var i=Hp(e),r=zg(t);if(i!==co||!tr(ls,r)||tr(au,r)){var n=kA(i,r);return!n||!tr(ls,r)||tr(i,qr)&&i[qr][r]||(n.enumerable=!0),n}},VA=function(e){var t=LA(Hp(e)),i=[];return Kp(t,function(r){tr(ls,r)||tr(bA,r)||MA(i,r)}),i},FA=function(e){var t=e===co,i=LA(t?au:Hp(e)),r=[];return Kp(i,function(n){!tr(ls,n)||t&&!tr(co,n)||MA(r,ls[n])}),r};ml||(Za=function(){if(YH(Yp,this))throw o6("Symbol is not a constructor");var e=arguments.length&&arguments[0]!==void 0?qH(arguments[0]):void 0,t=NA(e),i=function(r){this===co&&Hg(i,au,r),tr(this,qr)&&tr(this[qr],t)&&(this[qr][t]=!1),Qg(this,t,Yg(1,r))};return pl&&Xg&&Qg(co,t,{configurable:!0,set:i}),Zg(t,e)},OA(Yp=Za[su],"toString",function(){return PA(this).tag}),OA(Za,"withoutSetter",function(e){return Zg(NA(e),e)}),AA.f=UA,wA.f=qp,QH.f=$g,IA.f=xA,JH.f=yA.f=VA,XH.f=FA,e6.f=function(e){return Zg($H(e),e)},pl&&ZH(Yp,"description",{configurable:!0,get:function(){return PA(this).description}})),Wp({global:!0,constructor:!0,wrap:!0,forced:!ml,sham:!ml},{Symbol:Za}),Kp(CA(a6),function(e){t6(e)}),Wp({target:zp,stat:!0,forced:!ml},{useSetter:function(){Xg=!0},useSimple:function(){Xg=!1}}),Wp({target:"Object",stat:!0,forced:!ml,sham:!pl},{create:function(e,t){return t===void 0?ou(e):$g(ou(e),t)},defineProperty:qp,defineProperties:$g,getOwnPropertyDescriptor:xA}),Wp({target:"Object",stat:!0,forced:!ml},{getOwnPropertyNames:VA}),i6(),r6(Za,zp),bA[qr]=!0;var jA=Qc&&!!Symbol.for&&!!Symbol.keyFor,c6=Tt,l6=Lr,d6=Fi,u6=hn,BA=$c,h6=jA,eS=BA("string-to-symbol-registry"),p6=BA("symbol-to-string-registry");c6({target:"Symbol",stat:!0,forced:!h6},{for:function(e){var t=u6(e);if(d6(eS,t))return eS[t];var i=l6("Symbol")(t);return eS[t]=i,p6[i]=t,i}});var m6=Tt,_6=Fi,f6=Bd,E6=Zc,g6=jA,GA=$c("symbol-to-string-registry");m6({target:"Symbol",stat:!0,forced:!g6},{keyFor:function(e){if(!f6(e))throw TypeError(E6(e)+" is not a symbol");if(_6(GA,e))return GA[e]}});var WA=nu,S6=ui,HA=De,T6=hn,KA=K([].push),v6=Tt,zA=Lr,YA=q,R6=Le,cu=K,qA=v,JA=ui,XA=Bd,QA=YE,C6=function(e){if(S6(e))return e;if(WA(e)){for(var t=e.length,i=[],r=0;r<t;r++){var n=e[r];typeof n=="string"?KA(i,n):typeof n!="number"&&HA(n)!="Number"&&HA(n)!="String"||KA(i,T6(n))}var o=i.length,a=!0;return function(l,d){if(a)return a=!1,d;if(WA(this))return d;for(var u=0;u<o;u++)if(i[u]===l)return d}}},y6=Qc,I6=String,Ks=zA("JSON","stringify"),Jp=cu(/./.exec),ZA=cu("".charAt),w6=cu("".charCodeAt),A6=cu("".replace),O6=cu(1 .toString),b6=/[\uD800-\uDFFF]/g,$A=/^[\uD800-\uDBFF]$/,eO=/^[\uDC00-\uDFFF]$/,tO=!y6||qA(function(){var e=zA("Symbol")();return Ks([e])!="[null]"||Ks({a:e})!="{}"||Ks(Object(e))!="{}"}),iO=qA(function(){return Ks("\uDF06\uD834")!=='"\\udf06\\ud834"'||Ks("\uDEAD")!=='"\\udead"'}),N6=function(e,t){var i=QA(arguments),r=C6(t);if(JA(r)||e!==void 0&&!XA(e))return i[1]=function(n,o){if(JA(r)&&(o=R6(r,this,I6(n),o)),!XA(o))return o},YA(Ks,null,i)},D6=function(e,t,i){var r=ZA(i,t-1),n=ZA(i,t+1);return Jp($A,e)&&!Jp(eO,n)||Jp(eO,e)&&!Jp($A,r)?"\\u"+O6(w6(e,0),16):e};Ks&&v6({target:"JSON",stat:!0,arity:3,forced:tO||iO},{stringify:function(e,t,i){var r=QA(arguments),n=YA(tO?N6:Ks,null,r);return iO&&typeof n=="string"?A6(n,b6,D6):n}});var rO=Hd,P6=ko;Tt({target:"Object",stat:!0,forced:!Qc||v(function(){rO.f(1)})},{getOwnPropertySymbols:function(e){var t=rO.f;return t?t(P6(e)):[]}}),Pi("asyncIterator"),Pi("hasInstance"),Pi("isConcatSpreadable"),Pi("iterator"),Pi("match"),Pi("matchAll"),Pi("replace"),Pi("search"),Pi("species"),Pi("split");var k6=TA;Pi("toPrimitive"),k6();var L6=Lr,M6=Bs;Pi("toStringTag"),M6(L6("Symbol"),"Symbol"),Pi("unscopables"),Bs(le.JSON,"JSON",!0);var U6=so.Symbol,x6=qt,V6=Dn.f,nO=x6("metadata"),oO=Function.prototype;oO[nO]===void 0&&V6(oO,nO,{value:null}),Pi("dispose"),Pi("metadata");var F6=U6;Pi("asyncDispose");var j6=K,tS=Lr("Symbol"),B6=tS.keyFor,G6=j6(tS.prototype.valueOf),sO=tS.isRegisteredSymbol||function(e){try{return B6(G6(e))!==void 0}catch{return!1}};Tt({target:"Symbol",stat:!0},{isRegisteredSymbol:sO});for(var W6=$c,aO=Lr,H6=K,K6=Bd,z6=qt,Xp=aO("Symbol"),cO=Xp.isWellKnownSymbol,lO=aO("Object","getOwnPropertyNames"),Y6=H6(Xp.prototype.valueOf),dO=W6("wks"),iS=0,uO=lO(Xp),q6=uO.length;iS<q6;iS++)try{var hO=uO[iS];K6(Xp[hO])&&z6(hO)}catch{}var pO=function(e){if(cO&&cO(e))return!0;try{for(var t=Y6(e),i=0,r=lO(dO),n=r.length;i<n;i++)if(dO[r[i]]==t)return!0}catch{}return!1};Tt({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:pO}),Pi("matcher"),Pi("observable"),Tt({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:sO}),Tt({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:pO}),Pi("metadataKey"),Pi("patternMatch"),Pi("replaceAll");var _l=g(F6),mO=g(hl.f("iterator"));function lu(e){return lu=typeof _l=="function"&&typeof mO=="symbol"?function(t){return typeof t}:function(t){return t&&typeof _l=="function"&&t.constructor===_l&&t!==_l.prototype?"symbol":typeof t},lu(e)}var J6=g(hl.f("toPrimitive"));function X6(e){var t=function(i,r){if(lu(i)!=="object"||i===null)return i;var n=i[J6];if(n!==void 0){var o=n.call(i,r||"default");if(lu(o)!=="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(r==="string"?String:Number)(i)}(e,"string");return lu(t)==="symbol"?t:String(t)}function y(e,t,i){return(t=X6(t))in e?cA(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Q6=v,Z6=qt("iterator"),rS=!Q6(function(){var e=new URL("b?a=1&b=2&c=3","http://a"),t=e.searchParams,i=new URLSearchParams("a=1&a=2"),r="";return e.pathname="c%20d",t.forEach(function(n,o){t.delete("b"),r+=o+n}),i.delete("a",2),!e.toJSON||!i.has("a",1)||i.has("a",2)||!t.size&&!0||!t.sort||e.href!=="http://a/c%20d?a=1&c=3"||t.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!t[Z6]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("http://тест").host!=="xn--e1aybc"||new URL("http://a#б").hash!=="#%D0%B1"||r!=="a1c3"||new URL("http://x",void 0).host!=="x"}),$6=js,nS=Tt,fl=le,Qp=Le,Vo=K,El=dr,_O=rS,fO=js,eK=Cp,tK=function(e,t,i){for(var r in t)i&&i.unsafe&&e[r]?e[r]=t[r]:$6(e,r,t[r],i);return e},iK=Bs,rK=FE,oS=Ja,EO=GE,sS=ui,nK=Fi,oK=Vs,sK=Lo,aK=Tr,gO=zr,Mr=hn,cK=Kd,SO=Sr,aS=bE,lK=_p,gl=Ip,dK=Ow,uK=qt("iterator"),du="URLSearchParams",TO=du+"Iterator",vO=oS.set,Ln=oS.getterFor(du),hK=oS.getterFor(TO),pK=Object.getOwnPropertyDescriptor,cS=function(e){if(!El)return fl[e];var t=pK(fl,e);return t&&t.value},RO=cS("fetch"),Zp=cS("Request"),uu=cS("Headers"),lS=Zp&&Zp.prototype,CO=uu&&uu.prototype,mK=fl.RegExp,_K=fl.TypeError,yO=fl.decodeURIComponent,fK=fl.encodeURIComponent,EK=Vo("".charAt),IO=Vo([].join),ec=Vo([].push),dS=Vo("".replace),gK=Vo([].shift),wO=Vo([].splice),AO=Vo("".split),SK=Vo("".slice),TK=/\+/g,OO=Array(4),vK=function(e){return OO[e-1]||(OO[e-1]=mK("((?:%[\\da-f]{2}){"+e+"})","gi"))},RK=function(e){try{return yO(e)}catch{return e}},bO=function(e){var t=dS(e,TK," "),i=4;try{return yO(t)}catch{for(;i;)t=dS(t,vK(i--),RK);return t}},CK=/[!'()~]|%20/g,yK={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},IK=function(e){return yK[e]},NO=function(e){return dS(fK(e),CK,IK)},uS=rK(function(e,t){vO(this,{type:TO,iterator:aS(Ln(e).entries),kind:t})},"Iterator",function(){var e=hK(this),t=e.kind,i=e.iterator.next(),r=i.value;return i.done||(i.value=t==="keys"?r.key:t==="values"?r.value:[r.key,r.value]),i},!0),DO=function(e){this.entries=[],this.url=null,e!==void 0&&(gO(e)?this.parseObject(e):this.parseQuery(typeof e=="string"?EK(e,0)==="?"?SK(e,1):e:Mr(e)))};DO.prototype={type:du,bindURL:function(e){this.url=e,this.update()},parseObject:function(e){var t,i,r,n,o,a,l,d=lK(e);if(d)for(i=(t=aS(e,d)).next;!(r=Qp(i,t)).done;){if(o=(n=aS(aK(r.value))).next,(a=Qp(o,n)).done||(l=Qp(o,n)).done||!Qp(o,n).done)throw _K("Expected sequence with length 2");ec(this.entries,{key:Mr(a.value),value:Mr(l.value)})}else for(var u in e)nK(e,u)&&ec(this.entries,{key:u,value:Mr(e[u])})},parseQuery:function(e){if(e)for(var t,i,r=AO(e,"&"),n=0;n<r.length;)(t=r[n++]).length&&(i=AO(t,"="),ec(this.entries,{key:bO(gK(i)),value:bO(IO(i,"="))}))},serialize:function(){for(var e,t=this.entries,i=[],r=0;r<t.length;)e=t[r++],ec(i,NO(e.key)+"="+NO(e.value));return IO(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var $p=function(){EO(this,Sl);var e=vO(this,new DO(arguments.length>0?arguments[0]:void 0));El||(this.size=e.entries.length)},Sl=$p.prototype;if(tK(Sl,{append:function(e,t){var i=Ln(this);gl(arguments.length,2),ec(i.entries,{key:Mr(e),value:Mr(t)}),El||this.length++,i.updateURL()},delete:function(e){for(var t=Ln(this),i=gl(arguments.length,1),r=t.entries,n=Mr(e),o=i<2?void 0:arguments[1],a=o===void 0?o:Mr(o),l=0;l<r.length;){var d=r[l];if(d.key!==n||a!==void 0&&d.value!==a)l++;else if(wO(r,l,1),a!==void 0)break}El||(this.size=r.length),t.updateURL()},get:function(e){var t=Ln(this).entries;gl(arguments.length,1);for(var i=Mr(e),r=0;r<t.length;r++)if(t[r].key===i)return t[r].value;return null},getAll:function(e){var t=Ln(this).entries;gl(arguments.length,1);for(var i=Mr(e),r=[],n=0;n<t.length;n++)t[n].key===i&&ec(r,t[n].value);return r},has:function(e){for(var t=Ln(this).entries,i=gl(arguments.length,1),r=Mr(e),n=i<2?void 0:arguments[1],o=n===void 0?n:Mr(n),a=0;a<t.length;){var l=t[a++];if(l.key===r&&(o===void 0||l.value===o))return!0}return!1},set:function(e,t){var i=Ln(this);gl(arguments.length,1);for(var r,n=i.entries,o=!1,a=Mr(e),l=Mr(t),d=0;d<n.length;d++)(r=n[d]).key===a&&(o?wO(n,d--,1):(o=!0,r.value=l));o||ec(n,{key:a,value:l}),El||(this.size=n.length),i.updateURL()},sort:function(){var e=Ln(this);dK(e.entries,function(t,i){return t.key>i.key?1:-1}),e.updateURL()},forEach:function(e){for(var t,i=Ln(this).entries,r=oK(e,arguments.length>1?arguments[1]:void 0),n=0;n<i.length;)r((t=i[n++]).value,t.key,this)},keys:function(){return new uS(this,"keys")},values:function(){return new uS(this,"values")},entries:function(){return new uS(this,"entries")}},{enumerable:!0}),fO(Sl,uK,Sl.entries,{name:"entries"}),fO(Sl,"toString",function(){return Ln(this).serialize()},{enumerable:!0}),El&&eK(Sl,"size",{get:function(){return Ln(this).entries.length},configurable:!0,enumerable:!0}),iK($p,du),nS({global:!0,constructor:!0,forced:!_O},{URLSearchParams:$p}),!_O&&sS(uu)){var wK=Vo(CO.has),AK=Vo(CO.set),PO=function(e){if(gO(e)){var t,i=e.body;if(sK(i)===du)return t=e.headers?new uu(e.headers):new uu,wK(t,"content-type")||AK(t,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),cK(e,{body:SO(0,Mr(i)),headers:SO(0,t)})}return e};if(sS(RO)&&nS({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(e){return RO(e,arguments.length>1?PO(arguments[1]):{})}}),sS(Zp)){var hS=function(e){return EO(this,lS),new Zp(e,arguments.length>1?PO(arguments[1]):{})};lS.constructor=hS,hS.prototype=lS,nS({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:hS})}}var OK={URLSearchParams:$p,getState:Ln},kO=g(so.URLSearchParams),bK={isBrowser:!0,classes:{URLSearchParams:kO!==void 0?kO:Gg,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};let LO=typeof window<"u"&&typeof document<"u",NK=(MO=typeof navigator<"u"&&navigator.product,LO&&["ReactNative","NativeScript","NS"].indexOf(MO)<0);var MO;let DK=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function";function UO(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function xO(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?UO(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):UO(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}var Fo=xO(xO({},Object.freeze({__proto__:null,hasBrowserEnv:LO,hasStandardBrowserEnv:NK,hasStandardBrowserWebWorkerEnv:DK})),bK),PK=Tr,kK=Le,LK=Fi,MK=$,UK=function(){var e=PK(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t},VO=RegExp.prototype,FO=function(e){var t=e.flags;return t!==void 0||"flags"in VO||LK(e,"flags")||!MK(VO,e)?t:kK(UK,e)},xK=Sg.charAt,jO=Le,VK=Tr,FK=ui,jK=De,BK=/./.exec,GK=TypeError,WK=Tt,BO=Le,GO=pt,HK=FE,em=BE,WO=Xc,HO=Uy,hu=hn,KK=Tr,zK=Jc,YK=De,qK=Vy,KO=FO,JK=ip,XK=v,QK=zE,ZK=function(e,t,i){return t+(i?xK(e,t).length:1)},$K=function(e,t){var i=e.exec;if(FK(i)){var r=jO(i,e,t);return r!==null&&VK(r),r}if(jK(e)==="RegExp")return jO(BK,e,t);throw GK("RegExp#exec called on incompatible receiver")},zO=Ja,e8=qt("matchAll"),YO="RegExp String",qO=YO+" Iterator",t8=zO.set,i8=zO.getterFor(qO),r8=TypeError,pS=GO("".indexOf),tm=GO("".matchAll),mS=!!tm&&!XK(function(){tm("a",/./)}),n8=HK(function(e,t,i,r){t8(this,{type:qO,regexp:e,string:t,global:i,unicode:r,done:!1})},YO,function(){var e=i8(this);if(e.done)return em(void 0,!0);var t=e.regexp,i=e.string,r=$K(t,i);return r===null?(e.done=!0,em(void 0,!0)):e.global?(hu(r[0])===""&&(t.lastIndex=ZK(i,HO(t.lastIndex),e.unicode)),em(r,!1)):(e.done=!0,em(r,!1))}),JO=function(e){var t,i,r,n=KK(this),o=hu(e),a=QK(n,RegExp),l=hu(KO(n));return t=new a(a===RegExp?n.source:n,l),i=!!~pS(l,"g"),r=!!~pS(l,"u"),t.lastIndex=HO(n.lastIndex),new n8(t,o,i,r)};WK({target:"String",proto:!0,forced:mS},{matchAll:function(e){var t,i,r,n,o=WO(this);if(zK(e)){if(mS)return tm(o,e)}else{if(qK(e)&&(t=hu(WO(KO(e))),!~pS(t,"g")))throw r8("`.matchAll` does not allow non-global regexes");if(mS)return tm(o,e);if((r=JK(e,e8))===void 0&&YK(e)=="RegExp"&&(r=JO),r)return BO(r,e,o)}return i=hu(o),n=new RegExp(e,"g"),BO(JO,n,i)}});var o8=Pn("String").matchAll,s8=$,a8=o8,_S=String.prototype,c8=function(e){var t=e.matchAll;return typeof e=="string"||e===_S||s8(_S,e)&&t===_S.matchAll?a8:t},l8=g(c8);function XO(e){function t(i,r,n,o){let a=i[o++];if(a==="__proto__")return!0;let l=Number.isFinite(+a),d=o>=i.length;return a=!a&&ue.isArray(n)?n.length:a,d?(ue.hasOwnProp(n,a)?n[a]=[n[a],r]:n[a]=r,!l):(n[a]&&ue.isObject(n[a])||(n[a]=[]),t(i,r,n[a],o)&&ue.isArray(n[a])&&(n[a]=function(u){let p={},m=Object.keys(u),f,E=m.length,I;for(f=0;f<E;f++)I=m[f],p[I]=u[I];return p}(n[a])),!l)}if(ue.isFormData(e)&&ue.isFunction(e.entries)){let i={};return ue.forEachEntry(e,(r,n)=>{t(function(o){return l8(ue).call(ue,/\w+|\[(\w*)]/g,o).map(a=>a[0]==="[]"?"":a[1]||a[0])}(r),n,i,0)}),i}return null}let fS={transitional:nA,adapter:["xhr","http"],transformRequest:[function(e,t){let i=t.getContentType()||"",r=i.indexOf("application/json")>-1,n=ue.isObject(e);if(n&&ue.isHTMLForm(e)&&(e=new FormData(e)),ue.isFormData(e))return r?JSON.stringify(XO(e)):e;if(ue.isArrayBuffer(e)||ue.isBuffer(e)||ue.isStream(e)||ue.isFile(e)||ue.isBlob(e))return e;if(ue.isArrayBufferView(e))return e.buffer;if(ue.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let o;if(n){if(i.indexOf("application/x-www-form-urlencoded")>-1)return function(a,l){return Gp(a,new Fo.classes.URLSearchParams,Object.assign({visitor:function(d,u,p,m){return Fo.isNode&&ue.isBuffer(d)?(this.append(u,d.toString("base64")),!1):m.defaultVisitor.apply(this,arguments)}},l))}(e,this.formSerializer).toString();if((o=ue.isFileList(e))||i.indexOf("multipart/form-data")>-1){let a=this.env&&this.env.FormData;return Gp(o?{"files[]":e}:e,a&&new a,this.formSerializer)}}return n||r?(t.setContentType("application/json",!1),function(a,l,d){if(ue.isString(a))try{return(l||JSON.parse)(a),qi(ue).call(ue,a)}catch(u){if(u.name!=="SyntaxError")throw u}return(0,JSON.stringify)(a)}(e)):e}],transformResponse:[function(e){let t=this.transitional||fS.transitional,i=t&&t.forcedJSONParsing,r=this.responseType==="json";if(e&&ue.isString(e)&&(i&&!this.responseType||r)){let n=!(t&&t.silentJSONParsing)&&r;try{return JSON.parse(e)}catch(o){if(n)throw o.name==="SyntaxError"?Pt.from(o,Pt.ERR_BAD_RESPONSE,this,null,this.response):o}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Fo.classes.FormData,Blob:Fo.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};ue.forEach(["delete","get","head","post","put","patch"],e=>{fS.headers[e]={}});var ES=fS;let d8=ue.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),QO=Symbol("internals");function pu(e){var t;return e&&qi(t=String(e)).call(t).toLowerCase()}function im(e){return e===!1||e==null?e:ue.isArray(e)?e.map(im):String(e)}function gS(e,t,i,r,n){return ue.isFunction(r)?r.call(this,t,i):(n&&(t=i),ue.isString(t)?ue.isString(r)?t.indexOf(r)!==-1:ue.isRegExp(r)?r.test(t):void 0:void 0)}class rm{constructor(t){t&&this.set(t)}set(t,i,r){let n=this;function o(d,u,p){let m=pu(u);if(!m)throw new Error("header name must be a non-empty string");let f=ue.findKey(n,m);(!f||n[f]===void 0||p===!0||p===void 0&&n[f]!==!1)&&(n[f||u]=im(d))}let a=(d,u)=>ue.forEach(d,(p,m)=>o(p,m,u));var l;return ue.isPlainObject(t)||t instanceof this.constructor?a(t,i):ue.isString(t)&&(t=qi(t).call(t))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(qi(l=t).call(l))?a((d=>{let u={},p,m,f;return d&&d.split(`
`).forEach(function(E){var I,T;f=E.indexOf(":"),p=qi(I=E.substring(0,f)).call(I).toLowerCase(),m=qi(T=E.substring(f+1)).call(T),!p||u[p]&&d8[p]||(p==="set-cookie"?u[p]?u[p].push(m):u[p]=[m]:u[p]=u[p]?u[p]+", "+m:m)}),u})(t),i):t!=null&&o(i,t,r),this}get(t,i){if(t=pu(t)){let r=ue.findKey(this,t);if(r){let n=this[r];if(!i)return n;if(i===!0)return function(o){let a=Object.create(null),l=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g,d;for(;d=l.exec(o);)a[d[1]]=d[2];return a}(n);if(ue.isFunction(i))return i.call(this,n,r);if(ue.isRegExp(i))return i.exec(n);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,i){if(t=pu(t)){let r=ue.findKey(this,t);return!(!r||this[r]===void 0||i&&!gS(0,this[r],r,i))}return!1}delete(t,i){let r=this,n=!1;function o(a){if(a=pu(a)){let l=ue.findKey(r,a);!l||i&&!gS(0,r[l],l,i)||(delete r[l],n=!0)}}return ue.isArray(t)?t.forEach(o):o(t),n}clear(t){let i=Object.keys(this),r=i.length,n=!1;for(;r--;){let o=i[r];t&&!gS(0,this[o],o,t,!0)||(delete this[o],n=!0)}return n}normalize(t){let i=this,r={};return ue.forEach(this,(n,o)=>{var a;let l=ue.findKey(r,o);if(l)return i[l]=im(n),void delete i[o];let d=t?function(u){return qi(u).call(u).toLowerCase().replace(/([a-z\d])(\w*)/g,(p,m,f)=>m.toUpperCase()+f)}(o):qi(a=String(o)).call(a);d!==o&&delete i[o],i[d]=im(n),r[d]=!0}),this}concat(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];return this.constructor.concat(this,...i)}toJSON(t){let i=Object.create(null);return ue.forEach(this,(r,n)=>{r!=null&&r!==!1&&(i[n]=t&&ue.isArray(r)?r.join(", "):r)}),i}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(t=>{let[i,r]=t;return i+": "+r}).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t){let i=new this(t);for(var r=arguments.length,n=new Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];return n.forEach(a=>i.set(a)),i}static accessor(t){let i=(this[QO]=this[QO]={accessors:{}}).accessors,r=this.prototype;function n(o){let a=pu(o);i[a]||(function(l,d){let u=ue.toCamelCase(" "+d);["get","set","has"].forEach(p=>{Object.defineProperty(l,p+u,{value:function(m,f,E){return this[p].call(this,d,m,f,E)},configurable:!0})})}(r,o),i[a]=!0)}return ue.isArray(t)?t.forEach(n):n(t),this}}rm.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),ue.reduceDescriptors(rm.prototype,(e,t)=>{let{value:i}=e,r=t[0].toUpperCase()+t.slice(1);return{get:()=>i,set(n){this[r]=n}}}),ue.freezeMethods(rm);var ds=rm;function SS(e,t){let i=this||ES,r=t||i,n=ds.from(r.headers),o=r.data;return ue.forEach(e,function(a){o=a.call(i,o,n.normalize(),t?t.status:void 0)}),n.normalize(),o}function ZO(e){return!(!e||!e.__CANCEL__)}function mu(e,t,i){Pt.call(this,e??"canceled",Pt.ERR_CANCELED,t,i),this.name="CanceledError"}ue.inherits(mu,Pt,{__CANCEL__:!0});var u8=Fo.hasStandardBrowserEnv?{write(e,t,i,r,n,o){let a=[e+"="+encodeURIComponent(t)];ue.isNumber(i)&&a.push("expires="+new Date(i).toGMTString()),ue.isString(r)&&a.push("path="+r),ue.isString(n)&&a.push("domain="+n),o===!0&&a.push("secure"),document.cookie=a.join("; ")},read(e){let t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function $O(e,t){return e&&!function(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)}(t)?function(i,r){return r?i.replace(/\/?\/$/,"")+"/"+r.replace(/^\/+/,""):i}(e,t):t}var h8=Fo.hasStandardBrowserEnv?function(){let e=/(msie|trident)/i.test(navigator.userAgent),t=document.createElement("a"),i;function r(n){let o=n;return e&&(t.setAttribute("href",o),o=t.href),t.setAttribute("href",o),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:t.pathname.charAt(0)==="/"?t.pathname:"/"+t.pathname}}return i=r(window.location.href),function(n){let o=ue.isString(n)?r(n):n;return o.protocol===i.protocol&&o.host===i.host}}():function(){return!0};function eb(e,t){let i=0,r=function(n,o){n=n||10;let a=new Array(n),l=new Array(n),d,u=0,p=0;return o=o!==void 0?o:1e3,function(m){let f=Date.now(),E=l[p];d||(d=f),a[u]=m,l[u]=f;let I=p,T=0;for(;I!==u;)T+=a[I++],I%=n;if(u=(u+1)%n,u===p&&(p=(p+1)%n),f-d<o)return;let R=E&&f-E;return R?Math.round(1e3*T/R):void 0}}(50,250);return n=>{let o=n.loaded,a=n.lengthComputable?n.total:void 0,l=o-i,d=r(l);i=o;let u={loaded:o,total:a,progress:a?o/a:void 0,bytes:l,rate:d||void 0,estimated:d&&a&&o<=a?(a-o)/d:void 0,event:n};u[t?"download":"upload"]=!0,e(u)}}var p8=typeof XMLHttpRequest<"u"&&function(e){return new ne(function(t,i){let r=e.data,n=ds.from(e.headers).normalize(),o,a,{responseType:l,withXSRFToken:d}=e;function u(){e.cancelToken&&e.cancelToken.unsubscribe(o),e.signal&&e.signal.removeEventListener("abort",o)}if(ue.isFormData(r)){if(Fo.hasStandardBrowserEnv||Fo.hasStandardBrowserWebWorkerEnv)n.setContentType(!1);else if((a=n.getContentType())!==!1){let[I,...T]=a?a.split(";").map(R=>qi(R).call(R)).filter(Boolean):[];n.setContentType([I||"multipart/form-data",...T].join("; "))}}let p=new XMLHttpRequest;if(e.auth){let I=e.auth.username||"",T=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";n.set("Authorization","Basic "+btoa(I+":"+T))}let m=$O(e.baseURL,e.url);function f(){if(!p)return;let I=ds.from("getAllResponseHeaders"in p&&p.getAllResponseHeaders());(function(T,R,w){let O=w.config.validateStatus;w.status&&O&&!O(w.status)?R(new Pt("Request failed with status code "+w.status,[Pt.ERR_BAD_REQUEST,Pt.ERR_BAD_RESPONSE][Math.floor(w.status/100)-4],w.config,w.request,w)):T(w)})(function(T){t(T),u()},function(T){i(T),u()},{data:l&&l!=="text"&&l!=="json"?p.response:p.responseText,status:p.status,statusText:p.statusText,headers:I,config:e,request:p}),p=null}if(p.open(e.method.toUpperCase(),iA(m,e.params,e.paramsSerializer),!0),p.timeout=e.timeout,"onloadend"in p?p.onloadend=f:p.onreadystatechange=function(){p&&p.readyState===4&&(p.status!==0||p.responseURL&&p.responseURL.indexOf("file:")===0)&&setTimeout(f)},p.onabort=function(){p&&(i(new Pt("Request aborted",Pt.ECONNABORTED,e,p)),p=null)},p.onerror=function(){i(new Pt("Network Error",Pt.ERR_NETWORK,e,p)),p=null},p.ontimeout=function(){let I=e.timeout?"timeout of "+e.timeout+"ms exceeded":"timeout exceeded",T=e.transitional||nA;e.timeoutErrorMessage&&(I=e.timeoutErrorMessage),i(new Pt(I,T.clarifyTimeoutError?Pt.ETIMEDOUT:Pt.ECONNABORTED,e,p)),p=null},Fo.hasStandardBrowserEnv&&(d&&ue.isFunction(d)&&(d=d(e)),d||d!==!1&&h8(m))){let I=e.xsrfHeaderName&&e.xsrfCookieName&&u8.read(e.xsrfCookieName);I&&n.set(e.xsrfHeaderName,I)}r===void 0&&n.setContentType(null),"setRequestHeader"in p&&ue.forEach(n.toJSON(),function(I,T){p.setRequestHeader(T,I)}),ue.isUndefined(e.withCredentials)||(p.withCredentials=!!e.withCredentials),l&&l!=="json"&&(p.responseType=e.responseType),typeof e.onDownloadProgress=="function"&&p.addEventListener("progress",eb(e.onDownloadProgress,!0)),typeof e.onUploadProgress=="function"&&p.upload&&p.upload.addEventListener("progress",eb(e.onUploadProgress)),(e.cancelToken||e.signal)&&(o=I=>{p&&(i(!I||I.type?new mu(null,e,p):I),p.abort(),p=null)},e.cancelToken&&e.cancelToken.subscribe(o),e.signal&&(e.signal.aborted?o():e.signal.addEventListener("abort",o)));let E=function(I){let T=/^([-+\w]{1,25})(:?\/\/|:)/.exec(I);return T&&T[1]||""}(m);E&&Fo.protocols.indexOf(E)===-1?i(new Pt("Unsupported protocol "+E+":",Pt.ERR_BAD_REQUEST,e)):p.send(r||null)})};let TS={http:null,xhr:p8};ue.forEach(TS,(e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}});let tb=e=>"- ".concat(e),m8=e=>ue.isFunction(e)||e===null||e===!1;var ib={getAdapter:e=>{e=ue.isArray(e)?e:[e];let{length:t}=e,i,r,n={};for(let o=0;o<t;o++){let a;if(i=e[o],r=i,!m8(i)&&(r=TS[(a=String(i)).toLowerCase()],r===void 0))throw new Pt("Unknown adapter '".concat(a,"'"));if(r)break;n[a||"#"+o]=r}if(!r){let o=Object.entries(n).map(a=>{let[l,d]=a;return"adapter ".concat(l," ")+(d===!1?"is not supported by the environment":"is not available in the build")});throw new Pt("There is no suitable adapter to dispatch the request "+(t?o.length>1?`since :
`+o.map(tb).join(`
`):" "+tb(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return r},adapters:TS};function vS(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new mu(null,e)}function rb(e){return vS(e),e.headers=ds.from(e.headers),e.data=SS.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),ib.getAdapter(e.adapter||ES.adapter)(e).then(function(t){return vS(e),t.data=SS.call(e,e.transformResponse,t),t.headers=ds.from(t.headers),t},function(t){return ZO(t)||(vS(e),t&&t.response&&(t.response.data=SS.call(e,e.transformResponse,t.response),t.response.headers=ds.from(t.response.headers))),ne.reject(t)})}function nb(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}let ob=e=>e instanceof ds?function(t){for(var i=1;i<arguments.length;i++){var r=arguments[i]!=null?arguments[i]:{};i%2?nb(Object(r),!0).forEach(function(n){y(t,n,r[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):nb(Object(r)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(r,n))})}return t}({},e):e;function Tl(e,t){t=t||{};let i={};function r(u,p,m){return ue.isPlainObject(u)&&ue.isPlainObject(p)?ue.merge.call({caseless:m},u,p):ue.isPlainObject(p)?ue.merge({},p):ue.isArray(p)?p.slice():p}function n(u,p,m){return ue.isUndefined(p)?ue.isUndefined(u)?void 0:r(void 0,u,m):r(u,p,m)}function o(u,p){if(!ue.isUndefined(p))return r(void 0,p)}function a(u,p){return ue.isUndefined(p)?ue.isUndefined(u)?void 0:r(void 0,u):r(void 0,p)}function l(u,p,m){return m in t?r(u,p):m in e?r(void 0,u):void 0}let d={url:o,method:o,data:o,baseURL:a,transformRequest:a,transformResponse:a,paramsSerializer:a,timeout:a,timeoutMessage:a,withCredentials:a,withXSRFToken:a,adapter:a,responseType:a,xsrfCookieName:a,xsrfHeaderName:a,onUploadProgress:a,onDownloadProgress:a,decompress:a,maxContentLength:a,maxBodyLength:a,beforeRedirect:a,transport:a,httpAgent:a,httpsAgent:a,cancelToken:a,socketPath:a,responseEncoding:a,validateStatus:l,headers:(u,p)=>n(ob(u),ob(p),!0)};return ue.forEach(Object.keys(Object.assign({},e,t)),function(u){let p=d[u]||n,m=p(e[u],t[u],u);ue.isUndefined(m)&&p!==l||(i[u]=m)}),i}let sb="1.6.8",RS={};["object","boolean","number","function","string","symbol"].forEach((e,t)=>{RS[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}});let ab={};RS.transitional=function(e,t,i){function r(n,o){return"[Axios v"+sb+"] Transitional option '"+n+"'"+o+(i?". "+i:"")}return(n,o,a)=>{if(e===!1)throw new Pt(r(o," has been removed"+(t?" in "+t:"")),Pt.ERR_DEPRECATED);return t&&!ab[o]&&(ab[o]=!0,console.warn(r(o," has been deprecated since v"+t+" and will be removed in the near future"))),!e||e(n,o,a)}};var CS={assertOptions:function(e,t,i){if(typeof e!="object")throw new Pt("options must be an object",Pt.ERR_BAD_OPTION_VALUE);let r=Object.keys(e),n=r.length;for(;n-- >0;){let o=r[n],a=t[o];if(a){let l=e[o],d=l===void 0||a(l,o,e);if(d!==!0)throw new Pt("option "+o+" must be "+d,Pt.ERR_BAD_OPTION_VALUE)}else if(i!==!0)throw new Pt("Unknown option "+o,Pt.ERR_BAD_OPTION)}},validators:RS};let zs=CS.validators,nm=class{constructor(e){this.defaults=e,this.interceptors={request:new rA,response:new rA}}async request(e,t){try{return await this._request(e,t)}catch(i){if(i instanceof Error){let r;Error.captureStackTrace?Error.captureStackTrace(r={}):r=new Error;let n=r.stack?r.stack.replace(/^.+\n/,""):"";i.stack?n&&!String(i.stack).endsWith(n.replace(/^.+\n.+\n/,""))&&(i.stack+=`
`+n):i.stack=n}throw i}}_request(e,t){typeof e=="string"?(t=t||{}).url=e:t=e||{},t=Tl(this.defaults,t);let{transitional:i,paramsSerializer:r,headers:n}=t;i!==void 0&&CS.assertOptions(i,{silentJSONParsing:zs.transitional(zs.boolean),forcedJSONParsing:zs.transitional(zs.boolean),clarifyTimeoutError:zs.transitional(zs.boolean)},!1),r!=null&&(ue.isFunction(r)?t.paramsSerializer={serialize:r}:CS.assertOptions(r,{encode:zs.function,serialize:zs.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let o=n&&ue.merge(n.common,n[t.method]);n&&ue.forEach(["delete","get","head","post","put","patch","common"],E=>{delete n[E]}),t.headers=ds.concat(o,n);let a=[],l=!0;this.interceptors.request.forEach(function(E){typeof E.runWhen=="function"&&E.runWhen(t)===!1||(l=l&&E.synchronous,a.unshift(E.fulfilled,E.rejected))});let d=[],u;this.interceptors.response.forEach(function(E){d.push(E.fulfilled,E.rejected)});let p,m=0;if(!l){let E=[rb.bind(this),void 0];for(E.unshift.apply(E,a),E.push.apply(E,d),p=E.length,u=ne.resolve(t);m<p;)u=u.then(E[m++],E[m++]);return u}p=a.length;let f=t;for(m=0;m<p;){let E=a[m++],I=a[m++];try{f=E(f)}catch(T){I.call(this,T);break}}try{u=rb.call(this,f)}catch(E){return ne.reject(E)}for(m=0,p=d.length;m<p;)u=u.then(d[m++],d[m++]);return u}getUri(e){return iA($O((e=Tl(this.defaults,e)).baseURL,e.url),e.params,e.paramsSerializer)}};ue.forEach(["delete","get","head","options"],function(e){nm.prototype[e]=function(t,i){return this.request(Tl(i||{},{method:e,url:t,data:(i||{}).data}))}}),ue.forEach(["post","put","patch"],function(e){function t(i){return function(r,n,o){return this.request(Tl(o||{},{method:e,headers:i?{"Content-Type":"multipart/form-data"}:{},url:r,data:n}))}}nm.prototype[e]=t(),nm.prototype[e+"Form"]=t(!0)});var om=nm;class yS{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let i;this.promise=new ne(function(n){i=n});let r=this;this.promise.then(n=>{if(!r._listeners)return;let o=r._listeners.length;for(;o-- >0;)r._listeners[o](n);r._listeners=null}),this.promise.then=n=>{let o,a=new ne(l=>{r.subscribe(l),o=l}).then(n);return a.cancel=function(){r.unsubscribe(o)},a},t(function(n,o,a){r.reason||(r.reason=new mu(n,o,a),i(r.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){this.reason?t(this.reason):this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;let i=this._listeners.indexOf(t);i!==-1&&this._listeners.splice(i,1)}static source(){let t;return{token:new yS(function(i){t=i}),cancel:t}}}var _8=yS;let IS={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(IS).forEach(e=>{let[t,i]=e;IS[i]=t});var f8=IS;let Hi=function e(t){let i=new om(t),r=jw(om.prototype.request,i);return ue.extend(r,om.prototype,i,{allOwnKeys:!0}),ue.extend(r,i,null,{allOwnKeys:!0}),r.create=function(n){return e(Tl(t,n))},r}(ES);Hi.Axios=om,Hi.CanceledError=mu,Hi.CancelToken=_8,Hi.isCancel=ZO,Hi.VERSION=sb,Hi.toFormData=Gp,Hi.AxiosError=Pt,Hi.Cancel=Hi.CanceledError,Hi.all=function(e){return ne.all(e)},Hi.spread=function(e){return function(t){return e.apply(null,t)}},Hi.isAxiosError=function(e){return ue.isObject(e)&&e.isAxiosError===!0},Hi.mergeConfig=Tl,Hi.AxiosHeaders=ds,Hi.formToJSON=e=>XO(ue.isHTMLForm(e)?new FormData(e):e),Hi.getAdapter=ib.getAdapter,Hi.HttpStatusCode=f8,Hi.default=Hi;var ur=Hi;let E8=()=>{};function _u(){let e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:E8};return e.promise=new ne((t,i)=>{e.resolve=r=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(r),e.value=r)},e.reject=r=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,i(r))}}),e}let sm=new Map,am=new Map,jo=new Map,hi=function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e}({}),nt=function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e}({}),cb=new V5,lo=cb.getResult(),wS=null;function Xe(e){if(!wS){lo=cb.getResult();let t=function(l){if(l.engine.name==="Blink"&&l.browser.name!=="WeChat")return nt.CHROME;switch(l.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return nt.CHROME;case"Safari":case"Mobile Safari":return nt.SAFARI;case"Edge":return nt.EDGE;case"Firefox":return nt.FIREFOX;case"QQ":case"QQBrowser":return nt.QQ;case"Opera":return nt.OPERA;case"WeChat":return nt.WECHAT;default:return l.browser.name||""}}(lo),i=lb(lo),r=function(l){return l.os.name==="Windows"?l.os.version?l.os.name+" "+l.os.version:l.os.name:l.os.name||""}(lo),n=lo.os.version,o=lb(lo,!1),a=lo.device.type;if(!(t&&i&&r&&n))return{name:t,version:i,os:r,osVersion:n,browserVersion:o,deviceType:a};wS={name:t,version:i,os:r,osVersion:n,browserVersion:o,deviceType:a}}return wS}function lb(e){let t,i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return t=e.engine.name==="Blink"?e.engine.version||"":e.browser.version||"",i?t.split(".")[0]:t}function cm(){return Xe().os}function db(){let e=Xe();return"".concat(e.os," ").concat(e.osVersion)}function lm(){let e=Xe();return!!(lo.engine.name==="WebKit"&&e.os===hi.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==nt.SAFARI||ji()&&e.name!==nt.SAFARI)}function Ys(){return Xe().name===nt.CHROME}function pi(){return Xe().name===nt.SAFARI}function ub(){return Xe().name===nt.EDGE}function mt(){return Xe().name===nt.FIREFOX}function ji(){return Xe().os===hi.IOS}function AS(e){let t=Xe();return!(t.name!==nt.CHROME||!t.osVersion)&&Number(t.version)>=e}function hb(e){let t=Xe();return!(t.name!==nt.EDGE||!t.osVersion)&&Number(t.version)>=e}function pb(e){let t=Xe();return!(t.name!==nt.SAFARI||!t.osVersion)&&Number(t.version)>=e}function mb(e,t,i){let r=Xe();if(r.os!==hi.IOS||!r.osVersion)return!1;let n=r.osVersion.split(".");return t&&Number(n[0])===e&&Number(n[1])<t||Number(n[0])<e}function _b(e,t,i){let r=Xe();if(r.name!==nt.SAFARI||!r.osVersion||!r.browserVersion)return!1;let n=r.browserVersion.split(".");return t&&Number(n[0])===e&&Number(n[1])<t||Number(n[0])<e}function fb(e){let t=Xe();return!(t.name!==nt.OPERA||!t.osVersion)&&Number(t.version)>=e}function Eb(){let e=Xe();return!(e.name!==nt.CHROME||!e.osVersion)&&Number(e.version)<=90}function gb(){let e=Xe();if(e.os!==hi.IOS||!e.osVersion)return!1;let t=e.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function vl(){let e=Xe();if(e.os!==hi.IOS||!e.osVersion)return!1;let t=e.osVersion.split(".");return Number(t[0])===15}function OS(){let e=Xe();if(e.os!==hi.IOS||!e.osVersion)return!1;let t=e.osVersion.split(".");return Number(t[0])===16}function Sb(){let e=Xe();if(e.os!==hi.IOS||!e.osVersion)return!1;let t=e.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function Mn(){return pi()&&navigator.maxTouchPoints>0}function Tb(){return Xe().name===nt.WECHAT}function vb(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function bS(){let e=cm();return function(){let{deviceType:t}=Xe();return t==="mobile"||t==="tablet"}()||e===hi.ANDROID||e===hi.IOS||e===hi.HARMONY_OS}function qs(){let e=Xe();return e.name!==nt.EDGE&&e.name!==nt.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function dm(){return cm()===hi.ANDROID}function fu(){let e=Xe();return dm()&&(e.name===nt.CHROME||e.name===nt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function Rb(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function fe(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Rb(Object(i),!0).forEach(function(r){wt(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Rb(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function wt(e,t,i){return(t=function(r){var n=function(o,a){if(typeof o!="object"||o===null)return o;var l=o[Symbol.toPrimitive];if(l!==void 0){var d=l.call(o,"string");if(typeof d!="object")return d;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof n=="symbol"?n:String(n)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let A=function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e}({});class j extends Error{constructor(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",r=arguments.length>2?arguments[2]:void 0;super(i),wt(this,"code",void 0),wt(this,"message",void 0),wt(this,"data",void 0),wt(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(i),this.data=r}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",i=arguments.length>1?arguments[1]:void 0;return t==="error"&&(i||console).error(this.toString()),t==="warning"&&(i||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}}function us(e,t){if(typeof e!="boolean")throw new j(A.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function ci(e,t,i){if(!se(i).call(i,e))throw new j(A.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(i)))}function ut(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(e<i||e>r||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(n){return typeof n=="number"&&n%1==0}(e))throw new j(A.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(i,", ").concat(r,"]. integer only"))}function NS(e,t){if(typeof e!="number"){if(!(e.min||e.max||e.ideal||e.exact))throw new j(A.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));e.min!==void 0&&ut(e.min,"".concat(t,".min"),0,1/0),e.max!==void 0&&ut(e.max,"".concat(t,".max"),1,1/0),e.exact!==void 0&&ut(e.exact,"".concat(t,".exact"),1,1/0),e.ideal!==void 0&&ut(e.ideal,"".concat(t,".ideal"),1,1/0)}else ut(e,t,1,1/0)}function Ai(e,t){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,n=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(e==null)throw new j(A.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!Cb(e,i,r,n))throw new j(A.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(i,",").concat(r,"].").concat(n?" ASCII characters only.":""))}function hs(e,t){if(!Array.isArray(e))throw new j(A.INVALID_PARAMS,"".concat(t," should be an array"))}function Ut(e){return e==null}function Cb(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,r=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof e=="string"&&e.length<=i&&e.length>=t&&(!r||function(n){if(typeof n!="string")return!1;for(let o=0;o<n.length;o+=1){let a=n.charCodeAt(o);if(a<0||a>255)return!1}return!0}(e))}function yb(e,t,i){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,i);let r=e.getUint32(t,i),n=e.getUint32(t+4,i),o=+!!i,a=+!i;return BigInt(r*a+n*o)<<BigInt(32)|BigInt(r*o+n*a)}function Ib(e,t,i,r){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,i,r);let n=Number(i>>BigInt(32)),o=Number(i&BigInt(4294967295));e.setUint32(t,n,r),e.setUint32(t+4,o,r)}var Eu=function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e}(Eu||{}),DS=function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e}(DS||{});let wb=new class{constructor(){wt(this,"_clientSize",null),wt(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),wt(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),wt(this,"getStyle",e=>window.getComputedStyle(e,null)),wt(this,"checkCssVisibleProperty",e=>{var t;let i=!0,r=this.getStyle(e),{display:n,visibility:o,opacity:a,filter:l}=r;return(n==="none"||se(t=["hidden","collapse"]).call(t,o)||Number(a)<.1)&&(i=!1),!!i&&(l&&l.split(" ").filter(d=>{var u;let p=d.split("(")[0];return se(u=["brightness","blur","opacity"]).call(u,p)}).map(d=>{let[u,p]=d.split(/\(|\)/);return[u,Number(p.match(/^[0-9\.]+/))]}).forEach(d=>{let[u,p]=d;switch(u){case"brightness":(p<.1||p>3)&&(i=!1);break;case"blur":p>3&&(i=!1);break;case"opacity":p<.1&&(i=!1)}}),i)}),wt(this,"checkPropertyUpToAllParentNodes",(e,t)=>{let i=!0,r=!0,n=a=>t(a),o=e;for(;o&&r;)n(o)||(i=!1,r=!1),o=o.parentElement,o||(r=!1);return i}),wt(this,"checkActualCssVisibleIncludeInherit",e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty)),wt(this,"getSizeAboutClient",e=>{let{width:t,height:i,left:r,right:n,top:o,bottom:a}=e.getBoundingClientRect(),l=this.getClientWidth(),d=this.getClientHeight();return{width:t,height:i,left:r,right:n,top:o,bottom:a,clientWidth:l,clientHeight:d,clientMin:Math.min(l,d)}}),wt(this,"checkActualSize",()=>{let{width:e,height:t,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(e,t,i)}),wt(this,"elementFromPoint",(e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null),wt(this,"checkCoverForAPoint",(e,t,i)=>{let r=this.elementFromPoint(e,t);return r!==null&&r!==i}),wt(this,"getPointPositionList",()=>{let{width:e,height:t,left:i,top:r}=this._clientSize,n=e/6,o=t/6,a=[],l=10**6;for(let d=0;d<5;d++)for(let u=0;u<5;u++){let p=(i*l+(d===0?.1:d===4?(n*d*l-1e5)/l:n*d)*l)/l,m=(r*l+(u===0?.1:u===4?(o*u*l-1e5)/l:o*u)*l)/l;a.push({x:p,y:m})}return[...a]}),wt(this,"checkElementCover",e=>this.getPointPositionList().map(t=>this.checkCoverForAPoint(t.x,t.y,e)).filter(t=>!!t).length>6),wt(this,"checkSizeIsVisible",(e,t,i)=>(e>50||i/e<=10)&&(t>50||i/t<=10)),wt(this,"checkSizeOfPartInClient",()=>{let{left:e,right:t,top:i,bottom:r,clientHeight:n,clientWidth:o,clientMin:a}=this._clientSize,l,d,u,p;if(e<0)l=0;else{if(!(e<o))return!1;l=e}if(t<0)return!1;if(d=t<o?t:o,i<0)u=0;else{if(!(i<n))return!1;u=i}if(r<0)return!1;p=r<n?r:n;let m=d-l,f=p-u;return this.checkSizeIsVisible(m,f,a)}),wt(this,"returnHiddenResult",e=>(this._clientSize=null,{visible:!1,reason:e})),wt(this,"checkOneElementVisible",e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(Eu.COVERED);{let t=this.checkActualSize(),i=this.checkSizeOfPartInClient();return t&&!i?this.returnHiddenResult(Eu.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Eu.SIZE)}}return this.returnHiddenResult(Eu.STYLE)}return this.returnHiddenResult(DS.UNMOUNTED)}return this.returnHiddenResult(DS.INVALID_HTML_ELEMENT)}),wt(this,"checkElementIsMountedOnDom",e=>this.checkPropertyUpToAllParentNodes(e,t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))}};function PS(e){return new TextEncoder().encode(e)}let Ab=function(e,t){let i=new Uint8Array(e.byteLength+t.byteLength);return i.set(new Uint8Array(e),0),i.set(new Uint8Array(t),e.byteLength),i},kS=async e=>function(t,i){let r="";return new Uint8Array(t).forEach(n=>{r+=n.toString(i).padStart(2,"0")}),r}(await crypto.subtle.digest("SHA-256",PS(e)),16),Ot=class{constructor(){wt(this,"_events",{}),wt(this,"addListener",this.on)}getListeners(e){return this._events[e]?this._events[e].map(t=>t.listener):[]}on(e,t){this._events[e]||(this._events[e]=[]);let i=this._events[e];this._indexOfListener(i,t)===-1&&i.push({listener:t,once:!1})}once(e,t){this._events[e]||(this._events[e]=[]);let i=this._events[e];this._indexOfListener(i,t)===-1&&i.push({listener:t,once:!0})}off(e,t){if(!this._events[e])return;let i=this._events[e],r=this._indexOfListener(i,t);r!==-1&&i.splice(r,1),this._events[e].length===0&&delete this._events[e]}removeAllListeners(e){e?delete this._events[e]:this._events={}}emit(e){this._events[e]||(this._events[e]=[]);let t=this._events[e].map(o=>o);for(var i=arguments.length,r=new Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];for(let o=0;o<t.length;o+=1){let a=t[o];a.once&&this.off(e,a.listener),a.listener.apply(this,r||[])}}safeEmit(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];[...this._events[e]||[]].forEach(n=>{n.once&&this.off(e,n.listener);try{n.listener.apply(this,i)}catch(o){console.error("safeEmit event:".concat(e," error ").concat(o==null?void 0:o.toString()))}})}_indexOfListener(e,t){let i=e.length;for(;i--;)if(e[i].listener===t)return i;return-1}},gu=null;function Ob(){if(gu)return gu;if(window.electron)return gu=window.electron;if(!window.require)return null;try{return gu=window.require("electron"),gu}catch{return null}}let ei=function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.PRELOAD="PRELOAD",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.DATACHANNEL_FAILBACK="Client._datachannelFailback",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e}({}),xt=function(e){return e.TRACER="tracer",e}({});function bb(e){return ut(e.timeout,"config.timeout",0,1e5),ut(e.timeoutFactor,"config.timeoutFactor",0,100,!1),ut(e.maxRetryCount,"config.maxRetryConfig",0,1/0),ut(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let g8=function(e){return e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",e}({}),Ge=function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.FALLBACK="FALLBACK",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e}({});function Rl(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach(t=>{if(!t.urls)throw Error()})}catch{return!1}return!0}function Nb(e){return Ai(e.turnServerURL,"turnServerURL"),Ai(e.username,"username"),Ai(e.password,"password"),e.udpport&&ut(e.udpport,"udpport",1,99999,!0),e.forceturn&&us(e.forceturn,"forceturn"),e.security&&us(e.security,"security"),e.tcpport&&ut(e.tcpport,"tcpport",1,99999,!0),!0}function Db(e){return e.level!==void 0&&ci(e.level,"level",[1,2,3]),e.delay!==void 0&&ut(e.delay,"delay",0,3e3,!0),!0}let We=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.INJECT_STREAM_STATUS="stream-inject-status",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e}({}),ki=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),ir=function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({}),tc=function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({});function ti(e,t){for(var i=arguments.length,r=new Array(i>2?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];return e.getListeners(t).length===0?ne.reject(new j(A.UNEXPECTED_ERROR,"can not emit promise")):new ne((o,a)=>{e.emit(t,...r,o,a)})}function _t(e,t){if(e.getListeners(t).length===0)return ne.resolve();for(var i=arguments.length,r=new Array(i>2?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];return ti(e,t,...r)}function Ur(e,t){if(e.getListeners(t).length===0)return null;for(var i=arguments.length,r=new Array(i>2?i-2:0),n=2;n<i;n++)r[n-2]=arguments[n];return ic(e,t,...r)}function ic(e,t){let i=null,r=null;for(var n=arguments.length,o=new Array(n>2?n-2:0),a=2;a<n;a++)o[a-2]=arguments[a];if(e.emit(t,...o,l=>{i=l},l=>{r=l}),r!==null)throw r;if(i===null)throw new j(A.UNEXPECTED_ERROR,"handler is not sync");return i}let Vt=new class extends Ot{set networkState(e){this.emit(tc.NETWORK_STATE_CHANGE,e,this._networkState),e===ir.ONLINE?this.emit(tc.ONLINE):e===ir.OFFLINE&&(this.onlineWaiter=new ne(t=>{this.once(tc.ONLINE,()=>{this.onlineWaiter=void 0,t(ir.ONLINE)})}),this.emit(tc.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===ir.ONLINE}constructor(){super(),wt(this,"_moduleName","network-indicator"),wt(this,"_networkState",ir.ONLINE),wt(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=ir.ONLINE}),window.addEventListener("offline",()=>{this.networkState=ir.OFFLINE})}};function um(e,t){let i=e.indexOf(t);i!==-1&&e.splice(i,1)}function Cl(e){let t=[];return e.forEach(i=>{t.indexOf(i)===-1&&t.push(i)}),t}function hm(e){ne!==void 0?ne.resolve().then(e):setTimeout(e,0)}function vt(e){return JSON.parse(JSON.stringify(e))}function rc(e){try{return vt(e)}catch{return e}}let Pb={};function Js(e,t){Pb[t]||(Pb[t]=!0,e())}function nc(e){let t=window.atob(e),i=new Uint8Array(new ArrayBuffer(t.length));for(let r=0;r<t.length;r+=1)i[r]=t.charCodeAt(r);return i}function Xs(e){let t="";for(let i=0;i<e.length;i+=1)t+=String.fromCharCode(e[i]);return window.btoa(t)}function kb(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,i=new TextEncoder().encode(e);if(i.length>t)i=i.slice(0,t);else if(i.length<t){let r=new Uint8Array(t);r.set(i),i=r}return i}function Lb(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];let r=ao(t).call(t,(a,l)=>a+l.length,0),n=new Uint8Array(new ArrayBuffer(r)),o=0;return t.forEach(a=>{n.set(a,o),o+=a.length}),n}function Bo(e){return window.TextEncoder?new TextEncoder().encode(e).length:e.length}function Mb(e){let t=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&e.realFormData&&(e=e.realFormData),e.forEach(i=>{t+=typeof i=="string"?Bo(i):i.size}),t+138}function S8(e){let t=new j(A.TIMEOUT,"timeout");return new ne((i,r)=>{window.setTimeout(()=>r(t),e)})}function mi(e){return new ne(t=>{window.setTimeout(t,e)})}function ft(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0,i=Math.random().toString(16).substr(2,e).toLowerCase();return i.length===e?"".concat(t).concat(i):"".concat(t).concat(i)+ft(e-i.length,"")}function Su(){return ft(32,"").toUpperCase()}let pm=()=>{},Ub=new class{constructor(){wt(this,"fnMap",new Map)}throttleByKey(e,t,i,r){for(var n=arguments.length,o=new Array(n>4?n-4:0),a=4;a<n;a++)o[a-4]=arguments[a];if(this.fnMap.has(t)){let l=this.fnMap.get(t);if(l.threshold!==i){l.fn(...l.args),clearTimeout(l.timer);let d=window.setTimeout(()=>{let u=this.fnMap.get(t);u&&u.fn(...u.args),this.fnMap.delete(t)},i);this.fnMap.set(t,{fn:e,threshold:i,timer:d,args:o,skipFn:r})}else l.skipFn&&l.skipFn(...l.args),this.fnMap.set(t,fe(fe({},l),{},{fn:e,args:o,skipFn:r}))}else{let l=window.setTimeout(()=>{let d=this.fnMap.get(t);d&&d.fn(...d.args),this.fnMap.delete(t)},i);this.fnMap.set(t,{fn:e,threshold:i,timer:l,args:o,skipFn:r})}}},xb=Ub.throttleByKey.bind(Ub);function Vb(e){return typeof e=="object"&&e!==null&&!(e instanceof RegExp)}function LS(e,t){if(!Vb(e)||!Vb(t)||Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){let i=[...e];for(let r=0;r<t.length;r++)i[r]=LS(e[r],t[r]);return i}{let i=fe({},e);for(let r in t)Object.prototype.hasOwnProperty.call(t,r)&&(Object.prototype.hasOwnProperty.call(e,r)?i[r]=LS(e[r],t[r]):i[r]=t[r]);return i}}function Fb(e,t){let i=[0];if(i=new Array(t).fill(0),e===0)return i;let r=0;for(;e>0&&(i[r]=255&e,e>>=8,r++,r!==t););return i}function MS(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function jb(e){let t="0123456789abcdef";function i(P){let M,V="";for(M=0;M<=3;M++)V+=t.charAt(P>>8*M+4&15)+t.charAt(P>>8*M&15);return V}function r(P,M){let V=(65535&P)+(65535&M);return(P>>16)+(M>>16)+(V>>16)<<16|65535&V}function n(P,M,V,F,Y,J){return r(function(Z,pe){return Z<<pe|Z>>>32-pe}(r(r(M,P),r(F,J)),Y),V)}function o(P,M,V,F,Y,J,Z){return n(M&V|~M&F,P,M,Y,J,Z)}function a(P,M,V,F,Y,J,Z){return n(M&F|V&~F,P,M,Y,J,Z)}function l(P,M,V,F,Y,J,Z){return n(M^V^F,P,M,Y,J,Z)}function d(P,M,V,F,Y,J,Z){return n(V^(M|~F),P,M,Y,J,Z)}let u=function(P){let M,V=1+(P.length+8>>6),F=new Array(16*V);for(M=0;M<16*V;M++)F[M]=0;for(M=0;M<P.length;M++)F[M>>2]|=P.charCodeAt(M)<<M%4*8;return F[M>>2]|=128<<M%4*8,F[16*V-2]=8*P.length,F}(e),p,m,f,E,I,T=1732584193,R=-271733879,w=-1732584194,O=271733878;for(p=0;p<u.length;p+=16)m=T,f=R,E=w,I=O,T=o(T,R,w,O,u[p+0],7,-680876936),O=o(O,T,R,w,u[p+1],12,-389564586),w=o(w,O,T,R,u[p+2],17,606105819),R=o(R,w,O,T,u[p+3],22,-1044525330),T=o(T,R,w,O,u[p+4],7,-176418897),O=o(O,T,R,w,u[p+5],12,1200080426),w=o(w,O,T,R,u[p+6],17,-1473231341),R=o(R,w,O,T,u[p+7],22,-45705983),T=o(T,R,w,O,u[p+8],7,1770035416),O=o(O,T,R,w,u[p+9],12,-1958414417),w=o(w,O,T,R,u[p+10],17,-42063),R=o(R,w,O,T,u[p+11],22,-1990404162),T=o(T,R,w,O,u[p+12],7,1804603682),O=o(O,T,R,w,u[p+13],12,-40341101),w=o(w,O,T,R,u[p+14],17,-1502002290),R=o(R,w,O,T,u[p+15],22,1236535329),T=a(T,R,w,O,u[p+1],5,-165796510),O=a(O,T,R,w,u[p+6],9,-1069501632),w=a(w,O,T,R,u[p+11],14,643717713),R=a(R,w,O,T,u[p+0],20,-373897302),T=a(T,R,w,O,u[p+5],5,-701558691),O=a(O,T,R,w,u[p+10],9,38016083),w=a(w,O,T,R,u[p+15],14,-660478335),R=a(R,w,O,T,u[p+4],20,-405537848),T=a(T,R,w,O,u[p+9],5,568446438),O=a(O,T,R,w,u[p+14],9,-1019803690),w=a(w,O,T,R,u[p+3],14,-187363961),R=a(R,w,O,T,u[p+8],20,1163531501),T=a(T,R,w,O,u[p+13],5,-1444681467),O=a(O,T,R,w,u[p+2],9,-51403784),w=a(w,O,T,R,u[p+7],14,1735328473),R=a(R,w,O,T,u[p+12],20,-1926607734),T=l(T,R,w,O,u[p+5],4,-378558),O=l(O,T,R,w,u[p+8],11,-2022574463),w=l(w,O,T,R,u[p+11],16,1839030562),R=l(R,w,O,T,u[p+14],23,-35309556),T=l(T,R,w,O,u[p+1],4,-1530992060),O=l(O,T,R,w,u[p+4],11,1272893353),w=l(w,O,T,R,u[p+7],16,-155497632),R=l(R,w,O,T,u[p+10],23,-1094730640),T=l(T,R,w,O,u[p+13],4,681279174),O=l(O,T,R,w,u[p+0],11,-358537222),w=l(w,O,T,R,u[p+3],16,-722521979),R=l(R,w,O,T,u[p+6],23,76029189),T=l(T,R,w,O,u[p+9],4,-640364487),O=l(O,T,R,w,u[p+12],11,-421815835),w=l(w,O,T,R,u[p+15],16,530742520),R=l(R,w,O,T,u[p+2],23,-995338651),T=d(T,R,w,O,u[p+0],6,-198630844),O=d(O,T,R,w,u[p+7],10,1126891415),w=d(w,O,T,R,u[p+14],15,-1416354905),R=d(R,w,O,T,u[p+5],21,-57434055),T=d(T,R,w,O,u[p+12],6,1700485571),O=d(O,T,R,w,u[p+3],10,-1894986606),w=d(w,O,T,R,u[p+10],15,-1051523),R=d(R,w,O,T,u[p+1],21,-2054922799),T=d(T,R,w,O,u[p+8],6,1873313359),O=d(O,T,R,w,u[p+15],10,-30611744),w=d(w,O,T,R,u[p+6],15,-1560198380),R=d(R,w,O,T,u[p+13],21,1309151649),T=d(T,R,w,O,u[p+4],6,-145523070),O=d(O,T,R,w,u[p+11],10,-1120210379),w=d(w,O,T,R,u[p+2],15,718787259),R=d(R,w,O,T,u[p+9],21,-343485551),T=r(T,m),R=r(R,f),w=r(w,E),O=r(O,I);return i(T)+i(R)+i(w)+i(O)}let T8=1,mm=console,Ti=class{static setLogger(e){mm=e}constructor(e){wt(this,"lockingPromise",ne.resolve()),wt(this,"locks",0),wt(this,"name",""),wt(this,"lockId",void 0),this.lockId=T8++,e&&(this.name=e),mm.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(e){let t;this.locks+=1,mm.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:""));let i=new ne(n=>{t=()=>{this.locks-=1,mm.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof e=="string"?e:"")),n()}}),r=this.lockingPromise.then(()=>t);return this.lockingPromise=this.lockingPromise.then(()=>i),r}};function yl(e,t){return function(i,r,n){let o=n.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){let a=this[t];if(!a)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));let l=await a.lock("From ".concat(e,".").concat(r));try{for(var d=arguments.length,u=new Array(d),p=0;p<d;p++)u[p]=arguments[p];return await o.apply(this,u)}finally{l()}},n}}let Jt={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function _m(e,t){let i=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,i)}function uo(e,t,i,r){let n=Object.assign({},Jt,r),o=n.timeout,a=async()=>{await function(u){return new ne(p=>{window.setTimeout(p,u)})}(o),o*=n.timeoutFactor,o=Math.min(n.maxRetryTimeout,o)},l=!1,d=new ne(async(u,p)=>{t=t||(()=>!1),i=i||(()=>!0);for(let m=0;m<n.maxRetryCount;m+=1){if(l)return p(new j(A.OPERATION_ABORTED));try{let f=await e();if(!t(f,m)||m+1===n.maxRetryCount)return u(f);await a()}catch(f){if(!i(f,m)||m+1===n.maxRetryCount)return p(f);await a()}}});return d.cancel=()=>l=!0,d}class US{constructor(t){wt(this,"input",[]),wt(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){var t;return this.input.length===0?0:ao(t=this.input).call(t,(i,r)=>i+r)/this.input.length}}let fm,Em=0,xS=0;function VS(e,t,i,r){return new ne((n,o)=>{t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),Em+=Bo(t.data)):i&&(t.data.size?Em+=t.data.size:t.data instanceof FormData?Em+=Mb(t.data):Em+=Bo(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ur.request(t).then(a=>{typeof a.data=="string"?xS+=Bo(a.data):a.data instanceof ArrayBuffer||a.data instanceof Uint8Array?xS+=a.data.byteLength:xS+=Bo(JSON.stringify(a.data)),n(a.data)}).catch(a=>{ur.isCancel(a)?o(new j(A.OPERATION_ABORTED,"cancel token canceled")):a.code==="ECONNABORTED"?o(new j(A.NETWORK_TIMEOUT,a.message)):a.response?o(new j(A.NETWORK_RESPONSE_ERROR,a.response.status)):o(new j(A.NETWORK_ERROR,a.message))})})}async function v8(e,t){let i=new Blob([t.data],{type:"buffer"});return await VS(e,fe(fe({},t),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)}let Bb=()=>window.isSecureContext!==void 0,mn=function(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;let t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){let r=t[1],n=t[2];return"".concat(r,".").concat(n)}let i=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(i&&i[1]&&i[2]){let r=i[1],n=i[2];return"".concat(r,".").concat(100*(Number(n)+1))}return"4.0.0.999"}("4.21.0"),FS=function(){try{return JSON.parse("true")===!0}catch{return!0}}(),oc=function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e}({}),jS={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},BS="v4.21.0-0-g16fdae2c-dirty(6/3/2024, 2:55:18 PM)",oi={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!0,USE_SUB_RTX:!0,USE_XR:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:void 0,ENABLE_CC_FALLBACK:void 0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:jS,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,CUSTOM_ADAPTATION_DEFAULT_MODE:"",ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,ENABLE_PRELOAD:!0};function ht(e,t,i){var r,n,o;se(r=Object.keys(oi)).call(r,e)&&(!i&&se(n=Object.keys(Qs)).call(n,e)||(oi[e]=t,e==="ENABLE_VIDEO_SEI"&&t===!0&&(oi.ENABLE_ENCODED_TRANSFORM=!0),e==="USE_NEW_NETWORK_CONFIG"&&t&&(o=!!t,oi.USE_NEW_NETWORK_CONFIG=o,o&&(oi.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],oi.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],oi.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],oi.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],oi.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",oi.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",oi.GATEWAY_DOMAINS=["edge.sd-rtn.com"]))))}function N(e){return oi[e]}let Qs={};var je=function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.AVOID_JOIN_START="AVOID_JOIN_START",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e}(je||{});class R8{constructor(t,i,r,n){wt(this,"state",void 0),this.state={codec:t,audioCodec:i,mode:r,clientId:n,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:oc.Default}}dispatch(t){this.state=function(i,r){switch(r.type){case je.SET_SESSION_ID:return fe(fe({},i),{},{sessionId:r.sessionId});case je.SET_P2P_ID:return fe(fe({},i),{},{p2pId:r.p2pId});case je.SET_UID:return fe(fe({},i),{},{uid:r.uid});case je.SET_INT_UID:return fe(fe({},i),{},{intUid:r.intUid});case je.SET_PUB_ID:return fe(fe({},i),{},{pubId:r.pubId});case je.KEY_METRIC_CLIENT_CREATED:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{clientCreated:r.metric})});case je.KEY_METRIC_JOIN_START:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{joinStart:r.metric})});case je.AVOID_JOIN_START:return fe(fe({},i),{},{avoidJoinStart:r.avoidJoinStart});case je.KEY_METRIC_JOIN_END:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{joinEnd:r.metric})});case je.KEY_METRIC_REQUEST_AP_START:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{requestAPStart:r.metric})});case je.KEY_METRIC_REQUEST_AP_END:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{requestAPEnd:r.metric})});case je.KEY_METRIC_JOIN_GATEWAY_START:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{joinGatewayStart:r.metric})});case je.KEY_METRIC_JOIN_GATEWAY_END:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{joinGatewayEnd:r.metric})});case je.KEY_METRIC_PEER_CONNECTION_START:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{peerConnectionStart:r.metric})});case je.KEY_METRIC_PEER_CONNECTION_END:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{peerConnectionEnd:r.metric})});case je.KEY_METRIC_DESCRIPTION_START:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{descriptionStart:r.metric})});case je.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{signalChannelOpen:r.metric})});case je.KEY_METRIC_ICE_CONNECTION_END:return fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{iceConnectionEnd:r.metric})});case je.KEY_METRIC_PUBLISH:{let n=i.keyMetrics.publish,o=n.findIndex(a=>a.trackId===r.metric.trackId);return o!==-1?(n[o]=fe(fe({},n[o]),r.metric),fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{publish:[...n]})})):fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{publish:[...i.keyMetrics.publish,r.metric]})})}case je.KEY_METRIC_SUBSCRIBE:{let n=i.keyMetrics.subscribe,o=n.findIndex(a=>a.userId===r.metric.userId&&a.type===r.metric.type);return o!==-1?(n[o]=fe(fe({},n[o]),r.metric),fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{subscribe:[...n]})})):fe(fe({},i),{},{keyMetrics:fe(fe({},i.keyMetrics),{},{subscribe:[...i.keyMetrics.subscribe,r.metric]})})}case je.SET_CLOUD_PROXY_SERVER_MODE:return i.cloudProxyServerMode=r.mode,i;case je.RECORD_JOIN_CHANNEL_SERVICE:return typeof r.index!="number"?i.joinChannelServiceRecords=[...i.joinChannelServiceRecords,r.record]:(i.joinChannelServiceRecords[r.index]=fe(fe({},i.joinChannelServiceRecords[r.index]),r.record),i.joinChannelServiceRecords=[...i.joinChannelServiceRecords]),i;case je.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return i.joinChannelServiceRecords=[],i;case je.RESET_KEY_METRICS:return i.keyMetrics={publish:[],subscribe:[]},i;case je.SET_USE_DATACHANNEL:return fe(fe({},i),{},{useDataChannel:r.val});case je.SET_USE_P2P:return fe(fe({},i),{},{useP2P:r.val});case je.SET_TRANSPORT_TYPE:return fe(fe({},i),{},{p2pTransport:r.val});default:return i}}(this.state,t)}set sessionId(t){this.dispatch({type:je.SET_SESSION_ID,sessionId:t})}get sessionId(){return this.state.sessionId}set codec(t){this.state.codec=t}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(t){this.dispatch({type:je.SET_P2P_ID,p2pId:t})}get p2pId(){return this.state.p2pId}set dcId(t){this.dispatch({type:je.SET_DC_ID,dcId:t})}get dcId(){return this.state.dcId}set uid(t){this.dispatch({type:je.SET_UID,uid:t})}get uid(){return this.state.uid}set intUid(t){this.dispatch({type:je.SET_INT_UID,intUid:t})}get intUid(){return this.state.intUid}set pubId(t){this.dispatch({type:je.SET_PUB_ID,pubId:t})}get pubId(){return this.state.pubId}set cloudProxyServerMode(t){this.dispatch({type:je.SET_CLOUD_PROXY_SERVER_MODE,mode:t})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(t){this.dispatch({type:je.SET_USE_DATACHANNEL,val:t})}get useDataChannel(){return this.state.useDataChannel}set useP2P(t){this.dispatch({type:je.SET_USE_P2P,val:t})}get useP2P(){return this.state.useP2P}set p2pTransport(t){this.dispatch({type:je.SET_TRANSPORT_TYPE,val:t})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:je.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:je.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:je.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:je.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:je.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:je.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:je.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:je.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:je.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:je.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:je.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:je.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(t,i,r,n){this.dispatch({type:je.KEY_METRIC_PUBLISH,metric:fe(fe({trackId:t,type:i},r&&{publishStart:r}),n&&{publishEnd:n})})}subscribe(t,i,r,n,o,a,l){this.dispatch({type:je.KEY_METRIC_SUBSCRIBE,metric:fe(fe(fe(fe(fe({userId:t,type:i},r&&{subscribeStart:r}),n&&{subscribeEnd:n}),o&&{firstFrame:o}),a&&{streamAdded:a}),l&&{firstDecoded:l})})}massSubscribe(t,i,r,n){t.forEach(o=>{this.dispatch({type:je.KEY_METRIC_SUBSCRIBE,metric:fe(fe(fe({userId:o.userId,type:o.type},i&&{subscribeStart:i}),r&&{subscribeEnd:r}),n&&{firstFrame:n})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(t,i){t.service==="gateway"&&Array.isArray(t.urls)&&(t.urls=t.urls.map(r=>r.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof i!="number"?(this.dispatch({type:je.RECORD_JOIN_CHANNEL_SERVICE,record:fe(fe({},t),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(i<0||i>=this.state.joinChannelServiceRecords.length||this.dispatch({type:je.RECORD_JOIN_CHANNEL_SERVICE,record:t,index:i}),i)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:je.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:je.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(t){this.dispatch({type:je.AVOID_JOIN_START,avoidJoinStart:t})}}let Il=function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e}({});(function(e){e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722"})({});let Gb=128,C8=96,Wb=1e3,wl=10,y8=0;function Hb(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function Me(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?Hb(Object(i),!0).forEach(function(r){Gt(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Hb(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function Gt(e,t,i){return(t=function(r){var n=function(o,a){if(typeof o!="object"||o===null)return o;var l=o[Symbol.toPrimitive];if(l!==void 0){var d=l.call(o,"string");if(typeof d!="object")return d;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof n=="symbol"?n:String(n)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let Kb=new class extends Ot{constructor(){super(...arguments),Gt(this,"currentUploadLogID",0)}reportLogUploadError(e){let{errorRange:t}=e;t[t.length-1]&&t[t.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=t[t.length-1],this.emit("REPORT_LOG_UPLOAD",e))}};class I8{constructor(t){Gt(this,"logger",void 0),Gt(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];this.logger.debug(...this.prefixLists,...i)}info(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];this.logger.info(...this.prefixLists,...i)}warning(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];this.logger.warning(...this.prefixLists,...i)}error(){for(var t=arguments.length,i=new Array(t),r=0;r<t;r++)i[r]=arguments[r];this.logger.error(...this.prefixLists,...i)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function GS(){let e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function zb(){let e=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?(t==null?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}let _n={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},gm=Date.now(),Tu=e=>{for(let t in _n)if(Object.prototype.hasOwnProperty.call(_n,t)&&_n[t]===e)return t;return"DEFAULT"},S=new class{constructor(){Gt(this,"proxyServerURL",void 0),Gt(this,"logLevel",_n.DEBUG),Gt(this,"uploadState","collecting"),Gt(this,"uploadLogWaitingList",[]),Gt(this,"uploadLogUploadingList",[]),Gt(this,"uploadErrorCount",0),Gt(this,"currentLogID",0),Gt(this,"url",void 0),Gt(this,"extLog",(e,t)=>{this.appendLogToWaitingList(e,...t)})}debug(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];let r=[_n.DEBUG].concat(t);this.log.apply(this,r)}info(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];let r=[_n.INFO].concat(t);this.log.apply(this,r)}warning(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];let r=[_n.WARNING].concat(t);this.log.apply(this,r)}warn(){this.warning(...arguments)}error(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];let r=[_n.ERROR].concat(t);this.log.apply(this,r)}upload(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];let r=[_n.DEBUG].concat(t);this.uploadLog.apply(this,r)}setLogLevel(e){e=Math.min(Math.max(0,e),4),this.logLevel=e}enableLogUpload(){ht("UPLOAD_LOG",!0)}disableLogUpload(){ht("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(e){this.proxyServerURL=e}prefix(e){return new I8(this).prefix(e)}log(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if(Date.now()-gm<100)return void setTimeout(()=>{this.log(...t)},Date.now()-gm);let r=Math.max(0,Math.min(4,t[0]));if(t[0]=GS()+" Agora-SDK [".concat(Tu(r),"]:"),this.appendLogToWaitingList(r,...t),r<this.logLevel)return;let n=GS()+" %cAgora-SDK [".concat(Tu(r),"]:"),o=[];if(!N("USE_NEW_LOG"))switch(r){case _n.DEBUG:o=[n,"color: #64B5F6;"].concat(t.slice(1)),console.log.apply(console,o);break;case _n.INFO:o=[n,"color: #1E88E5; font-weight: bold;"].concat(t.slice(1)),console.log.apply(console,o);break;case _n.WARNING:o=[n,"color: #FB8C00; font-weight: bold;"].concat(t.slice(1)),console.warn.apply(console,o);break;case _n.ERROR:o=[n,"color: #B00020; font-weight: bold;"].concat(t.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];if(Date.now()-gm<100)return void setTimeout(()=>{this.uploadLog(...t)},Date.now()-gm);let r=Math.max(0,Math.min(4,t[0]));t[0]=GS()+" Agora-SDK [".concat(Tu(r),"]:"),this.appendLogToWaitingList(r,...t)}appendLogToWaitingList(e){if(!N("UPLOAD_LOG"))return;for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];Array.isArray(i[0])?i[0][0]=zb()+" Agora-SDK [".concat(Tu(e),"]:"):i[0]=zb()+" Agora-SDK [".concat(Tu(e),"]:");let n="";i.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),n+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:n,log_level:e,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){let e=this.uploadLogUploadingList,t={sdk_version:mn,process_id:N("PROCESS_ID"),payload:JSON.stringify(e)};return uo(async()=>{let i=await ur.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(N("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(N("LOG_UPLOAD_SERVER"),"/upload/v1")),t,{responseType:"text"});if(i.data!=="OK"){let r=new Error("unexpected upload log response");throw r.response=i,r}},()=>(this.uploadLogUploadingList=[],!1),i=>{let r={status:-1,message:i.message,errorRange:e.map(n=>n.log_item_id)};return i.response?(r.status=i.response.status,r.data=i.response.data,r.headers=i.response.headers):i.request&&(r.status=i.request.status),Kb.reportLogUploadError(r),!0},{timeout:N("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:N("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,N("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),N("UPLOAD_LOG_INTERVAL"))}).catch(e=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),N("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),N("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var Yb;function w8(e){return Ai(e.reportId,"params.reportId",0,100,!1),Ai(e.category,"params.category",0,100,!1),Ai(e.event,"params.event",0,100,!1),Ai(e.label,"params.label",0,100,!1),ut(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(Yb={}).FREE="free",Yb.UPLOADING="uploading",function(e){e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API"}({});let A8={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0},vi=function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e}({}),kt=function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e}({});(function(e){e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({}),function(e){e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED"}({});class vu{constructor(){Gt(this,"baseInfoMap",new Map),Gt(this,"proxyServer",void 0),Gt(this,"eventUploadTimer",void 0),Gt(this,"setSessionIdTimer",void 0),Gt(this,"url",void 0),Gt(this,"backupUrl",void 0),Gt(this,"_appId",void 0),Gt(this,"keyEventUploadPendingItems",[]),Gt(this,"normalEventUploadPendingItems",[]),Gt(this,"apiInvokeUploadPendingItems",[]),Gt(this,"apiInvokeCount",0),Gt(this,"ltsList",[]),Gt(this,"lastSendNormalEventTime",Date.now()),Gt(this,"customReportCounterTimer",void 0),Gt(this,"customReportCount",0),Gt(this,"extApiInvoke",async t=>{for(let i of t){let r=Me(Me({},i),{},{sid:null,invokeId:++this.apiInvokeCount,tag:xt.TRACER});this.sendApiInvoke(r)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),N("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),N("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void S.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));let i=this.baseInfoMap.get(t),r=Date.now(),n=i.startTime;i.startTime=r,S.debug("rewrite session ".concat(t," startTime: ").concat(r," , ").concat(r-n,"ms")),this.baseInfoMap.set(t,i)}setAppId(t){this._appId=t}reportApiInvoke(t,i,r){i.timeout=i.timeout||6e4,i.reportResult=i.reportResult===void 0||i.reportResult;let n=Date.now();this.apiInvokeCount+=1;let o=this.apiInvokeCount,a=()=>({tag:i.tag,invokeId:o,sid:t,name:i.name,apiInvokeTime:n,options:i.options,states:i.states||null}),l=!!N("SHOW_REPORT_INVOKER_LOG");l&&S.info("".concat(i.name," start"),i.options);let d=!1;mi(i.timeout).then(()=>{d||(this.sendApiInvoke(Me(Me({},a()),{},{error:A.API_INVOKE_TIMEOUT,success:!1})),S.debug("".concat(i.name," timeout")))});let u=new j(A.UNEXPECTED_ERROR,"".concat(i.name,": this api invoke is end"));return{onSuccess:p=>{let m=()=>{if(d)throw u;return d=!0,this.sendApiInvoke(Me(Me({},a()),{},{success:!0},i.reportResult&&{result:p})),l&&S.info("".concat(i.name," onSuccess")),p};return r?xb(m,i.name+"Success",r,()=>d=!0):m()},onError:p=>{let m=()=>{if(d)throw p;d=!0,this.sendApiInvoke(Me(Me({},a()),{},{success:!1,error:p})),l&&S.info("".concat(i.name," onFailure"),p.toString())};return r?xb(m,i.name+"Error",r,()=>d=!0):m()}}}sessionInit(t,i){if(this.baseInfoMap.has(t))return;let r=Date.now(),n=this.createBaseInfo(t,r);n.cname=i.cname;let o=Object.assign({},{willUploadConsoleLog:N("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:FS?"global":"oversea",areas:N("AREAS")&&N("AREAS").join(",")},i.extend),{stringUid:a,channelProfile:l,channelMode:d,isABTestSuccess:u,lsid:p,clientRole:m}=i,f=Date.now(),E=Me(Me({},n),{},{eventType:vi.SESSION_INIT,appid:i.appid,browser:navigator.userAgent,buildFormat:i.buildFormat,build:BS,lts:f,elapse:f-r,extend:JSON.stringify(o),mode:i.mode,process:N("PROCESS_ID"),appType:N("APP_TYPE"),success:!0,version:mn,stringUid:a,channelProfile:l,channelMode:d,isABTestSuccess:u,lsid:p,clientType:20,clientRole:m,serviceId:N("PROCESS_ID"),extensionID:N("PLUGIN_INFO").join(",")||"",preload:i.preload?1:0});this.send({type:kt.SESSION,data:E},!0)}joinChooseServer(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me({},n),{},{eventType:vi.JOIN_CHOOSE_SERVER,lts:o,eventElapse:i.elapse||o-i.lts,chooseServerAddr:i.csAddr,errorCode:i.ec,elapse:o-r.startTime,success:i.succ,chooseServerAddrList:JSON.stringify(i.serverList),uid:i.uid?parseInt(i.uid):null,cid:i.cid?parseInt(i.cid):null,chooseServerIp:i.csIp||"",opid:i.opid,unilbsServerIds:i.unilbsServerIds,extend:i.extend||void 0,isHttp3:i.isHttp3});this.send({type:kt.JOIN_CHOOSE_SERVER,data:a},!0)}reqUserAccount(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me({},n),{},{eventType:vi.REQ_USER_ACCOUNT,lts:o,success:i.success,serverAddress:i.serverAddr,stringUid:i.stringUid,uid:i.uid,errorCode:i.errorCode,elapse:i.elapse||o-r.startTime,eventElapse:o-i.lts,extend:JSON.stringify(i.extend)});this.send({type:kt.REQ_USER_ACCOUNT,data:a},!0)}joinGateway(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info;i.vid&&(n.vid=i.vid),n.uid=i.uid,n.cid=i.cid;let o=Date.now(),{firstSuccess:a,avoidJoinStartTime:l,isProxy:d,addr:u}=i,p=o-(a&&l?l:r.startTime),m=Me(Me({},n),{},{eventType:vi.JOIN_GATEWAY,lts:o,gatewayAddr:i.addr,success:i.succ,errorCode:i.ec,elapse:p,eventElapse:o-i.lts,firstSuccess:a,signalChannel:i.signalChannel}),f=m.success?1:0;if(i.succ&&(r.lastJoinSuccessTime=o),a)this.send({type:kt.JOIN_GATEWAY,data:m},!0);else{let E;if(u)if(d){let T=u.match(/h=(\d{1,3}-){3}\d{1,3}/g),R=u.match(/p=[0-9]{1,6}/g);E={isSuccess:f,gatewayIp:T&&T.length?T[0].split("=")[1].replace(/-/g,"."):"",port:R&&R.length?R[0].split("=")[1]:"",isProxy:d?1:0}}else{let T=u.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),R=u.match(/(:|p=)[0-9]{1,6}/g);E={isSuccess:f,gatewayIp:T&&T.length?T[0].split("//")[1].replace(/-/g,"."):"",port:R&&R.length?R[0].split(/:|p=/g)[1]:"",isProxy:d?1:0}}else E={isSuccess:f,gatewayIp:"",port:"",isProxy:d?1:0};delete m.success,delete m.eventType,delete m.firstSuccess,m.vid=Number(m.vid);let I=Object.assign({},m,E,{eventType:vi.REJOIN_GATEWAY});this.send({type:kt.RE_JOIN_GATEWAY,data:I},!0)}}joinChannelTimeout(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=Date.now(),o=Me(Me({},r.info),{},{lts:n,timeout:i,elapse:n-r.startTime});this.send({type:kt.JOIN_CHANNEL_TIMEOUT,data:o},!0)}publish(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me({},n),{},{eventType:vi.PUBLISH,lts:o,eventElapse:i.eventElapse,elapse:o-r.startTime,success:i.succ,errorCode:i.ec,videoName:i.videoName,audioName:i.audioName,screenName:i.screenName,screenshare:i.screenshare,audio:i.audio,video:i.video,p2pid:i.p2pid,publishRequestid:i.publishRequestid});this.send({type:kt.PUBLISH,data:a},!0)}subscribe(t,i,r){let n=this.baseInfoMap.get(t);if(!n)return;let o=n.info,a=Date.now(),l=Me(Me({},o),{},{eventType:vi.SUBSCRIBE,lts:a,eventElapse:i.eventElapse,elapse:a-n.startTime,success:i.succ,errorCode:i.ec,video:i.video,audio:i.audio,subscribeRequestid:i.subscribeRequestid,p2pid:i.p2pid},r&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof i.peerid=="string"?l.peerSuid=i.peerid:l.peer=i.peerid,this.send({type:kt.SUBSCRIBE,data:l},!0)}wsCompressorInit(t){var i;let r=[...Yr(i=this.baseInfoMap).call(i)],n=r.length?r[0]:"UnableToGetSid",o=this.baseInfoMap.get(n);if(!o)return;let a=o.info,l=Date.now(),d=Me(Me({},a),{},{eventType:vi.WS_COMPRESSOR_INIT,lts:l,eventElapse:t.eventElapse,elapse:l-o.startTime,status:t.status?1:2});this.send({type:kt.WS_COMPRESSOR_INIT,data:d},!0)}firstRemoteVideoDecode(t,i,r,n){let o=this.baseInfoMap.get(t);if(!o)return;let a=o.info,l=Date.now(),d=Me(Me(Me({},a),n),{},{elapse:l-o.startTime,eventType:i,lts:l,firstDecodeFrame:Math.max(l-o.startTime,0),apEnd:Math.max(n.apEnd-o.startTime,0),apStart:Math.max(n.apStart-o.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-o.startTime,0),joinGwStart:Math.max(n.joinGwStart-o.startTime,0),pcEnd:Math.max(n.pcEnd-o.startTime,0),pcStart:Math.max(n.pcStart-o.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-o.startTime,0),subscriberStart:Math.max(n.subscriberStart-o.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-o.startTime,0)});this.send({type:r,data:d},!0)}firstRemoteFrame(t,i,r,n){let o=this.baseInfoMap.get(t);if(!o)return;let a=o.info,l=Date.now(),d=Me(Me(Me({},a),n),{},{elapse:l-o.startTime,eventType:i,lts:l});this.send({type:r,data:d},!0)}pcStats(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me(Me({},n),i),{},{vid:n.vid===void 0?0:Number(n.vid),elapse:o-r.startTime,eventType:vi.PC_STATS,lts:o});this.send({type:kt.PC_STATS,data:a},!0)}updateRemoteRTPCapabilities(t,i){if(t){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me(Me({},n),i),{},{vid:n.vid===void 0?0:Number(n.vid),eventType:vi.UPDATE_REMOTE_RTPCAPABILITIES,lts:o});this.send({type:kt.UPDATE_REMOTE_RTPCAPABILITIES,data:a},!0)}}onGatewayStream(t,i,r,n){let o=this.baseInfoMap.get(t);if(!o)return;let a=o.info,l=Date.now(),d=Me(Me(Me({},a),n),{},{eventType:i,lts:l});this.send({type:r,data:d},!0)}streamSwitch(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me({},n),{},{eventType:vi.STREAM_SWITCH,lts:o,isDual:i.isdual,elapse:o-r.startTime,success:i.succ});this.send({type:kt.STREAM_SWITCH,data:a},!0)}requestProxyAppCenter(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me({},n),{},{eventType:vi.REQUEST_PROXY_APPCENTER,lts:o,eventElapse:o-i.lts,elapse:o-r.startTime,APAddr:i.APAddr,workerManagerList:i.workerManagerList,response:i.response,errorCode:i.ec,success:i.succ});this.send({type:kt.REQUEST_PROXY_APPCENTER,data:a},!0)}requestProxyWorkerManager(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me({},n),{},{eventType:vi.REQUEST_PROXY_WORKER_MANAGER,lts:o,eventElapse:o-i.lts,elapse:o-r.startTime,workerManagerAddr:i.workerManagerAddr,response:i.response,errorCode:i.ec,success:i.succ});this.send({type:kt.REQUEST_PROXY_WORKER_MANAGER,data:a},!0)}setProxyServer(t){this.proxyServer=t,t?S.debug("reportProxyServerurl: ".concat(t)):S.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me({},n),{},{subscribeElapse:i.subscribeElapse,peer:i.peer,peerPublishDuration:Math.max(i.audioPublishDuration,i.videoPublishDuration),audiotag:i.audioPublishDuration>0?1:-1,videotag:i.videoPublishDuration>0?1:-1,lts:o,elapse:o-r.startTime,joinChannelSuccessElapse:o-(r.lastJoinSuccessTime||o),peerPublishDurationVideo:i.videoPublishDuration,peerPublishDurationAudio:i.audioPublishDuration});this.send({type:kt.PEER_PUBLISH_STATUS,data:a},!0)}workerEvent(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now();(function(a,l,d){let u=a[l];if(!u||typeof u!="string")return[a];a[l]="";let p=Bo(JSON.stringify(a)),m=0,f=[],E=0;for(let I=0;I<u.length;I++)E+=u.charCodeAt(I)<=127?1:3,E<=d-p||(f[f.length]=fe(fe({},a),{},{[l]:u.substring(m,I)}),m=I,E=u.charCodeAt(I)<=127?1:3);return m!==u.length-1&&(f[f.length]=fe(fe({},a),{},{[l]:u.substring(m)})),f})(Me(Me(Me({},n),i),{},{elapse:o-r.startTime,lts:o,productType:"WebRTC"}),"payload",1300).forEach(a=>this.send({type:kt.WORKER_EVENT,data:a},!0))}apworkerEvent(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me(Me({},n),i),{},{elapse:o-r.startTime,lts:o});this.send({type:kt.AP_WORKER_EVENT,data:a},!0)}joinWebProxyAP(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me(Me({},n),i),{},{elapse:o-r.startTime,lts:o,extend:i.extend||void 0});this.send({type:kt.JOIN_WEB_PROXY_AP,data:a},!0)}WebSocketQuit(t,i){let r=this.baseInfoMap.get(t);if(!r)return;let n=r.info,o=Date.now(),a=Me(Me(Me({},n),i),{},{elapse:o-r.startTime,lts:o});this.send({type:kt.WEBSOCKET_QUIT,data:a},!0)}async sendCustomReportMessage(t,i){if(this.customReportCount+=i.length,this.customReportCount>N("CUSTOM_REPORT_LIMIT"))throw new j(A.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));let r=Date.now(),n=i.map(o=>({type:kt.USER_ANALYTICS,data:Me(Me({sid:t},o),{},{lts:r})}));try{N("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(n):await this.postDataToStatsCollector(n)}catch(o){throw S.error("send custom report message failed",o.toString()),new j(A.CUSTOM_REPORT_SEND_FAILED,o.message)}}sendApiInvoke(t){let i=N("NOT_REPORT_EVENT");if(t.tag&&se(i)&&se(i).call(i,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;let r=this.baseInfoMap.get(t.sid);if(!r)return this.apiInvokeUploadPendingItems.push(t),!1;let{cname:n,uid:o,cid:a}=r.info,l;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof j){let{code:u,message:p}=t.error;l=u||p||t.error.toString()}else l=t.error.toString();let d={invokeId:t.invokeId,sid:t.sid,cname:n,cid:a,uid:o,lts:t.lts,success:t.success,elapse:t.lts-r.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?l:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:kt.API_INVOKE,data:d},!1),!0}appendSessionId(){vu.__CLIENT_LIST__.forEach(t=>{if(t._sessionId){let i=this.apiInvokeUploadPendingItems.length;for(let r=0;r<i;r++){let n=this.apiInvokeUploadPendingItems.shift();n&&(n.sid=t._sessionId,this.sendApiInvoke(Object.assign({},n)))}}})}send(t,i){if(i)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>N("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,i){let r=[],n=[];for(;t.length;){let a=t.shift();r.length<20?r.push(a):n.push(a)}t.push(...n);for(let a of[...r]){var o;this.ltsList.indexOf(a.data.lts)!==-1?(a.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(a.data.lts)):(this.ltsList.push(a.data.lts),tu(o=this.ltsList).call(o,(l,d)=>l-d))}return i||(this.lastSendNormalEventTime=Date.now()),N("ENABLE_EVENT_REPORT")&&r.length&&(N("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(r):this.postDataToStatsCollector(r)).catch((a=>l=>{N("EVENT_REPORT_RETRY")&&(i?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(a):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(a),this.normalEventUploadPendingItems.length>N("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-N("NORMAL_EVENT_QUEUE_CAPACITY")),S.warning("report: drop normal events"))))})(r)),t}async postDataToStatsCollector2(t){Vt.networkState===ir.OFFLINE&&await ne.race([Vt.onlineWaiter,mi(2*Jt.maxRetryTimeout)]);let i=o=>{let a=new Uint8Array;return o.forEach(l=>{let d=PS(JSON.stringify(l.data)),u=new ArrayBuffer(5),p=(f=>{let E=0;return Object.entries(kt).forEach(I=>{let[T,R]=I;R===f.type&&(E=EventNameToID[T])}),E})(l),m=new DataView(u);m.setUint16(0,d.byteLength,!0),m.setUint8(2,255&p),m.setUint8(3,p>>>8&255),m.setUint8(4,p>>>16&255),a=Ab(a,new Uint8Array(u)),a=Ab(a,d)}),a},r="event",n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(N("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(r):"https://".concat(N("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(r);for(let o=0;o<2;o+=1){o===1&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(N("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(r):"https://".concat(N("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(r));try{await VS(n,{timeout:1e4,data:i(t),headers:Me(Me({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(a){if(o===1)throw a;continue}return}}async postDataToStatsCollector(t){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1],r={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(a=>JSON.stringify(a)),vid:(a=>{let l=a&&a.data.sid&&this.baseInfoMap.get(a.data.sid);return l&&l.info.vid&&+l.info.vid||0})(t[0])};Vt.networkState===ir.OFFLINE&&await ne.race([Vt.onlineWaiter,mi(2*Jt.maxRetryTimeout)]);let n=i?"/events/proto-raws":"/events/messages",o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(N("EVENT_REPORT_DOMAIN"),"&p=").concat(N("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(N("EVENT_REPORT_DOMAIN"),":").concat(N("STATS_COLLECTOR_PORT")).concat(n));for(let a=0;a<2;a+=1){a===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(N("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(N("STATS_COLLECTOR_PORT"),"&d=").concat(n):"https://".concat(N("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(N("STATS_COLLECTOR_PORT")).concat(n)));try{i?await v8(o,{timeout:1e4,data:r}):await VS(o,{timeout:1e4,data:r})}catch(l){if(a===1)throw l;continue}return}}createBaseInfo(t,i){let r=Object.assign({},A8);return r.sid=t,this.baseInfoMap.set(t,{info:r,startTime:i}),r}reportResourceTiming(t,i){let r=performance.getEntriesByName(t),n=r[r.length-1];n&&this.reportApiInvoke(i,{name:"Client.resourceTiming",options:n,tag:xt.TRACER}).onSuccess()}}function Ce(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,i,r){let n=r.value;if(typeof n=="function"){let o=e.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);r.value=function(){for(var a=arguments.length,l=new Array(a),d=0;d<a;d++)l[d]=arguments[d];let u=l;if(e.argsMap)try{u=e.argsMap(this,...l)}catch(m){S.warning(m),u=[]}try{JSON.stringify(u)}catch{S.warning("arguments for method ".concat(o,".").concat(String(i)," not serializable for apiInvoke.")),u=[]}let p=(e.report||_e).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(String(i)),options:u,tag:xt.TRACER,reportResult:e.reportResult},e.throttleTime);try{let m=n.apply(this,l);return m instanceof ne?m.then(f=>(p.onSuccess(e.reportResult&&f),f)).catch(f=>{throw p.onError(f),f}):(p.onSuccess(e.reportResult&&m),m)}catch(m){throw p.onError(m),m}}}return r}}Gt(vu,"__CLIENT_LIST__",[]);let _e=new vu;Kb.on("REPORT_LOG_UPLOAD",e=>{e.networkState=Vt.networkState,_e.reportApiInvoke(null,{name:"logUploadError",options:e,tag:xt.TRACER}).onSuccess("logUploadError")});let O8=["CHINA","GLOBAL"],Li=function(){let e="us".concat("erna","me"),t="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");let r=i.join(""),n=[];for(let l=0;l<6;l++)n.push("1");let o=n.join(""),a={};return a[e]=r,a[t]=o,Object.assign(a,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Li,FS||(oi.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],oi.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],oi.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],oi.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],oi.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],oi.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],oi.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",oi.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",oi.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",oi.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",oi.AREAS=["NORTH_AMERICA","OVERSEA"]);let qb=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],Zs=[];function sc(e,t){return!!t&&Zs.some(i=>i.uid===e&&i.channelName===t)}vu.__CLIENT_LIST__=Zs;var b8=RA.forEach,Jb=ap("forEach")?[].forEach:function(e){return b8(this,e,arguments.length>1?arguments[1]:void 0)};Tt({target:"Array",proto:!0,forced:[].forEach!=Jb},{forEach:Jb});var N8=Pn("Array").forEach,D8=Lo,P8=Fi,k8=$,L8=N8,WS=Array.prototype,M8={DOMTokenList:!0,NodeList:!0},U8=function(e){var t=e.forEach;return e===WS||k8(WS,e)&&t===WS.forEach||P8(M8,D8(e))?L8:t},x8=g(U8),V8=ko,Xb=hp;Tt({target:"Object",stat:!0,forced:v(function(){Xb(1)})},{keys:function(e){return Xb(V8(e))}});var Qb=g(so.Object.keys),F8=g(Wy),j8=Tt,B8=nu,G8=K([].reverse),Zb=[1,2];j8({target:"Array",proto:!0,forced:String(Zb)===String(Zb.reverse())},{reverse:function(){return B8(this)&&(this.length=this.length),G8(this)}});var W8=Pn("Array").reverse,H8=$,K8=W8,HS=Array.prototype,z8=function(e){var t=e.reverse;return e===HS||H8(HS,e)&&t===HS.reverse?K8:t},$b=z8,Y8=g($b),q8=Tt,eN=nu,J8=yp,X8=zr,tN=pE,Q8=cs,Z8=xs,$8=xp,ez=qt,tz=YE,iz=hA("slice"),rz=ez("species"),KS=Array,nz=Math.max;q8({target:"Array",proto:!0,forced:!iz},{slice:function(e,t){var i,r,n,o=Z8(this),a=Q8(o),l=tN(e,a),d=tN(t===void 0?a:t,a);if(eN(o)&&(i=o.constructor,(J8(i)&&(i===KS||eN(i.prototype))||X8(i)&&(i=i[rz])===null)&&(i=void 0),i===KS||i===void 0))return tz(o,l,d);for(r=new(i===void 0?KS:i)(nz(d-l,0)),n=0;l<d;l++,n++)l in o&&$8(r,n,o[l]);return r.length=n,r}});var oz=Pn("Array").slice,sz=$,az=oz,zS=Array.prototype,cz=function(e){var t=e.slice;return e===zS||sz(zS,e)&&t===zS.slice?az:t},lz=g(cz);function ie(e,t,i,r,n){var o,a,l,d={};return x8(o=Qb(r)).call(o,function(u){d[u]=r[u]}),d.enumerable=!!d.enumerable,d.configurable=!!d.configurable,("value"in d||d.initializer)&&(d.writable=!0),d=F8(a=Y8(l=lz(i).call(i)).call(l)).call(a,function(u,p){return p(e,t,u)||u},d),n&&d.initializer!==void 0&&(d.value=d.initializer?d.initializer.call(n):void 0,d.initializer=void 0),d.initializer===void 0&&(cA(e,t,d),d=null),d}var dz=Pn("Array").values,uz=Lo,hz=Fi,pz=$,mz=dz,YS=Array.prototype,_z={DOMTokenList:!0,NodeList:!0},fz=function(e){var t=e.values;return e===YS||pz(YS,e)&&t===YS.values||hz(_z,uz(e))?mz:t},ho=g(fz);let Ez=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),Jr=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({}),Sm=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),qS=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),Un=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),rr=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),Re=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),Be=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),de=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e}({}),Se=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e}({}),ac=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),Oe=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e}({}),nr=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),Ae=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({});class U extends j{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),y(this,"name","AgoraRTCException")}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(t,S)}throw(){super.throw(S)}}function Tm(e){if(typeof e!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw S.error("Invalid Channel Name ".concat(e)),new U(A.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function vm(e){if(!function(t){return typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295}(e)&&!Cb(e,1,255))throw new U(A.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");typeof e=="string"&&S.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Ri=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming",e}({}),Al=function(e){return e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN",e}({}),gz={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},JS={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function XS(e,t){Ai(e.url,"".concat(t,".url"),1,1e3,!1),Ut(e.x)||ut(e.x,"".concat(t,".x"),0,1e4),Ut(e.y)||ut(e.y,"".concat(t,".y"),0,1e4),Ut(e.width)||ut(e.width,"".concat(t,".width"),0,1e4),Ut(e.height)||ut(e.height,"".concat(t,".height"),0,1e4),Ut(e.zOrder)||ut(e.zOrder,"".concat(t,".zOrder"),0,255),Ut(e.alpha)||ut(e.alpha,"".concat(t,".alpha"),0,1,!1)}let Sz={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Tz={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30},Go=function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e}({}),Rm=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({}),si=function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e}({});function iN(e){if(!e.channelName)throw new U(A.INVALID_PARAMS,"invalid channelName in info");if(typeof e.uid!="number")throw new U(A.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&Ai(e.token,"info.token",1,2047),vm(e.uid),Tm(e.channelName),!0}let or=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),ps=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),vr=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),Ol=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),ot=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),Wt=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal",e}({}),Ru=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),_i=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),rN=function(e){return e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel",e}({}),et=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({}),nN=[et.AFRICA,et.ASIA,et.CHINA,et.EUROPE,et.GLOBAL,et.INDIA,et.JAPAN,et.NORTH_AMERICA,et.OCEANIA,et.OVERSEA,et.SOUTH_AMERICA],Bi=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({}),Cm={CHINA:{},ASIA:{CODE:Bi.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:Bi.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:Bi.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:Bi.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:Bi.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:Bi.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:Bi.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:Bi.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:Bi.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:Bi.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:Bi.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:Bi.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:Bi.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};FS&&(Cm.CHINA={CODE:Bi.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let QS=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e}({});class oN extends Ot{constructor(t,i){super(),y(this,"onICEConnectionStateChange",void 0),y(this,"onConnectionStateChange",void 0),y(this,"onDTLSTransportStateChange",void 0),y(this,"onDTLSTransportError",void 0),y(this,"onICETransportStateChange",void 0),y(this,"onFirstAudioReceived",void 0),y(this,"onFirstVideoReceived",void 0),y(this,"onFirstAudioDecoded",void 0),y(this,"onFirstVideoDecoded",void 0),y(this,"onFirstVideoDecodedTimeout",void 0),y(this,"onSelectedLocalCandidateChanged",void 0),y(this,"onSelectedRemoteCandidateChanged",void 0),y(this,"getLocalVideoStats",void 0)}}class ym extends oN{constructor(t,i){super(t,i),y(this,"establishPromise",void 0)}}let me=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),Ji=function(e){return e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY",e}({}),ms=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({}),Q=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),st=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),ye=function(e){return e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e}({}),xn=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Vn=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),Ci=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),$s=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),ii=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e}({}),Wo=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),fn=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),po=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),bl=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),Ht=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),Nl=function(e){return e.ABORT="abort",e}({}),ea=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),vz=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({}),Rz={[Sm.ACCESS_POINT]:{[rr.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[rr.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[rr.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[rr.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[rr.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[rr.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[rr.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Sm.UNILBS]:{[Un.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Un.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Un.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Un.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Un.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Un.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Un.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Un.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Un.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Un.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Un.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Un.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Sm.STRING_UID_ALLOCATOR]:{[qS.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[qS.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[qS.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Dl(e){let t=Rz[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};let i=t[e%1e4];if(!i){if(Math.floor(e/1e4)===Sm.ACCESS_POINT){let r=e%1e4;if(r.toString()[0]==="1")return{desc:e.toString(),retry:!1};if(r.toString()[0]==="2")return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return i}let Cz={[Re.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Re.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Re.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Re.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Re.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Re.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Re.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Re.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Re.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Re.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Re.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Re.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Re.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Re.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Re.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Re.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Re.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Re.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Re.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Re.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Re.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Re.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Re.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Re.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Re.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Re.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Re.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Re.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Re.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Re.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Re.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Re.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Re.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Re.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Re.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Re.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Re.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Re.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Re.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Re.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Re.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Re.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Re.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Re.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Re.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Re.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Re.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Re.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Re.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Re.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Re.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Re.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Re.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Re.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Re.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Re.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Re.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Re.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Re.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Re.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Re.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Re.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Re.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function cc(e){return Cz[e]||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function sN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function ZS(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?sN(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):sN(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function aN(e){return e.every(t=>t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING)}function cN(e,t){if(typeof e=="string")return e;let{proxy:i,host:r,port:n}=e;if(t){let o=N("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(r,"/ws/?p=").concat(Number(n)+150):"wss://".concat(r,":").concat(o,"/ws/?p=").concat(Number(n)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(r,"&p=").concat(n):"wss://".concat(r,":").concat(n)}let yz=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,Iz=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,wz=/wss:\/\/(.+):([0-9]+)\/?/,Az=/wss:\/\/(.[^\/]+)\/?/,Oz=0;class bz{constructor(t,i){y(this,"id",0),y(this,"store",void 0),y(this,"recordIndex",void 0),y(this,"websockets",[]),y(this,"try443PortDuration",2e3),y(this,"forceCloseWSDuration",5e3),y(this,"try443PortTimeout",null),y(this,"forceCloseTimeout",null),y(this,"isTry443PortFailed",!1),y(this,"isNormalPortFailed",!1),y(this,"useDoubleDomain",!1),y(this,"useProxy",!1),y(this,"startTime",Date.now()),this.id=++Oz,this.try443PortDuration=N("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=i}closeAllWebsockets(){this.websockets.forEach(t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var t;let i=Date.now()-this.startTime;for(var r=arguments.length,n=new Array(r),o=0;o<r;o++)n[o]=arguments[o];S.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...n)}createWebSocket(t,i,r){this.logger("createWebSocket:",t,{isTry443Port:i,hasTimeoutDetection:r});let n=N("GATEWAY_DOMAINS"),o=Date.now(),a=[],l=n.find(p=>{var m;return se(m=t.host).call(m,p)});l||(this.useDoubleDomain=!1);let d=[];if(this.useDoubleDomain)n.forEach(p=>{d.push(cN(ZS(ZS({},t),{},{host:t.host.replace(l,p)}),i))});else{let p=ZS({},t);if(i&&l){let m=n.find(f=>f!==l);m&&(p.host=p.host.replace(l,m))}d.push(cN(p,i))}try{d.forEach(p=>{let m=new WebSocket(p);m.binaryType="arraybuffer",a.push(m),this.logger("ws is connecting:",m.url)})}catch(p){if(this.logger("ws create failed"),a.forEach(m=>m.close()),a.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,i,r);if(!i&&Number(t.port)!==443)return this.createWebSocket(t,!0,r);throw new U(A.WS_ERR,"init websocket failed! Error: ".concat(p.toString()))}let u=_u();return this.store&&this.store.recordJoinChannelService({urls:a.map(p=>p.url),service:"gateway"},this.recordIndex),a.forEach(p=>{p.onopen=()=>{this.logger("onopen: ws ".concat(p.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(m=>{m!==p&&(m.onopen=null,m.onclose=null,m.onmessage=null,m.close(),this.logger("close backup websocket: ".concat(m.url)))}),this.websockets.length=0,u.resolve(p)},p.onclose=m=>{this.logger("onclose: ws ".concat(p.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(p.readyState)),i?this.isTry443PortFailed=aN(a):this.isNormalPortFailed=aN(a),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(i&&this.isTry443PortFailed||!i&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(m.reason)),u.reject({code:m.code,reason:Ru.A_ROUND_WS_FAILED}))},p.onmessage=m=>this.logger("".concat(p.url," onmessage: ").concat(m.data))}),this.websockets.push(...a),r||(()=>{let p=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",u.isResolved),this.websockets.forEach(m=>m.readyState!==WebSocket.OPEN&&m.close())};if(i||this.useProxy)return this.logger("add 5s timeout at ".concat(i?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(p,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",u.isResolved),u.isResolved)return p();Xe().os===hi.MAC_OS&&mt()&&p(),this.createWebSocket(t,!0,!0).then(m=>u.resolve(m)).catch(m=>{this.isNormalPortFailed&&u.reject(m),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(p,this.forceCloseWSDuration)},this.try443PortDuration)})(),u.promise}chooseBestWebsocket(t,i,r,n){return this.useDoubleDomain=!!i,typeof t=="string"&&(t=function(o){let a,l,d;return[,a,l,d]=o.match(yz)||[],a||([,l,d]=o.match(Iz)||[]),l&&d||([,l,d]=o.match(wz)||[]),l&&d||([,l]=o.match(Az)||[]),l||S.warning("un-destructible url: ",o),{proxy:a,host:l,port:d||"443"}}(t)),this.recordIndex=n,this.useProxy=!!t.proxy,r&&this.useProxy&&(S.warn("cannot use 443 only when use proxy"),r=!1),this.createWebSocket(t,!!r,!1).finally(()=>this.clearTimeout())}}function lN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}class dN extends Ot{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var i;se(i=["tryNext","recover"]).call(i,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(Ae.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Ae.CONNECTED):this._state==="closed"?this.emit(Ae.CLOSED):this._state==="failed"&&this.emit(Ae.FAILED))}resetReconnectCount(t){S.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,i){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2],n=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],a=arguments.length>5?arguments[5]:void 0;super(),y(this,"connectionID",0),y(this,"currentURLIndex",0),y(this,"urls",[]),y(this,"_reconnectMode","tryNext"),y(this,"reconnectReason",void 0),y(this,"_initMutex",new Ti("websocket")),y(this,"name",void 0),y(this,"_state","closed"),y(this,"reconnectInterrupter",void 0),y(this,"websocket",void 0),y(this,"retryConfig",void 0),y(this,"reconnectCount",0),y(this,"forceCloseTimeout",5e3),y(this,"onlineReconnectListener",void 0),y(this,"useCompress",void 0),y(this,"tryDoubleDomain",!1),y(this,"use443PortOnly",!1),y(this,"wsInflateLength",0),y(this,"wsDeflateLength",0),y(this,"closeEstablishingWs",()=>{}),y(this,"store",void 0),y(this,"joinGatewayRecordIndex",void 0),this.store=a,this.name=t,this.retryConfig=function(m){for(var f=1;f<arguments.length;f++){var E=arguments[f]!=null?arguments[f]:{};f%2?lN(Object(E),!0).forEach(function(I){y(m,I,E[I])}):Object.getOwnPropertyDescriptors?Object.defineProperties(m,Object.getOwnPropertyDescriptors(E)):lN(Object(E)).forEach(function(I){Object.defineProperty(m,I,Object.getOwnPropertyDescriptor(E,I))})}return m}({},i),this.useCompress=r,this.tryDoubleDomain=n,this.use443PortOnly=o;let{timeout:l,timeoutFactor:d}=i,u=Math.max(300,Math.floor(3*l/5)),p=Math.max(1.2,Math.floor(8*d)/10);ir.ONLINE&&(this.retryConfig.timeout=u,this.retryConfig.timeoutFactor=p),Vt.on(tc.NETWORK_STATE_CHANGE,(m,f)=>{m!==f&&(this.resetReconnectCount("network state change: ".concat(f," -> ").concat(m)),m===ir.ONLINE?(this.retryConfig.timeout=u,this.retryConfig.timeoutFactor=p):(this.retryConfig.timeout=l,this.retryConfig.timeoutFactor=d))})}getConnection(){return this.websocket||void 0}async init(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,r=await this._initMutex.lock();this.forceCloseTimeout=i,this.urls=t,this.state="connecting";try{let n=_u(),o=this.urls[this.currentURLIndex];this.createWebSocketConnection(o).then(n.resolve).catch(n.reject),this.once(Ae.CLOSED,()=>{n.reject(new j(A.WS_DISCONNECT))}),this.once(Ae.CONNECTED,n.resolve),await n.promise}catch{}finally{r()}}close(t,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;let r=this.websocket;i?setTimeout(()=>r.close(),500):r.close(),this.websocket=void 0}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,i){if(!this.websocket)return void S.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),S.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);let r=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),r&&r.bind(this.websocket)({code:9999,reason:i})}sendMessage(t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new j(A.WS_ABORT,"websocket is not ready");try{i||(t=JSON.stringify(t)),this.websocket.send(t)}catch(r){throw new j(A.WS_ERR,"send websocket message error"+r.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){let t=this.wsInflateLength,i=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:i}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var i;let r=_u();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;let n=p=>{var m;(m=this.store)===null||m===void 0||m.signalChannelOpen(),S.debug("[".concat(this.name,"] websocket opened:"),p),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),r.resolve()},o=async p=>{var m;if(S.debug("[".concat(this.name,"] websocket close ").concat((m=this.websocket)===null||m===void 0?void 0:m.url,", code: ").concat(p.code,", reason: ").concat(p.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)r.reject(new j(A.WS_DISCONNECT,"websocket close: ".concat(p.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=p.reason,this.state="reconnecting");let f=Ur(this,Ae.WILL_RECONNECT,this.reconnectMode,p.reason)||this.reconnectMode,E=await this.reconnectWithAction(f);if(this.state==="closed")return void S.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!E)return r.reject(new j(A.WS_DISCONNECT,"websocket reconnect failed: ".concat(p.code))),this.close(!0);r.resolve()}},a=p=>{this.emit(Ae.ON_MESSAGE,p)},l=p=>{S.warn("[".concat(this.connectionID,"] ws open error ").concat(p))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),N("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=N("GATEWAY_WSS_ADDRESS")),S.debug("[".concat(this.name,"] start connect, url:"),t);let d=(i=this.store)===null||i===void 0?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var u;let p=await this.chooseBestWebsocketConnection(t);this.websocket=p,n&&n(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=a,this.websocket.onerror=l,(u=this.store)===null||u===void 0||u.recordJoinChannelService({endTs:Date.now(),status:"success"},d),this.joinGatewayRecordIndex=d}catch(p){let m=this.state==="closed",f=p instanceof j,E=f&&p.code===A.WS_ABORT,I=f&&p.code===A.WS_ERR,T=f?p.message:p&&(p.reason||p.toString());S.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(T)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:E?"aborted":"error",errors:[p]},d),m||I?(r.reject(m?new j(A.WS_DISCONNECT,"websocket is closed: ".concat(T)):new j(A.WS_ERR,"init websocket failed: ".concat(T))),I&&S.error("[".concat(this.name,"] init websocket failed: ").concat(T))):o&&o(p)}return r.promise}async reconnectWithAction(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;S.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||Vt.isOnline||!Vt.onlineWaiter||(this.onlineReconnectListener=Vt.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let r=!0;if(this.reconnectInterrupter=()=>r=!1,i){let a=_m(this.reconnectCount,this.retryConfig);S.debug("[".concat(this.name,"] wait ").concat(a,"ms to reconnect websocket, mode: ").concat(t)),await ne.race([mi(a),this.onlineReconnectListener||new ne(()=>{})])}if(this._state==="closed"||!r)return!1;this.reconnectCount+=1;let n=async(a,l)=>{this.emit(Ae.RECONNECT_CREATE_CONNECTION,l),await this.createWebSocketConnection(a)};try{if(t==="retry")this.emit(Ae.RECONNECT_WAITTING_FINISH,t),await n(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);S.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(Ae.RECONNECT_WAITTING_FINISH,t),await n(this.urls[this.currentURLIndex],t)}else t==="recover"&&(S.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(Ae.RECONNECT_WAITTING_FINISH,t),this.urls=await ti(this,Ae.REQUEST_NEW_URLS),this.currentURLIndex=0,await n(this.urls[this.currentURLIndex],t))}catch(a){var o;S.error("[".concat(this.name,"] reconnect failed ").concat(a&&a.toString()));let l=a==null||(o=a.data)===null||o===void 0?void 0:o.desc;return Array.isArray(l)&&se(l).call(l,"dynamic key expired")?(this.emit(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(t,i)}return!0}}class Cu extends dN{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,i){let r=_u(),n=function(a,l){return new bz(a,l)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{S.debug("[choose-best-ws] close establishing websockets"),n.closeAllWebsockets(),r.reject(new j(A.WS_ABORT,"choose best websocket aborted"))};let o=N("GATEWAY_DOMAINS");return S.debug("[choose-best-ws] currentDomain: ",t,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),n.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,i).then(r.resolve).catch(r.reject),r.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class yu extends dN{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,i){return new ne((r,n)=>{let o=!1,a=[];this.closeEstablishingWs=()=>{S.debug("[choose-best-ws] close establishing websockets"),a.forEach(I=>{I.onclose=null,I.onopen=null,I.onmessage=null,I.close()}),n(new j(A.WS_ABORT,"choose best websocket aborted"))};let l=N("GATEWAY_DOMAINS"),d,u=t.indexOf("?h="),p=l.find(I=>u!==-1?se(t).call(t,I,u):se(t).call(t,I));S.debug("[choose-best-ws] currentDomain: ",p,", domains: ",l);let m=!this.tryDoubleDomain||!p;if(!m&&p){var f;let I=Date.now();try{l.forEach(T=>{let R=u===-1?t.replace(p,T):t.substr(0,u)+t.substr(u).replace(p,T),w=new WebSocket(R);w.binaryType="arraybuffer",a.push(w),S.debug("[choose-best-ws] ws is connecting:",w.url)})}catch{for(S.debug("[choose-best-ws] ws create failed, fallback to single url"),a.forEach(T=>T.close());a.length;)a.pop();m=!0}(f=this.store)===null||f===void 0||f.recordJoinChannelService({urls:a.map(T=>T.url),service:"gateway"},i),a.forEach(T=>{T.onopen=()=>{if(o)return;let R=Date.now()-I;S.debug("[choose-best-ws] ws open cost ".concat(R,"ms")),a.filter(w=>w!==T).forEach(w=>{S.debug("[choose-best-ws]close backup websocket: ".concat(w.url)),w.close()}),o=!0,r(T)},T.onclose=R=>{d=R,!o&&(a.find(w=>!(w.readyState===WebSocket.CLOSED||w.readyState===WebSocket.CLOSING))||(S.debug("[choose-best-ws] all websocket is closed"),o=!0,n(d)))},T.onmessage=R=>{S.debug("[choose-best-ws]".concat(T.url," onmessage: ").concat(R.data))}}),mi(this.forceCloseTimeout).then(()=>{a.forEach(T=>{T.readyState!==WebSocket.OPEN&&T.close()})})}if(m){var E;let I;S.debug("[choose-best-ws] use single url: ",t),(E=this.store)===null||E===void 0||E.recordJoinChannelService({urls:[t],service:"gateway"},i);try{I=new WebSocket(t),a.push(I),I.binaryType="arraybuffer"}catch(T){let R=new j(A.WS_ERR,"init websocket failed! Error: ".concat(T.toString()));return S.error("[".concat(this.name,"]").concat(R)),void n(R)}I.onopen=()=>{r(I)},I.onclose=T=>{n(T)},I.onmessage=T=>{S.debug("[choose-best-ws]".concat(I.url," onmessage: ").concat(T.data))},mi(this.forceCloseTimeout).then(()=>{I&&I.readyState!==WebSocket.OPEN&&I.close()})}}).then(r=>(this.closeEstablishingWs=void 0,r)).catch(r=>{throw this.closeEstablishingWs=void 0,r})}}class uN extends Ot{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Be.CONNECTED?this.emit(de.WS_CONNECTED):t===Be.RECONNECTING?this.emit(de.WS_RECONNECTING,this._websocketReconnectReason):t===Be.CLOSED&&this.emit(de.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,i){super(),y(this,"_disconnectedReason",void 0),y(this,"_websocketReconnectReason",void 0),y(this,"_connectionState",Be.CLOSED),y(this,"reconnectToken",void 0),y(this,"websocket",void 0),y(this,"openConnectionTime",void 0),y(this,"clientId",void 0),y(this,"lastMsgTime",Date.now()),y(this,"uploadCache",[]),y(this,"uploadCacheInterval",void 0),y(this,"rttRolling",new US(5)),y(this,"pingpongTimer",void 0),y(this,"wsInflateDataTimer",void 0),y(this,"pingpongTimeoutCount",0),y(this,"joinResponse",void 0),y(this,"multiIpOption",void 0),y(this,"initError",void 0),y(this,"spec",void 0),y(this,"store",void 0),y(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(de.ON_BINARY_DATA,r.data);let n=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(n,"_id")){let o="res-@".concat(n._id);this.emit(o,n._result,n._message)}else if(Object.prototype.hasOwnProperty.call(n,"_type")){if(this.emit(n._type,n._message),n._type===Oe.ON_NOTIFICATION&&this.handleNotification(n._message),n._type===Oe.ON_USER_BANNED)switch(n._message.error_code){case 14:this.close(Ge.UID_BANNED);break;case 15:this.close(Ge.IP_BANNED);break;case 16:this.close(Ge.CHANNEL_BANNED)}if(n._type===Oe.ON_USER_LICENSE_BANNED)switch(n._message.error_code){case Re.ERR_LICENSE_MISSING:this.close(Ge.LICENSE_MISSING);break;case Re.ERR_LICENSE_EXPIRED:this.close(Ge.LICENSE_EXPIRED);break;case Re.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ge.LICENSE_MINUTES_EXCEEDED);break;case Re.ERR_LICENSE_PERIOD_INVALID:this.close(Ge.LICENSE_PERIOD_INVALID);break;case Re.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ge.LICENSE_MULTIPLE_SDK_SERVICE);break;case Re.ERR_LICENSE_ILLEGAL:this.close(Ge.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new Cu("gateway-".concat(this.clientId),this.spec.retryConfig,!0,N("JOIN_GATEWAY_USE_DUAL_DOMAIN"),N("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Be.CONNECTED&&this.reconnect("retry",ki.OFFLINE)})}async request(t,i,r,n){let o=ft(6,""),a={_id:o,_type:t,_message:i},l=this.websocket.connectionID,d=()=>new ne((I,T)=>{if(this.connectionState===Be.CONNECTED)return I();let R=()=>{this.off(de.WS_CLOSED,w),I()},w=()=>{this.off(de.WS_CONNECTED,R),T(new U(A.WS_ABORT))};this.once(de.WS_CONNECTED,R),this.once(de.WS_CLOSED,w),t!==Se.PUBLISH&&t!==Se.PUBLISH_DATASTREAM&&t!==Se.SUBSCRIBE&&t!==Se.SUBSCRIBE_DATASTREAM&&t!==Se.UNSUBSCRIBE&&t!==Se.UNSUBSCRIBE_DATASTREAM&&t!==Se.UNPUBLISH&&t!==Se.UNPUBLISH_DATASTREAM&&t!==Se.CONTROL&&t!==Se.RESTART_ICE||this.once(de.DISCONNECT_P2P,()=>{T(new U(A.DISCONNECT_P2P))}),t!==Se.PUBLISH&&t!==Se.RESTART_ICE||this.once(de.ABORT_P2P_EXECUTION,()=>{T(new U(A.DISCONNECT_P2P))})});if(this.connectionState!==Be.CONNECTING&&this.connectionState!==Be.RECONNECTING||t===Se.JOIN||t===Se.REJOIN||await d(),this.websocket.sendMessage(a,!0),n)return;let u=new ne((I,T)=>{let R=!1,w=(P,M)=>{R=!0,I({isSuccess:P==="success",message:M||{}}),this.off(de.WS_CLOSED,O),this.off(de.WS_RECONNECTING,O),this.emit(de.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(o),w);let O=()=>{T(new U(A.WS_ABORT,"type: ".concat(t))),this.off(de.WS_CLOSED,O),this.off(de.WS_RECONNECTING,O),this.off("res-@".concat(o),w)};this.once(de.WS_CLOSED,O),this.once(de.WS_RECONNECTING,O),mi(N("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==l||R||(S.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(de.REQUEST_TIMEOUT,t,i))})}),p=null;try{p=await u}catch(I){if(this.connectionState===Be.CLOSED||t===Se.LEAVE)throw new U(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?I.throw():t===Se.JOIN||t===Se.REJOIN?null:(await d(),await this.request(t,i))}if(p.isSuccess)return p.message;let m=Number(p.message.error_code||p.message.code),f=cc(m),E=new U(A.UNEXPECTED_RESPONSE,"".concat(f.desc,": ").concat(p.message.error_str),{code:m,data:p.message});return f.action==="success"?p.message:(S.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(m,", message: ").concat(f.desc,", action: ").concat(f.action)),m===Re.ERR_TOO_MANY_BROADCASTERS?((t===Se.JOIN||t===Se.REJOIN)&&(this.initError=E,this.close()),E.throw()):f.action==="failed"?E.throw():f.action==="quit"?(this.initError=E,this.close(),E.throw()):(m===Re.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",ki.MULTI_IP)):this.reconnect(f.action,ki.SERVER_ERROR),t===Se.JOIN||t===Se.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new ne(r=>{let n=o=>{(!i||i(o))&&(this.off(t,n),r(o))};this.on(t,n)})}uploadWRTCStats(t){if(!this.store.sessionId)return void S.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(ac.WRTC_STATS,i)}upload(t,i){let r={_type:t,_message:i};try{this.websocket.sendMessage(r)}catch{let n=N("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>n&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Be.CONNECTED)return;let o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},N("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,i){let r={_type:t,_message:i};this.websocket.sendMessage(r)}init(t,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ne((r,n)=>{this.once(de.WS_CONNECTED,()=>r(this.joinResponse)),this.once(de.WS_CLOSED,()=>n(this.initError||new U(A.WS_ABORT))),this.connectionState=Be.CONNECTING,this.websocket.init(t).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Ge.LEAVE,this.connectionState=Be.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===Ge.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Cu("gateway-".concat(this.clientId),this.spec.retryConfig,!0,N("JOIN_GATEWAY_USE_DUAL_DOMAIN"),N("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(de.ABORT_P2P_EXECUTION);let t=await ti(this,de.REQUEST_JOIN_INFO),i=await this.request(Se.JOIN,t);if(!i)return this.emit(de.REPORT_JOIN_GATEWAY,Ru.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(de.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Be.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new U(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let t=ic(this,de.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;let i=await this.request(Se.REJOIN,t);return!!i&&(this.connectionState=Be.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(r=>{this.emit(Oe.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(Oe.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(Oe.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(Oe.MUTE_AUDIO,{uid:r.uid}):this.emit(Oe.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(Oe.MUTE_VIDEO,{uid:r.uid}):this.emit(Oe.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(Oe.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(Oe.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(Oe.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(Oe.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(Oe.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}handleNotification(t){S.debug("[".concat(this.clientId,"] receive notification: "),t);let i=cc(t.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ge.UID_BANNED),void this.close()):void this.reconnect(i.action,ki.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let t=N("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(S.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>N("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",ki.TIMEOUT):this.request(Se.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let r=Date.now()-i;this.rttRolling.add(r),N("REPORT_STATS")&&this.send(Se.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWsInflateData(){let{wsInflateLength:t,wsDeflateLength:i}=this.websocket.getWsInflateData();t!==0&&i!==0&&this.upload(ac.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(Ae.RECONNECT_WAITTING_FINISH,t=>{this.emit(de.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(Ae.RECONNECT_CREATE_CONNECTION,t=>{this.emit(de.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(Ae.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ae.CLOSED,()=>{this.connectionState=Be.CLOSED}),this.websocket.on(Ae.FAILED,()=>{this._disconnectedReason=Ge.NETWORK_ERROR,this.connectionState=Be.CLOSED}),this.websocket.on(Ae.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Be.CONNECTED?this.connectionState=Be.RECONNECTING:this.connectionState=Be.CONNECTING}),this.websocket.on(Ae.WILL_RECONNECT,(t,i,r)=>{let n=ic(this,de.IS_P2P_DISCONNECTED),o=n||t!=="retry";n&&t==="retry"&&(S.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",i=Ru.P2P_DISCONNECTED),o&&(S.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(de.REPORT_JOIN_GATEWAY,i||Ru.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(de.NEED_RENEW_SESSION,this.websocket.currentURLIndex>=this.websocket.urls.length-1?"recover":t),this.emit(de.DISCONNECT_P2P)),r(t)}),this.websocket.on(Ae.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{S.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",ki.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(de.REPORT_JOIN_GATEWAY,t.message||t.code||Ru.UNKNOWN_REASON,this.url||""),t instanceof U){if(t.code===A.UNEXPECTED_RESPONSE&&t.data.code===Re.ERR_NO_AUTHORIZED)return this.initError=new U(A.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),S.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",ki.SERVER_ERROR);S.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",ki.SERVER_ERROR):(this.initError=t,this.close())}})}),this.websocket.on(Ae.REQUEST_NEW_URLS,(t,i)=>{ti(this,de.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Oe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}let Xt=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function hN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function Im(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?hN(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):hN(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function ta(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(N("TURN_DOMAIN")):(S.info("Unidentified as ip: ".concat(e,", use as host")),e)}function $S(e,t){e.addresses||(e.addresses=[]);let i=function(o,a){if(N("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return o.map(u=>{let{ip:p,port:m}=u;return{address:"".concat(p,":").concat(m)}});let l=N("GATEWAY_DOMAINS"),d=l[1]&&se(a).call(a,l[1])?1:0;return o.map(u=>{let{domain_prefix:p,port:m,ip:f}=u;if(p)return{address:"".concat(p,".").concat(l[d++%l.length],":").concat(m)};let E=/^[\.\:\d]+$/.test(f),I=E?"".concat(f.replace(/[^\d]/g,"-"),".").concat(l[d++%l.length],":").concat(m):"".concat(f,":").concat(m);return E||S.info("Unidentified as ip: ".concat(f,", use as host")),{ip:f,port:m,address:I}})}(e.addresses,t),r=Array.isArray(e.detail)&&e.detail[18];if(r&&typeof r=="string"){let o=r.split(";");for(let a=0;a<o.length;a++){var n;let l=qi(n=o[a]).call(n);i[a]&&l&&(i[a].ip6=l)}}return{gatewayAddrs:i,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function Rr(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function pN(e){let t=e._encoderConfig;if(!t)return{};let i={resolution:t.width&&t.height?"".concat(Rr(t.width),"x").concat(Rr(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(i.maxFrameRate=t.frameRate,i.minFrameRate=t.frameRate):t.frameRate&&(i.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,i.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),i}function mN(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function Iu(e,t){let i,r,n;switch(t){case Xt.CHOOSE_SERVER:r=4096,n="choose server";break;case Xt.CLOUD_PROXY:r=1048576,n="proxy";break;case Xt.CLOUD_PROXY_5:r=4194304,n="proxy5";break;case Xt.CLOUD_PROXY_FALLBACK:r=4194310,n="proxy fallback";break;default:throw new U(A.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach(o=>{o.buffer&&o.buffer.flag===r&&(i={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(a=>Im(Im({},a),{},{ticket:o.buffer.cert})),server_ts:e.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:Im(Im({},o.buffer.detail),e.detail),flag:o.buffer.flag,opid:e.opid,cert:o.buffer.cert})}),!i)throw new U(A.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(n," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return i}async function _N(e,t){return await ne.all(e.addresses.map(async i=>({address:ta(i.ip),tcpport:i.port,udpport:i.port,username:t&&N("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():Li.username,password:t&&N("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await kS(t.toString()):Li.password})))}function eT(e,t){let i=t.getMediaStreamTrack(!0).getSettings(),r=t.videoHeight||i.height,n=t.videoWidth||i.width;return r&&n?Math.max(Math.min(r,n)/Math.min(Rr(e.height),Rr(e.width)),1):(S.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function ia(e){let{candidateType:t,relayProtocol:i,type:r,address:n,port:o,protocol:a}=e;return r==="local-candidate"?{candidateType:t,relayProtocol:i,protocol:a}:{candidateType:t,relayProtocol:i,address:n,port:o,protocol:a}}function fN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}class Nz extends Ot{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){var i;se(i=["tryNext","recover"]).call(i,t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(ii.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(ii.CONNECTED):this._state==="closed"?this.emit(ii.CLOSED):this._state==="failed"&&this.emit(ii.FAILED))}constructor(t,i,r,n){super(),y(this,"connectionID",0),y(this,"currentURLIndex",0),y(this,"reconnectReason",void 0),y(this,"_reconnectMode","tryNext"),y(this,"_initMutex",void 0),y(this,"_name",void 0),y(this,"_state","closed"),y(this,"_reconnectInterrupter",void 0),y(this,"_url",void 0),y(this,"_retryConfig",void 0),y(this,"_reconnectCount",0),y(this,"_forceCloseTimeout",5e3),y(this,"_onlineReconnectListener",void 0),y(this,"_closeEstablishingTransmitter",()=>{}),y(this,"_store",void 0),y(this,"_joinChannelServiceRecordIndex",void 0),y(this,"_transmitter",void 0),y(this,"_useCompress",void 0),y(this,"_inflateLength",0),y(this,"_deflateLength",0),this._store=n,this._name=t,this._retryConfig=function(o){for(var a=1;a<arguments.length;a++){var l=arguments[a]!=null?arguments[a]:{};a%2?fN(Object(l),!0).forEach(function(d){y(o,d,l[d])}):Object.getOwnPropertyDescriptors?Object.defineProperties(o,Object.getOwnPropertyDescriptors(l)):fN(Object(l)).forEach(function(d){Object.defineProperty(o,d,Object.getOwnPropertyDescriptor(l,d))})}return o}({},i),this._useCompress=r}resetReconnectCount(t){S.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;let r=this._transmitter;i?setTimeout(()=>r.close(),500):r.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,i){if(!this._transmitter)return void S.warning("[".concat(this._name,"] can not reconnect, no websocket"));var r;t!==void 0&&(this.reconnectMode=t),S.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((r=this._store)===null||r===void 0||r.recordJoinChannelService({status:"error",errors:[new Error(i)]},this._joinChannelServiceRecordIndex));let n=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),n&&n.bind(this._transmitter)({code:9999,reason:i})}getInflateData(){let t=this._inflateLength,i=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:i}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let mo=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class Dz{constructor(t,i,r){y(this,"version",1),y(this,"initialRTO",void 0),y(this,"maxBatchAckCount",void 0),y(this,"maxRTO",void 0),y(this,"initialRTT",void 0),y(this,"ID",void 0),y(this,"rtt",void 0),y(this,"packetNumber",1),y(this,"rtoRatioMap",new Map),y(this,"timeoutMap",new Map),y(this,"unorderedPacketQueue",[]),y(this,"batchAckPacketQueue",[]),y(this,"lastOrderedPacketNumber",0),y(this,"batchAckTimer",void 0),y(this,"sendImpl",void 0),y(this,"receiveImpl",void 0),this.sendImpl=t,this.receiveImpl=i,this.ID=ft(7,"transmitter-"),this.initialRTO=(r==null?void 0:r.initialRTO)!==void 0?r.initialRTO:N("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(r==null?void 0:r.initialRTT)!==void 0?r.initialRTT:N("TRANSMITTER_INITIAL_RTT"),this.rtt=(r==null?void 0:r.initialRTT)!==void 0?r.initialRTT:N("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(r==null?void 0:r.maxBatchAckCount)!==void 0?r.maxBatchAckCount:N("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(r==null?void 0:r.maxRTO)!==void 0?r.maxRTO:N("TRANSMITTER_MAX_RTO")}packetize(t,i){return{type:mo.Default,version:this.version,packetNumber:i,payload:t}}serialize(t){switch(t.type){case mo.Default:{let i;typeof t.payload=="string"?i=new TextEncoder().encode(t.payload):i=t.payload;let r=new ArrayBuffer(i.length+15),n=new DataView(r);return n.setUint16(0,t.version),n.setUint8(2,t.type),n.setUint32(3,t.packetNumber),Ib(n,7,BigInt(t.sendTs)),new Uint8Array(n.buffer).set(i,15),r}case mo.Ack:{let i=new ArrayBuffer(16),r=new DataView(i);return r.setUint16(0,t.version),r.setUint8(2,t.type),r.setUint32(3,t.maxAckPacketNumber),r.setUint8(7,t.shift),Ib(r,8,BigInt(t.ackSendTs)),i}}}deserialize(t){let i=new DataView(t),r=i.getUint16(0),n=i.getUint8(2);switch(n){case mo.Default:{let o=i.getUint32(3),a=yb(i,7),l=t.slice(15),d=new TextDecoder().decode(l);return{version:r,type:n,packetNumber:o,sendTs:Number(a),payload:d}}case mo.Ack:{let o=i.getUint32(3),a=i.getUint8(7),l=yb(i,8);return{version:r,type:n,maxAckPacketNumber:o,shift:a,ackSendTs:Number(l)}}default:throw S.error("[".concat(this.ID,"] Unrecognized packet type ").concat(n)),new Error("Unrecognized packet type ".concat(n))}}sendMessage(t){let i=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;let r=this.calculateRTO(i),n=window.setTimeout(()=>{this.resendMessage(i)},r);this.timeoutMap.set(i.packetNumber,n),this.sendPacket(i)}onData(t){let i=this.deserialize(t);i.type===mo.Default?this.ack(i):i.type===mo.Ack&&(this.updateRTT(i,Math.round(performance.now())),this.clearRTO(i))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(t=>{let[i,r]=t;window.clearTimeout(r)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){let i=this.calculateRTO(t),r=window.setTimeout(()=>{this.resendMessage(t)},i);this.timeoutMap.set(t.packetNumber,r),this.sendPacket(t)}calculateRTO(t){let i=this.rtoRatioMap.get(t.packetNumber);if(i===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{let r=9*this.rtt/8*i;return this.rtoRatioMap.set(t.packetNumber,i+1),r>this.maxRTO?this.maxRTO:r}}updateRTT(t,i){let r=t.ackSendTs;this.rtt=this.rtt*(7/8)+(i-r-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){let i=this.unorderedPacketQueue[0];if(!i){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(i.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){let i={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:mo.Ack,version:this.version};this.sendPacket(i)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;let i={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:mo.Ack,version:this.version};this.sendPacket(i)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;let t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:mo.Ack,version:this.version};this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===mo.Default&&(t.sendTs=Math.round(performance.now()));let i=this.serialize(t);this.sendImpl(i)}clearRTO(t){for(let i=t.maxAckPacketNumber-t.shift;i<=t.maxAckPacketNumber;i++){let r=this.timeoutMap.get(i);r!==void 0&&window.clearTimeout(r),this.timeoutMap.delete(i),this.rtoRatioMap.delete(i)}}}class EN extends Nz{constructor(t,i){super(t,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),y(this,"_initMutex",void 0),y(this,"_reconnectInterrupter",void 0),y(this,"_url",void 0),y(this,"_transmitter",void 0),y(this,"_addresses",void 0),y(this,"_reliableTransmission",void 0),this._initMutex=new Ti("datachannel");let{timeout:r,timeoutFactor:n}=i,o=Math.max(300,Math.floor(3*r/5)),a=Math.max(1.2,Math.floor(8*n)/10);ir.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=a),Vt.on(tc.NETWORK_STATE_CHANGE,(l,d)=>{l!==d&&(this.resetReconnectCount("network state change: ".concat(d," -> ").concat(l)),l===ir.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=a):(this._retryConfig.timeout=r,this._retryConfig.timeoutFactor=n))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=i;let r=(n,o)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex(l=>l.fingerprint||N("FINGERPRINT"));let a=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(a).then(n).catch(o),this.once(ii.CLOSED,()=>o(new U(A.WS_DISCONNECT))),this.once(ii.CONNECTED,()=>n())};return this._initMutex.lock().then(n=>new ne((o,a)=>{r(o,a)}).then(()=>{n()}).catch(()=>{n()}))}sendMessage(t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new U(A.WS_ABORT,"datachannel is not ready");try{i||(t=JSON.stringify(t)),this._reliableTransmission.sendMessage(t)}catch(r){throw new U(A.WS_ERR,"send datachannel signal message error"+r.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){let i=JSON.stringify(t);return{compressed:i,compressedLength:i.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new ne((i,r)=>{var n;let o=()=>{S.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i()},a=async p=>{var m;if((m=this._closeEstablishingTransmitter)===null||m===void 0||m.call(this),S.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(p.code,", reason: ").concat(p.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=p.reason,this.state="reconnecting");let f=Ur(this,ii.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,E=await this.reconnectWithAction(f);if(this.state==="closed")return void S.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!E)return r(new U(A.WS_DISCONNECT,"datachannel reconnect failed: ".concat(p.code))),void this.close(!0);i()}else r(new U(A.WS_DISCONNECT,"datachannel close: ".concat(p.code))),this.close()},l=p=>{var m;(m=this._reliableTransmission)===null||m===void 0||m.onData(p.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),S.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));let d=(n=this._store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),u=Date.now();ti(this,ii.TO_CONNECT_DATACHANNEL,t).then(p=>{var m,f;if(!p)throw new Error("transmissonInfo not exist yet");let{transmitter:E,close:I}=p;this._transmitter=E,(m=this._store)===null||m===void 0||m.signalChannelOpen();let T=Date.now()-u;S.debug("[choose dc] dc open cost ".concat(T,"ms")),this._reliableTransmission=new Dz(R=>{var w;this._transmitter&&this._transmitter.readyState==="open"&&((w=this._transmitter)===null||w===void 0||w.send(R))},R=>{typeof R=="string"&&this.emit(ii.ON_MESSAGE,R)}),this._closeEstablishingTransmitter=()=>{var R;(R=this._reliableTransmission)===null||R===void 0||R.close(),this._reliableTransmission=void 0,I()},o&&o(),E.onclose=a,E.onmessage=l,(f=this._store)===null||f===void 0||f.recordJoinChannelService({endTs:Date.now(),status:"success"},d),this._joinChannelServiceRecordIndex=d}).catch(p=>{var m;if((m=this._store)===null||m===void 0||m.recordJoinChannelService({endTs:Date.now(),status:p instanceof U&&p.code===A.WS_ABORT?"aborted":"error",errors:[p]},d),this.state!=="closed"){if(p instanceof U&&p.code===A.WS_ERR){let f=new U(A.WS_ERR,"init datachannel failed! Error: ".concat(p.toString()));return S.error("[".concat(this._name,"]").concat(f)),void r(f)}a&&a(p)}else r(new U(A.WS_DISCONNECT,"datachannel is closed: ".concat(p.toString())))})})}async reconnectWithAction(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||Vt.networkState!==ir.OFFLINE||(this._onlineReconnectListener=Vt.onlineWaiter&&Vt.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let r=!0;if(this._reconnectInterrupter=()=>{r=!1},i){let l=_m(this._reconnectCount,this._retryConfig);S.debug("[".concat(this._name,"] wait ").concat(l,"ms to reconnect datachannel, mode: ").concat(t)),await ne.race([mi(l),this._onlineReconnectListener||new ne(()=>{})])}if(this.state==="closed"||!r)return!1;this._reconnectCount+=1;let n=async(l,d)=>{this.emit(ii.RECONNECT_CREATE_CONNECTION,d),await this.createTransmitterConnection(l)};try{if(t==="retry"){let l=this._addresses[this.currentURLIndex];this.emit(ii.RECONNECT_WAITTING_FINISH,t),await n(l,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let d=this.currentURLIndex;d<this._addresses.length;d++){if(this._addresses[d].fingerprint||N("FINGERPRINT")){this.currentURLIndex=d;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return S.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);S.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));let l=this._addresses[this.currentURLIndex];this.emit(ii.RECONNECT_WAITTING_FINISH,t),await n(l,t)}else t==="recover"&&(S.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(ii.RECONNECT_WAITTING_FINISH,t),this.emit(ii.FAILBACK));return!0}catch(l){var o,a;return S.error("[".concat(this._name,"] reconnect failed"),l.toString()),l!=null&&(o=l.data)!==null&&o!==void 0&&o.desc&&Array.isArray(l.data.desc)&&l.data.desc.length&&se(a=l.data.desc).call(a,"dynamic key expired")?(this.emit(ii.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,i)}}}class _s extends Ot{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Be.CONNECTED?this.emit(de.WS_CONNECTED):t===Be.RECONNECTING?this.emit(de.WS_RECONNECTING,this._websocketReconnectReason):t===Be.CLOSED&&this.emit(de.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(t,i){super(),y(this,"_disconnectedReason",void 0),y(this,"_websocketReconnectReason",void 0),y(this,"_connectionState",Be.CLOSED),y(this,"reconnectToken",void 0),y(this,"websocket",void 0),y(this,"openConnectionTime",void 0),y(this,"clientId",void 0),y(this,"lastMsgTime",Date.now()),y(this,"uploadCache",[]),y(this,"uploadCacheInterval",void 0),y(this,"rttRolling",new US(5)),y(this,"pingpongTimer",void 0),y(this,"inflateDataTimer",void 0),y(this,"pingpongTimeoutCount",0),y(this,"joinResponse",void 0),y(this,"multiIpOption",void 0),y(this,"initError",void 0),y(this,"spec",void 0),y(this,"store",void 0),y(this,"onWebsocketMessage",r=>{if(r instanceof ArrayBuffer)return void this.emit(de.ON_BINARY_DATA,r);let n=JSON.parse(r);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(n,"_id")){let o="res-@".concat(n._id);this.emit(o,n._result,n._message)}else if(Object.prototype.hasOwnProperty.call(n,"_type")&&(this.emit(n._type,n._message),n._type===Oe.ON_NOTIFICATION&&this.handleNotification(n._message),n._type===Oe.ON_USER_BANNED))switch(n._message.error_code){case 14:this.close(Ge.UID_BANNED);break;case 15:this.close(Ge.IP_BANNED);break;case 16:this.close(Ge.CHANNEL_BANNED)}}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new EN("gateway-".concat(this.clientId),this.spec.retryConfig,!0,i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Be.CONNECTED&&this.reconnect("retry",$s.OFFLINE)})}async request(t,i,r,n){let o=ft(6,""),a={_id:o,_type:t,_message:i},l=this.websocket.connectionID,d=()=>new ne((I,T)=>{if(this.connectionState===Be.CONNECTED)return I();let R=()=>{this.off(de.WS_CLOSED,w),I()},w=()=>{this.off(de.WS_CONNECTED,R),T(new U(A.WS_ABORT))};this.once(de.WS_CONNECTED,R),this.once(de.WS_CLOSED,w),t!==Se.PUBLISH&&t!==Se.SUBSCRIBE&&t!==Se.UNSUBSCRIBE&&t!==Se.UNPUBLISH&&t!==Se.CONTROL&&t!==Se.RESTART_ICE||this.once(de.DISCONNECT_P2P,()=>{T(new U(A.DISCONNECT_P2P))}),t!==Se.PUBLISH&&t!==Se.RESTART_ICE||this.once(de.ABORT_P2P_EXECUTION,()=>{T(new U(A.DISCONNECT_P2P))})});if(this.connectionState!==Be.CONNECTING&&this.connectionState!==Be.RECONNECTING||t===Se.JOIN||t===Se.REJOIN||await d(),t===Se.LEAVE&&(this.websocket.unbindDcCloseEventListener(),n=!0),this.websocket.sendMessage(a,!0,!1),n)return;let u=new ne((I,T)=>{let R=!1,w=(P,M)=>{R=!0,I({isSuccess:P==="success",message:M||{}}),this.off(de.WS_CLOSED,O),this.off(de.WS_RECONNECTING,O),this.emit(de.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(o),w);let O=()=>{T(new U(A.WS_ABORT,"type: ".concat(t))),this.off(de.WS_CLOSED,O),this.off(de.WS_RECONNECTING,O),this.off("res-@".concat(o),w)};this.once(de.WS_CLOSED,O),this.once(de.WS_RECONNECTING,O),mi(N("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==l||R||(S.warning("dc request timeout, type: ".concat(t)),this.emit(de.REQUEST_TIMEOUT,t,i))})}),p=null;try{p=await u}catch(I){if(this.connectionState===Be.CLOSED||t===Se.LEAVE)throw new U(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?I.throw():t===Se.JOIN||t===Se.REJOIN?null:(await d(),await this.request(t,i))}if(p.isSuccess)return p.message;let m=Number(p.message.error_code||p.message.code),f=cc(m),E=new U(A.UNEXPECTED_RESPONSE,"".concat(f.desc,": ").concat(p.message.error_str),{code:m,data:p.message});return f.action==="success"?p.message:(S.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(m,", message: ").concat(f.desc,", action: ").concat(f.action)),m===Re.ERR_TOO_MANY_BROADCASTERS?((t===Se.JOIN||t===Se.REJOIN)&&(this.initError=E,this.close()),E.throw()):f.action==="failed"?E.throw():f.action==="quit"?(this.initError=E,this.close(),E.throw()):(m===Re.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",$s.MULTI_IP)):this.reconnect(f.action,$s.SERVER_ERROR),t===Se.JOIN||t===Se.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new ne(r=>{let n=o=>{(!i||i(o))&&(this.off(t,n),r(o))};this.on(t,n)})}uploadWRTCStats(t){if(!this.store.sessionId)return void S.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(ac.WRTC_STATS,i)}upload(t,i){let r={_type:t,_message:i};try{this.websocket.sendMessage(r)}catch{let n=N("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>n&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Be.CONNECTED)return;let o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},N("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,i){let r={_type:t,_message:i};this.websocket.sendMessage(r)}init(t,i){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ne((r,n)=>{this.once(de.WS_CONNECTED,()=>r(this.joinResponse)),this.once(de.WS_CLOSED,()=>n(this.initError||new U(A.WS_ABORT))),this.connectionState=Be.CONNECTING,this.websocket.init(t).catch(n),this.websocket.once(ii.FAILBACK,()=>{this.openConnectionTime===void 0&&n(new U(A.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{i&&this.openConnectionTime===void 0&&(S.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),n(new U(A.INIT_DATACHANNEL_TIMEOUT)))},N("DC_JOIN_WITH_FAILBACK"))})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||Ge.LEAVE,this.connectionState=Be.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===Ge.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new EN("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(de.ABORT_P2P_EXECUTION);let t=await ti(this,de.DATACHANNEL_CONNECTING),i=await this.request(Se.JOIN,t);if(!i)return this.emit(de.REPORT_JOIN_GATEWAY,A.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(de.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Be.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new U(A.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let t=ic(this,de.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;let i=await this.request(Se.REJOIN,t);return!!i&&(this.connectionState=Be.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(r=>{this.emit(Oe.ON_USER_ONLINE,{uid:r.uid}),r.audio&&this.emit(Oe.ON_ADD_AUDIO_STREAM,{uid:r.uid,uint_id:r.uint_id,audio:!0,ssrcId:r.audio_ssrc}),r.video&&this.emit(Oe.ON_ADD_VIDEO_STREAM,{uid:r.uid,uint_id:r.uint_id,video:!0,ssrcId:r.video_ssrc}),r.audio_mute?this.emit(Oe.MUTE_AUDIO,{uid:r.uid}):this.emit(Oe.UNMUTE_AUDIO,{uid:r.uid}),r.video_mute?this.emit(Oe.MUTE_VIDEO,{uid:r.uid}):this.emit(Oe.UNMUTE_VIDEO,{uid:r.uid}),r.audio_enable_local?this.emit(Oe.ENABLE_LOCAL_AUDIO,{uid:r.uid}):this.emit(Oe.DISABLE_LOCAL_AUDIO,{uid:r.uid}),r.video_enable_local?this.emit(Oe.ENABLE_LOCAL_VIDEO,{uid:r.uid}):this.emit(Oe.DISABLE_LOCAL_VIDEO,{uid:r.uid}),r.audio||r.video||this.emit(Oe.ON_REMOVE_STREAM,{uid:r.uid,uint_id:r.uint_id})}),!0)}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}handleNotification(t){S.debug("[".concat(this.clientId,"] receive notification: "),t);let i=cc(t.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ge.UID_BANNED),void this.close()):void this.reconnect(i.action,$s.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let t=N("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(S.warning("PINGPONG Timeout. Last Socket Message: ".concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>N("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",$s.TIMEOUT):this.request(Se.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let r=Date.now()-i;this.rttRolling.add(r),N("REPORT_STATS")&&this.send(Se.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleInflateData(){let{inflateLength:t,deflateLength:i}=this.websocket.getInflateData();t!==0&&i!==0&&this.upload(ac.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(ii.RECONNECT_WAITTING_FINISH,t=>{this.emit(de.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(ii.RECONNECT_CREATE_CONNECTION,t=>{this.emit(de.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(ii.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ii.CLOSED,()=>{this.connectionState=Be.CLOSED}),this.websocket.on(ii.FAILED,()=>{this._disconnectedReason=Ge.NETWORK_ERROR,this.connectionState=Be.CLOSED}),this.websocket.on(ii.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Be.CONNECTED?this.connectionState=Be.RECONNECTING:this.connectionState=Be.CONNECTING}),this.websocket.on(ii.WILL_RECONNECT,(t,i)=>{if(ic(this,de.IS_P2P_DISCONNECTED)&&t==="retry")return S.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(de.NEED_RENEW_SESSION),this.emit(de.DISCONNECT_P2P),i("tryNext");t!=="retry"&&(S.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(de.NEED_RENEW_SESSION),this.emit(de.DISCONNECT_P2P)),i(t)}),this.websocket.on(ii.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{S.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",$s.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(de.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof U&&t.code===A.UNEXPECTED_RESPONSE&&t.data.code===Re.ERR_NO_AUTHORIZED)return S.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",$s.SERVER_ERROR);S.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",$s.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(ii.REQUEST_NEW_URLS,(t,i)=>{ti(this,de.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on(ii.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Oe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(ii.TO_CONNECT_DATACHANNEL,async(t,i,r)=>ti(this,de.DATACHANNEL_PRECONNECT,t).then(i).catch(r)),this.websocket.on(ii.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(de.DATACHANNEL_FAILBACK)})}}class lc extends Ot{constructor(t,i){super(),y(this,"signal",void 0),y(this,"token",void 0),y(this,"tokenTimeout",void 0),y(this,"tokenInterval",void 0),y(this,"_sequence",0),y(this,"userMap",new Map),y(this,"encoder",new TextEncoder),this.signal=t,this.token=i;let r=()=>{this.signal.connectionState===Be.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(r,1e3):this.tokenInterval=window.setTimeout(r,3*N("P2P_TOKEN_INTERVAL"))};r()}async send(t,i,r,n,o){var a,l,d;if(this.userMap.size===0)return;let u=Array.from(ho(a=this.userMap).call(a))[0].token;typeof i!="string"&&(i=JSON.stringify(i)),n=(l=n)!==null&&l!==void 0?l:ft(6,""),o=(d=o)!==null&&d!==void 0?d:this._sequence++;let p={_id:n,_type:t,_seq:o,_message:i,token:"".concat(this.token,"_").concat(u)};N("SHOW_P2P_LOG")&&S.debug("send message",p,"noNeedResponse : ".concat(r)),this.splitMessage(JSON.stringify(p)).forEach(f=>{this.signal.request(Se.DATA_STREAM,{payload:Xs(this.encoder.encode(f))})});let m=new ne((f,E)=>{let I=window.setTimeout(()=>{this.off("res-@".concat(n,"_ack"),T),this.off("res-@".concat(n),w),this.off(Nl.ABORT,R),S.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(n)),this.userMap.size===0?E(new j(A.INVALID_REMOTE_USER)):E(new j(A.TIMEOUT))},N("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),T=()=>{I&&window.clearTimeout(I),this.off(Nl.ABORT,R),r&&f()},R=()=>{I&&window.clearTimeout(I),this.off("res-@".concat(n,"_ack"),T),this.off("res-@".concat(n),w),E(new j(A.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(n)))};this.once(Nl.ABORT,R),this.once("res-@".concat(n,"_ack"),T);let w=(P,M)=>{O=!0,I&&window.clearTimeout(I),this.off("res-@".concat(n,"_ack"),T),this.off(Nl.ABORT,R),P==="success"?f(M):E(new j(A.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(n)))},O=!1;r||(this.once("res-@".concat(n),w),mi(N("SIGNAL_REQUEST_TIMEOUT")).then(()=>{O||S.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(n,", ").concat(p))}))});try{return await m}catch(f){if(f.code===A.TIMEOUT)return await this.send(t,i,r,n,o);throw f}}onMessage(t){var i;let{_uid:r}=t,n,o=this.userMap.get(r);if(o)n=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==Ht.CHECK)return;let{token:u}=t;n=new Map,o={uid:r,isStart:!0,token:u,splitMessageMap:n,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(r,o),this.signal.emit(Oe.ON_USER_ONLINE,{uid:r}),this.handleUserOnline()}if("id"in t&&"total"in t){var a;let{id:u,total:p}=t,m=(a=n.get(u))!==null&&a!==void 0?a:[];if(m.push(t),n.has(u)||n.set(u,m),m.length!==p)return;{let f=tu(m).call(m,(E,I)=>E.index-I.index).map(E=>E.payload).join("");n.delete(u),(t=JSON.parse(f))._uid=r}}let{_type:l,token:d}=t;if(se(i=[Ht.ACK,Ht.CHECK]).call(i,l))return l===Ht.CHECK&&this.handleCheckToken(o,d),void this.receiveMessage(t);d==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(t):S.debug('Receive unexpected message", '.concat(d,", cur_token: ").concat(o.token,"_").concat(this.token),t)}check(){let t={_id:ft(6,""),token:this.token,_type:Ht.CHECK};N("SHOW_P2P_LOG")&&S.debug("send message",t),this.signal.request(Se.DATA_STREAM,{payload:Xs(this.encoder.encode(JSON.stringify(t)))})}ack(t){let i={_id:t,_type:Ht.ACK,token:this.token};N("SHOW_P2P_LOG")&&S.debug("send message",i),this.signal.request(Se.DATA_STREAM,{payload:Xs(this.encoder.encode(JSON.stringify(i)))})}response(t,i,r){this.send(Ht.RESPONSE,JSON.stringify({success:!r,message:i}),!0,t)}handleReceivedMessage(t){let i=()=>{this.userMap.forEach(u=>{let{receivedMessagesMap:p,nextExpectedSequenceNumber:m}=u;for(;p.has(m);){let f=p.get(m);p.delete(m),this.receiveMessage(f),u.nextExpectedSequenceNumber++}})};if(!t)return void i();let{_uid:r,_seq:n}=t,o=this.userMap.get(r),{receivedMessagesMap:a,isStart:l,nextExpectedSequenceNumber:d}=o;if(n<d)return this.ack(t._id),void S.debug("[external-signal] receive old message, seq: ".concat(n,", ").concat(t._message));a.set(n,t),l&&n===d&&(this.receiveMessage(t),a.delete(d),o.nextExpectedSequenceNumber++,i())}receiveMessage(t){let{_id:i,_type:r,_message:n,_uid:o}=t;if(N("SHOW_P2P_LOG")&&S.debug("receive message",t),i){let a;switch(t._type!==Ht.ACK&&(n&&(a=JSON.parse(n)),this.ack(t._id)),t._type){case Ht.CANDIDATE:case Ht.CONTROL:this.signal.emit(r,a,o);break;case Ht.PUBLISH:case Ht.UNPUBLISH:case Ht.RESTART_ICE:case Ht.CALL:a.uid=o,ti(this.signal,r,a).then(l=>{this.response(t._id,l)}).catch(()=>{this.response(t._id,void 0,!0)});break;case Ht.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case Ht.RESPONSE:{let{success:l,message:d}=a;this.emit("res-@".concat(i),l?"success":"failed",d);break}}}}splitMessage(t){if(t.length<lc.MAX_MESSAGE_SIZE)return[t];let i=[],{remoteToken:r}=JSON.parse(t),n=ft(6,""),o=0,a=800,l=Math.ceil(t.length/a);for(;t.length>0;){o++;let d={id:n,index:o,total:l,payload:t.slice(0,a),token:"".concat(this.token,"_").concat(r)};JSON.stringify(d).length>lc.MAX_MESSAGE_SIZE?a-=50:(i.push(d),t=t.slice(a))}return i.map(d=>JSON.stringify(d))}handleCheckToken(t,i){return t.token!==i?(S.debug("token changed, from ".concat(t.token," to ").concat(i)),this.reset(t.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{S.debug("token timeout, ".concat(i)),this.reset(t.uid)},N("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){let t=await ti(this.signal,Ht.CALL,void 0),i=await this.send(Ht.CALL,t);this.signal.emit(de.P2P_CONNECTION,i,!0)}async reset(t,i){let r=this.userMap.get(t);r&&(this.emit(Nl.ABORT),this.signal.emit(Oe.ON_USER_OFFLINE,{uid:r.uid,reason:vz.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(S.debug("change local token from ".concat(i," to ").concat(i)),this.token=ft(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Nl.ABORT)}}y(lc,"MAX_SIZE",1),y(lc,"MAX_MESSAGE_SIZE",1024);class gN extends Ot{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===Be.CONNECTED?this.emit(de.WS_CONNECTED):t===Be.RECONNECTING?this.emit(de.WS_RECONNECTING,this._websocketReconnectReason):t===Be.CLOSED&&this.emit(de.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,i){super(),y(this,"_disconnectedReason",void 0),y(this,"_websocketReconnectReason",void 0),y(this,"_connectionState",Be.CLOSED),y(this,"reconnectToken",void 0),y(this,"p2pToken",void 0),y(this,"websocket",void 0),y(this,"openConnectionTime",void 0),y(this,"clientId",void 0),y(this,"lastMsgTime",Date.now()),y(this,"uploadCache",[]),y(this,"uploadCacheInterval",void 0),y(this,"rttRolling",new US(5)),y(this,"pingpongTimer",void 0),y(this,"pingpongTimeoutCount",0),y(this,"joinResponse",void 0),y(this,"multiIpOption",void 0),y(this,"initError",void 0),y(this,"spec",void 0),y(this,"store",void 0),y(this,"_external_signal",void 0),y(this,"onWebsocketMessage",r=>{if(r.data instanceof ArrayBuffer)return void this.emit(de.ON_BINARY_DATA,r.data);let n=JSON.parse(r.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(n,"_id")){let o="res-@".concat(n._id);this.emit(o,n._result,n._message)}else if(Object.prototype.hasOwnProperty.call(n,"_type")){switch(n._type){case Oe.ON_DATA_STREAM:return void this.handleDataStream(n._message);case Oe.MUTE_AUDIO:case Oe.MUTE_VIDEO:case Oe.ON_P2P_LOST:case Oe.ON_USER_ONLINE:return;case Oe.ON_USER_OFFLINE:let{uid:o}=n._message;return S.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(n._type,n._message),n._type===Oe.ON_NOTIFICATION&&this.handleNotification(n._message),n._type===Oe.ON_USER_BANNED)switch(n._message.error_code){case 14:this.close(Ge.UID_BANNED);break;case 15:this.close(Ge.IP_BANNED);break;case 16:this.close(Ge.CHANNEL_BANNED)}if(n._type===Oe.ON_USER_LICENSE_BANNED)switch(n._message.error_code){case Re.ERR_LICENSE_MISSING:this.close(Ge.LICENSE_MISSING);break;case Re.ERR_LICENSE_EXPIRED:this.close(Ge.LICENSE_EXPIRED);break;case Re.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ge.LICENSE_MINUTES_EXCEEDED);break;case Re.ERR_LICENSE_PERIOD_INVALID:this.close(Ge.LICENSE_PERIOD_INVALID);break;case Re.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ge.LICENSE_MULTIPLE_SDK_SERVICE);break;case Re.ERR_LICENSE_ILLEGAL:this.close(Ge.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=t.clientId,this.spec=t,this.store=i,this.websocket=new Cu("gateway-".concat(this.clientId),this.spec.retryConfig,!0,N("JOIN_GATEWAY_USE_DUAL_DOMAIN"),N("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===Be.CONNECTED&&this.reconnect("retry",ki.OFFLINE)}),this.p2pToken=ft(6,""),this._external_signal=new lc(this,this.p2pToken)}async request(t,i,r,n){let o=ft(6,""),a={_id:o,_type:t,_message:i},l=this.websocket.connectionID,d=()=>new ne((I,T)=>{if(this.connectionState===Be.CONNECTED)return I();let R=()=>{this.off(de.WS_CLOSED,w),I()},w=()=>{this.off(de.WS_CONNECTED,R),T(new j(A.WS_ABORT))};this.once(de.WS_CONNECTED,R),this.once(de.WS_CLOSED,w)});if(this.connectionState!==Be.CONNECTING&&this.connectionState!==Be.RECONNECTING||t===Se.JOIN||t===Se.REJOIN||await d(),this.websocket.sendMessage(a,!0),n)return;let u=new ne((I,T)=>{let R=!1,w=(P,M)=>{R=!0,I({isSuccess:P==="success",message:M||{}}),this.off(de.WS_CLOSED,O),this.off(de.WS_RECONNECTING,O),this.emit(de.REQUEST_SUCCESS,t,i)};this.once("res-@".concat(o),w);let O=()=>{T(new j(A.WS_ABORT,"type: ".concat(t))),this.off(de.WS_CLOSED,O),this.off(de.WS_RECONNECTING,O),this.off("res-@".concat(o),w)};this.once(de.WS_CLOSED,O),this.once(de.WS_RECONNECTING,O),mi(N("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==l||R||(S.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(de.REQUEST_TIMEOUT,t,i))})}),p=null;try{p=await u}catch(I){if(this.connectionState===Be.CLOSED||t===Se.LEAVE)throw new j(A.WS_ABORT);return!this.spec.forceWaitGatewayResponse||r?I.throw():t===Se.JOIN||t===Se.REJOIN?null:(await d(),await this.request(t,i))}if(p.isSuccess)return p.message;let m=Number(p.message.error_code||p.message.code),f=cc(m),E=new j(A.UNEXPECTED_RESPONSE,"".concat(f.desc,": ").concat(p.message.error_str),{code:m,data:p.message});return f.action==="success"?p.message:(S.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(m,", message: ").concat(f.desc,", action: ").concat(f.action)),m===Re.ERR_TOO_MANY_BROADCASTERS?((t===Se.JOIN||t===Se.REJOIN)&&(this.initError=E,this.close()),E.throw()):f.action==="failed"?E.throw():f.action==="quit"?(this.initError=E,this.close(),E.throw()):(m===Re.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=p.message.option,S.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",ki.MULTI_IP)):this.reconnect(f.action,ki.SERVER_ERROR),t===Se.JOIN||t===Se.REJOIN?null:await this.request(t,i)))}waitMessage(t,i){return new ne(r=>{let n=o=>{(!i||i(o))&&(this.off(t,n),r(o))};this.on(t,n)})}uploadWRTCStats(t){if(!this.store.sessionId)return void S.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(ac.WRTC_STATS,i)}upload(t,i){let r={_type:t,_message:i};try{this.websocket.sendMessage(r)}catch{let n=N("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(r),this.uploadCache.length>n&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==Be.CONNECTED)return;let o=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(o._type,o._message)},N("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,i){let r={_type:t,_message:i};this.websocket.sendMessage(r)}async sendExtensionMessage(t,i,r){return await this._external_signal.send(t,i,r)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new ne((i,r)=>{this.once(de.WS_CONNECTED,()=>i(this.joinResponse)),this.once(de.WS_CLOSED,()=>r(this.initError||new j(A.WS_ABORT))),this.connectionState=Be.CONNECTING,this.websocket.init(t).catch(r)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||Ge.LEAVE,this.connectionState=Be.CLOSED,S.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===Ge.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new Cu("gateway-".concat(this.clientId),this.spec.retryConfig,!0,N("JOIN_GATEWAY_USE_DUAL_DOMAIN"),N("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=ft(6,""),this._external_signal.clear(),this._external_signal=new lc(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(de.ABORT_P2P_EXECUTION);let t=await ti(this,de.REQUEST_JOIN_INFO),i=await this.request(Se.JOIN,t);if(!i)return this.emit(de.REPORT_JOIN_GATEWAY,A.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(de.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=Be.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,i)}handleDataStream(t){try{var i;let r=nc(t.payload),n=new TextDecoder().decode(r),o=JSON.parse(n);"total"in o&&"id"in o||se(i=Object.values(Ht)).call(i,o._type)?(o._uid=t.uid,this._external_signal.onMessage(o)):this.emit(Oe.ON_DATA_STREAM,t)}catch{this.emit(Oe.ON_DATA_STREAM,t)}}handleNotification(t){S.debug("[".concat(this.clientId,"] receive notification: "),t);let i=cc(t.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ge.UID_BANNED),void this.close()):void this.reconnect(i.action,ki.SERVER_ERROR);S.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let t=N("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=t&&(S.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>N("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",ki.TIMEOUT):this.request(Se.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let r=Date.now()-i;this.rttRolling.add(r),N("REPORT_STATS")&&this.send(Se.PING_BACK,{pingpongElapse:r})}).catch(r=>{})}handleWebsocketEvents(){this.websocket.on(Ae.RECONNECT_WAITTING_FINISH,t=>{this.emit(de.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(Ae.RECONNECT_CREATE_CONNECTION,t=>{this.emit(de.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(Ae.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Ae.CLOSED,()=>{this.connectionState=Be.CLOSED}),this.websocket.on(Ae.FAILED,()=>{this._disconnectedReason=Ge.NETWORK_ERROR,this.connectionState=Be.CLOSED}),this.websocket.on(Ae.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===Be.CONNECTED?this.connectionState=Be.RECONNECTING:this.connectionState=Be.CONNECTING}),this.websocket.on(Ae.WILL_RECONNECT,(t,i,r)=>{t!=="retry"?(S.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(de.NEED_RENEW_SESSION)):S.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),r(t)}),this.websocket.on(Ae.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(t=>{if(this.emit(de.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof j&&t.code===A.UNEXPECTED_RESPONSE&&t.data.code===Re.ERR_NO_AUTHORIZED)return S.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",ki.SERVER_ERROR);S.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",ki.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(Ae.REQUEST_NEW_URLS,(t,i)=>{ti(this,de.REQUEST_RECOVER,this.multiIpOption).then(t).catch(i)}),this.websocket.on(Ae.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(Oe.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}function SN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function Fn(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?SN(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):SN(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let tT=new Map;class Pz extends Ot{get state(){return this._state}set state(t){if(t===this._state)return;let i=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(Wt.CONNECTION_STATE_CHANGE,t,i,this._disconnectedReason):this.emit(Wt.CONNECTION_STATE_CHANGE,t,i)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){S.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,i){super(),y(this,"store",void 0),y(this,"joinInfo",void 0),y(this,"key",void 0),y(this,"ntpOffset",0),y(this,"signal",void 0),y(this,"role",void 0),y(this,"inChannelInfo",{joinAt:null,duration:0}),y(this,"spec",void 0),y(this,"_state","DISCONNECTED"),y(this,"_statsCollector",void 0),y(this,"_disconnectedReason",void 0),y(this,"isSignalRecover",!1),y(this,"hasChangeBGPAddress",!1),y(this,"trafficStatsInterval",void 0),y(this,"networkQualityInterval",void 0),y(this,"_joinGatewayStartTime",0),y(this,"_signalTimeout",!1),y(this,"_clientRoleOptions",void 0),y(this,"_isProactiveJoin",!1),this.store=t,this.spec=i,this.signal=this.store.useP2P?new gN(Fn(Fn({},i),{},{retryConfig:i.websocketRetryConfig}),t):this.store.useDataChannel?new _s(Fn(Fn({},i),{},{retryConfig:i.websocketRetryConfig}),t):new uN(Fn(Fn({},i),{},{retryConfig:i.websocketRetryConfig}),t),this._statsCollector=i.statsCollector,this.role=i.role||"audience",this._clientRoleOptions=i.clientRoleOptions,this.handleSignalEvents()}async join(t,i,r){if(this.signal instanceof _s){let d=!1;t.cloudProxyServer!=="disabled"?(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),d=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),d=!0):t.apResponse.addresses.some(u=>u.fingerprint)||N("FINGERPRINT")||(S.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),d=!0),d&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);let n=Date.now(),o=tT.get(t.cname);if(o||(o=new Map,tT.set(t.cname,o)),this._isProactiveJoin=!0,o.has(t.uid)){let d=new U(A.UID_CONFLICT);throw _e.joinGateway(t.sid,{lts:n,succ:!1,ec:d.message,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!t.proxyServer,signalChannel:this.signal instanceof _s?"1":"0"}),this._isProactiveJoin=!1,d}o.set(t.uid,!0),this.joinInfo=t,this.key=i;let a=0;this.joinGatewayStartTime=n;let l=t.proxyServer;try{let d;if(S.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof _s?"datachannel":"websocket"," join uid ").concat(a)),this.signal instanceof _s)d=await this.signal.init(t.apResponse.addresses,r);else{let u=t.gatewayAddrs.map(p=>{let{address:m}=p,[f,E]=m.split(":"),I={host:f,port:E};return t.proxyServer&&(I.proxy=t.proxyServer),I});d=await this.signal.init(u,r)}a=d.uid,S.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof _s?"datachannel":"websocket"," join uid ").concat(a," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(d){throw d&&d.code===A.INIT_WEBSOCKET_TIMEOUT?(S.warning("[".concat(this.store.clientId,"] User join failed"),d.toString()),d):d&&d.code===A.INIT_DATACHANNEL_TIMEOUT?(S.warning("[".concat(this.store.clientId,"] User join datachannel failed"),d.toString()),this.resetSignal(),d):(S.error("[".concat(this.store.clientId,"] User join failed"),d.toString()),_e.joinGateway(t.sid,{lts:n,succ:!1,ec:d.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!l,signalChannel:this.signal instanceof _s?"1":"0"}),this._isProactiveJoin=!1,o.delete(t.uid),this.signal.close(),d)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),S.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(d=>{S.warning("[".concat(this.store.clientId,"] get traffic stats error"),d.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(Wt.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(Wt.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(Wt.NETWORK_QUALITY,{uplinkNetworkQuality:mN(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:mN(this._statsCollector.trafficStats.B_dnq)}):this.emit(Wt.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),a}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){i!==Ge.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==Be.CONNECTED||await function(r,n){return n===1/0?r:ne.race([r,S8(n)])}(this.signal.request(Se.LEAVE,void 0,!0),3e3)}catch(r){S.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),r)}this.signal.close(i),i!==Ge.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,i,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let n={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:N("PUB_EXTEND"),twcc:!!N("PUBLISH_TWCC"),rtx:!!N("USE_PUB_RTX")};try{return(await this.signal.request(Se.PUBLISH,n,!0))._message}catch(o){if(r&&o.data&&o.data.code===Re.ERR_PUBLISH_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(t,i),this.publish(t,i,!1);throw o}}async publishDataChannel(t,i,r){var n;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let o={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:(n=i.maxRetransmits)!==null&&n!==void 0?n:10,channel_id:i.channelId,metadata:i.metadata};try{await this.signal.request(Se.PUBLISH_DATASTREAM,o,!0)}catch(a){if(r&&a.data&&a.data.code===Re.ERR_PUBLISH_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),a.toString()),await this.tryUnpubDataChannelBeforeRepub(t,i),this.publishDataChannel(t,i,!1);throw a}}async unpublish(t,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request(Se.UNPUBLISH,{stream_id:i,ortc:t},!0)}catch(r){S.warning("[".concat(this.store.clientId,"] unpublish warning: "),r)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await ne.all(t.map(i=>this.signal.request(Se.UNPUBLISH_DATASTREAM,{channel_id:i},!0)))}catch(i){S.warning("unpublish datachannels warning: ",i)}}async presubscribe(t,i,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));let n={stream_id:t,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!N("SUBSCRIBE_TWCC"),rtx:!!N("USE_SUB_RTX")||void 0,extend:N("SUB_EXTEND"),svc:Array.isArray(N("SVC"))&&N("SVC").length!==0?N("SVC"):void 0};try{return await this.signal.request(Se.PRE_SUBSCRIBE,n,!0)}catch(o){if(r&&o.data&&o.data.code===Re.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(t,i,!1);throw o}}async subscribe(t,i,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));let n={stream_id:t,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!N("SUBSCRIBE_TWCC"),rtx:!!N("USE_SUB_RTX"),extend:N("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(N("SVC"))&&N("SVC").length!==0?N("SVC"):void 0};try{return(await this.signal.request(Se.SUBSCRIBE,n,!0))._message}catch(o){if(r&&o.data&&o.data.code===Re.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(t,i),await this.subscribe(t,i,!1);throw o}}async subscribeDataChannel(t,i,r){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));let n={uid:t,stream_id:i.id,channel_id:i.datachannelId};try{return void await this.signal.request(Se.SUBSCRIBE_DATASTREAM,n,!0)}catch(o){if(r&&o.data&&o.data.code===Re.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),await this.tryUnsubDataChannelBeforeResub(t,i),await this.subscribeDataChannel(t,i,!1);throw o}}async subscribeAll(t,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));let r={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!N("USE_SUB_RTX"),twcc:!!N("SUBSCRIBE_TWCC"),svc:Array.isArray(N("SVC"))&&N("SVC").length!==0?N("SVC"):void 0};try{return await this.signal.request(Se.SUBSCRIBE_STREAMS,r,!0)}catch(n){if(i&&n.data&&n.data.code===Re.ERR_SUBSCRIBE_REQUEST_INVALID)return S.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),n.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw n}}async setVideoProfile(t){let i=function(r){if(!(r.bitrateMax&&r.bitrateMin&&r.frameRate&&r.height&&r.width))return;let n=r.frameRate,o=r.width,a=r.height,l=!0;return typeof n!="number"&&(n=n.exact||n.ideal||n.max||n.min||0,n||(l=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(l=!1)),typeof a!="number"&&(a=a.exact||a.ideal||a.max||a.min||0,n||(l=!1)),l?{stream_type:0,width:o,height:a,fps:n,start_bps:1e3*r.bitrateMax,min_bps:1e3*r.bitrateMin,target_bps:1e3*r.bitrateMax}:void 0}(t);if(i)return this.signal.request(Se.SET_VIDEO_PROFILE,i);S.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,i){try{await this.signal.request(Se.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:i},!0)}catch(r){S.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),r)}}async unsubscribeDataChannel(t,i){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await ne.all(t.map(r=>this.signal.request(Se.UNSUBSCRIBE_DATASTREAM,{stream_id:r,uid:i},!0)))}catch(r){S.warning("unsubscribeDataChannel warning: ",r)}}async massUnsubscribe(t){try{await this.signal.request(Se.UNSUBSCRIBE_STREAMS,t,!0)}catch(i){S.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),i)}}async reconnectPC(t){let{iceParameters:i,dtlsParameters:r,rtpCapabilities:n}=t;return{gatewayEstablishParams:await this.signal.request(Se.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:i,dtlsParameters:r,rtpCapabilities:n}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request(Se.GATEWAY_INFO)}async renewToken(t){await this.signal.request(Se.RENEW_TOKEN,t),this.key=t.token}async setClientRole(t,i){if(i&&(this._clientRoleOptions=Object.assign({},i)),this.state!=="CONNECTED")return void(this.role=t);let r,n=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(r=this._clientRoleOptions.delay,n=1):n=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:n=0,await this.signal.request(Se.SET_CLIENT_ROLE,{role:t,level:n,delay:r,client_ts:Date.now()}),this.role=t}async setRemoteVideoStreamType(t,i){await this.signal.request(Se.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:i})}async setDefaultRemoteVideoStreamType(t){await this.signal.request(Se.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,i){await this.signal.request(Se.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:i})}async pickSVCLayer(t,i){await this.signal.request(Se.PICK_SVC_LAYER,{stream_id:t,spatial_layer:i.spatialLayer,temporal_layer:i.temporalLayer})}async setRTM2Flag(t){await this.signal.request(Se.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,i,r){if(this.signal instanceof gN)return this.signal.sendExtensionMessage(t,i,r)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Fn({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request(Se.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){let t=tT.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;let t=function(i){let r;return r=i.startsWith("dc")?i.match(/(dc\:\/\/)?([^:]+):(\d+)/):i.match(/(wss\:\/\/)?([^:]+):(\d+)/),r?{username:Li.username,password:Li.password,turnServerURL:r[2],tcpport:parseInt(r[3])+30,udpport:parseInt(r[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Fn(Fn({},Li),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;let t=await this.signal.request(Se.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach(i=>{let r=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(n=>n.peer_uid===i.peer_uid);r&&r.B_st!==i.B_st&&hm(()=>{this.emit(Wt.STREAM_TYPE_CHANGE,i.peer_uid,i.B_st)})}),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){if(!this.joinInfo||!this.key)throw new U(A.UNEXPECTED_ERROR,"can not generate join message, no join info");let i=Object.assign({},this.joinInfo.apResponse),r=N("REPORT_APP_SCENARIO");if(typeof r!="string")try{r=JSON.stringify(r)}catch{r=void 0}r&&r.length>128&&(r=void 0);let n=Fn({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:mn,browser:navigator.userAgent,process_id:N("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:i,extend:N("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:r,attributes:{userAttributes:{enablePublishedUserList:N("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:N("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof N("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?N("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof N("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?N("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof N("ENABLE_USER_LICENSE_CHECK")=="boolean"?N("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:N("USE_PUB_RTX")===!0||N("USE_SUB_RTX")===!0||void 0,disableFEC:N("DISABLE_FEC"),enableNTPReport:!!N("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!N("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof N("ENABLE_DATASTREAM_2")=="boolean"?N("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!N("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof N("USE_XR")=="boolean"?N("USE_XR"):void 0,enableLossbasedBwe:typeof N("ENABLE_LOSSBASED_BWE")=="boolean"?N("ENABLE_LOSSBASED_BWE"):void 0,enableAutCC:typeof N("ENABLE_AUT_CC")=="boolean"?N("ENABLE_AUT_CC"):void 0,enableCCFallback:typeof N("ENABLE_CC_FALLBACK")=="boolean"?N("ENABLE_CC_FALLBACK"):void 0}},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(n.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(n.aes_mode=this.joinInfo.aesmode,N("ENCRYPT_AES")?(n.aes_secret=this.joinInfo.aespassword,n.aes_encrypt=!0):n.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(n.aes_salt=this.joinInfo.aessalt)),i.addresses[this.signal.websocket.currentURLIndex]&&(n.ap_response.ticket=i.addresses[this.signal.websocket.currentURLIndex].ticket,delete i.addresses),this.joinInfo.defaultVideoStream!==void 0&&(n.default_video_stream=this.joinInfo.defaultVideoStream),n}getRejoinMessage(){if(!this.joinInfo)throw new U(A.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(de.WS_RECONNECT_WAITTING_FINISH,t=>{var i;se(i=["tryNext","recover"]).call(i,t)&&this.joinInfo&&_e.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(de.WS_RECONNECT_CREATE_CONNECTION,t=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(de.WS_RECONNECTING,t=>{this.joinInfo&&_e.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||ki.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",_e.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(de.WS_CLOSED,t=>{let i;switch(t){case Ge.LEAVE:i=ki.LEAVE;break;case Ge.UID_BANNED:case Ge.IP_BANNED:case Ge.CHANNEL_BANNED:case Ge.SERVER_ERROR:i=ki.SERVER_ERROR;break;case Ge.FALLBACK:i=ki.FALLBACK;break;case Ge.LICENSE_MISSING:case Ge.LICENSE_EXPIRED:case Ge.LICENSE_MINUTES_EXCEEDED:case Ge.LICENSE_PERIOD_INVALID:case Ge.LICENSE_MULTIPLE_SDK_SERVICE:case Ge.LICENSE_ILLEGAL:case Ge.TOKEN_EXPIRE:i=t;break;default:i=ki.NETWORK_ERROR}S.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(i||"undefined -> "+ki.NETWORK_ERROR)),this.joinInfo&&_e.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===Ge.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:i}),this._disconnectedReason=t,t!==Ge.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(de.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(S.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),_e.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof _s?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){let t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void S.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));ht("EVENT_REPORT_DOMAIN",t[1]),ht("EVENT_REPORT_BACKUP_DOMAIN",t[1]),ht("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}),this.signal.on(Oe.ON_UPLINK_STATS,t=>{this._statsCollector.updateUplinkStats(t)}),this.signal.on(de.REQUEST_RECOVER,(t,i,r)=>{if(!this.joinInfo)return r(new U(A.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,ti(this,Wt.REQUEST_NEW_GATEWAY_LIST).then(i).catch(r)}),this.signal.on(de.REQUEST_JOIN_INFO,async t=>{var i;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));let{iceParameters:r,dtlsParameters:n,rtpCapabilities:o}=await ti(this,Wt.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(i=this.joinInfo)===null||i===void 0?void 0:i.turnServer});t(this.getJoinMessage({ortc:{iceParameters:r,dtlsParameters:n,rtpCapabilities:o,version:"2"}}))}),this.signal.on(de.REQUEST_REJOIN_INFO,t=>{t(this.getRejoinMessage())}),this.signal.on(de.REPORT_JOIN_GATEWAY,(t,i)=>{this.joinInfo&&(_e.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:t,addr:i,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof _s?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(de.IS_P2P_DISCONNECTED,t=>{t(ic(this,Wt.IS_P2P_DISCONNECTED))}),this.signal.on(de.DISCONNECT_P2P,()=>{this.emit(Wt.DISCONNECT_P2P)}),this.signal.on(de.NEED_RENEW_SESSION,t=>{this.emit(Wt.NEED_RENEW_SESSION,t)}),this.signal.on(de.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(de.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(de.JOIN_RESPONSE,t=>{let i=this.getCurrentGatewayAddress();this.emit(Wt.JOIN_RESPONSE,t,i)}),this.signal.on(de.DATACHANNEL_PRECONNECT,async(t,i,r)=>{this.updateTurnConfigFromSignal();let n=this.getCurrentGatewayAddress();return ti(this,Wt.DATACHANNEL_PRECONNECT,t,n).then(i).catch(r)}),this.signal.on(de.DATACHANNEL_CONNECTING,async t=>{let{iceParameters:i,dtlsParameters:r,rtpCapabilities:n}=await ti(this,Wt.REQUEST_DC_CONNECTION_PARAMS);t(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:r,rtpCapabilities:n,version:"2"}}))}),this.signal.on(de.DATACHANNEL_FAILBACK,()=>{S.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(Wt.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(t,i){try{await this.signal.request(Se.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[i]},!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),r),r}}async tryUnsubDataChannelBeforeResub(t,i){try{await this.signal.request(Se.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(r){throw S.warning("unsubscribe datachannel warning",r),r}}async tryUnpubBeforeRepub(t,i){try{await this.signal.request(Se.UNPUBLISH,{stream_id:t,ortc:i},!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),r),r}}async tryUnpubDataChannelBeforeRepub(t,i){try{await this.signal.request(Se.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(r){throw S.warning("unpublish datastream warning: ",r),r}}async tryMassUnsubBeforeResub(t){let i={users:t.map(r=>({stream_id:r.stream_id,stream_type:r.stream_type}))};try{await this.signal.request(Se.UNSUBSCRIBE_STREAMS,i,!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),r),r}}async muteLocal(t,i){let r={action:t.find(n=>n.stream_type===ot.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:i};try{await this.signal.request(Se.CONTROL,r,!0,!0)}catch(n){throw S.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),n),n}}async unmuteLocal(t,i){let r={action:t.find(n=>n.stream_type===ot.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:i};try{await this.signal.request(Se.CONTROL,r,!0,!0)}catch(n){throw S.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),n),n}}async muteRemote(t,i){let r={action:t===me.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(Se.CONTROL,r,!0,!0)}catch(n){throw S.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),n),n}}async unmuteRemote(t,i){let r={action:t===me.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{await this.signal.request(Se.CONTROL,r,!0,!0)}catch(n){throw S.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),n),n}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,i){this.signal.upload(t,i)}getSignalRTT(){return this.signal.rtt}async restartICE(t){let i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request(Se.RESTART_ICE,i,!0)}catch(r){throw S.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),r),r}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,ki.P2P_FAILED)}getCurrentGatewayAddress(){var t;if(!N("GATEWAY_WSS_ADDRESS"))return(t=this.joinInfo)!==null&&t!==void 0&&t.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request(Se.SET_PARAMETER,{enablePublishAudioFilter:t})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(Ge.FALLBACK)),this.store.useDataChannel=!1,this.signal=new uN(Fn(Fn({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(Wt.RESET_SIGNAL,rN.websocket)}}let wm=0,iT=0;function _o(e,t,i,r){return new ne((n,o)=>{t.timeout=t.timeout||N("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!i?(t.data=JSON.stringify(t.data),wm+=Bo(t.data)):i&&(t.data.size?wm+=t.data.size:t.data instanceof FormData?wm+=Mb(t.data):wm+=Bo(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,ur.request(t).then(a=>{typeof a.data=="string"?iT+=Bo(a.data):a.data instanceof ArrayBuffer||a.data instanceof Uint8Array?iT+=a.data.byteLength:iT+=Bo(JSON.stringify(a.data)),r&&n({data:a.data,headers:a.headers}),n(a.data)}).catch(a=>{ur.isCancel(a)?o(new U(A.OPERATION_ABORTED,"cancel token canceled")):a.code==="ECONNABORTED"?o(new U(A.NETWORK_TIMEOUT,a.message)):a.response?o(new U(A.NETWORK_RESPONSE_ERROR,a.response.status)):o(new U(A.NETWORK_ERROR,a.message))})})}(function(){var e;function t(z){var re=0;return function(){return re<z.length?{done:!1,value:z[re++]}:{done:!0}}}var i=typeof Object.defineProperties=="function"?Object.defineProperty:function(z,re,he){return z==Array.prototype||z==Object.prototype||(z[re]=he.value),z},r,n=function(z){z=[typeof globalThis=="object"&&globalThis,z,typeof window=="object"&&window,typeof self=="object"&&self,typeof _=="object"&&_];for(var re=0;re<z.length;++re){var he=z[re];if(he&&he.Math==Math)return he}throw Error("Cannot find global object")}(this);function o(z,re){if(re)e:{var he=n;z=z.split(".");for(var Pe=0;Pe<z.length-1;Pe++){var tt=z[Pe];if(!(tt in he))break e;he=he[tt]}(re=re(Pe=he[z=z[z.length-1]]))!=Pe&&re!=null&&i(he,z,{configurable:!0,writable:!0,value:re})}}function a(z){return(z={next:z})[Symbol.iterator]=function(){return this},z}function l(z){var re=typeof Symbol<"u"&&Symbol.iterator&&z[Symbol.iterator];return re?re.call(z):{next:t(z)}}if(o("Symbol",function(z){function re(tt,oe){this.A=tt,i(this,"description",{configurable:!0,writable:!0,value:oe})}if(z)return z;re.prototype.toString=function(){return this.A};var he="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",Pe=0;return function tt(oe){if(this instanceof tt)throw new TypeError("Symbol is not a constructor");return new re(he+(oe||"")+"_"+Pe++,oe)}}),o("Symbol.iterator",function(z){if(z)return z;z=Symbol("Symbol.iterator");for(var re="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),he=0;he<re.length;he++){var Pe=n[re[he]];typeof Pe=="function"&&typeof Pe.prototype[z]!="function"&&i(Pe.prototype,z,{configurable:!0,writable:!0,value:function(){return a(t(this))}})}return z}),typeof Object.setPrototypeOf=="function")r=Object.setPrototypeOf;else{var d;e:{var u={};try{u.__proto__={a:!0},d=u.a;break e}catch{}d=!1}r=d?function(z,re){if(z.__proto__=re,z.__proto__!==re)throw new TypeError(z+" is not extensible");return z}:null}var p=r;function m(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function f(z){if(z.m)throw new TypeError("Generator is already running");z.m=!0}function E(z,re){return z.h=3,{value:re}}function I(z){this.g=new m,this.G=z}function T(z,re,he,Pe){try{var tt=re.call(z.g.j,he);if(!(tt instanceof Object))throw new TypeError("Iterator result "+tt+" is not an object");if(!tt.done)return z.g.m=!1,tt;var oe=tt.value}catch(C){return z.g.j=null,z.g.s(C),R(z)}return z.g.j=null,Pe.call(z.g,oe),R(z)}function R(z){for(;z.g.h;)try{var re=z.G(z.g);if(re)return z.g.m=!1,{value:re.value,done:!1}}catch(he){z.g.v=void 0,z.g.s(he)}if(z.g.m=!1,z.g.l){if(re=z.g.l,z.g.l=null,re.F)throw re.D;return{value:re.return,done:!0}}return{value:void 0,done:!0}}function w(z){this.next=function(re){return z.o(re)},this.throw=function(re){return z.s(re)},this.return=function(re){return function(he,Pe){f(he.g);var tt=he.g.j;return tt?T(he,"return"in tt?tt.return:function(oe){return{value:oe,done:!0}},Pe,he.g.return):(he.g.return(Pe),R(he))}(z,re)},this[Symbol.iterator]=function(){return this}}function O(z,re){return re=new w(new I(re)),p&&z.prototype&&p(re,z.prototype),re}if(m.prototype.o=function(z){this.v=z},m.prototype.s=function(z){this.l={D:z,F:!0},this.h=this.C||this.u},m.prototype.return=function(z){this.l={return:z},this.h=this.u},I.prototype.o=function(z){return f(this.g),this.g.j?T(this,this.g.j.next,z,this.g.o):(this.g.o(z),R(this))},I.prototype.s=function(z){return f(this.g),this.g.j?T(this,this.g.j.throw,z,this.g.o):(this.g.s(z),R(this))},o("Array.prototype.entries",function(z){return z||function(){return function(re,he){re instanceof String&&(re+="");var Pe=0,tt=!1,oe={next:function(){if(!tt&&Pe<re.length){var C=Pe++;return{value:he(C,re[C]),done:!1}}return tt=!0,{done:!0,value:void 0}}};return oe[Symbol.iterator]=function(){return oe},oe}(this,function(re,he){return[re,he]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var P=function(z,re){for(var he=0;he<z.length;he++)re(z[he])},M=function(z){return z.replace(/\r?\n|\r/g,`\r
`)},V=function(z,re,he){return re instanceof Blob?(he=he!==void 0?he+"":typeof re.name=="string"?re.name:"blob",re.name===he&&Object.prototype.toString.call(re)!=="[object Blob]"||(re=new File([re],he)),[String(z),re]):[String(z),String(re)]},F=function(z,re){if(z.length<re)throw new TypeError(re+" argument required, but only "+z.length+" present.")},Y=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,J=Y.FormData,Z=Y.XMLHttpRequest&&Y.XMLHttpRequest.prototype.send,pe=Y.Request&&Y.fetch,Ke=Y.navigator&&Y.navigator.sendBeacon,rt=Y.Element&&Y.Element.prototype,Ct=Y.Symbol&&Symbol.toStringTag;Ct&&(Blob.prototype[Ct]||(Blob.prototype[Ct]="Blob"),"File"in Y&&!File.prototype[Ct]&&(File.prototype[Ct]="File"));try{new File([],"")}catch{Y.File=function(z,re,he){return z=new Blob(z,he||{}),Object.defineProperties(z,{name:{value:re},lastModified:{value:+(he&&he.lastModified!==void 0?new Date(he.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),Ct&&Object.defineProperty(z,Ct,{value:"File"}),z}}var Zt=function(z){return z.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Mt=function(z){this.i=[];var re=this;z&&P(z.elements,function(he){if(he.name&&!he.disabled&&he.type!=="submit"&&he.type!=="button"&&!he.matches("form fieldset[disabled] *"))if(he.type==="file"){var Pe=he.files&&he.files.length?he.files:[new File([],"",{type:"application/octet-stream"})];P(Pe,function(tt){re.append(he.name,tt)})}else he.type==="select-multiple"||he.type==="select-one"?P(he.options,function(tt){!tt.disabled&&tt.selected&&re.append(he.name,tt.value)}):he.type==="checkbox"||he.type==="radio"?he.checked&&re.append(he.name,he.value):(Pe=he.type==="textarea"?M(he.value):he.value,re.append(he.name,Pe))})};if((e=Mt.prototype).append=function(z,re,he){F(arguments,2),this.i.push(V(z,re,he))},e.delete=function(z){F(arguments,1);var re=[];z=String(z),P(this.i,function(he){he[0]!==z&&re.push(he)}),this.i=re},e.entries=function z(){var re,he=this;return O(z,function(Pe){if(Pe.h==1&&(re=0),Pe.h!=3)return re<he.i.length?Pe=E(Pe,he.i[re]):(Pe.h=0,Pe=void 0),Pe;re++,Pe.h=2})},e.forEach=function(z,re){F(arguments,1);for(var he=l(this),Pe=he.next();!Pe.done;Pe=he.next()){var tt=l(Pe.value);Pe=tt.next().value,tt=tt.next().value,z.call(re,tt,Pe,this)}},e.get=function(z){F(arguments,1);var re=this.i;z=String(z);for(var he=0;he<re.length;he++)if(re[he][0]===z)return re[he][1];return null},e.getAll=function(z){F(arguments,1);var re=[];return z=String(z),P(this.i,function(he){he[0]===z&&re.push(he[1])}),re},e.has=function(z){F(arguments,1),z=String(z);for(var re=0;re<this.i.length;re++)if(this.i[re][0]===z)return!0;return!1},e.keys=function z(){var re,he,Pe,tt,oe=this;return O(z,function(C){if(C.h==1&&(re=l(oe),he=re.next()),C.h!=3)return he.done?void(C.h=0):(Pe=he.value,tt=l(Pe),E(C,tt.next().value));he=re.next(),C.h=2})},e.set=function(z,re,he){F(arguments,2),z=String(z);var Pe=[],tt=V(z,re,he),oe=!0;P(this.i,function(C){C[0]===z?oe&&(oe=!Pe.push(tt)):Pe.push(C)}),oe&&Pe.push(tt),this.i=Pe},e.values=function z(){var re,he,Pe,tt,oe=this;return O(z,function(C){if(C.h==1&&(re=l(oe),he=re.next()),C.h!=3)return he.done?void(C.h=0):(Pe=he.value,(tt=l(Pe)).next(),E(C,tt.next().value));he=re.next(),C.h=2})},Mt.prototype._asNative=function(){for(var z=new J,re=l(this),he=re.next();!he.done;he=re.next()){var Pe=l(he.value);he=Pe.next().value,Pe=Pe.next().value,z.append(he,Pe)}return z},Mt.prototype._blob=function(){var z="----formdata-polyfill-"+Math.random(),re=[],he="--"+z+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(Pe,tt){return typeof Pe=="string"?re.push(he+Zt(M(tt))+`"\r
\r
`+M(Pe)+`\r
`):re.push(he+Zt(M(tt))+'"; filename="'+Zt(Pe.name)+`"\r
Content-Type: `+(Pe.type||"application/octet-stream")+`\r
\r
`,Pe,`\r
`)}),re.push("--"+z+"--"),new Blob(re,{type:"multipart/form-data; boundary="+z})},Mt.prototype[Symbol.iterator]=function(){return this.entries()},Mt.prototype.toString=function(){return"[object FormData]"},rt&&!rt.matches&&(rt.matches=rt.matchesSelector||rt.mozMatchesSelector||rt.msMatchesSelector||rt.oMatchesSelector||rt.webkitMatchesSelector||function(z){for(var re=(z=(this.document||this.ownerDocument).querySelectorAll(z)).length;0<=--re&&z.item(re)!==this;);return-1<re}),Ct&&(Mt.prototype[Ct]="FormData"),Z){var $n=Y.XMLHttpRequest.prototype.setRequestHeader;Y.XMLHttpRequest.prototype.setRequestHeader=function(z,re){$n.call(this,z,re),z.toLowerCase()==="content-type"&&(this.B=!0)},Y.XMLHttpRequest.prototype.send=function(z){z instanceof Mt?(z=z._blob(),this.B||this.setRequestHeader("Content-Type",z.type),Z.call(this,z)):Z.call(this,z)}}pe&&(Y.fetch=function(z,re){return re&&re.body&&re.body instanceof Mt&&(re.body=re.body._blob()),pe.call(this,z,re)}),Ke&&(Y.navigator.sendBeacon=function(z,re){return re instanceof Mt&&(re=re._asNative()),Ke.call(this,z,re)}),Y.FormData=Mt}})();let wu=()=>{let e=N("AREAS");return e.length===0&&e.push(et.GLOBAL),ao(e).call(e,(t,i,r)=>{let n=TN(i);return n?r===0?n:"".concat(t,",").concat(n):t},"")},TN=e=>e===et.OVERSEA?"".concat(Bi.ASIA,",").concat(Bi.EUROPE,",").concat(Bi.AFRICA,",").concat(Bi.NORTH_AMERICA,",").concat(Bi.SOUTH_AMERICA,",").concat(Bi.OCEANIA):Bi[e],kz=e=>{let t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map(i=>{let r=Cm[i],n=Object.keys(r);n&&n.map(o=>{o!=="CODE"&&(t[o]=t[o].concat(r[o]))})}),t},Am={GLOBAL:{ASIA:[et.CHINA,et.JAPAN,et.INDIA,et.KOREA,et.HKMC],EUROPE:[],NORTH_AMERICA:[et.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Om=Object.keys(Am[et.GLOBAL]),rT=[et.CHINA,et.NORTH_AMERICA,et.EUROPE,et.ASIA,et.JAPAN,et.INDIA,et.OCEANIA,et.SOUTH_AMERICA,et.AFRICA,et.KOREA,et.HKMC,et.US],Lz=function(e,t){let i=[];if(se(e).call(e,et.GLOBAL)){let o=[et.GLOBAL,et.OVERSEA],a=Object.keys(Cm);if(t===et.GLOBAL)throw new U(A.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===et.CHINA)i=[et.OVERSEA];else if(n=t,se(Om).call(Om,n)){let l=(r=t,Am[et.GLOBAL][r]||[]),d=[...o,t,...l];i=a.filter(u=>!se(d).call(d,u))}else if(function(l){let d=!1;return Om.forEach(u=>{var p;se(p=Am[et.GLOBAL][u]).call(p,l)&&(d=!0)}),d}(t)){let l=function(u){let p;return Om.forEach(m=>{var f;se(f=Am[et.GLOBAL][m]).call(f,u)&&(p=m)}),p}(t),d=[...o,l,t];i=a.filter(u=>!se(d).call(d,u))}else i=e;i=function(l){let d=[];return rT.forEach(u=>{se(l).call(l,u)&&d.push(u)}),d.concat(l.filter(u=>!se(rT).call(rT,u)))}(i)}else i=e;var r,n;return i};function vN(e){var t,i;if(!e&&se(t=N("AREAS")).call(t,et.EXTENSIONS))return S.debug("update area from ap : reset"),void nT(O8,!0);if(!se(i=N("AREAS")).call(i,et.GLOBAL)||!e)return;let r=Cm.EXTENSIONS;r&&(r={CODE:TN(et.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},S.debug("update area from ap success: ".concat(e,",config is "),r),ht("AREAS",[et.EXTENSIONS],!0),Object.keys(r).map(n=>{n==="LOG_UPLOAD_SERVER"||n==="EVENT_REPORT_DOMAIN"||n==="EVENT_REPORT_BACKUP_DOMAIN"||n==="PROXY_SERVER_TYPE3"?ht(n,r[n][0]):ht(n,r[n])}))}function nT(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1],i=_e.reportApiInvoke(null,{name:ei.SET_AREA,options:e,tag:xt.TRACER});try{let r=[];if(typeof e=="string"&&(r=[e]),Array.isArray(e)&&(e.forEach(o=>{if(!se(nN).call(nN,o))throw new U(A.INVALID_PARAMS,"invalid area code")}),r=e),Object.prototype.toString.call(e)==="[object Object]"){let{areaCode:o,excludedArea:a}=e;if(!o)throw new U(A.INVALID_PARAMS,"area code is needed");let l=o;typeof o=="string"&&(l=[o]),r=a?Lz(l,a):l}if(!t){if(Qs.AREAS){let o=new U(A.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(o),void S.warning("setArea is prohibited because of config-distribute")}if(se(r).call(r,et.GLOBAL)&&N("AREAS")===et.EXTENSIONS){let o=new U(A.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(o),void S.warning("setArea is prohibited because of ap extensions")}}ht("AREAS",r,t);let n=kz(r);Object.keys(n).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?ht(o,n[o][0]):ht(o,n[o])}),S.debug("set area success:",r.join(","))}catch(r){throw i.onError(r),r}i.onSuccess()}function RN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function oT(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?RN(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):RN(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let sT=1;function Mz(e,t,i,r,n){sT+=1;let o={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:sT,requestId:sT,version:mn,cname:i.cname},a={service_name:t,json_body:JSON.stringify(o)},l,d,u=e[0];return uo(async()=>{l=Date.now();let p=await _o(u,{data:a,cancelToken:r,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(d=Date.now()-l,p.code!==0){let E=new U(A.UNEXPECTED_RESPONSE,"live streaming ap error, code"+p.code,{retry:!0,responseTime:d});throw S.error(E.toString()),E}let m=JSON.parse(p.json_body);if(m.code!==200){let E=new U(A.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(m.code,", reason: ").concat(m.reason),{code:m.code,responseTime:d});throw S.error(E.toString()),E}if(!m.servers||m.servers.length===0){let E=new U(A.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:m.code,responseTime:d});throw S.error(E.toString()),E}let f=function(E,I){return{addressList:E.servers.map(T=>"wss://".concat(T.address.replace(/\./g,"-"),".").concat(N("WORKER_DOMAIN"),":").concat(T.wss,"?serviceName=").concat(encodeURIComponent(I))),workerToken:E.workerToken,vid:E.vid}}(m,t);return N("LIVE_STREAMING_ADDRESS")&&(f.addressList=N("LIVE_STREAMING_ADDRESS")instanceof Array?N("LIVE_STREAMING_ADDRESS"):[N("LIVE_STREAMING_ADDRESS")]),oT(oT({},f),{},{responseTime:d})},(p,m)=>(_e.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(p.addressList),firstSuccess:m===0,responseTime:d,serverIp:e[m%e.length]}),!1),(p,m)=>(_e.apworkerEvent(i.sid,{success:!1,sc:p.data&&p.data.code||200,serviceName:t,responseTime:d,serverIp:e[m%e.length]}),!!(p.code!==A.OPERATION_ABORTED&&p.code!==A.UNEXPECTED_RESPONSE||p.data&&p.data.retry)&&(u=e[(m+1)%e.length],!0)),n)}let aT=1;function CN(e,t,i,r){let{url:n,areaCode:o}=e,{clientId:a,sid:l}=t,d=Date.now(),u,[p,m]=lT(t,o,[Xt.CHOOSE_SERVER]),f=Vt.networkState;return uo(async()=>{f&&Vt.networkState===ir.OFFLINE&&Vt.onlineWaiter&&await ne.race([Vt.onlineWaiter,mi(r&&r.maxRetryTimeout||Jt.maxRetryTimeout)]),f=Vt.networkState;let{data:E,headers:I}=await _o(n,{data:p,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);u=I.http3==="1"?1:-1,_e.reportResourceTiming(n,l),IN(E,n,t,d,[Xt.CHOOSE_SERVER],u);let T=Iu(E,Xt.CHOOSE_SERVER);return cT(T),$S(T,n)},E=>(E&&_e.joinChooseServer(l,{lts:d,succ:!0,csAddr:n,opid:m,serverList:E.gatewayAddrs.map(I=>I.address),ec:null,cid:E.cid.toString(),uid:E.uid.toString(),csIp:E.csIp,unilbsServerIds:[Xt.CHOOSE_SERVER].toString(),isHttp3:u}),!1),E=>E.code!==A.OPERATION_ABORTED&&(E.code===A.CAN_NOT_GET_GATEWAY_SERVER?E.data.retry:(_e.joinChooseServer(l,{lts:d,succ:!1,csAddr:n,serverList:null,opid:m,ec:E.code,csIp:E.data&&E.data.csIp,unilbsServerIds:[Xt.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:f}),isHttp3:u}),S.warning("[".concat(a||"sid-".concat(l.slice(0,6)),"] Choose server network error, retry"),E),!0)),r)}function yN(e,t,i,r){let n,{url:o,areaCode:a,serviceIds:l}=e,d=Date.now(),[u,p]=lT(t,a,l),m;return uo(async()=>{m&&Vt.networkState===ir.OFFLINE&&Vt.onlineWaiter&&await ne.race([Vt.onlineWaiter,mi(r&&r.maxRetryTimeout||Jt.maxRetryTimeout)]),m=Vt.networkState;let{data:f,headers:E}=await _o(o,{data:u,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);n=E.http3==="1"?1:-1,_e.reportResourceTiming(o,t.sid),IN(f,o,t,d,l,n);let I=Iu(f,Xt.CHOOSE_SERVER),T=Iu(f,t.cloudProxyServer==="proxy5"?Xt.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Xt.CLOUD_PROXY:Xt.CLOUD_PROXY_FALLBACK);return cT(I),{gatewayInfo:$S(I,o),proxyInfo:T,url:o}},f=>(f.gatewayInfo&&_e.joinChooseServer(t.sid,{lts:d,succ:!0,csAddr:o,serverList:f.gatewayInfo.gatewayAddrs.map(E=>E.address),ec:null,opid:p,cid:f.gatewayInfo.cid.toString(),uid:f.gatewayInfo.uid.toString(),csIp:f.gatewayInfo.csIp,unilbsServerIds:l.toString(),isHttp3:n}),f.proxyInfo&&_e.joinWebProxyAP(t.sid,{lts:d,sucess:1,apServerAddr:o,turnServerAddrList:f.proxyInfo.addresses.map(E=>E.ip).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:l.toString()}),!1),f=>f.code!==A.OPERATION_ABORTED&&(f.code===A.CAN_NOT_GET_GATEWAY_SERVER?f.data.retry:(_e.joinWebProxyAP(t.sid,{lts:d,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:f.code,eventType:t.cloudProxyServer,unilbsServerIds:l.toString(),extend:JSON.stringify({networkState:m})}),S.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),f),!0)),r)}let IN=(e,t,i,r,n,o)=>{let{sid:a,clientId:l,cloudProxyServer:d}=i,u=[],p=m=>{m.flag===4096?_e.joinChooseServer(a,{lts:r,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:m.error.message,csIp:m.error.data&&m.error.data.csIp,unilbsServerIds:n.toString(),isHttp3:o}):m.flag!==1048576&&m.flag!==4194304&&m.flag!==4194310||_e.joinWebProxyAP(a,{lts:r,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:m.error.code,eventType:d,unilbsServerIds:n.toString()})};if(e.response_body.forEach(m=>{let f=m.buffer.code;if(m.uri===23&&f===0&&!m.buffer.edges_services)if(m.buffer.flag===4194310)S.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),m.buffer.edges_services=[];else{let E={error:new U(A.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:m.buffer.flag};u.push(E),p(E)}if(f!==0){let E=Dl(f),I={error:new U(A.CAN_NOT_GET_GATEWAY_SERVER,E.desc,{desc:E.desc,retry:E.retry,csIp:e.detail[502]}),flag:m.buffer.flag};m.buffer.flag===4194310?S.warning(I.error.toString()):u.push(I),p(I)}}),u.length)throw S.warning("[".concat(l||"sid-".concat(a.slice(0,6)),"] multi unilbs ").concat(t," failed, ").concat(u.map(m=>"flag: ".concat(m.flag,", message: ").concat(m.error.message,", retry: ").concat(m.error.data.retry)).join(" | "))),new U(A.CAN_NOT_GET_GATEWAY_SERVER,u.map(m=>"flag: ".concat(m.flag,", message: ").concat(m.error.message)).join(" | "),{retry:!!u.find(m=>m.error.data.retry),csIp:e.detail[502],desc:[...new Set(u.map(m=>{var f;return m==null||(f=m.error)===null||f===void 0||(f=f.data)===null||f===void 0?void 0:f.desc}).filter(m=>!!m))]})},cT=e=>{var t,i,r,n;if(e.addresses&&e.addresses.length===0&&e.code===0)throw new U(A.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(N("AP_AREA")&&((r=e.detail)!==null&&r!==void 0&&r[23]&&typeof((n=e.detail)===null||n===void 0?void 0:n[23])=="string"?vN(e.detail[23].toLowerCase()):vN()),(t=e.detail)!==null&&t!==void 0&&t[19]&&typeof((i=e.detail)===null||i===void 0?void 0:i[19])=="string"){let a=e.detail[19],l=a==null?void 0:a.split(";");for(let d=0;d<l.length;d++){var o;let u=qi(o=l[d]).call(o);e.addresses[d]&&l&&(e.addresses[d].fingerprint=u)}}if(N("GATEWAY_ADDRESS")&&N("GATEWAY_ADDRESS").length>0){S.debug("assign gateway address to",N("GATEWAY_ADDRESS"));let a=N("GATEWAY_ADDRESS").map(l=>{var d,u;let p=(d=(u=e.addresses.find(m=>m.ip===l.ip&&m.port===l.port))===null||u===void 0?void 0:u.fingerprint)!==null&&d!==void 0?d:"";return{ip:l.ip,port:l.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:p}});e.addresses=a}},Uz=(e,t)=>{if(e.response_body&&e.response_body.length){let i=e.response_body[0];if(i.buffer.code!==0){let r=Dl(i.buffer.code);throw new U(A.UPDATE_TICKET_FAILED,"[".concat(i.buffer.code,"]: ").concat(r.desc),{retry:r.retry})}return i.buffer.ticket}throw S.debug("update ticket request received ap response without response body:",t),new U(A.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},lT=(e,t,i)=>{let r=Math.floor(Math.random()*1e12),n={appid:e.appId,client_ts:Date.now(),opid:r,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:oT({6:e.stringUid,11:t,12:N("USE_NEW_TOKEN")?"1":void 0,22:t},e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:i,uid:e.uid||0}}]};n.request_bodies.forEach(a=>{e.multiIP&&e.multiIP.gateway_ip&&(a.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))});let o=new FormData;return o.append("request",JSON.stringify(n)),[o,r]},xz=(e,t)=>{let i=Math.floor(Math.random()*1e12),r={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},n=new FormData;return n.append("request",JSON.stringify(r)),[n,i]},Pl=0;function kl(e){return ne.all(e.map(t=>t.then(i=>{throw i},i=>i))).then(t=>{throw t},t=>t)}let Au=async e=>{let{fragementLength:t,referenceList:i,asyncMapHandler:r,allFailedhandler:n,promisesCollector:o}=e,a=0,l=t,d,u=0,p=async()=>{let m=(()=>{let f=a*l,E=f+l;return i.slice(f,E).map(r)})();o&&o.push(...m);try{d=await kl(m)}catch(f){if(u+=l,a++,!(u>=i.length))return void await p();n(f)}m.forEach(f=>f.cancel())};return await p(),d},wN=async e=>{let{referenceList:t,asyncMapHandler:i,closeFn:r}=e,n=t.length,o=0,a=async()=>{let l=i(t.shift());try{return await l}catch(d){if(o++,o>=n||r!=null&&r(d))throw d;return a()}};return a()};async function dT(e,t,i,r){return{gatewayInfo:await async function(n,o,a,l){let d=null,u=[],p=async()=>{let f=N("WEBCS_DOMAIN").slice(0,N("AJAX_REQUEST_CONCURRENT")).map(T=>({url:n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(T+"/api/v2/transpond/webrtc?v=2"):"https://".concat(T,"/api/v2/transpond/webrtc?v=2"),areaCode:wu()})),E=l.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map(T=>T.url)}),I=await Au({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:T=>(S.debug("[".concat(n.clientId,"] Connect to choose_server:"),T.url),CN(T,n,o,a)),allFailedhandler:T=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},E),T[0]},promisesCollector:u});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},E),I},m=async()=>{if(await mi(1e3),d!==null)return d;let f=N("WEBCS_DOMAIN_BACKUP_LIST").map(T=>({url:n.proxyServer?"https://".concat(n.proxyServer,"/ap/?url=").concat(T+"/api/v2/transpond/webrtc?v=2"):"https://".concat(T,"/api/v2/transpond/webrtc?v=2"),areaCode:wu()})),E=l.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:f.map(T=>T.url)}),I=await Au({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:f,asyncMapHandler:T=>(S.debug("[".concat(n.clientId,"] Connect to backup choose_server:"),T.url),CN(T,n,o,a)),allFailedhandler:T=>{throw l.recordJoinChannelService({endTs:Date.now(),status:"error",errors:T},E),T[0]},promisesCollector:u});return l.recordJoinChannelService({endTs:Date.now(),status:"success"},E),I};try{return d=await kl([p(),m()]),u.length&&u.forEach(f=>f.cancel&&typeof f.cancel=="function"&&f.cancel()),d}catch(f){throw f[0]}}(e,t,i,r)}}async function AN(e,t,i,r,n){let o=e.cloudProxyServer;if(o==="disabled"){if(e.useLocalAccessPoint)return await dT(e,t,i,n);if(N("JOIN_WITH_FALLBACK_MEDIA_PROXY")){let{gatewayInfo:f,proxyInfo:E}=await NN(e,t,i,n);if(e.turnServer&&e.turnServer.mode!=="auto")return{gatewayInfo:f};let I=E.map(T=>({turnServerURL:T.address,tcpport:T.tcpport||Li.tcpport,udpport:T.udpport||Li.udpport,username:T.username||Li.username,password:T.password||Li.password,forceturn:!1,security:!0}));if(n.useP2P){var a;let T=(a=e.uid)!==null&&a!==void 0?a:f.uid,R="glb:".concat(T.toString()),w=await kS(R),O=E.map(P=>({turnServerURL:P.address,tcpport:P.tcpport||Li.tcpport,udpport:P.udpport||Li.udpport,username:R,password:w,forceturn:!1,security:!0}));I.push(...O)}return e.turnServer={mode:"manual",servers:I},{gatewayInfo:f}}return await dT(e,t,i,n)}let{proxyInfo:l,gatewayInfo:d}=await NN(e,t,i,n),u={gatewayInfo:d},p=l.map(f=>({turnServerURL:f.address,tcpport:o==="proxy3"?void 0:f.tcpport?f.tcpport:Li.tcpport,udpport:o==="proxy4"?void 0:f.udpport?f.udpport:Li.udpport,username:f.username||Li.username,password:f.password||Li.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(n.useP2P){var m;let f=(m=e.uid)!==null&&m!==void 0?m:d.uid,E="glb:".concat(f.toString()),I=await kS(E),T=l.map(R=>({turnServerURL:R.address,tcpport:o==="proxy3"?void 0:R.tcpport||Li.tcpport,udpport:o==="proxy4"?void 0:R.udpport||Li.udpport,username:E,password:I,forceturn:o!=="proxy4",security:o==="proxy5"}));p.push(...T)}return e.turnServer={mode:"manual",servers:p},S.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(o)),u}async function ON(e,t,i,r,n){let o=N("ACCOUNT_REGISTER").slice(0,N("AJAX_REQUEST_CONCURRENT")),a=[];a=t.proxyServer?o.map(d=>"https://".concat(t.proxyServer,"/ap/?url=").concat(d+"/api/v1")):o.map(d=>"https://".concat(d,"/api/v1"));let l=n==null?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:a});try{let d=await async function(u,p,m,f,E){let I=Date.now(),T={sid:m.sid,opid:10,appid:m.appId,string_uid:p},R=u[0],w=await uo(()=>_o(R+"".concat(R.indexOf("?")===-1?"?":"&","action=stringuid"),{data:T,cancelToken:f,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(O,P)=>{if(O.code===0){if(O.uid<=0||O.uid>=Math.pow(2,32))throw S.error("Invalid Uint Uid ".concat(p," => ").concat(O.uid),O),_e.reqUserAccount(T.sid,{lts:I,success:!1,serverAddr:R,stringUid:T.string_uid,uid:O.uid,errorCode:A.INVALID_UINT_UID_FROM_STRING_UID,extend:T}),new U(A.INVALID_UINT_UID_FROM_STRING_UID);return _e.reqUserAccount(T.sid,{lts:I,success:!0,serverAddr:R,stringUid:T.string_uid,uid:O.uid,errorCode:null,extend:T}),!1}let M=Dl(O.code);return M.retry&&(R=u[(P+1)%u.length]),_e.reqUserAccount(T.sid,{lts:I,success:!1,serverAddr:R,stringUid:T.string_uid,uid:O.uid,errorCode:M.desc,extend:T}),M.retry},(O,P)=>O.code!==A.OPERATION_ABORTED&&(_e.reqUserAccount(T.sid,{lts:I,success:!1,serverAddr:R,stringUid:T.string_uid,uid:null,errorCode:O.code,extend:T}),R=u[(P+1)%u.length],!0),E);if(w.code!==0){let O=Dl(w.code);throw new U(A.UNEXPECTED_RESPONSE,O.desc)}return w}(a,e,t,i,r);return n==null||n.recordJoinChannelService({status:"success",endTs:Date.now()},l),d.uid}catch(d){throw n==null||n.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[d]},l),d}}async function Vz(e,t,i){let r=N("ACCOUNT_REGISTER"),n=[];n=t.proxyServer?r.map(o=>"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1")):r.map(o=>"https://".concat(o,"/api/v1"));try{return await wN({referenceList:n,asyncMapHandler:o=>async function(a,l,d,u){let p=Date.now(),m={sid:d.sid,opid:10,appid:d.appId,string_uid:l};try{let f=await _o(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:m,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(f.code!==0){let E=Dl(f.code);throw new U(A.UNEXPECTED_RESPONSE,"preload sua error:".concat(E.desc),E)}if(f.uid<=0||f.uid>=Math.pow(2,32))throw new U(A.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:p,url:a,req:m,uid:f.uid,elapse:Date.now()-p}}catch(f){throw f}}(o,e,t,i),closeFn:o=>o.code===A.OPERATION_ABORTED||o.code===A.UNEXPECTED_RESPONSE&&!o.data.retry})}catch(o){throw o}}async function Fz(e,t,i){let r=N("CDS_AP").slice(0,N("AJAX_REQUEST_CONCURRENT")).map(d=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(d+"/api/v1"):"https://".concat(d,"/api/v1?action=config")),n=r.map(d=>function(u,p,m,f){let E=Xe(),I={flag:64,cipher_method:0,features:{device:E.name,system:E.os,system_general:navigator.userAgent,vendor:p.appId,version:mn,cname:p.cname,sid:p.sid,session_id:p.sid,detail:"",proxyServer:p.proxyServer}};return uo(()=>_o(u,{data:I,timeout:1e3,cancelToken:m,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,T=>T.code!==A.OPERATION_ABORTED,f)}(d,e,t,i)),o=null,a=null,l={};try{o=await kl(n)}catch(d){if(d.code===A.OPERATION_ABORTED)throw d;a=d}if(n.forEach(d=>d.cancel()),_e.reportApiInvoke(e.sid,{name:ei.REQUEST_CONFIG_DISTRIBUTE,options:{error:a,res:o}}).onSuccess(),o&&o.test_tags)try{l=function(d){if(!d.test_tags)return{};let u=d.test_tags,p=Object.keys(u),m={};return p.forEach(f=>{var E;let I=qi(E=f.slice(4)).call(E),T=JSON.parse(u[f])[1];m[I]=T}),m}(o)}catch{}return l}async function bN(e,t){let i=N("WEBCS_DOMAIN").concat(N("WEBCS_DOMAIN_BACKUP_LIST")).map(r=>({url:"https://".concat(r,"/api/v2/transpond/webrtc?v=2"),areaCode:wu(),serviceIds:[Xt.CHOOSE_SERVER,Xt.CLOUD_PROXY_FALLBACK]}));try{return await wN({referenceList:i,asyncMapHandler:r=>async function(n,o,a){let l,{url:d,areaCode:u,serviceIds:p}=n,m=Date.now(),[f,E]=lT(o,u,p),I=Vt.networkState;try{I&&Vt.networkState===ir.OFFLINE&&Vt.onlineWaiter&&await ne.race([Vt.onlineWaiter,mi(Jt.maxRetryTimeout)]),I=Vt.networkState;let{data:T,headers:R}=await _o(d,{data:f,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);l=R.http3==="1"?1:-1,(P=>{let M=[];if(P.response_body.forEach(V=>{let F=V.buffer.code;if(V.uri===23&&F===0&&!V.buffer.edges_services)if(V.buffer.flag===4194310)V.buffer.edges_services=[];else{let Y={error:new U(A.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:P.detail[502]}),flag:V.buffer.flag};M.push(Y)}if(F!==0){let Y=Dl(F),J={error:new U(A.CAN_NOT_GET_GATEWAY_SERVER,Y.desc,{desc:Y.desc,retry:Y.retry,csIp:P.detail[502]}),flag:V.buffer.flag};V.buffer.flag===4194310?S.warning(J.error.toString()):M.push(J)}}),M.length)throw new U(A.CAN_NOT_GET_GATEWAY_SERVER,M.map(V=>"flag: ".concat(V.flag,", message: ").concat(V.error.message)).join(" | "),{retry:!!M.find(V=>V.error.data.retry),csIp:P.detail[502],desc:[...new Set(M.map(V=>{var F;return V==null||(F=V.error)===null||F===void 0||(F=F.data)===null||F===void 0?void 0:F.desc}).filter(V=>!!V))]})})(T);let w=Iu(T,Xt.CHOOSE_SERVER),O=Iu(T,Xt.CLOUD_PROXY_FALLBACK);return cT(w),{gatewayInfo:$S(w,d),proxyInfo:O,opid:E,requestTime:m,url:d,isHttp3:l,elapse:Date.now()-m}}catch(T){throw T}}(r,e,t),closeFn:r=>r.code===A.OPERATION_ABORTED||r.code===A.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(r){throw r}}async function NN(e,t,i,r){let n=N("PROXY_SERVER_TYPE3"),o=(E,I,T)=>{let R=T||n;return Array.isArray(R)&&(R=I%2==0?n[1]:n[0]),"https://".concat(R,"/ap/?url=").concat(E)},a=null,l=[],d=async()=>{let E=N("WEBCS_DOMAIN").slice(0,N("AJAX_REQUEST_CONCURRENT")).map((R,w)=>{let O;return O=e.cloudProxyServer==="disabled"&&e.proxyServer?o("".concat(R,"/api/v2/transpond/webrtc?v=2"),w,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(R,"/api/v2/transpond/webrtc?v=2"):o("".concat(R,"/api/v2/transpond/webrtc?v=2"),w),{url:O,areaCode:wu(),serviceIds:[Xt.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?Xt.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?Xt.CLOUD_PROXY:Xt.CLOUD_PROXY_FALLBACK]}}),I=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:E.map(R=>R.url)}),T=await Au({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:R=>(S.debug("[".concat(e.clientId,"] Connect to choose_server:"),R.url),yN(R,e,t,i)),allFailedhandler:R=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},I),R[0]},promisesCollector:l});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},I),T},u=async()=>{if(await mi(1e3),a!==null)return a;let E=N("WEBCS_DOMAIN_BACKUP_LIST").map((R,w)=>{let O;return O=e.cloudProxyServer==="disabled"&&e.proxyServer?o("".concat(R,"/api/v2/transpond/webrtc?v=2"),w,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(R,"/api/v2/transpond/webrtc?v=2"):o("".concat(R,"/api/v2/transpond/webrtc?v=2"),w),{url:O,areaCode:wu(),serviceIds:[Xt.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?Xt.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?Xt.CLOUD_PROXY:Xt.CLOUD_PROXY_FALLBACK]}}),I=r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:E.map(R=>R.url)}),T=await Au({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:E,asyncMapHandler:R=>(S.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),R.url),yN(R,e,t,i)),allFailedhandler:R=>{throw r.recordJoinChannelService({endTs:Date.now(),status:"error",errors:R},I),R[0]},promisesCollector:l});return r.recordJoinChannelService({endTs:Date.now(),status:"success"},I),T},p,m,f;try{({gatewayInfo:p,proxyInfo:m,url:f}=await kl([d(),u()]))}catch(E){throw E[0]}if(l.length&&l.forEach(E=>E.cancel&&typeof E.cancel=="function"&&E.cancel()),!p||!m)throw new U(A.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=f,e.cloudProxyServer!=="disabled"&&Array.isArray(n)&&f){let E=/^https?:\/\/(.+?)(\/.*)?$/.exec(f)[1];se(n).call(n,E)&&(e.proxyServer=E,S.setProxyServer(E),_e.setProxyServer(E))}return a={gatewayInfo:p,proxyInfo:await _N(m,p.uid)},a}async function DN(e,t,i,r){let n=N("UAP_AP").slice(0,N("AJAX_REQUEST_CONCURRENT")).map(o=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap"));return await Mz(n,e,t,i,r)}async function jz(e,t,i){let r=N("UAP_AP").slice(0,N("AJAX_REQUEST_CONCURRENT")).map(o=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")),n=r.map(o=>function(a,l,d,u){let p={command:"convergeAllocateEdge",sid:l.sid,appId:l.appId,token:l.token,ts:Date.now(),version:mn,cname:l.cname,uid:l.uid.toString(),requestId:aT,seq:aT};aT+=1;let m={service_name:"tele_channel",json_body:JSON.stringify(p)};return uo(async()=>{let f=await _o(a,{data:m,cancelToken:d,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(f.code!==0){let I=new U(A.UNEXPECTED_RESPONSE,"cross channel ap error, code"+f.code,{retry:!0});throw S.error(I.toString()),I}let E=JSON.parse(f.json_body);if(E.code!==200){let I=new U(A.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(E.code,", reason: ").concat(E.reason));throw S.error(I.toString()),I}if(!E.servers||E.servers.length===0){let I=new U(A.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw S.error(I.toString()),I}return{vid:E.vid,workerToken:E.workerToken,addressList:(N("CHANNEL_MEDIA_RELAY_SERVERS")||E.servers).map(I=>"wss://".concat(I.address.replace(/\./g,"-"),".").concat(N("WORKER_DOMAIN"),":").concat(I.wss))}},void 0,f=>!!(f.code!==A.OPERATION_ABORTED&&f.code!==A.UNEXPECTED_RESPONSE||f.data&&f.data.retry),u)}(o,e,t,i));try{let o=await kl(n);return n.forEach(a=>a.cancel()),o}catch(o){throw o[0]}}async function Bz(e,t,i){let r=null,n=[],o=async a=>{let l=N(a?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(d=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(d+"/api/v2/transpond/webrtc?v=2"):"https://".concat(d,"/api/v2/transpond/webrtc?v=2"));return a&&(await mi(1e3),r!==null)?r:await Au({fragementLength:N("FRAGEMENT_LENGTH"),referenceList:l,asyncMapHandler:d=>(S.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(a?"backup":""," choose_server:"),d),function(u,p,m,f){let[E]=xz(p,[Xt.CHOOSE_SERVER]),I=Vt.networkState;return uo(async()=>{I&&Vt.networkState===ir.OFFLINE&&Vt.onlineWaiter&&await ne.race([Vt.onlineWaiter,mi(f&&f.maxRetryTimeout||Jt.maxRetryTimeout)]),I=Vt.networkState;let T=await _o(u,{data:E,cancelToken:m,headers:{"Content-Type":"multipart/form-data;"}},!0);return Uz(T,u)},()=>!1,T=>T.code!==A.OPERATION_ABORTED&&(T.code===A.UPDATE_TICKET_FAILED?T.data.retry:(S.warning("[".concat(p.clientId,"] update ticket network error, retry"),T),!0)),f)}(d,e,t,i)),allFailedhandler:d=>{throw d[0]},promisesCollector:n})};try{return r=await kl([o(!1),o(!0)]),n.length&&n.forEach(a=>a.cancel&&typeof a.cancel=="function"&&a.cancel()),r}catch(a){throw a[0]}}function PN(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function kN(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?PN(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):PN(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class Gz extends Ot{get isSuccess(){return!!this.configs}constructor(){super(),y(this,"configs",void 0),y(this,"joinInfo",void 0),y(this,"cancelToken",void 0),y(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),y(this,"interval",void 0),y(this,"mutex",new Ti("config-distribute")),y(this,"mutableParamsRead",!1)}startGetConfigDistribute(t,i){this.joinInfo=t,this.cancelToken=i,this.interval&&this.stopGetConfigDistribute(),N("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},N("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,_e.reportApiInvoke(null,{options:void 0,name:ei.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:xt.TRACER}).onSuccess(JSON.stringify(Qs))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void S.debug("[config-distribute] get config distribute interrupted have no joininfo");let t,i=await this.mutex.lock();try{t=await Fz(this.joinInfo,this.cancelToken,this.retryConfig),S.debug("[config-distribute] get config distribute",JSON.stringify(t)),t.limit_bitrate&&this.handleBitrateLimit(t.limit_bitrate),this.cacheGlobalParameterConfig(t),this.configs=t}catch(r){let n=new U(A.NETWORK_RESPONSE_ERROR,r);S.warning("[config-distribute] ".concat(n.toString()))}finally{i()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(t){var i;(i=t)&&i.uplink&&i.id&&i.uplink.max_bitrate!==void 0&&i.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==t.id&&this.emit(QS.UPDATE_BITRATE_LIMIT,t):this.emit(QS.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&kN({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(t){var i;let r=tu(i=Object.keys(t).filter(o=>/^webrtc_ng_global_parameter/.test(o))).call(i);for(let o=0;o<r.length;o++)for(let a=r.length-1;a>o;a--){let l=r[a];if(typeof t[l].__priority=="number"){let d=t[l].__priority,u=r[a-1];if(typeof t[u].__priority=="number"){if(!(d>t[u].__priority))continue;{let p=l;r[a]=r[a-1],r[a-1]=p}}else{let p=l;r[a]=r[a-1],r[a-1]=p}}}let n={};r.forEach(o=>{let a=t[o],l=a.__expires;Object.keys(a).forEach(d=>{d==="__priority"||d==="__expires"||Object.prototype.hasOwnProperty.call(n,d)||(n[d]=kN({value:a[d]},l&&{expires:l}))})});try{(function(l){try{let d=Date.now();Object.keys(l).forEach(u=>{switch(u){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(oi,u)){let{value:p,expires:m}=l[u];if(m&&m<=d)return;Qs[u]=p,oi[u]=p,S.debug("Update global parameters from config distribute",u,p)}}})}catch(d){S.error("Error update config immediately: ".concat(l),d.message)}})(n);let o=JSON.stringify(n),a=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",a),S.debug("Caching global parameters ".concat(o))}catch(o){S.error("Error caching global parameters:",o.message)}}}var jn,Wz=g($b),LN=dr,Hz=K,Kz=Le,zz=v,uT=hp,Yz=Hd,qz=lt,Jz=ko,Xz=tp,Ll=Object.assign,MN=Object.defineProperty,Qz=Hz([].concat),Zz=!Ll||zz(function(){if(LN&&Ll({b:1},Ll(MN({},"a",{enumerable:!0,get:function(){MN(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var e={},t={},i=Symbol(),r="abcdefghijklmnopqrst";return e[i]=7,r.split("").forEach(function(n){t[n]=n}),Ll({},e)[i]!=7||uT(Ll({},t)).join("")!=r})?function(e,t){for(var i=Jz(e),r=arguments.length,n=1,o=Yz.f,a=qz.f;r>n;)for(var l,d=Xz(arguments[n++]),u=o?Qz(uT(d),o(d)):uT(d),p=u.length,m=0;p>m;)l=u[m++],LN&&!Kz(a,d,l)||(i[l]=d[l]);return i}:Ll,$z=Tr,eY=hI,tY=Vs,iY=Le,rY=ko,nY=function(e,t,i,r){try{return r?t($z(i)[0],i[1]):t(i)}catch(n){eY(e,"throw",n)}},oY=lI,sY=yp,aY=cs,UN=xp,cY=bE,lY=_p,xN=Array,dc=K,hT=2147483647,dY=/[^\0-\u007E]/,VN=/[.\u3002\uFF0E\uFF61]/g,FN="Overflow: input needs wider integers to process",jN=RangeError,uY=dc(VN.exec),Ml=Math.floor,pT=String.fromCharCode,BN=dc("".charCodeAt),GN=dc([].join),ra=dc([].push),hY=dc("".replace),pY=dc("".split),mY=dc("".toLowerCase),WN=function(e){return e+22+75*(e<26)},_Y=function(e,t,i){var r=0;for(e=i?Ml(e/700):e>>1,e+=Ml(e/t);e>455;)e=Ml(e/35),r+=36;return Ml(r+36*e/(e+38))},fY=function(e){var t=[];e=function(w){for(var O=[],P=0,M=w.length;P<M;){var V=BN(w,P++);if(V>=55296&&V<=56319&&P<M){var F=BN(w,P++);(64512&F)==56320?ra(O,((1023&V)<<10)+(1023&F)+65536):(ra(O,V),P--)}else ra(O,V)}return O}(e);var i,r,n=e.length,o=128,a=0,l=72;for(i=0;i<e.length;i++)(r=e[i])<128&&ra(t,pT(r));var d=t.length,u=d;for(d&&ra(t,"-");u<n;){var p=hT;for(i=0;i<e.length;i++)(r=e[i])>=o&&r<p&&(p=r);var m=u+1;if(p-o>Ml((hT-a)/m))throw jN(FN);for(a+=(p-o)*m,o=p,i=0;i<e.length;i++){if((r=e[i])<o&&++a>hT)throw jN(FN);if(r==o){for(var f=a,E=36;;){var I=E<=l?1:E>=l+26?26:E-l;if(f<I)break;var T=f-I,R=36-I;ra(t,pT(WN(I+T%R))),f=Ml(T/R),E+=36}ra(t,pT(WN(f))),l=_Y(a,m,u==d),a=0,u++}}a++,o++}return GN(t,"")},EY=Tt,mT=dr,gY=rS,_T=le,HN=Vs,Bn=K,bm=js,Gn=Cp,SY=GE,fT=Fi,ET=Zz,Ul=function(e){var t=rY(e),i=sY(this),r=arguments.length,n=r>1?arguments[1]:void 0,o=n!==void 0;o&&(n=tY(n,r>2?arguments[2]:void 0));var a,l,d,u,p,m,f=lY(t),E=0;if(!f||this===xN&&oY(f))for(a=aY(t),l=i?new this(a):xN(a);a>E;E++)m=o?n(t[E],E):t[E],UN(l,E,m);else for(p=(u=cY(t,f)).next,l=i?new this:[];!(d=iY(p,u)).done;E++)m=o?nY(u,n,[d.value,E],!0):d.value,UN(l,E,m);return l.length=E,l},fo=Dg,TY=Sg.codeAt,vY=function(e){var t,i,r=[],n=pY(hY(mY(e),VN,"."),".");for(t=0;t<n.length;t++)i=n[t],ra(r,uY(dY,i)?"xn--"+fY(i):i);return GN(r,".")},fs=hn,RY=Bs,CY=Ip,KN=OK,zN=Ja,yY=zN.set,Nm=zN.getterFor("URL"),IY=KN.URLSearchParams,wY=KN.getState,Ou=_T.URL,gT=_T.TypeError,Dm=_T.parseInt,AY=Math.floor,YN=Math.pow,Wn=Bn("".charAt),Eo=Bn(/./.exec),bu=Bn([].join),OY=Bn(1 .toString),bY=Bn([].pop),xl=Bn([].push),ST=Bn("".replace),NY=Bn([].shift),DY=Bn("".split),Nu=Bn("".slice),Pm=Bn("".toLowerCase),PY=Bn([].unshift),TT="Invalid scheme",Du="Invalid host",qN="Invalid port",JN=/[a-z]/i,kY=/[\d+-.a-z]/i,vT=/\d/,LY=/^0x/i,MY=/^[0-7]+$/,UY=/^\d+$/,XN=/^[\da-f]+$/i,xY=/[\0\t\n\r #%/:<>?@[\\\]^|]/,VY=/[\0\t\n\r #/:<>?@[\\\]^|]/,FY=/^[\u0000-\u0020]+/,jY=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,BY=/[\t\n\r]/g,Pu=function(e){var t,i,r,n;if(typeof e=="number"){for(t=[],i=0;i<4;i++)PY(t,e%256),e=AY(e/256);return bu(t,".")}if(typeof e=="object"){for(t="",r=function(o){for(var a=null,l=1,d=null,u=0,p=0;p<8;p++)o[p]!==0?(u>l&&(a=d,l=u),d=null,u=0):(d===null&&(d=p),++u);return u>l&&(a=d,l=u),a}(e),i=0;i<8;i++)n&&e[i]===0||(n&&(n=!1),r===i?(t+=i?":":"::",n=!0):(t+=OY(e[i],16),i<7&&(t+=":")));return"["+t+"]"}return e},km={},QN=ET({},km,{" ":1,'"':1,"<":1,">":1,"`":1}),ZN=ET({},QN,{"#":1,"?":1,"{":1,"}":1}),RT=ET({},ZN,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),na=function(e,t){var i=TY(e,0);return i>32&&i<127&&!fT(t,e)?e:encodeURIComponent(e)},Lm={ftp:21,file:null,http:80,https:443,ws:80,wss:443},ku=function(e,t){var i;return e.length==2&&Eo(JN,Wn(e,0))&&((i=Wn(e,1))==":"||!t&&i=="|")},$N=function(e){var t;return e.length>1&&ku(Nu(e,0,2))&&(e.length==2||(t=Wn(e,2))==="/"||t==="\\"||t==="?"||t==="#")},GY=function(e){return e==="."||Pm(e)==="%2e"},CT={},eD={},yT={},tD={},iD={},IT={},rD={},nD={},Mm={},Um={},wT={},AT={},OT={},bT={},oD={},NT={},Vl={},Ho={},sD={},uc={},Es={},DT=function(e,t,i){var r,n,o,a=fs(e);if(t){if(n=this.parse(a))throw gT(n);this.searchParams=null}else{if(i!==void 0&&(r=new DT(i,!0)),n=this.parse(a,null,r))throw gT(n);(o=wY(new IY)).bindURL(this),this.searchParams=o}};DT.prototype={type:"URL",parse:function(e,t,i){var r,n,o,a,l,d=this,u=t||CT,p=0,m="",f=!1,E=!1,I=!1;for(e=fs(e),t||(d.scheme="",d.username="",d.password="",d.host=null,d.port=null,d.path=[],d.query=null,d.fragment=null,d.cannotBeABaseURL=!1,e=ST(e,FY,""),e=ST(e,jY,"$1")),e=ST(e,BY,""),r=Ul(e);p<=r.length;){switch(n=r[p],u){case CT:if(!n||!Eo(JN,n)){if(t)return TT;u=yT;continue}m+=Pm(n),u=eD;break;case eD:if(n&&(Eo(kY,n)||n=="+"||n=="-"||n=="."))m+=Pm(n);else{if(n!=":"){if(t)return TT;m="",u=yT,p=0;continue}if(t&&(d.isSpecial()!=fT(Lm,m)||m=="file"&&(d.includesCredentials()||d.port!==null)||d.scheme=="file"&&!d.host))return;if(d.scheme=m,t)return void(d.isSpecial()&&Lm[d.scheme]==d.port&&(d.port=null));m="",d.scheme=="file"?u=bT:d.isSpecial()&&i&&i.scheme==d.scheme?u=tD:d.isSpecial()?u=nD:r[p+1]=="/"?(u=iD,p++):(d.cannotBeABaseURL=!0,xl(d.path,""),u=sD)}break;case yT:if(!i||i.cannotBeABaseURL&&n!="#")return TT;if(i.cannotBeABaseURL&&n=="#"){d.scheme=i.scheme,d.path=fo(i.path),d.query=i.query,d.fragment="",d.cannotBeABaseURL=!0,u=Es;break}u=i.scheme=="file"?bT:IT;continue;case tD:if(n!="/"||r[p+1]!="/"){u=IT;continue}u=Mm,p++;break;case iD:if(n=="/"){u=Um;break}u=Ho;continue;case IT:if(d.scheme=i.scheme,n==jn)d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=fo(i.path),d.query=i.query;else if(n=="/"||n=="\\"&&d.isSpecial())u=rD;else if(n=="?")d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=fo(i.path),d.query="",u=uc;else{if(n!="#"){d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=fo(i.path),d.path.length--,u=Ho;continue}d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,d.path=fo(i.path),d.query=i.query,d.fragment="",u=Es}break;case rD:if(!d.isSpecial()||n!="/"&&n!="\\"){if(n!="/"){d.username=i.username,d.password=i.password,d.host=i.host,d.port=i.port,u=Ho;continue}u=Um}else u=Mm;break;case nD:if(u=Mm,n!="/"||Wn(m,p+1)!="/")continue;p++;break;case Mm:if(n!="/"&&n!="\\"){u=Um;continue}break;case Um:if(n=="@"){f&&(m="%40"+m),f=!0,o=Ul(m);for(var T=0;T<o.length;T++){var R=o[T];if(R!=":"||I){var w=na(R,RT);I?d.password+=w:d.username+=w}else I=!0}m=""}else if(n==jn||n=="/"||n=="?"||n=="#"||n=="\\"&&d.isSpecial()){if(f&&m=="")return"Invalid authority";p-=Ul(m).length+1,m="",u=wT}else m+=n;break;case wT:case AT:if(t&&d.scheme=="file"){u=NT;continue}if(n!=":"||E){if(n==jn||n=="/"||n=="?"||n=="#"||n=="\\"&&d.isSpecial()){if(d.isSpecial()&&m=="")return Du;if(t&&m==""&&(d.includesCredentials()||d.port!==null))return;if(a=d.parseHost(m))return a;if(m="",u=Vl,t)return;continue}n=="["?E=!0:n=="]"&&(E=!1),m+=n}else{if(m=="")return Du;if(a=d.parseHost(m))return a;if(m="",u=OT,t==AT)return}break;case OT:if(!Eo(vT,n)){if(n==jn||n=="/"||n=="?"||n=="#"||n=="\\"&&d.isSpecial()||t){if(m!=""){var O=Dm(m,10);if(O>65535)return qN;d.port=d.isSpecial()&&O===Lm[d.scheme]?null:O,m=""}if(t)return;u=Vl;continue}return qN}m+=n;break;case bT:if(d.scheme="file",n=="/"||n=="\\")u=oD;else{if(!i||i.scheme!="file"){u=Ho;continue}if(n==jn)d.host=i.host,d.path=fo(i.path),d.query=i.query;else if(n=="?")d.host=i.host,d.path=fo(i.path),d.query="",u=uc;else{if(n!="#"){$N(bu(fo(r,p),""))||(d.host=i.host,d.path=fo(i.path),d.shortenPath()),u=Ho;continue}d.host=i.host,d.path=fo(i.path),d.query=i.query,d.fragment="",u=Es}}break;case oD:if(n=="/"||n=="\\"){u=NT;break}i&&i.scheme=="file"&&!$N(bu(fo(r,p),""))&&(ku(i.path[0],!0)?xl(d.path,i.path[0]):d.host=i.host),u=Ho;continue;case NT:if(n==jn||n=="/"||n=="\\"||n=="?"||n=="#"){if(!t&&ku(m))u=Ho;else if(m==""){if(d.host="",t)return;u=Vl}else{if(a=d.parseHost(m))return a;if(d.host=="localhost"&&(d.host=""),t)return;m="",u=Vl}continue}m+=n;break;case Vl:if(d.isSpecial()){if(u=Ho,n!="/"&&n!="\\")continue}else if(t||n!="?")if(t||n!="#"){if(n!=jn&&(u=Ho,n!="/"))continue}else d.fragment="",u=Es;else d.query="",u=uc;break;case Ho:if(n==jn||n=="/"||n=="\\"&&d.isSpecial()||!t&&(n=="?"||n=="#")){if((l=Pm(l=m))===".."||l==="%2e."||l===".%2e"||l==="%2e%2e"?(d.shortenPath(),n=="/"||n=="\\"&&d.isSpecial()||xl(d.path,"")):GY(m)?n=="/"||n=="\\"&&d.isSpecial()||xl(d.path,""):(d.scheme=="file"&&!d.path.length&&ku(m)&&(d.host&&(d.host=""),m=Wn(m,0)+":"),xl(d.path,m)),m="",d.scheme=="file"&&(n==jn||n=="?"||n=="#"))for(;d.path.length>1&&d.path[0]==="";)NY(d.path);n=="?"?(d.query="",u=uc):n=="#"&&(d.fragment="",u=Es)}else m+=na(n,ZN);break;case sD:n=="?"?(d.query="",u=uc):n=="#"?(d.fragment="",u=Es):n!=jn&&(d.path[0]+=na(n,km));break;case uc:t||n!="#"?n!=jn&&(n=="'"&&d.isSpecial()?d.query+="%27":d.query+=n=="#"?"%23":na(n,km)):(d.fragment="",u=Es);break;case Es:n!=jn&&(d.fragment+=na(n,QN))}p++}},parseHost:function(e){var t,i,r;if(Wn(e,0)=="["){if(Wn(e,e.length-1)!="]"||(t=function(n){var o,a,l,d,u,p,m,f=[0,0,0,0,0,0,0,0],E=0,I=null,T=0,R=function(){return Wn(n,T)};if(R()==":"){if(Wn(n,1)!=":")return;T+=2,I=++E}for(;R();){if(E==8)return;if(R()!=":"){for(o=a=0;a<4&&Eo(XN,R());)o=16*o+Dm(R(),16),T++,a++;if(R()=="."){if(a==0||(T-=a,E>6))return;for(l=0;R();){if(d=null,l>0){if(!(R()=="."&&l<4))return;T++}if(!Eo(vT,R()))return;for(;Eo(vT,R());){if(u=Dm(R(),10),d===null)d=u;else{if(d==0)return;d=10*d+u}if(d>255)return;T++}f[E]=256*f[E]+d,++l!=2&&l!=4||E++}if(l!=4)return;break}if(R()==":"){if(T++,!R())return}else if(R())return;f[E++]=o}else{if(I!==null)return;T++,I=++E}}if(I!==null)for(p=E-I,E=7;E!=0&&p>0;)m=f[E],f[E--]=f[I+p-1],f[I+--p]=m;else if(E!=8)return;return f}(Nu(e,1,-1)),!t))return Du;this.host=t}else if(this.isSpecial()){if(e=vY(e),Eo(xY,e)||(t=function(n){var o,a,l,d,u,p,m,f=DY(n,".");if(f.length&&f[f.length-1]==""&&f.length--,(o=f.length)>4)return n;for(a=[],l=0;l<o;l++){if((d=f[l])=="")return n;if(u=10,d.length>1&&Wn(d,0)=="0"&&(u=Eo(LY,d)?16:8,d=Nu(d,u==8?1:2)),d==="")p=0;else{if(!Eo(u==10?UY:u==8?MY:XN,d))return n;p=Dm(d,u)}xl(a,p)}for(l=0;l<o;l++)if(p=a[l],l==o-1){if(p>=YN(256,5-o))return null}else if(p>255)return null;for(m=bY(a),l=0;l<a.length;l++)m+=a[l]*YN(256,3-l);return m}(e),t===null))return Du;this.host=t}else{if(Eo(VY,e))return Du;for(t="",i=Ul(e),r=0;r<i.length;r++)t+=na(i[r],km);this.host=t}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme=="file"},includesCredentials:function(){return this.username!=""||this.password!=""},isSpecial:function(){return fT(Lm,this.scheme)},shortenPath:function(){var e=this.path,t=e.length;!t||this.scheme=="file"&&t==1&&ku(e[0],!0)||e.length--},serialize:function(){var e=this,t=e.scheme,i=e.username,r=e.password,n=e.host,o=e.port,a=e.path,l=e.query,d=e.fragment,u=t+":";return n!==null?(u+="//",e.includesCredentials()&&(u+=i+(r?":"+r:"")+"@"),u+=Pu(n),o!==null&&(u+=":"+o)):t=="file"&&(u+="//"),u+=e.cannotBeABaseURL?a[0]:a.length?"/"+bu(a,"/"):"",l!==null&&(u+="?"+l),d!==null&&(u+="#"+d),u},setHref:function(e){var t=this.parse(e);if(t)throw gT(t);this.searchParams.update()},getOrigin:function(){var e=this.scheme,t=this.port;if(e=="blob")try{return new Fl(e.path[0]).origin}catch{return"null"}return e!="file"&&this.isSpecial()?e+"://"+Pu(this.host)+(t!==null?":"+t:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(e){this.parse(fs(e)+":",CT)},getUsername:function(){return this.username},setUsername:function(e){var t=Ul(fs(e));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<t.length;i++)this.username+=na(t[i],RT)}},getPassword:function(){return this.password},setPassword:function(e){var t=Ul(fs(e));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<t.length;i++)this.password+=na(t[i],RT)}},getHost:function(){var e=this.host,t=this.port;return e===null?"":t===null?Pu(e):Pu(e)+":"+t},setHost:function(e){this.cannotBeABaseURL||this.parse(e,wT)},getHostname:function(){var e=this.host;return e===null?"":Pu(e)},setHostname:function(e){this.cannotBeABaseURL||this.parse(e,AT)},getPort:function(){var e=this.port;return e===null?"":fs(e)},setPort:function(e){this.cannotHaveUsernamePasswordPort()||((e=fs(e))==""?this.port=null:this.parse(e,OT))},getPathname:function(){var e=this.path;return this.cannotBeABaseURL?e[0]:e.length?"/"+bu(e,"/"):""},setPathname:function(e){this.cannotBeABaseURL||(this.path=[],this.parse(e,Vl))},getSearch:function(){var e=this.query;return e?"?"+e:""},setSearch:function(e){(e=fs(e))==""?this.query=null:(Wn(e,0)=="?"&&(e=Nu(e,1)),this.query="",this.parse(e,uc)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var e=this.fragment;return e?"#"+e:""},setHash:function(e){(e=fs(e))!=""?(Wn(e,0)=="#"&&(e=Nu(e,1)),this.fragment="",this.parse(e,Es)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var Fl=function(e){var t=SY(this,xr),i=CY(arguments.length,1)>1?arguments[1]:void 0,r=yY(t,new DT(e,!1,i));mT||(t.href=r.serialize(),t.origin=r.getOrigin(),t.protocol=r.getProtocol(),t.username=r.getUsername(),t.password=r.getPassword(),t.host=r.getHost(),t.hostname=r.getHostname(),t.port=r.getPort(),t.pathname=r.getPathname(),t.search=r.getSearch(),t.searchParams=r.getSearchParams(),t.hash=r.getHash())},xr=Fl.prototype,Hn=function(e,t){return{get:function(){return Nm(this)[e]()},set:t&&function(i){return Nm(this)[t](i)},configurable:!0,enumerable:!0}};if(mT&&(Gn(xr,"href",Hn("serialize","setHref")),Gn(xr,"origin",Hn("getOrigin")),Gn(xr,"protocol",Hn("getProtocol","setProtocol")),Gn(xr,"username",Hn("getUsername","setUsername")),Gn(xr,"password",Hn("getPassword","setPassword")),Gn(xr,"host",Hn("getHost","setHost")),Gn(xr,"hostname",Hn("getHostname","setHostname")),Gn(xr,"port",Hn("getPort","setPort")),Gn(xr,"pathname",Hn("getPathname","setPathname")),Gn(xr,"search",Hn("getSearch","setSearch")),Gn(xr,"searchParams",Hn("getSearchParams")),Gn(xr,"hash",Hn("getHash","setHash"))),bm(xr,"toJSON",function(){return Nm(this).serialize()},{enumerable:!0}),bm(xr,"toString",function(){return Nm(this).serialize()},{enumerable:!0}),Ou){var aD=Ou.createObjectURL,cD=Ou.revokeObjectURL;aD&&bm(Fl,"createObjectURL",HN(aD,Ou)),cD&&bm(Fl,"revokeObjectURL",HN(cD,Ou))}RY(Fl,"URL"),EY({global:!0,constructor:!0,forced:!gY,sham:!mT},{URL:Fl});var WY=Tt,HY=v,KY=Ip,lD=hn,zY=rS,dD=Lr("URL");WY({target:"URL",stat:!0,forced:!(zY&&HY(function(){dD.canParse()}))},{canParse:function(e){var t=KY(arguments.length,1),i=lD(e),r=t<2||arguments[1]===void 0?void 0:lD(arguments[1]);try{return!!new dD(i,r)}catch{return!1}}});var uD=g(so.URL),YY=$,qY=FO,hD=RegExp.prototype,JY=function(e){return e===hD||YY(hD,e)?qY(e):e.flags},Xi=g(JY);function jl(e){let t=e.length;for(;--t>=0;)e[t]=0}let PT=256,pD=286,Lu=30,Mu=15,kT=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),xm=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),XY=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),mD=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),gs=new Array(576);jl(gs);let Uu=new Array(60);jl(Uu);let xu=new Array(512);jl(xu);let Vu=new Array(256);jl(Vu);let LT=new Array(29);jl(LT);let Vm=new Array(Lu);function MT(e,t,i,r,n){this.static_tree=e,this.extra_bits=t,this.extra_base=i,this.elems=r,this.max_length=n,this.has_stree=e&&e.length}let _D,fD,ED;function UT(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}jl(Vm);let gD=e=>e<256?xu[e]:xu[256+(e>>>7)],Fu=(e,t)=>{e.pending_buf[e.pending++]=255&t,e.pending_buf[e.pending++]=t>>>8&255},Xr=(e,t,i)=>{e.bi_valid>16-i?(e.bi_buf|=t<<e.bi_valid&65535,Fu(e,e.bi_buf),e.bi_buf=t>>16-e.bi_valid,e.bi_valid+=i-16):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=i)},Ko=(e,t,i)=>{Xr(e,i[2*t],i[2*t+1])},SD=(e,t)=>{let i=0;do i|=1&e,e>>>=1,i<<=1;while(--t>0);return i>>>1},TD=(e,t,i)=>{let r=new Array(16),n,o,a=0;for(n=1;n<=Mu;n++)a=a+i[n-1]<<1,r[n]=a;for(o=0;o<=t;o++){let l=e[2*o+1];l!==0&&(e[2*o]=SD(r[l]++,l))}},vD=e=>{let t;for(t=0;t<pD;t++)e.dyn_ltree[2*t]=0;for(t=0;t<Lu;t++)e.dyn_dtree[2*t]=0;for(t=0;t<19;t++)e.bl_tree[2*t]=0;e.dyn_ltree[512]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},RD=e=>{e.bi_valid>8?Fu(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},CD=(e,t,i,r)=>{let n=2*t,o=2*i;return e[n]<e[o]||e[n]===e[o]&&r[t]<=r[i]},xT=(e,t,i)=>{let r=e.heap[i],n=i<<1;for(;n<=e.heap_len&&(n<e.heap_len&&CD(t,e.heap[n+1],e.heap[n],e.depth)&&n++,!CD(t,r,e.heap[n],e.depth));)e.heap[i]=e.heap[n],i=n,n<<=1;e.heap[i]=r},yD=(e,t,i)=>{let r,n,o,a,l=0;if(e.sym_next!==0)do r=255&e.pending_buf[e.sym_buf+l++],r+=(255&e.pending_buf[e.sym_buf+l++])<<8,n=e.pending_buf[e.sym_buf+l++],r===0?Ko(e,n,t):(o=Vu[n],Ko(e,o+PT+1,t),a=kT[o],a!==0&&(n-=LT[o],Xr(e,n,a)),r--,o=gD(r),Ko(e,o,i),a=xm[o],a!==0&&(r-=Vm[o],Xr(e,r,a)));while(l<e.sym_next);Ko(e,256,t)},VT=(e,t)=>{let i=t.dyn_tree,r=t.stat_desc.static_tree,n=t.stat_desc.has_stree,o=t.stat_desc.elems,a,l,d,u=-1;for(e.heap_len=0,e.heap_max=573,a=0;a<o;a++)i[2*a]!==0?(e.heap[++e.heap_len]=u=a,e.depth[a]=0):i[2*a+1]=0;for(;e.heap_len<2;)d=e.heap[++e.heap_len]=u<2?++u:0,i[2*d]=1,e.depth[d]=0,e.opt_len--,n&&(e.static_len-=r[2*d+1]);for(t.max_code=u,a=e.heap_len>>1;a>=1;a--)xT(e,i,a);d=o;do a=e.heap[1],e.heap[1]=e.heap[e.heap_len--],xT(e,i,1),l=e.heap[1],e.heap[--e.heap_max]=a,e.heap[--e.heap_max]=l,i[2*d]=i[2*a]+i[2*l],e.depth[d]=(e.depth[a]>=e.depth[l]?e.depth[a]:e.depth[l])+1,i[2*a+1]=i[2*l+1]=d,e.heap[1]=d++,xT(e,i,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],((p,m)=>{let f=m.dyn_tree,E=m.max_code,I=m.stat_desc.static_tree,T=m.stat_desc.has_stree,R=m.stat_desc.extra_bits,w=m.stat_desc.extra_base,O=m.stat_desc.max_length,P,M,V,F,Y,J,Z=0;for(F=0;F<=Mu;F++)p.bl_count[F]=0;for(f[2*p.heap[p.heap_max]+1]=0,P=p.heap_max+1;P<573;P++)M=p.heap[P],F=f[2*f[2*M+1]+1]+1,F>O&&(F=O,Z++),f[2*M+1]=F,M>E||(p.bl_count[F]++,Y=0,M>=w&&(Y=R[M-w]),J=f[2*M],p.opt_len+=J*(F+Y),T&&(p.static_len+=J*(I[2*M+1]+Y)));if(Z!==0){do{for(F=O-1;p.bl_count[F]===0;)F--;p.bl_count[F]--,p.bl_count[F+1]+=2,p.bl_count[O]--,Z-=2}while(Z>0);for(F=O;F!==0;F--)for(M=p.bl_count[F];M!==0;)V=p.heap[--P],V>E||(f[2*V+1]!==F&&(p.opt_len+=(F-f[2*V+1])*f[2*V],f[2*V+1]=F),M--)}})(e,t),TD(i,u,e.bl_count)},ID=(e,t,i)=>{let r,n,o=-1,a=t[1],l=0,d=7,u=4;for(a===0&&(d=138,u=3),t[2*(i+1)+1]=65535,r=0;r<=i;r++)n=a,a=t[2*(r+1)+1],++l<d&&n===a||(l<u?e.bl_tree[2*n]+=l:n!==0?(n!==o&&e.bl_tree[2*n]++,e.bl_tree[32]++):l<=10?e.bl_tree[34]++:e.bl_tree[36]++,l=0,o=n,a===0?(d=138,u=3):n===a?(d=6,u=3):(d=7,u=4))},wD=(e,t,i)=>{let r,n,o=-1,a=t[1],l=0,d=7,u=4;for(a===0&&(d=138,u=3),r=0;r<=i;r++)if(n=a,a=t[2*(r+1)+1],!(++l<d&&n===a)){if(l<u)do Ko(e,n,e.bl_tree);while(--l!=0);else n!==0?(n!==o&&(Ko(e,n,e.bl_tree),l--),Ko(e,16,e.bl_tree),Xr(e,l-3,2)):l<=10?(Ko(e,17,e.bl_tree),Xr(e,l-3,3)):(Ko(e,18,e.bl_tree),Xr(e,l-11,7));l=0,o=n,a===0?(d=138,u=3):n===a?(d=6,u=3):(d=7,u=4)}},AD=!1,OD=(e,t,i,r)=>{Xr(e,0+(r?1:0),3),RD(e),Fu(e,i),Fu(e,~i),i&&e.pending_buf.set(e.window.subarray(t,t+i),e.pending),e.pending+=i};var QY=e=>{AD||((()=>{let t,i,r,n,o,a=new Array(16);for(r=0,n=0;n<28;n++)for(LT[n]=r,t=0;t<1<<kT[n];t++)Vu[r++]=n;for(Vu[r-1]=n,o=0,n=0;n<16;n++)for(Vm[n]=o,t=0;t<1<<xm[n];t++)xu[o++]=n;for(o>>=7;n<Lu;n++)for(Vm[n]=o<<7,t=0;t<1<<xm[n]-7;t++)xu[256+o++]=n;for(i=0;i<=Mu;i++)a[i]=0;for(t=0;t<=143;)gs[2*t+1]=8,t++,a[8]++;for(;t<=255;)gs[2*t+1]=9,t++,a[9]++;for(;t<=279;)gs[2*t+1]=7,t++,a[7]++;for(;t<=287;)gs[2*t+1]=8,t++,a[8]++;for(TD(gs,287,a),t=0;t<Lu;t++)Uu[2*t+1]=5,Uu[2*t]=SD(t,5);_D=new MT(gs,kT,257,pD,Mu),fD=new MT(Uu,xm,0,Lu,Mu),ED=new MT(new Array(0),XY,0,19,7)})(),AD=!0),e.l_desc=new UT(e.dyn_ltree,_D),e.d_desc=new UT(e.dyn_dtree,fD),e.bl_desc=new UT(e.bl_tree,ED),e.bi_buf=0,e.bi_valid=0,vD(e)},ZY=(e,t,i,r)=>{let n,o,a=0;e.level>0?(e.strm.data_type===2&&(e.strm.data_type=(l=>{let d,u=4093624447;for(d=0;d<=31;d++,u>>>=1)if(1&u&&l.dyn_ltree[2*d]!==0)return 0;if(l.dyn_ltree[18]!==0||l.dyn_ltree[20]!==0||l.dyn_ltree[26]!==0)return 1;for(d=32;d<PT;d++)if(l.dyn_ltree[2*d]!==0)return 1;return 0})(e)),VT(e,e.l_desc),VT(e,e.d_desc),a=(l=>{let d;for(ID(l,l.dyn_ltree,l.l_desc.max_code),ID(l,l.dyn_dtree,l.d_desc.max_code),VT(l,l.bl_desc),d=18;d>=3&&l.bl_tree[2*mD[d]+1]===0;d--);return l.opt_len+=3*(d+1)+5+5+4,d})(e),n=e.opt_len+3+7>>>3,o=e.static_len+3+7>>>3,o<=n&&(n=o)):n=o=i+5,i+4<=n&&t!==-1?OD(e,t,i,r):e.strategy===4||o===n?(Xr(e,2+(r?1:0),3),yD(e,gs,Uu)):(Xr(e,4+(r?1:0),3),((l,d,u,p)=>{let m;for(Xr(l,d-257,5),Xr(l,u-1,5),Xr(l,p-4,4),m=0;m<p;m++)Xr(l,l.bl_tree[2*mD[m]+1],3);wD(l,l.dyn_ltree,d-1),wD(l,l.dyn_dtree,u-1)})(e,e.l_desc.max_code+1,e.d_desc.max_code+1,a+1),yD(e,e.dyn_ltree,e.dyn_dtree)),vD(e),r&&RD(e)},$Y=(e,t,i)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=i,t===0?e.dyn_ltree[2*i]++:(e.matches++,t--,e.dyn_ltree[2*(Vu[i]+PT+1)]++,e.dyn_dtree[2*gD(t)]++),e.sym_next===e.sym_end),eq=e=>{Xr(e,2,3),Ko(e,256,gs),(t=>{t.bi_valid===16?(Fu(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(e)},tq={_tr_init:QY,_tr_stored_block:OD,_tr_flush_block:ZY,_tr_tally:$Y,_tr_align:eq},ju=(e,t,i,r)=>{let n=65535&e|0,o=e>>>16&65535|0,a=0;for(;i!==0;){a=i>2e3?2e3:i,i-=a;do n=n+t[r++]|0,o=o+n|0;while(--a);n%=65521,o%=65521}return n|o<<16|0};let iq=new Uint32Array((()=>{let e,t=[];for(var i=0;i<256;i++){e=i;for(var r=0;r<8;r++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t})());var sr=(e,t,i,r)=>{let n=iq,o=r+i;e^=-1;for(let a=r;a<o;a++)e=e>>>8^n[255&(e^t[a])];return-1^e},hc={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Bl={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};let{_tr_init:rq,_tr_stored_block:FT,_tr_flush_block:nq,_tr_tally:oa,_tr_align:oq}=tq,{Z_NO_FLUSH:sa,Z_PARTIAL_FLUSH:sq,Z_FULL_FLUSH:aq,Z_FINISH:Kn,Z_BLOCK:bD,Z_OK:hr,Z_STREAM_END:ND,Z_STREAM_ERROR:zo,Z_DATA_ERROR:cq,Z_BUF_ERROR:jT,Z_DEFAULT_COMPRESSION:lq,Z_FILTERED:dq,Z_HUFFMAN_ONLY:Fm,Z_RLE:uq,Z_FIXED:hq,Z_DEFAULT_STRATEGY:pq,Z_UNKNOWN:mq,Z_DEFLATED:jm}=Bl,BT=286,_q=30,fq=19,Eq=2*BT+1,gq=15,pc=258,Yo=262,Gl=42,mc=113,Bu=666,_c=(e,t)=>(e.msg=hc[t],t),DD=e=>2*e-(e>4?9:0),aa=e=>{let t=e.length;for(;--t>=0;)e[t]=0},Sq=e=>{let t,i,r,n=e.w_size;t=e.hash_size,r=t;do i=e.head[--r],e.head[r]=i>=n?i-n:0;while(--t);t=n,r=t;do i=e.prev[--r],e.prev[r]=i>=n?i-n:0;while(--t)},ca=(e,t,i)=>(t<<e.hash_shift^i)&e.hash_mask,En=e=>{let t=e.state,i=t.pending;i>e.avail_out&&(i=e.avail_out),i!==0&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+i),e.next_out),e.next_out+=i,t.pending_out+=i,e.total_out+=i,e.avail_out-=i,t.pending-=i,t.pending===0&&(t.pending_out=0))},gn=(e,t)=>{nq(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,En(e.strm)},Bt=(e,t)=>{e.pending_buf[e.pending++]=t},Gu=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=255&t},GT=(e,t,i,r)=>{let n=e.avail_in;return n>r&&(n=r),n===0?0:(e.avail_in-=n,t.set(e.input.subarray(e.next_in,e.next_in+n),i),e.state.wrap===1?e.adler=ju(e.adler,t,n,i):e.state.wrap===2&&(e.adler=sr(e.adler,t,n,i)),e.next_in+=n,e.total_in+=n,n)},PD=(e,t)=>{let i,r,n=e.max_chain_length,o=e.strstart,a=e.prev_length,l=e.nice_match,d=e.strstart>e.w_size-Yo?e.strstart-(e.w_size-Yo):0,u=e.window,p=e.w_mask,m=e.prev,f=e.strstart+pc,E=u[o+a-1],I=u[o+a];e.prev_length>=e.good_match&&(n>>=2),l>e.lookahead&&(l=e.lookahead);do if(i=t,u[i+a]===I&&u[i+a-1]===E&&u[i]===u[o]&&u[++i]===u[o+1]){o+=2,i++;do;while(u[++o]===u[++i]&&u[++o]===u[++i]&&u[++o]===u[++i]&&u[++o]===u[++i]&&u[++o]===u[++i]&&u[++o]===u[++i]&&u[++o]===u[++i]&&u[++o]===u[++i]&&o<f);if(r=pc-(f-o),o=f-pc,r>a){if(e.match_start=t,a=r,r>=l)break;E=u[o+a-1],I=u[o+a]}}while((t=m[t&p])>d&&--n!=0);return a<=e.lookahead?a:e.lookahead},Wl=e=>{let t=e.w_size,i,r,n;do{if(r=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-Yo)&&(e.window.set(e.window.subarray(t,t+t-r),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),Sq(e),r+=t),e.strm.avail_in===0)break;if(i=GT(e.strm,e.window,e.strstart+e.lookahead,r),e.lookahead+=i,e.lookahead+e.insert>=3)for(n=e.strstart-e.insert,e.ins_h=e.window[n],e.ins_h=ca(e,e.ins_h,e.window[n+1]);e.insert&&(e.ins_h=ca(e,e.ins_h,e.window[n+3-1]),e.prev[n&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=n,n++,e.insert--,!(e.lookahead+e.insert<3)););}while(e.lookahead<Yo&&e.strm.avail_in!==0)},kD=(e,t)=>{let i,r,n,o=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,a=0,l=e.strm.avail_in;do{if(i=65535,n=e.bi_valid+42>>3,e.strm.avail_out<n||(n=e.strm.avail_out-n,r=e.strstart-e.block_start,i>r+e.strm.avail_in&&(i=r+e.strm.avail_in),i>n&&(i=n),i<o&&(i===0&&t!==Kn||t===sa||i!==r+e.strm.avail_in)))break;a=t===Kn&&i===r+e.strm.avail_in?1:0,FT(e,0,0,a),e.pending_buf[e.pending-4]=i,e.pending_buf[e.pending-3]=i>>8,e.pending_buf[e.pending-2]=~i,e.pending_buf[e.pending-1]=~i>>8,En(e.strm),r&&(r>i&&(r=i),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+r),e.strm.next_out),e.strm.next_out+=r,e.strm.avail_out-=r,e.strm.total_out+=r,e.block_start+=r,i-=r),i&&(GT(e.strm,e.strm.output,e.strm.next_out,i),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i)}while(a===0);return l-=e.strm.avail_in,l&&(l>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=l&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-l,e.strm.next_in),e.strstart),e.strstart+=l,e.insert+=l>e.w_size-e.insert?e.w_size-e.insert:l),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),a?4:t!==sa&&t!==Kn&&e.strm.avail_in===0&&e.strstart===e.block_start?2:(n=e.window_size-e.strstart,e.strm.avail_in>n&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,n+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),n>e.strm.avail_in&&(n=e.strm.avail_in),n&&(GT(e.strm,e.window,e.strstart,n),e.strstart+=n,e.insert+=n>e.w_size-e.insert?e.w_size-e.insert:n),e.high_water<e.strstart&&(e.high_water=e.strstart),n=e.bi_valid+42>>3,n=e.pending_buf_size-n>65535?65535:e.pending_buf_size-n,o=n>e.w_size?e.w_size:n,r=e.strstart-e.block_start,(r>=o||(r||t===Kn)&&t!==sa&&e.strm.avail_in===0&&r<=n)&&(i=r>n?n:r,a=t===Kn&&e.strm.avail_in===0&&i===r?1:0,FT(e,e.block_start,i,a),e.block_start+=i,En(e.strm)),a?3:1)},WT=(e,t)=>{let i,r;for(;;){if(e.lookahead<Yo){if(Wl(e),e.lookahead<Yo&&t===sa)return 1;if(e.lookahead===0)break}if(i=0,e.lookahead>=3&&(e.ins_h=ca(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),i!==0&&e.strstart-i<=e.w_size-Yo&&(e.match_length=PD(e,i)),e.match_length>=3)if(r=oa(e,e.strstart-e.match_start,e.match_length-3),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=3){e.match_length--;do e.strstart++,e.ins_h=ca(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!=0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=ca(e,e.ins_h,e.window[e.strstart+1]);else r=oa(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(r&&(gn(e,!1),e.strm.avail_out===0))return 1}return e.insert=e.strstart<2?e.strstart:2,t===Kn?(gn(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(gn(e,!1),e.strm.avail_out===0)?1:2},Hl=(e,t)=>{let i,r,n;for(;;){if(e.lookahead<Yo){if(Wl(e),e.lookahead<Yo&&t===sa)return 1;if(e.lookahead===0)break}if(i=0,e.lookahead>=3&&(e.ins_h=ca(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=2,i!==0&&e.prev_length<e.max_lazy_match&&e.strstart-i<=e.w_size-Yo&&(e.match_length=PD(e,i),e.match_length<=5&&(e.strategy===dq||e.match_length===3&&e.strstart-e.match_start>4096)&&(e.match_length=2)),e.prev_length>=3&&e.match_length<=e.prev_length){n=e.strstart+e.lookahead-3,r=oa(e,e.strstart-1-e.prev_match,e.prev_length-3),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=n&&(e.ins_h=ca(e,e.ins_h,e.window[e.strstart+3-1]),i=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!=0);if(e.match_available=0,e.match_length=2,e.strstart++,r&&(gn(e,!1),e.strm.avail_out===0))return 1}else if(e.match_available){if(r=oa(e,0,e.window[e.strstart-1]),r&&gn(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return 1}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(r=oa(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<2?e.strstart:2,t===Kn?(gn(e,!0),e.strm.avail_out===0?3:4):e.sym_next&&(gn(e,!1),e.strm.avail_out===0)?1:2};function qo(e,t,i,r,n){this.good_length=e,this.max_lazy=t,this.nice_length=i,this.max_chain=r,this.func=n}let Wu=[new qo(0,0,0,0,kD),new qo(4,4,8,4,WT),new qo(4,5,16,8,WT),new qo(4,6,32,32,WT),new qo(4,4,16,16,Hl),new qo(8,16,32,32,Hl),new qo(8,16,128,128,Hl),new qo(8,32,128,256,Hl),new qo(32,128,258,1024,Hl),new qo(32,258,258,4096,Hl)];function Tq(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=jm,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*Eq),this.dyn_dtree=new Uint16Array(2*(2*_q+1)),this.bl_tree=new Uint16Array(2*(2*fq+1)),aa(this.dyn_ltree),aa(this.dyn_dtree),aa(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(gq+1),this.heap=new Uint16Array(2*BT+1),aa(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*BT+1),aa(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}let Hu=e=>{if(!e)return 1;let t=e.state;return!t||t.strm!==e||t.status!==Gl&&t.status!==57&&t.status!==69&&t.status!==73&&t.status!==91&&t.status!==103&&t.status!==mc&&t.status!==Bu?1:0},LD=e=>{if(Hu(e))return _c(e,zo);e.total_in=e.total_out=0,e.data_type=mq;let t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?57:t.wrap?Gl:mc,e.adler=t.wrap===2?0:1,t.last_flush=-2,rq(t),hr},MD=e=>{let t=LD(e);return t===hr&&(i=>{i.window_size=2*i.w_size,aa(i.head),i.max_lazy_match=Wu[i.level].max_lazy,i.good_match=Wu[i.level].good_length,i.nice_match=Wu[i.level].nice_length,i.max_chain_length=Wu[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0})(e.state),t},UD=(e,t,i,r,n,o)=>{if(!e)return zo;let a=1;if(t===lq&&(t=6),r<0?(a=0,r=-r):r>15&&(a=2,r-=16),n<1||n>9||i!==jm||r<8||r>15||t<0||t>9||o<0||o>hq||r===8&&a!==1)return _c(e,zo);r===8&&(r=9);let l=new Tq;return e.state=l,l.strm=e,l.status=Gl,l.wrap=a,l.gzhead=null,l.w_bits=r,l.w_size=1<<l.w_bits,l.w_mask=l.w_size-1,l.hash_bits=n+7,l.hash_size=1<<l.hash_bits,l.hash_mask=l.hash_size-1,l.hash_shift=~~((l.hash_bits+3-1)/3),l.window=new Uint8Array(2*l.w_size),l.head=new Uint16Array(l.hash_size),l.prev=new Uint16Array(l.w_size),l.lit_bufsize=1<<n+6,l.pending_buf_size=4*l.lit_bufsize,l.pending_buf=new Uint8Array(l.pending_buf_size),l.sym_buf=l.lit_bufsize,l.sym_end=3*(l.lit_bufsize-1),l.level=t,l.strategy=o,l.method=i,MD(e)};var vq=(e,t)=>{if(Hu(e)||t>bD||t<0)return e?_c(e,zo):zo;let i=e.state;if(!e.output||e.avail_in!==0&&!e.input||i.status===Bu&&t!==Kn)return _c(e,e.avail_out===0?jT:zo);let r=i.last_flush;if(i.last_flush=t,i.pending!==0){if(En(e),e.avail_out===0)return i.last_flush=-1,hr}else if(e.avail_in===0&&DD(t)<=DD(r)&&t!==Kn)return _c(e,jT);if(i.status===Bu&&e.avail_in!==0)return _c(e,jT);if(i.status===Gl&&i.wrap===0&&(i.status=mc),i.status===Gl){let n=jm+(i.w_bits-8<<4)<<8,o=-1;if(o=i.strategy>=Fm||i.level<2?0:i.level<6?1:i.level===6?2:3,n|=o<<6,i.strstart!==0&&(n|=32),n+=31-n%31,Gu(i,n),i.strstart!==0&&(Gu(i,e.adler>>>16),Gu(i,65535&e.adler)),e.adler=1,i.status=mc,En(e),i.pending!==0)return i.last_flush=-1,hr}if(i.status===57){if(e.adler=0,Bt(i,31),Bt(i,139),Bt(i,8),i.gzhead)Bt(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),Bt(i,255&i.gzhead.time),Bt(i,i.gzhead.time>>8&255),Bt(i,i.gzhead.time>>16&255),Bt(i,i.gzhead.time>>24&255),Bt(i,i.level===9?2:i.strategy>=Fm||i.level<2?4:0),Bt(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(Bt(i,255&i.gzhead.extra.length),Bt(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(e.adler=sr(e.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(Bt(i,0),Bt(i,0),Bt(i,0),Bt(i,0),Bt(i,0),Bt(i,i.level===9?2:i.strategy>=Fm||i.level<2?4:0),Bt(i,3),i.status=mc,En(e),i.pending!==0)return i.last_flush=-1,hr}if(i.status===69){if(i.gzhead.extra){let n=i.pending,o=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+o>i.pending_buf_size;){let l=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+l),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>n&&(e.adler=sr(e.adler,i.pending_buf,i.pending-n,n)),i.gzindex+=l,En(e),i.pending!==0)return i.last_flush=-1,hr;n=0,o-=l}let a=new Uint8Array(i.gzhead.extra);i.pending_buf.set(a.subarray(i.gzindex,i.gzindex+o),i.pending),i.pending+=o,i.gzhead.hcrc&&i.pending>n&&(e.adler=sr(e.adler,i.pending_buf,i.pending-n,n)),i.gzindex=0}i.status=73}if(i.status===73){if(i.gzhead.name){let n,o=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>o&&(e.adler=sr(e.adler,i.pending_buf,i.pending-o,o)),En(e),i.pending!==0)return i.last_flush=-1,hr;o=0}n=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,Bt(i,n)}while(n!==0);i.gzhead.hcrc&&i.pending>o&&(e.adler=sr(e.adler,i.pending_buf,i.pending-o,o)),i.gzindex=0}i.status=91}if(i.status===91){if(i.gzhead.comment){let n,o=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>o&&(e.adler=sr(e.adler,i.pending_buf,i.pending-o,o)),En(e),i.pending!==0)return i.last_flush=-1,hr;o=0}n=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,Bt(i,n)}while(n!==0);i.gzhead.hcrc&&i.pending>o&&(e.adler=sr(e.adler,i.pending_buf,i.pending-o,o))}i.status=103}if(i.status===103){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(En(e),i.pending!==0))return i.last_flush=-1,hr;Bt(i,255&e.adler),Bt(i,e.adler>>8&255),e.adler=0}if(i.status=mc,En(e),i.pending!==0)return i.last_flush=-1,hr}if(e.avail_in!==0||i.lookahead!==0||t!==sa&&i.status!==Bu){let n=i.level===0?kD(i,t):i.strategy===Fm?((o,a)=>{let l;for(;;){if(o.lookahead===0&&(Wl(o),o.lookahead===0)){if(a===sa)return 1;break}if(o.match_length=0,l=oa(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,l&&(gn(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,a===Kn?(gn(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(gn(o,!1),o.strm.avail_out===0)?1:2})(i,t):i.strategy===uq?((o,a)=>{let l,d,u,p,m=o.window;for(;;){if(o.lookahead<=pc){if(Wl(o),o.lookahead<=pc&&a===sa)return 1;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(u=o.strstart-1,d=m[u],d===m[++u]&&d===m[++u]&&d===m[++u])){p=o.strstart+pc;do;while(d===m[++u]&&d===m[++u]&&d===m[++u]&&d===m[++u]&&d===m[++u]&&d===m[++u]&&d===m[++u]&&d===m[++u]&&u<p);o.match_length=pc-(p-u),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=3?(l=oa(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(l=oa(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),l&&(gn(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,a===Kn?(gn(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(gn(o,!1),o.strm.avail_out===0)?1:2})(i,t):Wu[i.level].func(i,t);if(n!==3&&n!==4||(i.status=Bu),n===1||n===3)return e.avail_out===0&&(i.last_flush=-1),hr;if(n===2&&(t===sq?oq(i):t!==bD&&(FT(i,0,0,!1),t===aq&&(aa(i.head),i.lookahead===0&&(i.strstart=0,i.block_start=0,i.insert=0))),En(e),e.avail_out===0))return i.last_flush=-1,hr}return t!==Kn?hr:i.wrap<=0?ND:(i.wrap===2?(Bt(i,255&e.adler),Bt(i,e.adler>>8&255),Bt(i,e.adler>>16&255),Bt(i,e.adler>>24&255),Bt(i,255&e.total_in),Bt(i,e.total_in>>8&255),Bt(i,e.total_in>>16&255),Bt(i,e.total_in>>24&255)):(Gu(i,e.adler>>>16),Gu(i,65535&e.adler)),En(e),i.wrap>0&&(i.wrap=-i.wrap),i.pending!==0?hr:ND)},Rq=(e,t)=>{let i=t.length;if(Hu(e))return zo;let r=e.state,n=r.wrap;if(n===2||n===1&&r.status!==Gl||r.lookahead)return zo;if(n===1&&(e.adler=ju(e.adler,t,i,0)),r.wrap=0,i>=r.w_size){n===0&&(aa(r.head),r.strstart=0,r.block_start=0,r.insert=0);let d=new Uint8Array(r.w_size);d.set(t.subarray(i-r.w_size,i),0),t=d,i=r.w_size}let o=e.avail_in,a=e.next_in,l=e.input;for(e.avail_in=i,e.next_in=0,e.input=t,Wl(r);r.lookahead>=3;){let d=r.strstart,u=r.lookahead-2;do r.ins_h=ca(r,r.ins_h,r.window[d+3-1]),r.prev[d&r.w_mask]=r.head[r.ins_h],r.head[r.ins_h]=d,d++;while(--u);r.strstart=d,r.lookahead=2,Wl(r)}return r.strstart+=r.lookahead,r.block_start=r.strstart,r.insert=r.lookahead,r.lookahead=0,r.match_length=r.prev_length=2,r.match_available=0,e.next_in=a,e.input=l,e.avail_in=o,r.wrap=n,hr},Ku={deflateInit:(e,t)=>UD(e,t,jm,15,8,pq),deflateInit2:UD,deflateReset:MD,deflateResetKeep:LD,deflateSetHeader:(e,t)=>Hu(e)||e.state.wrap!==2?zo:(e.state.gzhead=t,hr),deflate:vq,deflateEnd:e=>{if(Hu(e))return zo;let t=e.state.status;return e.state=null,t===mc?_c(e,cq):hr},deflateSetDictionary:Rq,deflateInfo:"pako deflate (from Nodeca project)"};let Cq=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var Bm={assign:function(e){let t=Array.prototype.slice.call(arguments,1);for(;t.length;){let i=t.shift();if(i){if(typeof i!="object")throw new TypeError(i+"must be non-object");for(let r in i)Cq(i,r)&&(e[r]=i[r])}}return e},flattenChunks:e=>{let t=0;for(let r=0,n=e.length;r<n;r++)t+=e[r].length;let i=new Uint8Array(t);for(let r=0,n=0,o=e.length;r<o;r++){let a=e[r];i.set(a,n),n+=a.length}return i}};let xD=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{xD=!1}let zu=new Uint8Array(256);for(let e=0;e<256;e++)zu[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;zu[254]=zu[254]=1;var Yu={string2buf:e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let t,i,r,n,o,a=e.length,l=0;for(n=0;n<a;n++)i=e.charCodeAt(n),(64512&i)==55296&&n+1<a&&(r=e.charCodeAt(n+1),(64512&r)==56320&&(i=65536+(i-55296<<10)+(r-56320),n++)),l+=i<128?1:i<2048?2:i<65536?3:4;for(t=new Uint8Array(l),o=0,n=0;o<l;n++)i=e.charCodeAt(n),(64512&i)==55296&&n+1<a&&(r=e.charCodeAt(n+1),(64512&r)==56320&&(i=65536+(i-55296<<10)+(r-56320),n++)),i<128?t[o++]=i:i<2048?(t[o++]=192|i>>>6,t[o++]=128|63&i):i<65536?(t[o++]=224|i>>>12,t[o++]=128|i>>>6&63,t[o++]=128|63&i):(t[o++]=240|i>>>18,t[o++]=128|i>>>12&63,t[o++]=128|i>>>6&63,t[o++]=128|63&i);return t},buf2string:(e,t)=>{let i=t||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,t));let r,n,o=new Array(2*i);for(n=0,r=0;r<i;){let a=e[r++];if(a<128){o[n++]=a;continue}let l=zu[a];if(l>4)o[n++]=65533,r+=l-1;else{for(a&=l===2?31:l===3?15:7;l>1&&r<i;)a=a<<6|63&e[r++],l--;l>1?o[n++]=65533:a<65536?o[n++]=a:(a-=65536,o[n++]=55296|a>>10&1023,o[n++]=56320|1023&a)}}return((a,l)=>{if(l<65534&&a.subarray&&xD)return String.fromCharCode.apply(null,a.length===l?a:a.subarray(0,l));let d="";for(let u=0;u<l;u++)d+=String.fromCharCode(a[u]);return d})(o,n)},utf8border:(e,t)=>{(t=t||e.length)>e.length&&(t=e.length);let i=t-1;for(;i>=0&&(192&e[i])==128;)i--;return i<0||i===0?t:i+zu[e[i]]>t?i:t}},VD=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};let FD=Object.prototype.toString,{Z_NO_FLUSH:yq,Z_SYNC_FLUSH:Iq,Z_FULL_FLUSH:wq,Z_FINISH:Aq,Z_OK:Gm,Z_STREAM_END:Oq,Z_DEFAULT_COMPRESSION:bq,Z_DEFAULT_STRATEGY:Nq,Z_DEFLATED:Dq}=Bl;function qu(e){this.options=Bm.assign({level:bq,method:Dq,chunkSize:16384,windowBits:15,memLevel:8,strategy:Nq},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new VD,this.strm.avail_out=0;let i=Ku.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(i!==Gm)throw new Error(hc[i]);if(t.header&&Ku.deflateSetHeader(this.strm,t.header),t.dictionary){let r;if(r=typeof t.dictionary=="string"?Yu.string2buf(t.dictionary):FD.call(t.dictionary)==="[object ArrayBuffer]"?new Uint8Array(t.dictionary):t.dictionary,i=Ku.deflateSetDictionary(this.strm,r),i!==Gm)throw new Error(hc[i]);this._dict_set=!0}}function HT(e,t){let i=new qu(t);if(i.push(e,!0),i.err)throw i.msg||hc[i.err];return i.result}qu.prototype.push=function(e,t){let i=this.strm,r=this.options.chunkSize,n,o;if(this.ended)return!1;for(o=t===~~t?t:t===!0?Aq:yq,typeof e=="string"?i.input=Yu.string2buf(e):FD.call(e)==="[object ArrayBuffer]"?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;)if(i.avail_out===0&&(i.output=new Uint8Array(r),i.next_out=0,i.avail_out=r),(o===Iq||o===wq)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(n=Ku.deflate(i,o),n===Oq)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),n=Ku.deflateEnd(this.strm),this.onEnd(n),this.ended=!0,n===Gm;if(i.avail_out!==0){if(o>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(i.avail_in===0)break}else this.onData(i.output)}return!0},qu.prototype.onData=function(e){this.chunks.push(e)},qu.prototype.onEnd=function(e){e===Gm&&(this.result=Bm.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Pq={Deflate:qu,deflate:HT,deflateRaw:function(e,t){return(t=t||{}).raw=!0,HT(e,t)},gzip:function(e,t){return(t=t||{}).gzip=!0,HT(e,t)},constants:Bl};let Wm=16209;var kq=function(e,t){let i,r,n,o,a,l,d,u,p,m,f,E,I,T,R,w,O,P,M,V,F,Y,J,Z,pe=e.state;i=e.next_in,J=e.input,r=i+(e.avail_in-5),n=e.next_out,Z=e.output,o=n-(t-e.avail_out),a=n+(e.avail_out-257),l=pe.dmax,d=pe.wsize,u=pe.whave,p=pe.wnext,m=pe.window,f=pe.hold,E=pe.bits,I=pe.lencode,T=pe.distcode,R=(1<<pe.lenbits)-1,w=(1<<pe.distbits)-1;e:do{E<15&&(f+=J[i++]<<E,E+=8,f+=J[i++]<<E,E+=8),O=I[f&R];t:for(;;){if(P=O>>>24,f>>>=P,E-=P,P=O>>>16&255,P===0)Z[n++]=65535&O;else{if(!(16&P)){if(!(64&P)){O=I[(65535&O)+(f&(1<<P)-1)];continue t}if(32&P){pe.mode=16191;break e}e.msg="invalid literal/length code",pe.mode=Wm;break e}M=65535&O,P&=15,P&&(E<P&&(f+=J[i++]<<E,E+=8),M+=f&(1<<P)-1,f>>>=P,E-=P),E<15&&(f+=J[i++]<<E,E+=8,f+=J[i++]<<E,E+=8),O=T[f&w];i:for(;;){if(P=O>>>24,f>>>=P,E-=P,P=O>>>16&255,!(16&P)){if(!(64&P)){O=T[(65535&O)+(f&(1<<P)-1)];continue i}e.msg="invalid distance code",pe.mode=Wm;break e}if(V=65535&O,P&=15,E<P&&(f+=J[i++]<<E,E+=8,E<P&&(f+=J[i++]<<E,E+=8)),V+=f&(1<<P)-1,V>l){e.msg="invalid distance too far back",pe.mode=Wm;break e}if(f>>>=P,E-=P,P=n-o,V>P){if(P=V-P,P>u&&pe.sane){e.msg="invalid distance too far back",pe.mode=Wm;break e}if(F=0,Y=m,p===0){if(F+=d-P,P<M){M-=P;do Z[n++]=m[F++];while(--P);F=n-V,Y=Z}}else if(p<P){if(F+=d+p-P,P-=p,P<M){M-=P;do Z[n++]=m[F++];while(--P);if(F=0,p<M){P=p,M-=P;do Z[n++]=m[F++];while(--P);F=n-V,Y=Z}}}else if(F+=p-P,P<M){M-=P;do Z[n++]=m[F++];while(--P);F=n-V,Y=Z}for(;M>2;)Z[n++]=Y[F++],Z[n++]=Y[F++],Z[n++]=Y[F++],M-=3;M&&(Z[n++]=Y[F++],M>1&&(Z[n++]=Y[F++]))}else{F=n-V;do Z[n++]=Z[F++],Z[n++]=Z[F++],Z[n++]=Z[F++],M-=3;while(M>2);M&&(Z[n++]=Z[F++],M>1&&(Z[n++]=Z[F++]))}break}}break}}while(i<r&&n<a);M=E>>3,i-=M,E-=M<<3,f&=(1<<E)-1,e.next_in=i,e.next_out=n,e.avail_in=i<r?r-i+5:5-(i-r),e.avail_out=n<a?a-n+257:257-(n-a),pe.hold=f,pe.bits=E};let Hm=15,Lq=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Mq=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Uq=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),xq=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var Ju=(e,t,i,r,n,o,a,l)=>{let d=l.bits,u,p,m,f,E,I,T=0,R=0,w=0,O=0,P=0,M=0,V=0,F=0,Y=0,J=0,Z=null,pe=new Uint16Array(16),Ke=new Uint16Array(16),rt,Ct,Zt,Mt=null;for(T=0;T<=Hm;T++)pe[T]=0;for(R=0;R<r;R++)pe[t[i+R]]++;for(P=d,O=Hm;O>=1&&pe[O]===0;O--);if(P>O&&(P=O),O===0)return n[o++]=20971520,n[o++]=20971520,l.bits=1,0;for(w=1;w<O&&pe[w]===0;w++);for(P<w&&(P=w),F=1,T=1;T<=Hm;T++)if(F<<=1,F-=pe[T],F<0)return-1;if(F>0&&(e===0||O!==1))return-1;for(Ke[1]=0,T=1;T<Hm;T++)Ke[T+1]=Ke[T]+pe[T];for(R=0;R<r;R++)t[i+R]!==0&&(a[Ke[t[i+R]]++]=R);if(e===0?(Z=Mt=a,I=20):e===1?(Z=Lq,Mt=Mq,I=257):(Z=Uq,Mt=xq,I=0),J=0,R=0,T=w,E=o,M=P,V=0,m=-1,Y=1<<P,f=Y-1,e===1&&Y>852||e===2&&Y>592)return 1;for(;;){rt=T-V,a[R]+1<I?(Ct=0,Zt=a[R]):a[R]>=I?(Ct=Mt[a[R]-I],Zt=Z[a[R]-I]):(Ct=96,Zt=0),u=1<<T-V,p=1<<M,w=p;do p-=u,n[E+(J>>V)+p]=rt<<24|Ct<<16|Zt|0;while(p!==0);for(u=1<<T-1;J&u;)u>>=1;if(u!==0?(J&=u-1,J+=u):J=0,R++,--pe[T]==0){if(T===O)break;T=t[i+a[R]]}if(T>P&&(J&f)!==m){for(V===0&&(V=P),E+=w,M=T-V,F=1<<M;M+V<O&&(F-=pe[M+V],!(F<=0));)M++,F<<=1;if(Y+=1<<M,e===1&&Y>852||e===2&&Y>592)return 1;m=J&f,n[m]=P<<24|M<<16|E-o|0}}return J!==0&&(n[E+J]=T-V<<24|64<<16|0),l.bits=P,0};let{Z_FINISH:jD,Z_BLOCK:Vq,Z_TREES:Km,Z_OK:fc,Z_STREAM_END:Fq,Z_NEED_DICT:jq,Z_STREAM_ERROR:zn,Z_DATA_ERROR:BD,Z_MEM_ERROR:GD,Z_BUF_ERROR:Bq,Z_DEFLATED:WD}=Bl,zm=16180,Ym=16190,Ss=16191,KT=16192,zT=16194,qm=16199,Jm=16200,YT=16206,yi=16209,HD=e=>(e>>>24&255)+(e>>>8&65280)+((65280&e)<<8)+((255&e)<<24);function Gq(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}let Ec=e=>{if(!e)return 1;let t=e.state;return!t||t.strm!==e||t.mode<zm||t.mode>16211?1:0},KD=e=>{if(Ec(e))return zn;let t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=1&t.wrap),t.mode=zm,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(852),t.distcode=t.distdyn=new Int32Array(592),t.sane=1,t.back=-1,fc},zD=e=>{if(Ec(e))return zn;let t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,KD(e)},YD=(e,t)=>{let i;if(Ec(e))return zn;let r=e.state;return t<0?(i=0,t=-t):(i=5+(t>>4),t<48&&(t&=15)),t&&(t<8||t>15)?zn:(r.window!==null&&r.wbits!==t&&(r.window=null),r.wrap=i,r.wbits=t,zD(e))},qD=(e,t)=>{if(!e)return zn;let i=new Gq;e.state=i,i.strm=e,i.window=null,i.mode=zm;let r=YD(e,t);return r!==fc&&(e.state=null),r},qT,JT,JD=!0,Wq=e=>{if(JD){qT=new Int32Array(512),JT=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(Ju(1,e.lens,0,288,qT,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;Ju(2,e.lens,0,32,JT,0,e.work,{bits:5}),JD=!1}e.lencode=qT,e.lenbits=9,e.distcode=JT,e.distbits=5},XD=(e,t,i,r)=>{let n,o=e.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),r>=o.wsize?(o.window.set(t.subarray(i-o.wsize,i),0),o.wnext=0,o.whave=o.wsize):(n=o.wsize-o.wnext,n>r&&(n=r),o.window.set(t.subarray(i-r,i-r+n),o.wnext),(r-=n)?(o.window.set(t.subarray(i-r,i),0),o.wnext=r,o.whave=o.wsize):(o.wnext+=n,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=n))),0};var Hq=(e,t)=>{let i,r,n,o,a,l,d,u,p,m,f,E,I,T,R,w,O,P,M,V,F,Y,J=0,Z=new Uint8Array(4),pe,Ke,rt=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Ec(e)||!e.output||!e.input&&e.avail_in!==0)return zn;i=e.state,i.mode===Ss&&(i.mode=KT),a=e.next_out,n=e.output,d=e.avail_out,o=e.next_in,r=e.input,l=e.avail_in,u=i.hold,p=i.bits,m=l,f=d,Y=fc;e:for(;;)switch(i.mode){case zm:if(i.wrap===0){i.mode=KT;break}for(;p<16;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(2&i.wrap&&u===35615){i.wbits===0&&(i.wbits=15),i.check=0,Z[0]=255&u,Z[1]=u>>>8&255,i.check=sr(i.check,Z,2,0),u=0,p=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&u)<<8)+(u>>8))%31){e.msg="incorrect header check",i.mode=yi;break}if((15&u)!==WD){e.msg="unknown compression method",i.mode=yi;break}if(u>>>=4,p-=4,F=8+(15&u),i.wbits===0&&(i.wbits=F),F>15||F>i.wbits){e.msg="invalid window size",i.mode=yi;break}i.dmax=1<<i.wbits,i.flags=0,e.adler=i.check=1,i.mode=512&u?16189:Ss,u=0,p=0;break;case 16181:for(;p<16;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(i.flags=u,(255&Xi(i))!==WD){e.msg="unknown compression method",i.mode=yi;break}if(57344&Xi(i)){e.msg="unknown header flags set",i.mode=yi;break}i.head&&(i.head.text=u>>8&1),512&Xi(i)&&4&i.wrap&&(Z[0]=255&u,Z[1]=u>>>8&255,i.check=sr(i.check,Z,2,0)),u=0,p=0,i.mode=16182;case 16182:for(;p<32;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}i.head&&(i.head.time=u),512&Xi(i)&&4&i.wrap&&(Z[0]=255&u,Z[1]=u>>>8&255,Z[2]=u>>>16&255,Z[3]=u>>>24&255,i.check=sr(i.check,Z,4,0)),u=0,p=0,i.mode=16183;case 16183:for(;p<16;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}i.head&&(i.head.xflags=255&u,i.head.os=u>>8),512&Xi(i)&&4&i.wrap&&(Z[0]=255&u,Z[1]=u>>>8&255,i.check=sr(i.check,Z,2,0)),u=0,p=0,i.mode=16184;case 16184:if(1024&Xi(i)){for(;p<16;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}i.length=u,i.head&&(i.head.extra_len=u),512&Xi(i)&&4&i.wrap&&(Z[0]=255&u,Z[1]=u>>>8&255,i.check=sr(i.check,Z,2,0)),u=0,p=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&Xi(i)&&(E=i.length,E>l&&(E=l),E&&(i.head&&(F=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(r.subarray(o,o+E),F)),512&Xi(i)&&4&i.wrap&&(i.check=sr(i.check,r,E,o)),l-=E,o+=E,i.length-=E),i.length))break e;i.length=0,i.mode=16186;case 16186:if(2048&Xi(i)){if(l===0)break e;E=0;do F=r[o+E++],i.head&&F&&i.length<65536&&(i.head.name+=String.fromCharCode(F));while(F&&E<l);if(512&Xi(i)&&4&i.wrap&&(i.check=sr(i.check,r,E,o)),l-=E,o+=E,F)break e}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&Xi(i)){if(l===0)break e;E=0;do F=r[o+E++],i.head&&F&&i.length<65536&&(i.head.comment+=String.fromCharCode(F));while(F&&E<l);if(512&Xi(i)&&4&i.wrap&&(i.check=sr(i.check,r,E,o)),l-=E,o+=E,F)break e}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&Xi(i)){for(;p<16;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(4&i.wrap&&u!==(65535&i.check)){e.msg="header crc mismatch",i.mode=yi;break}u=0,p=0}i.head&&(i.head.hcrc=Xi(i)>>9&1,i.head.done=!0),e.adler=i.check=0,i.mode=Ss;break;case 16189:for(;p<32;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}e.adler=i.check=HD(u),u=0,p=0,i.mode=Ym;case Ym:if(i.havedict===0)return e.next_out=a,e.avail_out=d,e.next_in=o,e.avail_in=l,i.hold=u,i.bits=p,jq;e.adler=i.check=1,i.mode=Ss;case Ss:if(t===Vq||t===Km)break e;case KT:if(i.last){u>>>=7&p,p-=7&p,i.mode=YT;break}for(;p<3;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}switch(i.last=1&u,u>>>=1,p-=1,3&u){case 0:i.mode=16193;break;case 1:if(Wq(i),i.mode=qm,t===Km){u>>>=2,p-=2;break e}break;case 2:i.mode=16196;break;case 3:e.msg="invalid block type",i.mode=yi}u>>>=2,p-=2;break;case 16193:for(u>>>=7&p,p-=7&p;p<32;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if((65535&u)!=(u>>>16^65535)){e.msg="invalid stored block lengths",i.mode=yi;break}if(i.length=65535&u,u=0,p=0,i.mode=zT,t===Km)break e;case zT:i.mode=16195;case 16195:if(E=i.length,E){if(E>l&&(E=l),E>d&&(E=d),E===0)break e;n.set(r.subarray(o,o+E),a),l-=E,o+=E,d-=E,a+=E,i.length-=E;break}i.mode=Ss;break;case 16196:for(;p<14;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(i.nlen=257+(31&u),u>>>=5,p-=5,i.ndist=1+(31&u),u>>>=5,p-=5,i.ncode=4+(15&u),u>>>=4,p-=4,i.nlen>286||i.ndist>30){e.msg="too many length or distance symbols",i.mode=yi;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;p<3;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}i.lens[rt[i.have++]]=7&u,u>>>=3,p-=3}for(;i.have<19;)i.lens[rt[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,pe={bits:i.lenbits},Y=Ju(0,i.lens,0,19,i.lencode,0,i.work,pe),i.lenbits=pe.bits,Y){e.msg="invalid code lengths set",i.mode=yi;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;J=i.lencode[u&(1<<i.lenbits)-1],R=J>>>24,w=J>>>16&255,O=65535&J,!(R<=p);){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(O<16)u>>>=R,p-=R,i.lens[i.have++]=O;else{if(O===16){for(Ke=R+2;p<Ke;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(u>>>=R,p-=R,i.have===0){e.msg="invalid bit length repeat",i.mode=yi;break}F=i.lens[i.have-1],E=3+(3&u),u>>>=2,p-=2}else if(O===17){for(Ke=R+3;p<Ke;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}u>>>=R,p-=R,F=0,E=3+(7&u),u>>>=3,p-=3}else{for(Ke=R+7;p<Ke;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}u>>>=R,p-=R,F=0,E=11+(127&u),u>>>=7,p-=7}if(i.have+E>i.nlen+i.ndist){e.msg="invalid bit length repeat",i.mode=yi;break}for(;E--;)i.lens[i.have++]=F}}if(i.mode===yi)break;if(i.lens[256]===0){e.msg="invalid code -- missing end-of-block",i.mode=yi;break}if(i.lenbits=9,pe={bits:i.lenbits},Y=Ju(1,i.lens,0,i.nlen,i.lencode,0,i.work,pe),i.lenbits=pe.bits,Y){e.msg="invalid literal/lengths set",i.mode=yi;break}if(i.distbits=6,i.distcode=i.distdyn,pe={bits:i.distbits},Y=Ju(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,pe),i.distbits=pe.bits,Y){e.msg="invalid distances set",i.mode=yi;break}if(i.mode=qm,t===Km)break e;case qm:i.mode=Jm;case Jm:if(l>=6&&d>=258){e.next_out=a,e.avail_out=d,e.next_in=o,e.avail_in=l,i.hold=u,i.bits=p,kq(e,f),a=e.next_out,n=e.output,d=e.avail_out,o=e.next_in,r=e.input,l=e.avail_in,u=i.hold,p=i.bits,i.mode===Ss&&(i.back=-1);break}for(i.back=0;J=i.lencode[u&(1<<i.lenbits)-1],R=J>>>24,w=J>>>16&255,O=65535&J,!(R<=p);){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(w&&!(240&w)){for(P=R,M=w,V=O;J=i.lencode[V+((u&(1<<P+M)-1)>>P)],R=J>>>24,w=J>>>16&255,O=65535&J,!(P+R<=p);){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}u>>>=P,p-=P,i.back+=P}if(u>>>=R,p-=R,i.back+=R,i.length=O,w===0){i.mode=16205;break}if(32&w){i.back=-1,i.mode=Ss;break}if(64&w){e.msg="invalid literal/length code",i.mode=yi;break}i.extra=15&w,i.mode=16201;case 16201:if(i.extra){for(Ke=i.extra;p<Ke;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}i.length+=u&(1<<i.extra)-1,u>>>=i.extra,p-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;J=i.distcode[u&(1<<i.distbits)-1],R=J>>>24,w=J>>>16&255,O=65535&J,!(R<=p);){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(!(240&w)){for(P=R,M=w,V=O;J=i.distcode[V+((u&(1<<P+M)-1)>>P)],R=J>>>24,w=J>>>16&255,O=65535&J,!(P+R<=p);){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}u>>>=P,p-=P,i.back+=P}if(u>>>=R,p-=R,i.back+=R,64&w){e.msg="invalid distance code",i.mode=yi;break}i.offset=O,i.extra=15&w,i.mode=16203;case 16203:if(i.extra){for(Ke=i.extra;p<Ke;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}i.offset+=u&(1<<i.extra)-1,u>>>=i.extra,p-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){e.msg="invalid distance too far back",i.mode=yi;break}i.mode=16204;case 16204:if(d===0)break e;if(E=f-d,i.offset>E){if(E=i.offset-E,E>i.whave&&i.sane){e.msg="invalid distance too far back",i.mode=yi;break}E>i.wnext?(E-=i.wnext,I=i.wsize-E):I=i.wnext-E,E>i.length&&(E=i.length),T=i.window}else T=n,I=a-i.offset,E=i.length;E>d&&(E=d),d-=E,i.length-=E;do n[a++]=T[I++];while(--E);i.length===0&&(i.mode=Jm);break;case 16205:if(d===0)break e;n[a++]=i.length,d--,i.mode=Jm;break;case YT:if(i.wrap){for(;p<32;){if(l===0)break e;l--,u|=r[o++]<<p,p+=8}if(f-=d,e.total_out+=f,i.total+=f,4&i.wrap&&f&&(e.adler=i.check=Xi(i)?sr(i.check,n,f,a-f):ju(i.check,n,f,a-f)),f=d,4&i.wrap&&(Xi(i)?u:HD(u))!==i.check){e.msg="incorrect data check",i.mode=yi;break}u=0,p=0}i.mode=16207;case 16207:if(i.wrap&&Xi(i)){for(;p<32;){if(l===0)break e;l--,u+=r[o++]<<p,p+=8}if(4&i.wrap&&u!==(4294967295&i.total)){e.msg="incorrect length check",i.mode=yi;break}u=0,p=0}i.mode=16208;case 16208:Y=Fq;break e;case yi:Y=BD;break e;case 16210:return GD;default:return zn}return e.next_out=a,e.avail_out=d,e.next_in=o,e.avail_in=l,i.hold=u,i.bits=p,(i.wsize||f!==e.avail_out&&i.mode<yi&&(i.mode<YT||t!==jD))&&XD(e,e.output,e.next_out,f-e.avail_out),m-=e.avail_in,f-=e.avail_out,e.total_in+=m,e.total_out+=f,i.total+=f,4&i.wrap&&f&&(e.adler=i.check=Xi(i)?sr(i.check,n,f,e.next_out-f):ju(i.check,n,f,e.next_out-f)),e.data_type=i.bits+(i.last?64:0)+(i.mode===Ss?128:0)+(i.mode===qm||i.mode===zT?256:0),(m===0&&f===0||t===jD)&&Y===fc&&(Y=Bq),Y},Ts={inflateReset:zD,inflateReset2:YD,inflateResetKeep:KD,inflateInit:e=>qD(e,15),inflateInit2:qD,inflate:Hq,inflateEnd:e=>{if(Ec(e))return zn;let t=e.state;return t.window&&(t.window=null),e.state=null,fc},inflateGetHeader:(e,t)=>{if(Ec(e))return zn;let i=e.state;return 2&i.wrap?(i.head=t,t.done=!1,fc):zn},inflateSetDictionary:(e,t)=>{let i=t.length,r,n,o;return Ec(e)?zn:(r=e.state,r.wrap!==0&&r.mode!==Ym?zn:r.mode===Ym&&(n=1,n=ju(n,t,i,0),n!==r.check)?BD:(o=XD(e,t,i,i),o?(r.mode=16210,GD):(r.havedict=1,fc)))},inflateInfo:"pako inflate (from Nodeca project)"},Kq=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};let QD=Object.prototype.toString,{Z_NO_FLUSH:zq,Z_FINISH:Yq,Z_OK:Xu,Z_STREAM_END:XT,Z_NEED_DICT:QT,Z_STREAM_ERROR:qq,Z_DATA_ERROR:ZD,Z_MEM_ERROR:Jq}=Bl;function Qu(e){this.options=Bm.assign({chunkSize:65536,windowBits:15,to:""},e||{});let t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),!(t.windowBits>=0&&t.windowBits<16)||e&&e.windowBits||(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&!(15&t.windowBits)&&(t.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new VD,this.strm.avail_out=0;let i=Ts.inflateInit2(this.strm,t.windowBits);if(i!==Xu)throw new Error(hc[i]);if(this.header=new Kq,Ts.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=Yu.string2buf(t.dictionary):QD.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(i=Ts.inflateSetDictionary(this.strm,t.dictionary),i!==Xu)))throw new Error(hc[i])}function ZT(e,t){let i=new Qu(t);if(i.push(e),i.err)throw i.msg||hc[i.err];return i.result}Qu.prototype.push=function(e,t){let i=this.strm,r=this.options.chunkSize,n=this.options.dictionary,o,a,l;if(this.ended)return!1;for(a=t===~~t?t:t===!0?Yq:zq,QD.call(e)==="[object ArrayBuffer]"?i.input=new Uint8Array(e):i.input=e,i.next_in=0,i.avail_in=i.input.length;;){for(i.avail_out===0&&(i.output=new Uint8Array(r),i.next_out=0,i.avail_out=r),o=Ts.inflate(i,a),o===QT&&n&&(o=Ts.inflateSetDictionary(i,n),o===Xu?o=Ts.inflate(i,a):o===ZD&&(o=QT));i.avail_in>0&&o===XT&&i.state.wrap>0&&e[i.next_in]!==0;)Ts.inflateReset(i),o=Ts.inflate(i,a);switch(o){case qq:case ZD:case QT:case Jq:return this.onEnd(o),this.ended=!0,!1}if(l=i.avail_out,i.next_out&&(i.avail_out===0||o===XT))if(this.options.to==="string"){let d=Yu.utf8border(i.output,i.next_out),u=i.next_out-d,p=Yu.buf2string(i.output,d);i.next_out=u,i.avail_out=r-u,u&&i.output.set(i.output.subarray(d,d+u),0),this.onData(p)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(o!==Xu||l!==0){if(o===XT)return o=Ts.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(i.avail_in===0)break}}return!0},Qu.prototype.onData=function(e){this.chunks.push(e)},Qu.prototype.onEnd=function(e){e===Xu&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Bm.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};var Xq={Inflate:Qu,inflate:ZT,inflateRaw:function(e,t){return(t=t||{}).raw=!0,ZT(e,t)},ungzip:ZT,constants:Bl};let{Deflate:BQ,deflate:Qq,deflateRaw:GQ,gzip:WQ}=Pq,{Inflate:HQ,inflate:Zq,inflateRaw:KQ,ungzip:zQ}=Xq;var $q=Qq,e9=Zq;let Mi={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function Ye(){return Mi}function $D(){return"setSinkId"in HTMLAudioElement.prototype&&(!N("RESTRICTION_SET_PLAYBACK_DEVICE")||(Ys()||ub())&&!bS())}let Oi=function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e}({});function Kl(e,t,i){return{sampleRate:e,stereo:t,bitrate:i}}function Je(e,t,i,r,n){return{width:e,height:t,frameRate:i,bitrateMin:r,bitrateMax:n}}function Yn(e,t,i,r,n){return{width:{max:e},height:{max:t},frameRate:i,bitrateMin:r,bitrateMax:n}}function $T(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}let t9={"90p":Je(160,90),"90p_1":Je(160,90),"120p":Je(160,120,15,30,65),"120p_1":Je(160,120,15,30,65),"120p_3":Je(120,120,15,30,50),"120p_4":Je(212,120),"180p":Je(320,180,15,30,140),"180p_1":Je(320,180,15,30,140),"180p_3":Je(180,180,15,30,100),"180p_4":Je(240,180,15,30,120),"240p":Je(320,240,15,40,200),"240p_1":Je(320,240,15,40,200),"240p_3":Je(240,240,15,40,140),"240p_4":Je(424,240,15,40,220),"360p":Je(640,360,15,80,400),"360p_1":Je(640,360,15,80,400),"360p_3":Je(360,360,15,80,260),"360p_4":Je(640,360,30,80,600),"360p_6":Je(360,360,30,80,400),"360p_7":Je(480,360,15,80,320),"360p_8":Je(480,360,30,80,490),"360p_9":Je(640,360,15,80,800),"360p_10":Je(640,360,24,80,800),"360p_11":Je(640,360,24,80,1e3),"480p":Je(640,480,15,100,500),"480p_1":Je(640,480,15,100,500),"480p_2":Je(640,480,30,100,1e3),"480p_3":Je(480,480,15,100,400),"480p_4":Je(640,480,30,100,750),"480p_6":Je(480,480,30,100,600),"480p_8":Je(848,480,15,100,610),"480p_9":Je(848,480,30,100,930),"480p_10":Je(640,480,10,100,400),"720p":Je(1280,720,15,120,1130),"720p_auto":Je(1280,720,30,900,3e3),"720p_1":Je(1280,720,15,120,1130),"720p_2":Je(1280,720,30,120,2e3),"720p_3":Je(1280,720,30,120,1710),"720p_5":Je(960,720,15,120,910),"720p_6":Je(960,720,30,120,1380),"1080p":Je(1920,1080,15,120,2080),"1080p_1":Je(1920,1080,15,120,2080),"1080p_2":Je(1920,1080,30,120,3e3),"1080p_3":Je(1920,1080,30,120,3150),"1080p_5":Je(1920,1080,60,120,4780),"1440p":Je(2560,1440,30,120,4850),"1440p_1":Je(2560,1440,30,120,4850),"1440p_2":Je(2560,1440,60,120,7350),"4k":Je(3840,2160,30,120,8910),"4k_1":Je(3840,2160,30,120,8910),"4k_3":Je(3840,2160,60,120,13500)},Xm=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],i9={"480p":Yn(640,480,5),"480p_1":Yn(640,480,5),"480p_2":Yn(640,480,30),"480p_3":Yn(640,480,15),"720p":Yn(1280,720,5),"720p_auto":Je(1280,720,30,900,3e3),"720p_1":Yn(1280,720,5),"720p_2":Yn(1280,720,30),"720p_3":Yn(1280,720,15),"1080p":Yn(1920,1080,5),"1080p_1":Yn(1920,1080,5),"1080p_2":Yn(1920,1080,30),"1080p_3":Yn(1920,1080,15)},r9={"1SL1TL":$T(1,1),"3SL3TL":$T(3,3),"2SL3TL":$T(2,3)};function Jo(e){return e||(e="480p_1"),typeof e=="string"?Object.assign({},t9[e]):e}function ev(e){return typeof e=="string"?Object.assign({},i9[e]):e}function Qm(e){return typeof e=="string"?Object.assign({},r9[e]):e}let n9={speech_low_quality:Kl(16e3,!1),speech_standard:Kl(32e3,!1,18),music_standard:Kl(48e3,!1),standard_stereo:Kl(48e3,!0,56),high_quality:Kl(48e3,!1,128),high_quality_stereo:Kl(48e3,!0,192)};function Zm(e){return typeof e=="string"?Object.assign({},n9[e]):e}let zl=[];function eP(e){return ci(e,"mediaSource",["screen","window","application"]),!0}let ce=function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e}({}),Rt=function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e}({}),Yl=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({}),o9=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({}),s9=function(e){return e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e}({}),gc=function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e.TRACK_UPDATED="track-updated",e}({}),ql=function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e}({}),Jl=function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e}({}),Qr=function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e}({});(function(e){e.UPDATE_TRACK_SOURCE="update-track-source"})({});let tv={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},iv={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},tP={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},a9={uplinkNetworkQuality:0,downlinkNetworkQuality:0},iP={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},ar=function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e}({}),Zr=function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e}({}),Zu=function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e}({}),Sc=function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e}({}),Qi=function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e}({}),Xo=function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e}({}),rv={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370},$m=function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e}({});function rP(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function bt(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?rP(Object(i),!0).forEach(function(r){B(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):rP(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function B(e,t,i){return(t=function(r){var n=function(o,a){if(typeof o!="object"||o===null)return o;var l=o[Symbol.toPrimitive];if(l!==void 0){var d=l.call(o,"string");if(typeof d!="object")return d;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(r);return typeof n=="symbol"?n:String(n)}(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function qe(e,t,i,r,n){var o,a,l={};return Object.keys(r).forEach(function(d){l[d]=r[d]}),l.enumerable=!!l.enumerable,l.configurable=!!l.configurable,("value"in l||l.initializer)&&(l.writable=!0),l=ao(o=Wz(a=i.slice()).call(a)).call(o,function(d,u){return u(e,t,d)||d},l),n&&l.initializer!==void 0&&(l.value=l.initializer?l.initializer.call(n):void 0,l.initializer=void 0),l.initializer===void 0&&(Object.defineProperty(e,t,l),l=null),l}class nP extends Ot{set _mediaStreamTrack(t){t!==this.mediaStreamTrack&&(this.safeEmit(gc.TRACK_UPDATED,t),this.mediaStreamTrack=t)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(t,i){super(),B(this,"trackMediaType",void 0),B(this,"_ID",void 0),B(this,"_rtpTransceiver",void 0),B(this,"_lowRtpTransceiver",void 0),B(this,"_hints",[]),B(this,"_isClosed",!1),B(this,"_originMediaStreamTrack",void 0),B(this,"mediaStreamTrack",void 0),B(this,"_external",{}),this._ID=i||ft(8,"track-"),this._originMediaStreamTrack=t,this.mediaStreamTrack=t,function(r){se(zl).call(zl,r)||zl.push(r)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){return t||Js(()=>{var i;_e.reportApiInvoke(null,{name:ei.GET_MEDIA_STREAM_TRACK,options:[],tag:xt.TRACER}).onSuccess(((i=this._mediaStreamTrack)===null||i===void 0?void 0:i.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===Yl.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(t){let i=zl.indexOf(t);i!==-1&&zl.splice(i,1)}(this),this.emit(ql.CLOSED),this.removeAllListeners(gc.SEI_RECEIVED)}_updateRtpTransceiver(t,i){if(i===Yl.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(gc.TRANSCEIVER_UPDATED,t,i)}}class Xl extends nP{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(t,i){super(t,i),B(this,"_enabled",!0),B(this,"_muted",!1),B(this,"_isExternalTrack",!1),B(this,"_isClosed",!1),B(this,"_enabledMutex",void 0),B(this,"processor",void 0),B(this,"_processorContext",void 0),B(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Ti("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,i;return(t=(i=this._originMediaStreamTrack)===null||i===void 0?void 0:i.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,S.debug("[".concat(this.getTrackId(),"] close")),this.emit(ce.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,i){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=r,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await _t(this,ce.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ql.TRACK_ENDED)}stateCheck(t,i){if(S.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(i,"]")),us(i,t),this._enabled&&this._muted&&t==="enabled"&&i===!1)throw new j(A.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",S);if(!this._enabled&&!this._muted&&t==="muted"&&i===!0)throw new j(A.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",S)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():ne.resolve([])}}let oP=window.AudioContext||window.webkitAudioContext,$r=null,dt=new class extends Ot{constructor(){super(...arguments),B(this,"prevState",void 0),B(this,"curState",void 0),B(this,"currentTime",void 0),B(this,"currentTimeStuckAt",void 0),B(this,"interruptDetectorTrack",void 0),B(this,"onLocalAudioTrackMute",()=>{S.info("ios15-interruption-start"),this.emit(Oi.IOS_15_16_INTERRUPTION_START)}),B(this,"onLocalAudioTrackUnmute",async()=>{S.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?S.info("ios15-interruption-end-canceled"):($r&&await $r.suspend(),this.emit(Oi.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(e){S.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){S.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Ql(){if(!$r){if(function(){if(!oP)return void S.error("your browser is not support web audio");S.info("create audio context");let e=bt({},N("WEBAUDIO_INIT_OPTIONS"));S.debug("audio context init option:",JSON.stringify(e)),$r=new oP(e),dt.curState=$r.state,$r.onstatechange=()=>{dt.prevState=dt.curState,dt.curState=$r?$r.state:void 0;let{prevState:t,curState:i}=dt,r=i==="running",n=i==="interrupted",o=t==="running",a=t==="suspended",l=t==="interrupted",d=Xe().osVersion;(ji()||Mn())&&o&&n&&(S.info("ios".concat(d,"-interruption-start")),dt.emit(Oi.IOS_INTERRUPTION_START)),(ji()||Mn())&&(a||l)&&r&&(S.info("ios".concat(d,"-interruption-end")),dt.emit(Oi.IOS_INTERRUPTION_END)),t!==i&&dt.emit(Oi.STATE_CHANGE,i,t)},setInterval(()=>{var t;let i=(t=$r)===null||t===void 0?void 0:t.currentTime;dt.currentTime!==i?(dt.currentTimeStuckAt&&(S.debug("AudioContext current time resume at ".concat(i)),dt.currentTimeStuckAt=void 0),dt.currentTime=i):(i!==dt.currentTimeStuckAt&&(_e.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:i},tag:xt.TRACER}).onSuccess(),S.warning("AudioContext current time stuck at ".concat(i))),dt.currentTimeStuckAt=i)},5e3),async function(t){let i=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"],r,n=!1,o=!1,a=!1;function l(T){t.state==="running"?d(!1):ji()||Mn()?t.state==="suspended"&&(d(!0),T&&t.resume().then(u,u)):t.state!=="closed"&&(d(!0),T&&t.resume().then(u,u))}function d(T){if(n!==T){n=T;for(let R=0,w=i;R<w.length;R+=1){let O=w[R];T?window.addEventListener(O,p,{capture:!0,passive:!0}):window.removeEventListener(O,p,{capture:!0,passive:!0})}}}function u(){l(!1)}function p(){l(!0)}function m(T){if(!a)if(r.paused)if(T){let R;f(!1),a=!0;try{R=r.play(),R?R.then(E,E):(r.addEventListener("playing",E),r.addEventListener("abort",E),r.addEventListener("error",E))}catch{E()}}else f(!0);else f(!1)}function f(T){if(o!==T){o=T;for(let R=0,w=i;R<w.length;R++){let O=w[R];T?window.addEventListener(O,I,{capture:!0,passive:!0}):window.removeEventListener(O,I,{capture:!0,passive:!0})}}}function E(){r.removeEventListener("playing",E),r.removeEventListener("abort",E),r.removeEventListener("error",E),a=!1,m(!1)}function I(){m(!0)}if(ji()){let T=t.createMediaStreamDestination(),R=document.createElement("div");R.innerHTML="<audio x-webkit-airplay='deny'></audio>",r=R.children.item(0),r.controls=!1,r.disableRemotePlayback=!0,r.preload="auto",r.srcObject=T.stream,m(!0)}dt.on(Oi.STATE_CHANGE,function(){l(!0)}),l(!1)}($r)}(),!$r)throw new j(A.NOT_SUPPORTED,"can not create audio context");return $r}return $r}function Tc(e){if(function(){if(nv!==null)return nv;let r=Ql(),n=r.createBufferSource(),o=r.createGain(),a=r.createGain();n.connect(o),n.connect(a),n.disconnect(o);let l=!1;try{n.disconnect(o)}catch{l=!0}return n.disconnect(),nv=l,l}())return;let t=e.connect,i=e.disconnect;e.connect=(r,n,o)=>{var a;return e._inputNodes||(e._inputNodes=[]),se(a=e._inputNodes).call(a,r)||(r instanceof AudioNode?(e._inputNodes.push(r),t.call(e,r,n,o)):t.call(e,r,n)),e},e.disconnect=(r,n,o)=>{i.call(e),r?um(e._inputNodes,r):e._inputNodes=[];for(let a of e._inputNodes)t.call(e,a)}}let nv=null;function ov(e,t){let i=!1,r=1/t;if(N("DISABLE_WEBAUDIO")){let n=window.setInterval(()=>{i?window.clearInterval(n):e(performance.now()/1e3)},1e3*r)}else{let n=Ql(),o=n.createGain();o.gain.value=0,o.connect(n.destination);let a=()=>{if(i)return void(o=null);let l=n.createOscillator();l.onended=a,l.connect(o),l.start(0),l.stop(n.currentTime+r),e(n.currentTime)};a()}return()=>{i=!0}}class sP{constructor(){B(this,"context",void 0),B(this,"analyserNode",void 0),B(this,"sourceNode",void 0),this.context=Ql(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t==null||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||ji()||Mn()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;let t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{let r=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(r);for(let n=0;n<t.length;++n)t[n]=r[n]/128-1}let i=ao(t).call(t,(r,n)=>r+n*n,0)/t.length;return Math.max(10*Math.log10(i)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,i;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(i=this.sourceNode)===null||i===void 0||i.connect(this.analyserNode)}catch{S.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class aP extends Ot{get processSourceNode(){return this.sourceNode}set processedNode(t){var i;if(!this.isDestroyed&&this._processedNode!==t){try{var r;(r=this.sourceNode)===null||r===void 0||r.disconnect(this.outputNode)}catch{}(i=this._processedNode)===null||i===void 0||i.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),B(this,"outputNode",void 0),B(this,"outputTrack",void 0),B(this,"isPlayed",!1),B(this,"sourceNode",void 0),B(this,"context",void 0),B(this,"audioBufferNode",void 0),B(this,"destNode",void 0),B(this,"audioOutputLevel",0),B(this,"volumeLevelAnalyser",void 0),B(this,"_processedNode",void 0),B(this,"playNode",void 0),B(this,"isDestroyed",!1),B(this,"onNoAudioInput",void 0),B(this,"isNoAudioInput",!1),B(this,"_noAudioInputCount",0),this.context=Ql(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Tc(this.outputNode),this.volumeLevelAnalyser=new sP}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=i=>{this.emit(Qr.ON_AUDIO_BUFFER,function(r){for(let n=0;n<r.outputBuffer.numberOfChannels;n+=1){let o=r.outputBuffer.getChannelData(n);for(let a=0;a<o.length;a+=1)o[a]=0}return r.inputBuffer}(i))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Ye().webAudioMediaStreamDest)throw new j(A.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&hm(()=>{dt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;ji()||Mn()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();let i=this.volumeLevelAnalyser.getAnalyserNode(),r;i.getFloatTimeDomainData?(r=new Float32Array(i.fftSize),i.getFloatTimeDomainData(r)):(r=new Uint8Array(i.fftSize),i.getByteTimeDomainData(r));let n=!1;for(let o=0;o<r.length;o++)r[o]!==0&&(n=!0);return n?(this.isNoAudioInput=!1,!0):(await mi(200),await this.checkHasAudioInput(t?t+1:1)&&n)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,i;(t=this.processedNode)===null||t===void 0||t.disconnect(),(i=this.sourceNode)===null||i===void 0||i.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class cP extends aP{get isFreeze(){return!1}constructor(t,i,r){var n;if(super(),B(this,"sourceNode",void 0),B(this,"track",void 0),B(this,"clonedTrack",void 0),B(this,"audioElement",void 0),B(this,"isCurrentTrackCloned",!1),B(this,"isRemoteTrack",!1),B(this,"originVolumeLevelAnalyser",void 0),B(this,"rebuildWebAudio",async()=>{if(S.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void S.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>S.info("resume success")),S.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();let l=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?l.stop():this.isCurrentTrackCloned=!0;let d=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(d),Tc(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();let u=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(u,this.context.currentTime),Tc(this.outputNode),this.emit(Qr.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=d,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),t.kind!=="audio")throw new j(A.UNEXPECTED_ERROR);this.track=t;let o=new MediaStream([this.track]);if(this.isRemoteTrack=!!i,this.sourceNode=this.context.createMediaStreamSource(o),Tc(this.sourceNode),r){let l=r.clone();l.enabled=!0,this.clonedTrack=l,S.debug("create an unmuted track ".concat(l.id," from the original track ").concat(r.id," to get the volume"));let d=this.context.createMediaStreamSource(new MediaStream([l]));Tc(d),this.originVolumeLevelAnalyser=new sP,this.originVolumeLevelAnalyser.updateSource(d)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;let a=Xe();i&&a.os===hi.IOS&&Number((n=a.osVersion)===null||n===void 0?void 0:n.split(".")[0])<15&&(dt.on(Oi.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(l=>{l||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;let i=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(i),Tc(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(Qr.UPDATE_SOURCE),this.audioElement.srcObject=i}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),dt.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){let i=t.clone();i.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=i),S.debug("create an unmuted track ".concat(i.id," from the original track ").concat(t.id," to get the volume"));let r=this.context.createMediaStreamSource(new MediaStream([i]));Tc(r),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(r)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function lP(e,t,i){let r=(o,a)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||a:o:a,n={audio:!!i&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:r(t.height,1080),maxWidth:r(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(n.video.mandatory.maxFrameRate=t.frameRate.max,n.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(n.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(n)}async function c9(e,t){let i=await dP(e.mediaSource),{sourceId:r,audio:n}=await function(o){let a=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new ne((l,d)=>{let u=document.createElement("div");u.innerText="share screen",u.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");let p=document.createElement("div");p.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");let m=document.createElement("div");m.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",m.setAttribute("style","height: 12%;");let f=document.createElement("div");f.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");let E=document.createElement("div");E.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");let I=document.createElement("button");I.innerHTML="cancel",I.setAttribute("style","width: 85px;"),I.onclick=()=>{document.body.removeChild(w);let O=new Error("NotAllowedError");O.name="NotAllowedError",d(O)};let T=a,R=document.createElement("div");if(a){let O=document.createElement("input");O.setAttribute("type","checkbox");let P=document.createElement("span");O.setAttribute("style","margin-right: 6px;"),P.innerText="Share audio",O.checked=T,O.onchange=()=>{T=O.checked},R.appendChild(O),R.appendChild(P)}E.appendChild(R),E.appendChild(I),p.appendChild(m),p.appendChild(f),p.appendChild(E);let w=document.createElement("div");w.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),w.appendChild(u),w.appendChild(p),document.body.appendChild(w),o.map(O=>{if(O.id){let P=document.createElement("div");P.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let M=O.thumbnail;try{let{width:V}=M.getSize();V>1920&&(M=M.resize({width:1920}))}catch(V){throw V&&V.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),V}P.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+M.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+O.name.replace(/[\u00A0-\u9999<>\&]/g,function(V){return"&#"+V.charCodeAt(0)+";"})+"</span>",P.onclick=()=>{document.body.removeChild(w),l({sourceId:O.id,audio:T})},f.appendChild(P)}})})}(i,t);return await lP(r,e,n)}async function dP(e){let t=["window","screen"];e!=="application"&&e!=="window"||(t=["window"]),e==="screen"&&(t=["screen"]);let i=Ob();if(!i)throw console.error("failed to fetch electron, please mount it to window"),new j(A.ELECTRON_IS_NULL);let r=null;try{var n;r=((n=i.desktopCapturer)===null||n===void 0?void 0:n.getSources({types:t}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{r=null}r&&r.then||(r=new ne((o,a)=>{i.desktopCapturer.getSources({types:t},(l,d)=>{l?a(l):o(d)})}));try{return await r}catch(o){throw new j(A.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}let sv=new Ti("safari"),uP=!1,hP=!1;async function en(e,t){let i=0,r=null;for(;i<2;)try{r=await l9(e,t,i>0);break}catch(n){if(n instanceof j)throw S.error("[".concat(t,"] ").concat(n.toString())),n;let o=e_(n.name||n.code||n,n.message);if(o.code===A.MEDIA_OPTION_INVALID){S.debug("[".concat(t,"] detect media option invalid, retry")),i+=1,await mi(500);continue}throw S.error("[".concat(t,"] ").concat(o.toString())),o}if(!r)throw new j(A.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return r}async function l9(e,t,i){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new j(A.NOT_SUPPORTED,"can not find getUserMedia");i&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));let r=Ye(),n=new MediaStream;if(e.audioSource&&n.addTrack(e.audioSource),e.videoSource&&n.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return S.debug("Using Video Source/ Audio Source"),n;if(e.screen)if(Ob())e.screen.sourceId?Zl(n,await lP(e.screen.sourceId,e.screen,e.screenAudio)):Zl(n,await c9(e.screen,e.screenAudio));else if(Ys()&&e.screen.extensionId&&e.screen.mandatory){if(!r.getStreamFromExtension)throw new j(A.NOT_SUPPORTED,"This browser does not support screen sharing");S.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));let f=await(a=e.screen.extensionId,l=t,new ne((E,I)=>{try{chrome.runtime.sendMessage(a,{getStream:!0},T=>{if(!T||!T.streamId)return S.error("[".concat(l,"] No response from Chrome Plugin. Plugin not installed properly"),T),void I(new j(A.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));E(T.streamId)})}catch(T){S.error("[".concat(l,"] AgoraRTC screensharing plugin is not accessible(").concat(a,")"),T.toString()),I(new j(A.CHROME_PLUGIN_NOT_INSTALL))}}));e.screen.mandatory.chromeMediaSourceId=f,Zl(n,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(r.getDisplayMedia){var o;e.screen.mediaSource&&eP(e.screen.mediaSource);let f={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:(o=e.screen.displaySurface)!==null&&o!==void 0?o:e.screen.mediaSource==="screen"?"monitor":e.screen.mediaSource},{selfBrowserSurface:E,surfaceSwitching:I,systemAudio:T}=e.screen,R={selfBrowserSurface:E,surfaceSwitching:I,systemAudio:T};!E&&delete R.selfBrowserSurface,!I&&delete R.surfaceSwitching,!T&&delete R.systemAudio,S.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:f,audio:!!e.screenAudio,controls:R})),Zl(n,await navigator.mediaDevices.getDisplayMedia(bt({video:f,audio:!!e.screenAudio},R)))}else{if(!mt())throw S.error("[".concat(t,"] This browser does not support screenSharing")),new j(A.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&eP(e.screen.mediaSource);let f={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};S.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(f))),Zl(n,await navigator.mediaDevices.getUserMedia(f))}}var a,l;if(!e.video&&!e.audio)return n;let d={video:e.video,audio:e.audio},u=N("MEDIA_DEVICE_CONSTRAINTS");if(u)try{typeof u=="string"&&(u=JSON.parse(u)),d=LS(d,u)}catch{}S.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(d)),Xe();let p,m=null;(pi()||ji()||lm())&&(m=await sv.lock());try{p=await navigator.mediaDevices.getUserMedia(d)}catch(f){throw m&&m(),f}return d.audio&&(uP=!0),d.video&&(hP=!0),Zl(n,p),m&&m(),n}function e_(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new j(A.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new j(A.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new j(A.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new j(A.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new j(A.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new j(A.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return S.error("getUserMedia unexpected error",e),new j(A.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function Zl(e,t){let i=e.getVideoTracks()[0],r=e.getAudioTracks()[0],n=t.getVideoTracks()[0],o=t.getAudioTracks()[0];o&&(r&&e.removeTrack(r),e.addTrack(o)),n&&(i&&e.removeTrack(i),e.addTrack(n))}let tn=new class extends Ot{get state(){return this._state}set state(e){e!==this._state&&(this.emit(Sc.STATE_CHANGE,e),this._state=e)}constructor(){super(),B(this,"_state",Zu.IDLE),B(this,"isAccessMicrophonePermission",!1),B(this,"isAccessCameraPermission",!1),B(this,"lastAccessMicrophonePermission",!1),B(this,"lastAccessCameraPermission",!1),B(this,"checkdeviceMatched",!1),B(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(N("ENUMERATE_DEVICES_INTERVAL")||(dm()||cm()===hi.HARMONY_OS)&&qs())&&this.updateDevicesInfo()},N("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(e=>S.error(e.toString()))}async enumerateDevices(e,t){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new j(A.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();let r=await navigator.mediaDevices.enumerateDevices(),n=this.checkMediaDeviceInfoIsOk(r),o=!this.isAccessMicrophonePermission&&e,a=!this.isAccessCameraPermission&&t;n.audio&&(o=!1),n.video&&(a=!1);let l=null,d=null,u=null;if(!i&&(o||a)){if(sv.isLocked&&(S.debug("[device manager] wait GUM lock"),(await sv.lock())(),S.debug("[device manager] GUM unlock")),uP&&(o=!1,this.isAccessMicrophonePermission=!0),hP&&(a=!1,this.isAccessCameraPermission=!0),S.debug("[device manager] check media device permissions",e,t,o,a),o&&a){try{u=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(p){let m=e_(p.name||p.code||p,p.message);if(m.code===A.PERMISSION_DENIED)throw m;S.warning("getUserMedia failed in getDevices",m)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(o){try{l=await navigator.mediaDevices.getUserMedia({audio:e})}catch(p){let m=e_(p.name||p.code||p,p.message);if(m.code===A.PERMISSION_DENIED)throw m;S.warning("getUserMedia failed in getDevices",m)}this.isAccessMicrophonePermission=!0}else if(a){try{d=await navigator.mediaDevices.getUserMedia({video:t})}catch(p){let m=e_(p.name||p.code||p,p.message);if(m.code===A.PERMISSION_DENIED)throw m;S.warning("getUserMedia failed in getDevices",m)}this.isAccessCameraPermission=!0}S.debug("[device manager] mic permission",e,"cam permission",t)}try{let p=await navigator.mediaDevices.enumerateDevices();return l&&l.getTracks().forEach(m=>m.stop()),d&&d.getTracks().forEach(m=>m.stop()),u&&u.getTracks().forEach(m=>m.stop()),l=null,d=null,u=null,p}catch(p){return l&&l.getTracks().forEach(m=>m.stop()),d&&d.getTracks().forEach(m=>m.stop()),u&&u.getTracks().forEach(m=>m.stop()),l=null,d=null,u=null,new j(A.ENUMERATE_DEVICES_FAILED,p.toString()).throw()}}async getRecordingDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter(t=>t.kind==="audioinput")}async getCamerasDevices(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,e)).filter(t=>t.kind==="videoinput")}async getSpeakers(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,e)).filter(t=>t.kind==="audiooutput")}searchDeviceIdByName(e){let t=null;return this.deviceInfoMap.forEach(i=>{i.device.label===e&&(t=i.device.deviceId)}),t}async getDeviceById(e){let t=(await this.enumerateDevices(!0,!0,!0)).find(i=>i.deviceId===e);if(!t)throw new j(A.DEVICE_NOT_FOUND,"deviceId: ".concat(e));return t}async init(){this.state=Zu.INITING;try{await this.updateDevicesInfo(),this.state=Zu.INITEND}catch(e){throw S.warning("Device Detection functionality cannot start properly.",e.toString()),this.state=Zu.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")||new j(A.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),e}}async updateDevicesInfo(){let e=await this.enumerateDevices(!0,!0,!0),t=Date.now(),i=[];if(e[0]&&e[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;let n=e.find(a=>a.kind==="audioinput"&&a.deviceId==="default"),o=e.find(a=>a.kind==="audiooutput"&&a.deviceId==="default");n&&o?o.groupId===n.groupId?S.debug("[device-check] default input ".concat(n.label," and output ").concat(o.label," is the same group")):S.warning("[device-check] default input ".concat(n.label," and output ").concat(o.label," is not the same group")):S.debug("[device-check] default input or output not found")}let r=this.checkMediaDeviceInfoIsOk(e);if(e.forEach(n=>{if(!n.deviceId)return;let o=this.deviceInfoMap.get("".concat(n.kind,"_").concat(n.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){let a={initAt:t,updateAt:t,device:n,state:"ACTIVE"};this.deviceInfoMap.set("".concat(n.kind,"_").concat(n.deviceId),a),i.push(a)}o&&(o.updateAt=t)}),this.deviceInfoMap.forEach((n,o)=>{n.state==="ACTIVE"&&n.updateAt!==t&&(n.state="INACTIVE",i.push(n))}),this.state!==Zu.INITEND)return r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach(n=>{switch(n.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Sc.RECORDING_DEVICE_CHANGED,n);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Sc.CAMERA_DEVICE_CHANGED,n);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Sc.PLAYOUT_DEVICE_CHANGED,n)}}),r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(e){let t=e.filter(n=>n.kind==="audioinput"),i=e.filter(n=>n.kind==="videoinput"),r={audio:!1,video:!1};for(let n of t)if(n.label&&n.deviceId){r.audio=!0;break}for(let n of i)if(n.label&&n.deviceId){r.video=!0;break}return r}},av=!1,rn=new class extends Ot{constructor(){super(...arguments),B(this,"onAutoplayFailed",void 0),B(this,"onAudioAutoplayFailed",void 0)}};function pP(){if(Xe(),!av){let e=t=>{t.preventDefault(),av=!1,fu()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};av=!0,fu()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),S.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),rn.onAutoplayFailed?rn.onAutoplayFailed():rn.onAudioAutoplayFailed?S.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):S.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),rn.emit("autoplay-failed")}}function mP(e,t,i,r){if(!e)return;let n=_e.getBaseInfoBySessionId(e);if(!n)return;let o=n.info,a=Date.now(),l=bt(bt({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:a,elapse:a-n.startTime,cbRegistered:rn.onAutoplayFailed||rn.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:t,trackId:r,extend:void 0});_e.send({type:kt.AUTOPLAY_FAILED,data:l},!0)}let d9=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],pr=new class{constructor(){B(this,"onAutoplayFailed",void 0),B(this,"elementMap",new Map),B(this,"elementStateMap",new Map),B(this,"elementsNeedToResume",[]),B(this,"sinkIdMap",new Map),B(this,"autoResumeAfterInterruption",e=>{Array.from(this.elementMap.entries()).forEach(t=>{let[i,r]=t,n=this.elementStateMap.get(i),o=r.srcObject.getAudioTracks()[0],a=o&&o.readyState;if(S.debug("resume after interrupted, ele: ".concat(n," audio: ").concat(a," ").concat(e)),a==="live"){if(e)return r.pause(),void r.play();if(dt.curState==="running")return vl()?(r.pause(),void r.play()):void(n&&n==="paused"&&r.play())}})}),B(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(e=>{let[t,i]=e,r=i.srcObject.getAudioTracks()[0];r&&r.readyState==="live"&&(S.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())})}),this.autoResumeAudioElement(),dt.on(Oi.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),dt.on(Oi.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),dt.on(Oi.STATE_CHANGE,()=>{ji()&&dt.prevState==="suspended"&&dt.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(e,t){let i=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),i)try{await i.setSinkId(t)}catch(r){throw new j(A.PERMISSION_DENIED,"can not set sink id: "+r.toString())}}play(e,t,i,r){if(this.elementMap.has(t))return;let n=document.createElement("audio");n.autoplay=!0,n.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,n),this.elementMap.set(t,n),this.elementStateMap.set(t,Qi.INIT),this.setVolume(t,i);let o=this.sinkIdMap.get(t);if(o)try{n.setSinkId(o).catch(l=>{S.warning("[".concat(t,"] set sink id failed"),l.toString())})}catch(l){S.warning("[".concat(t,"] set sink id failed"),l.toString())}let a=n.play();a&&a.then&&a.catch(l=>{r&&mP(r,"audio",l.message,t),S.warning("audio element play warning",l.toString()),this.elementMap.has(t)&&l.name==="NotAllowedError"&&(S.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(n),hm(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),pP()}))})}updateTrack(e,t){let i=this.elementMap.get(e);i&&(i.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&this.elementStateMap.get(e)==="playing"}setVolume(e,t){let i=this.elementMap.get(e);i&&(t=Math.max(0,Math.min(100,t)),i.volume=t/100)}stop(e){let t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;let i=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(i,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){d9.forEach(i=>{t.addEventListener(i,r=>{let n=this.elementStateMap.get(e),o=r.type==="pause"?"paused":r.type;if(S.debug("[".concat(e,"] audio-element-status change ").concat(n," => ").concat(o)),r.type==="error"){let a=t==null?void 0:t.error;a&&S.error("[".concat(e,"] media error, code: ").concat(a.code,", message: ").concat(a.message))}this.elementStateMap.set(e,o)})})}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){let e=()=>{this.elementsNeedToResume.forEach(t=>{t.play().then(i=>{S.debug("Auto resume audio element success")}).catch(i=>{S.warning("Auto resume audio element failed!",i)})}),this.elementsNeedToResume=[]};new ne(t=>{document.body?t():window.addEventListener("load",()=>t())}).then(()=>{fu()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))})}};function Kt(){return function(e,t,i){let r=i.value;return typeof r=="function"&&(i.value=function(){this._isClosed&&new j(A.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",S);for(var n=arguments.length,o=new Array(n),a=0;a<n;a++)o[a]=arguments[a];let l=r.apply(this,o);return l instanceof ne?new ne((d,u)=>{l.then(d).catch(u)}):l}),i}}class _P extends Ot{constructor(t){super(),B(this,"name","VideoProcessorDestination"),B(this,"ID","0"),B(this,"_source",void 0),B(this,"videoContext",void 0),B(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new j(A.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new j(A.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(ar.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(ar.ON_TRACK,void 0)}}class fP extends Ot{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,i){super(),B(this,"constraintsMap",new Map),B(this,"statsRegistry",[]),B(this,"usageRegistry",[]),B(this,"trackId",void 0),B(this,"direction",void 0),B(this,"_chained",!1),this.trackId=t,this.direction=i}async getConstraints(){return await ti(this,Zr.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,i){var r;return S.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(i,t),_t(this,Zr.REQUEST_UPDATE_CONSTRAINTS,Array.from(ho(r=this.constraintsMap).call(r)))}async requestRevertConstraints(t){var i;if(this.constraintsMap.has(t))return S.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),_t(this,Zr.REQUEST_UPDATE_CONSTRAINTS,Array.from(ho(i=this.constraintsMap).call(i)))}registerStats(t,i,r){this.statsRegistry.find(n=>n.processorID===t.ID&&n.processorName===t.name&&n.type===i)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:i,cb:r})}unregisterStats(t,i){let r=this.statsRegistry.findIndex(n=>n.processorID===t.ID&&n.processorName===t.name&&n.type===i);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){let t=[];for(let{processorID:i,processorName:r,type:n,cb:o}of this.statsRegistry)try{let a=o();t.push({processorID:i,processorName:r,type:n,stats:a})}catch(a){S.error(new j(A.UNEXPECTED_ERROR,a.message))}return t}registerUsage(t,i){this.usageRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:i})}unregisterUsage(t){let i=this.usageRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){let t=[];if(!this.chained)return[];for(let{cb:i}of this.usageRegistry)try{let r=i();r instanceof ne&&(r=await r),t.push(bt(bt({},r),{},{direction:this.direction}))}catch(r){S.error("gather extension usage error",r)}return t}getDirection(){return this.direction}}class EP extends Ot{constructor(t){super(),B(this,"name","AudioProcessorDestination"),B(this,"ID","0"),B(this,"inputTrack",void 0),B(this,"inputNode",void 0),B(this,"audioProcessorContext",void 0),B(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new j(A.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new j(A.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(ar.ON_TRACK,void 0),this.emit(ar.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(ar.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(ar.ON_NODE,this.inputNode))}}class gP extends Ot{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,i,r){super(),B(this,"constraintsMap",new Map),B(this,"statsRegistry",[]),B(this,"audioContext",void 0),B(this,"trackId",void 0),B(this,"direction",void 0),B(this,"usageRegistry",[]),B(this,"_chained",!1),this.audioContext=t,this.trackId=i,this.direction=r}async getConstraints(){return ti(this,Zr.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,i){var r;return S.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(i,t),_t(this,Zr.REQUEST_UPDATE_CONSTRAINTS,Array.from(ho(r=this.constraintsMap).call(r)))}async requestRevertConstraints(t){var i;if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),_t(this,Zr.REQUEST_UPDATE_CONSTRAINTS,Array.from(ho(i=this.constraintsMap).call(i)))}registerStats(t,i,r){this.statsRegistry.find(n=>n.processorID===t.ID&&n.processorName===t.name&&n.type===i)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:i,cb:r})}unregisterStats(t,i){let r=this.statsRegistry.findIndex(n=>n.processorID===t.ID&&n.processorName===t.name&&n.type===i);r!==-1&&this.statsRegistry.splice(r,1)}gatherStats(){let t=[];for(let{processorID:i,processorName:r,type:n,cb:o}of this.statsRegistry)try{let a=o();t.push({processorID:i,processorName:r,type:n,stats:a})}catch(a){S.error(new j(A.UNEXPECTED_ERROR,a.message))}return t}registerUsage(t,i){this.usageRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:i})}unregisterUsage(t){let i=this.usageRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name);i!==-1&&this.usageRegistry.splice(i,1)}async gatherUsage(){let t=[];if(!this.chained)return[];for(let{cb:i}of this.usageRegistry)try{let r=i();r instanceof ne&&(r=await r),t.push(bt(bt({},r),{},{direction:this.direction}))}catch(r){S.error("gather extension usage error",r)}return t}getDirection(){return this.direction}}class cv extends Ot{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),B(this,"context",void 0),B(this,"processSourceNode",void 0),B(this,"outputTrack",void 0),B(this,"processedNode",void 0),B(this,"clonedTrack",void 0),B(this,"outputNode",void 0),this.outputNode=new u9}setVolume(){}createOutputTrack(){throw new j(A.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class u9{disconnect(){}connect(){}}function SP(e){return new ne((t,i)=>{let r=!1,n=document.createElement("video");n.setAttribute("autoplay",""),n.setAttribute("muted",""),n.muted=!0,n.autoplay=!0,n.setAttribute("playsinline",""),n.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(n);let o=ji()?"canplay":"playing";n.addEventListener(o,()=>{let a=n.videoWidth,l=n.videoHeight;!a&&mt()||(r=!0,n.srcObject=null,n.remove(),t([a,l]))}),n.srcObject=new MediaStream([e]),n.play().catch(pm),setTimeout(()=>{r||(n.srcObject=null,n.remove(),t([n.videoWidth,n.videoHeight]))},4e3)})}function t_(e){let t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});let i=Jo(e.encoderConfig);return i.width!=null&&(t.width=i.width),i.height!=null&&(t.height=i.height),!vb()&&i.frameRate&&(t.frameRate=i.frameRate),ub()&&typeof t.frameRate=="object"&&(t.frameRate.max=60),mt()&&(t.frameRate={ideal:30,max:30}),t}function TP(e){let t={};if(vb()||(e.AGC!==void 0&&(t.autoGainControl=e.AGC),e.AEC!==void 0&&(t.echoCancellation=e.AEC),e.ANS!==void 0&&(t.noiseSuppression=e.ANS,Ys()&&e.ANS&&(t.googHighpassFilter=e.ANS))),e.encoderConfig){let i=Zm(e.encoderConfig);t.channelCount=i.stereo?2:1,t.sampleRate=i.sampleRate,t.sampleSize=i.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),dm()&&(t.sampleRate=void 0),t}let h9=e=>{let t=e._encoderConfig;if(!t)return;let{frameRate:i,width:r,height:n}=e.getMediaStreamTrackSettings(),{frameRate:o=i,width:a=r,height:l=n}=t;if(!o||!a||!l)return;a=MS(a),l=MS(l),o=MS(o);let{max:d,min:u}=function(E,I,T){let R=200*Math.pow(T/15,.6)*Math.pow(E*I/640/360,.75);return{min:Math.floor(R),max:Math.floor(4*R)}}(a,l,o),{bitrateMax:p,bitrateMin:m}=t||{};p||S.debug("calculate bitrate: [w: ".concat(a,", h: ").concat(l,", fps: ").concat(o,"] => [brMax: ").concat(p,", brMin: ").concat(m,"]"));let{maxFramerate:f}=N("ENCODER_CONFIG_LIMIT");return f&&typeof f=="number"&&(o=Math.min(o,f)),{frameRate:o,bitrateMax:p||d,bitrateMin:m||u,scaleResolutionDownBy:1,scale:0}},vP=async(e,t,i)=>await(async(r,n,o)=>{let a=function(u){let p=[];for(let m=0;m<u.length;m+=2)p.push(parseInt(u.slice(m,m+2),16));return Uint8Array.from(p)}(jb(""+n+o)).slice(0,16),l=a.slice(0,12),d=await window.crypto.subtle.importKey("raw",a,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:l},d,r))})(e.buffer,t,i),lv=e=>{let t=document.createElement("canvas");return t.width=2,t.height=2,new ne((i,r)=>{t.toBlob(async n=>{if(t.remove(),n){let o=await RP(n);i({buffer:o,width:t.width,height:t.height})}else r(new j(A.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,1)})},RP=async e=>{let t=await e.arrayBuffer();return new Uint8Array(t)};var CP,yP,IP,wP,AP,OP,bP,NP,DP,PP,kP,LP,MP,UP,xP,VP,FP,jP,Lt,BP,GP,WP,HP,KP,zP,Qo,YP,qP,JP,XP,QP,ZP,$P,ek,tk,ik,rk,nk,ok,Ui;let jt=(CP=Ce({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),yP=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),IP=Kt(),wP=yl("LocalAudioTrack","_enabledMutex"),AP=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),OP=Kt(),bP=yl("LocalAudioTrack","_enabledMutex"),NP=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),DP=Kt(),PP=Kt(),kP=Kt(),LP=Ce({argsMap:e=>[e.getTrackId()]}),MP=Kt(),UP=Ce({argsMap:e=>[e.getTrackId()]}),xP=Kt(),VP=Ce({argsMap:e=>[e.getTrackId()]}),FP=Ce({argsMap:(e,t)=>[e.getTrackId(),t.name]}),jP=Ce({argsMap:e=>[e.getTrackId()]}),qe((Lt=class extends Xl{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?pr.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,i,r){super(e,i),B(this,"trackMediaType","audio"),B(this,"_encoderConfig",void 0),B(this,"_trackSource",void 0),B(this,"_enabled",!0),B(this,"_volume",100),B(this,"_useAudioElement",!0),B(this,"_bypassWebAudio",!1),B(this,"processor",void 0),B(this,"_processorContext",void 0),B(this,"_processorDestination",void 0),B(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!r,this._trackSource=new cv,N("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),N("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),pi()&&!$r?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(e){ut(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&pr.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void S.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));let t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,_t(this,ce.NEED_REPLACE_TRACK,this).then(()=>{S.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(i=>{S.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),i)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!$D())throw new j(A.NOT_SUPPORTED,"your browser does not support setting the audio output device");await pr.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,i){return this._setEnabled(e,t,i)}async _setEnabled(e,t,i){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),await _t(this,ce.NEED_ENABLE_TRACK,this),S.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(r){throw i||(this._enabled=!1),S.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{await _t(this,ce.NEED_DISABLE_TRACK,this)}catch(r){throw i||(this._enabled=!0),S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,S.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await _t(this,ce.NEED_MUTE_TRACK,this):await _t(this,ce.NEED_UNMUTE_TRACK,this))}getStats(){return Js(()=>{S.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Ur(this,ce.GET_STATS)||bt({},tv)}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Qr.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Qr.ON_AUDIO_BUFFER),this._source.on(Qr.ON_AUDIO_BUFFER,i=>e(i))}play(){S.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(S.debug("[".concat(this.getTrackId(),"] start audio playback in element")),pr.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){S.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?pr.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];S.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&pr.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await _t(this,ce.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return ne.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new j(A.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new j(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;let t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(ar.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await _t(this,ce.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await _t(this,ce.NEED_REPLACE_TRACK,this))}),e.on(ar.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(e){e.removeAllListeners(ar.ON_TRACK),e.removeAllListeners(ar.ON_NODE)}bindProcessorContextEvents(e){e.on(Zr.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(e){e.removeAllListeners(Zr.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof cv&&(this._trackSource=new cP(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){let e=new gP(this._source.context,this.getTrackId(),"local"),t=new EP(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(Qr.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(pr.stop(this.getTrackId()),this._source.play()),_t(this,ce.NEED_REPLACE_MIXING_TRACK,this).then(()=>{S.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(i=>{S.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),i)})),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[CP],Object.getOwnPropertyDescriptor(Lt.prototype,"setVolume"),Lt.prototype),qe(Lt.prototype,"setPlaybackDevice",[yP,IP],Object.getOwnPropertyDescriptor(Lt.prototype,"setPlaybackDevice"),Lt.prototype),qe(Lt.prototype,"setEnabled",[wP,AP,OP],Object.getOwnPropertyDescriptor(Lt.prototype,"setEnabled"),Lt.prototype),qe(Lt.prototype,"setMuted",[bP,NP,DP],Object.getOwnPropertyDescriptor(Lt.prototype,"setMuted"),Lt.prototype),qe(Lt.prototype,"getStats",[PP],Object.getOwnPropertyDescriptor(Lt.prototype,"getStats"),Lt.prototype),qe(Lt.prototype,"setAudioFrameCallback",[kP],Object.getOwnPropertyDescriptor(Lt.prototype,"setAudioFrameCallback"),Lt.prototype),qe(Lt.prototype,"play",[LP,MP],Object.getOwnPropertyDescriptor(Lt.prototype,"play"),Lt.prototype),qe(Lt.prototype,"stop",[UP,xP],Object.getOwnPropertyDescriptor(Lt.prototype,"stop"),Lt.prototype),qe(Lt.prototype,"close",[VP],Object.getOwnPropertyDescriptor(Lt.prototype,"close"),Lt.prototype),qe(Lt.prototype,"pipe",[FP],Object.getOwnPropertyDescriptor(Lt.prototype,"pipe"),Lt.prototype),qe(Lt.prototype,"unpipe",[jP],Object.getOwnPropertyDescriptor(Lt.prototype,"unpipe"),Lt.prototype),Lt),i_=(BP=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),GP=Kt(),WP=yl("MicrophoneAudioTrack","_enabledMutex"),HP=Ce({argsMap:(e,t,i)=>[e.getTrackId(),t,i]}),KP=Kt(),zP=Ce({argsMap:e=>[e.getTrackId()]}),qe((Qo=class extends jt{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,i,r){super(e,t.encoderConfig?Zm(t.encoderConfig):{},r,N("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),B(this,"_config",void 0),B(this,"_deviceName","default"),B(this,"_constraints",void 0),B(this,"_originalConstraints",void 0),B(this,"_enabled",!0),this._config=t,this._constraints=i,this._originalConstraints=i,this._deviceName=e.label,typeof t.bypassWebAudio=="boolean"&&(this._bypassWebAudio=t.bypassWebAudio),(vl()||OS())&&dt.bindInterruptDetectorTrack(this)}async setDevice(e){if(S.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{let t=await tn.getDeviceById(e),i={};i.audio=bt({},this._constraints),i.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let r=null;try{r=await en(i,this.getTrackId())}catch(n){throw S.error("[".concat(this.getTrackId(),"] setDevice failed"),n.toString()),r=await en({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),n}await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{let t=await tn.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}S.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,i){if(t)return S.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),e),N("AUTO_RESET_AUDIO_ROUTE")&&(ji()||Mn())){let a=navigator.audioSession;a&&(e||(a.type="playback"),a.type="auto")}if(!e){var r;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(r=this._source.clonedTrack)===null||r===void 0||r.stop(),i||(this._enabled=!1);try{await _t(this,ce.NEED_DISABLE_TRACK,this)}catch(a){throw S.error("[".concat(this.getTrackId(),"] setEnabled false failed"),a.toString()),a}return}let n=bt({},this._constraints),o=tn.searchDeviceIdByName(this._deviceName);o&&!n.deviceId&&(n.deviceId=o);try{i||(this._enabled=!0);let a=await en({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!1),await _t(this,ce.NEED_ENABLE_TRACK,this)}catch(a){throw i||(this._enabled=!1),S.error("[".concat(this.getTrackId(),"] setEnabled true failed"),a.toString()),a}S.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(vl()||OS())&&dt.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((ji()||Mn())&&this._enabled&&!this._isClosed&&dt.duringInterruption){let e=async()=>{dt.off(Oi.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};dt.on(Oi.IOS_INTERRUPTION_END,e)}else S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ql.TRACK_ENDED)}async renewMediaStreamTrack(e){let t=e||this._constraints,i=tn.searchDeviceIdByName(this._deviceName);if(i&&!t.deviceId&&(t.deviceId=i),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();let r=await en({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(Zr.REQUEST_UPDATE_CONSTRAINTS,async(t,i,r)=>{try{let n=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(n),i()}catch(n){r(n)}})}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(Zr.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[BP,GP],Object.getOwnPropertyDescriptor(Qo.prototype,"setDevice"),Qo.prototype),qe(Qo.prototype,"setEnabled",[WP,HP,KP],Object.getOwnPropertyDescriptor(Qo.prototype,"setEnabled"),Qo.prototype),qe(Qo.prototype,"close",[zP],Object.getOwnPropertyDescriptor(Qo.prototype,"close"),Qo.prototype),Qo),p9=(YP=Ce({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),qP=Kt(),JP=Ce({argsMap:e=>[e.getTrackId()]}),XP=Kt(),QP=Ce({argsMap:e=>[e.getTrackId()]}),ZP=Kt(),$P=Ce({argsMap:e=>[e.getTrackId()]}),ek=Kt(),tk=Ce({argsMap:e=>[e.getTrackId()]}),ik=Kt(),rk=Ce({argsMap:e=>[e.getTrackId()]}),nk=Ce({argsMap:e=>[e.getTrackId()]}),ok=Kt(),qe((Ui=class extends jt{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,i,r){super(t.createOutputTrack(),i,r),B(this,"source",void 0),B(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(Qr.AUDIO_SOURCE_STATE_CHANGE,n=>{this.safeEmit(ql.SOURCE_STATE_CHANGE,n)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){ut(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[YP,qP],Object.getOwnPropertyDescriptor(Ui.prototype,"startProcessAudioBuffer"),Ui.prototype),qe(Ui.prototype,"pauseProcessAudioBuffer",[JP,XP],Object.getOwnPropertyDescriptor(Ui.prototype,"pauseProcessAudioBuffer"),Ui.prototype),qe(Ui.prototype,"seekAudioBuffer",[QP,ZP],Object.getOwnPropertyDescriptor(Ui.prototype,"seekAudioBuffer"),Ui.prototype),qe(Ui.prototype,"resumeProcessAudioBuffer",[$P,ek],Object.getOwnPropertyDescriptor(Ui.prototype,"resumeProcessAudioBuffer"),Ui.prototype),qe(Ui.prototype,"stopProcessAudioBuffer",[tk,ik],Object.getOwnPropertyDescriptor(Ui.prototype,"stopProcessAudioBuffer"),Ui.prototype),qe(Ui.prototype,"close",[rk],Object.getOwnPropertyDescriptor(Ui.prototype,"close"),Ui.prototype),qe(Ui.prototype,"setAudioBufferPlaybackSpeed",[nk,ok],Object.getOwnPropertyDescriptor(Ui.prototype,"setAudioBufferPlaybackSpeed"),Ui.prototype),Ui);class ai extends jt{get __className__(){return"MixingAudioTrack"}get isActive(){for(let t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){let t=Ql().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,ft(8,"track-mix-")),B(this,"trackList",void 0),B(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(S.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):S.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){S.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}um(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){let t={};this.trackList.forEach(i=>{i._encoderConfig&&((i._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=i._encoderConfig.bitrate),(i._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=i._encoderConfig.sampleRate),(i._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=i._encoderConfig.sampleSize),i._encoderConfig.stereo&&(t.stereo=!0))}),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach(i=>{i instanceof ai?i.emit(gc.TRANSCEIVER_UPDATED,t):i._updateRtpTransceiver(t)}))}}class m9 extends aP{set currentState(t){t!==this._currentState&&(this._currentState=t,this.safeEmit(Qr.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),B(this,"audioBuffer",void 0),B(this,"sourceNode",void 0),B(this,"startPlayTime",0),B(this,"startPlayOffset",0),B(this,"pausePlayTime",0),B(this,"options",void 0),B(this,"currentLoopCount",0),B(this,"currentPlaybackSpeed",100),B(this,"_currentState","stopped"),this.audioBuffer=t,this.options=i,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(t){this.currentState==="stopped"?(this.options=t,this.startPlayOffset=this.options.startPlayTime||0):S.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(t){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=t,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=t))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(t){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=t/100),this.currentPlaybackSpeed=t}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){let t=this.context.createBufferSource();return t.buffer=this.audioBuffer,t.loop=!!this.options.loop,t.connect(this.outputNode),t.playbackRate.value=this.currentPlaybackSpeed/100,t}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}let sk=new Map;class dv{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){let t=this.renderStats.curTs-this.renderStats.lastTs,i=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/t;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,i}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(t){t!==this._videoElementStatus&&(S.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}get videoState(){return this._videoState}set videoState(t){var i;t!==this._videoState&&(this._videoState=t,(i=this.onVideoStateChanged)===null||i===void 0||i.call(this,this.videoState))}constructor(t){B(this,"trackId",void 0),B(this,"config",void 0),B(this,"onFirstVideoFrameDecoded",void 0),B(this,"onVideoStateChanged",void 0),B(this,"freezeTimeCounterList",[]),B(this,"renderFreezeAccTime",0),B(this,"isKeepLastFrame",!1),B(this,"timeUpdatedCount",0),B(this,"freezeTime",0),B(this,"playbackTime",0),B(this,"lastTimeUpdatedTime",0),B(this,"autoplayFailed",!1),B(this,"videoTrack",void 0),B(this,"videoElement",void 0),B(this,"cacheVideoElement",void 0),B(this,"renderStats",void 0),B(this,"_videoState",Xo.VideoStateStopped),B(this,"videoElementCheckInterval",void 0),B(this,"videoElementFreezeTimeout",void 0),B(this,"_videoElementStatus",Qi.NONE),B(this,"isGettingVideoDimensions",!1),B(this,"startGetVideoDimensions",()=>{let i=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return S.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(i,500)};!this.isGettingVideoDimensions&&i()}),B(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&dt.curState==="running"&&(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(db())),Sb()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),B(this,"handleVideoEvents",i=>{switch(i.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=Qi.PLAYING;break;case"loadeddata":if(this.videoState=Xo.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=Qi.CANPLAY;break;case"stalled":this.videoElementStatus=Qi.STALLED;break;case"suspend":this.videoElementStatus=Qi.SUSPEND;break;case"pause":this.videoElementStatus=Qi.PAUSED,ji()||Mn()||pi()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=Qi.WAITING;break;case"abort":this.videoElementStatus=Qi.ABORT;break;case"ended":this.videoElementStatus=Qi.ENDED;break;case"emptied":this.videoElementStatus=Qi.EMPTIED;break;case"error":{let r=this.videoElement.error;r?(this.videoElementStatus=Qi.ERROR,S.error("[".concat(this.trackId,"] media error: ").concat(r.message," (").concat(r.code,")"))):S.debug("[".concat(this.trackId,"] media not been an error."));break}case"timeupdate":{let r=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=r);let n=r-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=r,vs.lastVisibleTime<vs.lastHiddenTime||o<vs.lastHiddenTime||o<vs.lastVisibleTime)return;for(n>N("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=n),this.playbackTime+=n;this.playbackTime>=6e3;){this.playbackTime-=6e3;let a=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(a),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),B(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(S.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(db())),Sb()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),dt.on(Oi.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),dt.on(Oi.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){let i=this.videoElement.play();i&&i.catch&&i.catch(n=>{t&&mP(t,"video",n.message,this.trackId),n.name==="NotAllowedError"?(S.warning("detected video element autoplay failed",n),this.autoplayFailed=!0,this.handleAutoPlayFailed()):S.warning("[".concat(this.trackId,"] play warning: "),n)});let r=Xe();if((r.name==="Safari"&&Number(r.version)===15||vl())&&i&&i.then){let n=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};i.then(n).catch(n)}}getCurrentFrame(){let t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;let i=t.getContext("2d");if(!i)return S.error("create canvas context failed!"),new ImageData(2,2);i.drawImage(this.videoElement,0,0,t.width,t.height);let r=i.getImageData(0,0,t.width,t.height);return t.remove(),r}async getCurrentFrameToUint8Array(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,r=document.createElement("canvas");r.width=this.videoElement.videoWidth,r.height=this.videoElement.videoHeight;let n=r.getContext("2d");return n?(n.drawImage(this.videoElement,0,0,r.width,r.height),new ne((o,a)=>{r.toBlob(async l=>{if(r.remove(),l){let d=await RP(l);o({buffer:d,width:r.width,height:r.height})}else a(new j(A.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,i<0?.1:i>1?1:i)})):await lv(t)}destroy(){this.renderStats=void 0,dt.off(Oi.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),dt.off(Oi.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Xo.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=Qi.INIT,!this.videoElementCheckInterval&&(ak.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(o){return o!==document.body&&document.body.contains(o)})(this.videoElement)||(this.videoElementStatus=Qi.DESTROYED)},1e3),N("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,i;let o,a=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",a),this.videoElementFreezeTimeout=window.setTimeout(l,N("VIDEO_FREEZE_DURATION")))},l=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Xo.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Xo.VideoStateFrozen:document.addEventListener("visibilitychange",a))},d=(u,p)=>{if(this.videoElementStatus===Qi.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=p.mediaTime):this.renderStats={lastTs:p.mediaTime,curTs:p.mediaTime,lastRenderNum:0,renderNum:0},o){let E=p.presentationTime-o.presentationTime;this.videoState===Xo.VideoStateStarting&&(this.videoState=Xo.VideoStateDecoding),this.videoState===Xo.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(l,N("VIDEO_FREEZE_DURATION"))),E<N("VIDEO_FREEZE_DURATION")&&this.videoState===Xo.VideoStateFrozen&&(this.videoState=Xo.VideoStateDecoding),E>N("VIDEO_FREEZE_DURATION")&&vs.lastVisibleTime>=vs.lastHiddenTime&&o.timestamp>vs.lastVisibleTime&&o.timestamp>vs.lastHiddenTime&&(this.renderFreezeAccTime+=E)}o=bt(bt({},p),{},{timestamp:u})}var m,f;N("ENABLE_VIDEO_FRAME_CALLBACK")&&((m=(f=this.videoElement).requestVideoFrameCallback)===null||m===void 0||m.call(f,d))};(t=(i=this.videoElement).requestVideoFrameCallback)===null||t===void 0||t.call(i,d)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),dm()&&!N("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");let r=Xe();r.name==="Safari"&&Number(r.version)===15||vl()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,mt()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,mt()&&this.videoElement.load());let n=this.videoElement.play();n!==void 0&&n.catch(o=>{S.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){ak.forEach(t=>{this.videoElement&&this.videoElement.removeEventListener(t,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=Qi.NONE}handleAutoPlayFailed(){let t=i=>{i.preventDefault(),this.videoElement.play().then(()=>{S.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(r=>{S.error(r)}),this.autoplayFailed=!1,fu()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};fu()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),pP()}}let ak=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class ck extends dv{constructor(t){super(t),B(this,"container",void 0),B(this,"slot",void 0),this.slot=t.element,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;let i=t.element;i!==this.slot&&(this.destroy(),this.slot=i),this.createElements()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var i;(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var i;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,r):await lv(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",N("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var lk,dk,uk,hk,pk,mk,_k,fk,Ek,gk,Sk,Tk,vk,Rk,Ck,yk,Ik,wk,Ak,Ok,bk,Nk,Dk,Pk,kk,He,Lk,Mk,Uk,xk,Vk,Fk,jk,Bk,nn;let Et=(lk=Ce({argsMap:(e,t,i)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),dk=Kt(),uk=Ce({argsMap:e=>[e.getTrackId()]}),hk=yl("LocalVideoTrack","_enabledMutex"),pk=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),mk=Kt(),_k=yl("LocalVideoTrack","_enabledMutex"),fk=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),Ek=Kt(),gk=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),Sk=Kt(),Tk=Kt(),vk=Ce({argsMap:(e,t,i)=>[e.getTrackId(),t,i]}),Rk=Kt(),Ck=Kt(),yk=Kt(),Ik=Kt(),wk=Kt(),Ak=Kt(),Ok=Kt(),bk=Ce({argsMap:(e,t)=>[e.getTrackId(),t.name]}),Nk=Ce({argsMap:e=>[e.getTrackId()]}),Dk=Ce({argsMap:e=>[e.getTrackId()]}),Pk=Ce({argsMap:(e,t,i)=>[e.getTrackId(),t.label,i]}),kk=Ce(),He=class cV extends Xl{get videoHeight(){if(pi()){let{height:t}=this._mediaStreamTrack.getSettings();return this._videoHeight=t,this._videoHeight}return this._videoHeight}get videoWidth(){if(pi()){let{width:t}=this._mediaStreamTrack.getSettings();return this._videoWidth=t,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Qi.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,i,r,n,o,a){if(super(t,o),B(this,"trackMediaType","video"),B(this,"_player",void 0),B(this,"isUseScaleResolutionDownBy",!1),B(this,"_videoVisibleTimer",null),B(this,"_statsTimer",null),B(this,"_previousVideoVisibleStatus",void 0),B(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),B(this,"_encoderConfig",void 0),B(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),B(this,"_optimizationMode",void 0),B(this,"_videoHeight",void 0),B(this,"_videoWidth",void 0),B(this,"_forceBitrateLimit",void 0),B(this,"_enabled",!0),B(this,"_processorDestination",void 0),B(this,"_processorContext",void 0),pi()){let{width:l,height:d}=t.getSettings();this._videoWidth=l,this._videoHeight=d}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=i,this._scalabilityMode=r,this._optimizationMode=n,this._hints=a||[],this._hints.indexOf(Rt.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(function(l,d,u){let p=Xe();return!(p.name!==l||!p.osVersion)&&Number(p.version)===d}(nt.CHROME,115)&&cm().indexOf("Windows")!==-1){let l=function(d,u){if("VideoFrame"in window&&"TransformStream"in window&&Ye().supportWebRTCInsertableStream){let p=new MediaStreamTrackProcessor(d),m=new MediaStreamTrackGenerator({kind:"video"}),f,E,I=Date.now(),T=()=>{R&&(clearInterval(R),R=void 0),f&&(f.close(),f=void 0),d.stop(),E=void 0,m.removeEventListener("ended",T)},R=window.setInterval(()=>{if(E&&f&&Date.now()-I>1e3)try{m.readyState==="live"?E.enqueue(f.clone()):T()}catch{T()}},1e3),w=new TransformStream({transform:(O,P)=>{m.readyState==="live"?(E=P,I=Date.now(),f===void 0?(f=O,P.enqueue(O.clone())):(P.enqueue(f),f=O)):O.close()}});return m.addEventListener("ended",T),p.readable.pipeThrough(w).pipeTo(m.writable),m}}(t);l&&(S.info("local screen video track begin to inject frame"),this._mediaStreamTrack=l)}i&&this._hints.indexOf(Rt.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(i),this._processorContext=new fP(this.getTrackId(),"local"),this._processorDestination=new _P(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){let n=document.getElementById(t);n?t=n:(S.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}S.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));let r=bt(bt(bt({},this._getDefaultPlayerConfig()),i),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(r):(t instanceof HTMLVideoElement?this._player=new dv(r):this._player=new ck(r),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let n=this.getVideoElementVisibleStatus();this.safeEmit(ql.VIDEO_ELEMENT_VISIBLE_STATUS,n)}catch{}},N("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,S.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await _t(this,ce.NEED_DISABLE_TRACK,this)}catch(r){throw S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}return i||(this._enabled=!1),void S.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await _t(this,ce.NEED_ENABLE_TRACK,this)}catch(r){throw S.error("[".concat(this.getTrackId(),"] setEnabled to true error"),r.toString()),r}S.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,S.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await _t(this,ce.NEED_MUTE_TRACK,this):await _t(this,ce.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(t,i){if(!this._enabled)throw new j(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=Jo(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){let r=t_({encoderConfig:t});(pi()||ji()||Mn())&&(r.deviceId=void 0),S.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(n){let o=new j(A.UNEXPECTED_ERROR,n.toString());throw S.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=t,this._hints.indexOf(Rt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await _t(this,ce.NEED_UPDATE_VIDEO_ENCODER,this)}catch(r){return r.throw(S)}}getStats(){return Js(()=>{S.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Ur(this,ce.GET_STATS)||bt({},iv)}async setBeautyEffect(t){S.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,i):await lv(t)}async setBitrateLimit(t){if(S.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t){this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate);try{await _t(this,ce.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(S)}}}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void S.error(A.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");let i=this._optimizationMode;try{this._optimizationMode=t,await _t(this,ce.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(r){throw this._optimizationMode=i,S.error("[".concat(this.getTrackId(),"] set optimization mode failed"),r.toString()),r}S.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return S.error(A.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,S.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){SP(this._originMediaStreamTrack).then(t=>{let[i,r]=t;this._videoHeight=r,this._videoWidth=i}).catch(pm)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new j(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");S.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=Jo(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(Rt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await _t(this,ce.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(S)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;let{width:t,height:i,frameRate:r}=this.getMediaStreamTrackSettings();if(!t||!i||!r)return;let{bitrateMax:n,bitrateMin:o}=this._encoderConfig;if(o==null||n==null){let{max:a,min:l}=function(d,u,p,m,f){let E=N("BITRATE_ADAPTER_TYPE");if(E==="DEFAULT_BITRATE")return{min:m,max:f};if(f===void 0){var I;let R=Math.floor(200*Math.pow(p/15,.6)*Math.pow(d*u/640/360,.75));f=E==="STANDARD_BITRATE"?4*R:2*R,m=(I=m)!==null&&I!==void 0?I:R}else{var T;m=(T=m)!==null&&T!==void 0?T:Math.floor(f/10)}return{min:m,max:f}}(t,i,r,o,n);this._encoderConfig.bitrateMin=l,this._encoderConfig.bitrateMax=a,S.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(i,", fps: ").concat(r,"] => [brMax: ").concat(a,", brMin: ").concat(l,"]"))}}getVideoElementVisibleStatus(){try{var t,i;let r=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),n={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:r==null?void 0:r.parentElement},{element:o,slot:a}=n;if(this.isPlaying&&o instanceof HTMLVideoElement&&a instanceof HTMLElement){let l=wb.checkOneElementVisible(o),d=Object.assign({},l);if(d.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=d.visible;let u=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});d.visible?u.onSuccess("Video is visible"):u.onSuccess("Invisible because of ".concat(d.reason))}return d}return}catch(r){throw new j(A.GET_VIDEO_ELEMENT_VISIBLE_ERROR,r.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new j(A.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;let t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;t&&(r=bt(bt({},r),Jo(t))),r=rc(r);let n=ft(8,"track-video-cloned-"),o=new cV(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,r,rc(this._scalabilityMode),this._optimizationMode,n,rc(this._hints));return t&&r&&o.setEncoderConfiguration(r),S.debug("clone video track from ".concat(this.getTrackId()," to ").concat(n,", clone ").concat(i)),o}async replaceTrack(t,i){if(!(t instanceof MediaStreamTrack))throw new j(A.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new j(A.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,i,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!pi()&&!ji())return;this._statsTimer&&window.clearInterval(this._statsTimer);let t=2,i=Xm[t],r=-1,n=Date.now(),o=a=>{a>2||a<0||(n=Date.now(),i=Xm[a],this.setSenderConfiguration(i))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{let a=this.getStats(),l=Ur(this,ce.GET_RTC_STATS);if(a.sendPackets>0&&l){r===-1&&(r=Date.now());let d=Date.now();if(d-r<1e3||d-n<N("PROFILE_SWITCH_INTERVAL"))return;let u=a.sendFrameRate,p=.6*i.frameRate,m=.9*i.frameRate;typeof u=="number"&&u>0&&u<p?t>0&&(t--,o(t),S.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(u,", switchProfile to ").concat(t))):l.OutgoingAvailableBandwidth<i.bitrateMin?t>0&&(t--,o(t),S.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(l.OutgoingAvailableBandwidth,", bitrateMin ").concat(i.bitrateMin,", switchProfile to ").concat(t))):typeof u=="number"&&u>m&&t<Xm.length-1&&l.OutgoingAvailableBandwidth>1.2*Xm[t+1].bitrateMin&&(t++,o(t),S.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(u,", OutgoingAvailableBandwidth ").concat(l.OutgoingAvailableBandwidth,", switchProfile to ").concat(t)))}},N("CHECK_LOCAL_STATS_INTERVAL"))}sendSeiData(t){if(Js(()=>{_e.reportApiInvoke(null,{name:ei.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:xt.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!N("ENABLE_VIDEO_SEI")||!N("ENABLE_ENCODED_TRANSFORM"))return void S.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(t instanceof Uint8Array==0)return new j(A.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();let i=this.getRTCRtpTransceiver();if(!i)return void S.warning("Video track is not published, SEI can not be send");let r=i.sender.getParameters();if(r.codecs.length===0)return;let n=r.codecs[0].mimeType.toLocaleLowerCase();n==="video/h264"?this.safeEmit("sei-to-send",t):S.warning("SEI is not supported by ".concat(n))}bindProcessorDestinationEvents(){this.processorDestination.on(ar.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await _t(this,ce.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await _t(this,ce.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ar.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(Zr.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(Zr.REQUEST_CONSTRAINTS)}},qe(He.prototype,"play",[lk,dk],Object.getOwnPropertyDescriptor(He.prototype,"play"),He.prototype),qe(He.prototype,"stop",[uk],Object.getOwnPropertyDescriptor(He.prototype,"stop"),He.prototype),qe(He.prototype,"setEnabled",[hk,pk,mk],Object.getOwnPropertyDescriptor(He.prototype,"setEnabled"),He.prototype),qe(He.prototype,"setMuted",[_k,fk,Ek],Object.getOwnPropertyDescriptor(He.prototype,"setMuted"),He.prototype),qe(He.prototype,"setEncoderConfiguration",[gk,Sk],Object.getOwnPropertyDescriptor(He.prototype,"setEncoderConfiguration"),He.prototype),qe(He.prototype,"getStats",[Tk],Object.getOwnPropertyDescriptor(He.prototype,"getStats"),He.prototype),qe(He.prototype,"setBeautyEffect",[vk,Rk],Object.getOwnPropertyDescriptor(He.prototype,"setBeautyEffect"),He.prototype),qe(He.prototype,"getCurrentFrameData",[Ck],Object.getOwnPropertyDescriptor(He.prototype,"getCurrentFrameData"),He.prototype),qe(He.prototype,"getCurrentFrameImage",[yk],Object.getOwnPropertyDescriptor(He.prototype,"getCurrentFrameImage"),He.prototype),qe(He.prototype,"setBitrateLimit",[Ik],Object.getOwnPropertyDescriptor(He.prototype,"setBitrateLimit"),He.prototype),qe(He.prototype,"setOptimizationMode",[wk],Object.getOwnPropertyDescriptor(He.prototype,"setOptimizationMode"),He.prototype),qe(He.prototype,"setScalabiltyMode",[Ak],Object.getOwnPropertyDescriptor(He.prototype,"setScalabiltyMode"),He.prototype),qe(He.prototype,"updateMediaStreamTrackResolution",[Ok],Object.getOwnPropertyDescriptor(He.prototype,"updateMediaStreamTrackResolution"),He.prototype),qe(He.prototype,"pipe",[bk],Object.getOwnPropertyDescriptor(He.prototype,"pipe"),He.prototype),qe(He.prototype,"unpipe",[Nk],Object.getOwnPropertyDescriptor(He.prototype,"unpipe"),He.prototype),qe(He.prototype,"close",[Dk],Object.getOwnPropertyDescriptor(He.prototype,"close"),He.prototype),qe(He.prototype,"replaceTrack",[Pk],Object.getOwnPropertyDescriptor(He.prototype,"replaceTrack"),He.prototype),qe(He.prototype,"startMonitorStats",[kk],Object.getOwnPropertyDescriptor(He.prototype,"startMonitorStats"),He.prototype),He),uv=(Lk=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),Mk=Kt(),Uk=yl("CameraVideoTrack","_enabledMutex"),xk=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),Vk=Kt(),Fk=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),jk=Kt(),Bk=Ce({argsMap:e=>[e.getTrackId()]}),nn=class lV extends Et{get __className__(){return"CameraVideoTrack"}constructor(t,i,r,n,o,a){super(t,Jo(i.encoderConfig),n,o,a),B(this,"_config",void 0),B(this,"_originalConstraints",void 0),B(this,"_constraints",void 0),B(this,"_enabled",!0),B(this,"_deviceName","default"),B(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(vl()||OS())&&!function(){let l=Xe();if(l.os!==hi.IOS||!l.osVersion)return!1;let d=l.osVersion.split(".");return Number(d[0])===15&&Number(d[1])>=2}()&&Tb()&&this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=i,this._originalConstraints=r,this._constraints=r,this._deviceName=t.label,this._encoderConfig=Jo(this._config.encoderConfig),dt.on(Oi.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),dt.on(Oi.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(S.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{let i=await tn.getDeviceById(t),r={};r.video=bt({},this._constraints),r.video.deviceId={exact:t},r.video.facingMode=void 0,this._originMediaStreamTrack.stop();let n=null;try{n=await en(r,this.getTrackId())}catch(o){throw S.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),n=await en({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=i.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(i){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{let i=await tn.getDeviceById(t);this._deviceName=i.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(i){throw S.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}S.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){S.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));let i={video:bt(bt({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let r=null;try{r=await en(i,this.getTrackId())}catch(n){throw S.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),n.toString()),r=await en({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),n}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=bt({},i.video),S.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,i){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(S.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{let r=await en({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1)}await _t(this,ce.NEED_ENABLE_TRACK,this)}catch(r){throw S.error("[".concat(this.getTrackId(),"] setEnabled true error"),r.toString()),r}this.updateMediaStreamTrackResolution(),S.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),i||(this._enabled=!1);try{await _t(this,ce.NEED_DISABLE_TRACK,this)}catch(r){throw S.error("[".concat(this.getTrackId(),"] setEnabled to false error"),r.toString()),r}S.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,i){if(!this._enabled)throw new j(A.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=Jo(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate||t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate||t.bitrateMin);let r=vt(this._config);r.encoderConfig=t;let n=t_(r);(pi()||ji()||Mn())&&(n.deviceId=void 0),S.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(n));try{await this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(o){let a=new j(A.UNEXPECTED_ERROR,o.toString());throw S.error("[".concat(this.getTrackId(),"] applyConstraints error"),a.toString()),a}this._config=r,this._constraints=n,this._originalConstraints=n,this._encoderConfig=t,this._hints.indexOf(Rt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await _t(this,ce.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(S)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((ji()||Mn())&&this._enabled&&!this._isClosed&&dt.duringInterruption){let t=async()=>{dt.off(Oi.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(S.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};dt.on(Oi.IOS_INTERRUPTION_END,t)}else S.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ql.TRACK_ENDED)}async renewMediaStreamTrack(t){let i=t||this._constraints,r=tn.searchDeviceIdByName(this._deviceName);if(r&&!i.deviceId&&(i.deviceId={exact:r}),this._enabled){let n=await en({video:i},this.getTrackId());this._constraints=i,await this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),dt.off(Oi.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),dt.off(Oi.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],r=this._encoderConfig;t&&(r=bt(bt({},r),Jo(t))),r=rc(r);let n=ft(8,"track-cam-cloned-"),o=new lV(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,rc(bt(bt({},this._config),{},{encoderConfig:r})),rc(this._constraints),rc(this._scalabilityMode),this._optimizationMode,n);return t&&r&&o.setEncoderConfiguration(r),S.debug("clone track from ".concat(this.getTrackId()," to ").concat(n,", clone ").concat(i)),o}bindProcessorContextEvents(){this.processorContext.on(Zr.REQUEST_UPDATE_CONSTRAINTS,async(t,i,r)=>{try{let n=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(n),i()}catch(n){r(n)}}),this.processorContext.on(Zr.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}},qe(nn.prototype,"setDevice",[Lk,Mk],Object.getOwnPropertyDescriptor(nn.prototype,"setDevice"),nn.prototype),qe(nn.prototype,"setEnabled",[Uk,xk,Vk],Object.getOwnPropertyDescriptor(nn.prototype,"setEnabled"),nn.prototype),qe(nn.prototype,"setEncoderConfiguration",[Fk,jk],Object.getOwnPropertyDescriptor(nn.prototype,"setEncoderConfiguration"),nn.prototype),qe(nn.prototype,"close",[Bk],Object.getOwnPropertyDescriptor(nn.prototype,"close"),nn.prototype),nn);function hv(e,t,i,r){i.optimizationMode&&(r&&r.width&&r.height?(i.encoderConfig=bt(bt({},r),{},{bitrateMin:r.bitrateMin,bitrateMax:r.bitrateMax}),i.optimizationMode!=="motion"&&i.optimizationMode!=="detail"||(t.contentHint=i.optimizationMode,t.contentHint===i.optimizationMode?S.debug("[".concat(e,"] set content hint to"),i.optimizationMode):S.debug("[".concat(e,"] set content hint failed")))):S.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}var Gk,Wk,Hk,Kk,Sn,zk,Yk,qk,Jk,Xk,Qk,Zi;class Zk extends nP{getUserId(){return this._userId}constructor(t,i,r,n){super(t,"track-".concat(t.kind,"-").concat(i,"-").concat(n.clientId,"_").concat(ft(5,""))),B(this,"_userId",void 0),B(this,"_uintId",void 0),B(this,"_isDestroyed",!1),B(this,"store",void 0),B(this,"processor",void 0),B(this,"processorContext",void 0),this._userId=i,this._uintId=r,this.store=n}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,S.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let $l=(Gk=Ce({argsMap:(e,t,i)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),Wk=Ce({argsMap:e=>[e.getTrackId()]}),Hk=Ce({argsMap:(e,t)=>[e.getTrackId(),t.name]}),Kk=Ce({argsMap:e=>[e.getTrackId()]}),qe((Sn=class extends Zk{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==Qi.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,i,r){super(e,t,i,r),B(this,"_videoVisibleTimer",null),B(this,"_previousVideoVisibleStatus",void 0),B(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),B(this,"trackMediaType","video"),B(this,"_videoWidth",void 0),B(this,"_videoHeight",void 0),B(this,"_player",void 0),B(this,"processorDestination",void 0),B(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new fP(this.getTrackId(),"remote"),this.processorDestination=new _P(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Js(()=>{S.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Ur(this,ce.GET_STATS)||bt({},iP)}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){let r=document.getElementById(e);r?e=r:(S.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}S.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));let i=bt(bt({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(i):(e instanceof HTMLVideoElement?this._player=new dv(i):this._player=new ck(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Jl.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=r=>{this.safeEmit(Jl.VIDEO_STATE_CHANGED,r)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let r=this.getVideoElementVisibleStatus();this.safeEmit(Jl.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},N("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,S.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){SP(this._originMediaStreamTrack).then(e=>{let[t,i]=e;this._videoHeight=i,this._videoWidth=t}).catch(pm)}_updatePlayerSource(){S.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;let i=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:n,slot:o}=r;if(this.isPlaying&&n instanceof HTMLVideoElement&&o instanceof HTMLElement){let a=wb.checkOneElementVisible(n),l=Object.assign({},a);if(l.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=l.visible;let d=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});l.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(l.reason))}return l}return}catch(i){throw new j(A.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new j(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;let e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ar.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ar.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(gc.SEI_RECEIVED,e)}}).prototype,"play",[Gk],Object.getOwnPropertyDescriptor(Sn.prototype,"play"),Sn.prototype),qe(Sn.prototype,"stop",[Wk],Object.getOwnPropertyDescriptor(Sn.prototype,"stop"),Sn.prototype),qe(Sn.prototype,"pipe",[Hk],Object.getOwnPropertyDescriptor(Sn.prototype,"pipe"),Sn.prototype),qe(Sn.prototype,"unpipe",[Kk],Object.getOwnPropertyDescriptor(Sn.prototype,"unpipe"),Sn.prototype),Sn),ed=(zk=Ce({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),Yk=Ce({argsMap:(e,t)=>[e.getTrackId(),t]}),qk=Ce({argsMap:e=>[e.getTrackId()]}),Jk=Ce({argsMap:e=>[e.getTrackId()]}),Xk=Ce({argsMap:(e,t)=>[e.getTrackId(),t.name]}),Qk=Ce({argsMap:e=>[e.getTrackId()]}),qe((Zi=class extends Zk{get isPlaying(){return this._useAudioElement?pr.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,i,r){super(e,t,i,r),B(this,"trackMediaType","audio"),B(this,"_source",void 0),B(this,"_useAudioElement",!0),B(this,"_volume",100),B(this,"processorContext",void 0),B(this,"processorDestination",void 0),B(this,"_played",!1),B(this,"_bypassWebAudio",!1),N("DISABLE_WEBAUDIO")?(this._source=new cv,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new cP(e,!0),N("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(Qr.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Jl.FIRST_FRAME_DECODED)}),this.processorContext=new gP(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new EP(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(Qr.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(Qr.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(Qr.ON_AUDIO_BUFFER),this._source.on(Qr.ON_AUDIO_BUFFER,i=>e(i))}setVolume(e){this._volume=e,this._useAudioElement?pr.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!$D())throw new j(A.NOT_SUPPORTED,"your browser does not support setting the audio output device");await pr.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Js(()=>{S.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Ur(this,ce.GET_STATS)||bt({},tP)}play(){S.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(S.debug("[".concat(this.getTrackId(),"] use audio element to play")),pr.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){S.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?pr.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];S.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&pr.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new j(A.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new j(A.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new j(A.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;let t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(ar.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(ar.ON_NODE,e=>{this._source.processedNode=e;let t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(ar.ON_TRACK),this.processorDestination.removeAllListeners(ar.ON_NODE)}}).prototype,"setVolume",[zk],Object.getOwnPropertyDescriptor(Zi.prototype,"setVolume"),Zi.prototype),qe(Zi.prototype,"setPlaybackDevice",[Yk],Object.getOwnPropertyDescriptor(Zi.prototype,"setPlaybackDevice"),Zi.prototype),qe(Zi.prototype,"play",[qk],Object.getOwnPropertyDescriptor(Zi.prototype,"play"),Zi.prototype),qe(Zi.prototype,"stop",[Jk],Object.getOwnPropertyDescriptor(Zi.prototype,"stop"),Zi.prototype),qe(Zi.prototype,"pipe",[Xk],Object.getOwnPropertyDescriptor(Zi.prototype,"pipe"),Zi.prototype),qe(Zi.prototype,"unpipe",[Qk],Object.getOwnPropertyDescriptor(Zi.prototype,"unpipe"),Zi.prototype),Zi),vs=new class extends Ot{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),B(this,"_lastHiddenTime",0),B(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),S.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};var $k=function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e}($k||{});class _9{constructor(){B(this,"_sequence",0),B(this,"_startTime",Date.now()),B(this,"isUseOneByte",!0)}get startTime(){let t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){let i={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){let l=new Uint8Array(4);l.set([1,0,0,0]);let d={id:0,length:4,data:l.buffer},u={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[d]};i.commonPacketHeader.extension=1,i.extension=u,i.payload=this.compress(t),i.commonPacketHeader.length=8+(i.extension.length+2)+i.payload.byteLength}else i.commonPacketHeader.length=8+i.payload.byteLength;N("SHOW_DATASTREAM2_LOG")&&S.debug("send data header: ".concat(JSON.stringify(i.commonPacketHeader)));let r=new ArrayBuffer(i.commonPacketHeader.length),n=new Uint8Array(r),o=new DataView(r),a=0;if(o.setUint16(a,i.commonPacketHeader.extension<<15|i.commonPacketHeader.reserved<<14|i.commonPacketHeader.length,!0),a+=2,o.setUint32(a,i.commonPacketHeader.sequence,!0),a+=4,o.setUint16(a,i.commonStreamHeader,!0),a+=2,i.extension){let l=this.serializeExtension(i.extension);n.set(new Uint8Array(l),a),a+=l.byteLength}if(n.set(new Uint8Array(i.payload),a),a+=i.payload.byteLength,a!==i.commonPacketHeader.length)throw Error("serialize error!");return r}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);let i=new DataView(t),r=0,n=i.getUint16(r,!0);r+=2;let o={length:16383&n,reserved:(16384&n)>>14,extension:(32768&n)>>15,sequence:i.getUint16(r+2,!0)<<16|i.getUint16(r,!0)},a,l;if(r+=4,N("SHOW_DATASTREAM2_LOG")&&S.debug("receive data header: ".concat(JSON.stringify(o))),i.getUint16(r,!0),r+=2,o.extension){l=this.deserializeExtension(t.slice(r)),r+=2+l.length,a=t.slice(r);let d=!1;if(l.datas.length>0){let u=l.datas.find(p=>p.id===0);u&&(d=(1&new DataView(u.data).getUint32(0,!0))==1)}a=d?this.decompress(a):a}else a=t.slice(8);return a}serializeExtension(t){let{profile:i,length:r,datas:n}=t,o=new ArrayBuffer(r+2),a=new Uint8Array(o),l=new DataView(o),d=0;if(l.setUint8(d++,i),l.setUint8(d++,r),n.forEach(u=>{i?(l.setUint8(d++,u.id),l.setUint8(d++,u.length),a.set(new Uint8Array(u.data),d),d+=u.data.byteLength):(l.setUint8(d++,u.id|u.length<<4),a.set(new Uint8Array(u.data),d),d+=u.data.byteLength)}),d!==r+2)throw Error("serialize extension error, is ".concat(d,"!==").concat(r+2));return o}deserializeExtension(t){let i=new DataView(t),r=0,n=i.getUint8(r);r++;let o=i.getUint8(r);r++;let a=n===$k.TWO_BYTE,l=[],d=new DataView(t,2),u=0;for(;u<o;){let p=0,m=0,f=new ArrayBuffer(0);a?(p=d.getUint8(u),u++,m=d.getUint8(u),u++):(p=15&d.getUint8(u),m=d.getUint8(u)>>4,u++),m>0&&(f=d.buffer.slice(u+2,u+2+m),u+=f.byteLength),l.push({id:p,length:m,data:f})}if(u!==o)throw Error("parse error");return{profile:n,length:o,datas:l}}decompress(t){return e9(new Uint8Array(t))}compress(t){return $q(new Uint8Array(t))}}class eL extends Ot{constructor(t,i){super(),B(this,"_version",1),B(this,"_type",3),B(this,"_config",void 0),B(this,"_originDataChannel",void 0),B(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),B(this,"_dataStreamPacketHandler",void 0),B(this,"_datachannelEventMap",new Map),this._config=t,i&&(this._originDataChannel=i,this._bandDataChannelEvents(i)),this._initPacketHeader(),this._dataStreamPacketHandler=new _9}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return N("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,i;return(t=(i=this._originDataChannel)===null||i===void 0?void 0:i.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,i;return(t=(i=this._originDataChannel)===null||i===void 0?void 0:i.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new ne((t,i)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();let r=setTimeout(()=>{var n;i(new j(A.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((n=this._originDataChannel)===null||n===void 0?void 0:n.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(r),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(r),new j(A.DATACHANNEL_CONNECTION_TIMEOUT)}}else i(new j(A.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){let t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[$m.OPEN,$m.CLOSE,$m.ERROR].forEach(i=>{let r=()=>{this.emit(i)};this._datachannelEventMap.set(i,r),t.addEventListener(i,r)})}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach(i=>{let[r,n]=i;t.removeEventListener(r,n)}),this._datachannelEventMap.clear()}}class f9 extends eL{constructor(t){super(t),B(this,"_messageListener",void 0),this._messageListener=i=>{if(i.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);let r=i.data.slice(0,this._dataStreamPacketHeader.byteLength),n=new DataView(r).getUint8(3);if(n!==this.id)return void(N("SHOW_DATASTREAM2_LOG")&&S.debug("invalid datachannel id: ".concat(n," !== ").concat(this.id)));let o=i.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit($m.MESSAGE,o)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class tL extends eL{send(t){if(this._originDataChannel){let i=t;i=this._dataStreamPacketHandler.serialize(t);let r=new Uint8Array(this._dataStreamPacketHeader.byteLength+i.byteLength);r.set(new Uint8Array(this._dataStreamPacketHeader),0),r.set(new Uint8Array(i),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(r.buffer)}}}function r_(){let e=new Blob([atob("ZnVuY3Rpb24gZShlKXtjb25zdCB0PW5ldyBEYXRhVmlldyhlLmRhdGEpO2lmKDA9PT10LmdldFVpbnQ4KDApJiYwPT09dC5nZXRVaW50OCgxKSYmMD09PXQuZ2V0VWludDgoMikmJjE9PT10LmdldFVpbnQ4KDMpJiY2PT09dC5nZXRVaW50OCg0KSl7bGV0IG49NixyPTAsbz0wO2Zvcig7MjU1PT09KG89dC5nZXRVaW50OChuKyspKTspcis9MjU1O3IrPW87Y29uc3QgYT1mdW5jdGlvbihlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLG89W10sYT0wO2Zvcig7YTxuOylhKzM8biYmMD09PXJbYV0mJjA9PT1yW2ErMV0mJjM9PT1yW2ErMl0mJigwPT09clthKzNdfHwxPT09clthKzNdfHwyPT09clthKzNdfHwzPT09clthKzNdKT8oby5wdXNoKHJbYV0sclthKzFdLHJbYSszXSksYSs9NCk6KG8ucHVzaChyW2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShvKX0oZS5kYXRhLG4scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGEpfXJldHVybiBudWxsfWZ1bmN0aW9uIHQoZSx0KXtjb25zdCBuPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9ZS5sZW5ndGg7bGV0IG49W10scj0wO2Zvcig7cjx0OylyKzI8dCYmMD09PWVbcl0mJjA9PT1lW3IrMV0mJigwPT09ZVtyKzJdfHwxPT09ZVtyKzJdfHwyPT09ZVtyKzJdfHwzPT09ZVtyKzJdKT8obi5wdXNoKGVbcl0sZVtyKzFdLDMsZVtyKzJdKSxyKz0zKToobi5wdXNoKGVbcl0pLHIrKyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KG4pfSh0KSxyPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihyLzI1NSksYT1yJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK3IrZS5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBpPTA7Zm9yKDtpPG87KXNbNitpXT0yNTUsaSsrO3JldHVybiBzWzYraV09YSxpKysscy5zZXQobiw2K2kpLHMuc2V0KG5ldyBVaW50OEFycmF5KGUpLDYraStyKSxzLmJ1ZmZlcn1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIlNhZmFyaSIpPi0xJiYtMT09PW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikmJihzZWxmLm9ucnRjdHJhbnNmb3JtPW49Pntjb25zdCByPW4udHJhbnNmb3JtZXI7bGV0IG89W107ci5vcHRpb25zLnBvcnQub25tZXNzYWdlPWU9PntlLmRhdGEuc2VpJiZvLnB1c2goZS5kYXRhLnNlaSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBhPXIucmVhZGFibGUuZ2V0UmVhZGVyKCkscz1yLndyaXRhYmxlLmdldFdyaXRlcigpOyJyeCI9PT1yLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2EucmVhZCgpLnRoZW4oKHI9PntpZighci5kb25lKXtpZihyLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7YS5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1vLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>uD.revokeObjectURL(e),0),new Worker(uD.createObjectURL(e))}let n_=new Map,o_=new Map,s_=new Map;async function E9(e,t){if(!Ye().supportWebRTCEncodedTransform)return void S.warning("browser not support video encoded transform");if(s_.has(e)||!e.track)return;let i={track:e.track};if(Ys()){if(!e.createEncodedStreams)return void S.warning("browser not support createEncodedStreams() API");let n=null;try{n=e.createEncodedStreams()}catch(l){return void S.error("create video-encoded-streams error",l&&l.message)}let o=[];t.on("sei-to-send",l=>{o.push(l)});let a=new TransformStream({transform(l,d){i.controller||(i.controller=d),e.track&&e.track.id!==i.track.id&&(S.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r));let u=o.shift();u&&(l.data=function(p,m){let f=function(O){let P=O.length,M=[],V=0;for(;V<P;)V+2<P&&O[V]===0&&O[V+1]===0&&(O[V+2]===0||O[V+2]===1||O[V+2]===2||O[V+2]===3)?(M.push(O[V],O[V+1],3,O[V+2]),V+=3):(M.push(O[V]),V++);return new Uint8Array(M)}(m),E=f.length,I=Math.floor(E/255),T=E%255,R=new Uint8Array(6+I+1+E+p.byteLength);R[0]=0,R[1]=0,R[2]=0,R[3]=1,R[4]=6,R[5]=101;let w=0;for(;w<I;)R[6+w]=255,w++;return R[6+w]=T,w++,R.set(f,6+w),R.set(new Uint8Array(p),6+w+E),R.buffer}(l.data,u)),d.enqueue(l)}});n.readable.pipeThrough(a).pipeTo(n.writable)}else{if(!pi())return;{if(typeof RTCRtpScriptTransform>"u")return void S.warning("browser not support RTCRtpScriptTransform");let n=r_(),o=new MessageChannel;await new ne(l=>n.onmessage=d=>{d.data==="registered"&&l(void 0)});let a=new RTCRtpScriptTransform(n,{name:"tx",port:o.port2},[o.port2]);e.transform=a,await new ne(l=>n.onmessage=d=>{d.data==="started"&&l(void 0)}),t.on("sei-to-send",l=>{o.port1.postMessage({sei:l})}),o.port1.onmessage=l=>{var d;l.data.transformed&&e.track&&((d=e.track)===null||d===void 0?void 0:d.id)!==i.track.id&&(S.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r))},i.worker=n}}function r(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",r)}let n=s_.get(e);if(n){s_.delete(e);try{var o,a;(o=n.controller)===null||o===void 0||o.terminate(),(a=n.worker)===null||a===void 0||a.terminate()}catch(l){S.warning(l&&l.message)}}}s_.set(e,i),e.track.addEventListener("ended",r)}let $u=new Map;async function g9(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Ye().supportWebRTCEncodedTransform)return void S.warning("browser not support video encoded transform");if(!e.track)return;if($u.has(e)){let n=$u.get(e);return void(n&&(n.onSei=t.onSei))}let i={track:e.track,onSei:t.onSei};if(Ys()){if(!e.createEncodedStreams)return void S.warning("browser not support createEncodedStreams() API");let n=null;try{n=e.createEncodedStreams()}catch(a){return void S.error("create video-encoded-streams error",a&&a.message)}let o=new TransformStream({transform(a,l){i.controller||(i.controller=l),e.track&&e.track.id!==i.track.id&&(S.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r));let d=function(u){let p=new DataView(u.data);if(p.getUint8(0)===0&&p.getUint8(1)===0&&p.getUint8(2)===0&&p.getUint8(3)===1&&p.getUint8(4)===6){let m=6,f=0,E=0;for(;(E=p.getUint8(m++))===255;)f+=255;f+=E;let I=function(T,R,w){let O=new Uint8Array(T,R,w),P=[],M=0;for(;M<w;)M+3<w&&O[M]===0&&O[M+1]===0&&O[M+2]===3&&(O[M+3]===0||O[M+3]===1||O[M+3]===2||O[M+3]===3)?(P.push(O[M],O[M+1],O[M+3]),M+=4):(P.push(O[M]),M++);return new Uint8Array(P)}(u.data,m,f);return new Uint8Array(I)}return null}(a);d&&i.onSei&&i.onSei(d),l.enqueue(a)}});n.readable.pipeThrough(o).pipeTo(n.writable)}else if(pi()){if(typeof RTCRtpScriptTransform>"u")return void S.warning("browser not support RTCRtpScriptTransform");let n=r_(),o=new MessageChannel;await new ne(l=>n.onmessage=d=>{d.data==="registered"&&l(void 0)});let a=new RTCRtpScriptTransform(n,{name:"rx",port:o.port2},[o.port2]);e.transform=a,await new ne(l=>n.onmessage=d=>{d.data==="started"&&l(void 0)}),o.port1.onmessage=l=>{var d;l.data.transformed&&e.track&&((d=e.track)===null||d===void 0?void 0:d.id)!==i.track.id?(S.debug("video track changed: ".concat(i.track.id," => ").concat(e.track.id)),i.track.removeEventListener("ended",r),i.track=e.track,i.track.addEventListener("ended",r)):l.data.sei&&i.onSei&&i.onSei(l.data.sei)},i.worker=n}function r(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",r)}(function(n){let o=$u.get(n);if(o){$u.delete(n);try{var a,l;(a=o.controller)===null||a===void 0||a.terminate(),(l=o.worker)===null||l===void 0||l.terminate()}catch(d){S.warning(d&&d.message)}}})(e)}$u.set(e,i),e.track.addEventListener("ended",r)}(function(){let e=Xe();Mi.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),Mi.getStreamFromExtension=e.name===nt.CHROME&&Number(e.version)>34,Mi.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let t=new RTCPeerConnection,i=!1;try{t.addTransceiver("audio"),i=!0}catch{}return t.close(),i}(),Mi.supportMinBitrate=e.name===nt.CHROME||e.name===nt.EDGE,Mi.supportSetRtpSenderParameters=function(){let t=Xe();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!qs()||!(!pi()&&!lm())||t.name===nt.FIREFOX&&Number(t.version)>=64)}(),e.name===nt.SAFARI&&(Number(e.version)>=14?Mi.supportDualStream=!0:Mi.supportDualStream=!1),Mi.webAudioMediaStreamDest=function(){let t=Xe();return!(t.name===nt.SAFARI&&Number(t.version)<12)}(),Mi.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",Mi.supportWebGL=typeof WebGLRenderingContext<"u",Mi.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,qs()||(Mi.webAudioWithAEC=!0),Mi.supportShareAudio=function(){let t=Xe();return(t.os===hi.WIN_10||t.os===hi.WIN_81||t.os===hi.WIN_7||t.os===hi.LINUX||t.os===hi.MAC_OS||t.os===hi.CHROMIUM_OS)&&t.name===nt.CHROME&&Number(t.version)>=74}(),Mi.supportDataChannel=!!(AS(76)||function(t){let i=Xe();return!(i.name!==nt.FIREFOX||!i.osVersion)&&Number(i.version)>=t}(68)||pb(14)),Mi.supportPCSetConfiguration=function(){let t=window.RTCPeerConnection;return!mt()&&!!t&&t.prototype.setConfiguration instanceof Function}(),Mi.supportWebRTCEncodedTransform=function(){let t=Xe();return t.name==="Chrome"&&Number(t.version)>=86||t.name==="Safari"&&Number(t.version)>=15}(),Mi.supportWebRTCInsertableStream=function(){let t=Xe();return(t.name===nt.CHROME||t.name===nt.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),Mi.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,Mi.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,hm(()=>{Mi.supportDualStreamEncoding=function(){let t=Xe();return!!N("DISABLE_WEBAUDIO")||t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&N("CHROME_DUAL_STREAM_USE_ENCODING"))}(),S.info("browser compatibility",JSON.stringify(Mi),JSON.stringify(e))})})();class S9 extends Ot{constructor(){super(...arguments),y(this,"resultStorage",new Map)}setLocalAudioStats(t,i,r){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(r,i)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(r,i))}setLocalVideoStats(t,i,r){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(r,i)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(r,i)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(r))}setRemoteAudioStats(t,i){let r=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",r,this.checkAudioOutputLevel(i))}setRemoteVideoStats(t,i){let r=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",r,this.checkVideoDecode(i))}record(t,i,r){if(N("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});let n=this.resultStorage.get(t);if(n&&(n.result.push(r),n.result.length>=5)){var o;let a=se(o=n.result).call(o,!0);n.isPrevNormal&&!a&&this.emit("exception",iL[t],t,i),!n.isPrevNormal&&a&&this.emit("exception",iL[t]+2e3,t+"_RECOVER",i),n.isPrevNormal=a,n.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,i){return i instanceof ai&&!i.isActive||!!i.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,i){let r=null;i._encoderConfig&&i._encoderConfig.frameRate&&(r=Rr(i._encoderConfig.frameRate));let n=t.captureFrameRate;return!r||!n||!(r>10&&n<5||r<10&&r>=5&&n<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checkSendVideoBitrate(t,i){return!!i.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,i){return i instanceof ai&&!i.isActive||!!i.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}let iL={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},Gi=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){let i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(i.length>0){let r=i[i.length-1];return Math.round(performance.now()-r.startTime)}return 0}measureFromPublishStart(e,t){let i=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(i.length>0){let r=i[i.length-1];return Math.round(performance.now()-r.startTime)}return 0}};function pv(e,t){this.v=e,this.k=t}function Ue(e){return new pv(e,0)}var T9=B0,v9=Uo;Tt({target:"Promise",stat:!0,forced:!0},{withResolvers:function(){var e=v9.f(this);return{promise:e.promise,resolve:e.resolve,reject:e.reject}}});var R9=Uo,C9=al;Tt({target:"Promise",stat:!0,forced:!0},{try:function(e){var t=R9.f(this),i=C9(e);return(i.error?t.reject:t.resolve)(i.value),t.promise}});var mv=g(T9),rL=hl.f("asyncIterator"),y9=g(rL);function eh(e){var t,i;function r(o,a){try{var l=e[o](a),d=l.value,u=d instanceof pv;mv.resolve(u?d.v:d).then(function(p){if(u){var m=o==="return"?"return":"next";if(!d.k||p.done)return r(m,p);p=e[m](p).value}n(l.done?"return":"normal",p)},function(p){r("throw",p)})}catch(p){n("throw",p)}}function n(o,a){switch(o){case"return":t.resolve({value:a,done:!0});break;case"throw":t.reject(a);break;default:t.resolve({value:a,done:!1})}(t=t.next)?r(t.key,t.arg):i=null}this._invoke=function(o,a){return new mv(function(l,d){var u={key:o,arg:a,resolve:l,reject:d,next:null};i?i=i.next=u:(t=i=u,r(o,a))})},typeof e.return!="function"&&(this.return=void 0)}function Vr(e){return function(){return new eh(e.apply(this,arguments))}}eh.prototype[typeof _l=="function"&&y9||"@@asyncIterator"]=function(){return this},eh.prototype.next=function(e){return this._invoke("next",e)},eh.prototype.throw=function(e){return this._invoke("throw",e)},eh.prototype.return=function(e){return this._invoke("return",e)};var nL=g(so.Object.getOwnPropertySymbols),I9=Tt,w9=mE.indexOf,A9=ap,_v=pt([].indexOf),oL=!!_v&&1/_v([1],1,-0)<0;I9({target:"Array",proto:!0,forced:oL||!A9("indexOf")},{indexOf:function(e){var t=arguments.length>1?arguments[1]:void 0;return oL?_v(this,e,t)||0:w9(this,e,t)}});var O9=Pn("Array").indexOf,b9=$,N9=O9,fv=Array.prototype,D9=function(e){var t=e.indexOf;return e===fv||b9(fv,e)&&t===fv.indexOf?N9:t},sL=g(D9);function P9(e,t){if(e==null)return{};var i,r,n=function(a,l){if(a==null)return{};var d,u,p={},m=Qb(a);for(u=0;u<m.length;u++)d=m[u],sL(l).call(l,d)>=0||(p[d]=a[d]);return p}(e,t);if(nL){var o=nL(e);for(r=0;r<o.length;r++)i=o[r],sL(t).call(t,i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}var aL={exports:{}};(function(e,t){e.exports=(()=>{var i={8:(o,a,l)=>{l.r(a),l.d(a,{Parser:()=>Ke,Printer:()=>$n,parse:()=>Pe,print:()=>tt});let d=`
`,u="".concat("\r").concat(d),p=" ",m;function f(oe){return oe>="0"&&oe<="9"}function E(oe){return oe>="!"&&oe<="~"}function I(oe){return E(oe)||oe>=""&&oe<="ÿ"}function T(oe){return oe==="!"||oe>="#"&&oe<="'"||oe>="*"&&oe<="+"||oe>="-"&&oe<="."||oe>="0"&&oe<="9"||oe>="A"&&oe<="Z"||oe>="^"&&oe<="~"}function R(oe){return oe>="1"&&oe<="9"}function w(oe){return oe>="A"&&oe<="Z"||oe>="a"&&oe<="z"}function O(oe){return oe==="d"||oe==="h"||oe==="m"||oe==="s"}function P(oe){return oe>""&&oe<"	"||oe>"\v"&&oe<"\f"||oe>""&&oe<"ÿ"}function M(oe){return w(oe)||f(oe)||oe==="+"||oe==="/"}function V(oe){return f(oe)||w(oe)||oe==="+"||oe==="/"||oe==="-"||oe==="_"}function F(oe){return w(oe)||f(oe)||oe==="+"||oe==="/"}function Y(oe,C){var D=Object.keys(oe);if(Object.getOwnPropertySymbols){var k=Object.getOwnPropertySymbols(oe);C&&(k=k.filter(function(te){return Object.getOwnPropertyDescriptor(oe,te).enumerable})),D.push.apply(D,k)}return D}function J(oe){for(var C=1;C<arguments.length;C++){var D=arguments[C]!=null?arguments[C]:{};C%2?Y(Object(D),!0).forEach(function(k){Z(oe,k,D[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(oe,Object.getOwnPropertyDescriptors(D)):Y(Object(D)).forEach(function(k){Object.defineProperty(oe,k,Object.getOwnPropertyDescriptor(D,k))})}return oe}function Z(oe,C,D){return C in oe?Object.defineProperty(oe,C,{value:D,enumerable:!0,configurable:!0,writable:!0}):oe[C]=D,oe}(function(oe){oe.VERSION="v",oe.ORIGIN="o",oe.SESSION_NAME="s",oe.INFORMATION="i",oe.URI="u",oe.EMAIL="e",oe.PHONE="p",oe.CONNECTION="c",oe.BANDWIDTH="b",oe.TIME="t",oe.REPEAT="r",oe.ZONE_ADJUSTMENTS="z",oe.KEY="k",oe.ATTRIBUTE="a",oe.MEDIA="m"})(m||(m={}));class pe{consumeText(C,D){let k=D;for(;k<C.length;){let te=C[k];if(te==="\0"||te==="\r"||te===d)break;k+=1}if(k-D==0)throw new Error("Invalid text, at ".concat(C));return k}consumeUnicastAddress(C,D,k){return this.consumeTill(C,D,p)}consumeOneOrMore(C,D,k){let te=D;for(;k(C[te]);)te++;if(te-D==0)throw new Error("Invalid rule at ".concat(D,"."));return te}consumeSpace(C,D){if(C[D]===p)return D+1;throw new Error("Invalid space at ".concat(D,"."))}consumeIP4Address(C,D){let k=D;for(let te=0;te<4;te++)if(k=this.consumeDecimalUChar(C,k),te!==3){if(C[k]!==".")throw new Error("Invalid IP4 address.");k++}return k}consumeDecimalUChar(C,D){let k=D;for(let be=0;be<3&&f(C[k]);be++,k++);if(k-D==0)throw new Error("Invalid decimal uchar.");let te=parseInt(C.slice(D,k));if(te>=0&&te<=255)return k;throw new Error("Invalid decimal uchar")}consumeIP6Address(C,D){let k=this.consumeHexpart(C,D);return C[k]===":"&&(k+=1,k=this.consumeIP4Address(C,k)),k}consumeHexpart(C,D){let k=D;if(C[k]===":"&&C[k+1]===":"){k+=2;try{k=this.consumeHexseq(C,k)}catch{}return k}if(k=this.consumeHexseq(C,k),C[k]===":"&&C[k+1]===":"){k+=2;try{k=this.consumeHexseq(C,k)}catch{}return k}return k}consumeHexseq(C,D){let k=D;for(;k=this.consumeHex4(C,k),C[k]===":"&&C[k+1]!==":";)k+=1;return k}consumeHex4(C,D){let k=0;for(;k<4;k++)if(!((te=C[D+k])>="0"&&te<="9"||te>="a"&&te<="f"||te>="A"&&te<="F")){if(k===0)throw new Error("Invalid hex 4");break}var te;return D+k}consumeFQDN(C,D){let k=D;for(;f(C[k])||w(C[k])||C[k]==="-"||C[k]===".";)k+=1;if(k-D<4)throw new Error("Invalid FQDN");return k}consumeExtnAddr(C,D){return this.consumeOneOrMore(C,D,I)}consumeMulticastAddress(C,D,k){switch(k){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(C,D);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(C,D);default:try{return this.consumeFQDN(C,D)}catch{return this.consumeExtnAddr(C,D)}}}consumeIP6MulticastAddress(C,D){let k=this.consumeHexpart(C,D);return C[k]==="/"?this.consumeInteger(C,k+1):k}consumeIP4MulticastAddress(C,D){let k=D+3,te=C.slice(D,k),be=parseInt(te);if(be<224||be>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let St=0;St<3;St++){if(C[k]!==".")throw new Error("Invalid IP4 multicast address.");k+=1,k=this.consumeDecimalUChar(C,k)}return C[k]==="/"&&(k+=1),k=this.consumeTTL(C,k),C[k]==="/"&&(k=this.consumeInteger(C,k)),k}consumeInteger(C,D){if(!R(C[D]))throw new Error("Invalid integer.");for(D+=1;f(C[D]);)D+=1;return D}consumeTTL(C,D){if(C[D]==="0")return D+1;if(!R(C[D]))throw new Error("Invalid TTL.");D+=1;for(let k=0;k<2&&f(C[D]);k++)D+=1;return D}consumeToken(C,D){return this.consumeOneOrMore(C,D,T)}consumeTime(C,D){let k=D;if(C[k]==="0")return k+1;for(R(C[k])&&(k+=1);f(C[k]);)k++;if(k-D<10)throw new Error("Invalid time");return k}consumeAddress(C,D){return this.consumeTill(C,D,p)}consumeTypedTime(C,D){let k=D;return k=this.consumeOneOrMore(C,k,f),O(C[k])?k+1:k}consumeRepeatInterval(C,D){if(!R(C[D]))throw new Error("Invalid repeat interval");for(D+=1;f(C[D]);)D+=1;return O(C[D])&&(D+=1),D}consumePort(C,D){return this.consumeOneOrMore(C,D,f)}consume(C,D,k){for(let te=0;te<k.length;te++){if(D+te>=C.length)throw new Error("consume exceeding value length");if(C[D+te]!==k[te])throw new Error("consume ".concat(k," failed at ").concat(te))}return D+k.length}consumeTill(C,D,k){let te=D;for(;te<C.length&&(typeof k!="string"||C[te]!==k)&&(typeof k!="function"||!k(C[te]));)te++;return te}}class Ke extends pe{constructor(){super(),Z(this,"records",[]),Z(this,"currentLine",0)}parse(C){let D=this.probeEOL(C);this.records=C.split(D).filter(ni=>!!qi(ni).call(ni)).map(this.parseLine),this.currentLine=0;let k=this.parseVersion(),te=this.parseOrigin(),be=this.parseSessionName(),St=this.parseInformation(),li=this.parseUri(),wr=this.parseEmail(),ys=this.parsePhone(),N_=this.parseConnection(),D_=this.parseBandWidth(),Cn=this.parseTimeFields(),Sa=this.parseKey(),ld=this.parseSessionAttribute(),zt=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:k,origin:te,sessionName:be,information:St,uri:li,emails:wr,phones:ys,connection:N_,bandwidths:D_,timeFields:Cn,key:Sa,attributes:ld,mediaDescriptions:zt}}getCurrentRecord(){let C=this.records[this.currentLine];if(!C)throw new Error("Record doesn't exit.");return C}probeEOL(C){for(let D=0;D<C.length;D++)if(C[D]===d)return C[D-1]==="\r"?u:d;throw new Error("Invalid newline character.")}parseLine(C,D){if(C.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");let k=C[0];if(C[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:k,value:C.slice(2),line:D,cur:0}}parseSessionAttribute(){let C=new Ct;for(;this.currentLine<this.records.length;){let D=this.getCurrentRecord();if(D.type!==m.ATTRIBUTE)break;let k={attField:this.extractOneOrMore(D,te=>T(te)&&te!==":"),_cur:0};D.value[D.cur]===":"&&(D.cur+=1,k.attValue=this.extractOneOrMore(D,P)),C.parse(k),this.currentLine++}return C.digest()}parseMediaAttributes(C){let D=new Zt(C);for(;this.currentLine<this.records.length;){let k=this.getCurrentRecord();if(k.type!==m.ATTRIBUTE)break;let te={attField:this.extractOneOrMore(k,be=>T(be)&&be!==":"),_cur:0};k.value[k.cur]===":"&&(k.cur+=1,te.attValue=this.extractOneOrMore(k,P)),D.parse(te),this.currentLine++}return D.digest()}parseKey(){let C=this.getCurrentRecord();if(C.type===m.KEY){if(C.value==="prompt"||C.value==="clear:"||C.value==="base64:"||C.value==="uri:")return C.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){let C=this.getCurrentRecord();if(C.type===m.ZONE_ADJUSTMENTS){let D=[];for(;;)try{let k=this.extract(C,this.consumeTime);this.consumeSpaceForRecord(C);let te=!1;C.value[C.cur]==="-"&&(te=!0,C.cur+=1);let be=this.extract(C,this.consumeTypedTime);D.push({time:k,typedTime:be,back:te})}catch{break}if(D.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,D}return[]}parseRepeat(){let C=[];for(;;){let D=this.getCurrentRecord();if(D.type!==m.REPEAT)break;{let k=this.extract(D,this.consumeRepeatInterval),te=this.parseTypedTime(D);C.push({repeatInterval:k,typedTimes:te}),this.currentLine++}}return C}parseTypedTime(C){let D=[];for(;;)try{this.consumeSpaceForRecord(C),D.push(this.extract(C,this.consumeTypedTime))}catch{break}if(D.length===0)throw new Error("Invalid typed time.");return D}parseTime(){let C=this.getCurrentRecord(),D=this.extract(C,this.consumeTime);this.consumeSpaceForRecord(C);let k=this.extract(C,this.consumeTime);return this.currentLine++,{startTime:D,stopTime:k}}parseBandWidth(){let C=[];for(;this.currentLine<this.records.length;){let D=this.getCurrentRecord();if(D.type!==m.BANDWIDTH)break;{let k=this.extractOneOrMore(D,T);if(D.value[D.cur]!==":")throw new Error("Invalid bandwidth field.");D.cur++;let te=this.extractOneOrMore(D,f);C.push({bwtype:k,bandwidth:te}),this.currentLine++}}return C}parseVersion(){let C=this.getCurrentRecord();if(C.type!==m.VERSION)throw new Error("first sdp record must be version");let D=C.value.slice(0,this.consumeOneOrMore(C.value,0,f));if(D.length!==C.value.length)throw new Error('invalid proto version, "v='.concat(C.value,'"'));return this.currentLine++,D}parseOrigin(){let C=this.getCurrentRecord();if(C.type!==m.ORIGIN)throw new Error("second line of sdp must be origin");let D=this.extractOneOrMore(C,I);this.consumeSpaceForRecord(C);let k=this.extractOneOrMore(C,f);this.consumeSpaceForRecord(C);let te=this.extractOneOrMore(C,f);this.consumeSpaceForRecord(C);let be=this.extractOneOrMore(C,T);this.consumeSpaceForRecord(C);let St=this.extractOneOrMore(C,T);this.consumeSpaceForRecord(C);let li=this.extract(C,this.consumeUnicastAddress);return this.currentLine++,{username:D,sessId:k,sessVersion:te,nettype:be,addrtype:St,unicastAddress:li}}parseSessionName(){let C=this.getCurrentRecord();if(C.type===m.SESSION_NAME){let D=this.extract(C,this.consumeText);return this.currentLine++,D}}parseInformation(){let C=this.getCurrentRecord();if(C.type!==m.INFORMATION)return;let D=this.extract(C,this.consumeText);return this.currentLine++,D}parseUri(){let C=this.getCurrentRecord();if(C.type===m.URI)return this.currentLine++,C.value}parseEmail(){let C=[];for(;;){let D=this.getCurrentRecord();if(D.type!==m.EMAIL)break;C.push(D.value),this.currentLine++}return C}parsePhone(){let C=[];for(;;){let D=this.getCurrentRecord();if(D.type!==m.PHONE)break;C.push(D.value),this.currentLine++}return C}parseConnection(){let C=this.getCurrentRecord();if(C.type===m.CONNECTION){let D=this.extractOneOrMore(C,T);this.consumeSpaceForRecord(C);let k=this.extractOneOrMore(C,T);this.consumeSpaceForRecord(C);let te=this.extract(C,this.consumeAddress);return this.currentLine++,{nettype:D,addrtype:k,address:te}}}parseMedia(){let C=this.getCurrentRecord(),D=this.extract(C,this.consumeToken);this.consumeSpaceForRecord(C);let k=this.extract(C,this.consumePort);C.value[C.cur]==="/"&&(C.cur+=1,k+=this.extract(C,this.consumeInteger)),this.consumeSpaceForRecord(C);let te=[];for(te.push(this.extract(C,this.consumeToken));C.value[C.cur]==="/";)C.cur+=1,te.push(this.extract(C,this.consumeToken));if(te.length===0)throw new Error("Invalid proto");let be=this.parseFmt(C);return this.currentLine++,{mediaType:D,port:k,protos:te,fmts:be}}parseTimeFields(){let C=[];for(;this.getCurrentRecord().type===m.TIME;){let D=this.parseTime(),k=this.parseRepeat(),te=this.parseZone();C.push({time:D,repeats:k,zones:te})}return C}parseMediaDescription(){let C=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===m.MEDIA;){let D=this.parseMedia(),k=this.parseInformation(),te=this.parseConnections(),be=this.parseBandWidth(),St=this.parseKey(),li=this.parseMediaAttributes(D);C.push({media:D,information:k,connections:te,bandwidths:be,key:St,attributes:li})}return C}parseConnections(){let C=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===m.CONNECTION;)C.push(this.parseConnection());return C}parseFmt(C){let D=[];for(;;)try{this.consumeSpaceForRecord(C),D.push(this.extract(C,this.consumeToken))}catch{break}if(D.length===0)throw new Error("Invalid fmts");return D}extract(C,D){for(var k=arguments.length,te=new Array(k>2?k-2:0),be=2;be<k;be++)te[be-2]=arguments[be];let St=D.call(this,C.value,C.cur,...te),li=C.value.slice(C.cur,St);return C.cur=St,li}extractOneOrMore(C,D){let k=this.consumeOneOrMore(C.value,C.cur,D),te=C.value.slice(C.cur,k);return C.cur=k,te}consumeSpaceForRecord(C){if(C.value[C.cur]!==p)throw new Error("Invalid space at ".concat(C.cur,"."));C.cur+=1}}class rt extends pe{constructor(){super(...arguments),Z(this,"attributes",void 0),Z(this,"digested",!1)}extractOneOrMore(C,D,k){let te=this.consumeOneOrMore(C.attValue,C._cur,D),be=C.attValue.slice(C._cur,te),[St,li]=k||[];if(typeof St=="number"&&be.length<St)throw new Error("error in length, should be more or equal than ".concat(St," characters."));if(typeof li=="number"&&be.length>li)throw new Error("error in length, should be less or equal than ".concat(li," characters."));return C._cur=te,be}consumeAttributeSpace(C){if(C.attValue[C._cur]!==p)throw new Error("Invalid space at ".concat(C._cur,"."));C._cur+=1}extract(C,D){if(!C.attValue)throw new Error("Nothing to extract from attValue.");for(var k=arguments.length,te=new Array(k>2?k-2:0),be=2;be<k;be++)te[be-2]=arguments[be];let St=D.call(this,C.attValue,C._cur,...te),li=C.attValue.slice(C._cur,St);return C._cur=St,li}atEnd(C){if(!C.attValue)throw new Error;return C._cur>=C.attValue.length}peekChar(C){if(!C.attValue)throw new Error;return C.attValue[C._cur]}peek(C,D){if(!C.attValue)throw new Error;for(let k=0;k<D.length;k++)if(D[k]!==C.attValue[C._cur+k])return!1;return!0}parseIceUfrag(C){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(C,M,[4,256])}parseIcePwd(C){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(C,M,[22,256])}parseIceOptions(C){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");let D=[];for(;!this.atEnd(C);){D.push(this.extractOneOrMore(C,M));try{this.consumeAttributeSpace(C)}catch(k){if(this.atEnd(C))break;throw k}}this.attributes.iceOptions=D}parseFingerprint(C){let D=this.extract(C,this.consumeToken);this.consumeAttributeSpace(C);let k=this.extract(C,this.consumeTill);this.attributes.fingerprints.push({hashFunction:D,fingerprint:k})}parseExtmap(C){let D=this.extractOneOrMore(C,f),k;this.peekChar(C)==="/"&&(this.extract(C,this.consume,"/"),k=this.extract(C,this.consumeToken)),this.consumeAttributeSpace(C);let te=this.extract(C,this.consumeTill,p),be=J(J({entry:parseInt(D,10)},k&&{direction:k}),{},{extensionName:te});this.peekChar(C)===p&&(this.consumeAttributeSpace(C),be.extensionAttributes=this.extract(C,this.consumeTill)),this.attributes.extmaps.push(be)}parseSetup(C){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");let D=this.extract(C,this.consumeTill);if(D!=="active"&&D!=="passive"&&D!=="actpass"&&D!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=D}}class Ct extends rt{constructor(){super(...arguments),Z(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(C){if(this.digested)throw new Error("already digested");try{switch(C.attField){case"group":this.parseGroup(C);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(C);break;case"ice-pwd":this.parseIcePwd(C);break;case"ice-options":this.parseIceOptions(C);break;case"fingerprint":this.parseFingerprint(C);break;case"setup":this.parseSetup(C);break;case"tls-id":this.parseTlsId(C);break;case"identity":this.parseIdentity(C);break;case"extmap":this.parseExtmap(C);break;case"msid-semantic":this.parseMsidSemantic(C);break;default:C.ignored=!0,this.attributes.unrecognized.push(C)}}catch(D){throw console.error("parsing session attribute ".concat(C.attField,' error, "a=').concat(C.attField,":").concat(C.attValue,'"')),D}if(!C.ignored&&C.attValue&&!this.atEnd(C))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(C){let D=this.extract(C,this.consumeToken),k=[];for(;!this.atEnd(C)&&this.peekChar(C)===p;)this.consumeAttributeSpace(C),k.push(this.extract(C,this.consumeToken));this.attributes.groups.push({semantic:D,identificationTag:k})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(C){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(C,V)}parseIdentity(C){let D=this.extractOneOrMore(C,F),k=[];for(;!this.atEnd(C)&&this.peekChar(C)===p;){this.consumeAttributeSpace(C);let te=this.extract(C,this.consumeToken);this.extract(C,this.consume,"=");let be=this.extractOneOrMore(C,St=>St!==p&&P(St));k.push({name:te,value:be})}this.attributes.identities.push({assertionValue:D,extensions:k})}parseMsidSemantic(C){this.peekChar(C)===p&&this.consumeAttributeSpace(C);let D={semantic:this.extract(C,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(C)}catch{break}if(this.peekChar(C)==="*"){this.extract(C,this.consume,"*"),D.applyForAll=!0;break}{let k=this.extract(C,this.consumeTill,p);D.identifierList.push(k)}}this.attributes.msidSemantic=D}}class Zt extends rt{constructor(C){super(),Z(this,"attributes",void 0),C.protos.indexOf("RTP")!==-1||C.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(C){if(this.digested)throw new Error("already digested");try{switch(C.attField){case"extmap":this.parseExtmap(C);break;case"setup":this.parseSetup(C);break;case"ice-ufrag":this.parseIceUfrag(C);break;case"ice-pwd":this.parseIcePwd(C);break;case"ice-options":this.parseIceOptions(C);break;case"candidate":this.parseCandidate(C);break;case"remote-candidate":this.parseRemoteCandidate(C);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(C);break;case"rtpmap":this.parseRtpmap(C);break;case"ptime":this.parsePtime(C);break;case"maxptime":this.parseMaxPtime(C);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(C);break;case"ssrc":this.parseSSRC(C);break;case"fmtp":this.parseFmtp(C);break;case"rtcp-fb":this.parseRtcpFb(C);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(C);break;case"mid":this.parseMid(C);break;case"msid":this.parseMsid(C);break;case"imageattr":this.parseImageAttr(C);break;case"rid":this.parseRid(C);break;case"simulcast":this.parseSimulcast(C);break;case"sctp-port":this.parseSctpPort(C);break;case"max-message-size":this.parseMaxMessageSize(C);break;case"ssrc-group":this.parseSSRCGroup(C);break;default:C.ignored=!0,this.attributes.unrecognized.push(C)}}catch(D){throw console.error("parsing media attribute ".concat(C.attField,' error, "a=').concat(C.attField,":").concat(C.attValue,'"')),D}if(!C.ignored&&C.attValue&&!this.atEnd(C))throw new Error("attribute parsing error")}parseCandidate(C){let D=this.extractOneOrMore(C,M,[1,32]);this.consumeAttributeSpace(C);let k=this.extractOneOrMore(C,f,[1,5]);this.consumeAttributeSpace(C);let te=this.extract(C,this.consumeToken);this.consumeAttributeSpace(C);let be=this.extractOneOrMore(C,f,[1,10]);this.consumeAttributeSpace(C);let St=this.extract(C,this.consumeAddress);this.consumeAttributeSpace(C);let li=this.extract(C,this.consumePort);this.consumeAttributeSpace(C),this.extract(C,this.consume,"typ"),this.consumeAttributeSpace(C);let wr={foundation:D,componentId:k,transport:te,priority:be,connectionAddress:St,port:li,type:this.extract(C,this.consumeToken),extension:{}};for(this.peek(C," raddr")&&(this.extract(C,this.consume," raddr"),this.consumeAttributeSpace(C),wr.relAddr=this.extract(C,this.consumeAddress)),this.peek(C," rport")&&(this.extract(C,this.consume," rport"),this.consumeAttributeSpace(C),wr.relPort=this.extract(C,this.consumePort));this.peekChar(C)===p;){this.consumeAttributeSpace(C);let ys=this.extract(C,this.consumeToken);this.consumeAttributeSpace(C),wr.extension[ys]=this.extractOneOrMore(C,E)}this.attributes.candidates.push(wr)}parseRemoteCandidate(C){let D=[];for(;;){let k=this.extractOneOrMore(C,f,[1,5]);this.consumeAttributeSpace(C);let te=this.extract(C,this.consumeAddress);this.consumeAttributeSpace(C);let be=this.extract(C,this.consumePort);D.push({componentId:k,connectionAddress:te,port:be});try{this.consumeAttributeSpace(C)}catch{break}}this.attributes.remoteCandidatesList.push(D)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(C){let D=this.extract(C,this.consumeToken);this.consumeAttributeSpace(C);let k=this.extract(C,this.consumeTill,"/");this.extract(C,this.consume,"/");let te={encodingName:k,clockRate:this.extractOneOrMore(C,f)};this.atEnd(C)||this.peekChar(C)!=="/"||(this.extract(C,this.consume,"/"),te.encodingParameters=parseInt(this.extract(C,this.consumeTill),10));let be=this.attributes.payloads.find(St=>St.payloadType===parseInt(D,10));be?be.rtpMap=te:this.attributes.payloads.push({payloadType:parseInt(D,10),rtpMap:te,rtcpFeedbacks:[]})}parsePtime(C){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(C,this.consumeTill)}parseMaxPtime(C){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(C,this.consumeTill)}parseDirection(C){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=C.attField}parseSSRC(C){let D=this.extractOneOrMore(C,f);this.consumeAttributeSpace(C);let k=this.extract(C,this.consumeTill,":"),te;this.peekChar(C)===":"&&(this.extract(C,this.consume,":"),te=this.extract(C,this.consumeTill));let be=this.attributes.ssrcs.find(St=>St.ssrcId===parseInt(D,10));be?be.attributes[k]=te:this.attributes.ssrcs.push({ssrcId:parseInt(D,10),attributes:{[k]:te}})}parseFmtp(C){let D=this.extract(C,this.consumeTill,p);this.consumeAttributeSpace(C);let k=this.extract(C,this.consumeTill),te={};k.split(";").forEach(St=>{let[li,wr]=St.split("=");li=qi(li).call(li);let ys=typeof wr=="string"?qi(wr).call(wr):null;typeof li=="string"&&li.length>0&&(te[li]=ys)});let be=this.attributes.payloads.find(St=>St.payloadType===parseInt(D,10));be?be.fmtp={parameters:te}:this.attributes.payloads.push({payloadType:parseInt(D,10),rtcpFeedbacks:[],fmtp:{parameters:te}})}parseFmtParameters(C){let D={},k=this.extract(C,this.consumeTill,"=");C._cur++;let te=this.extract(C,this.consumeTill,";");for(D[k]=te;C.attValue[C._cur]===";";){let be=this.extract(C,this.consumeTill,"=");C._cur++;let St=this.extract(C,this.consumeTill,";");D[be]=St}return D}parseRtcpFb(C){let D="";D=this.peekChar(C)==="*"?this.extract(C,this.consume,"*"):this.extract(C,this.consumeTill,p),this.consumeAttributeSpace(C);let k=this.extract(C,this.consumeTill,p),te;if(k==="trr-int")te={type:k,interval:this.extract(C,this.consumeTill)};else{let be={type:k};this.peekChar(C)===p&&(this.consumeAttributeSpace(C),be.parameter=this.extract(C,this.consumeToken),this.peekChar(C)===p&&(be.additional=this.extract(C,this.consumeTill))),te=be}if(D==="*")this.attributes.rtcpFeedbackWildcards.push(te);else{let be=this.attributes.payloads.find(St=>St.payloadType===parseInt(D,10));be?be.rtcpFeedbacks.push(te):this.attributes.payloads.push({payloadType:parseInt(D,10),rtcpFeedbacks:[te]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(C){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");let D={port:this.extract(C,this.consumePort)};this.peekChar(C)===p&&(this.consumeAttributeSpace(C),D.netType=this.extractOneOrMore(C,T),this.consumeAttributeSpace(C),D.addressType=this.extractOneOrMore(C,T),this.consumeAttributeSpace(C),D.address=this.extract(C,this.consumeAddress)),this.attributes.rtcp=D}parseMsid(C){let D={id:this.extractOneOrMore(C,T,[1,64])};this.peekChar(C)===p&&(this.consumeAttributeSpace(C),D.appdata=this.extractOneOrMore(C,T,[1,64])),this.attributes.msids.push(D)}parseImageAttr(C){this.attributes.imageattr.push(C.attValue)}parseRid(C){let D=this.extractOneOrMore(C,te=>w(te)||f(te)||te==="_"||te==="-");this.consumeAttributeSpace(C);let k={id:D,direction:this.extract(C,this.consumeToken),params:[]};if(this.peekChar(C)===p){if(this.consumeAttributeSpace(C),this.peek(C,"pt=")){this.extract(C,this.consume,"pt=");let te=[];for(;;){let be=this.extract(C,this.consumeToken);te.push(be);try{this.extract(C,this.consume,",")}catch{break}}k.payloads=te,this.peekChar(C)===p&&this.extract(C,this.consume,p)}for(;;){let te=this.extract(C,this.consumeToken);switch(te){case"depend":{let be={type:te,rids:this.extract(C,this.consume,"=").split(",")};k.params.push(be);break}default:{let be={type:te};this.peekChar(C)==="="&&(this.extract(C,this.consume,"="),be.val=this.extract(C,this.consumeTill,";")),k.params.push(be)}}try{this.extract(C,this.consume,";")}catch{break}}}this.attributes.rids.push(k)}parseSimulcast(C){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=C.attValue,this.extract(C,this.consumeTill)}parseSctpPort(C){this.attributes.sctpPort=this.extractOneOrMore(C,f,[1,5])}parseMaxMessageSize(C){this.attributes.maxMessageSize=this.extractOneOrMore(C,f,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(C){this.attributes.mid=this.extract(C,this.consumeToken)}parseSSRCGroup(C){let D=this.extract(C,this.consumeToken),k=[];for(;;)try{this.consumeAttributeSpace(C);let te=this.extract(C,this.consumeInteger);k.push(parseInt(te,10))}catch{break}this.attributes.ssrcGroups.push({semantic:D,ssrcIds:k})}}function Mt(oe,C,D){return C in oe?Object.defineProperty(oe,C,{value:D,enumerable:!0,configurable:!0,writable:!0}):oe[C]=D,oe}class $n{constructor(){Mt(this,"eol",u)}print(C,D){let k="";return D&&(this.eol=D),k+=this.printVersion(C.version),k+=this.printOrigin(C.origin),k+=this.printSessionName(C.sessionName),k+=this.printInformation(C.information),k+=this.printUri(C.uri),k+=this.printEmail(C.emails),k+=this.printPhone(C.phones),k+=this.printConnection(C.connection),k+=this.printBandwidth(C.bandwidths),k+=this.printTimeFields(C.timeFields),k+=this.printKey(C.key),k+=this.printSessionAttributes(C.attributes),k+=this.printMediaDescription(C.mediaDescriptions),k}printVersion(C){return"v=".concat(C).concat(this.eol)}printOrigin(C){return"o=".concat(C.username," ").concat(C.sessId," ").concat(C.sessVersion," ").concat(C.nettype," ").concat(C.addrtype," ").concat(C.unicastAddress).concat(this.eol)}printSessionName(C){return C?"s=".concat(C).concat(this.eol):""}printInformation(C){return C?"i=".concat(C).concat(this.eol):""}printUri(C){return C?"u=".concat(C).concat(this.eol):""}printEmail(C){let D="";for(let k of C)D+="e=".concat(k).concat(this.eol);return D}printPhone(C){let D="";for(let k of C)D+="e=".concat(k).concat(this.eol);return D}printConnection(C){return C?"c=".concat(C.nettype," ").concat(C.addrtype," ").concat(C.address).concat(this.eol):""}printBandwidth(C){let D="";for(let k of C)D+="b=".concat(k.bwtype,":").concat(k.bandwidth).concat(this.eol);return D}printTimeFields(C){let D="";for(let k of C){D+="t=".concat(k.time.startTime," ").concat(k.time.startTime).concat(this.eol);for(let te of k.repeats)D+="r=".concat(te.repeatInterval," ").concat(te.typedTimes.join(" ")).concat(this.eol);k.zoneAdjustments&&(D+="z=",D+="z=".concat(k.zoneAdjustments.map(te=>"".concat(te.time," ").concat(te.back?"-":""," ").concat(te.typedTime)).join(" ")).concat(this.eol),D+=this.eol)}return D}printKey(C){return C?"k=".concat(C).concat(this.eol):""}printAttributes(C){let D="";for(let k of C)D+="a=".concat(k.attField).concat(k.attValue?":".concat(k.attValue):"").concat(this.eol);return D}printMediaDescription(C){let D="";for(let k of C)D+=this.printMedia(k.media),D+=this.printInformation(k.information),D+=this.printConnections(k.connections),D+=this.printBandwidth(k.bandwidths),D+=this.printKey(k.key),D+=this.printMediaAttributes(k);return D}printConnections(C){let D="";for(let k of C)D+=this.printConnection(k);return D}printMedia(C){return"m=".concat(C.mediaType," ").concat(C.port," ").concat(C.protos.join("/")," ").concat(C.fmts.join(" ")).concat(this.eol)}printSessionAttributes(C){return new re(this.eol).print(C)}printMediaAttributes(C){return new he(this.eol).print(C)}}class z{constructor(C){Mt(this,"eol",void 0),this.eol=C}printIceUfrag(C){return C===void 0?"":"a=ice-ufrag:".concat(C).concat(this.eol)}printIcePwd(C){return C===void 0?"":"a=ice-pwd:".concat(C).concat(this.eol)}printIceOptions(C){return C===void 0?"":"a=ice-options:".concat(C.join(p)).concat(this.eol)}printFingerprints(C){return C.length>0?C.map(D=>"a=fingerprint:".concat(D.hashFunction).concat(p).concat(D.fingerprint)).join(this.eol)+this.eol:""}printExtmap(C){return C.map(D=>"a=extmap:".concat(D.entry).concat(D.direction?"/".concat(D.direction):"").concat(p).concat(D.extensionName).concat(D.extensionAttributes?"".concat(p).concat(D.extensionAttributes):"").concat(this.eol)).join("")}printSetup(C){return C===void 0?"":"a=setup:".concat(C).concat(this.eol)}printUnrecognized(C){return C.map(D=>"a=".concat(D.attField).concat(D.attValue?":".concat(D.attValue):"").concat(this.eol)).join("")}}class re extends z{print(C){let D="";return D+=this.printGroups(C.groups),D+=this.printMsidSemantic(C.msidSemantic),D+=this.printIceLite(C.iceLite),D+=this.printIceUfrag(C.iceUfrag),D+=this.printIcePwd(C.icePwd),D+=this.printIceOptions(C.iceOptions),D+=this.printFingerprints(C.fingerprints),D+=this.printSetup(C.setup),D+=this.printTlsId(C.tlsId),D+=this.printIdentity(C.identities),D+=this.printExtmap(C.extmaps),D+=this.printUnrecognized(C.unrecognized),D}printGroups(C){let D="";return C.length>0&&(D+=C.map(k=>"a=group:".concat(k.semantic).concat(k.identificationTag.map(te=>"".concat(p).concat(te)).join("")).concat(this.eol)).join("")),D}printIceLite(C){return C===void 0?"":"a=ice-lite"+this.eol}printTlsId(C){return C?"a=tls-id:".concat(C).concat(this.eol):""}printIdentity(C){return C.length===0?"":C.map(D=>"a=identity:".concat(D.assertionValue).concat(D.extensions.map(k=>"".concat(p).concat(k.name).concat(k.value?"=".concat(k.value):"")))).join(this.eol)+this.eol}printMsidSemantic(C){if(!C)return"";let D="a=msid-semantic:".concat(C.semantic);return C.applyForAll?D+="".concat(p,"*"):C.identifierList.length>0&&(D+=C.identifierList.map(k=>"".concat(p).concat(k))),D+this.eol}}class he extends z{print(C){let D=C.attributes,k="";return k+=this.printRTCP(D.rtcp),k+=this.printIceUfrag(D.iceUfrag),k+=this.printIcePwd(D.icePwd),k+=this.printIceOptions(D.iceOptions),k+=this.printCandidates(D.candidates),k+=this.printRemoteCandidatesList(D.remoteCandidatesList),k+=this.printEndOfCandidates(D.endOfCandidates),k+=this.printFingerprints(D.fingerprints),k+=this.printSetup(D.setup),k+=this.printMid(D.mid),k+=this.printExtmap(D.extmaps),k+=this.printRTPRelated(D),k+=this.printPtime(D.ptime),k+=this.printMaxPtime(D.maxPtime),k+=this.printDirection(D.direction),k+=this.printSSRCGroups(D.ssrcGroups),k+=this.printSSRC(D.ssrcs),k+=this.printRTCPMux(D.rtcpMux),k+=this.printRTCPMuxOnly(D.rtcpMuxOnly),k+=this.printRTCPRsize(D.rtcpRsize),k+=this.printMSId(D.msids),k+=this.printImageattr(D.imageattr),k+=this.printRid(D.rids),k+=this.printSimulcast(D.simulcast),k+=this.printSCTPPort(D.sctpPort),k+=this.printMaxMessageSize(D.maxMessageSize),k+=this.printUnrecognized(D.unrecognized),k}printCandidates(C){return C.map(D=>"a=candidate:".concat(D.foundation).concat(p).concat(D.componentId).concat(p).concat(D.transport).concat(p).concat(D.priority).concat(p).concat(D.connectionAddress).concat(p).concat(D.port).concat(p,"typ").concat(p).concat(D.type).concat(D.relAddr?"".concat(p,"raddr").concat(p).concat(D.relAddr):"").concat(D.relPort?"".concat(p,"rport").concat(p).concat(D.relPort):"").concat(Object.keys(D.extension).map(k=>"".concat(p).concat(k).concat(p).concat(D.extension[k])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(C){return C.map(D=>"a=remote-candidates:".concat(D.join(p)).concat(this.eol)).join("")}printEndOfCandidates(C){return C===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(C){if(!C.payloads)return"";let D=C.payloads,k="";k+=C.rtcpFeedbackWildcards.map(te=>this.printRTCPFeedback("*",te)).join("");for(let te of D)k+=this.printRtpMap(te.payloadType,te.rtpMap),k+=this.printFmtp(te.payloadType,te.fmtp),k+=te.rtcpFeedbacks.map(be=>this.printRTCPFeedback(te.payloadType,be)).join("");return k}printFmtp(C,D){if(!D)return"";let k=Object.keys(D.parameters);return k.length===1&&D.parameters[k[0]]===null?"a=fmtp:".concat(C).concat(p).concat(k[0]).concat(this.eol):"a=fmtp:".concat(C).concat(p).concat(Object.keys(D.parameters).map(te=>"".concat(te,"=").concat(D.parameters[te])).join(";")).concat(this.eol)}printRtpMap(C,D){return D?"a=rtpmap:".concat(C).concat(p).concat(D.encodingName,"/").concat(D.clockRate).concat(D.encodingParameters?"/".concat(D.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(C,D){let k="a=rtcp-fb:".concat(C).concat(p),te=D;return te.type==="trr-int"?k+="ttr-int".concat(p).concat(te.interval):(k+="".concat(te.type),te.parameter&&(k+="".concat(p).concat(te.parameter),te.additional&&(k+="".concat(p).concat(te.additional)))),k+this.eol}printPtime(C){return C===void 0?"":"a=ptime:".concat(C).concat(this.eol)}printMaxPtime(C){return C===void 0?"":"a=maxptime:".concat(C).concat(this.eol)}printDirection(C){return C===void 0?"":"a=".concat(C).concat(this.eol)}printSSRC(C){return C.map(D=>Object.keys(D.attributes).map(k=>"a=ssrc:".concat(D.ssrcId.toString(10)).concat(p).concat(k).concat(D.attributes[k]?":".concat(D.attributes[k]):"").concat(this.eol)).join("")).join("")}printRTCPMux(C){return C===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(C){return C===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(C){return C===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(C){if(C===void 0)return"";let D="a=rtcp:".concat(C.port);return C.netType&&(D+="".concat(p).concat(C.netType)),C.addressType&&(D+="".concat(p).concat(C.addressType)),C.address&&(D+="".concat(p).concat(C.address)),D+this.eol}printMSId(C){return C.map(D=>"a=msid:".concat(D.id).concat(D.appdata?"".concat(p).concat(D.appdata):"").concat(this.eol)).join("")}printImageattr(C){return C.map(D=>"a=imageattr:".concat(D).concat(this.eol)).join("")}printRid(C){return C.map(D=>{let k="a=rid:".concat(D.id).concat(p).concat(D.direction);return D.payloads&&(k+="".concat(p,"pt=").concat(D.payloads.join(","))),D.params.length>0&&(k+="".concat(p).concat(D.params.map(te=>te.type==="depend"?"depend=".concat(te.rids.join(",")):"".concat(te.type,"=").concat(te.val)).join(";"))),k+this.eol}).join("")}printSimulcast(C){return C===void 0?"":"a=simulcast:".concat(C).concat(this.eol)}printSCTPPort(C){return C===void 0?"":"a=sctp-port:".concat(C).concat(this.eol)}printMaxMessageSize(C){return C===void 0?"":"a=max-message-size:".concat(C).concat(this.eol)}printMid(C){return C===void 0?"":"a=mid:".concat(C).concat(this.eol)}printSSRCGroups(C){return C.map(D=>"a=ssrc-group:".concat(D.semantic).concat(D.ssrcIds.map(k=>"".concat(p).concat(k.toString(10))).join("")).concat(this.eol)).join("")}}function Pe(oe){return new Ke().parse(oe)}function tt(oe,C){return new $n().print(oe,C)}}},r={};function n(o){if(r[o])return r[o].exports;var a=r[o]={exports:{}};return i[o](a,a.exports,n),a.exports}return n.d=(o,a)=>{for(var l in a)n.o(a,l)&&!n.o(o,l)&&Object.defineProperty(o,l,{enumerable:!0,get:a[l]})},n.o=(o,a)=>Object.prototype.hasOwnProperty.call(o,a),n.r=o=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(o,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(o,"__esModule",{value:!0})},n(8)})()})(aL);var Nt=aL.exports;function qn(e){if(Array.isArray(e))return e.map(i=>i);if(!cL(e))return e;let t={};for(let i in e){let r=e[i];cL(r)||Array.isArray(r)?t[i]=qn(r):t[i]=r}return t}function cL(e){return!(typeof e!="object"||Array.isArray(e)||!e)}class Ev{constructor(t){y(this,"input",[]),y(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}let Zo={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},th={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Zo,remoteCandidate:Zo}},lL={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0},dL={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},uL={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},hL={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};function pL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function mL(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?pL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):pL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class gv{constructor(t,i){y(this,"onFirstVideoReceived",void 0),y(this,"onFirstVideoDecoded",void 0),y(this,"onFirstAudioReceived",void 0),y(this,"onFirstVideoDecodedTimeout",void 0),y(this,"onFirstAudioDecoded",void 0),y(this,"onSelectedLocalCandidateChanged",void 0),y(this,"onSelectedRemoteCandidateChanged",void 0),y(this,"videoIsReady",!1),y(this,"videoIsReady2",{}),y(this,"pc",void 0),y(this,"options",void 0),y(this,"intervalTimer",void 0),y(this,"stats",qn(th)),y(this,"isFirstVideoReceived",{}),y(this,"isFirstVideoDecoded",{}),y(this,"isFirstAudioReceived",{}),y(this,"isFirstAudioDecoded",{}),y(this,"isFirstVideoDecodedTimeout",{}),y(this,"lossRateWindowStats",[]),this.pc=t,this.options=i,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new ne(t=>{t({local:mL({},Zo),remote:mL({},Zo)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,i){this.videoIsReady2[t]=i}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);let i=this.lossRateWindowStats.length,r=["videoSend","audioSend","videoRecv","audioRecv"],n=0,o=0,a=0,l=0;for(let d of r)t[d].forEach((u,p)=>{if(!this.lossRateWindowStats[i-1][d][p]||!this.lossRateWindowStats[0][d][p])return;let m=this.lossRateWindowStats[i-1][d][p].packets-this.lossRateWindowStats[0][d][p].packets,f=this.lossRateWindowStats[i-1][d][p].packetsLost-this.lossRateWindowStats[0][d][p].packetsLost;d==="videoSend"||d==="audioSend"?(n+=m,a+=f):(o+=m,l+=f),Number.isNaN(m)||Number.isNaN(m)?u.packetLostRate=0:u.packetLostRate=m<=0||f<=0?0:f/(m+f)});t.sendPacketLossRate=n<=0||a<=0?0:a/(n+a),t.recvPacketLossRate=o<=0||l<=0?0:l/(o+l)}}function _L(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function k9(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?_L(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):_L(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class L9 extends gv{constructor(){super(...arguments),y(this,"_stats",th),y(this,"lastDecodeVideoReceiverStats",new Map)}async updateStats(){let t=await this._getStats(),i=this.statsResponsesToObjects(t);this._stats=qn(th);let r=i.filter(o=>o.type==="ssrc");this.processSSRCStats(r);let n=i.find(o=>o.type==="VideoBwe");n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(i=>{var r;let n=se(r=i.id).call(r,"send");switch("".concat(i.mediaType,"_").concat(n?"send":"recv")){case"video_send":{let o=qn(dL);o.codec=i.googCodecName,o.adaptionChangeReason="none",i.googCpuLimitedResolution&&(o.adaptionChangeReason="cpu"),i.googBandwidthLimitedResolution&&(o.adaptionChangeReason="bandwidth"),o.avgEncodeMs=Number(i.googAvgEncodeMs),o.inputFrame={width:Number(i.googFrameWidthInput)||Number(i.googFrameWidthSent),height:Number(i.googFrameHeightInput)||Number(i.googFrameHeightSent),frameRate:Number(i.googFrameRateInput)},o.sentFrame={width:Number(i.googFrameWidthSent),height:Number(i.googFrameHeightSent),frameRate:Number(i.googFrameRateInput)},o.firsCount=Number(i.googFirReceived),o.nacksCount=Number(i.googNacksReceived),o.plisCount=Number(i.googPlisReceived),o.frameCount=Number(i.framesEncoded),o.bytes=Number(i.bytesSent),o.packets=Number(i.packetsSent),o.packetsLost=Number(i.packetsLost),o.ssrc=Number(i.ssrc),o.rttMs=Number(i.googRtt||0),this._stats.videoSend.push(o),this._stats.rtt=o.rttMs;break}case"video_recv":{let o=qn(lL),a=this.lastDecodeVideoReceiverStats.get(Number(i.ssrc));if(o.codec=i.googCodecName,o.targetDelayMs=Number(i.googTargetDelayMs),o.renderDelayMs=Number(i.googRenderDelayMs),o.currentDelayMs=Number(i.googCurrentDelayMs),o.minPlayoutDelayMs=Number(i.googMinPlayoutDelayMs),o.decodeMs=Number(i.googDecodeMs),o.maxDecodeMs=Number(i.googMaxDecodeMs),o.receivedFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateReceived)},o.decodedFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateDecoded)},o.decodeFrameRate=Number(i.googFrameRateDecoded),o.outputFrame={width:Number(i.googFrameWidthReceived),height:Number(i.googFrameHeightReceived),frameRate:Number(i.googFrameRateOutput)},o.jitterBufferMs=Number(i.googJitterBufferMs),o.firsCount=Number(i.googFirsSent),o.nacksCount=Number(i.googNacksSent),o.plisCount=Number(i.googPlisSent),o.framesDecodeCount=Number(i.framesDecoded),o.bytes=Number(i.bytesReceived),o.packets=Number(i.packetsReceived),o.packetsLost=Number(i.packetsLost),o.ssrc=Number(i.ssrc),o.packets>0&&!this.isFirstVideoReceived[o.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(o.ssrc),this.isFirstVideoReceived[o.ssrc]=!0),o.framesDecodeCount>0&&!this.isFirstVideoDecoded[o.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(o.ssrc,o.decodedFrame.width,o.decodedFrame.height),this.isFirstVideoDecoded[o.ssrc]=!0),a){let l=a.stats,d=Date.now()-a.lts;o.framesDecodeFreezeTime=l.framesDecodeFreezeTime,o.framesDecodeInterval=l.framesDecodeInterval,o.framesDecodeCount>l.framesDecodeCount&&this.isFirstVideoDecoded[o.ssrc]?(a.lts=Date.now(),o.framesDecodeInterval=d,o.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(i.ssrc,10))?o.framesDecodeFreezeTime+=o.framesDecodeInterval:this.setVideoIsReady2(parseInt(i.ssrc,10),!0))):o.framesDecodeCount<a.stats.framesDecodeCount&&(o.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(o.ssrc,{stats:k9({},o),lts:Date.now()}),this._stats.videoRecv.push(o);break}case"audio_recv":{let o=qn(hL);o.codec=i.googCodecName,o.outputLevel=Math.abs(Number(i.audioOutputLevel))/32767,o.decodingCNG=Number(i.googDecodingCNG),o.decodingCTN=Number(i.googDecodingCTN),o.decodingCTSG=Number(i.googDecodingCTSG),o.decodingNormal=Number(i.googDecodingNormal),o.decodingPLC=Number(i.googDecodingPLC),o.decodingPLCCNG=Number(i.googDecodingPLCCNG),o.expandRate=Number(i.googExpandRate),o.accelerateRate=Number(i.googAccelerateRate),o.preemptiveExpandRate=Number(i.googPreemptiveExpandRate),o.secondaryDecodedRate=Number(i.googSecondaryDecodedRate),o.speechExpandRate=Number(i.googSpeechExpandRate),o.preferredJitterBufferMs=Number(i.googPreferredJitterBufferMs),o.jitterBufferMs=Number(i.googJitterBufferMs),o.jitterMs=Number(i.googJitterReceived),o.bytes=Number(i.bytesReceived),o.packets=Number(i.packetsReceived),o.packetsLost=Number(i.packetsLost),o.ssrc=Number(i.ssrc),o.receivedFrames=Number(i.googDecodingCTN)||Number(i.packetsReceived),o.droppedFrames=Number(i.googDecodingPLC)+Number(i.googDecodingPLCCNG)||Number(i.packetsLost),o.receivedFrames>0&&!this.isFirstAudioReceived[o.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(o.ssrc),this.isFirstAudioReceived[o.ssrc]=!0),o.decodingNormal>0&&!this.isFirstAudioDecoded[o.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(o.ssrc),this.isFirstAudioDecoded[o.ssrc]=!0),this._stats.audioRecv.push(o);break}case"audio_send":{let o=qn(uL);o.codec=i.googCodecName,o.inputLevel=Math.abs(Number(i.audioInputLevel))/32767,o.aecReturnLoss=Number(i.googEchoCancellationReturnLoss||0),o.aecReturnLossEnhancement=Number(i.googEchoCancellationReturnLossEnhancement||0),o.residualEchoLikelihood=Number(i.googResidualEchoLikelihood||0),o.residualEchoLikelihoodRecentMax=Number(i.googResidualEchoLikelihoodRecentMax||0),o.bytes=Number(i.bytesSent),o.packets=Number(i.packetsSent),o.packetsLost=Number(i.packetsLost),o.ssrc=Number(i.ssrc),o.rttMs=Number(i.googRtt||0),this._stats.rtt=o.rttMs,this._stats.audioSend.push(o);break}}})}_getStats(){return new ne((t,i)=>{this.pc.getStats(t,i)})}statsResponsesToObjects(t){let i=[];return t.result().forEach(r=>{let n={id:r.id,timestamp:r.timestamp.valueOf().toString(),type:r.type};r.names().forEach(o=>{n[o]=r.stat(o)}),i.push(n)}),i}}function fL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function vc(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?fL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):fL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class EL extends gv{constructor(){super(...arguments),y(this,"_stats",th),y(this,"report",void 0),y(this,"lastDecodeVideoReceiverStats",new Map),y(this,"lastVideoFramesRecv",new Map),y(this,"lastVideoFramesSent",new Map),y(this,"lastVideoFramesDecode",new Map),y(this,"lastVideoFramesOutput",new Map),y(this,"lastVideoJBDelay",new Map),y(this,"lastAudioJBDelay",new Map),y(this,"mediaBytesSent",new Map),y(this,"mediaBytesRetransmit",new Map),y(this,"mediaBytesTargetEncode",new Map),y(this,"lastEncoderMs",new Map)}async updateStats(){this.report=await this.pc.getStats(),this._stats=qn(th),this.report.forEach(t=>{switch(t.type){case Jr.OUTBOUND:case Jr.INBOUND:{let i=t.mediaType||t.kind,r=!i&&"frameWidth"in t,n=!i&&!("frameWidth"in t);t.type===Jr.OUTBOUND?i==="audio"||n?this.processAudioOutboundStats(t):(i==="video"||r)&&this.processVideoOutboundStats(t):t.type===Jr.INBOUND&&(i==="audio"||n?this.processAudioInboundStats(t):(i==="video"||r)&&this.processVideoInboundStats(t));break}case Jr.TRANSPORT:{let i=this.report.get(t.selectedCandidatePairId);i&&this.processCandidatePairStats(i);break}case Jr.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){let t=await this.pc.getStats(),i={local:vc({},Zo),remote:vc({},Zo)};return t.forEach(r=>{let n;if(r.type===Jr.TRANSPORT&&(n=t.get(r.selectedCandidatePairId)),r.type===Jr.CANDIDATE_PAIR&&r.selected&&(n=r),n){let o=(a,l)=>{a.type=l.type,a.id=l.id,l.address&&(a.address=l.address),l.candidateType&&(a.candidateType=l.candidateType),l.port&&(a.port=l.port),l.priority&&(a.priority=l.priority),l.protocol&&(a.protocol=l.protocol),l.relayProtocol&&(a.relayProtocol=l.relayProtocol)};if(n.localCandidateId){let a=t.get(n.localCandidateId);a&&o(i.local,a)}if(n.remoteCandidateId){let a=t.get(n.remoteCandidateId);a&&o(i.remote,a)}}}),i}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(i=>{t.currentRoundTripTime&&(i.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(i=>{t.currentRoundTripTime&&(i.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){let i=this.report.get(t.localCandidateId);i&&this.processCandidateStats(i)}if(t.remoteCandidateId){let i=this.report.get(t.remoteCandidateId);i&&this.processCandidateStats(i)}}processCandidateStats(t){let i;t.type===Jr.LOCAL_CANDIDATE&&(i=this._stats.selectedCandidatePair.localCandidate),t.type===Jr.REMOTE_CANDIDATE&&(i=this._stats.selectedCandidatePair.remoteCandidate),i&&(i.type=t.type,i.id=t.id,t.address&&(i.address=t.address),t.candidateType&&(i.candidateType=t.candidateType),t.port&&(i.port=t.port),t.priority&&(i.priority=t.priority),t.protocol&&(i.protocol=t.protocol),t.relayProtocol&&(i.relayProtocol=t.relayProtocol),t.type===Jr.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==i.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(vc({},i),vc({},this.stats.selectedCandidatePair.localCandidate)),t.type===Jr.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==i.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(vc({},i),vc({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let i=this._stats.audioRecv.find(r=>r.ssrc===t.ssrc);i||(i=qn(hL),this._stats.audioRecv.push(i)),i.ssrc=t.ssrc,i.packets=t.packetsReceived,i.packetsLost=t.packetsLost,i.bytes=t.bytesReceived,i.jitterMs=1e3*t.jitter,this.processAudioTrackReceiverStats(t,t.trackId,i),t.codecId&&(i.codec=this.getCodecFromCodecStats(t.codecId)),i.receivedFrames||(i.receivedFrames=t.packetsReceived),i.droppedFrames||(i.droppedFrames=t.packetsLost),i.receivedFrames>0&&!this.isFirstAudioReceived[i.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(i.ssrc),this.isFirstAudioReceived[i.ssrc]=!0),i.outputLevel&&i.outputLevel>0&&!this.isFirstAudioDecoded[i.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(i.ssrc),this.isFirstAudioDecoded[i.ssrc]=!0),typeof t.concealedSamples=="number"&&(i.concealedSamples=t.concealedSamples)}processVideoInboundStats(t){let i=this._stats.videoRecv.find(l=>l.ssrc===t.ssrc);i||(i=qn(lL),this._stats.videoRecv.push(i)),i.ssrc=t.ssrc,i.packets=t.packetsReceived,i.packetsLost=t.packetsLost,i.bytes=t.bytesReceived,i.firsCount=t.firCount,i.nacksCount=t.nackCount,i.plisCount=t.pliCount,i.framesDecodeCount=t.framesDecoded,i.framesDroppedCount=t.framesDropped,i.totalInterFrameDelay=t.totalInterFrameDelay,i.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay,i.totalFreezesDuration=t.totalFreezesDuration;let r=this.lastDecodeVideoReceiverStats.get(i.ssrc),n=this.lastVideoFramesDecode.get(i.ssrc),o=this.lastVideoFramesOutput.get(i.ssrc),a=Date.now();if(i.framesDecodeCount>0&&!this.isFirstVideoDecoded[i.ssrc]){let l=i.decodedFrame?i.decodedFrame.width:0,d=i.decodedFrame?i.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(i.ssrc,l,d),this.isFirstVideoDecoded[i.ssrc]=!0}if(r){let l=r.stats,d=a-r.lts;i.framesDecodeFreezeTime=l.framesDecodeFreezeTime,i.framesDecodeInterval=l.framesDecodeInterval,!this.isFirstVideoDecoded[i.ssrc]&&d>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[i.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(i.ssrc),this.isFirstVideoDecodedTimeout[i.ssrc]=!0),i.framesDecodeCount>l.framesDecodeCount&&this.isFirstVideoDecoded[i.ssrc]?(r.lts=Date.now(),i.framesDecodeInterval=d,i.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?i.framesDecodeFreezeTime+=i.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):i.framesDecodeCount<l.framesDecodeCount&&(i.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(r.stats.framesDecodeCount>t.framesDecoded?i.qpSumPerFrame=t.qpSum/t.framesDecoded:i.qpSumPerFrame=(t.qpSum-r.qpSum)/(t.framesDecoded-r.stats.framesDecodeCount))}n&&a-n.lts>=800?(i.decodeFrameRate=Math.round((i.framesDecodeCount-n.count)/((a-n.lts)/1e3)),this.lastVideoFramesDecode.set(i.ssrc,{count:i.framesDecodeCount,lts:a,rate:i.decodeFrameRate})):n?i.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(i.ssrc,{count:i.framesDecodeCount,lts:a,rate:0}),i.framesDroppedCount&&t.framesReceived&&(o&&a-o.lts>=800?(i.outputFrameRate=Math.round((t.framesReceived-i.framesDroppedCount-o.count)/((a-o.lts)/1e3)),this.lastVideoFramesOutput.set(i.ssrc,{count:t.framesReceived-i.framesDroppedCount,lts:a,rate:Math.max(i.outputFrameRate,0)})):o?i.outputFrameRate=o.rate:this.lastVideoFramesOutput.set(i.ssrc,{count:t.framesReceived-i.framesDroppedCount,lts:a,rate:0})),t.totalDecodeTime&&(i.decodeMs=1e3*t.totalDecodeTime),this.processVideoTrackReceiverStats(t,t.trackId,i),t.codecId&&(i.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(i.framesRateFirefox=t.framerateMean),i.packets>0&&!this.isFirstVideoReceived[i.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(i.ssrc),this.isFirstVideoReceived[i.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(i.ssrc,{stats:vc({},i),lts:r?r.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let i=this._stats.videoSend.find(n=>n.ssrc===t.ssrc);i||(i=qn(dL),this._stats.videoSend.push(i));let r=this.mediaBytesSent.get(t.ssrc);if(r)r.add(t.bytesSent);else{let n=new Ev(10);n.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,n)}if(t.retransmittedBytesSent!==void 0){let n=this.mediaBytesRetransmit.get(t.ssrc);if(n)n.add(t.retransmittedBytesSent);else{let o=new Ev(10);o.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,o)}}if(t.totalEncodedBytesTarget){let n=this.mediaBytesTargetEncode.get(t.ssrc);if(n)n.add(t.totalEncodedBytesTarget);else{let o=new Ev(10);o.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,o)}}if(i.ssrc=t.ssrc,i.bytes=t.bytesSent,i.packets=t.packetsSent,i.firsCount=t.firCount,i.nacksCount=t.nackCount,i.plisCount=t.pliCount,i.frameCount=t.framesEncoded,i.adaptionChangeReason=t.qualityLimitationReason,i.scalabilityMode=t.scalabilityMode,t.totalEncodeTime&&t.framesEncoded){let n=this.lastEncoderMs.get(t.ssrc);if(!n||n.lastFrameCount>t.framesEncoded)i.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{let o=t.framesEncoded-n.lastFrameCount,a=t.totalEncodeTime-n.lastEncoderTime;i.avgEncodeMs=1e3*a/o}}if(t.framesEncoded&&t.qpSum){let n=this.lastEncoderMs.get(t.ssrc);!n||n.lastFrameCount>t.framesEncoded?i.qpSumPerFrame=t.qpSum/t.framesEncoded:i.qpSumPerFrame=(t.qpSum-n.lastQpSum)/(t.framesEncoded-n.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(i.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,i),this.processVideoTrackSenderStats(t,t.trackId,i),t.remoteId)this.processRemoteInboundStats(t.remoteId,i);else{let n=this.findRemoteStatsId(t.ssrc,Jr.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,i)}}processAudioOutboundStats(t){let i=this._stats.audioSend.find(r=>r.ssrc===t.ssrc);if(i||(i=qn(uL),this._stats.audioSend.push(i)),i.ssrc=t.ssrc,i.packets=t.packetsSent,i.bytes=t.bytesSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,i),t.codecId&&(i.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,i),t.remoteId)this.processRemoteInboundStats(t.remoteId,i);else{let r=this.findRemoteStatsId(t.ssrc,Jr.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,i)}}findRemoteStatsId(t,i){var r;let n=Array.from(ho(r=this.report).call(r)).find(o=>o.type===i&&o.ssrc===t);return n?n.id:null}processVideoMediaSource(t,i){let r=this.report.get(t);r&&r.width&&r.height&&r.framesPerSecond&&(i.inputFrame={width:r.width,height:r.height,frameRate:r.framesPerSecond})}processAudioMediaSource(t,i){let r=this.report.get(t);r&&(i.inputLevel=r.audioLevel)}processVideoTrackSenderStats(t,i,r){var n,o,a,l;let d=i?this.report.get(i):void 0,u=(n=d==null?void 0:d.framesSent)!==null&&n!==void 0?n:t.framesSent;if(typeof u!="number")return;let p=(o=d==null?void 0:d.frameWidth)!==null&&o!==void 0?o:t.frameWidth,m=(a=d==null?void 0:d.frameHeight)!==null&&a!==void 0?a:t.frameHeight,f=(l=d==null?void 0:d.framesPerSecond)!==null&&l!==void 0?l:t.framesPerSecond;if(typeof p=="number"&&typeof m=="number"||(p=0,m=0),f==null){let E=Date.now(),I=this.lastVideoFramesSent.get(r.ssrc);I&&E-I.lts>=800?(f=Math.round((u-I.count)/((E-I.lts)/1e3)),this.lastVideoFramesSent.set(r.ssrc,{count:u,lts:E,rate:f})):I?f=I.rate:this.lastVideoFramesSent.set(r.ssrc,{count:u,lts:E,rate:0})}r.sentFrame={width:p,height:m,frameRate:Math.max(0,f)}}processVideoTrackReceiverStats(t,i,r){var n,o,a,l,d;let u=i?this.report.get(i):void 0,p=(n=u==null?void 0:u.framesReceived)!==null&&n!==void 0?n:t.framesReceived,m=(o=u==null?void 0:u.frameWidth)!==null&&o!==void 0?o:t.frameWidth,f=(a=u==null?void 0:u.frameHeight)!==null&&a!==void 0?a:t.frameHeight,E=(l=u==null?void 0:u.jitterBufferDelay)!==null&&l!==void 0?l:t.jitterBufferDelay,I=(d=u==null?void 0:u.jitterBufferEmittedCount)!==null&&d!==void 0?d:t.jitterBufferEmittedCount;if(typeof p=="number"){let T=this.lastVideoFramesRecv.get(r.ssrc),R=Date.now();r.framesReceivedCount=p;let w=0;T&&R-T.lts>=800?(w=Math.round((p-T.count)/((R-T.lts)/1e3)),this.lastVideoFramesRecv.set(r.ssrc,{count:p,lts:R,rate:w})):T?w=T.rate:this.lastVideoFramesRecv.set(r.ssrc,{count:p,lts:R,rate:0}),r.receivedFrame={width:m||0,height:f||0,frameRate:w||0},r.decodedFrame={width:m||0,height:f||0,frameRate:r.decodeFrameRate||0},r.outputFrame={width:m||0,height:f||0,frameRate:r.outputFrameRate||r.decodeFrameRate||0}}if(E&&I){let T=this.lastVideoJBDelay.get(r.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},R=T.jitterBufferMs,w=I-T.jitterBufferEmittedCount;w>0&&(R=1e3*(E-T.jitterBufferDelay)/w),r.jitterBufferMs=R,r.currentDelayMs=Math.round(R),this.lastVideoJBDelay.set(r.ssrc,{jitterBufferDelay:E,jitterBufferEmittedCount:I,jitterBufferMs:r.currentDelayMs})}}processAudioTrackSenderStats(t,i,r){var n,o,a,l;let d=i?this.report.get(i):void 0,u=(n=(o=d==null?void 0:d.echoReturnLoss)!==null&&o!==void 0?o:t.echoReturnLoss)!==null&&n!==void 0?n:0,p=(a=(l=d==null?void 0:d.echoReturnLossEnhancement)!==null&&l!==void 0?l:t.echoReturnLossEnhancement)!==null&&a!==void 0?a:0;r.aecReturnLoss=u,r.aecReturnLossEnhancement=p}processAudioTrackReceiverStats(t,i,r){var n,o,a,l,d,u,p;let m=i?this.report.get(i):void 0,f=(n=m==null?void 0:m.removedSamplesForAcceleration)!==null&&n!==void 0?n:t.removedSamplesForAcceleration,E=(o=m==null?void 0:m.totalSamplesReceived)!==null&&o!==void 0?o:t.totalSamplesReceived,I=(a=m==null?void 0:m.jitterBufferDelay)!==null&&a!==void 0?a:t.jitterBufferDelay,T=(l=m==null?void 0:m.jitterBufferEmittedCount)!==null&&l!==void 0?l:t.jitterBufferEmittedCount,R=(d=m==null?void 0:m.audioLevel)!==null&&d!==void 0?d:t==null?void 0:t.audioLevel,w=(u=m==null?void 0:m.totalSamplesDuration)!==null&&u!==void 0?u:t==null?void 0:t.totalSamplesDuration,O=(p=m==null?void 0:m.concealedSamples)!==null&&p!==void 0?p:t.concealedSamples;if(f&&E&&(r.accelerateRate=f/E),I&&T){let M=this.lastAudioJBDelay.get(r.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},V=M.jitterBufferMs,F=T-M.jitterBufferEmittedCount;F>0&&(V=1e3*(I-M.jitterBufferDelay)/F),r.jitterBufferMs=Math.round(V),this.lastAudioJBDelay.set(r.ssrc,{jitterBufferDelay:I,jitterBufferEmittedCount:T,jitterBufferMs:r.jitterBufferMs})}r.outputLevel=R;let P=1920;w&&E&&(P=E/w/50,r.receivedFrames=Math.round(E/P)),O&&(r.droppedFrames=Math.round(O/P))}processRemoteInboundStats(t,i){let r=this.report.get(t);r&&(i.packetsLost=r.packetsLost,r.roundTripTime&&(i.rttMs=1e3*r.roundTripTime),r.jitter&&(i.jitterMs=1e3*r.jitter),r.timestamp&&(i.timestamp=r.timestamp))}getCodecFromCodecStats(t){let i=this.report.get(t);if(!i)return"";let r=i.mimeType.match(/\/(.*)$/);return r&&r[1]?r[1]:""}updateSendBitrate(){let t=0,i=null,r=null;this.mediaBytesSent.forEach(o=>{t+=o.diffMean()}),this.mediaBytesRetransmit.forEach(o=>{i=i===null?o.diffMean():i+o.diffMean()}),this.mediaBytesTargetEncode.forEach(o=>{r=r===null?o.diffMean():r+o.diffMean()});let n=i!==null?t-i:t;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},i!==null&&(this._stats.bitrate.retransmit=8*i/(this.options.updateInterval/1e3)),r!==null&&(this._stats.bitrate.targetEncoded=8*r/(this.options.updateInterval/1e3))}}class M9 extends gv{updateStats(){return ne.resolve()}}function a_(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,n=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4,o=function(){let a=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return a&&a[0]?Number(a[0].split("/")[1]):null}();return o?o<76?new L9(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:r,firstVideoDecodedTimeout:n}):new EL(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:r,firstVideoDecodedTimeout:n}):function(a){return!!window.RTCStatsReport&&a.getStats()instanceof ne}(e)?new EL(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:r,firstVideoDecodedTimeout:n}):new M9(e,{updateInterval:t,lossRateInterval:i,freezeRateLimit:r,firstVideoDecodedTimeout:n})}function gL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function SL(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?gL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):gL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function ih(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0,{filterRTX:n,filterVideoFec:o,filterAudioFec:a,filterAudioCodec:l,filterVideoCodec:d}=t,{useXR:u}=i,p=[],m=[],f=[],E=[],I=!1,T=!1;if(Nt.parse(e).mediaDescriptions.forEach(w=>{r&&r!==w.attributes.direction||(w.media.mediaType!=="video"||I||(m=w.attributes.payloads,E=w.attributes.extmaps,I=!0),w.media.mediaType!=="audio"||T||(p=w.attributes.payloads,f=w.attributes.extmaps,T=!0))}),!E||m.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!f||p.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(m.forEach(w=>{var O;(O=w.rtpMap)!==null&&O!==void 0&&O.clockRate&&(w.rtpMap.clockRate=parseInt(w.rtpMap.clockRate)),u&&w.rtcpFeedbacks.push({type:"rrtr"})}),p.forEach(w=>{var O;(O=w.rtpMap)!==null&&O!==void 0&&O.clockRate&&(w.rtpMap.clockRate=parseInt(w.rtpMap.clockRate)),u&&w.rtcpFeedbacks.push({type:"rrtr"})}),n&&(p=p.filter(w=>{var O;return((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName.toLowerCase())!=="rtx"}),m=m.filter(w=>{var O;return((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName.toLowerCase())!=="rtx"})),o&&(m=m.filter(w=>{var O;return!/(red)|(ulpfec)|(flexfec)/i.test(((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName)||"")})),a&&(p=p.filter(w=>{var O;return!/(red)|(ulpfec)|(flexfec)/i.test(((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName)||"")})),l&&(l==null?void 0:l.length)>0&&(p=p.filter(w=>{var O;return se(l).call(l,((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName.toLowerCase())||"")})),d&&(d==null?void 0:d.length)>0){let w=m.filter(O=>{var P;return se(d).call(d,((P=O.rtpMap)===null||P===void 0?void 0:P.encodingName.toLowerCase())||"")});m=w.concat(n?[]:Cv(w,m))}let R=N("UNSUPPORTED_VIDEO_CODEC");return R&&R.length>0&&(m=m.filter(w=>!(w.rtpMap&&se(R).call(R,w.rtpMap.encodingName.toLowerCase())))),{audioCodecs:p,videoCodecs:m,audioExtensions:f,videoExtensions:E}}function go(e){let t=Nt.parse(e),i,r;for(let n of t.mediaDescriptions){if(!i){let o=n.attributes.iceUfrag,a=n.attributes.icePwd;if(!o||!a)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:o,icePwd:a}}if(!r){let o=n.attributes.fingerprints;o.length>0&&(r={fingerprints:o})}}if(!r&&t.attributes.fingerprints.length>0&&(r={fingerprints:t.attributes.fingerprints}),!r||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:r}}function Sv(e,t){let i=[],r=e.attributes.ssrcGroups.filter(a=>a.semantic==="FID"),n=e.attributes.ssrcGroups.find(a=>a.semantic==="SIM"),o=e.attributes.ssrcs;if(n)n.ssrcIds.forEach(a=>{var l;let d=(l=r.find(u=>u.ssrcIds[0]===a))===null||l===void 0?void 0:l.ssrcIds[1];i.push({ssrcId:a,rtx:t?d:void 0})});else if(r.length>0){let a=r[0].ssrcIds[0],l=r[0].ssrcIds[1];i.push({ssrcId:a,rtx:t?l:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function TL(e,t){let{cname:i}=e,r;t&&t.ip&&typeof t.port=="number"?(r=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],S.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(r.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),S.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):r=e.iceParameters.candidates.map(l=>({foundation:l.foundation,componentId:"1",transport:l.protocol,priority:l.priority.toString(),connectionAddress:l.ip,port:l.port.toString(),type:l.type,extension:{}}));let n={fingerprints:e.dtlsParameters.fingerprints.map(l=>({hashFunction:l.algorithm,fingerprint:l.fingerprint}))},o={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd},a;switch(e.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}return{dtlsParameters:n,iceParameters:o,candidates:r,rtpCapabilities:id(e.rtpCapabilities),setup:a,cname:i}}function on(e,t,i){let r=[],n=[];return e.forEach(o=>{let{ssrcId:a,rtx:l}=o,d=ft(8,"track-"),u={ssrcId:a,attributes:SL({label:d,mslabel:i=i||ft(10,""),msid:"".concat(i," ").concat(d)},t&&{cname:t})};if(r.push(u),l!==void 0){let p={ssrcId:l,attributes:SL({label:d,mslabel:i,msid:"".concat(i," ").concat(d)},t&&{cname:t})};r.push(p),n.push({semantic:"FID",ssrcIds:[a,l]})}}),e.length>1&&n.push({semantic:"SIM",ssrcIds:e.map(o=>{let{ssrcId:a}=o;return a})}),{ssrcs:r,ssrcGroups:n}}function la(e,t){t instanceof jt&&e.attributes.payloads.forEach(i=>{var r;let n=(r=i.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase();if(!n||["opus","pcmu","pcma","g722"].indexOf(n)===-1)return;i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters.minptime="10",i.fmtp.parameters.useinbandfec="1";let o=t._encoderConfig;o&&n!=="pcmu"&&n!=="pcma"&&n!=="g722"&&(o.bitrate&&!mt()&&(i.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(i.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),i.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(i.fmtp.parameters.stereo="1",i.fmtp.parameters["sprop-stereo"]="1"))})}function c_(e){let t=e.attributes.unrecognized.findIndex(i=>i.attField==="x-google-flag"&&i.attValue==="conference");t!==-1&&e.attributes.unrecognized.splice(t,1)}function l_(e,t){var i;if(!(t instanceof Et&&t._encoderConfig&&t._hints.indexOf(Rt.SCREEN_TRACK)===-1))return;let r=t._encoderConfig;Ye().supportMinBitrate&&r.bitrateMin&&e.attributes.payloads.forEach(n=>{var o,a;se(o=["h264","h265","vp8","vp9","av1"]).call(o,((a=n.rtpMap)===null||a===void 0?void 0:a.encodingName.toLowerCase())||"")&&(n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters["x-google-min-bitrate"]="".concat(r.bitrateMin))}),Ye().supportMinBitrate&&!se(i=t._hints).call(i,Rt.LOW_STREAM)&&r.bitrateMax&&e.attributes.payloads.forEach(n=>{var o,a;se(o=["h264","h265","vp8","vp9","av1"]).call(o,((a=n.rtpMap)===null||a===void 0?void 0:a.encodingName.toLowerCase())||"")&&(n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters["x-google-start-bitrate"]="".concat(N("X_GOOGLE_START_BITRATE")||Math.floor(r.bitrateMax)))})}function Tv(e){if(e.media.mediaType!=="video")return;let t=Xe();if(t.name!==nt.SAFARI&&t.os!==hi.IOS)return;let i=e.attributes.extmaps.findIndex(r=>/video-orientation/g.test(r.extensionName));i!==-1&&e.attributes.extmaps.splice(i,1)}function td(e,t,i){if(!t)return;let r,n;if(e.media.mediaType==="video"?(r=i.videoExtensions,n=i.videoCodecs):(r=i.audioExtensions,n=i.audioCodecs),t.twcc===!0){let o=r.find(a=>a.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o&&(e.attributes.extmaps.find(a=>a.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||e.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(a,l){return l.filter(d=>!!a.find(u=>u.payloadType===d.payloadType&&!!u.rtcpFeedbacks.find(p=>p.type==="transport-cc")))}(n,e.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(l=>l.type==="transport-cc")||a.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(t.twcc===!1){let o=e.attributes.extmaps.findIndex(a=>a.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o!==-1&&e.attributes.extmaps.splice(o,1),e.attributes.payloads.forEach(a=>{let l=a.rtcpFeedbacks.findIndex(d=>d.type==="transport-cc");l!==-1&&a.rtcpFeedbacks.splice(l,1)})}if(t.remb===!0){let o=r.find(a=>a.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o&&(e.attributes.extmaps.find(a=>a.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||e.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(a,l){return l.filter(d=>!!a.find(u=>u.payloadType===d.payloadType&&!!u.rtcpFeedbacks.find(p=>p.type==="goog-remb")))}(n,e.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(l=>l.type==="goog-remb")||a.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(t.remb===!1){let o=e.attributes.extmaps.findIndex(a=>a.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o!==-1&&e.attributes.extmaps.splice(o,1),e.attributes.payloads.forEach(a=>{let l=a.rtcpFeedbacks.findIndex(d=>d.type==="goog-remb");l!==-1&&a.rtcpFeedbacks.splice(l,1)})}}function vv(e,t,i){if(mt()||e.media.mediaType!=="video"||!(t instanceof Et)||i!=="vp9"&&i!=="vp8"||i==="vp8"&&!N("SIMULCAST")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;let r=i==="vp8"?2:t._scalabilityMode.numSpatialLayers,n=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find(l=>l.semantic==="FID"&&l.ssrcIds[0]===n.ssrcId),a={semantic:"SIM",ssrcIds:[n.ssrcId]};for(let l=1;l<r;l++)e.attributes.ssrcs.push({ssrcId:n.ssrcId+l,attributes:vt(n.attributes)}),a.ssrcIds.push(n.ssrcId+l),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+l,attributes:vt(n.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[n.ssrcId+l,o.ssrcIds[1]+l]}));e.attributes.ssrcGroups.unshift(a)}async function Rv(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});let r=(await i.createOffer()).sdp,{send:n,recv:o,sendrecv:a}=function(){let l=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},u=arguments.length>2?arguments[2]:void 0,p=ih(u,l,d,"sendonly"),m=ih(u,l,d,"recvonly"),f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},E={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},I={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Jn(p,m,"videoExtensions",f,E,I),Jn(p,m,"videoCodecs",f,E,I),Jn(p,m,"audioExtensions",f,E,I),Jn(p,m,"audioCodecs",f,E,I),N("RAISE_H264_BASELINE_PRIORITY")){let T=I.videoCodecs.findIndex(R=>{var w,O;return((w=R.rtpMap)===null||w===void 0?void 0:w.encodingName.toLocaleLowerCase())==="h264"&&((O=R.fmtp)===null||O===void 0?void 0:O.parameters["profile-level-id"])==="42001f"});if(T!==-1){let R=I.videoCodecs.findIndex(w=>{var O;return((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName.toLocaleLowerCase())==="h264"});if(R<T){S.debug("raising H264 baseline profile priority");let w=I.videoCodecs[T];I.videoCodecs.splice(T,1),I.videoCodecs.splice(R,0,w)}R!==-1&&(E.videoCodecs=E.videoCodecs.filter(w=>{var O,P;return!(((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName.toLocaleLowerCase())==="h264"&&((P=w.fmtp)===null||P===void 0?void 0:P.parameters["profile-level-id"])!=="42001f")})),R!==-1&&N("FILTER_SEND_H264_BASELINE")&&(f.videoCodecs=f.videoCodecs.filter(w=>{var O,P;return!(((O=w.rtpMap)===null||O===void 0?void 0:O.encodingName.toLocaleLowerCase())==="h264"&&((P=w.fmtp)===null||P===void 0?void 0:P.parameters["profile-level-id"])!=="42001f")}))}}return{send:f,recv:E,sendrecv:I}}(e,t,r);try{i.close()}catch{}return{send:n,recv:o,sendrecv:a}}function vL(){let e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=ih(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Jn(e,t,"videoExtensions",i,r,n),Jn(e,t,"videoCodecs",i,r,n),Jn(e,t,"audioExtensions",i,r,n),Jn(e,t,"audioCodecs",i,r,n),N("RAISE_H264_BASELINE_PRIORITY")){let o=n.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){let a=n.videoCodecs.findIndex(l=>l.rtpMap&&l.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(a<o){S.debug("raising H264 baseline profile priority");let l=n.videoCodecs[o];n.videoCodecs.splice(o,1),n.videoCodecs.splice(a,0,l)}a!==-1&&(r.videoCodecs=r.videoCodecs.filter(l=>!(l.rtpMap&&l.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&l.fmtp&&l.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:i,recv:r,sendrecv:n}}function Jn(e,t,i,r,n,o){if(i==="videoExtensions"||i==="audioExtensions"){let a=[];return e[i].forEach(l=>{t[i].some((d,u)=>{if(l.entry===d.entry&&l.extensionName===d.extensionName)return a.push(u),!0})?o[i].push(l):r[i].push(l)}),void t[i].forEach((l,d)=>{a.indexOf(d)===-1&&n[i].push(l)})}if(i==="videoCodecs"||i==="audioCodecs"){let a=[];return e[i].forEach(l=>{t[i].some((d,u)=>{if(l.payloadType===d.payloadType&&JSON.stringify(l)===JSON.stringify(d))return a.push(u),!0})?o[i].push(l):r[i].push(l)}),void t[i].forEach((l,d)=>{a.indexOf(d)===-1&&n[i].push(l)})}}function id(e){let{send:t,recv:i,sendrecv:r}=e;if(!r){if(!t||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:i}}let n,o;return t?(n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n.audioCodecs=[...t.audioCodecs,...r.audioCodecs],n.videoCodecs=[...t.videoCodecs,...r.videoCodecs],n.audioExtensions=[...t.audioExtensions,...r.audioExtensions],n.videoExtensions=[...t.videoExtensions,...r.videoExtensions]):n=r,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...r.audioCodecs],o.videoCodecs=[...i.videoCodecs,...r.videoCodecs],o.audioExtensions=[...i.audioExtensions,...r.audioExtensions],o.videoExtensions=[...i.videoExtensions,...r.videoExtensions]):o=r,{send:n,recv:o}}function So(e){e.media.mediaType==="audio"&&e.attributes.payloads.filter(t=>{var i;return((i=t.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase())==="opus"}).forEach(t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"})}function d_(e){e.mediaDescriptions.forEach(t=>{t.media.mediaType!=="video"&&t.media.mediaType!=="audio"||t.attributes.payloads.forEach(i=>{i.rtcpFeedbacks.findIndex(r=>r.type==="rrtr")===-1&&i.rtcpFeedbacks.push({type:"rrtr"})})})}function Rc(e,t,i,r){let n=[];if(e===me.VIDEO){if(N("H264_PROFILE_LEVEL_ID")&&r==="h264"&&(n=t.videoCodecs.filter(o=>{var a;return se(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,r)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===N("H264_PROFILE_LEVEL_ID")})),!Array.isArray(n)||n.length===0){let o=[],a=[],l=[],d=[];if(i.videoCodecs.forEach(u=>{let p=u.rtpMap&&u.rtpMap.encodingName.toLowerCase()||"";se(p).call(p,r)?o.push(u):se(p).call(p,"vp9")?a.push(u):se(p).call(p,"vp8")?l.push(u):se(p).call(p,"h264")&&d.push(u)}),o.length===0){let u="";a.length!==0?(o=a,u="vp9"):l.length!==0?(o=l,u="vp8"):d.length!==0&&(o=d,u="h264"),S.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(u))}o.length!==0&&(n=t.videoCodecs.filter(u=>o.some(p=>p.payloadType===u.payloadType)))}if(n.length===0&&(S.warning("codec ".concat(r," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),n=t.videoCodecs),N("USE_PUB_RTX")||N("USE_SUB_RTX")){let o=Cv(n,t.videoCodecs);n=[...n,...o]}}else n=t.audioCodecs.filter(o=>{var a;return se(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,r)}),n.length===0&&(S.warning("codec ".concat(r," not included in rtpCapabilities, fallback to opus")),n=t.audioCodecs.filter(o=>{var a;return se(a=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(a,"opus")}));return n}function Cv(e,t){let i=e.map(r=>r.payloadType.toString());return t.filter(r=>r.rtpMap&&r.rtpMap.encodingName==="rtx"&&r.fmtp&&r.fmtp.parameters.apt&&se(i).call(i,r.fmtp&&r.fmtp.parameters.apt))}let RL=class{get localCapabilities(){return vt(this._localCapabilities)}get rtpCapabilities(){return vt(this._rtpCapabilities)}get candidates(){return vt(this._candidates)}get iceParameters(){return vt(this._iceParameters)}get dtlsParameters(){return vt(this._dtlsParameters)}constructor(e){y(this,"sessionDesc",void 0),y(this,"_localCapabilities",void 0),y(this,"_rtpCapabilities",void 0),y(this,"_candidates",void 0),y(this,"_iceParameters",void 0),y(this,"_dtlsParameters",void 0),y(this,"setup",void 0),y(this,"currentMidIndex",void 0),y(this,"cname","o/i14u9pJrxRKAsu"),y(this,"firefoxSsrcMidMap",new Map),e=vt(e);let{remoteIceParameters:t,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:n,localCapabilities:o,direction:a,setup:l,videoCodec:d,audioCodec:u}=e,p;this.setup=l,p=a===nr.RECEIVE_ONLY?Nt.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Nt.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=n,this._candidates=r,this._iceParameters=t,this._dtlsParameters=i,this._localCapabilities=o;let m=a===nr.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,f=a===nr.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,E=a===nr.RECEIVE_ONLY?n.send.videoCodecs:Rc(me.VIDEO,m,f,d),I=a===nr.RECEIVE_ONLY?n.send.audioCodecs:Rc(me.AUDIO,m,f,u);for(let T of p.mediaDescriptions)T.attributes.iceUfrag=t.iceUfrag,T.attributes.icePwd=t.icePwd,T.attributes.fingerprints=i.fingerprints,T.attributes.candidates=r,T.attributes.setup=this.setup,T.media.mediaType==="application"&&(T.attributes.sctpPort="5000"),T.media.mediaType==="video"&&(T.media.fmts=E.map(R=>R.payloadType.toString(10)),T.attributes.payloads=E,T.attributes.extmaps=m.videoExtensions),T.media.mediaType==="audio"&&(T.media.fmts=I.map(R=>R.payloadType.toString(10)),T.attributes.payloads=I,T.attributes.extmaps=m.audioExtensions,So(T));this.sessionDesc=p,this.currentMidIndex=p.mediaDescriptions.length-1}toString(){return Nt.print(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every(t=>this.hasMid(t)):this.sessionDesc.mediaDescriptions.some(t=>t.attributes.mid===e)}send(e,t,i,r,n){i=i.replace(/ /g,"-");let{ssrcs:o,ssrcGroups:a}=on(t,this.cname,N("SYNC_GROUP")?i:void 0),l=this.findPreloadMediaDesc(o);if(l){if(mt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,l.attributes.mid),n&&(n.twcc||n.remb)){let d=this.sessionDesc.mediaDescriptions.indexOf(l);return this.sessionDesc.mediaDescriptions[d]=this.mungSendMediaDesc(l,n),{mid:l.attributes.mid,needExchangeSDP:!0}}return{mid:l.attributes.mid,needExchangeSDP:!1}}{let d=this.findAvailableMediaIndex(e,o,r),u;return d===-1?(u=this.createOrRecycleSendMedia(e,o,a,"sendonly",r,n),this.updateBundleMids()):(u=vt(this.sessionDesc.mediaDescriptions[d]),u.attributes.direction="sendonly",u.attributes.ssrcs=o,u.attributes.ssrcGroups=a,this.sessionDesc.mediaDescriptions[d]=this.mungSendMediaDesc(u,n)),mt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,u.attributes.mid),{needExchangeSDP:!0,mid:u.attributes.mid}}}stopSending(e){let t=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&e.indexOf(i.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(i=>{i.attributes.ssrcs=[]}),this.updateBundleMids()}receive(e,t,i){let r=[];return e.forEach(n=>{let o=n._mediaStreamTrack.kind,a=this.findAvailableRecvMediaIndex(o),l,d=!1;a===-1?(d=!0,l=this.createOrRecycleRecvMedia(n,[],"recvonly",t,i),this.updateBundleMids()):(l=vt(this.sessionDesc.mediaDescriptions[a]),l.attributes.direction="recvonly"),r.push({mid:l.attributes.mid,needCreateTransceiver:d})}),r}stopReceiving(e){let t=this.sessionDesc.mediaDescriptions.filter(i=>e.indexOf(i.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(e){let{foundation:t,protocol:i,address:r,port:n,type:o,relatedAddress:a,relatedPort:l,priority:d}=new RTCIceCandidate(e),u={foundation:t??"",componentId:"1",transport:i??"",priority:d?d+"":"",connectionAddress:r??"",port:n?n+"":"",type:o?o+"":"",relAddr:a??"",relPort:l?l+"":"",extension:{}};this.candidates.some(p=>p.priority===u.priority&&p.connectionAddress===u.connectionAddress&&p.port===u.port)||(this._candidates.push(u),this.sessionDesc.mediaDescriptions.forEach(p=>{p.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,i,r,n){let o=e._mediaStreamTrack.kind,a=this.rtpCapabilities.recv,l=Rc(o,a,this.localCapabilities.send,o===me.AUDIO?n:r),d=o===me.VIDEO?a.videoExtensions:a.audioExtensions,u="".concat(++this.currentMidIndex),p={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map(f=>f.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};p=this.mungRecvMediaDsec(p,e);let m=this.findFirstClosedMedia(o);if(m){let f=this.sessionDesc.mediaDescriptions.indexOf(m);this.sessionDesc.mediaDescriptions[f]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}muteRemote(e){let t=this.sessionDesc.mediaDescriptions.filter(i=>se(e).call(e,i.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(e){let t=this.sessionDesc.mediaDescriptions.filter(i=>se(e).call(e,i.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(i=>{i.attributes.direction="recvonly"})}findAvailableMediaIndex(e,t,i){return this.sessionDesc.mediaDescriptions.findIndex(r=>{let n=r.media.mediaType===e&&r.media.port!=="0"&&(r.attributes.direction==="sendonly"||r.attributes.direction==="sendrecv")&&r.attributes.ssrcs.length===0;if(mt()){if(n){let o=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(o||r.attributes.mid!=="0"&&r.attributes.mid!=="1")||!(!o||o!==r.attributes.mid)}return!1}return n&&r.attributes.mid===i})}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex(t=>{let i=t.media.mediaType===e&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&i})}predictReceivingMids(e){let t=[];for(let i=0;i<e;i++)t.push((this.currentMidIndex+i+1).toString(10));return t}restartICE(e){e=vt(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}createOrRecycleSendMedia(e,t,i,r,n,o){let a=this.rtpCapabilities.send,l=e===me.VIDEO?a.videoCodecs:a.audioCodecs,d=e===me.VIDEO?a.videoExtensions:a.audioExtensions;mt()&&(n="".concat(++this.currentMidIndex));let u={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:n}};u=this.mungSendMediaDesc(u,o);let p=this.findFirstClosedMedia(e);if(p){let m=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[m]=u}else this.sessionDesc.mediaDescriptions.push(u);return u}mungRecvMediaDsec(e,t,i){let r=vt(e);return c_(r),la(r,t),l_(r,t),Tv(r),td(r,i,this.localCapabilities.send),r}mungSendMediaDesc(e,t){let i=vt(e);return td(i,t,this.localCapabilities.recv),So(i),i}updateRecvMedia(e,t){let i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(i!==-1){let r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],t);this.sessionDesc.mediaDescriptions[i]=r}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var i;return((i=t.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===e[0].ssrcId})}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>mt()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}},U9=["sdp"];var yt;function CL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function da(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?CL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):CL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let yL=(yt=class ud extends oN{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,i;return(t=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,i,r){super(t,i),y(this,"direction",void 0),y(this,"name",void 0),y(this,"store",void 0),y(this,"spec",void 0),y(this,"peerConnection",void 0),y(this,"initialOffer",void 0),y(this,"transport",void 0),y(this,"statsFilter",void 0),y(this,"localCandidateCount",0),y(this,"_isInRestartIce",!1),y(this,"mutex",new Ti("P2PConnection-mutex")),y(this,"onLocalCandidate",void 0),y(this,"remoteSDP",void 0),y(this,"pendingCandidates",[]),y(this,"localCapabilities",void 0),y(this,"isReady",!1),y(this,"restartCnt",0),y(this,"curTurnServerIndex",0),this.store=i,this.spec=t,this.peerConnection=new RTCPeerConnection(ud.resolvePCConfiguration(t,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=r??nr.SEND_ONLY,this.name=this.direction===nr.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=a_(this.peerConnection,N("STATS_UPDATE_INTERVAL"),void 0,mt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{let i=await Rv();if(this.localCapabilities=id(i),t){let{sdp:r}=t,n=P9(t,U9),o=function(){let p={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},m=ih(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),f={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},E={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},I={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Jn(m,p,"videoExtensions",f,E,I),Jn(m,p,"videoCodecs",f,E,I),Jn(m,p,"audioExtensions",f,E,I),Jn(m,p,"audioCodecs",f,E,I),N("RAISE_H264_BASELINE_PRIORITY")){let T=I.videoCodecs.findIndex(R=>R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&R.fmtp&&R.fmtp.parameters["profile-level-id"]==="42001f");if(T!==-1){let R=I.videoCodecs.findIndex(w=>w.rtpMap&&w.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(R<T){S.debug("raising H264 baseline profile priority");let w=I.videoCodecs[T];I.videoCodecs.splice(T,1),I.videoCodecs.splice(R,0,w)}R!==-1&&N("FILTER_SEND_H264_BASELINE")&&(f.videoCodecs=f.videoCodecs.filter(w=>!(w.rtpMap&&w.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&w.fmtp&&w.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:f,recv:E,sendrecv:I}}({},{},r);this.remoteSDP=new RL({remoteIceParameters:n.iceParameters,remoteDtlsParameters:n.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;let a=await this.peerConnection.createAnswer();if(!a.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");let l=go(a.sdp);await this.peerConnection.setLocalDescription(a);let d=await vL({},{},a.sdp);this.localCapabilities=id(d);let u=this.peerConnection.getTransceivers()[0];return u!=null&&u.receiver&&u.receiver.transport&&this.tryBindTransportEvents(u.receiver.transport),da(da({},l),{},{sdp:a.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});let r=await this.peerConnection.createOffer();if(!r.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let n=go(r.sdp);return this.initialOffer=r,da(da({},n),{},{sdp:r.sdp})}}catch(i){throw new j(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);let{sdp:i,iceParameters:r,dtlsParameters:n}=t,o=await vL({},{},i);this.remoteSDP=new RL({remoteIceParameters:r,remoteDtlsParameters:n,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});let a=this.peerConnection.getTransceivers()[0];a!=null&&a.sender&&a.sender.transport&&this.tryBindTransportEvents(a.sender.transport)}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i)}),this.pendingCandidates=[])}catch(i){throw new j(A.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(i.toString()))}}send(t,i,r){var n=this;return Vr(function*(){let o=yield Ue(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let a=[],l=n.remoteSDP.receive(t,i,r);t.forEach((R,w)=>{if(l[w].needCreateTransceiver){let O=n.peerConnection.addTransceiver(R._mediaStreamTrack,{direction:"sendonly"});a.push(O),R._updateRtpTransceiver(O)}else{let O=n.peerConnection.getTransceivers().find(P=>P.mid===l[w].mid);if(!O)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(l[w].mid));a.push(O),R._updateRtpTransceiver(O)}}),mt()&&N("SIMULCAST")===!0&&(yield Ue(n.applySimulcastForFirefox(a,t)));let d=l.map(R=>R.mid),u=yield Ue(n.peerConnection.createOffer()),p=n.mungSendOfferSDP(u.sdp,t,d),m=Nt.parse(p),f=d.map(R=>{let w=m.mediaDescriptions.find(O=>O.attributes.mid===R);if(!w)throw new Error("Cannot extract ssrc from mediaDescription.");return Sv(w,N("USE_PUB_RTX"))}),E=a.map((R,w)=>{let O=d[w];return{localSSRC:f[w],id:O}});yield Ue(n.peerConnection.setLocalDescription({type:"offer",sdp:p}));try{yield E}catch(R){let w=n.remoteSDP.toString();throw yield Ue(n.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield Ue(n.peerConnection.setRemoteDescription({type:"answer",sdp:w})),yield Ue(n.stopSending(d,!0)),R}yield Ue(n.applySimulcastEncodings(a,t)),yield Ue(n.applySendEncodings(a,t));let I=n.remoteSDP.toString(),T=n.logSDPExchange(p,"offer","local","send");return T==null||T(I),yield Ue(n.setRemoteDescription({type:"answer",sdp:I})),a.map((R,w)=>{let O=d[w];return{localSSRC:f[w],id:O}})}catch(a){throw a instanceof j?a:new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(a.toString()))}finally{o()}})()}async stopSending(t,i){let r=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let n=this.peerConnection.getTransceivers().filter(d=>t.indexOf(d.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length (".concat(n.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));n.map(d=>{var u;d.direction="inactive",(u=d.stop)===null||u===void 0||u.call(d)});let o=await this.peerConnection.createOffer(),a=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);let l=this.remoteSDP.toString();a==null||a(l),await this.setRemoteDescription({type:"answer",sdp:l})}catch(n){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}finally{r&&r()}}async receive(t,i,r,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));let{mid:o,needExchangeSDP:a}=this.remoteSDP.send(t,i,r,n);if(a){let d=this.remoteSDP.toString(),u=this.logSDPExchange(d,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:d});let p=await this.peerConnection.createAnswer(),m=this.mungReceiveAnswerSDP(p.sdp,o,t);u==null||u(m||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:m}),S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));let l=this.peerConnection.getTransceivers().find(d=>d.mid===o);if(!l||l.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:l.receiver.track,mid:l.mid,transceiver:l}}catch(o){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async mockReceive(t,i,r,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));let{mid:o,needExchangeSDP:a}=this.remoteSDP.send(t,i,r,n);if(a){let l=this.remoteSDP.toString(),d=this.logSDPExchange(l,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:l});let u=await this.peerConnection.createAnswer(),p=this.mungReceiveAnswerSDP(u.sdp,o,t);d==null||d(p||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:p}),S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(o){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);let i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:i});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===oc.Auto&&(this.store.p2pTransport=oc.SdRtn,Ye().supportPCSetConfiguration&&this.peerConnection.setConfiguration(ud.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Ye().supportPCSetConfiguration&&this.peerConnection.setConfiguration(ud.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;let i=await this.peerConnection.createOffer({iceRestart:!0});if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let{iceParameters:r}=go(i.sdp);return this.store.descriptionStart(),this.direction===nr.SEND_ONLY&&await this.peerConnection.setLocalDescription(i),r}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===nr.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});let i=await this.peerConnection.createAnswer();if(!i.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");let{iceParameters:r}=go(i.sdp);return await this.peerConnection.setLocalDescription(i),r}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let r=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(r.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);let o=this.remoteSDP.toString(),a=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),a==null||a(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new j(A.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,i){let r=this.peerConnection.getTransceivers().filter(n=>n.mid===t);r.length===1&&(this.isVP8Simulcast(i)?mt()||await this.applySimulcastEncodings(r,[i]):await this.applySendEncodings(r,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){let r=this.peerConnection.getTransceivers().find(n=>n.mid===i);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){let t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){let i=t[0].transport.iceTransport,{local:r,remote:n}=i.getSelectedCandidatePair();return{local:da(da({},Zo),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:da(da({},Zo),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t,i;se(t=["connected","completed"]).call(t,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(i=this.onICEConnectionStateChange)===null||i===void 0||i.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var i;t.candidate.candidate&&((i=this.onLocalCandidate)===null||i===void 0||i.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,i){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,n={iceServers:[]};var o;return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Rl(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...ud.turnServerConfigToIceServers(t.turnServer.servers,i,r)),N("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...ud.turnServerConfigToIceServers(t.turnServer.serversFromGateway,i,r)),se(o=[oc.Relay,oc.SdRtn]).call(o,i)&&(n.iceTransportPolicy="relay"),N("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(a=>{a.forceturn&&(n.iceTransportPolicy="relay")}))),N("ENABLE_ENCODED_TRANSFORM")&&Ye().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),S.debug("P2PConnection p2pTransport is ".concat(i)),n}static turnServerConfigToIceServers(t,i){let r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,n=[],o=t.filter(l=>l.tcpport);S.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(r));let a=o.length>r?o[r]:o[0];switch(i){case oc.SdRtn:let l=t.filter(u=>{var p;return se(p=u.username).call(p,"glb:")&&u.turnServerURL==u.turnServerURL}),d=l.length>r?l[r]:l[0];d&&(n.push({username:d.username,credential:d.password,credentialType:"password",urls:"turn:".concat(ta(d.turnServerURL),":").concat(d.tcpport,"?transport=udp")}),n.push({username:d.username,credential:d.password,credentialType:"password",urls:"turns:".concat(ta(d.turnServerURL),":").concat(d.tcpport,"?transport=tcp")}));break;case oc.Relay:a&&(n.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),n.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(ta(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}));break;default:a&&(n.push({username:a.username,credential:a.password,credentialType:"password",urls:"turn:".concat(a.turnServerURL,":").concat(a.tcpport,"?transport=udp")}),n.push({username:a.username,credential:a.password,credentialType:"password",urls:"turns:".concat(ta(a.turnServerURL),":").concat(a.tcpport,"?transport=tcp")}),n.push({username:a.username,credential:a.password,credentialType:"password",urls:"stun:".concat(a.turnServerURL,":").concat(a.tcpport)}))}return n}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var r;t!=null&&t.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,t.state))},t.onerror=r=>{var n;(n=this.onDTLSTransportError)===null||n===void 0||n.call(this,"error"in r?r.error:r)};let i=t.iceTransport;i&&(i.onstatechange=()=>{let r=t==null?void 0:t.iceTransport.state;var n;r&&((n=this.onICETransportStateChange)===null||n===void 0||n.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){let{local:r,remote:n}=i.getSelectedCandidatePair();S.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,i){var r;if(i||(i=this.peerConnection.getSenders().find(p=>p.track===t._mediaStreamTrack)),!i)return S.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return S.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ye().supportSetRtpSenderParameters)return S.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let n={},o={};switch(t._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(t._encoderConfig){var a;let{bitrateMax:p,frameRate:m,scaleResolutionDownBy:f}=t._encoderConfig;p&&(o.maxBitrate=1e3*p),se(a=t._hints).call(a,Rt.LOW_STREAM)&&(m&&(o.maxFramerate=Rr(m)),f&&f>=1&&(o.scaleResolutionDownBy=f))}if(N("DSCP_TYPE")&&qs()){var l;let p=N("DSCP_TYPE");se(l=["very-low","low","medium","high"]).call(l,p)&&(o.networkPriority=p)}let d=i.getParameters(),u=(r=d.encodings)===null||r===void 0?void 0:r[0];mt()&&!u&&(n.encodings=[o]),u&&Object.assign(u,o),Object.assign(d,n),S.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(d.encodings))),await i.setParameters(d)}async applySendEncodings(t,i){try{if(!Ye().supportSetRtpSenderParameters||t.length!==i.length)return;for(let r=0;r<t.length;r++){let n=t[r],o=i[r];o instanceof Et&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,n.sender)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i,r){let n=Nt.parse(t);return i.forEach((o,a)=>{let l=r[a],d=n.mediaDescriptions.find(u=>u.attributes.mid===l);d&&(la(d,o),vv(d,o,this.store.codec))}),Nt.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,r)=>{var n;(n=this.onFirstVideoDecoded)===null||n===void 0||n.call(this,t,i,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let d=0;d<t.length;d++){var r,n,o,a,l;let u=t[d],p=i[d];if(p instanceof Et&&!se(r=p._hints).call(r,Rt.LOW_STREAM)&&(n=p._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((o=p._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(a=p._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((l=p._scalabilityMode)===null||l===void 0?void 0:l.numSpatialLayers)>1&&this.store.codec==="vp8"){let m={},f={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{rid:"m",active:!0,maxBitrate:f.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:f.high}];let E=u.sender.getParameters();await u.sender.setParameters(Object.assign(E,m))}}}async applySimulcastEncodings(t,i){if(!mt()&&t.length===i.length)for(let r=0;r<t.length;r++){let n=i[r];if(n instanceof Et&&this.isVP8Simulcast(n)){let o=t[r],a={},l={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:l.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:l.medium,scaleResolutionDownBy:4}];let d=o.sender.getParameters();await o.sender.setParameters(Object.assign(d,a))}}}isVP8Simulcast(t){var i,r,n,o,a;return!!(t instanceof Et&&N("SIMULCAST")&&this.store.codec==="vp8"&&!se(i=t._hints).call(i,Rt.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((n=t._encoderConfig)===null||n===void 0?void 0:n.bitrateMax)>200&&(o=t._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=t._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1)}logSDPExchange(t,i,r,n){if(N("SDP_LOGGING"))return S.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(i," SDP during P2PConnection.").concat(n,`
`),t),i==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",n)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(a=>{a.direction="inactive"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);let o=this.remoteSDP.toString();n==null||n(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async a=>{a.direction="sendonly"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t);let o=this.remoteSDP.toString();n==null||n(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}async getRemoteSSRC(t,i){var r,n;if(i=(r=i)!==null&&r!==void 0?r:(n=this.currentRemoteDescription)===null||n===void 0?void 0:n.sdp){var o;let a=(o=Nt.parse(i).mediaDescriptions.find(l=>l.attributes.mid===t))===null||o===void 0?void 0:o.attributes.ssrcs;return a==null?void 0:a[0].ssrcId}}async setRemoteDescription(t){var i;await this.peerConnection.setRemoteDescription(t),se(i=["connected","completed"]).call(i,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,i,r){let n=Nt.parse(t),o=n.mediaDescriptions.find(a=>a.attributes.mid===i);return o&&r===me.AUDIO&&o.media.mediaType==="audio"&&So(o),Nt.print(n)}},ie(yt.prototype,"establish",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"establish"),yt.prototype),ie(yt.prototype,"connect",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"connect"),yt.prototype),ie(yt.prototype,"receive",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"receive"),yt.prototype),ie(yt.prototype,"mockReceive",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"mockReceive"),yt.prototype),ie(yt.prototype,"stopReceiving",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"stopReceiving"),yt.prototype),ie(yt.prototype,"restartICE",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"restartICE"),yt.prototype),ie(yt.prototype,"close",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"close"),yt.prototype),ie(yt.prototype,"updateEncoderConfig",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"updateEncoderConfig"),yt.prototype),ie(yt.prototype,"updateSendParameters",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"updateSendParameters"),yt.prototype),ie(yt.prototype,"replaceTrack",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"replaceTrack"),yt.prototype),ie(yt.prototype,"muteLocal",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"muteLocal"),yt.prototype),ie(yt.prototype,"unmuteLocal",[Xn],Object.getOwnPropertyDescriptor(yt.prototype,"unmuteLocal"),yt.prototype),yt);function Xn(e,t,i){let r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let n=this.mutex,o=await n.lock("From P2PConnection.".concat(t));try{for(var a=arguments.length,l=new Array(a),d=0;d<a;d++)l[d]=arguments[d];return await r.apply(this,l)}finally{o()}},i}function yv(e,t){let i=document.createElement("video"),r=document.createElement("canvas");i.setAttribute("style","display:none"),r.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),r.width=Rr(t.width),r.height=Rr(t.height);let n=Rr(t.framerate||15);document.body.append(i),document.body.append(r);let o=e._mediaStreamTrack;i.srcObject=new MediaStream([o]),i.play();let a=r.getContext("2d");if(!a)throw new U(A.UNEXPECTED_ERROR,"can not get canvas context");let l=Ye(),d=r.captureStream(l.supportRequestFrame?0:n).getVideoTracks()[0];d.canvas||(d.canvas=r),r.startCapture=()=>{if(!i)return r.stopCapture&&r.stopCapture();if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){let p=i.videoWidth,m=i.videoHeight/p,f=r.width*m;Math.abs(f-r.height)>=2&&(S.debug("adjust low stream resolution","".concat(r.width,"x").concat(r.height," -> ").concat(r.width,"x").concat(f)),r.height=f)}a.drawImage(i,0,0,r.width,r.height),d.requestFrame&&d.requestFrame(),o!==e._mediaStreamTrack&&(o=e._mediaStreamTrack,i.srcObject=new MediaStream([o]))},r.stopCapture=ov(()=>r.startCapture&&r.startCapture(),n);let u=d.stop;return d.stop=()=>{u.call(d),i&&(i.remove(),i.srcObject=null,i=null),r&&(r.width=0,r.remove(),r.stopCapture&&r.stopCapture(),r.startCapture=void 0,r.stopCapture=void 0,r=null),S.debug("clean low stream renderer")},d}var u_=function(e){return e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH",e}(u_||{}),fi=function(e){return e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM",e}(fi||{}),Cc=function(e){return e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH",e}(Cc||{}),Ki=function(e){return e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY",e}(Ki||{}),yc=function(e){return e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",e[e.FREEZE_DURATION=2156]="FREEZE_DURATION",e}(yc||{}),IL=function(e){return e[e.PCM_LEVEL=2104]="PCM_LEVEL",e}(IL||{}),ua=function(e){return e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED",e}(ua||{}),Qn=function(e){return e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",e}(Qn||{}),wL=function(e){return e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL",e}(wL||{}),Tn=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e}(Tn||{});let Rs=1e3,Ic=3;function Ve(e,t,i){i!=null&&Number.isFinite(i)&&(e[t]=Math.round(Math.max(0,i)))}function AL(e){let t={[Tn.CONN_TYPE]:0,[Tn.RTT]:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{let i=e.selectedCandidatePair.localCandidate.relayProtocol;i==="udp"&&(t[Tn.CONN_TYPE]=1),i==="tcp"&&(t[Tn.CONN_TYPE]=3),i==="tls"&&(t[Tn.CONN_TYPE]=4);break}case"srflx":t[Tn.CONN_TYPE]=2}return t}function OL(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class bL extends Ot{constructor(t){super(),y(this,"store",void 0),y(this,"uploadWRTCStatsTimer",void 0),y(this,"uploadOutboundDenoiserStatsTimer",void 0),y(this,"uploadExtStatsTimer",void 0),y(this,"uploadExtUsageStatsTimer",void 0),y(this,"uploadInboundExtStatsTimer",void 0),y(this,"requestStats",void 0),y(this,"requestTransportStats",void 0),y(this,"requestLocalMedia",void 0),y(this,"requestRemoteMedia",void 0),y(this,"requestAllTracks",void 0),y(this,"requestVideoIsReady",void 0),y(this,"requestUploadStats",void 0),y(this,"requestUpload",void 0),y(this,"uploadOutboundStarted",!1),y(this,"uploadInboundStarted",!1),y(this,"uploadTransportStarted",!1),y(this,"uploadExtensionUsageStarted",!1),y(this,"lastRecvStats",void 0),y(this,"lastSendStats",void 0),y(this,"lastFullRecvStats",void 0),y(this,"lastFullSendStats",void 0),y(this,"needUploadRenderFreezeTime",!0),this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;let i,r;if(this.uploadTransportStarted&&(i=this.requestStats(),this.store.useP2P&&(r=this.requestStats(!0))),!i&&this.uploadOutboundStarted&&(i=this.requestStats()),!r&&this.uploadInboundStarted&&(r=this.requestStats(!0)),i||r){let n={};if(this.uploadTransportStarted&&i){let o=this.getTransportStats(i,r,t);o&&(n.misc=[o])}if(this.uploadOutboundStarted&&i){let o=this.getOutboundStats(i,t?this.lastSendStats:this.lastFullSendStats,t);o&&(n.outbound=[o])}if(this.uploadInboundStarted&&r){let o=this.getInboundStats(r,t?this.lastRecvStats:this.lastFullRecvStats,t);o&&(n.inbound=o)}this.requestUploadStats(n)}this.lastRecvStats=r,this.lastSendStats=i,t||(this.lastFullRecvStats=r,this.lastFullSendStats=i)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let t=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(t!==Ic),++t===Ic+1&&(t=1)},Rs)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(t,i,r){if(!this.requestStats)return;if(r)return t.rtt==null?void 0:{addition:{[Tn.RTT]:t.rtt,[Tn.CONN_TYPE]:void 0}};let n=AL(t);if(this.store.useP2P){if(i){let o=AL(i);n[Tn.CONN_TYPE]+=o[Tn.CONN_TYPE]<<3}n[Tn.CONN_TYPE]+=110}else n[Tn.CONN_TYPE]+=100;return{addition:n}}getOutboundStats(t,i,r){if(!this.requestUploadStats||!this.requestLocalMedia)return;let n=this.requestLocalMedia();if(!n||n.length===0)return;let o,a,l;return n.forEach(d=>{let[u,{track:p,ssrcs:m}]=d;switch(u){case Q.LocalVideoLowTrack:case Q.LocalVideoTrack:if(u===Q.LocalVideoTrack){let f=function(T,R,w,O,P){let M=R.videoSend.find(pe=>pe.ssrc===T);if(!M)return;let V={},{sentFrame:F,inputFrame:Y}=M;if(Y&&F){let pe=Y.frameRate,Ke=F.frameRate;V[fi.FREEZE]=function(rt,Ct){let Zt=!0;return Zt=!(rt<=5)&&(rt<=10?Ct<3:rt<=20?Ct<4:Ct<5),Zt}(pe,Ke)?1:0}if(Ve(V,fi.QP_SUM,M.qpSumPerFrame),P)return V;switch(F&&(Ve(V,fi.HEIGHT,F.height),Ve(V,fi.WIDTH,F.width),Ve(V,fi.FRAME_RATE,F.frameRate)),V[fi.DISABLED]=O._originMediaStreamTrack&&!O._originMediaStreamTrack.enabled||O._mediaStreamTrack&&!O._mediaStreamTrack.enabled?1:0,M.adaptionChangeReason){case"none":V[fi.ADAPTATION]=0;break;case"cpu":V[fi.ADAPTATION]=1;break;case"bandwidth":V[fi.ADAPTATION]=2;break;case"other":V[fi.ADAPTATION]=3}let J=0;M.adaptionChangeReason&&(J+=OL(M.adaptionChangeReason)),R.qualityLimitationReason&&(J+=OL(R.qualityLimitationReason)<<3),V[fi.ADAPTATION]=J,V[fi.PLAYER_STATUS]=rv[O._player?O._player.videoElementStatus:"uninit"],Ve(V,fi.NACKS,M.nacksCount),Ve(V,fi.PLIS,M.plisCount),Ve(V,fi.FIRS,M.firsCount),Ve(V,fi.AVG_ENCODE,M.avgEncodeMs);let Z=w&&w.videoSend.find(pe=>pe.ssrc===T);if(Z){let pe=P?Rs:Rs*Ic;Z.timestamp&&M.timestamp&&(pe=M.timestamp-Z.timestamp),Z.packets!=null&&M.packets!=null&&Ve(V,fi.PACKAGE_RATE,1e3*(M.packets-Z.packets)/pe),M.packetsLost!=null&&Z.packetsLost!=null&&Ve(V,fi.PACKAGE_LOST,M.packetsLost-Z.packetsLost),Z.bytes!=null&&M.bytes!=null&&Ve(V,fi.BITRATE,8*(M.bytes-Z.bytes)/pe)}return V}(m[0].ssrcId,t,i,p,r),E=r?null:function(T,R,w){let O=R.videoSend.find(J=>J.ssrc===T);if(!O)return null;let P={},M=O.inputFrame,V=M&&M.height||w&&w.videoHeight||0,F=M&&M.width||w&&w.videoWidth||0,Y=M&&M.frameRate||0;return Ve(P,u_.HEIGHT,V),Ve(P,u_.WIDTH,F),Ve(P,u_.FRAME_RATE,Y),P}(m[0].ssrcId,t,p),I=r?null:function(T){let R={};return Ve(R,fi.RETRANSMIT,T.bitrate.retransmit),Ve(R,fi.TARGET_ENCODED,T.bitrate.targetEncoded),Ve(R,fi.ACTUAL_ENCODED,T.bitrate.actualEncoded),Ve(R,fi.TRANSMIT,T.bitrate.transmit),Ve(R,fi.BANDWIDTH,T.sendBandwidth),R}(t);a=Object.assign({},f,E,I)}else l=r?void 0:function(f,E,I){let T=E.videoSend.find(O=>O.ssrc===f);if(!T)return;let R={},w=T.sentFrame;if(w&&(Ve(R,Cc.HEIGHT,w.height),Ve(R,Cc.WIDTH,w.width),Ve(R,Cc.FRAME_RATE,w.frameRate)),I){let O=I.videoSend.find(P=>P.ssrc===f);if(O){let P=Rs*Ic;O.timestamp&&T.timestamp&&(P=T.timestamp-O.timestamp),O.packets!=null&&T.packets!=null&&Ve(R,Cc.PACKAGE_RATE,1e3*(T.packets-O.packets)/P),T.packetsLost!=null&&O.packetsLost!=null&&Ve(R,Cc.PACKAGE_LOST,T.packetsLost-O.packetsLost),O.bytes!=null&&T.bytes!=null&&Ve(R,Cc.BITRATE,8*(T.bytes-O.bytes)/P)}}return R}(m[0].ssrcId,t,i);break;case Q.LocalAudioTrack:o=r?void 0:function(f,E,I,T){let R=E.audioSend.find(V=>V.ssrc===f);if(!R)return;let w={};w[ua.DISABLED]=T._originMediaStreamTrack&&!T._originMediaStreamTrack.enabled||T._mediaStreamTrack&&!T._mediaStreamTrack.enabled?1:0;let O=100*T._source.getAccurateVolumeLevel(),P=R.inputLevel;if(P!=null){let V=Math.ceil(50*Math.log10(100*P+1));Ve(w,ua.LEVEL,V)}Ve(w,IL.PCM_LEVEL,O),Ve(w,ua.AEC_RETURN_LOSS,R.aecReturnLoss),Ve(w,ua.AEC_RETURN_LOSS_ENH,R.aecReturnLossEnhancement),w[ua.FREEZE]=0;let M=I&&I.audioSend.find(V=>V.ssrc===f);if(M){let V=Rs*Ic;M.timestamp&&R.timestamp&&(V=R.timestamp-M.timestamp),M.bytes!=null&&R.bytes!=null&&Ve(w,ua.BITRATE,8*(R.bytes-M.bytes)/V),M.packets!=null&&R.packets!=null&&Ve(w,ua.PACKAGE_RATE,1e3*(R.packets-M.packets)/V)}return w}(m[0].ssrcId,t,i,p)}}),{high:a,low:l,audio:o}}getInboundStats(t,i,r){if(!this.requestRemoteMedia)return;let n=this.requestRemoteMedia()||[],o=[];return n.forEach(a=>{let[l,d]=a,u={peer:l.uid};if(d.has(me.VIDEO)&&l.videoTrack){let p=l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)||!1,m=l.videoTrack?function(f,E,I,T,R,w,O){var P;let M=E.videoRecv.find(Ke=>Ke.ssrc===f);if(!M)return;let V={},{receivedFrame:F,outputFrame:Y,decodeFrameRate:J}=M,Z=I&&I.videoRecv.find(Ke=>Ke.ssrc===f);if(V[Ki.FREEZE]=R&&rh.isRemoteVideoFreeze(T,M,Z)?1:0,Ve(V,yc.FRAME_RATE_DECODE,J),Ve(V,Ki.QP_SUM,M.qpSumPerFrame),M.framesRateFirefox&&Ve(V,Ki.FRAME_RATE,M.framesRateFirefox),F&&Ve(V,Ki.FRAME_RATE,F.frameRate),Z){let Ke=E.timestamp-I.timestamp||(O?Rs:Ic*Rs);M.packetsLost!=null&&Z.packetsLost!=null&&Ve(V,Ki.PACKAGE_LOST,M.packetsLost-Z.packetsLost),Z.bytes!=null&&M.bytes!=null&&Ve(V,Ki.BITRATE,8*(M.bytes-Z.bytes)/Ke),Z.packets!=null&&M.packets!=null&&Ve(V,Ki.PACKAGE_RATE,1e3*(M.packets-Z.packets)/Ke)}if(O)return V;F?(Ve(V,Ki.HEIGHT,F.height),Ve(V,Ki.WIDTH,F.width)):T&&(Ve(V,Ki.HEIGHT,T._videoHeight||0),Ve(V,Ki.WIDTH,T._videoWidth||0)),Y&&Ve(V,yc.FRAME_RATE_OUTPUT,Y.frameRate);let pe=(P=T._player)===null||P===void 0?void 0:P.rendFrameRate.toFixed(0);if(pe&&Ve(V,yc.FRAME_RATE_RENDER,+pe),Ve(V,Ki.JITTER_BUFFER,M.jitterBufferMs),Ve(V,Ki.CURRENT_DELAY,M.currentDelayMs),Ve(V,Ki.FIRS,M.firsCount),Ve(V,Ki.NACKS,M.nacksCount),Ve(V,Ki.PLIS,M.plisCount),T){V[Ki.DISABLED]=T._originMediaStreamTrack.enabled&&T._mediaStreamTrack.enabled?0:1;let Ke=T._player;if(Ke){let{freezeTimeCounterList:rt,renderFreezeAccTime:Ct,videoElementStatus:Zt}=Ke;if(rt&&rt.length>0&&Ve(V,yc.FREEZE_TIME,rt.splice(0,1)[0]),w&&vs.visibility==="visible"&&Zt===Qi.PLAYING&&Ye().supportRequestVideoFrameCallback){let Mt=Math.min(6e3,Ct);Ke.renderFreezeAccTime=Math.max(0,Ct-Mt),Ve(V,yc.FREEZE_TIME_RENDER,Mt)}if(typeof M.totalFreezesDuration=="number"){let Mt=Z&&Z.totalFreezesDuration?M.totalFreezesDuration-Z.totalFreezesDuration:M.totalFreezesDuration;Ve(V,yc.FREEZE_DURATION,1e3*Mt)}}}if(V[Ki.PLAYER_STATUS]=rv[T._player?T._player.videoElementStatus:"uninit"],Z&&M.totalInterFrameDelay!==void 0&&M.totalSquaredInterFrameDelay!==void 0&&Z.totalInterFrameDelay!==void 0&&Z.totalSquaredInterFrameDelay!==void 0){let Ke=M.totalInterFrameDelay-Z.totalInterFrameDelay,rt=M.totalSquaredInterFrameDelay-Z.totalSquaredInterFrameDelay,Ct=M.framesDecodeCount-Z.framesDecodeCount,Zt=Ke/Ct*1e3,Mt=Math.round(1e3*Math.sqrt((rt-Math.pow(Ke,2)/Ct)/Ct));!isNaN(Mt)&&Zt+Mt>Math.max(3*Zt,Zt+150)&&(V[Ki.I_FRAME_DELAY]=Mt)}return V}(l._videoSSRC,t,i,l.videoTrack,p===!0,this.needUploadRenderFreezeTime,r):void 0;m&&(u.video=m)}if(d.has(me.AUDIO)&&l.audioTrack){let p=l.audioTrack?function(m,f,E,I,T){let R=f.audioRecv.find(Z=>Z.ssrc===m);if(!R)return;let w={},O=E&&E.audioRecv.find(Z=>Z.ssrc===m),{receivedFrames:P,droppedFrames:M}=R;var V,F;if(Ve(w,Qn.JITTER,R.jitterMs),P!=null&&M!=null&&(w[Qn.FREEZE]=(F=M,(V=P)===0||100*F/V>20?1:0)),O){let Z=f.timestamp-E.timestamp||(T?Rs:Rs*Ic);R.packets!=null&&O.packets!=null&&Ve(w,Qn.PACKAGE_RATE,1e3*(R.packets-O.packets)/Z),O.bytes!=null&&R.bytes!=null&&Ve(w,Qn.BITRATE,8*(R.bytes-O.bytes)/Z),R.packetsLost!=null&&O.packetsLost!=null&&Ve(w,Qn.PACKAGE_LOST,R.packetsLost-O.packetsLost)}if(T)return w;let Y=100*I._source.getAccurateVolumeLevel(),J=R.outputLevel;if(J!=null){let Z=Math.ceil(50*Math.log10(100*J+1));Ve(w,wL.LEVEL,Z)}if(Ve(w,Qn.PCM_LEVEL,Y),I&&(w[Qn.DISABLED]=I._originMediaStreamTrack.enabled&&I._mediaStreamTrack.enabled?0:1),Ve(w,Qn.JITTER_BUFFER,R.jitterBufferMs),Ve(w,Qn.CURRENT_DELAY,R.jitterBufferMs),w[Qn.PLAYER_STATUS]=rv[pr.getPlayerState(I.getTrackId())],O){let Z=R.concealedSamples-O.concealedSamples;Z>0&&Ve(w,Qn.CONCEALED_SAMPLES,Z)}return w}(l._audioSSRC,t,i,l.audioTrack,r):void 0;p&&(u.audio=p)}(u.video||u.audio)&&o.push(u)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;let t=(this.requestAllTracks()||[]).find(i=>i instanceof i_);if(t&&t._external.getDenoiserStats){let i=t._external.getDenoiserStats();i&&this.requestUpload(ac.DENOISER_STATS,i)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(t=>{t.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(t=>{let[i,r]=t;r.has(me.VIDEO)&&i.videoTrack&&i.videoTrack.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)}),r.has(me.AUDIO)&&i.audioTrack&&i.audioTrack.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);let t=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{let i=Date.now(),r={connectionInterval:N("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:i},n=[],o=this.requestAllTracks&&this.requestAllTracks()||[];for(let u of o)!u.muted&&u.enabled&&(n=n.concat(await u.getProcessorUsage()));let a=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(let[u,p]of a)p.has(me.VIDEO)&&u.videoTrack&&(n=n.concat(await u.videoTrack.getProcessorUsage())),p.has(me.AUDIO)&&u.audioTrack&&(n=n.concat(await u.audioTrack.getProcessorUsage()));if(n.length===0)return;r.details=function(u,p){let m={};for(let{id:T,value:R,level:w,direction:O}of u){var f;let P=(f=p.get(T))!==null&&f!==void 0?f:0,M=R===2?P+N("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:P;var E,I;p.set(T,M),m[T]?(R===2&&(m[T].value=R),w>m[T].level&&(m[T].level=w),O==="remote"&&(m[T].remoteUidCount+=1),m[T].totalTs=(E=p.get(T))!==null&&E!==void 0?E:0):m[T]={value:R,level:w,remoteUidCount:O==="local"?0:1,totalTs:(I=p.get(T))!==null&&I!==void 0?I:0}}return Object.keys(m).map(T=>{let{level:R,value:w,totalTs:O}=m[T];return{id:T,level:R,value:w,totalTs:O}})}(n,t);let l=Date.now(),d=l>i?l:i+1;this.requestUpload&&this.requestUpload(ac.EXTENSION_USAGE_STATS,{usageStats:r,sendTs:d})},N("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class ha{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,i){y(this,"uid",void 0),y(this,"_uintid",void 0),y(this,"_trust_in_room_",!0),y(this,"_trust_audio_enabled_state_",!0),y(this,"_trust_video_enabled_state_",!0),y(this,"_trust_audio_mute_state_",!0),y(this,"_trust_video_mute_state_",!0),y(this,"_audio_muted_",!1),y(this,"_video_muted_",!1),y(this,"_audio_enabled_",!0),y(this,"_video_enabled_",!0),y(this,"_audio_added_",!1),y(this,"_video_added_",!1),y(this,"_is_pre_created",!1),y(this,"_video_pre_subscribed",!1),y(this,"_audio_pre_subscribed",!1),y(this,"_trust_video_stream_added_state_",!0),y(this,"_trust_audio_stream_added_state_",!0),y(this,"_audioTrack",void 0),y(this,"_videoTrack",void 0),y(this,"_dataChannels",[]),y(this,"_audioSSRC",void 0),y(this,"_videoSSRC",void 0),y(this,"_audioOrtc",void 0),y(this,"_videoOrtc",void 0),y(this,"_cname",void 0),y(this,"_rtxSsrcId",void 0),y(this,"_videoMid",void 0),y(this,"_audioMid",void 0),this.uid=t,this._uintid=i}}let To=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});function x9(e,t){var i;let r;switch(t){case Q.LocalAudioTrack:r=ot.Audio;break;case Q.LocalVideoTrack:r=se(i=e._hints).call(i,Rt.SCREEN_TRACK)?ot.Screen:ot.High;break;case Q.LocalVideoLowTrack:r=ot.Low}return r}function Iv(e){let t=Ye();if(e.some(i=>i._bypassWebAudio))throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function wv(e,t){Iv(e);let i=new ai;return e.forEach(r=>i.addAudioTrack(r)),i}var NL,DL,PL,kL,LL,ML,UL,xL,VL,FL,jL,Dt;function BL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function h_(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?BL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):BL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let Fr=(NL=vo(To.SEND_ONLY),DL=vo(To.SEND_ONLY),PL=vo(),kL=vo(To.RECEIVE_ONLY),LL=vo(To.RECEIVE_ONLY),ML=vo(To.RECEIVE_ONLY),UL=vo(To.RECEIVE_ONLY),xL=vo(To.RECEIVE_ONLY),VL=vo(To.RECEIVE_ONLY),FL=vo(),jL=vo(To.RECEIVE_ONLY),Dt=class extends Ot{get state(){return this._state}set state(e){let t=this._state;this._state=e,this.emit(ye.StateChange,t,this._state)}constructor(e,t){super(),y(this,"store",void 0),y(this,"statsUploader",void 0),y(this,"sendConnection",void 0),y(this,"recvConnection",void 0),y(this,"localTrackMap",new Map),y(this,"remoteUserMap",new Map),y(this,"localDataChannels",[]),y(this,"pendingLocalTracks",[]),y(this,"pendingRemoteTracks",[]),y(this,"statsCollector",void 0),y(this,"dtlsFailedCount",0),y(this,"sendMutex",new Ti("P2PChannel2-send-mutex")),y(this,"recvMutex",new Ti("P2PChannel2-recv-mutex")),y(this,"_state",st.Disconnected),y(this,"_restartStates",["disconnected","failed"]),y(this,"reconnectInterval",void 0),y(this,"uploadUnplinkStarted",!1),y(this,"uploadDownlinkStarted",!1),y(this,"uplinkStateUploadInterval",void 0),y(this,"downlinkStatsUploadInterval",void 0),y(this,"handleMuteLocalTrack",async(i,r,n)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==st.Connected)return void n(new j(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));let d=this.filterTobeMutedTracks(i);if(d.length===0)return void r();let u=d.find(E=>E[0]==="videoLowTrack");u&&u[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(d.map(E=>{let[,{id:I}]=E;return I}));let p=!1;var a,l;i.trackMediaType==="video"?p=!((a=this.localTrackMap.get(Q.LocalAudioTrack))===null||a===void 0||!a.track._muted):p=((l=this.localTrackMap.get(Q.LocalVideoTrack))===null||l===void 0?void 0:l.id)===void 0;let m=this.createMuteMessage(d);await _t(this,ye.RequestMuteLocal,m);let f=i.trackMediaType==="video"?ea.MUTE_LOCAL_VIDEO:ea.MUTE_LOCAL_AUDIO;await _t(this,ye.RequestP2PMuteLocal,{action:f,message:m,isMuteAll:p}),r()}catch(d){n(d)}finally{o()}}),y(this,"handleUnmuteLocalTrack",async(i,r,n)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==st.Connected)return void n(new j(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));let a=this.filterTobeUnmutedTracks(i);if(a.length===0)return void r();await this.sendConnection.unmuteLocal(a.map(u=>{let[,{id:p}]=u;return p}));let l=this.createUnmuteMessage(a),d=i.trackMediaType==="video"?ea.UNMUTE_LOCAL_VIDEO:ea.UNMUTE_LOCAL_AUDIO;await _t(this,ye.RequestP2PMuteLocal,{action:d,message:l}),r()}catch(a){n(a)}finally{o()}}),y(this,"handleUpdateVideoEncoder",async(i,r,n)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{let a=this.localTrackMap.get(Q.LocalVideoTrack);if(!this.sendConnection||!a||a.track!==i||this.state!==st.Connected)return void r();let{id:l,track:d}=a;l&&(await this.sendConnection.updateSendParameters(l,d),await this.sendConnection.updateEncoderConfig(l,d),this.emit(ye.UpdateVideoEncoder,d)),r()}catch(a){n(a)}finally{o()}}),y(this,"handleUpdateVideoSendParameters",async(i,r,n)=>{let o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{let a=this.localTrackMap.get(Q.LocalVideoTrack);if(!this.sendConnection||!a||a.track!==i||this.state!==st.Connected)return void r();let{id:l,track:d}=a;l&&await this.sendConnection.updateSendParameters(l,d),r()}catch(a){n(a)}finally{o()}}),y(this,"handleReplaceTrack",async(i,r,n,o)=>{let a;S.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var l;let u=Array.from(this.localTrackMap.entries()).find(p=>{let[,{track:m}]=p;return i===m});if(!this.sendConnection||!u||u[1].id===void 0||this.state!==st.Connected)return void r();if(await((l=this.sendConnection)===null||l===void 0?void 0:l.replaceTrack(i,u[1].id)),u[0]===Q.LocalVideoTrack&&Ye().supportDualStreamEncoding){let p=this.localTrackMap.get(Q.LocalVideoLowTrack);if(p){let m=i._mediaStreamTrack.clone();p.track._originMediaStreamTrack.stop(),p.track._mediaStreamTrack=m,p.track._originMediaStreamTrack=m,await new ne((f,E)=>{this.handleReplaceTrack(p.track,f,E,!0)})}}r()}catch(u){n(u)}finally{var d;(d=a)===null||d===void 0||d()}}),y(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),y(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),y(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),y(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new bL(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(i=>{i&&(i.iceConnectionState!=="disconnected"&&i.iceConnectionState!=="failed"||this.handleDisconnect(i.direction))})},N("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new j(A.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,i,r,n,o){throw new j(A.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let i;try{if(t){this.recvConnection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),i=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new yL(e,this.store,nr.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);let r=await this.recvConnection.establish(t);return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}{this.state=st.New,this.sendConnection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),i=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new yL(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);let r=await this.sendConnection.establish();return{iceParameters:r.iceParameters,dtlsParameters:r.dtlsParameters,sdp:r.sdp}}}finally{i&&i()}}async p2pConnect(e){if(!this.sendConnection)throw new j(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=st.Connected}async addRemoteCandidate(e,t){if(t===nr.RECEIVE_ONLY){if(!this.sendConnection)throw new j(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new j(A.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,i){var r=this;return Vr(function*(){let n=yield Ue(r.sendMutex.lock("From P2PChannel.publish"));try{if(!r.sendConnection||r.state!==st.Connected){r.throwIfTrackTypeNotMatch(e);let u=e.filter(p=>r.pendingLocalTracks.indexOf(p)===-1);return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(u))}r.store.pubId=r.store.pubId+1,Gi.markPublishStart(r.store.clientId,r.store.pubId);let o=r.filterTobePublishedTracks(e,t,i);if(o.length===0)return void(yield Ue(r.tryToUnmuteAudio(e)));o.forEach(u=>{let{track:p,type:m}=u,f=Date.now();r.store.publish(p.getTrackId(),m===Q.LocalAudioTrack?"audio":"video",f)}),r.bindLocalTrackEvents(o);let a=yield Ue(r.sendConnection.send(o.map(u=>{let{track:p}=u;return p}),r.store.codec,r.store.audioCodec)),l=(yield Ue(a.next())).value,d=r.createGatewayPublishMessage(o,l);try{yield d}catch(u){throw a.throw(u),(u==null?void 0:u.code)===A.WS_ABORT&&o.forEach(p=>{let{track:m}=p;r.pendingLocalTracks.indexOf(m)===-1&&r.pendingLocalTracks.push(m)}),r.unbindLocalTrackEvents(o),u}yield Ue(a.next()),o.forEach(u=>{let{type:p}=u;r.statsCollector.addLocalStats(p)}),r.statsUploader.startUploadOutboundStats(),r.assignLocalTracks(o,l),o.forEach(u=>{let{track:p,type:m}=u,f=Date.now();r.store.publish(p.getTrackId(),m===Q.LocalAudioTrack?"audio":"video",void 0,f)}),r.startUploadUplinkState()}finally{n()}})()}async unpublish(e){if(!this.sendConnection||this.state!==st.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(n=>!se(e).call(e,n)));let t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;let i=t.find(n=>n[0]==="videoLowTrack");i&&i[1].track.close();let r=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map(n=>{let[,{id:o}]=n;return o})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(n=>{let[o,{track:a}]=n;return{type:o,track:a}})),t.forEach(n=>{let[o]=n;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===st.Connected)return i&&i[1].track.close(),r;e.forEach(n=>{let o=this.pendingLocalTracks.indexOf(n);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);let e=()=>{let t=[],i=[];Array.from(this.localTrackMap.entries()).forEach(r=>{let[n,{track:o,ssrcs:a}]=r,l={stream_type:x9(o,n),ssrcs:a};o._muted||!o._enabled?t.push(l):i.push(l)}),t.length>0&&t.forEach(r=>{_t(this,ye.RequestMuteLocal,[r])}),i.length>0&&i.forEach(r=>{_t(this,ye.RequestUnmuteLocal,[r])})};e(),this.uplinkStateUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return Vr(function*(){throw new j(A.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(S.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await ti(this,ye.RequestRePublish,this.pendingLocalTracks),this.emit(ye.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new j(A.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,i,r){var n;if(!this.recvConnection)throw new j(A.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((n=this.remoteUserMap.get(e))!==null&&n!==void 0&&n.has(t))return;let{track:o,mid:a,transceiver:l}=await this.recvConnection.receive(t,[{ssrcId:i}],String(e.uid),r);t===me.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new ed(o,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),l&&e._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=i,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new $l(o,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),l&&e._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(e,e._videoTrack));let d=this.remoteUserMap.get(e);d?d.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();let u=this.pendingRemoteTracks.findIndex(p=>{let{user:m,kind:f}=p;return m.uid===e.uid&&t===f});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(ye.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,i,r){if(!this.recvConnection)throw new j(A.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:i}],String(e.uid),r)}async unsubscribe(e,t,i){let r=this.pendingRemoteTracks.filter(o=>{let{user:a,kind:l}=o;return t!==void 0?a.uid===e.uid&&t===l:a.uid===e.uid});if(r.forEach(o=>{let a=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(a,1)}),this.recvConnection||i||r.forEach(o=>{let{kind:a}=o;var l;if(a===me.AUDIO)(l=e._audioTrack)===null||l===void 0||l._destroy(),e._audioTrack=void 0;else if(a===me.VIDEO){var d;(d=e._videoTrack)===null||d===void 0||d._destroy(),e._videoTrack=void 0}}),!this.recvConnection)return;let n=this.filterTobeUnSubscribedTracks(e,t);n.length!==0&&(await this.recvConnection.stopReceiving(n.map(o=>{let[,{id:a}]=o;return a})),this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),n.forEach(o=>{let[a,{kind:l}]=o;var d,u;if(l===me.VIDEO&&a._videoSSRC&&((d=this.recvConnection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),l===me.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),i||((u=a._videoTrack)===null||u===void 0||u._destroy(),a._videoTrack=void 0);else if(l===me.AUDIO){var p;this.unbindRemoteTrackEvents(a._audioTrack),!i&&((p=a._audioTrack)===null||p===void 0||p._destroy(),a._audioTrack=void 0)}}),n.forEach(o=>{let[,{kind:a}]=o;_t(this,ye.RequestP2PMuteRemote,a)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let e=()=>Array.from(this.remoteUserMap.entries()).forEach(t=>{let[,i]=t;[me.VIDEO,me.AUDIO].forEach(r=>{i.has(r)?_t(this,ye.RequestP2PUnmuteRemote,r):_t(this,ye.RequestP2PMuteRemote,r)})});e(),this.downlinkStatsUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new j(A.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new j(A.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new j(A.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new j(A.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;let i=this.remoteUserMap.get(e);if(!i)return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!i.get(t))return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));let r=t===me.VIDEO?e._videoSSRC:e._audioSSRC;r!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;let i=this.remoteUserMap.get(e);if(!i)return void S.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));i.get(t)||S.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){let t=this.localTrackMap.get(Q.LocalAudioTrack);if((t==null?void 0:t.track)instanceof ai){let i=t.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[n]=r;return n!==Q.LocalAudioTrack}).filter(r=>{let[n]=r;return!(e&&n===Q.LocalVideoLowTrack)}).map(r=>{let[,{track:n}]=r;return n}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return!(e&&r===Q.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r})}reportPublishEvent(e,t,i,r,n){if(e){let a=this.localTrackMap.get(Q.LocalAudioTrack),l=r?this.localTrackMap.get(Q.LocalVideoLowTrack):this.localTrackMap.get(Q.LocalVideoTrack);_e.publish(this.store.sessionId,{eventElapse:Gi.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:l==null?void 0:l.track.getTrackLabel(),screenshare:(l==null?void 0:l.track._hints.indexOf(Rt.SCREEN_TRACK))!==-1,audio:!!a,video:!!l,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:n})}else{var o;i||(i=[]);let a=i.find(d=>d instanceof jt),l=r?(o=this.localTrackMap.get(Q.LocalVideoTrack))===null||o===void 0?void 0:o.track:i.find(d=>d instanceof Et);_e.publish(this.store.sessionId,{eventElapse:Gi.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:a==null?void 0:a.getTrackLabel(),videoName:l==null?void 0:l.getTrackLabel(),screenshare:(l==null?void 0:l._hints.indexOf(Rt.SCREEN_TRACK))!==-1,audio:!!a,video:!!l,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:n})}}reportSubscribeEvent(e,t,i,r){let n=r===me.VIDEO?i._videoSSRC:i._audioSSRC;n&&_e.subscribe(this.store.sessionId,{succ:e,ec:t,video:r===me.VIDEO,audio:r===me.AUDIO,peerid:i.uid,subscribeRequestid:r===me.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:Gi.measureFromSubscribeStart(this.store.clientId,n)})}reset(){S.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Ti("P2PChannel2-send-mutex"),this.sendMutex=new Ti("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let e=this.localTrackMap.get(Q.LocalAudioTrack);if((e==null?void 0:e.track)instanceof ai){if(e.track.trackList.length>0){let t=e.track;e.track.trackList.forEach(i=>{t.removeAudioTrack(i)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=st.Disconnected}getStats(e){var t,i;return e?(i=this.recvConnection)===null||i===void 0?void 0:i.getStats():(t=this.sendConnection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.recvConnection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){let e=this.localTrackMap.get(Q.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){let e=this.localTrackMap.get(Q.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){let t=this.localTrackMap.get(e);return t&&t.track instanceof Et||t&&t.track instanceof jt?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;let i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;let i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;let i=Array.from(Yr(t=this.remoteUserMap).call(t)).find(r=>r.uid===e);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(i=>{let[r]=i;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}}),t=this.localTrackMap.get(Q.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=tu(e).call(e,(i,r)=>i.level-r.level),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(S.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=st.Reconnecting,N("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&((i=t._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[i,{track:r}]=e;switch(i){case Q.LocalVideoTrack:se(t=r._hints).call(t,Rt.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case Q.LocalAudioTrack:r instanceof ai?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case Q.LocalVideoLowTrack:}}),this.emit(ye.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,i]=e;Array.from(Yr(i).call(i)).forEach(r=>{this.setPendingRemoteMedia(t,r)}),this.emit(ye.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),S.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(let i of this.pendingRemoteTracks){let{user:r,kind:n}=i;if((e instanceof ha?e.uid:e)===r.uid&&t===n)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let i,r;if(e===nr.SEND_ONLY){if(!this.sendConnection)throw new j(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=await this.sendMutex.lock("From P2PChannel.restartICE"),r=this.sendConnection}else{if(!this.recvConnection)throw new j(A.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=await this.recvMutex.lock("From P2PChannel.restartICE"),r=this.recvConnection}try{if(t){let n=await r.restartICE(t);return r.isInRestartIce=!1,n}{let n=await r.restartICE();if(n){let o=await ti(this,ye.RequestP2PRestartICE,{direction:nr.RECEIVE_ONLY,iceParameter:n});await r.restartICE(o),r.isInRestartIce=!1}}}finally{i()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;let e=this.sendConnection.getStats(),t=this.localTrackMap.get(Q.LocalVideoTrack),i=this.localTrackMap.get(Q.LocalAudioTrack),r=e.videoSend.find(E=>{var I;return E.ssrc===(t==null||(I=t.ssrcs)===null||I===void 0?void 0:I[0].ssrcId)}),n=e.audioSend.find(E=>{var I;return E.ssrc===(i==null||(I=i.ssrcs)===null||I===void 0?void 0:I[0].ssrcId)});if(!r||!n)return 1;let o=Ur(this,ye.NeedSignalRTT),a=r?r.rttMs:void 0,l=n?n.rttMs:void 0,d=a&&l?(a+l)/2:a||l,u=(d&&o?(d+o)/2:d||o)||0,p=100*e.sendPacketLossRate*.7/50+.3*u/1500,m=p<.17?1:p<.36?2:p<.59?3:p<.1?4:5,f=t==null?void 0:t.track;if(f&&f._encoderConfig&&f._hints.indexOf(Rt.SCREEN_TRACK)===-1){let E=f._encoderConfig.bitrateMax,I=e.bitrate.actualEncoded;if(E&&I){let T=(1e3*E-I)/(1e3*E);return qb[T<.15?0:T<.3?1:T<.45?2:T<.6?3:4][m]}}return m}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;let e=this.recvConnection.getStats(),t=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[r]=i,n=r._audioSSRC,o=r._videoSSRC,a=e.audioRecv.find(I=>I.ssrc===n),l=e.videoRecv.find(I=>I.ssrc===o);if(!a&&!l)return void(t+=1);let d=Ur(this,ye.NeedSignalRTT),u=e.rtt,p=(u&&d?(u+d)/2:u||d)||0,m=a?a.jitterMs:void 0,f=e.recvPacketLossRate,E=.7*f*100/50+.3*p/1500;m&&(E=.6*f*100/50+.2*p/1500+.2*m/400),t+=E<.1?1:E<.17?2:E<.36?3:E<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new ne((t,i)=>{this.handleMuteLocalTrack(e,t,i)})}filterTobePublishedTracks(e,t,i){let r=[],n=Ye(),o=this.getAllTracks();e=Cl(e=e.filter(d=>o.indexOf(d)===-1));let a=!1,l=!1;for(let d of e){if(d instanceof Et&&(this.localTrackMap.has(Q.LocalVideoTrack)||a?new j(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:d,type:Q.LocalVideoTrack}),a=!0),t)){let u=this.getLowVideoTrack(d,i);r.push({track:u,type:Q.LocalVideoLowTrack})}if(d instanceof jt){let u=this.localTrackMap.get(Q.LocalAudioTrack);if(u){if(!(u.track instanceof ai))throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");u.track.addAudioTrack(d),this.bindLocalAudioTrackEvents(d,!0)}else if(l){let p=r.find(m=>{let{type:f}=m;return f===Q.LocalAudioTrack});if(!(p.track instanceof ai))throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(d._bypassWebAudio)throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");p.track.addAudioTrack(d)}else{if(!n.webAudioMediaStreamDest||d instanceof ai||d._bypassWebAudio)r.push({track:d,type:Q.LocalAudioTrack});else{let p=new ai;p.addAudioTrack(d),r.push({track:p,type:Q.LocalAudioTrack})}l=!0}}}return r}filterTobeUnpublishedTracks(e){let t=[],i=this.getAllTracks();e=Cl(e=e.filter(r=>i.indexOf(r)!==-1));for(let r of e){if(r instanceof jt){let n=this.localTrackMap.get(Q.LocalAudioTrack);if(!n)continue;n.track instanceof ai?(n.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),n.track.trackList.length===0&&(t.push([Q.LocalAudioTrack,n]),n.track.close())):t.push([Q.LocalAudioTrack,n])}if(r instanceof Et){let n=this.localTrackMap.get(Q.LocalVideoTrack);if(!n)continue;t.push([Q.LocalVideoTrack,n]);let o=this.localTrackMap.get(Q.LocalVideoLowTrack);o&&t.push([Q.LocalVideoLowTrack,o])}}return t}bindLocalTrackEvents(e){e.forEach(t=>{let{track:i,type:r}=t;switch(r){case Q.LocalVideoTrack:i.addListener(ce.GET_STATS,this.handleGetLocalVideoStats),i.addListener(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(ce.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(ce.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.addListener(ce.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Q.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case Q.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof ai?e.trackList.forEach(i=>{i.addListener(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(ce.GET_STATS,this.handleGetLocalAudioStats),i.addListener(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(ce.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(ce.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[i,{track:r}]=t;return{track:r,type:i}})),e.forEach(t=>{let{track:i,type:r}=t;switch(r){case Q.LocalVideoTrack:i.off(ce.GET_STATS,this.handleGetLocalVideoStats),i.off(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(ce.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(ce.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.off(ce.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Q.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case Q.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof ai?e.trackList.forEach(t=>{t.off(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ce.GET_STATS,this.handleGetLocalAudioStats),t.off(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(ce.GET_STATS,this.handleGetLocalAudioStats),e.off(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ce.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof $l&&t.addListener(ce.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(e))}),t instanceof ed&&t.addListener(ce.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ce.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,i]=e;i.has(me.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(me.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((i,r)=>{var n;let o,{track:a,type:l}=i;switch(l){case Q.LocalAudioTrack:o=ot.Audio;break;case Q.LocalVideoTrack:o=se(n=a._hints).call(n,Rt.SCREEN_TRACK)?ot.Screen:ot.High;break;case Q.LocalVideoLowTrack:o=ot.Low}return{kind:l===Q.LocalAudioTrack?me.AUDIO:me.VIDEO,stream_type:o,mid:t[r].id,ssrcs:t[r].localSSRC,isMuted:a.muted||!a.enabled}})}createGatewayUnpublishMessage(e){return e.map(t=>{var i;let r,[n,{track:o,ssrcs:a,id:l}]=t;switch(n){case Q.LocalVideoTrack:r=se(i=o._hints).call(i,Rt.SCREEN_TRACK)?ot.Screen:ot.High;break;case Q.LocalAudioTrack:r=ot.Audio;break;case Q.LocalVideoLowTrack:r=ot.Low}return{stream_type:r,ssrcs:a,mid:l}})}assignLocalTracks(e,t){e.forEach((i,r)=>{let{track:n,type:o}=i;this.localTrackMap.set(o,{track:n,id:t[r].id,ssrcs:t[r].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[i]=t;this.localTrackMap.delete(i)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{var i;S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(ye.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(e.isInRestartIce=!1),se(i=this._restartStates).call(i,t)&&!e.isInRestartIce&&(t==="disconnected"&&await mi(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),_e.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:xt.TRACER}).onSuccess(),this.emit(ye.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var i;let r=Array.from(Yr(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===t);var n;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(n=r.audioTrack)===null||n===void 0||n.emit(Jl.FIRST_FRAME_DECODED),_e.firstRemoteFrame(this.store.sessionId,vi.FIRST_AUDIO_DECODE,kt.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:Gi.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var i;let r=Array.from(Yr(i=this.remoteUserMap).call(i)).find(n=>n._audioSSRC===t);r&&_e.firstRemoteFrame(this.store.sessionId,vi.FIRST_AUDIO_RECEIVED,kt.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:Gi.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,i,r)=>{this.reportVideoFirstFrameDecoded(t,i,r)},e.onFirstVideoReceived=t=>{var i;let r=Array.from(Yr(i=this.remoteUserMap).call(i)).find(n=>n._videoSSRC===t);r&&_e.firstRemoteFrame(this.store.sessionId,vi.FIRST_VIDEO_RECEIVED,kt.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:Gi.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,i)=>{let r=t.candidateType==="relay",n=i.candidateType==="relay";i.candidateType!=="unknown"&&r===n||this.emit(ye.ConnectionTypeChange,r),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ia(i))," -> ").concat(JSON.stringify(ia(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,i)=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ia(i))," -> ").concat(JSON.stringify(ia(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(ye.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){let t=e===nr.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,S.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===nr.SEND_ONLY?this.restartICE(e):ti(this,ye.RequestP2PRestartICE,{direction:nr.SEND_ONLY}))}filterTobeMutedTracks(e){let t=[];if(this.getAllTracks().indexOf(e)===-1)return t;let i=this.localTrackMap.get(Q.LocalAudioTrack);if(e instanceof jt&&(i==null?void 0:i.track)instanceof ai)return i.track.isActive||t.push([Q.LocalAudioTrack,i]),t;let r=Array.from(this.localTrackMap.entries()).find(n=>{let[,{track:o}]=n;return e===o});if(r&&(t.push(r),r[0]===Q.LocalVideoTrack)){let n=this.localTrackMap.get(Q.LocalVideoLowTrack);n&&t.push([Q.LocalVideoLowTrack,n])}return t}filterTobeUnmutedTracks(e){let t=[],i=this.localTrackMap.get(Q.LocalAudioTrack);if(e instanceof jt&&(i==null?void 0:i.track)instanceof ai)return i.track.isActive&&t.push([Q.LocalAudioTrack,i]),t;let r=Array.from(this.localTrackMap.entries()).find(n=>{let[,{track:o}]=n;return e===o});if(r)if(r[0]===Q.LocalVideoTrack){t.push(r);let n=this.localTrackMap.get(Q.LocalVideoLowTrack);n&&t.push([Q.LocalVideoLowTrack,n])}else t.push(r);return t}createMuteMessage(e){return e.map(t=>{var i;let r,[n,{track:o,ssrcs:a,id:l}]=t;switch(n){case Q.LocalAudioTrack:r=ot.Audio;break;case Q.LocalVideoTrack:r=se(i=o._hints).call(i,Rt.SCREEN_TRACK)?ot.Screen:ot.High;break;case Q.LocalVideoLowTrack:r=ot.Low}return{stream_type:r,ssrcs:a,mid:l}})}createUnmuteMessage(e){return e.map(t=>{var i;let r,[n,{track:o,ssrcs:a,id:l}]=t;switch(n){case Q.LocalAudioTrack:r=ot.Audio;break;case Q.LocalVideoTrack:r=se(i=o._hints).call(i,Rt.SCREEN_TRACK)?ot.Screen:ot.High;break;case Q.LocalVideoLowTrack:r=ot.Low}return{stream_type:r,ssrcs:a,mid:l}})}filterTobeUnSubscribedTracks(e,t){let i=[],r=this.remoteUserMap.get(e);if(!r)return i;if(t){let n=r.get(t);if(!n)return i;i.push([e,{kind:t,id:n}])}else Array.from(r.entries()).forEach(n=>{let[o,a]=n;i.push([e,{kind:o,id:a}])});return i}createUnsubscribeMessage(e){let t=[];return e.forEach(i=>{let[r,{kind:n,id:o}]=i;switch(n){case me.VIDEO:return void(r._videoSSRC&&t.push({stream_type:me.VIDEO,ssrcId:r._videoSSRC}));case me.AUDIO:return void(r._audioSSRC&&t.push({stream_type:me.AUDIO,ssrcId:r._audioSSRC}))}}),t}withdrawRemoteTracks(e){e.forEach(t=>{let[i,{kind:r}]=t,n=this.remoteUserMap.get(i);n&&(n.delete(r),Array.from(n.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(e){let t=this.localTrackMap.get(Q.LocalVideoTrack),i=this.localTrackMap.get(Q.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){let e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return e!=="connected"&&t!=="connected"}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof jt){let i=this.filterTobeUnmutedTracks(e[t]);if(i.length===0)continue;let r=this.createUnmuteMessage(i);return void await _t(this,ye.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(e=>{let[,{ssrcs:t}]=e;return!!t}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.recvConnection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(ye.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(ye.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await mi(_m(this.dtlsFailedCount,Jt)),this.emit(ye.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(Q.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof Et)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof Et).length>1)throw new j(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof jt).length>1&&(e.some(t=>t instanceof jt&&t._bypassWebAudio)||!Ye().webAudioMediaStreamDest))throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let t of e){if(t instanceof Et&&this.pendingLocalTracks.some(i=>i instanceof Et))throw new j(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof jt&&this.pendingLocalTracks.some(i=>i instanceof jt)&&(!Ye().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof jt&&i._bypassWebAudio)))throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){let i=!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ye().supportDualStreamEncoding,r=h_(h_({},{width:160,height:120,framerate:15,bitrate:50}),t),n;n=i?e._mediaStreamTrack.clone():yv(e,r);let o=ft(8,"track-low-"),a=new Et(n,h_(h_({},i&&{scaleResolutionDownBy:eT(r,e)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on(gc.TRANSCEIVER_UPDATED,l=>{e._updateRtpTransceiver(l,Yl.LOW_STREAM)}),a._hints.push(Rt.LOW_STREAM),e.addListener(ce.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,i,r){var n;let o=Array.from(Yr(n=this.remoteUserMap).call(n)).find(a=>a._videoSSRC===e);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let a=this.store.keyMetrics,l=a.subscribe.find(d=>d.userId===o.uid&&d.type==="video");_e.firstRemoteVideoDecode(this.store.sessionId,vi.FIRST_VIDEO_DECODE,kt.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:t,videoheight:i,subscribeElapse:Gi.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(l==null?void 0:l.subscribeEnd)||0,subscriberStart:(l==null?void 0:l.subscribeStart)||0,videoAddNotify:(l==null?void 0:l.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.recvConnection)return!1;let r=this.remoteUserMap.get(e);if(!r)return!1;let n=r.get(t);if(!n)return!1;let o=await this.recvConnection.getRemoteSSRC(n);return o!==void 0&&o!==i}resetConnection(e){S.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===st.Connected?(S.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new j(A.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new j(A.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new j(A.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new j(A.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new j(A.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new j(A.NOT_SUPPORTED)}async preConnect(e,t,i,r,n,o){throw new j(A.NOT_SUPPORTED)}getEstablishParams(){throw new j(A.NOT_SUPPORTED)}async reSubscribe(e){throw new j(A.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new j(A.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:i}]=e;t===Q.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Yl.LOW_STREAM):i._updateRtpTransceiver(void 0)})}},ie(Dt.prototype,"p2pConnect",[NL],Object.getOwnPropertyDescriptor(Dt.prototype,"p2pConnect"),Dt.prototype),ie(Dt.prototype,"unpublish",[DL],Object.getOwnPropertyDescriptor(Dt.prototype,"unpublish"),Dt.prototype),ie(Dt.prototype,"unpublishLowStream",[PL],Object.getOwnPropertyDescriptor(Dt.prototype,"unpublishLowStream"),Dt.prototype),ie(Dt.prototype,"subscribe",[kL],Object.getOwnPropertyDescriptor(Dt.prototype,"subscribe"),Dt.prototype),ie(Dt.prototype,"mockSubscribe",[LL],Object.getOwnPropertyDescriptor(Dt.prototype,"mockSubscribe"),Dt.prototype),ie(Dt.prototype,"unsubscribe",[ML],Object.getOwnPropertyDescriptor(Dt.prototype,"unsubscribe"),Dt.prototype),ie(Dt.prototype,"muteRemote",[UL],Object.getOwnPropertyDescriptor(Dt.prototype,"muteRemote"),Dt.prototype),ie(Dt.prototype,"unmuteRemote",[xL],Object.getOwnPropertyDescriptor(Dt.prototype,"unmuteRemote"),Dt.prototype),ie(Dt.prototype,"hasRemoteMediaWithLock",[VL],Object.getOwnPropertyDescriptor(Dt.prototype,"hasRemoteMediaWithLock"),Dt.prototype),ie(Dt.prototype,"disconnectForReconnect",[FL],Object.getOwnPropertyDescriptor(Dt.prototype,"disconnectForReconnect"),Dt.prototype),ie(Dt.prototype,"remoteMediaSsrcChanged",[jL],Object.getOwnPropertyDescriptor(Dt.prototype,"remoteMediaSsrcChanged"),Dt.prototype),Dt);function vo(e){return function(t,i,r){let n=t[i];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){for(var o=arguments.length,a=new Array(o),l=0;l<o;l++)a[l]=arguments[l];switch(e){case To.SEND_ONLY:{let d=await this.sendMutex.lock("From P2PChannel2.".concat(i));try{return await n.apply(this,a)}finally{d()}}case To.RECEIVE_ONLY:{let d=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await n.apply(this,a)}finally{d()}}default:{let d=await this.sendMutex.lock("From P2PChannel2.".concat(i)),u=await this.recvMutex.lock("From P2PChannel2.".concat(i));try{return await n.apply(this,a)}finally{d(),u()}}}},r}}function GL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function wc(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?GL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):GL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class rh{constructor(t){y(this,"store",void 0),y(this,"onStatsException",void 0),y(this,"onUploadPublishDuration",void 0),y(this,"onStatsChanged",void 0),y(this,"localStats",new Map),y(this,"remoteStats",new Map),y(this,"updateStatsInterval",void 0),y(this,"trafficStats",void 0),y(this,"trafficStatsPeerList",[]),y(this,"uplinkStats",void 0),y(this,"exceptionMonitor",void 0),y(this,"p2pChannel",void 0),y(this,"scalabilityMode",Ez.L1T1),y(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=t,this.exceptionMonitor=new S9,this.exceptionMonitor.on("exception",(i,r,n)=>{this.onStatsException&&this.onStatsException(i,r,n)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(Q.LocalAudioTrack)||wc({},tv)}getLocalVideoTrackStats(){return this.localStats.get(Q.LocalVideoTrack)||wc({},iv)}getRemoteAudioTrackStats(t){let i=(o,a)=>{if(!this.trafficStats)return a;let l=this.trafficStats.peer_delay.find(d=>d.peer_uid===o);return l&&(a.publishDuration=l.B_ppad+(Date.now()-this.trafficStats.timestamp)),a},r={};if(t){var n;let o=(n=this.remoteStats.get(t))===null||n===void 0?void 0:n.audioStats;o&&(r[t]=i(t,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[a,{audioStats:l}]=o;l&&(r[a]=i(a,l))});return r}getRemoteNetworkQualityStats(t){let i={};if(t){var r;let n=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.networkStats;n&&(i[t]=n)}else Array.from(this.remoteStats.entries()).forEach(n=>{let[o,{networkStats:a}]=n;a&&(i[o]=a)});return i}getRemoteVideoTrackStats(t){let i=(o,a)=>{if(!this.trafficStats)return a;let l=this.trafficStats.peer_delay.find(d=>d.peer_uid===o);return l&&(a.publishDuration=l.B_ppvd+(Date.now()-this.trafficStats.timestamp)),a},r={};if(t){var n;let o=(n=this.remoteStats.get(t))===null||n===void 0?void 0:n.videoStats;o&&(r[t]=i(t,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[a,{videoStats:l}]=o;l&&(r[a]=i(a,l))});return r}getRTCStats(){let t=0,i=0,r=0,n=0,o=this.localStats.get(Q.LocalAudioTrack);o&&(t+=o.sendBytes,i+=o.sendBitrate);let a=this.localStats.get(Q.LocalVideoTrack);a&&(t+=a.sendBytes,i+=a.sendBitrate);let l=this.localStats.get(Q.LocalVideoLowTrack);l&&(t+=l.sendBytes,i+=l.sendBitrate),this.remoteStats.forEach(u=>{let{audioStats:p,videoStats:m}=u;p&&(r+=p.receiveBytes,n+=p.receiveBitrate),m&&(r+=m.receiveBytes,n+=m.receiveBitrate)});let d=1;return this.trafficStats&&(d+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:d,SendBitrate:i,SendBytes:t,RecvBytes:r,RecvBitrate:n,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter(i=>i.B_ppad!==void 0||i.B_ppvd!==void 0),t.peer_delay.filter(i=>this.trafficStatsPeerList.indexOf(i.peer_uid)===-1).forEach(i=>{var r;let n=(r=this.p2pChannel)===null||r===void 0?void 0:r.getRemoteMedia(i.peer_uid),o=n!=null&&n.videoSSRC?Gi.measureFromSubscribeStart(this.store.clientId,n.videoSSRC):0,a=n!=null&&n.audioSSRC?Gi.measureFromSubscribeStart(this.store.clientId,n.audioSSRC):0;i.B_ppad!==void 0&&i.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(i.peer_uid,i.B_ppad,i.B_ppvd,o>a?o:a),this.trafficStatsPeerList.push(i.peer_uid))}),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&S.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,i,r){if(!t)return!1;let n=!!r&&i.framesDecodeFreezeTime>r.framesDecodeFreezeTime,o=!r||i.framesDecodeCount>r.framesDecodeCount;return n||!o}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach(i=>{let[r,n]=i;switch(r){case Q.LocalVideoTrack:case Q.LocalVideoLowTrack:{let a=n,l=wc({},iv),d=t.getStats(),u=t.getLocalMedia(r);if(d){let p=d.videoSend.find(m=>m.ssrc===(u==null?void 0:u.ssrcs[0].ssrcId));if(p){let m=t.getLocalVideoSize(),f=t.getEncoderConfig(Q.LocalVideoTrack);p.codec!=="H264"&&p.codec!=="H265"&&p.codec!=="VP8"&&p.codec!=="VP9"&&p.codec!=="AV1X"&&p.codec!=="AV1"||(l.codecType=p.codec),l.sendBytes=p.bytes,l.sendBitrate=a?8*Math.max(0,l.sendBytes-a.sendBytes):0,p.inputFrame?(l.captureFrameRate=p.inputFrame.frameRate,l.captureResolutionHeight=p.inputFrame.height,l.captureResolutionWidth=p.inputFrame.width):m&&(l.captureResolutionWidth=m.width,l.captureResolutionHeight=m.height),p.sentFrame?(l.sendFrameRate=p.sentFrame.frameRate,l.sendResolutionHeight=p.sentFrame.height,l.sendResolutionWidth=p.sentFrame.width):m&&(l.sendResolutionWidth=m.width,l.sendResolutionHeight=m.height),p.avgEncodeMs&&(l.encodeDelay=p.avgEncodeMs),f&&f.bitrateMax&&(l.targetSendBitrate=1e3*f.bitrateMax),l.sendPackets=p.packets,l.sendPacketsLost=p.packetsLost,l.sendJitterMs=p.jitterMs,l.sendRttMs=p.rttMs,l.totalDuration=a?a.totalDuration+1:1,l.totalFreezeTime=a?a.totalFreezeTime:0,this.isLocalVideoFreeze(p)&&(l.totalFreezeTime+=1),p.scalabilityMode&&this.scalabilityMode!==p.scalabilityMode&&(S.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(p.scalabilityMode)),this.scalabilityMode=p.scalabilityMode)}this.trafficStats&&(l.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(r,l),((a==null?void 0:a.sendResolutionWidth)!==l.sendResolutionWidth||(a==null?void 0:a.sendResolutionHeight)!==l.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:l.sendResolutionWidth,height:l.sendResolutionHeight})),l&&u&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,u.track,l);break}case Q.LocalAudioTrack:{let a=n,l=wc({},tv),d=t.getStats(),u=t.getLocalMedia(r);if(d){let p=d.audioSend.find(m=>m.ssrc===(u==null?void 0:u.ssrcs[0].ssrcId));if(p){if(p.codec!=="opus"&&p.codec!=="aac"&&p.codec!=="PCMU"&&p.codec!=="PCMA"&&p.codec!=="G722"||(l.codecType=p.codec),p.inputLevel)l.sendVolumeLevel=Math.round(32767*p.inputLevel);else{let m=t.getLocalAudioVolume();m&&(l.sendVolumeLevel=Math.round(32767*m))}l.sendBytes=p.bytes,l.sendPackets=p.packets,l.sendPacketsLost=p.packetsLost,l.sendJitterMs=p.jitterMs,l.sendRttMs=p.rttMs,l.sendBitrate=a?8*Math.max(0,l.sendBytes-a.sendBytes):0}}this.trafficStats&&(l.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(Q.LocalAudioTrack,l),l&&u&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,u.track,l);break}}})}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach(i=>{var r,n;let[o,{videoStats:a,audioStats:l,videoPcStats:d}]=i,u=l,p=a,m=d,f=wc({},tP),E=wc({},iP),I=wc({},a9),{audioTrack:T,videoTrack:R,audioSSRC:w,videoSSRC:O}=t.getRemoteMedia(o),P;P=t instanceof Fr?t.getStats(!0):t.getStats();let M=(r=P)===null||r===void 0?void 0:r.audioRecv.find(Y=>Y.ssrc===w),V=(n=P)===null||n===void 0?void 0:n.videoRecv.find(Y=>Y.ssrc===O),F=this.trafficStats&&this.trafficStats.peer_delay.find(Y=>Y.peer_uid===o);if(M&&(M.codec!=="opus"&&M.codec!=="aac"&&M.codec!=="PCMU"&&M.codec!=="PCMA"&&M.codec!=="G722"||(f.codecType=M.codec),M.outputLevel?f.receiveLevel=Math.round(32767*M.outputLevel):T&&(f.receiveLevel=Math.round(32767*T.getVolumeLevel())),f.receiveBytes=M.bytes,f.receivePackets=M.packets,f.receivePacketsLost=M.packetsLost,f.packetLossRate=f.receivePacketsLost/(f.receivePackets+f.receivePacketsLost),f.receiveBitrate=u?8*Math.max(0,f.receiveBytes-u.receiveBytes):0,f.totalDuration=u?u.totalDuration+1:1,f.totalFreezeTime=u?u.totalFreezeTime:0,f.freezeRate=f.totalFreezeTime/f.totalDuration,f.receiveDelay=M.jitterBufferMs,f.totalDuration>10&&rh.isRemoteAudioFreeze(T)&&(f.totalFreezeTime+=1)),V){V.codec!=="H264"&&V.codec!=="H265"&&V.codec!=="VP8"&&V.codec!=="VP9"&&V.codec!=="AV1X"&&V.codec!=="AV1"||(E.codecType=V.codec),E.receiveBytes=V.bytes,E.receiveBitrate=p?8*Math.max(0,E.receiveBytes-p.receiveBytes):0,E.decodeFrameRate=V.decodeFrameRate<0?0:V.decodeFrameRate,E.renderFrameRate=V.decodeFrameRate<0?0:V.decodeFrameRate,V.outputFrame&&(E.renderFrameRate=V.outputFrame.frameRate),V.receivedFrame?(E.receiveFrameRate=V.receivedFrame.frameRate,E.receiveResolutionHeight=V.receivedFrame.height,E.receiveResolutionWidth=V.receivedFrame.width):R&&(E.receiveResolutionHeight=R._videoHeight||0,E.receiveResolutionWidth=R._videoWidth||0),V.framesRateFirefox!==void 0&&(E.receiveFrameRate=Math.round(V.framesRateFirefox)),E.receivePackets=V.packets,E.receivePacketsLost=V.packetsLost,E.packetLossRate=E.receivePacketsLost/(E.receivePackets+E.receivePacketsLost),E.totalDuration=p?p.totalDuration+1:1,E.totalFreezeTime=p?p.totalFreezeTime:0,E.receiveDelay=V.jitterBufferMs||0;let Y=!!O&&t.getRemoteVideoIsReady(O);R&&Y&&rh.isRemoteVideoFreeze(R,V,m)&&(E.totalFreezeTime+=1),E.freezeRate=E.totalFreezeTime/E.totalDuration}F&&(f.end2EndDelay=F.B_ad,E.end2EndDelay=F.B_vd,f.transportDelay=F.B_ed,E.transportDelay=F.B_ed,f.currentPacketLossRate=F.B_ealr4/100,E.currentPacketLossRate=F.B_evlr4/100,I.uplinkNetworkQuality=F.B_punq?F.B_punq:0,I.downlinkNetworkQuality=F.B_pdnq?F.B_pdnq:0),this.remoteStats.set(o,{audioStats:f,videoStats:E,videoPcStats:V,networkStats:I}),T&&this.exceptionMonitor.setRemoteAudioStats(T,f),R&&this.exceptionMonitor.setRemoteVideoStats(R,E)})}}function WL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function nh(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?WL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):WL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class V9 extends Ot{constructor(t,i,r,n){super(),y(this,"spec",void 0),y(this,"token",void 0),y(this,"websocket",void 0),y(this,"pingpongTimer",void 0),y(this,"reconnectMode","retry"),y(this,"serviceMode",void 0),y(this,"reqId",0),y(this,"commandReqId",0),y(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),y(this,"handleWebSocketMessage",o=>{if(!o.data)return;let a=JSON.parse(o.data);a.requestId?this.emit("@".concat(a.requestId,"-").concat(a.sid),a):this.serviceMode===Ri.INJECT?this.emit(Go.INJECT_STREAM_STATUS,a):(_e.workerEvent(this.spec.sid,{actionType:"status",serverCode:a.code,workerType:this.serviceMode===Ri.TRANSCODE?1:2}),this.emit(Go.PUBLISH_STREAM_STATUS,a))}),this.spec=i,this.token=t,this.serviceMode=n,this.websocket=new yu("live-streaming",r),this.websocket.on(Ae.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Ae.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Ae.REQUEST_NEW_URLS,(o,a)=>{ti(this,Go.REQUEST_NEW_ADDRESS).then(o).catch(a)}),this.websocket.on(Ae.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(t){return this.websocket.init(t)}async request(t,i,r,n){this.reqId+=1,t==="request"&&(this.commandReqId+=1);let o=this.commandReqId,a=this.reqId;if(!a||!this.websocket)throw new U(A.UNEXPECTED_ERROR);let l=nh({command:t,sdkVersion:mn==="4.21.0"?"0.0.1":mn,seq:a,requestId:a,allocate:r,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},i);if(this.websocket.state==="closed")throw new U(A.WS_DISCONNECT);let d=()=>new ne((f,E)=>{this.websocket.once(Ae.CLOSED,()=>E(new U(A.WS_ABORT))),this.websocket.once(Ae.CONNECTED,f)});this.websocket.state!=="connected"&&await d(),l.clientRequest&&(l.clientRequest.workerToken=this.token);let u=new ne((f,E)=>{let I=()=>{E(new U(A.WS_ABORT))};this.websocket.once(Ae.RECONNECTING,I),this.websocket.once(Ae.CLOSED,I),this.once("@".concat(a,"-").concat(this.spec.sid),T=>{f(T)})});n&&_e.workerEvent(this.spec.sid,nh(nh({},n),{},{requestId:o,actionType:"request",payload:JSON.stringify(i.clientRequest),serverCode:0,code:0}));let p=Date.now();this.websocket.sendMessage(l);let m=null;try{m=await u}catch(f){if(this.websocket.state==="closed")throw f;return await d(),await this.request(t,i,r)}return n&&_e.workerEvent(this.spec.sid,nh(nh({},n),{},{requestId:o,actionType:"response",payload:JSON.stringify(m.serverResponse),serverCode:m.code,success:m.code===200,responseTime:Date.now()-p})),m.code!==200&&this.handleResponseError(m),m}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){let t=mn==="4.21.0"?"0.0.1":mn;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case si.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void S.warning("live stream response already exists stream");case si.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case si.LIVE_STREAM_RESPONSE_BAD_STREAM:case si.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new U(A.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case si.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new U(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case si.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new U(A.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case si.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let i=new U(A.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Go.WARNING,i,t.serverResponse.url)}case si.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{let i=new U(A.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Go.WARNING,i,t.serverResponse.url)}case si.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new U(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case si.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new U(A.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case si.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{let i=new U(A.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Go.WARNING,i,t.serverResponse.url)}case si.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new U(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case si.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new U(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case si.LIVE_STREAM_RESPONSE_WORKER_LOST:case si.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new U(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case si.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new U(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new U(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case si.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case si.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case si.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case si.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new U(A.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(pm)},6e3)}}function HL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function mr(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?HL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):HL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}class F9 extends Ot{constructor(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Jt,r=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Jt;super(),y(this,"onLiveStreamWarning",void 0),y(this,"onLiveStreamError",void 0),y(this,"onInjectStatusChange",void 0),y(this,"spec",void 0),y(this,"retryTimeout",1e4),y(this,"connection",void 0),y(this,"httpRetryConfig",void 0),y(this,"wsRetryConfig",void 0),y(this,"streamingTasks",new Map),y(this,"isStartingStreamingTask",!1),y(this,"taskMutex",new Ti("live-streaming")),y(this,"cancelToken",ur.CancelToken.source()),y(this,"transcodingConfig",void 0),y(this,"injectConfig",mr({},Tz)),y(this,"injectLoopTimes",0),y(this,"uapResponse",void 0),y(this,"lastTaskId",1),y(this,"statusError",new Map),this.spec=t,this.httpRetryConfig=r,this.wsRetryConfig=i}async setTranscodingConfig(t){let i=mr(mr({},Sz),t);i.videoCodecProfile!==66&&i.videoCodecProfile!==77&&i.videoCodecProfile!==100&&(S.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map(a=>mr(mr(mr({},gz),a),{},{zOrder:a.zOrder?a.zOrder+1:1}))),function(a){Ut(a.width)||ut(a.width,"config.width",0,1e4),Ut(a.height)||ut(a.height,"config.height",0,1e4),Ut(a.videoBitrate)||ut(a.videoBitrate,"config.videoBitrate",1,1e6),Ut(a.videoFrameRate)||ut(a.videoFrameRate,"config.videoFrameRate"),Ut(a.lowLatency)||us(a.lowLatency,"config.lowLatency"),Ut(a.audioSampleRate)||ci(a.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),Ut(a.audioBitrate)||ut(a.audioBitrate,"config.audioBitrate",1,128),Ut(a.audioChannels)||ci(a.audioChannels,"config.audioChannels",[1,2,3,4,5]),Ut(a.videoGop)||ut(a.videoGop,"config.videoGop"),Ut(a.videoCodecProfile)||ci(a.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),Ut(a.userCount)||ut(a.userCount,"config.userCount",0,17),Ut(a.backgroundColor)||ut(a.backgroundColor,"config.backgroundColor",0,16777215),Ut(a.userConfigExtraInfo)||Ai(a.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),a.transcodingUsers&&!Ut(a.transcodingUsers)&&(hs(a.transcodingUsers,"config.transcodingUsers"),a.transcodingUsers.forEach((l,d)=>{vm(l.uid),Ut(l.x)||ut(l.x,"transcodingUser[".concat(d,"].x"),0,1e4),Ut(l.y)||ut(l.y,"transcodingUser[".concat(d,"].y"),0,1e4),Ut(l.width)||ut(l.width,"transcodingUser[".concat(d,"].width"),0,1e4),Ut(l.height)||ut(l.height,"transcodingUser[".concat(d,"].height"),0,1e4),Ut(l.zOrder)||ut(l.zOrder-1,"transcodingUser[".concat(d,"].zOrder"),0,100),Ut(l.alpha)||ut(l.alpha,"transcodingUser[".concat(d,"].alpha"),0,1,!1)})),Ut(a.watermark)||XS(a.watermark,"watermark"),Ut(a.backgroundImage)||XS(a.backgroundImage,"backgroundImage"),a.images&&!Ut(a.images)&&(hs(a.images,"config.images"),a.images.forEach((l,d)=>{XS(l,"images[".concat(d,"]"))}))}(i);let r=[];i.images&&r.push(...i.images.map(a=>mr(mr(mr({},JS),a),{},{zOrder:255}))),i.backgroundImage&&(r.push(mr(mr(mr({},JS),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(r.push(mr(mr(mr({},JS),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=r,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map(a=>mr({},a)),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);let n=(i.userConfigs||[]).map(a=>typeof a.uid=="number"?ne.resolve(a.uid):ON(a.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await ne.all(n)).forEach((a,l)=>{i.userConfigs&&i.userConfigs[l]&&(i.userConfigs[l].uid=a)}),this.transcodingConfig=i,this.connection)try{var o;let a=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(ho(o=this.streamingTasks).call(o)).map(l=>l.taskId).join("#")});S.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(a.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(a){if(!a.data||!a.data.retry)throw a;a.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(l=>{S.warning("[".concat(this.spec.clientId,"] live streaming receive error"),a.toString(),"try to republish",l.url),this.startLiveStreamingTask(l.url,l.mode,a).then(()=>{S.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(l.url," success"))}).catch(d=>{S.error("[".concat(this.spec.clientId,"] live streaming republish failed"),l.url,d.toString()),this.onLiveStreamError&&this.onLiveStreamError(l.url,d)})})}}setInjectStreamConfig(t,i){this.injectConfig=Object.assign({},this.injectConfig,t),this.injectLoopTimes=i}async startLiveStreamingTask(t,i,r){var n;if(Array.from(ho(n=this.streamingTasks).call(n)).find(d=>d.mode===Ri.INJECT)&&i===Ri.INJECT)return new U(A.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&i===Ri.TRANSCODE)throw new U(A.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let o={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};S.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(i));let a=await this.taskMutex.lock();if(!this.connection&&r)return void a();if(this.streamingTasks.get(t)&&!r)return a(),new U(A.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(i))}catch(d){throw a(),d}switch(i){case Ri.TRANSCODE:o.transcodingConfig=mr({},this.transcodingConfig);break;case Ri.RAW:break;case Ri.INJECT:o={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:t,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(o.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;let l=this.lastTaskId++;try{let d=new ne((p,m)=>{mi(this.retryTimeout).then(()=>{if(r)return m(r);let f=this.statusError.get(t);return f?(this.statusError.delete(t),m(f)):void 0})}),u=await ne.race([this.connection.request("request",{clientRequest:o},!0,{url:t,command:"PublishStream",workerType:i===Ri.TRANSCODE?1:2,requestByUser:!r,tid:l.toString()}),d]);this.isStartingStreamingTask=!1,S.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(u.code)),this.streamingTasks.set(t,{clientRequest:o,mode:i,url:t,taskId:l}),a()}catch(d){if(a(),this.isStartingStreamingTask=!1,!d.data||!d.data.retry||r)throw d;return d.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,i,d)):await this.startLiveStreamingTask(t,i,d)}}stopLiveStreamingTask(t){return new ne((i,r)=>{let n=this.streamingTasks.get(t);if(!n||!this.connection)return new U(A.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();let o=n.mode;n.abortTask=()=>{S.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),i()},this.connection.request("request",{clientRequest:{command:o===Ri.INJECT?"UninjectStream":"UnpublishStream",url:n.url}},!1,{url:t,command:"UnPublishStream",workerType:o===Ri.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(a=>{S.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(a.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&o!==Ri.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),i(),o===Ri.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(Al.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,t)}).catch(r)})}async controlInjectStream(t,i,r,n){let o=this.streamingTasks.get(t);if(!o||!this.connection||o.mode!==Ri.INJECT)throw new U(A.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:t,control:i,audioVolume:r,position:n}})).serverResponse}resetAllTask(){var t;let i=Array.from(ho(t=this.streamingTasks).call(t));this.terminate();for(let r of i)this.startLiveStreamingTask(r.url,r.mode).catch(n=>{this.onLiveStreamError&&this.onLiveStreamError(r.url,n)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=ur.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new U(A.UNEXPECTED_ERROR,"live streaming connection has already connected");let i=await ti(this,Rm.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=i,this.connection=new V9(i.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(Go.WARNING,(r,n)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(n,r)),this.connection.on(Go.PUBLISH_STREAM_STATUS,r=>this.handlePublishStreamServer(r)),this.connection.on(Go.INJECT_STREAM_STATUS,r=>this.handleInjectStreamServerStatus(r)),this.connection.on(Go.REQUEST_NEW_ADDRESS,(r,n)=>{if(!this.connection)return n(new U(A.UNEXPECTED_ERROR,"can not get new live streaming address list"));ti(this,Rm.REQUEST_WORKER_MANAGER_LIST,t).then(o=>{this.uapResponse=o,r(o.addressList)}).catch(n)}),await this.connection.init(i.addressList),this.connection}handlePublishStreamServer(t){let i=t.serverStatus&&t.serverStatus.url||"empty_url",r=this.streamingTasks.get(i),n=t.reason;switch(t.code){case si.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case si.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case si.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case si.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{let a=new U(A.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(r)return S.error(a.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,a);if(!this.isStartingStreamingTask)return;this.statusError.set(i,a)}case si.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let a=new U(A.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,n);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,a)}case si.LIVE_STREAM_RESPONSE_WORKER_LOST:case si.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();let a=Array.from(ho(o=this.streamingTasks).call(o));for(let l of a)l.abortTask?l.abortTask():(S.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",l.url),this.startLiveStreamingTask(l.url,l.mode,new U(A.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then(()=>{S.debug("[".concat(this.spec.clientId,"] republish live stream success"),l.url)}).catch(d=>{S.error(d.toString()),this.onLiveStreamError&&this.onLiveStreamError(l.url,d)}));return}}}handleInjectStreamServerStatus(t){let i=Number(t.uid),r=t.serverStatus&&t.serverStatus.url;switch(t.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(Al.INJECT_STREAM_STATUS_START_SUCCESS,i,r));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(Al.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,i,r),void this.streamingTasks.delete(r);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(Al.INJECT_STREAM_STATUS_START_UNAUTHORIZED,i,r),void this.streamingTasks.delete(r);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(Al.INJECT_STREAM_STATUS_BROKEN,i,r),void this.streamingTasks.delete(r);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(Al.INJECT_STREAM_STATUS_START_TIMEOUT,i,r),void this.streamingTasks.delete(r);default:return void S.debug("inject stream server status",t)}}hasUrl(t){return this.streamingTasks.has(t)}}class KL{constructor(){y(this,"destChannelMediaInfos",new Map),y(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(t){iN(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){iN(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){Tm(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function zL(e){if(!(e instanceof KL))return new U(A.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();let t=e.getSrcChannelMediaInfo(),i=e.getDestChannelMediaInfo();if(!t)return new U(A.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(i.size===0)return new U(A.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class j9 extends Ot{constructor(t,i,r){super(),y(this,"ws",void 0),y(this,"requestId",1),y(this,"heartBeatTimer",void 0),y(this,"joinInfo",void 0),y(this,"clientId",void 0),y(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),y(this,"onClose",n=>{this.emit("close"),this.dispose()}),y(this,"onMessage",n=>{let o=JSON.parse(n.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=t,this.clientId=i,this.ws=new yu("cross-channel-".concat(this.clientId),r),this.ws.on(Ae.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(Ae.CONNECTED,this.onOpen),this.ws.on(Ae.ON_MESSAGE,this.onMessage),this.ws.on(Ae.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){let i=this.requestId++;return t.requestId=i,t.seq=i,this.ws.sendMessage(t),i}waitStatus(t){return new ne((i,r)=>{let n=window.setTimeout(()=>{r(new U(A.TIMEOUT,"wait status timeout, status: ".concat(t)))},5e3);this.once(t,o=>{window.clearTimeout(n),o.state&&o.state!==0?r(new U(A.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):i(void 0)}),this.once("dispose",()=>{window.clearTimeout(n),r(new U(A.WS_ABORT))})})}async request(t){if(this.ws.state==="closed")throw new U(A.WS_DISCONNECT);let i=()=>new ne((a,l)=>{this.ws.once(Ae.CLOSED,()=>l(new U(A.WS_ABORT))),this.ws.once(Ae.CONNECTED,a)});this.ws.state!=="connected"&&await i();let r=this.sendMessage(t),n=new ne((a,l)=>{let d=()=>{l(new U(A.WS_ABORT))};this.ws.once(Ae.RECONNECTING,d),this.ws.once(Ae.CLOSED,d),this.once("req_".concat(r),a),mi(3e3).then(()=>{this.removeAllListeners("req_".concat(r)),this.ws.off(Ae.RECONNECTING,d),this.ws.off(Ae.CLOSED,d),l(new U(A.TIMEOUT,"cross channel ws request timeout"))})}),o=await n;if(!o||o.code!==200)throw new U(A.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(t){this.ws.removeAllListeners(Ae.REQUEST_NEW_URLS),this.ws.on(Ae.REQUEST_NEW_URLS,i=>{i(t)}),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){let i=this.requestId++;return t.requestId=i,this.ws.sendMessage(t),i}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class B9 extends Ot{set state(t){t!==this._state&&(t!==vr.RELAY_STATE_FAILURE&&(this.errorCode=Ol.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,i,r,n,o){super(),y(this,"joinInfo",void 0),y(this,"sid",void 0),y(this,"clientId",void 0),y(this,"cancelToken",ur.CancelToken.source()),y(this,"workerToken",void 0),y(this,"requestId",0),y(this,"signal",void 0),y(this,"prevChannelMediaConfig",void 0),y(this,"httpRetryConfig",void 0),y(this,"_resolution",void 0),y(this,"_state",vr.RELAY_STATE_IDLE),y(this,"errorCode",Ol.RELAY_OK),y(this,"onStatus",a=>{S.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(a))),a&&a.command&&(a.command==="onAudioPacketReceived"&&this.emit("event",ps.PACKET_RECEIVED_AUDIO_FROM_SRC),a.command==="onVideoPacketReceived"&&this.emit("event",ps.PACKET_RECEIVED_VIDEO_FROM_SRC),a.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=Ol.SRC_TOKEN_EXPIRED,this.state=vr.RELAY_STATE_FAILURE),a.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=Ol.DEST_TOKEN_EXPIRED,this.state=vr.RELAY_STATE_FAILURE))}),y(this,"onReconnect",async()=>{S.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",ps.NETWORK_DISCONNECTED),this.state=vr.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(a=>{this.state!==vr.RELAY_STATE_IDLE&&(S.error("auto restart channel media relay failed",a.toString()),this.errorCode=Ol.SERVER_CONNECTION_LOST,this.state=vr.RELAY_STATE_FAILURE)})}),this.joinInfo=t,this.clientId=i,this.sid=Su(),this.signal=new j9(this.joinInfo,this.clientId,r),this.httpRetryConfig=n,this._resolution=o}async startChannelMediaRelay(t){if(this.state!==vr.RELAY_STATE_IDLE)throw new U(A.INVALID_OPERATION);this.state=vr.RELAY_STATE_CONNECTING,await this.connect(),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(i){throw i.data&&i.data.serverResponse&&i.data.serverResponse.command==="SetSourceChannel"?new U(A.CROSS_CHANNEL_FAILED_JOIN_SRC):i.data&&i.data.serverResponse&&i.serverResponse.command==="SetDestChannelStatus"?new U(A.CROSS_CHANNEL_FAILED_JOIN_DEST):i.data&&i.data.serverResponse&&i.serverResponse.command==="StartPacketTransfer"?new U(A.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):i}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==vr.RELAY_STATE_RUNNING)throw new U(A.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==vr.RELAY_STATE_RUNNING)throw new U(A.INVALID_OPERATION);let i=this.genMessage(or.SetVideoProfile);await this.signal.request(i),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),S.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=vr.RELAY_STATE_IDLE,this.dispose()}dispose(){S.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=ur.CancelToken.source(),this.state=vr.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){let t=await jz(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",ps.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){let i=this.genMessage(or.StopPacketTransfer);await this.signal.request(i),await this.signal.waitStatus("Normal Quit"),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));let r=this.genMessage(or.SetSdkProfile,t);await this.signal.request(r),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));let n=this.genMessage(or.SetSourceChannel,t);await this.signal.request(n),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",ps.PACKET_JOINED_SRC_CHANNEL),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));let o=this.genMessage(or.SetSourceUserId,t);await this.signal.request(o),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));let a=this.genMessage(or.SetDestChannel,t);await this.signal.request(a),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",ps.PACKET_JOINED_DEST_CHANNEL),S.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));let l=this.genMessage(or.StartPacketTransfer,t);await this.signal.request(l),this.emit("event",ps.PACKET_SENT_TO_DEST_CHANNEL),this.state=vr.RELAY_STATE_RUNNING,S.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){let i=this.genMessage(or.UpdateDestChannel,t);await this.signal.request(i),this.emit("event",ps.PACKET_UPDATE_DEST_CHANNEL),S.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){let t=this.genMessage(or.StopPacketTransfer);await this.signal.request(t),S.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,i){let r=[],n=[],o=[];this.requestId+=1;let a={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:mn,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};a.sdkVersion==="4.21.0"&&(a.sdkVersion="0.0.1");let l=null,d=null;switch(t){case or.SetSdkProfile:return a.clientRequest={command:"SetSdkProfile",type:"multi_channel"},a;case or.SetSourceChannel:if(d=i&&i.getSrcChannelMediaInfo(),!d)throw new U(A.UNEXPECTED_ERROR,"can not find source config");return a.clientRequest={command:"SetSourceChannel",uid:"0",channelName:d.channelName,token:d.token||this.joinInfo.appId},a;case or.SetSourceUserId:if(d=i&&i.getSrcChannelMediaInfo(),!d)throw new U(A.UNEXPECTED_ERROR,"can not find source config");return a.clientRequest={command:"SetSourceUserId",uid:d.uid+""},a;case or.SetDestChannel:if(l=i&&i.getDestChannelMediaInfo(),!l)throw new U(A.UNEXPECTED_ERROR,"can not find dest config");return l.forEach(u=>{r.push(u.channelName),n.push(u.uid+""),o.push(u.token||this.joinInfo.appId)}),a.clientRequest={command:"SetDestChannel",channelName:r,uid:n,token:o},a;case or.StartPacketTransfer:return a.clientRequest={command:"StartPacketTransfer"},a;case or.Reconnect:return a.clientRequest={command:"Reconnect"},a;case or.StopPacketTransfer:return a.clientRequest={command:"StopPacketTransfer"},a;case or.UpdateDestChannel:if(l=i&&i.getDestChannelMediaInfo(),!l)throw new U(A.UNEXPECTED_ERROR,"can not find dest config");return l.forEach(u=>{r.push(u.channelName),n.push(u.uid+""),o.push(u.token||this.joinInfo.appId)}),a.clientRequest={command:"UpdateDestChannel",channelName:r,uid:n,token:o},a;case or.SetVideoProfile:a.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return a}}function p_(e){var t={},i=!1;function r(n,o){return i=!0,{done:!1,value:new pv(o=new mv(function(a){a(e[n](o))}),1)}}return t[_l!==void 0&&mO||"@@iterator"]=function(){return this},t.next=function(n){return i?(i=!1,n):r("next",n)},typeof e.throw=="function"&&(t.throw=function(n){if(i)throw i=!1,n;return r("throw",n)}),typeof e.return=="function"&&(t.return=function(n){return i?(i=!1,n):r("return",n)}),t}var YL=g(rL);function qL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function JL(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?qL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):qL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}var gt;function XL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function QL(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?XL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):XL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let rd=(gt=class Rh extends ym{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var i;return se(i=Object.keys(Il)).call(i,t)}))]}constructor(t,i){super(t,i),y(this,"store",void 0),y(this,"peerConnection",void 0),y(this,"remoteSDP",void 0),y(this,"initialOffer",void 0),y(this,"statsFilter",void 0),y(this,"useRTX",!1),y(this,"localCapabilities",void 0),y(this,"localCandidateCount",0),y(this,"allCandidatesReceived",!1),y(this,"establishPromise",void 0),y(this,"mutex",new Ti("P2PConnection-mutex")),this.store=i,this.peerConnection=new RTCPeerConnection(Rh.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=a_(this.peerConnection,N("STATS_UPDATE_INTERVAL"),void 0,mt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{let t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=go(t.sdp),r=ih(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:N("FILTER_VIDEO_FEC"),filterAudioFec:N("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=r,this.initialOffer=t,QL(QL({},i),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:r},offerSDP:t.sdp})}catch(t){throw new j(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,i,r,n,o,a){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(d){y(this,"sessionDesc",void 0),y(this,"localCapabilities",void 0),y(this,"rtpCapabilities",void 0),y(this,"candidates",void 0),y(this,"iceParameters",void 0),y(this,"dtlsParameters",void 0),y(this,"setup",void 0),y(this,"currentMidIndex",void 0),y(this,"cname",void 0),d=vt(d);let{remoteIceParameters:u,remoteDtlsParameters:p,candidates:m,remoteRTPCapabilities:f,remoteSetup:E,localCapabilities:I,sdkCodec:T,cname:R}=d,w=Nt.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=f,this.candidates=m,this.iceParameters=u,this.dtlsParameters=p,this.setup=E,this.localCapabilities=I,this.cname=R;for(let O=0;O<w.mediaDescriptions.length;O++){let P=w.mediaDescriptions[O];if(P.attributes.iceUfrag=u.iceUfrag,P.attributes.icePwd=u.icePwd,P.attributes.fingerprints=p.fingerprints,P.attributes.candidates=m,P.attributes.setup=E,P.media.mediaType==="video"){P.media.fmts=f.videoCodecs.map(V=>V.payloadType.toString(10));let M=f.videoCodecs.filter(V=>{var F,Y;return(F=V.rtpMap)===null||F===void 0?void 0:se(Y=F.encodingName.toLowerCase()).call(Y,T)});M.length===0&&(M=f.videoCodecs),P.attributes.payloads=M,P.attributes.extmaps=f.videoExtensions}P.media.mediaType==="audio"&&(P.media.fmts=f.audioCodecs.map(M=>M.payloadType.toString(10)),P.attributes.payloads=f.audioCodecs,P.attributes.extmaps=f.audioExtensions),w.mediaDescriptions[O]=this.mungMediaDesc(P)}this.sessionDesc=w,this.currentMidIndex=w.mediaDescriptions.length-1}toString(){return Nt.print(this.sessionDesc)}send(d,u,p){let{ssrcs:m,ssrcGroups:f}=on(u,this.cname),E=this.sessionDesc.mediaDescriptions.find(R=>d===me.VIDEO?R.media.mediaType==="video":R.media.mediaType==="audio"),I=m[0].attributes.label,T=m[0].attributes.mslabel;return E.attributes.ssrcs=E.attributes.ssrcs.concat(m),E.attributes.ssrcGroups=E.attributes.ssrcGroups.concat(f),{id:I,mslabel:T}}batchSend(d){return d.map(u=>{let{kind:p,ssrcMsg:m}=u;return this.send(p,m,void 0)})}stopSending(d){this.sessionDesc.mediaDescriptions.forEach(u=>{let p=[],m=[],f=[];u.attributes.ssrcs.forEach(E=>{se(d).call(d,E.attributes.label||"")?f.push(E):p.push(E)}),u.attributes.ssrcGroups.forEach(E=>{var I;se(I=f.map(T=>T.ssrcId)).call(I,E.ssrcIds[0])||m.push(E)}),u.attributes.ssrcs=p,u.attributes.ssrcGroups=m})}mute(d){let u=this.sessionDesc.mediaDescriptions.find(p=>p.attributes.mid===d);if(!u)throw new Error("mediaDescription not found with ".concat(d," in remote SDP when calling RemoteSDP.mute."));u.attributes.direction="inactive"}unmute(d){let u=this.sessionDesc.mediaDescriptions.find(p=>p.attributes.mid===d);if(!u)throw new Error("mediaDescription not found with ".concat(d," in remote SDP when calling RemoteSDP.unmute."));u.attributes.direction="sendonly"}receive(d,u,p){d.forEach((m,f)=>{let E=m._mediaStreamTrack,I=this.sessionDesc.mediaDescriptions.findIndex(R=>R.attributes.mid===E.kind),T=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[I],m);this.sessionDesc.mediaDescriptions[I]=T})}stopReceiving(d){}updateCandidates(d){d===Ji.TCP?this.candidates.forEach(u=>{this.candidates.findIndex(p=>p.transport==="tcp"&&p.connectionAddress===u.connectionAddress&&p.port===u.port)===-1&&this.candidates.push(JL(JL({},u),{},{foundation:"tcpcandidate",priority:Number(u.priority)-1+"",transport:"tcp",port:Number(u.port)+90+""}))}):this.candidates=this.candidates.filter(u=>u.transport!=="tcp");for(let u of this.sessionDesc.mediaDescriptions)u.attributes.candidates=this.candidates}restartICE(d){d=vt(d),this.iceParameters=d,this.sessionDesc.mediaDescriptions.forEach(u=>{u.attributes.iceUfrag=d.iceUfrag,u.attributes.icePwd=d.icePwd})}predictReceivingMids(d){let u=[];for(let p=0;p<d;p++)u.push((this.currentMidIndex+p+1).toString(10));return u}mungRecvMediaDsec(d,u){let p=vt(d);return la(p,u),l_(p,u),p}updateRecvMedia(d,u){let p=this.sessionDesc.mediaDescriptions.findIndex(m=>m.attributes.mid===d);if(p!==-1){let m=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[p],u);this.sessionDesc.mediaDescriptions[p]=m}}bumpMid(d){this.currentMidIndex+=d}updateTrackLabel(d,u,p){let m=this.sessionDesc.mediaDescriptions.find(E=>d===me.VIDEO?E.attributes.mid==="video":E.attributes.mid==="audio");if(m){let E=m.attributes.ssrcs.find(I=>I.attributes.label===u);var f;E&&(E.attributes.label=p,(f=E.attributes.msid)===null||f===void 0||f.replace(u,p))}}mungMediaDesc(d){let u=vt(d);return c_(u),function(p){let m=p.attributes.extmaps.find(f=>f.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");m&&p.attributes.extmaps.splice(p.attributes.extmaps.indexOf(m),1),p.attributes.payloads.forEach(f=>{let E=f.rtcpFeedbacks.findIndex(I=>I.type==="transport-cc");E!==-1&&f.rtcpFeedbacks.splice(E,1)})}(u),u}getSSRC(d){for(let u of this.sessionDesc.mediaDescriptions)for(let p of u.attributes.ssrcs)if(p.attributes.label===d)return[p]}}({remoteIceParameters:t,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:n.send,remoteSetup:o,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:a});let l=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(l){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(l.toString()))}}async updateRemoteRTPCapabilities(t,i){throw new j(A.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(t,i){var r=this;return Vr(function*(){let n=yield Ue(r.mutex.lock());try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let o=t.map(f=>r.peerConnection.addTrack(f._mediaStreamTrack)),a=yield Ue(r.peerConnection.createOffer()),l=Nt.parse(a.sdp),d=t.map(f=>{let E=f._mediaStreamTrack,I=l.mediaDescriptions.find(T=>T.attributes.mid===E.kind);if(!I)throw new Error("Cannot extract ssrc from mediaDescription.");return function(T,R,w){let O=T.attributes.ssrcs.filter(M=>M.attributes.label===R),P=T.attributes.ssrcGroups;if(O.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(P&&O.length>1){let M=P.find(V=>V.ssrcIds.indexOf(O[0].ssrcId)!==-1);return M?[{ssrcId:M.ssrcIds[0],rtx:w?M.ssrcIds[1]:void 0}]:[{ssrcId:O[0].ssrcId}]}return[{ssrcId:O[0].ssrcId}]}(I,E.id,r.useRTX)}),u;try{u=yield d}catch(f){throw o.forEach(E=>{pi()&&E.replaceTrack(null),r.peerConnection.removeTrack(E)}),f}let p=r.mungSendOfferSDP(a.sdp,t);r.remoteSDP.receive(t,i,u);let m=r.remoteSDP.toString();return yield Ue(r.peerConnection.setLocalDescription({type:"offer",sdp:p})),yield Ue(r.applySendEncodings(o,t)),yield Ue(r.peerConnection.setRemoteDescription({type:"answer",sdp:m})),t.map((f,E)=>{let I=f._mediaStreamTrack.id;return{localSSRC:d[E],id:I}})}catch(o){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{n()}})()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let i=this.peerConnection.getSenders().filter(o=>{var a;return t.indexOf(((a=o.track)===null||a===void 0?void 0:a.id)||"")!==-1});if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(o=>{pi()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});let r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r),this.remoteSDP.stopReceiving(t);let n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}}async receive(t,i,r,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));let{id:o,mslabel:a}=this.remoteSDP.send(t,i,n),l=new ne((p,m)=>{let f=setTimeout(()=>{m(new Error("Cannot receive track, id: ".concat(o)))},1e4),E=I=>{let T=Xe();if((T.name==="Safari"&&Number(T.version)===11||ji())&&I.track.id!==o&&I.streams[0].id===a){var R;let w=I.streams[0].getTracks()[0];return(R=this.remoteSDP)===null||R===void 0||R.updateTrackLabel(t,o,I.track.id),this.peerConnection.removeEventListener("track",E),clearTimeout(f),void p(w)}if(I.track.id===o)return this.peerConnection.removeEventListener("track",E),clearTimeout(f),void p(I.track)};this.peerConnection.addEventListener("track",E)}),d=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:d});let u=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(u),{track:await l,id:o}}catch(o){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);let i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let r=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(r)}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getSenders().filter(r=>{var n;return t.indexOf(((n=r.track)===null||n===void 0?void 0:n.id)||"")!==-1});if(i.length!==t.length)throw new Error("sender' length doesn't match mids' length.");i.map(r=>{if(pi()&&r.track)r.track.enabled=!1;else{let n=r.getParameters();n.encodings.forEach(o=>o.active=!1),r.setParameters(n)}})}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getSenders().filter(o=>{var a;return t.indexOf(((a=o.track)===null||a===void 0?void 0:a.id)||"")!==-1});if(i.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");i.map(async o=>{if(pi()&&o.track)o.track.enabled=!0;else{let a=o.getParameters();a.encodings.forEach(l=>l.active=!0),await o.setParameters(a)}});let r=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(r);let n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:n})}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return Vr(function*(){let r=yield Ue(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ye().supportPCSetConfiguration){let d=i.peerConnection.getConfiguration(),u=t===Ji.RELAY?"relay":"all";d.iceTransportPolicy!==u&&(S.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(u,"]")),d.iceTransportPolicy=u,i.peerConnection.setConfiguration(d))}else if(t===Ji.RELAY)return;t!==Ji.RELAY&&i.remoteSDP.updateCandidates(t);let n=yield Ue(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let o=go(n.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);let l=i.remoteSDP.toString();yield Ue(i.peerConnection.setLocalDescription(n)),yield Ue(i.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(n){S.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),n)}finally{r()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let r=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(r.sdp,[i]);this.remoteSDP.updateRecvMedia(i._mediaStreamTrack.kind,i);let o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new j(A.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,i){let r=this.peerConnection.getSenders().filter(n=>{var o;return((o=n.track)===null||o===void 0?void 0:o.id)===t});r.length===1&&await this.applySendEncodings(r,[i])}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){let r=this.peerConnection.getSenders().find(n=>{var o;return((o=n.track)===null||o===void 0?void 0:o.id)===i});r&&await r.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,i){throw new j(A.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new j(A.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},N("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){let i={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Rl(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...Rh.turnServerConfigToIceServers(t.turnServer.servers)),N("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...Rh.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(t){let i=[];return t.forEach(r=>{r.security?r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),i}async updateRtpSenderEncodings(t,i){var r;if(i||(i=this.peerConnection.getSenders().find(u=>{var p;return((p=u.track)===null||p===void 0?void 0:p.id)===t._mediaStreamTrack.id})),!i)return S.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!Ye().supportSetRtpSenderParameters)return S.warn("Browser not support set rtp-sender parameters");let n={},o={};if(t instanceof Et)switch(t._optimizationMode){case"motion":n.degradationPreference="maintain-framerate";break;case"detail":n.degradationPreference="maintain-resolution";break;default:n.degradationPreference="balanced"}if(N("DSCP_TYPE")&&qs()){var a;let u=N("DSCP_TYPE");se(a=["very-low","low","medium","high"]).call(a,u)&&(o.networkPriority=u)}let l=i.getParameters(),d=(r=l.encodings)===null||r===void 0?void 0:r[0];d&&Object.assign(d,o),Object.assign(l,n),S.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(l.encodings))),await i.setParameters(l)}async applySendEncodings(t,i){try{if(!Ye().supportSetRtpSenderParameters||t.length!==i.length)return;for(let r=0;r<t.length;r++){let n=t[r],o=i[r];n&&o&&await this.updateRtpSenderEncodings(o,n)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i){let r=Nt.parse(t);return i.forEach((n,o)=>{let a=n._mediaStreamTrack,l=r.mediaDescriptions.find(d=>d.attributes.mid===a.kind);l&&la(l,n)}),Nt.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,r)=>{var n;(n=this.onFirstVideoDecoded)===null||n===void 0||n.call(this,t,i,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,i)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let i=this.remoteSDP.batchSend(t).map((o,a)=>{let{id:l,mslabel:d}=o,{kind:u}=t[a];return new ne((p,m)=>{let f=setTimeout(()=>{m(new Error("Cannot receive track, id: ".concat(l)))},1e4),E=I=>{let T=Xe();if(T.name==="Safari"&&Number(T.version)===11&&I.track.id!==l&&I.streams[0].id===d){var R;let w=I.streams[0].getTracks()[0];return(R=this.remoteSDP)===null||R===void 0||R.updateTrackLabel(u,l,I.track.id),this.peerConnection.removeEventListener("track",E),clearTimeout(f),void p({track:w,id:l})}if(I.track.id===l)return this.peerConnection.removeEventListener("track",E),clearTimeout(f),void p({track:I.track,id:l})};this.peerConnection.addEventListener("track",E)})}),r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});let n=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(n),await ne.all(i)}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;let i=this.remoteSDP.getSSRC(t);return i==null?void 0:i[0].ssrcId}setConfiguration(t){if(Ye().supportPCSetConfiguration){let i=Rh.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},ie(gt.prototype,"connect",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"connect"),gt.prototype),ie(gt.prototype,"stopSending",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"stopSending"),gt.prototype),ie(gt.prototype,"receive",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"receive"),gt.prototype),ie(gt.prototype,"stopReceiving",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"stopReceiving"),gt.prototype),ie(gt.prototype,"muteRemote",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"muteRemote"),gt.prototype),ie(gt.prototype,"unmuteRemote",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"unmuteRemote"),gt.prototype),ie(gt.prototype,"muteLocal",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"muteLocal"),gt.prototype),ie(gt.prototype,"unmuteLocal",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"unmuteLocal"),gt.prototype),ie(gt.prototype,"close",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"close"),gt.prototype),ie(gt.prototype,"updateEncoderConfig",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"updateEncoderConfig"),gt.prototype),ie(gt.prototype,"updateSendParameters",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"updateSendParameters"),gt.prototype),ie(gt.prototype,"replaceTrack",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"replaceTrack"),gt.prototype),ie(gt.prototype,"getRemoteSSRC",[vn],Object.getOwnPropertyDescriptor(gt.prototype,"getRemoteSSRC"),gt.prototype),gt);function vn(e,t,i){let r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let n=this.mutex,o=await n.lock("Locking from P2PConnection.".concat(t));try{for(var a=arguments.length,l=new Array(a),d=0;d<a;d++)l[d]=arguments[d];return await r.apply(this,l)}finally{o()}},i}function ZL(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function pa(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?ZL(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ZL(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let oh="9",$L=4e4;function e1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function Cs(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?e1(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):e1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let m_=function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e}({});var nd=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(nd||{});let __=new Map;function t1(e,t,i,r){let{scale:n}=e;if(n===0&&r===nd.UP||n>=t.length-1&&r===nd.DOWN)return e;let o=Cs(Cs({},e),{},{scale:r===nd.DOWN?++n:--n});switch(i){case"maintain-framerate":o=Cs(Cs({},o),t[n].motion);break;case"maintain-resolution":o=Cs(Cs({},o),t[n].detail);break;case"balanced":o=Cs(Cs({},o),t[n].balanced)}return o}function i1(e,t){if(t){let i={overUse:0,underUse:0,adaptationList:r1(t)};__.set(e,i)}else __.delete(e)}function r1(e){let t=Cs({},e),{bitrateMax:i,frameRate:r,scaleResolutionDownBy:n,bitrateMin:o}=t,{MIN_FRAME_RATE:a,MAX_THRESHOLD_FRAMERATE:l,MAX_SCALE:d,BITRATE_MIN_THRESHOLD:u,BITRATE_MAX_THRESHOLD:p,BWE_SCALE_UP_THRESHOLD:m,BWE_SCALE_DOWN_THRESHOLD:f,PERF_SCALE_DOWN_THRESHOLD:E,PERF_SCALE_UP_THRESHOLD:I,BALANCE_BITRATE_FACTOR:T,BALANCE_FRAMERATE_FACTOR:R,BALANCE_RESOLUTION_FACTOR:w,MOTION_RESOLUTION_FACTOR:O,MOTION_BITRATE_FACTOR:P,DETAIL_FRAMERATE_FACTOR:M,DETAIL_BITRATE_FACTOR:V}=jS,F=Math.min(t.frameRate,l),Y=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(f,1)*i),bwe_up:i,fps_down:Math.round(Math.pow(E,1)*F),fps_up:r},balanced:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:i,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:i,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:r,bitrateMax:i,bitrateMin:o}}];for(let J=1;J<=d;J++){let Z={bwe_up:Math.round(Math.pow(m,J)*i),bwe_down:Math.round(Math.pow(f,J+1)*i),fps_up:Math.round(Math.pow(I,J)*F),fps_down:Math.round(Math.pow(E,J+1)*F)},pe={scaleResolutionDownBy:n/Math.pow(w,J),frameRate:Math.max(Math.round(Math.pow(R,J)*r),a),bitrateMax:Math.max(Math.round(Math.pow(T,J)*i),p),bitrateMin:Math.max(Math.round(Math.pow(T,J)*o),u)},Ke={scaleResolutionDownBy:n/Math.pow(O,J),frameRate:r,bitrateMax:Math.max(Math.round(Math.pow(P,J)*i),p),bitrateMin:Math.max(Math.round(Math.pow(P,J)*o),u)},rt={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(M,J)*r),a),bitrateMax:Math.max(Math.round(Math.pow(V,J)*i),p),bitrateMin:Math.max(Math.round(Math.pow(V,J)*o),u)};Y.push({scale:J,threshold:Z,balanced:pe,motion:Ke,detail:rt})}return Y}function G9(e,t,i,r,n,o){let a=__.get(e)||{overUse:0,underUse:0,adaptationList:r1(n)},{adaptationList:l}=a;__.set(e,a);let{OVERUSE_TIMES_THRESHOLD:d,UNDERUSE_TIMES_THRESHOLD:u}=jS,{scale:p}=r,m,f;return typeof t=="number"&&t>0&&function(E,I,T,R){if(I>=T.length)return!1;let{threshold:{fps_down:w}}=T[I];return N("FORCE_AG_HIGH_FRAMERATE")&&R==="maintain-framerate"&&(w=T[0].threshold.fps_down),E<w}(t,p,l,o)&&(a.overUse++,f=m_.CPU,a.overUse>d)||typeof i=="number"&&i>0&&function(E,I,T){if(I>=T.length)return!1;let{threshold:{bwe_down:R}}=T[I];return E<R}(i,p,l)&&(a.overUse++,f=m_.BANDWIDTH,a.overUse>d)?(a.overUse=0,a.underUse=0,m=t1(r,l,o,nd.DOWN),[m,f]):(typeof t=="number"&&t>0&&typeof i=="number"&&i>0&&function(E,I,T,R){if(I===0)return;let{threshold:{fps_up:w}}=T[I];return N("FORCE_AG_HIGH_FRAMERATE")&&R==="maintain-framerate"&&(w=T[1].threshold.fps_up),E>w}(t,p,l,o)&&function(E,I,T){if(I===0)return;let{threshold:{bwe_up:R}}=T[I];return E>R}(i,p,l)&&(a.underUse++,a.underUse>u&&(a.overUse=0,a.underUse=0,m=t1(r,l,o,nd.UP),m.scale===0&&(f=m_.NONE))),[m,f])}function n1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function Av(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?n1(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):n1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function W9(e){var t;return!!N("ENABLE_AG_ADAPTATION")&&!!(e instanceof uv||se(t=e._hints).call(t,Rt.CUSTOM_TRACK))&&(!!N("FORCE_SUPPORT_AG_ADAPTATION")||!!(function(i){let r=Xe();if(r.os!==hi.IOS||!r.osVersion)return!1;let n=r.osVersion.split(".");return Number(n[0])>=i}(14)&&mb(17,4)||pb(14)&&_b(17,4)))}let f_=new Map;function E_(e){let t=f_.get(e);if(t){let{timer:i,adaptationFunc:r,originConfig:n}=t;window.clearTimeout(i),r(n),f_.delete(e)}i1(e)}var Qe;function o1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function ma(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?o1(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):o1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let Ro=(Qe=class Ch extends ym{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,i;return(t=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>{var i;return se(i=Object.keys(Il)).call(i,t)}))]}constructor(t,i){super(t,i),y(this,"store",void 0),y(this,"peerConnection",void 0),y(this,"id",ft(5,"connection-")),y(this,"remoteSDP",void 0),y(this,"initialOffer",void 0),y(this,"transportEventReceiver",void 0),y(this,"statsFilter",void 0),y(this,"useXR",N("USE_XR")),y(this,"localCapabilities",void 0),y(this,"remoteCodecs",void 0),y(this,"localCandidateCount",0),y(this,"allCandidatesReceived",!1),y(this,"dataStreamChannelMap",new Map),y(this,"establishPromise",void 0),y(this,"recoveredDataChannelIds",[]),y(this,"currentDataChannelId",1),y(this,"mutex",new Ti("P2PConnection-mutex")),y(this,"qualityLimitationReason",m_.NONE),this.store=i,this.peerConnection=new RTCPeerConnection(Ch.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=a_(this.peerConnection,N("STATS_UPDATE_INTERVAL"),void 0,mt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(t,i){if(this.remoteCodecs=i,!this.remoteSDP)return void S.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(t,i,this.store.codec)){let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r);let o=this.remoteSDP.toString();n==null||n(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else S.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=go(t.sdp),r=await Rv({filterRTX:!N("USE_PUB_RTX")&&!N("USE_SUB_RTX"),filterVideoFec:N("FILTER_VIDEO_FEC"),filterAudioFec:N("FILTER_AUDIO_FEC"),filterVideoCodec:N("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=id(r),this.initialOffer=t,ma(ma({},i),{},{rtpCapabilities:r,offerSDP:t.sdp})}catch(t){throw new j(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,i,r,n,o,a){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return vt(this._localCapabilities)}get rtpCapabilities(){return vt(this._rtpCapabilities)}get candidates(){return vt(this._candidates)}get iceParameters(){return vt(this._iceParameters)}get dtlsParameters(){return vt(this._dtlsParameters)}constructor(E){y(this,"sessionDesc",void 0),y(this,"_localCapabilities",void 0),y(this,"_rtpCapabilities",void 0),y(this,"_candidates",void 0),y(this,"_iceParameters",void 0),y(this,"_dtlsParameters",void 0),y(this,"setup",void 0),y(this,"currentMidIndex",void 0),y(this,"cname",void 0),y(this,"firefoxSsrcMidMap",new Map),E=vt(E);let{remoteIceParameters:I,remoteDtlsParameters:T,candidates:R,remoteRTPCapabilities:w,remoteSetup:O,localCapabilities:P,cname:M}=E,V=Nt.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=w,this._candidates=R,this._iceParameters=I,this._dtlsParameters=T,this._localCapabilities=P,this.setup=O,this.cname=M;let F=this.rtpCapabilities.send;for(let Y of V.mediaDescriptions){if(Y.attributes.iceUfrag=I.iceUfrag,Y.attributes.icePwd=I.icePwd,Y.attributes.fingerprints=T.fingerprints,Y.attributes.candidates=R,Y.attributes.setup=O,Y.media.mediaType==="video"&&(Y.media.fmts=F.videoCodecs.map(J=>J.payloadType.toString(10)),Y.attributes.payloads=F.videoCodecs,Y.attributes.extmaps=F.videoExtensions,N("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:J,ssrcGroups:Z}=on([{ssrcId:$L,rtx:N("USE_SUB_RTX")?40001:void 0}],this.cname);Y.attributes.ssrcs=J,Y.attributes.ssrcGroups=Z}if(Y.media.mediaType==="audio"&&(Y.media.fmts=F.audioCodecs.map(J=>J.payloadType.toString(10)),Y.attributes.payloads=F.audioCodecs,Y.attributes.extmaps=F.audioExtensions,So(Y),N("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:J,ssrcGroups:Z}=on([{ssrcId:2e4}],this.cname);Y.attributes.ssrcs=J,Y.attributes.ssrcGroups=Z}}this.sessionDesc=V,this.currentMidIndex=V.mediaDescriptions.length-1}preloadRemoteMedia(){let E=N("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;let I=this.candidates,T=this.dtlsParameters,R=this.iceParameters,w=this.rtpCapabilities.send;for(let O=1;O<E;O++){let P=2*O+2e4,M=2*O+$L,{ssrcs:V,ssrcGroups:F}=on([{ssrcId:P}],this.cname),{ssrcs:Y,ssrcGroups:J}=on([{ssrcId:M,rtx:N("USE_SUB_RTX")?M+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:oh,protos:["UDP","TLS","RTP","SAVPF"],fmts:w.videoCodecs.map(Z=>Z.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:R.iceUfrag,icePwd:R.icePwd,unrecognized:[],candidates:I,extmaps:w.videoExtensions,fingerprints:T.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:Y,ssrcGroups:J,rtcpFeedbackWildcards:[],payloads:w.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*O)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:oh,protos:["UDP","TLS","RTP","SAVPF"],fmts:w.audioCodecs.map(Z=>Z.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:R.iceUfrag,icePwd:R.icePwd,unrecognized:[],candidates:I,extmaps:w.audioExtensions,fingerprints:T.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:V,ssrcGroups:F,rtcpFeedbackWildcards:[],payloads:w.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*O+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Nt.print(this.sessionDesc)}send(E,I,T,R){let{ssrcs:w,ssrcGroups:O}=on(I,this.cname,N("SYNC_GROUP")?T:void 0),P=this.findPreloadMediaDesc(w);if(P){if(mt()&&this.firefoxSsrcMidMap.set(w[0].ssrcId,P.attributes.mid),R&&(R.twcc||R.remb)){let M=this.sessionDesc.mediaDescriptions.indexOf(P);return this.sessionDesc.mediaDescriptions[M]=this.mungSendMediaDesc(P,R),{mid:P.attributes.mid,needExchangeSDP:!0}}return{mid:P.attributes.mid,needExchangeSDP:!1}}{let M=this.findAvailableMediaIndex(E,w),V;return M===-1||M===1&&(pi()||Eb())||M===0&&N("USE_SUB_RTX")||gb()?(V=this.createOrRecycleSendMedia(E,w,O,"sendonly",R),this.updateBundleMids()):(V=vt(this.sessionDesc.mediaDescriptions[M]),V.attributes.direction="sendonly",V.attributes.ssrcs=w,V.attributes.ssrcGroups=O,this.sessionDesc.mediaDescriptions[M]=this.mungSendMediaDesc(V,R)),mt()&&this.firefoxSsrcMidMap.set(w[0].ssrcId,V.attributes.mid),{mid:V.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){let{mediaDesc:E,needExchangeSDP:I}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:E.attributes.mid,needExchangeSDP:I}}batchSend(E){let I=E.map(w=>{let{kind:O,ssrcMsg:P,mslabel:M}=w;return this.send(O,P,M)}),T=[],R=!1;return I.forEach(w=>{let{mid:O,needExchangeSDP:P}=w;P&&(R=!0),T.push(O)}),{mids:T,needExchangeSDP:R}}stopSending(E){let I=this.sessionDesc.mediaDescriptions.filter(T=>T.attributes.mid&&E.indexOf(T.attributes.mid)!==-1);if(I.length!==E.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");I.forEach(T=>{T.attributes.mid==="0"||mt()||gb()?T.attributes.ssrcs=[]:(T.attributes.ssrcs=[],T.attributes.direction="inactive",T.media.port="0")}),this.updateBundleMids()}mute(E){let I=this.sessionDesc.mediaDescriptions.find(T=>T.attributes.mid===E);if(!I)throw new Error("mediaDescription not found with ".concat(E," in remote SDP when calling RemoteSDP.mute."));I.attributes.direction="inactive"}unmute(E){let I=this.sessionDesc.mediaDescriptions.find(T=>T.attributes.mid===E);if(!I)throw new Error("mediaDescription not found with ".concat(E," in remote SDP when calling RemoteSDP.unmute."));I.attributes.direction="sendonly"}muteRemote(E){let I=this.sessionDesc.mediaDescriptions.filter(T=>se(E).call(E,T.attributes.mid||""));if(I.length!==E.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");I.forEach(T=>{T.attributes.direction="inactive"})}unmuteRemote(E){let I=this.sessionDesc.mediaDescriptions.filter(T=>se(E).call(E,T.attributes.mid||""));if(I.length!==E.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");I.forEach(T=>{T.attributes.direction="recvonly"})}receive(E,I,T,R){E.forEach((w,O)=>{this.createOrRecycleRecvMedia(w,[],"recvonly",I,T,R[O])}),this.updateBundleMids()}stopReceiving(E){let I=this.sessionDesc.mediaDescriptions.filter(T=>E.indexOf(T.attributes.mid)!==-1);if(I.length!==E.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");I.forEach(T=>{T.media.port="0",T.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(E){let I=this._candidates.filter(T=>T.transport==="udp");if(E===Ji.TCP){if(I.length===0)return;if(N("TCP_CANDIDATE_ONLY")){let T=this._candidates.filter(R=>R.transport==="tcp");I.forEach(R=>{T.findIndex(w=>w.connectionAddress===R.connectionAddress)===-1&&T.push(pa(pa({},R),{},{foundation:"tcpcandidate",priority:Number(R.priority)-1+"",transport:"tcp",port:Number(R.port)+90+""}))}),this._candidates=T}else{let T=[];I.forEach(R=>{T.push(pa(pa({},R),{},{foundation:"tcpcandidate",priority:Number(R.priority)-1+"",transport:"tcp",port:Number(R.port)+90+""}))}),this._candidates=[...I,...T]}}else if(E===Ji.RELAY){if(I.length!==0)return;{let T=this._candidates.filter(R=>R.transport==="tcp");T.forEach(R=>{I.push(pa(pa({},R),{},{foundation:"udpcandidate",priority:Number(R.priority)+1+"",transport:"udp",port:Number(R.port)-90+""}))}),this._candidates=[...I,...T]}}else I.length===0?(this._candidates.filter(T=>T.transport==="tcp").forEach(T=>{I.push(pa(pa({},T),{},{foundation:"udpcandidate",priority:Number(T.priority)+1+"",transport:"udp",port:Number(T.port)-90+""}))}),this._candidates=I):this._candidates=this._candidates.filter(T=>T.transport!=="tcp");for(let T of this.sessionDesc.mediaDescriptions)T.attributes.candidates=this.candidates}restartICE(E){E=vt(E),this._iceParameters=E,this.sessionDesc.mediaDescriptions.forEach(I=>{I.attributes.iceUfrag=E.iceUfrag,I.attributes.icePwd=E.icePwd})}predictReceivingMids(E){let I=[];for(let T=0;T<E;T++)I.push((this.currentMidIndex+T+1).toString(10));return I}findAvailableMediaIndex(E,I){return this.sessionDesc.mediaDescriptions.findIndex(T=>{let R=T.media.mediaType===E&&T.media.port!=="0"&&(T.attributes.direction==="sendonly"||T.attributes.direction==="sendrecv")&&T.attributes.ssrcs.length===0;if(mt()){if(R){let w=this.firefoxSsrcMidMap.get(I[0].ssrcId);return!(w||T.attributes.mid!=="0"&&T.attributes.mid!=="1")||!(!w||w!==T.attributes.mid)}return!1}return R})}createOrRecycleDataChannel(){for(let T of this.sessionDesc.mediaDescriptions)if(T.media.mediaType==="application")return{mediaDesc:T,needExchangeSDP:!1};this.currentMidIndex+=1;let E="".concat(this.currentMidIndex),I={media:{mediaType:"application",port:oh,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(E),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(I),{mediaDesc:I,needExchangeSDP:!0}}createOrRecycleRecvMedia(E,I,T,R,w,O){let P=E._mediaStreamTrack.kind,M=this.rtpCapabilities.recv,V=Rc(P,M,this.localCapabilities.send,P===me.VIDEO?R:w),F=P===me.VIDEO?M.videoExtensions:M.audioExtensions;this.currentMidIndex+=1;let Y="".concat(this.currentMidIndex),J={media:{mediaType:P,port:oh,protos:["UDP","TLS","RTP","SAVPF"],fmts:V.map(pe=>pe.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:F,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:I,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:V,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:T,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(Y)}};J=this.mungRecvMediaDsec(J,E,O);let Z=this.findFirstClosedMedia(P);if(Z){let pe=this.sessionDesc.mediaDescriptions.indexOf(Z);this.sessionDesc.mediaDescriptions[pe]=J}else this.sessionDesc.mediaDescriptions.push(J);return J}updateRemoteCodec(E,I,T){let R=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(J=>J.rtpMap&&J.rtpMap.encodingName.toLowerCase()||"").filter(J=>{var Z;return se(Z=Object.keys(Il)).call(Z,J)}))],w=new Set(I);if(R.every(J=>w.has(J)))return S.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(I)),!1;let O=this._rtpCapabilities.recv.videoCodecs.filter(J=>I.some(Z=>{var pe;return se(pe=J.rtpMap&&J.rtpMap.encodingName.toLowerCase()||"").call(pe,Z)}));if(O.length===0)return S.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(R," codecs: ").concat(I)),!1;let P=[...new Set(O.map(J=>J.rtpMap&&J.rtpMap.encodingName.toLowerCase()||""))],M;if(S.debug("updateRemoteCodec, from ".concat(R," to ").concat(P)),E.length===0)M=this.sessionDesc.mediaDescriptions.filter(J=>J.media.mediaType==="video"&&J.attributes.direction==="recvonly");else if(M=this.sessionDesc.mediaDescriptions.filter(J=>J.attributes.mid&&se(E).call(E,J.attributes.mid)&&J.attributes.direction==="recvonly"),M.length!==E.length)return S.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(E,", codecs: ").concat(I)),!1;if(N("USE_PUB_RTX")||N("USE_SUB_RTX")){let J=Cv(O,this.rtpCapabilities.recv.videoCodecs);O.push(...J)}this._rtpCapabilities.recv.videoCodecs=O;let V=this.localCapabilities.send,F=this.rtpCapabilities.recv,Y=Rc(me.VIDEO,F,V,T);return M.forEach(J=>{let Z=Y.map(pe=>pe.payloadType.toString(10));S.debug("updateRemoteCodec mid: ".concat(J.attributes.mid,", from ").concat(J.attributes.payloads," to ").concat(Y)),J.attributes.payloads=Y,J.media.fmts=Z}),!0}createOrRecycleSendMedia(E,I,T,R,w){let O=this.rtpCapabilities.send,P=E===me.VIDEO?O.videoCodecs:O.audioCodecs,M=E===me.VIDEO?O.videoExtensions:O.audioExtensions;this.currentMidIndex+=1;let V="".concat(this.currentMidIndex),F={media:{mediaType:E,port:oh,protos:["UDP","TLS","RTP","SAVPF"],fmts:P.map(J=>J.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:M,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:I,ssrcGroups:T,rtcpFeedbackWildcards:[],payloads:P,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:R,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(V)}};F=this.mungSendMediaDesc(F,w);let Y=this.findFirstClosedMedia(E);if(Y){let J=this.sessionDesc.mediaDescriptions.indexOf(Y);this.sessionDesc.mediaDescriptions[J]=F}else this.sessionDesc.mediaDescriptions.push(F);return F}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(E=>E.media.port!=="0").map(E=>E.attributes.mid)}mungRecvMediaDsec(E,I,T){let R=vt(E);return c_(R),la(R,I),l_(R,I),Tv(R),td(R,T,this.localCapabilities.send),R}mungSendMediaDesc(E,I){let T=vt(E);return td(T,I,this.localCapabilities.recv),So(T),T}updateRecvMedia(E,I){let T=this.sessionDesc.mediaDescriptions.findIndex(R=>R.attributes.mid===E);if(T!==-1){let R=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[T],I);this.sessionDesc.mediaDescriptions[T]=R}}bumpMid(E){this.currentMidIndex+=E}findFirstClosedMedia(E){return this.sessionDesc.mediaDescriptions.find(I=>mt()?I.media.port==="0"&&I.media.mediaType===E:I.media.port==="0")}findPreloadMediaDesc(E){return this.sessionDesc.mediaDescriptions.find(I=>{var T;return((T=I.attributes)===null||T===void 0||(T=T.ssrcs[0])===null||T===void 0?void 0:T.ssrcId)===E[0].ssrcId})}getSSRC(E){var I;return(I=this.sessionDesc.mediaDescriptions.find(T=>T.attributes.mid===E))===null||I===void 0?void 0:I.attributes.ssrcs}}({remoteIceParameters:t,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:n,remoteSetup:o,localCapabilities:this.localCapabilities,cname:a}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let l=this.remoteSDP.toString(),d=Nt.parse(this.initialOffer.sdp),u=d.mediaDescriptions.find(E=>E.media.mediaType==="audio");u&&So(u),this.useXR&&d_(d);let p=Nt.print(d),m=this.logSDPExchange(p||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:p}),m==null||m(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l});let f=this.peerConnection.getTransceivers()[0];if(f!=null&&f.receiver&&this.tryBindTransportEvents(f.receiver),N("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();let E=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:E});let I=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(I)}}catch(l){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(l.toString()))}}send(t,i,r){var n=this;return Vr(function*(){let o=yield Ue(n.mutex.lock("From P2PConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let a=[];t.forEach(T=>{let R=n.peerConnection.addTransceiver(T._mediaStreamTrack,{direction:"sendonly"});a.push(R),T._updateRtpTransceiver(R)}),mt()&&N("SIMULCAST")===!0&&(yield Ue(n.applySimulcastForFirefox(a,t)));let l=yield Ue(n.peerConnection.createOffer()),d=n.remoteSDP.predictReceivingMids(t.length),u=n.mungSendOfferSDP(l.sdp,t,d),p=Nt.parse(u),m=d.map(T=>{let R=p.mediaDescriptions.find(w=>w.attributes.mid===T);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return Sv(R,N("USE_PUB_RTX"))}),f;try{f=yield m}catch(T){f=[],n.remoteSDP.receive(t,i,r,f);let R=n.remoteSDP.toString();throw yield Ue(n.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield Ue(n.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield Ue(n.stopSending(d,!0)),T}n.remoteSDP.receive(t,i,r,f);let E=n.remoteSDP.toString(),I=n.logSDPExchange(u,"offer","local","send");return yield Ue(n.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield Ue(n.applySimulcastEncodings(a,t)),yield Ue(n.applySendEncodings(a,t)),I==null||I(E),yield Ue(n.peerConnection.setRemoteDescription({type:"answer",sdp:E})),a.map((T,R)=>{let w=d[R];return{localSSRC:m[R],id:w,transceiver:T}})}catch(a){throw a instanceof j?a:new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(a.toString()))}finally{o()}})()}async createDataChannels(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(t);if(r&&r.readyState==="open")S.debug("[P2PConnection] Channels are already available and can be reused directly.");else{let o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");r=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:N("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,r)}i.forEach(o=>{o._updateOriginDataChannel(r)});let{needExchangeSDP:n}=this.remoteSDP.sendDataChannel();if(n){let o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});let a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),S.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else S.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(r){throw r instanceof j?r:new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(t){try{let i=this.dataStreamChannelMap.get(t);return i&&(i.id&&this.recoveredDataChannelIds.push(i.id),i.close()),void this.dataStreamChannelMap.delete(t)}catch(i){throw i instanceof j?i:new j(A.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(i.toString()))}}async stopSending(t,i){let r=i?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let n=this.peerConnection.getTransceivers().filter(d=>t.indexOf(d.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(d=>{var u;E_(this.id+d.mid),d.direction="inactive",(u=d.stop)===null||u===void 0||u.call(d)});let o=await this.peerConnection.createOffer(),a=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);let l=this.remoteSDP.toString();a==null||a(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(n){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}finally{r&&r()}}async receive(t,i,r,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));let{mid:o,needExchangeSDP:a}=this.remoteSDP.send(t,i,r,n);if(a){let d=this.remoteSDP.toString(),u=this.logSDPExchange(d,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:d});let p=await this.peerConnection.createAnswer(),m=this.mungReceiveAnswerSDP(p.sdp,o,t);u==null||u(m||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:m}),S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else S.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));let l=this.peerConnection.getTransceivers().find(d=>d.mid===o);if(!l)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:l.receiver.track,id:o,transceiver:l}}catch(o){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let{mids:i,needExchangeSDP:r}=this.remoteSDP.batchSend(t);if(r){let n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let a=await this.peerConnection.createAnswer();o==null||o(a.sdp||""),await this.peerConnection.setLocalDescription(a),S.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else S.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return i.map(n=>{let o=this.peerConnection.getTransceivers().find(a=>a.mid===n);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:n,transceiver:o}})}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);let i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);let i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);let i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(a=>{a.direction="inactive"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);let o=this.remoteSDP.toString();n==null||n(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(a,l)=>{a.direction="sendonly"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t);let o=this.remoteSDP.toString();n==null||n(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new j(A.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return Vr(function*(){let r=yield Ue(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ye().supportPCSetConfiguration){let u=i.peerConnection.getConfiguration(),p=t===Ji.RELAY?"relay":"all";u.iceTransportPolicy!==p&&(S.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(u.iceTransportPolicy,"] to [").concat(p,"]")),u.iceTransportPolicy=p,i.peerConnection.setConfiguration(u))}else if(t===Ji.RELAY)return;i.remoteSDP.updateCandidates(t);let n=yield Ue(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let o=go(n.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);let l=i.remoteSDP.toString(),d=i.logSDPExchange(n.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield Ue(i.peerConnection.setLocalDescription(n)),d==null||d(l),yield Ue(i.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(n){S.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),n)}finally{r()}})()}close(){var t;this.peerConnection.getTransceivers().forEach(i=>{E_(this.id+i.mid)}),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return ma(ma({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let r=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(r.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);let o=this.remoteSDP.toString(),a=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),a==null||a(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new j(A.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,i){let r=this.peerConnection.getTransceivers().filter(n=>n.mid===t);r.length===1&&(this.isVP8Simulcast(i)?mt()||await this.applySimulcastEncodings(r,[i]):await this.applySendEncodings(r,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){let r=this.peerConnection.getTransceivers().find(n=>n.mid===i);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){let t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){let i=t[0].transport.iceTransport,{local:r,remote:n}=i.getSelectedCandidatePair();return{local:ma(ma({},Zo),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port}),remote:ma(ma({},Zo),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},N("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){let i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Rl(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...Ch.turnServerConfigToIceServers(t.turnServer.servers)),N("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...Ch.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),N("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(i.iceTransportPolicy="relay")}))),N("ENABLE_ENCODED_TRANSFORM")&&Ye().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(t){let i=[];return t.forEach(r=>{r.security?r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ta(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!N("FORCE_TURN_TCP")&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),i}tryBindTransportEvents(t){let i=t.transport;if(i){this.transportEventReceiver=t,i.onstatechange=()=>{var n;i!=null&&i.state&&((n=this.onDTLSTransportStateChange)===null||n===void 0||n.call(this,i.state))},i.onerror=n=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in n?n.error:n)};let r=i.iceTransport;r&&(r.onstatechange=()=>{let n=i==null?void 0:i.iceTransport.state;var o;n&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,n))},r.getSelectedCandidatePair&&(r.onselectedcandidatepairchange=()=>{if(r.getSelectedCandidatePair()){let{local:n,remote:o}=r.getSelectedCandidatePair();S.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol}),", remote ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,i){var r,n;if(i||(i=this.peerConnection.getSenders().find(T=>T.track===t._mediaStreamTrack)),!i)return S.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return S.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Ye().supportSetRtpSenderParameters)return S.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let o={},a={};switch(t._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}let l=function(T,R){return T.getTransceivers().find(w=>w.sender.track===R||w.receiver.track===R)}(this.peerConnection,t._mediaStreamTrack),d=h9(t);if(W9(t)&&l&&i&&d&&this.getLocalVideoStats&&se(r=["vp8","vp9"]).call(r,this.store.codec)){var u;let T=o.degradationPreference||(se(u=t._hints).call(u,Rt.CUSTOM_TRACK)?N("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");(function(R,w,O,P,M,V){if(E_(R),P!=="balanced"&&P!=="maintain-framerate"&&P!=="maintain-resolution")return;let F=-1;i1(R,w);let Y=window.setInterval(()=>{let Z=f_.get(R);if(!N("ENABLE_AG_ADAPTATION")||!Z)return void E_(R);let pe=V();if(pe.sendPackets>0&&pe.OutgoingAvailableBandwidth>0){if(F===-1)return void(F=Date.now());if(Date.now()-F<1e3)return;let Ke=pe.sendFrameRate,rt=pe.OutgoingAvailableBandwidth,[Ct,Zt]=G9(R,Ke,rt,Z.adaptationConfig,w,P);Zt&&(O.qualityLimitationReason=Zt),Ct&&Z.adaptationConfig.scale!==Ct.scale&&(S.debug("[".concat(R,"] applyAdaptation: ").concat(O.qualityLimitationReason,`
           sendFps `).concat(Ke,", bwe ").concat(rt,", switch from ").concat(Z.adaptationConfig.scale," to ").concat(Ct.scale," ")),Z.adaptationConfig=Av(Av({},Z.adaptationConfig),Ct),M(Ct))}},N("CHECK_LOCAL_STATS_INTERVAL")),J=Av({},w);f_.set(R,{timer:Y,adaptationConfig:J,originConfig:w,adaptationFunc:M}),S.debug("[".concat(R,"] start adaptation, originConfig: ").concat(JSON.stringify(w),", degradationPreference: ").concat(P))})(this.id+l.mid,d,this,T,R=>{i&&this.updateAdaptation(i,R)},this.getLocalVideoStats.bind(this))}if(t._encoderConfig){var p;let{bitrateMax:T,frameRate:R,scaleResolutionDownBy:w}=t._encoderConfig;T&&(a.maxBitrate=1e3*T),(se(p=t._hints).call(p,Rt.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(R&&(a.maxFramerate=Rr(R)),w&&w>=1&&(a.scaleResolutionDownBy=w))}let{maxFramerate:m}=N("ENCODER_CONFIG_LIMIT");if(m&&typeof m=="number"&&(a.maxFramerate=a.maxFramerate?Math.min(a.maxFramerate,m):m),N("DSCP_TYPE")&&qs()){var f;let T=N("DSCP_TYPE");se(f=["very-low","low","medium","high"]).call(f,T)&&(a.networkPriority=T)}let E=i.getParameters(),I=(n=E.encodings)===null||n===void 0?void 0:n[0];mt()&&!I&&(o.encodings=[a]),I&&Object.assign(I,a),Object.assign(E,o),S.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(E.encodings))),await i.setParameters(E)}async updateAdaptation(t,i){var r,n;if(!t)return S.debug("[updateAdaptation] no rtpSender found");if(!Ye().supportSetRtpSenderParameters)return S.debug("[updateAdaptation] Browser not support set rtp-sender parameters");let o={},{bitrateMax:a,frameRate:l,scaleResolutionDownBy:d}=i;a&&(o.maxBitrate=1e3*a),l&&(o.maxFramerate=Rr(l)),d&&d>=1&&se(r=["vp8","vp9"]).call(r,this.store.codec)&&(o.scaleResolutionDownBy=d);let u=t.getParameters(),p=(n=u.encodings)===null||n===void 0?void 0:n[0];p&&Object.assign(p,o),Object.assign(u,{});try{await t.setParameters(u),S.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(u.encodings)))}catch(m){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?S.debug("[updateAdaptation] peerConnection not connected}"):S.debug("[updateAdaptation] updateRtpSenderEncodings failed",m):S.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,i){try{if(!Ye().supportSetRtpSenderParameters||t.length!==i.length)return;for(let r=0;r<t.length;r++){let n=t[r],o=i[r];o instanceof Et&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,n.sender)}}catch{S.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,i,r){let n=Nt.parse(t);return i.forEach((o,a)=>{let l=r[a],d=n.mediaDescriptions.find(u=>u.attributes.mid===l);d&&(la(d,o),vv(d,o,this.store.codec))}),Nt.print(n)}mungReceiveAnswerSDP(t,i,r){let n=Nt.parse(t),o=n.mediaDescriptions.find(a=>a.attributes.mid===i);return o&&(r===me.AUDIO&&o.media.mediaType==="audio"&&So(o),this.useXR&&d_(n)),Nt.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,r)=>{var n;(n=this.onFirstVideoDecoded)===null||n===void 0||n.call(this,t,i,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let d=0;d<t.length;d++){var r,n,o,a,l;let u=t[d],p=i[d];if(p instanceof Et&&!se(r=p._hints).call(r,Rt.LOW_STREAM)&&(n=p._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((o=p._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(a=p._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((l=p._scalabilityMode)===null||l===void 0?void 0:l.numSpatialLayers)>1&&this.store.codec==="vp8"){let m={},f={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{rid:"m",active:!0,maxBitrate:f.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:f.high}];let E=u.sender.getParameters();await u.sender.setParameters(Object.assign(E,m))}}}async applySimulcastEncodings(t,i){if(!mt()&&t.length===i.length)for(let r=0;r<t.length;r++){let n=i[r];if(n instanceof Et&&this.isVP8Simulcast(n)){let o=t[r],a={},l={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:l.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:l.medium,scaleResolutionDownBy:4}];let d=o.sender.getParameters();await o.sender.setParameters(Object.assign(d,a))}}}isVP8Simulcast(t){var i,r,n,o,a;return!!(t instanceof Et&&N("SIMULCAST")&&this.store.codec==="vp8"&&!se(i=t._hints).call(i,Rt.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((n=t._encoderConfig)===null||n===void 0?void 0:n.bitrateMax)>200&&(o=t._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=t._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1)}logSDPExchange(t,i,r,n){if(N("SDP_LOGGING"))return S.upload("[".concat(this.store.clientId,"] exchanging ").concat(r," ").concat(i," SDP during P2PConnection.").concat(n,`
`),t),i==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",n)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;let i=this.remoteSDP.getSSRC(t);return i==null?void 0:i[0].ssrcId}setConfiguration(t){if(Ye().supportPCSetConfiguration){let i=Ch.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},ie(Qe.prototype,"updateRemoteRTPCapabilities",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"updateRemoteRTPCapabilities"),Qe.prototype),ie(Qe.prototype,"connect",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"connect"),Qe.prototype),ie(Qe.prototype,"createDataChannels",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"createDataChannels"),Qe.prototype),ie(Qe.prototype,"receive",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"receive"),Qe.prototype),ie(Qe.prototype,"batchReceive",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"batchReceive"),Qe.prototype),ie(Qe.prototype,"stopReceiving",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"stopReceiving"),Qe.prototype),ie(Qe.prototype,"muteRemote",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"muteRemote"),Qe.prototype),ie(Qe.prototype,"unmuteRemote",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"unmuteRemote"),Qe.prototype),ie(Qe.prototype,"muteLocal",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"muteLocal"),Qe.prototype),ie(Qe.prototype,"unmuteLocal",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"unmuteLocal"),Qe.prototype),ie(Qe.prototype,"close",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"close"),Qe.prototype),ie(Qe.prototype,"updateEncoderConfig",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"updateEncoderConfig"),Qe.prototype),ie(Qe.prototype,"updateSendParameters",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"updateSendParameters"),Qe.prototype),ie(Qe.prototype,"replaceTrack",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"replaceTrack"),Qe.prototype),ie(Qe.prototype,"updateAdaptation",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"updateAdaptation"),Qe.prototype),ie(Qe.prototype,"getRemoteSSRC",[Cr],Object.getOwnPropertyDescriptor(Qe.prototype,"getRemoteSSRC"),Qe.prototype),Qe);function Cr(e,t,i){let r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let n=this.mutex,o=await n.lock("From P2PConnection.".concat(t));try{for(var a=arguments.length,l=new Array(a),d=0;d<a;d++)l[d]=arguments[d];return await r.apply(this,l)}finally{o()}},i}function s1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function a1(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?s1(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):s1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let c1=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,g_="9",Ov=2e4,bv=4e4;class H9{get localCapabilities(){return vt(this._localCapabilities)}get rtpCapabilities(){return vt(this._rtpCapabilities)}get candidates(){return vt(this._candidates)}get iceParameters(){return vt(this._iceParameters)}get dtlsParameters(){return vt(this._dtlsParameters)}constructor(t){y(this,"sessionDesc",void 0),y(this,"_localCapabilities",void 0),y(this,"_rtpCapabilities",void 0),y(this,"_candidates",void 0),y(this,"_iceParameters",void 0),y(this,"_dtlsParameters",void 0),y(this,"setup",void 0),y(this,"currentMidIndex",void 0),y(this,"cname",void 0),y(this,"firefoxSsrcMidMap",new Map),t=vt(t);let{remoteIceParameters:i,remoteDtlsParameters:r,candidates:n,remoteRTPCapabilities:o,remoteSetup:a,localCapabilities:l,cname:d}=t,u=Nt.parse(c1);this._rtpCapabilities=o,this._candidates=n,this._iceParameters=i,this._dtlsParameters=r,this._localCapabilities=l,this.setup=a,this.cname=d;let p=this.rtpCapabilities.send;for(let m of u.mediaDescriptions){if(m.attributes.iceUfrag=i.iceUfrag,m.attributes.icePwd=i.icePwd,m.attributes.fingerprints=r.fingerprints,m.attributes.candidates=n,m.attributes.setup=a,m.media.mediaType==="application"&&(m.attributes.sctpPort="5000"),m.media.mediaType==="video"&&(m.media.fmts=p.videoCodecs.map(f=>f.payloadType.toString(10)),m.attributes.payloads=p.videoCodecs,m.attributes.extmaps=p.videoExtensions,N("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:f,ssrcGroups:E}=on([{ssrcId:bv,rtx:N("USE_SUB_RTX")?40001:void 0}],this.cname);m.attributes.ssrcs=f,m.attributes.ssrcGroups=E}if(m.media.mediaType==="audio"&&(m.media.fmts=p.audioCodecs.map(f=>f.payloadType.toString(10)),m.attributes.payloads=p.audioCodecs,m.attributes.extmaps=p.audioExtensions,So(m),N("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:f,ssrcGroups:E}=on([{ssrcId:Ov}],this.cname);m.attributes.ssrcs=f,m.attributes.ssrcGroups=E}}this.sessionDesc=u,this.currentMidIndex=u.mediaDescriptions.length-1}updateRemoteRTPCapabilities(t){let i=Nt.parse(c1);this._rtpCapabilities=t;let r=this.rtpCapabilities.send;for(let n of i.mediaDescriptions){if(n.attributes.iceUfrag=this._iceParameters.iceUfrag,n.attributes.icePwd=this._iceParameters.icePwd,n.attributes.fingerprints=this._dtlsParameters.fingerprints,n.attributes.candidates=this._candidates,n.attributes.setup=this.setup,n.media.mediaType==="application"&&(n.attributes.sctpPort="5000"),n.media.mediaType==="video"&&(n.media.fmts=r.videoCodecs.map(o=>o.payloadType.toString(10)),n.attributes.payloads=r.videoCodecs,n.attributes.extmaps=r.videoExtensions,N("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:o,ssrcGroups:a}=on([{ssrcId:bv,rtx:N("USE_SUB_RTX")?40001:void 0}],this.cname);n.attributes.ssrcs=o,n.attributes.ssrcGroups=a}if(n.media.mediaType==="audio"&&(n.media.fmts=r.audioCodecs.map(o=>o.payloadType.toString(10)),n.attributes.payloads=r.audioCodecs,n.attributes.extmaps=r.audioExtensions,N("PRELOAD_MEDIA_COUNT")>0)){let{ssrcs:o,ssrcGroups:a}=on([{ssrcId:Ov}],this.cname);n.attributes.ssrcs=o,n.attributes.ssrcGroups=a}}this.sessionDesc=i,this.currentMidIndex=i.mediaDescriptions.length-1}preloadRemoteMedia(t){this.rtpCapabilities;let i=this.candidates,r=this.dtlsParameters,n=this.iceParameters,o=this.rtpCapabilities.send;for(let a=1;a<t;a++){let l=2*a+Ov,d=2*a+bv,{ssrcs:u,ssrcGroups:p}=on([{ssrcId:l}],this.cname),{ssrcs:m,ssrcGroups:f}=on([{ssrcId:d,rtx:N("USE_SUB_RTX")?d+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:g_,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.videoCodecs.map(E=>E.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:i,extmaps:o.videoExtensions,fingerprints:r.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:m,ssrcGroups:f,rtcpFeedbackWildcards:[],payloads:o.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*a-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:g_,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.audioCodecs.map(E=>E.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:n.iceUfrag,icePwd:n.icePwd,unrecognized:[],candidates:i,extmaps:o.audioExtensions,fingerprints:r.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:u,ssrcGroups:p,rtcpFeedbackWildcards:[],payloads:o.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*a)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return Nt.print(this.sessionDesc)}send(t,i,r,n){let{ssrcs:o,ssrcGroups:a}=on(i,this.cname,N("SYNC_GROUP")?r:void 0),l=this.findPreloadMediaDesc(o);if(l){if(mt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,l.attributes.mid),n&&(n.twcc||n.remb)){let d=this.sessionDesc.mediaDescriptions.indexOf(l);return this.sessionDesc.mediaDescriptions[d]=this.mungSendMediaDesc(l,n),{mid:l.attributes.mid,needExchangeSDP:!0}}return{mid:l.attributes.mid,needExchangeSDP:!1}}{let d=this.findAvailableMediaIndex(t,o),u;return d===-1||pi()||ji()||Eb()||d===0&&N("USE_SUB_RTX")?(u=this.createOrRecycleSendMedia(t,o,a,"sendonly",n),this.updateBundleMids()):(u=vt(this.sessionDesc.mediaDescriptions[d]),u.attributes.direction="sendonly",u.attributes.ssrcs=o,u.attributes.ssrcGroups=a,this.sessionDesc.mediaDescriptions[d]=this.mungSendMediaDesc(u,n)),mt()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,u.attributes.mid),{mid:u.attributes.mid,needExchangeSDP:!0}}}batchSend(t){let i=t.map(o=>{let{kind:a,ssrcMsg:l,mslabel:d}=o;return this.send(a,l,d)}),r=[],n=!1;return i.forEach(o=>{let{mid:a,needExchangeSDP:l}=o;l&&(n=!0),r.push(a)}),{mids:r,needExchangeSDP:n}}stopSending(t){let i=this.sessionDesc.mediaDescriptions.filter(r=>r.attributes.mid&&t.indexOf(r.attributes.mid)!==-1);if(i.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");i.forEach(r=>{r.attributes.mid==="0"||mt()||pi()||ji()?r.attributes.ssrcs=[]:(r.attributes.ssrcs=[],r.attributes.direction="inactive",r.media.port="0")}),this.updateBundleMids()}mute(t){let i=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===t);if(!i)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(t){let i=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===t);if(!i)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}muteRemote(t){let i=this.sessionDesc.mediaDescriptions.filter(r=>se(t).call(t,r.attributes.mid||""));if(i.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(r=>{r.attributes.direction="inactive"})}unmuteRemote(t){let i=this.sessionDesc.mediaDescriptions.filter(r=>se(t).call(t,r.attributes.mid||""));if(i.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");i.forEach(r=>{r.attributes.direction="recvonly"})}receive(t,i,r,n){t.forEach((o,a)=>{this.createOrRecycleRecvMedia(o,[],"recvonly",i,r,n[a])}),this.updateBundleMids()}stopReceiving(t){let i=this.sessionDesc.mediaDescriptions.filter(r=>t.indexOf(r.attributes.mid)!==-1);if(i.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");i.forEach(r=>{r.media.port="0",r.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(t){t===Ji.TCP?this._candidates.forEach(i=>{this._candidates.findIndex(r=>r.transport==="tcp"&&r.connectionAddress===i.connectionAddress&&r.port===i.port)===-1&&this._candidates.push(a1(a1({},i),{},{foundation:"tcpcandidate",priority:Number(i.priority)-1+"",transport:"tcp",port:Number(i.port)+90+""}))}):this._candidates=this._candidates.filter(i=>i.transport!=="tcp");for(let i of this.sessionDesc.mediaDescriptions)i.attributes.candidates=this.candidates}restartICE(t){t=vt(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=t.iceUfrag,i.attributes.icePwd=t.icePwd})}predictReceivingMids(t){let i=[];for(let r=0;r<t;r++)i.push((this.currentMidIndex+r+1).toString(10));return i}findAvailableMediaIndex(t,i){return this.sessionDesc.mediaDescriptions.findIndex(r=>{let n=r.media.mediaType===t&&r.media.port!=="0"&&(r.attributes.direction==="sendonly"||r.attributes.direction==="sendrecv")&&r.attributes.ssrcs.length===0;if(mt()){if(n){let o=this.firefoxSsrcMidMap.get(i[0].ssrcId);return!(o||r.attributes.mid!=="0"&&r.attributes.mid!=="1")||!(!o||o!==r.attributes.mid)}return!1}return n})}createOrRecycleRecvMedia(t,i,r,n,o,a){let l=t._mediaStreamTrack.kind,d=this.rtpCapabilities.recv,u=Rc(l,d,this.localCapabilities.send,l===me.VIDEO?n:o),p=l===me.VIDEO?d.videoExtensions:d.audioExtensions;this.currentMidIndex+=1;let m="".concat(this.currentMidIndex),f={media:{mediaType:l,port:g_,protos:["UDP","TLS","RTP","SAVPF"],fmts:u.map(I=>I.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:p,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:u,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(m)}};f=this.mungRecvMediaDsec(f,t,a);let E=this.findFirstClosedMedia(l);if(E){let I=this.sessionDesc.mediaDescriptions.indexOf(E);this.sessionDesc.mediaDescriptions[I]=f}else this.sessionDesc.mediaDescriptions.push(f);return f}updateRemoteCodec(t,i,r){let n=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(f=>f.rtpMap&&f.rtpMap.encodingName.toLowerCase()||"").filter(f=>{var E;return se(E=Object.keys(Il)).call(E,f)}))],o=new Set(i);if(n.every(f=>o.has(f)))return S.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(i)),!1;let a=this._rtpCapabilities.recv.videoCodecs.filter(f=>i.some(E=>{var I;return se(I=f.rtpMap&&f.rtpMap.encodingName.toLowerCase()||"").call(I,E)}));if(a.length===0)return S.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(n," codecs: ").concat(i)),!1;let l=[...new Set(a.map(f=>f.rtpMap&&f.rtpMap.encodingName.toLowerCase()||""))],d;if(S.debug("updateRemoteCodec, from ".concat(n," to ").concat(l)),t.length===0)d=this.sessionDesc.mediaDescriptions.filter(f=>f.media.mediaType==="video"&&f.attributes.direction==="recvonly");else if(d=this.sessionDesc.mediaDescriptions.filter(f=>f.attributes.mid&&se(t).call(t,f.attributes.mid)&&f.attributes.direction==="recvonly"),d.length!==t.length)return S.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(i)),!1;this._rtpCapabilities.recv.videoCodecs=a;let u=this.localCapabilities.send,p=this.rtpCapabilities.recv,m=Rc(me.VIDEO,p,u,r);return d.forEach(f=>{let E=m.map(I=>I.payloadType.toString(10));S.debug("updateRemoteCodec mid: ".concat(f.attributes.mid,", from ").concat(f.attributes.payloads," to ").concat(m)),f.attributes.payloads=m,f.media.fmts=E}),!0}createOrRecycleSendMedia(t,i,r,n,o){let a=this.rtpCapabilities.send,l=t===me.VIDEO?a.videoCodecs:a.audioCodecs,d=t===me.VIDEO?a.videoExtensions:a.audioExtensions;this.currentMidIndex+=1;let u="".concat(this.currentMidIndex),p={media:{mediaType:t,port:g_,protos:["UDP","TLS","RTP","SAVPF"],fmts:l.map(f=>f.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:d,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:i,ssrcGroups:r,rtcpFeedbackWildcards:[],payloads:l,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};p=this.mungSendMediaDesc(p,o);let m=this.findFirstClosedMedia(t);if(m){let f=this.sessionDesc.mediaDescriptions.indexOf(m);this.sessionDesc.mediaDescriptions[f]=p}else this.sessionDesc.mediaDescriptions.push(p);return p}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}mungRecvMediaDsec(t,i,r){let n=vt(t);return c_(n),la(n,i),l_(n,i),Tv(n),td(n,r,this.localCapabilities.send),n}mungSendMediaDesc(t,i){let r=vt(t);return td(r,i,this.localCapabilities.recv),So(r),r}updateRecvMedia(t,i){let r=this.sessionDesc.mediaDescriptions.findIndex(n=>n.attributes.mid===t);if(r!==-1){let n=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[r],i);this.sessionDesc.mediaDescriptions[r]=n}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(i=>mt()?i.media.port==="0"&&i.media.mediaType===t:i.media.port==="0")}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(i=>{var r;return((r=i.attributes)===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId)===t[0].ssrcId})}getSSRC(t){var i;return(i=this.sessionDesc.mediaDescriptions.find(r=>r.attributes.mid===t))===null||i===void 0?void 0:i.attributes.ssrcs}}var Ze;function l1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function S_(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?l1(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):l1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let K9=(Ze=class cf extends ym{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let t;return this.localCapabilities&&(t=id(this.localCapabilities)),[...new Set(t&&t.send.videoCodecs.map(i=>i.rtpMap&&i.rtpMap.encodingName.toLowerCase()||"").filter(i=>{var r;return se(r=Object.keys(Il)).call(r,i)}))]}constructor(t,i,r){super(t,i),y(this,"store",void 0),y(this,"peerConnection",void 0),y(this,"remoteSDP",void 0),y(this,"initialOffer",void 0),y(this,"transportEventReceiver",void 0),y(this,"statsFilter",void 0),y(this,"useXR",N("USE_XR")),y(this,"localCapabilities",void 0),y(this,"localCandidateCount",0),y(this,"allCandidatesReceived",!1),y(this,"remoteCodecs",void 0),y(this,"dataStreamChannelMap",new Map),y(this,"establishPromise",void 0),y(this,"mutex",new Ti("NVExtentionsConnection-mutex")),y(this,"rtcMedia",void 0),this.store=i,this.peerConnection=r,this.statsFilter=a_(this.peerConnection,N("STATS_UPDATE_INTERVAL"),void 0,mt()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(t){try{let i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let r=go(i.sdp),n=await Rv({filterRTX:!N("USE_PUB_RTX")&&!N("USE_SUB_RTX"),filterVideoFec:N("FILTER_VIDEO_FEC"),filterAudioFec:N("FILTER_AUDIO_FEC"),filterVideoCodec:N("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=n,this.initialOffer=i,S_(S_({},r),{},{rtpCapabilities:n,offerSDP:i.sdp})}catch(i){throw new U(A.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}}async connect(t,i,r,n,o,a){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new H9({remoteIceParameters:t,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:n,remoteSetup:o,localCapabilities:id(this.localCapabilities),cname:a});let l=this.remoteSDP.toString(),d=Nt.parse(this.initialOffer.sdp),u=d.mediaDescriptions.find(f=>f.media.mediaType==="audio");u&&So(u),this.useXR&&d_(d);let p=Nt.print(d),m=this.logSDPExchange(p||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:p}),m==null||m(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(l){throw new U(A.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(l.toString()))}}async updateRemoteRTPCapabilities(t,i){if(this.remoteCodecs=i,!this.remoteSDP)return void S.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(t,i,this.store.codec)){let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r);let o=this.remoteSDP.toString();n==null||n(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else S.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(t){var i,r,n,o;(i=this.remoteSDP)===null||i===void 0||i.updateRemoteRTPCapabilities(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((o=this.remoteSDP)===null||o===void 0||o.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(r=this.remoteSDP)===null||r===void 0||r.preloadRemoteMedia(2);let a=(n=this.remoteSDP)===null||n===void 0?void 0:n.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:a});let l=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(l),S.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(t,i,r){var n=this;return Vr(function*(){let o=yield Ue(n.mutex.lock("From NVExtentionsConnection.send"));try{if(!n.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");let a=[];t.forEach(T=>{let R=n.peerConnection.addTransceiver(T._mediaStreamTrack,{direction:"sendonly"});a.push(R)}),mt()&&N("SIMULCAST")===!0&&(yield Ue(n.applySimulcastForFirefox(a,t)));let l=yield Ue(n.peerConnection.createOffer()),d=n.remoteSDP.predictReceivingMids(t.length),u=n.mungSendOfferSDP(l.sdp,t,d),p=Nt.parse(u),m=d.map(T=>{let R=p.mediaDescriptions.find(w=>w.attributes.mid===T);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return Sv(R,N("USE_PUB_RTX"))}),f;try{f=yield m}catch(T){f=[],n.remoteSDP.receive(t,i,r,f);let R=n.remoteSDP.toString();throw yield Ue(n.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield Ue(n.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield Ue(n.stopSending(d,!0)),T}n.remoteSDP.receive(t,i,r,f);let E=n.remoteSDP.toString(),I=n.logSDPExchange(u,"offer","local","send");return yield Ue(n.peerConnection.setLocalDescription({type:"offer",sdp:u})),yield Ue(n.applySimulcastEncodings(a,t)),yield Ue(n.applySendEncodings(a,t)),I==null||I(E),yield Ue(n.peerConnection.setRemoteDescription({type:"answer",sdp:E})),a.map((T,R)=>{let w=d[R];return{localSSRC:m[R],id:w,transceiver:T}})}catch(a){throw a instanceof U?a:new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(a.toString()))}finally{o()}})()}async stopSending(t,i){let r=i?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");let n=this.peerConnection.getTransceivers().filter(d=>t.indexOf(d.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");n.map(d=>{var u;d.direction="inactive",(u=d.stop)===null||u===void 0||u.call(d)});let o=await this.peerConnection.createOffer(),a=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);let l=this.remoteSDP.toString();a==null||a(l),await this.peerConnection.setRemoteDescription({type:"answer",sdp:l})}catch(n){throw new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(n.toString()))}finally{r&&r()}}async createDataChannels(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let r=this.dataStreamChannelMap.get(t);return r&&r.readyState==="open"?S.debug("[P2PConnection] Channels are already available and can be reused directly."):(r=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:N("DATASTREAM_MAX_RETRANSMITS")}),r.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,r)),void i.forEach(n=>{n._updateOriginDataChannel(r)})}catch(r){throw r instanceof U?r:new U(A.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(r.toString()))}}async stopDataChannels(t){try{let i=this.dataStreamChannelMap.get(t);return i==null||i.close(),void this.dataStreamChannelMap.delete(t)}catch(i){throw i instanceof U?i:new U(A.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(i.toString()))}}async receive(t,i,r,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(t," before remoteSDP created."));let{mid:o,needExchangeSDP:a}=this.remoteSDP.send(t,i,r,n);if(a){let d=this.remoteSDP.toString(),u=this.logSDPExchange(d,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:d});let p=await this.peerConnection.createAnswer(),m=this.mungReceiveAnswerSDP(p.sdp,o,t);u==null||u(m||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:m}),S.debug("[NVExtentionsConnection] receive ".concat(t," by exchanging SDP."))}else S.debug("[NVExtentionsConnection] receive ".concat(t," no need to exchange SDP."));let l=this.peerConnection.getTransceivers().find(d=>d.mid===o);if(!l)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:l.receiver.track,id:o}}catch(o){throw new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(o.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");let{mids:i,needExchangeSDP:r}=this.remoteSDP.batchSend(t);if(r){let n=this.remoteSDP.toString(),o=this.logSDPExchange(n,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let a=await this.peerConnection.createAnswer();o==null||o(a.sdp||""),await this.peerConnection.setLocalDescription(a),S.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else S.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return i.map(n=>{let o=this.peerConnection.getTransceivers().find(a=>a.mid===n);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:n}})}catch(i){throw new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(i.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);let i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(i){throw new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(i.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);let i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(i){throw new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(i.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);let i=this.remoteSDP.toString(),r=this.logSDPExchange(i,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let n=await this.peerConnection.createAnswer();r==null||r(n.sdp||""),await this.peerConnection.setLocalDescription(n)}catch(i){throw new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(i.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(a=>{a.direction="inactive"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.muteRemote(t);let o=this.remoteSDP.toString();n==null||n(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(i.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(a=>a.mid&&t.indexOf(a.mid)!==-1);if(i.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(async(a,l)=>{a.direction="sendonly"});let r=await this.peerConnection.createOffer(),n=this.logSDPExchange(r.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(r),this.remoteSDP.unmuteRemote(t);let o=this.remoteSDP.toString();n==null||n(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new U(A.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(i.toString()))}}restartICE(t){var i=this;return Vr(function*(){let r=yield Ue(i.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(Ye().supportPCSetConfiguration){let u=i.peerConnection.getConfiguration(),p=t===Ji.RELAY?"relay":"all";u.iceTransportPolicy!==p&&(S.debug("restartICE change iceTransportPolicy from [".concat(u.iceTransportPolicy,"] to [").concat(p,"]")),u.iceTransportPolicy=p,i.peerConnection.setConfiguration(u))}else if(t===Ji.RELAY)return;t!==Ji.RELAY&&i.remoteSDP.updateCandidates(t);let n=yield Ue(i.peerConnection.createOffer({iceRestart:!0}));if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let o=go(n.sdp),{remoteIceParameters:a}=yield o.iceParameters;i.remoteSDP.restartICE(a);let l=i.remoteSDP.toString(),d=i.logSDPExchange(n.sdp||"","offer","local","restartICE");yield Ue(i.peerConnection.setLocalDescription(n)),d==null||d(l),yield Ue(i.peerConnection.setRemoteDescription({type:"answer",sdp:l}))}catch(n){S.warning("restart ICE failed, abort operation",n)}finally{r()}})()}close(){var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,i){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");let r=await this.peerConnection.createOffer(),n=this.mungSendOfferSDP(r.sdp,[i],[t]);this.remoteSDP.updateRecvMedia(t,i);let o=this.remoteSDP.toString(),a=this.logSDPExchange(n,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:n}),a==null||a(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(r){throw new U(A.EXCHANGE_SDP_FAILED,r.toString())}}async updateSendParameters(t,i){let r=this.peerConnection.getTransceivers().filter(n=>n.mid===t);r.length===1&&(this.isVP8Simulcast(i)?mt()||await this.applySimulcastEncodings(r,[i]):await this.applySendEncodings(r,[i]))}setStatsRemoteVideoIsReady(t,i){this.statsFilter.setVideoIsReady2(t,i)}async replaceTrack(t,i){let r=this.peerConnection.getTransceivers().find(n=>n.mid===i);r&&await r.sender.replaceTrack(t._mediaStreamTrack)}getP2PConnectionParams(){var t;if((t=this.peerConnection.currentLocalDescription)===null||t===void 0||!t.sdp||!this.localCapabilities)throw new Error;return S_(S_({},go(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,S.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,S.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},N("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){let i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Rl(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...cf.turnServerConfigToIceServers(t.turnServer.servers)),N("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...cf.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),N("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(t){let i=[];return t.forEach(r=>{r.security?r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ta(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!N("FORCE_TURN_TCP")&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),i}async applySendEncodings(t,i){try{if(!Ye().supportSetRtpSenderParameters||t.length!==i.length)return;for(let m=0;m<t.length;m++){let f=t[m],E=i[m];if(E&&E instanceof Et){var r,n,o;if(this.isVP8Simulcast(E))continue;let I={},T={};switch(E._optimizationMode){case"motion":I.degradationPreference="maintain-framerate";break;case"detail":I.degradationPreference="maintain-resolution";break;default:I.degradationPreference="balanced"}var a,l,d,u;if((r=E._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&(T.maxBitrate=1e3*((a=E._encoderConfig)===null||a===void 0?void 0:a.bitrateMax)),se(n=E._hints).call(n,Rt.LOW_STREAM)&&((l=E._encoderConfig)!==null&&l!==void 0&&l.frameRate&&(T.maxFramerate=Rr(E._encoderConfig.frameRate)),(d=E._encoderConfig)!==null&&d!==void 0&&d.scaleResolutionDownBy&&((u=E._encoderConfig)===null||u===void 0?void 0:u.scaleResolutionDownBy)>1&&(T.scaleResolutionDownBy=E._encoderConfig.scaleResolutionDownBy)),N("DSCP_TYPE")&&qs()){var p;let O=N("DSCP_TYPE");se(p=["very-low","low","medium","high"]).call(p,O)&&(T.networkPriority=O)}let R=f.sender.getParameters(),w=(o=R.encodings)===null||o===void 0?void 0:o[0];mt()&&!w&&(I.encodings=[T]),w&&Object.assign(w,T),Object.assign(R,I),await f.sender.setParameters(R)}}}catch{S.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(t,i,r){let n=Nt.parse(t);return i.forEach((o,a)=>{let l=r[a],d=n.mediaDescriptions.find(u=>u.attributes.mid===l);d&&(la(d,o),vv(d,o,this.store.codec))}),Nt.print(n)}mungReceiveAnswerSDP(t,i,r){let n=Nt.parse(t),o=n.mediaDescriptions.find(a=>a.attributes.mid===i);return o&&r===me.AUDIO&&o.media.mediaType==="audio"&&So(o),this.useXR&&d_(n),Nt.print(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,i,r)=>{var n;(n=this.onFirstVideoDecoded)===null||n===void 0||n.call(this,t,i,r)},this.statsFilter.onSelectedLocalCandidateChanged=(t,i)=>{var r;(r=this.onSelectedLocalCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,i)=>{var r;(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0||r.call(this,t,i)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,i){if(t.length===i.length)for(let d=0;d<t.length;d++){var r,n,o,a,l;let u=t[d],p=i[d];if(p instanceof Et&&!se(r=p._hints).call(r,Rt.LOW_STREAM)&&(n=p._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((o=p._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(a=p._scalabilityMode)!==null&&a!==void 0&&a.numSpatialLayers&&((l=p._scalabilityMode)===null||l===void 0?void 0:l.numSpatialLayers)>1&&this.store.codec==="vp8"){let m={},f={high:1e3*(p._encoderConfig.bitrateMax-50),medium:5e4};m.encodings=[{rid:"m",active:!0,maxBitrate:f.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:f.high}];let E=u.sender.getParameters();await u.sender.setParameters(Object.assign(E,m))}}}async applySimulcastEncodings(t,i){if(!mt()&&t.length===i.length)for(let r=0;r<t.length;r++){let n=i[r];if(n instanceof Et&&this.isVP8Simulcast(n)){let o=t[r],a={},l={high:1e3*(n._encoderConfig.bitrateMax-50),medium:5e4};a.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:l.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:l.medium,scaleResolutionDownBy:4}];let d=o.sender.getParameters();await o.sender.setParameters(Object.assign(d,a))}}}isVP8Simulcast(t){var i,r,n,o,a;return!!(t instanceof Et&&N("SIMULCAST")&&this.store.codec==="vp8"&&!se(i=t._hints).call(i,Rt.LOW_STREAM)&&(r=t._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((n=t._encoderConfig)===null||n===void 0?void 0:n.bitrateMax)>200&&(o=t._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((a=t._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1)}logSDPExchange(t,i,r,n){if(N("SDP_LOGGING"))return S.upload("exchanging ".concat(r," ").concat(i," SDP during NVExtentionsConnection.").concat(n,`
`),t),i==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",n)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;let i=this.remoteSDP.getSSRC(t);return i==null?void 0:i[0].ssrcId}setConfiguration(t){if(Ye().supportPCSetConfiguration){let i=cf.resolvePCConfiguration(t);this.peerConnection.setConfiguration(i)}}},ie(Ze.prototype,"connect",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"connect"),Ze.prototype),ie(Ze.prototype,"updateRemoteRTPCapabilities",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"updateRemoteRTPCapabilities"),Ze.prototype),ie(Ze.prototype,"updateRemoteConnect",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"updateRemoteConnect"),Ze.prototype),ie(Ze.prototype,"createDataChannels",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"createDataChannels"),Ze.prototype),ie(Ze.prototype,"receive",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"receive"),Ze.prototype),ie(Ze.prototype,"batchReceive",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"batchReceive"),Ze.prototype),ie(Ze.prototype,"stopReceiving",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"stopReceiving"),Ze.prototype),ie(Ze.prototype,"muteRemote",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"muteRemote"),Ze.prototype),ie(Ze.prototype,"unmuteRemote",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"unmuteRemote"),Ze.prototype),ie(Ze.prototype,"muteLocal",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"muteLocal"),Ze.prototype),ie(Ze.prototype,"unmuteLocal",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"unmuteLocal"),Ze.prototype),ie(Ze.prototype,"close",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"close"),Ze.prototype),ie(Ze.prototype,"updateEncoderConfig",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"updateEncoderConfig"),Ze.prototype),ie(Ze.prototype,"updateSendParameters",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"updateSendParameters"),Ze.prototype),ie(Ze.prototype,"replaceTrack",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"replaceTrack"),Ze.prototype),ie(Ze.prototype,"getRemoteSSRC",[yr],Object.getOwnPropertyDescriptor(Ze.prototype,"getRemoteSSRC"),Ze.prototype),Ze);function yr(e,t,i){let r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let n=this.mutex,o=await n.lock("From NVExtentionsConnection.".concat(t));try{for(var a=arguments.length,l=new Array(a),d=0;d<a;d++)l[d]=arguments[d];return await r.apply(this,l)}finally{o()}},i}var at;function d1(e){var t,i,r,n=2;for(typeof Symbol<"u"&&(i=YL,r=Symbol.iterator);n--;){if(i&&(t=e[i])!=null)return t.call(e);if(r&&(t=e[r])!=null)return new T_(t.call(e));i="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function T_(e){function t(i){if(Object(i)!==i)return ne.reject(new TypeError(i+" is not an object."));var r=i.done;return ne.resolve(i.value).then(function(n){return{value:n,done:r}})}return T_=function(i){this.s=i,this.n=i.next},T_.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var r=this.s.return;return r===void 0?ne.resolve({value:i,done:!0}):t(r.apply(this.s,arguments))},throw:function(i){var r=this.s.return;return r===void 0?ne.reject(i):t(r.apply(this.s,arguments))}},new T_(e)}let _a=(at=class lf extends ym{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,i){super(t,i),y(this,"store",void 0),y(this,"peerConnection",void 0),y(this,"cname",void 0),y(this,"mutex",new Ti("DataChannelConnection-mutex")),y(this,"dataChannel",void 0),y(this,"_p2pConnection",void 0),y(this,"establishPromise",void 0),y(this,"_nvMedia",void 0),this.store=i,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(lf.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new K9(t,i,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var t;let i=(t=this._nvMedia)===null||t===void 0?void 0:t.getLocalRtpCapabilities();return await this._p2pConnection.establish(i)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(t,i,r,n,o,a){return this.cname=a,await this._p2pConnection.connect(t,i,r,n,o,a),await new ne((l,d)=>{let u=setTimeout(()=>{this.closeSignal(),d(new U(A.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(r))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(u),void l()},this.dataChannel.onerror=p=>{this.closeSignal(),d(p)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,i){return this._p2pConnection.updateRemoteRTPCapabilities(t,i)}send(t,i,r){var n=this;return Vr(function*(){let o=yield Ue(n.mutex.lock("From DataChannelConnection.send"));try{return yield*p_(d1(n._p2pConnection.send(t,i,r)))}finally{o()}})()}async stopSending(t,i){return this._p2pConnection.stopSending(t,i)}async createDataChannels(t,i){return this._p2pConnection.createDataChannels(t,i)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,i,r,n){return this._nvMedia?(S.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,i,this.cname)):(S.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,i,r,n))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var i=this;return Vr(function*(){return yield*p_(d1(i._p2pConnection.restartICE(t)))})()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var i;(i=this._nvMedia)===null||i===void 0||i.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,i){return await this._p2pConnection.updateEncoderConfig(t,i)}async updateSendParameters(t,i){return await this._p2pConnection.updateSendParameters(t,i)}setStatsRemoteVideoIsReady(t,i){this._p2pConnection.setStatsRemoteVideoIsReady(t,i)}async replaceTrack(t,i){return await this._p2pConnection.replaceTrack(t,i)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,i,r,n){if(N("SDP_LOGGING"))return S.upload("exchanging ".concat(r," ").concat(i," SDP during DataChannelConnection.").concat(n,`
`),t),i==="offer"?o=>{this.logSDPExchange(o,"answer",r==="local"?"remote":"local",n)}:void 0}static resolvePCConfiguration(t){let i={iceServers:[]};return t.iceServers?i.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Rl(t.turnServer.servers)?i.iceServers=t.turnServer.servers:(i.iceServers&&i.iceServers.push(...lf.turnServerConfigToIceServers(t.turnServer.servers)),N("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&t.turnServer.serversFromGateway&&i.iceServers.push(...lf.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),N("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(r=>{r.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(t){let i=[];return t.forEach(r=>{r.security?r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turns:".concat(ta(r.turnServerURL),":").concat(r.tcpport,"?transport=tcp")}):(r.udpport&&!N("FORCE_TURN_TCP")&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.udpport,"?transport=udp")}),r.tcpport&&i.push({username:r.username,credential:r.password,credentialType:"password",urls:"turn:".concat(r.turnServerURL,":").concat(r.tcpport,"?transport=tcp")}))}),i}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var i;return(i=this.onICEConnectionStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var i;return(i=this.onConnectionStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var i;return(i=this.onDTLSTransportStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var i;return(i=this.onDTLSTransportError)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var i;return(i=this.onICETransportStateChange)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var i;return(i=this.onFirstAudioReceived)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var i;return(i=this.onFirstVideoReceived)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var i;return(i=this.onFirstAudioDecoded)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,i,r)=>{var n;return(n=this.onFirstVideoDecoded)===null||n===void 0?void 0:n.call(this,t,i,r)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var i;return(i=this.onFirstVideoDecodedTimeout)===null||i===void 0?void 0:i.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,i)=>{var r;return(r=this.onSelectedLocalCandidateChanged)===null||r===void 0?void 0:r.call(this,t,i)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,i)=>{var r;return(r=this.onSelectedRemoteCandidateChanged)===null||r===void 0?void 0:r.call(this,t,i)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}},ie(at.prototype,"connect",[sn],Object.getOwnPropertyDescriptor(at.prototype,"connect"),at.prototype),ie(at.prototype,"updateRemoteRTPCapabilities",[sn],Object.getOwnPropertyDescriptor(at.prototype,"updateRemoteRTPCapabilities"),at.prototype),ie(at.prototype,"createDataChannels",[sn],Object.getOwnPropertyDescriptor(at.prototype,"createDataChannels"),at.prototype),ie(at.prototype,"receive",[sn],Object.getOwnPropertyDescriptor(at.prototype,"receive"),at.prototype),ie(at.prototype,"stopReceiving",[sn],Object.getOwnPropertyDescriptor(at.prototype,"stopReceiving"),at.prototype),ie(at.prototype,"muteRemote",[sn],Object.getOwnPropertyDescriptor(at.prototype,"muteRemote"),at.prototype),ie(at.prototype,"unmuteRemote",[sn],Object.getOwnPropertyDescriptor(at.prototype,"unmuteRemote"),at.prototype),ie(at.prototype,"muteLocal",[sn],Object.getOwnPropertyDescriptor(at.prototype,"muteLocal"),at.prototype),ie(at.prototype,"unmuteLocal",[sn],Object.getOwnPropertyDescriptor(at.prototype,"unmuteLocal"),at.prototype),ie(at.prototype,"close",[sn],Object.getOwnPropertyDescriptor(at.prototype,"close"),at.prototype),ie(at.prototype,"updateEncoderConfig",[sn],Object.getOwnPropertyDescriptor(at.prototype,"updateEncoderConfig"),at.prototype),ie(at.prototype,"updateSendParameters",[sn],Object.getOwnPropertyDescriptor(at.prototype,"updateSendParameters"),at.prototype),ie(at.prototype,"replaceTrack",[sn],Object.getOwnPropertyDescriptor(at.prototype,"replaceTrack"),at.prototype),ie(at.prototype,"getRemoteSSRC",[sn],Object.getOwnPropertyDescriptor(at.prototype,"getRemoteSSRC"),at.prototype),at);function sn(e,t,i){let r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let n=this.mutex,o=await n.lock("From DataChannelConnection.".concat(t));try{for(var a=arguments.length,l=new Array(a),d=0;d<a;d++)l[d]=arguments[d];return await r.apply(this,l)}finally{o()}},i}var xe;function u1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function $o(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?u1(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):u1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}function h1(e){var t,i,r,n=2;for(typeof Symbol<"u"&&(i=YL,r=Symbol.iterator);n--;){if(i&&(t=e[i])!=null)return t.call(e);if(r&&(t=e[r])!=null)return new v_(t.call(e));i="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function v_(e){function t(i){if(Object(i)!==i)return ne.reject(new TypeError(i+" is not an object."));var r=i.done;return ne.resolve(i.value).then(function(n){return{value:n,done:r}})}return v_=function(i){this.s=i,this.n=i.next},v_.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(i){var r=this.s.return;return r===void 0?ne.resolve({value:i,done:!0}):t(r.apply(this.s,arguments))},throw:function(i){var r=this.s.return;return r===void 0?ne.reject(i):t(r.apply(this.s,arguments))}},new v_(e)}let R_=(xe=class extends Ot{get state(){return this._state}set state(e){let t=this._state;this._state=e,this.emit(ye.StateChange,t,this._state)}constructor(e,t){super(),y(this,"store",void 0),y(this,"statsUploader",void 0),y(this,"connection",void 0),y(this,"localTrackMap",new Map),y(this,"remoteUserMap",new Map),y(this,"localDataChannels",[]),y(this,"remoteDataChannelMap",new Map),y(this,"pendingLocalTracks",[]),y(this,"pendingRemoteTracks",[]),y(this,"pendingLocalDataChannels",[]),y(this,"pendingRemoteDataChannels",[]),y(this,"statsCollector",void 0),y(this,"isPlanB",!1),y(this,"shouldForwardP2PCreation",void 0),y(this,"iceFailedCount",0),y(this,"dtlsFailedCount",0),y(this,"mutex",new Ti("P2PChannel-mutex")),y(this,"_state",st.Disconnected),y(this,"_pcStatsUploadType",N("NEW_ICE_RESTART")?ms.FIRST_CONNECTION:ms.OLD_FIRST_CONNECTION),y(this,"_isInRestartIce",!1),y(this,"_isStartRestartIce",!1),y(this,"_restartStates",["disconnected","failed"]),y(this,"_restartTimer",void 0),y(this,"_isFirstConnected",!0),y(this,"handleMuteLocalTrack",async(i,r,n)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==st.Connected)return void n(new j(A.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));let a=this.filterTobeMutedTracks(i);if(a.length===0)return void r();let l=a.find(u=>u[0]==="videoLowTrack");l&&l[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(a.map(u=>{let[,{id:p}]=u;return p}));let d=this.createMuteMessage(a);await _t(this,ye.RequestMuteLocal,d),r()}catch(a){n(a)}finally{o()}}),y(this,"handleUnmuteLocalTrack",async(i,r,n)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==st.Connected)return void n(new j(A.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));let a=this.filterTobeUnmutedTracks(i);if(a.length===0)return void r();let l=a.find(u=>u[0]==="videoLowTrack");if(l){let u=l[1];if(u.track._originMediaStreamTrack.stop(),!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ye().supportDualStreamEncoding){let p=i._mediaStreamTrack.clone();u.track._mediaStreamTrack=p,u.track._originMediaStreamTrack=p}else{let p=yv(i,ic(this,ye.RequestLowStreamParameter));u.track._mediaStreamTrack=p,u.track._originMediaStreamTrack=p}await new ne((p,m)=>{this.handleReplaceTrack(u.track,p,m,!0)})}await this.connection.unmuteLocal(a.map(u=>{let[,{id:p}]=u;return p}));let d=this.createUnmuteMessage(a);await _t(this,ye.RequestUnmuteLocal,d),r()}catch(a){n(a)}finally{o()}}),y(this,"handleUpdateVideoEncoder",async(i,r,n)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{let a=this.localTrackMap.get(Q.LocalVideoTrack);if(!this.connection||!a||a.track!==i||this.state!==st.Connected)return void r();let{id:l,track:d}=a;await this.connection.updateSendParameters(l,d),await this.connection.updateEncoderConfig(l,d),this.emit(ye.UpdateVideoEncoder,d),r()}catch(a){n(a)}finally{o()}}),y(this,"handleUpdateVideoSendParameters",async(i,r,n)=>{let o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{let a=this.localTrackMap.get(Q.LocalVideoTrack);if(!this.connection||!a||a.track!==i||this.state!==st.Connected)return void r();let{id:l,track:d}=a;await this.connection.updateSendParameters(l,d),r()}catch(a){n(a)}finally{o()}}),y(this,"handleReplaceMixingTrack",async(i,r,n,o)=>{if(!this.connection||this.state!==st.Connected)return void r();let a=wv([i]),l;S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(a.getTrackId(),"]")),typeof o=="boolean"&&o||(l=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(i,a),r()}catch(u){n(u)}finally{var d;(d=l)===null||d===void 0||d()}}),y(this,"handleReplaceTrack",async(i,r,n,o)=>{let a;S.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var l;let u=Array.from(this.localTrackMap.entries()).find(p=>{let[,{track:m}]=p;return i===m});if(!this.connection||!u||this.state!==st.Connected)return void r();if(await((l=this.connection)===null||l===void 0?void 0:l.replaceTrack(i,u[1].id)),this.isPlanB){let p=u[1];p.id=i._mediaStreamTrack.id,this.localTrackMap.set(u[0],p)}if(u[0]===Q.LocalVideoTrack&&!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ye().supportDualStreamEncoding){let p=this.localTrackMap.get(Q.LocalVideoLowTrack);if(p){let m=i._mediaStreamTrack.clone();p.track._originMediaStreamTrack.stop(),p.track._mediaStreamTrack=m,p.track._originMediaStreamTrack=m,await new ne((f,E)=>{this.handleReplaceTrack(p.track,f,E,!0)})}}r()}catch(u){n(u)}finally{var d;(d=a)===null||d===void 0||d()}}),y(this,"handleGetRTCStats",i=>{i(this.statsCollector.getRTCStats())}),y(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),y(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),y(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),y(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new bL(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!Ye().supportUnifiedPlan||N("CHROME_FORCE_PLAN_B")&&qs(),this.shouldForwardP2PCreation=N("FORWARD_P2P_CREATION")&&Ye().supportPCSetConfiguration&&bS(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new _a({},this.store):this.isPlanB?new rd({},this.store):new Ro({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var i;this.state=st.New;let r=this.shouldForwardP2PCreation&&((i=this.connection)===null||i===void 0?void 0:i.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!r||(r&&this.connection&&(S.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new _a(e,this.store):this.isPlanB?new rd(e,this.store):new Ro(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new j(A.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=N("NEW_ICE_RESTART")?ms.FIRST_CONNECTION:ms.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,i,r,n,o){if(!this.connection)throw new j(A.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof _a?this.connection.updateRemoteConnect(r):(this.store.peerConnectionStart(),await this.connection.connect(e,t,i,r,n,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=st.Connected)}updateRemoteRTPCapabilities(e){let t=Array.from(this.localTrackMap.entries()).filter(n=>{var o;let[a]=n;return se(o=[Q.LocalVideoLowTrack,Q.LocalVideoTrack]).call(o,a)}),i=t.map(n=>{let[,{id:o}]=n;return o}),r=t.map(n=>{let[o]=n;return o});if(this.connection instanceof Ro){if(_e.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(r),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!se(e).call(e,this.store.codec)){let n=["vp9","vp8","h264"].find(o=>se(e).call(e,o));n&&(this.store.codec=n,S.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(n,".")))}this.connection.updateRemoteRTPCapabilities(i,e)}}async preConnect(e,t,i,r,n,o){if(!this.connection)throw new j(A.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();let a=await this.connection.connect(e,t,i,r,n,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=st.Connected,a}getEstablishParams(){if(this.connection instanceof _a)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection||this.state!==st.Connected){if(this.state===st.Disconnected)throw new j(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void e.forEach(i=>{var r;se(r=this.pendingLocalDataChannels).call(r,i)||this.pendingLocalDataChannels.push(i)})}let t=this.filterTobePublishedDataChannels(e);t.length!==0&&(t.forEach(i=>{let r=Date.now();this.store.publish(i.id.toString(),"datachannel",r)}),await this.connection.createDataChannels(this.store.uid,t),t.forEach(i=>{this.localDataChannels.push(i);let r=Date.now();this.store.publish(i.id+"","datachannel",void 0,r)}))}publish(e,t,i){var r=this;return Vr(function*(){let n=yield Ue(r.mutex.lock("From P2PChannel.publish"));try{if(!r.connection||r.state!==st.Connected){if(r.state===st.Disconnected)throw new j(A.UNEXPECTED_ERROR,"PeerConnection already disconnected.");r.throwIfTrackTypeNotMatch(e);let a=e.filter(l=>r.pendingLocalTracks.indexOf(l)===-1);return void(r.pendingLocalTracks=r.pendingLocalTracks.concat(a))}r.store.pubId=r.store.pubId+1,Gi.markPublishStart(r.store.clientId,r.store.pubId);let o=r.filterTobePublishedTracks(e,t,i);if(o.length===0)return void(yield Ue(r.tryToUnmuteAudio(e)));yield*p_(h1(r.doPublish(r.connection,o)))}finally{n()}})()}doPublish(e,t){var i=this;return Vr(function*(){t.forEach(m=>{let{track:f,type:E}=m,I=Date.now();i.store.publish(f.getTrackId(),E===Q.LocalAudioTrack?"audio":"video",I)}),i.bindLocalTrackEvents(t);let r=t.map(m=>{let{track:f}=m;return f}),n=yield Ue(e.send(t.map(m=>{let{track:f}=m;return f}),i.store.codec,i.store.audioCodec)),o=(yield Ue(n.next())).value,a=i.createGatewayPublishMessage(t,o),l;try{l=yield a}catch(m){throw n.throw(m),(m==null?void 0:m.code)===A.WS_ABORT&&t.forEach(f=>{let{track:E}=f;i.pendingLocalTracks.indexOf(E)===-1&&i.pendingLocalTracks.push(E)}),i.unbindLocalTrackEvents(t),m}let d=i.mapPubResToRemoteConfig(a,l),u=(yield Ue(n.next(d))).value,p=N("ENABLE_VIDEO_SEI");r.forEach(async m=>{let f=m.getRTCRtpTransceiver();f&&p&&(m.trackMediaType===me.VIDEO?await E9(f.sender,m):m.trackMediaType===me.AUDIO&&await async function(E){if(!Ye().supportWebRTCEncodedTransform)return void S.warning("browser not support audio encoded transform");if(n_.has(E)||!E.track)return;let I={track:E.track};if(Ys()){if(!E.createEncodedStreams)return void S.warning("browser not support createEncodedStreams() API");let R=null;try{R=E.createEncodedStreams()}catch(O){return void S.error("create audio-encoded-streams error",O&&O.message)}let w=new TransformStream({transform(O,P){I.controller||(I.controller=P),E.track&&E.track.id!==I.track.id&&(S.debug("audio track changed: ".concat(I.track.id," => ").concat(E.track.id)),I.track.removeEventListener("ended",T),I.track=E.track,I.track.addEventListener("ended",T)),P.enqueue(O)}});R.readable.pipeThrough(w).pipeTo(R.writable)}else if(pi()){if(typeof RTCRtpScriptTransform>"u")return void S.warning("browser not support RTCRtpScriptTransform");let R=r_(),w=new MessageChannel;await new ne(P=>R.onmessage=M=>{M.data==="registered"&&P(void 0)});let O=new RTCRtpScriptTransform(R,{name:"tx",port:w.port2},[w.port2]);E.transform=O,await new ne(P=>R.onmessage=M=>{M.data==="started"&&P(void 0)}),w.port1.onmessage=P=>{var M;P.data.transformed&&E.track&&((M=E.track)===null||M===void 0?void 0:M.id)!==I.track.id&&(S.debug("audio track changed: ".concat(I.track.id," => ").concat(E.track.id)),I.track.removeEventListener("ended",T),I.track=E.track,I.track.addEventListener("ended",T))},I.worker=R}function T(){if(E.track){if(this.id!==E.track.id)return;E.track.removeEventListener("ended",T)}let R=n_.get(E);if(R){n_.delete(E);try{var w,O;(w=R.controller)===null||w===void 0||w.terminate(),(O=R.worker)===null||O===void 0||O.terminate()}catch(P){S.warning(P&&P.message)}}}n_.set(E,I),E.track.addEventListener("ended",T)}(f.sender))}),t.forEach(m=>{let{type:f}=m;i.statsCollector.addLocalStats(f)}),i.assignLocalTracks(t,u),i.statsUploader.startUploadOutboundStats(),t.forEach(m=>{let{track:f,type:E}=m,I=Date.now();i.store.publish(f.getTrackId(),E===Q.LocalAudioTrack?"audio":"video",void 0,I)})})()}async updateVideoStreamParameter(e,t){let i=this.localTrackMap.get(t);if(!i)return;if(!(i.track instanceof Et))return S.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof Ro||this.connection instanceof rd))return S.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");let{track:r}=i,n=function(o,a){let l={};return o.height&&o.width&&(l.scaleResolutionDownBy=eT(o,a)),l.maxFramerate=o.framerate?Rr(o.framerate):void 0,l.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,l}(e,r);if(r._encoderConfig||(r._encoderConfig={}),t!==Q.LocalVideoLowTrack||!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ye().supportDualStreamEncoding)n.scaleResolutionDownBy!=null&&(r._encoderConfig.scaleResolutionDownBy=n.scaleResolutionDownBy);else{let o=r._originMediaStreamTrack;if(!o.canvas)return S.warn("[".concat(r.getTrackId(),"] no canvas on track"));(function(a,l){let d=a.canvas;l.width&&(d.width=Rr(l.width)),l.height&&(d.height=Rr(l.height)),l.framerate&&(d.stopCapture&&d.stopCapture(),d.stopCapture=ov(()=>{!d.startCapture&&d.stopCapture&&d.stopCapture(),d.startCapture&&d.startCapture()},Rr(l.framerate)))})(o,e)}n.maxBitrate!=null&&(r._encoderConfig.bitrateMax=n.maxBitrate/1e3),n.maxFramerate!=null&&(r._encoderConfig.frameRate&&typeof r._encoderConfig.frameRate=="object"?r._encoderConfig.frameRate.max=n.maxFramerate:r._encoderConfig.frameRate={max:n.maxFramerate}),S.debug("[".concat(r.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(r._encoderConfig))),await this.connection.updateRtpSenderEncodings(r)}publishLowStream(e){var t=this;return Vr(function*(){if(!t.connection||t.state!==st.Connected)return;let i=yield Ue(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{let n=t.localTrackMap.get(Q.LocalVideoTrack);if(!n)throw new j(A.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(Q.LocalVideoLowTrack))throw new j(A.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));let o=[{track:t.getLowVideoTrack(n.track,e),type:Q.LocalVideoLowTrack}];if(yield*p_(h1(t.doPublish(t.connection,o))),n.track.muted||!n.track.enabled){var r;let a=(r=t.localTrackMap.get(Q.LocalVideoLowTrack))===null||r===void 0?void 0:r.id;a!==void 0&&(yield Ue(t.connection.muteLocal([a])))}}finally{i()}})()}async republish(){this.pendingLocalTracks.length>0&&(S.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await ti(this,ye.RequestRePublish,this.pendingLocalTracks),this.emit(ye.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(S.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await ti(this,ye.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){let{user:i,kind:r}=this.pendingRemoteTracks[t];(r!==me.AUDIO||i._audio_added_&&i._audioSSRC)&&(r!==me.VIDEO||i._video_added_&&i._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await ti(this,ye.RequestReSubscribe,this.pendingRemoteTracks);else for(let{user:t,kind:i}of this.pendingRemoteTracks)await this.subscribe(t,i,i===me.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach(t=>{let{user:i}=t;this.emit(ye.MediaReconnectEnd,i.uid)}),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==st.Connected)return void e.forEach(r=>{let n=this.pendingLocalTracks.indexOf(r);n!==-1&&this.pendingLocalTracks.splice(n,1)});let t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;let i=t.find(r=>r[0]==="videoLowTrack");return i&&i[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==st.Connected)return void e.forEach(i=>{let r=this.pendingLocalDataChannels.indexOf(i);r!==-1&&this.pendingLocalDataChannels.splice(r,1)});let t=this.filterTobeUnpublishedDataChannels(e);return t.length!==0?(t.forEach(i=>{let r=this.localDataChannels.indexOf(i);r!==-1&&this.localDataChannels.splice(r,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),t.map(i=>i.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==st.Connected)return;let e=this.localTrackMap.get(Q.LocalVideoLowTrack);if(!e)return;e.track.close();let t=[[Q.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){let i=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map(r=>{let[,{id:n}]=r;return n})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(r=>{let[n,{track:o}]=r;return{type:n,track:o}})),t.forEach(r=>{let[n]=r;this.statsCollector.removeLocalStats(n)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),i}async subscribeDataChannel(e,t){if(!this.connection||this.state!==st.Connected)throw new j(A.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");let i=t.filter(r=>{var n;return!((n=this.remoteDataChannelMap.get(e))!==null&&n!==void 0&&n.get(r.id))});if(i.length!==0)return await this.connection.createDataChannels(e.uid,i),i.forEach(r=>{var n;this.remoteDataChannelMap.has(e)?(n=this.remoteDataChannelMap.get(e))===null||n===void 0||n.set(r.id,r):this.remoteDataChannelMap.set(e,new Map([[r.id,r]]));let o=this.pendingRemoteDataChannels.findIndex(a=>{let{user:l,id:d}=a;return l.uid===e.uid&&d===r.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),i.map(r=>r.id)}async subscribe(e,t,i,r,n){var o;if(!this.connection||this.state!==st.Connected)throw new j(A.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(e))!==null&&o!==void 0&&o.has(t))return;let a,l,d;if(n){let m=n.find(E=>{let{stream_type:I}=E;return I===t});if(!m)throw new j(A.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));let f=await this.connection.receive(t,m.ssrcs,String(e._uintid),m.attributes);this.connection instanceof Ro&&(d=f.transceiver),a=f.track,l=f.id}else{let m=await this.connection.receive(t,[{ssrcId:i,rtx:r}],String(e._uintid),void 0);this.connection instanceof Ro&&(d=m.transceiver),a=m.track,l=m.id}t===me.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(a):(e._audioTrack=new ed(a,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),d&&e._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(a):(e._videoTrack=new $l(a,e.uid,e._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),d&&e._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(e,e._videoTrack)),N("ENABLE_VIDEO_SEI")&&d&&(t==me.VIDEO?await g9(d.receiver,{onSei:m=>{var f;(f=e._videoTrack)===null||f===void 0||f._onSei(m)}}):t==me.AUDIO&&await async function(m){if(!Ye().supportWebRTCEncodedTransform)return void S.warning("browser not support audio encoded transform");if(o_.has(m))return;let f={track:m.track};if(Ys()){if(!m.createEncodedStreams)return void S.warning("browser not support createEncodedStreams() API");let I=null;try{I=m.createEncodedStreams()}catch(R){return void S.error("create audio-encoded-streams error",R&&R.message)}let T=new TransformStream({transform(R,w){f.controller||(f.controller=w),m.track&&m.track.id!==f.track.id&&(S.debug("audio track changed: ".concat(f.track.id," => ").concat(m.track.id)),f.track.removeEventListener("ended",E),f.track=m.track,f.track.addEventListener("ended",E)),w.enqueue(R)}});I.readable.pipeThrough(T).pipeTo(I.writable)}else if(pi()){if(typeof RTCRtpScriptTransform>"u")return void S.warning("browser not support RTCRtpScriptTransform");let I=r_(),T=new MessageChannel;await new ne(w=>I.onmessage=O=>{O.data==="registered"&&w(void 0)});let R=new RTCRtpScriptTransform(I,{name:"rx",port:T.port2},[T.port2]);m.transform=R,await new ne(w=>I.onmessage=O=>{O.data==="started"&&w(void 0)}),T.port1.onmessage=w=>{var O;w.data.transformed&&m.track&&((O=m.track)===null||O===void 0?void 0:O.id)!==f.track.id&&(S.debug("audio track changed: ".concat(f.track.id," => ").concat(m.track.id)),f.track.removeEventListener("ended",E),f.track=m.track,f.track.addEventListener("ended",E))},f.worker=I}function E(){m.track.removeEventListener("ended",E),function(I){let T=o_.get(I);if(T){o_.delete(I);try{var R,w;(R=T.controller)===null||R===void 0||R.terminate(),(w=T.worker)===null||w===void 0||w.terminate()}catch(O){S.warning(O&&O.message)}}}(m)}o_.set(m,f),m.track.addEventListener("ended",E)}(d.receiver));let u=this.remoteUserMap.get(e);u?u.set(t,l):this.remoteUserMap.set(e,new Map([[t,l]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();let p=this.pendingRemoteTracks.findIndex(m=>{let{user:f,kind:E}=m;return f.uid===e.uid&&t===E});p!==-1&&(this.pendingRemoteTracks.splice(p,1),this.emit(ye.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==st.Connected)throw new j(A.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter(i=>{var r;let{user:n,mediaType:o}=i;return!((r=this.remoteUserMap.get(n))!==null&&r!==void 0&&r.has(o))});let t=await this.connection.batchReceive(e.map(i=>{let{user:r,mediaType:n,ssrcId:o,rtxSsrcId:a}=i;return{kind:n,ssrcMsg:[{ssrcId:o,rtx:a}],mslabel:String(r._uintid)}}));e.forEach((i,r)=>{let{user:n,mediaType:o}=i,{track:a,id:l,transceiver:d}=t[r];o===me.AUDIO?(n._audioTrack?n._audioTrack._updateOriginMediaStreamTrack(a):(n._audioTrack=new ed(a,n.uid,n._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(n._audioTrack.getTrackId()))),d&&n._audioTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(n,n._audioTrack)):(n._videoTrack?n._videoTrack._updateOriginMediaStreamTrack(a):(n._videoTrack=new $l(a,n.uid,n._uintid,this.store),S.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(n._videoTrack.getTrackId()))),d&&n._videoTrack._updateRtpTransceiver(d),this.bindRemoteTrackEvents(n,n._videoTrack));let u=this.remoteUserMap.get(n);u?u.set(o,l):this.remoteUserMap.set(n,new Map([[o,l]])),this.statsCollector.addRemoteStats(n.uid),this.statsUploader.startUploadInboundStats();let p=this.pendingRemoteTracks.findIndex(m=>{let{user:f,kind:E}=m;return f.uid===n.uid&&o===E});p!==-1&&(this.pendingRemoteTracks.splice(p,1),this.emit(ye.MediaReconnectEnd,n.uid))})}async unsubscribe(e,t,i){let r=this.pendingRemoteTracks.filter(a=>{let{user:l,kind:d}=a;return t!==void 0?l.uid===e.uid&&t===d:l.uid===e.uid});if(r.forEach(a=>{let l=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(l,1)}),this.connection&&this.state===st.Connected||i||r.forEach(a=>{let{kind:l}=a;var d;if(l===me.AUDIO)(d=e._audioTrack)===null||d===void 0||d._destroy(),e._audioTrack=void 0;else if(l===me.VIDEO){var u;(u=e._videoTrack)===null||u===void 0||u._destroy(),e._videoTrack=void 0}}),!this.connection||this.state!==st.Connected)return;let n=this.filterTobeUnSubscribedTracks(e,t);if(n.length===0)return;await this.connection.stopReceiving(n.map(a=>{let[,{id:l}]=a;return l}));let o=this.createUnsubscribeMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach(a=>{let[l,{kind:d}]=a;var u,p;if(d===me.VIDEO&&l._videoSSRC&&((u=this.connection)===null||u===void 0||u.setStatsRemoteVideoIsReady(l._videoSSRC,!1)),d===me.VIDEO)this.unbindRemoteTrackEvents(l._videoTrack),i||((p=l._videoTrack)===null||p===void 0||p._destroy(),l._videoTrack=void 0);else if(d===me.AUDIO){var m;this.unbindRemoteTrackEvents(l._audioTrack),!i&&((m=l._audioTrack)===null||m===void 0||m._destroy(),l._audioTrack=void 0)}}),o}async unsubscribeDataChannel(e,t){if(t.forEach(n=>{let o=this.pendingRemoteDataChannels.findIndex(a=>a.id===n.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;let i=this.filterTobeUnSubscribedDataChannels(e,t);if(i.length===0)return;t.forEach(n=>{n._close()});let r=this.remoteDataChannelMap.get(e);return i.forEach(n=>{r&&r.delete(n.id)}),r&&r.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),i.map(n=>n.id)}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(let{user:n,mediaType:o}of e){let a=this.pendingRemoteTracks.filter(l=>{let{user:d,kind:u}=l;return o!==void 0?d.uid===n.uid&&o===u:d.uid===n.uid});a.forEach(l=>{let d=this.pendingRemoteTracks.indexOf(l);this.pendingRemoteTracks.splice(d,1)}),t=t.concat(a)}if(!this.connection||this.state!==st.Connected)return void t.forEach(n=>{let{user:o,kind:a}=n;var l;if(a===me.AUDIO)(l=o._audioTrack)===null||l===void 0||l._destroy(),o._audioTrack=void 0;else if(a===me.VIDEO){var d;(d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0}});let i=ao(e).call(e,(n,o)=>{let{user:a,mediaType:l}=o,d=this.filterTobeUnSubscribedTracks(a,l);return n.concat(d)},[]);if(i.length===0)return;await this.connection.stopReceiving(i.map(n=>{let[,{id:o}]=n;return o}));let r=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),i.forEach(n=>{let[o,{kind:a}]=n;var l,d;if(a===me.VIDEO&&o._videoSSRC&&((l=this.connection)===null||l===void 0||l.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),a===me.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(d=o._videoTrack)===null||d===void 0||d._destroy(),o._videoTrack=void 0;else if(a===me.AUDIO){var u;this.unbindRemoteTrackEvents(o._audioTrack),(u=o._audioTrack)===null||u===void 0||u._destroy(),o._audioTrack=void 0}}),r}async muteRemote(e,t){if(!this.connection)return;let i=this.remoteUserMap.get(e);if(!i)return void S.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!i.get(t))return void S.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));let r=t===me.VIDEO?e._videoSSRC:e._audioSSRC;r!==void 0&&this.connection.setStatsRemoteVideoIsReady(r,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;let i=this.remoteUserMap.get(e);if(!i)return void S.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));i.get(t)||S.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){let t=this.localTrackMap.get(Q.LocalAudioTrack);if((t==null?void 0:t.track)instanceof ai){let i=t.track;return Array.from(this.localTrackMap.entries()).filter(r=>{let[n]=r;return n!==Q.LocalAudioTrack}).filter(r=>{let[n]=r;return!(e&&n===Q.LocalVideoLowTrack)}).map(r=>{let[,{track:n}]=r;return n}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return!(e&&r===Q.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,i,r,n){if(e){let a=this.localTrackMap.get(Q.LocalAudioTrack),l=r?this.localTrackMap.get(Q.LocalVideoLowTrack):this.localTrackMap.get(Q.LocalVideoTrack);_e.publish(this.store.sessionId,{eventElapse:Gi.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:a==null?void 0:a.track.getTrackLabel(),videoName:l==null?void 0:l.track.getTrackLabel(),screenshare:(l==null?void 0:l.track._hints.indexOf(Rt.SCREEN_TRACK))!==-1,audio:!!a,video:!!l,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:n})}else{var o;i||(i=[]);let a=i.find(d=>d instanceof jt),l=r?(o=this.localTrackMap.get(Q.LocalVideoTrack))===null||o===void 0?void 0:o.track:i.find(d=>d instanceof Et);_e.publish(this.store.sessionId,{eventElapse:Gi.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:a==null?void 0:a.getTrackLabel(),videoName:l==null?void 0:l.getTrackLabel(),screenshare:(l==null?void 0:l._hints.indexOf(Rt.SCREEN_TRACK))!==-1,audio:!!a,video:!!l,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:n})}}reportSubscribeEvent(e,t,i,r){let n=r===me.VIDEO?i._videoSSRC:i._audioSSRC;n&&_e.subscribe(this.store.sessionId,{succ:e,ec:t,video:r===me.VIDEO,audio:r===me.AUDIO,peerid:i.uid,subscribeRequestid:r===me.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:Gi.measureFromSubscribeStart(this.store.clientId,n)})}reset(){S.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Ti("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new _a({},this.store):this.isPlanB?new rd({},this.store):new Ro({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let e=this.localTrackMap.get(Q.LocalAudioTrack);if((e==null?void 0:e.track)instanceof ai){if(e.track.trackList.length>0){let t=e.track;e.track.trackList.forEach(i=>{t.removeAudioTrack(i)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=st.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.connection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){let e=this.localTrackMap.get(Q.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){let e=this.localTrackMap.get(Q.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){let t=this.localTrackMap.get(e);return t&&t.track instanceof Et||t&&t.track instanceof jt?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;let i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;let i=this.remoteUserMap.get(e);return!!i&&(!t||i.has(t))}getRemoteMedia(e){var t;let i=Array.from(Yr(t=this.remoteUserMap).call(t)).find(r=>r.uid===e);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(i=>{let[r]=i;return{uid:r.uid,level:r.audioTrack?100*r.audioTrack._source.getAccurateVolumeLevel():0}}),t=this.localTrackMap.get(Q.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=tu(e).call(e,(i,r)=>i.level-r.level),e}async disconnectForReconnect(){this.connection&&(S.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=st.Reconnecting,N("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var i;t._videoTrack&&t._videoTrack._player&&((i=t._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new _a({},this.store):this.isPlanB?new rd({},this.store):new Ro({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{var t;let[i,{track:r}]=e;switch(i){case Q.LocalVideoTrack:se(t=r._hints).call(t,Rt.LOW_STREAM)?r.close():this.pendingLocalTracks.push(r);break;case Q.LocalAudioTrack:r instanceof ai?this.pendingLocalTracks=this.pendingLocalTracks.concat(r.trackList):this.pendingLocalTracks.push(r);case Q.LocalVideoLowTrack:}}),this.emit(ye.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,i]=e;Array.from(Yr(i).call(i)).forEach(r=>{this.setPendingRemoteMedia(t,r)}),this.emit(ye.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(e=>{this.pendingLocalDataChannels.push(e)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(e=>{let[t,i]=e;Array.from(Yr(i).call(i)).forEach(r=>{this.setPendingRemoteDataChannel(t,r)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),S.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(let i of this.pendingRemoteDataChannels){let{user:r,id:n}=i;if((e instanceof ha?e.uid:e)===r.uid&&n===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(let i of this.pendingRemoteTracks){let{user:r,kind:n}=i;if((e instanceof ha?e.uid:e)===r.uid&&t===n)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return Vr(function*(){if(!t.connection||t.state!==st.Connected||t.connection instanceof _a)return;let i=yield Ue(t.mutex.lock("From P2PChannel.restartICE")),r;try{r=yield Ue(t.connection.restartICE(e));let o=yield Ue(r.next());if(o.done)return;let a=o.value,l=yield a;switch(t.reportPCDisconnectedOrFailed(e),e){case Ji.TCP:t._pcStatsUploadType=ms.TCP_RESTART;break;case Ji.RELAY:t._pcStatsUploadType=ms.RELAY_RESTART;break;default:t._pcStatsUploadType=ms.OLD_RESTART}t._isInRestartIce=!0,r.next(l)}catch(o){var n;(n=r)===null||n===void 0||n.throw(o)}finally{i()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;let e=this.connection.getStats(),t=this.localTrackMap.get(Q.LocalVideoTrack),i=this.localTrackMap.get(Q.LocalAudioTrack),r=e.videoSend.find(E=>E.ssrc===(t==null?void 0:t.ssrcs[0].ssrcId)),n=e.audioSend.find(E=>E.ssrc===(i==null?void 0:i.ssrcs[0].ssrcId));if(!r||!n)return 1;let o=Ur(this,ye.NeedSignalRTT),a=r?r.rttMs:void 0,l=n?n.rttMs:void 0,d=a&&l?(a+l)/2:a||l,u=(d&&o?(d+o)/2:d||o)||0,p=100*e.sendPacketLossRate*.7/50+.3*u/1500,m=p<.17?1:p<.36?2:p<.59?3:p<.1?4:5,f=t==null?void 0:t.track;if(f&&f._encoderConfig&&f._hints.indexOf(Rt.SCREEN_TRACK)===-1){let E=f._encoderConfig.bitrateMax,I=e.bitrate.actualEncoded;if(E&&I){let T=(1e3*E-I)/(1e3*E);return qb[T<.15?0:T<.3?1:T<.45?2:T<.6?3:4][m]}}return m}getDownlinkNetworkQuality(){if(!this.connection)return 0;let e=this.connection.getStats(),t=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[r]=i,n=r._audioSSRC,o=r._videoSSRC,a=e.audioRecv.find(I=>I.ssrc===n),l=e.videoRecv.find(I=>I.ssrc===o);if(!a&&!l)return void(t+=1);let d=Ur(this,ye.NeedSignalRTT),u=e.rtt,p=(u&&d?(u+d)/2:u||d)||0,m=a?a.jitterMs:void 0,f=e.recvPacketLossRate,E=.7*f*100/50+.3*p/1500;m&&(E=.6*f*100/50+.2*p/1500+.2*m/400),t+=E<.1?1:E<.17?2:E<.36?3:E<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new ne((t,i)=>{this.handleMuteLocalTrack(e,t,i)})}async replaceTrack(e,t){var i;if(S.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==st.Connected)return;let r=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:a}]=o;return e===a});if(!r)return;let n=r[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:n}]),this.bindLocalTrackEvents([{track:t,type:n}]),r[1].track=t),await((i=this.connection)===null||i===void 0?void 0:i.replaceTrack(t,r[1].id)),this.isPlanB){let o=r[1];o.id=t._mediaStreamTrack.id,this.localTrackMap.set(n,o)}if(n===Q.LocalVideoTrack&&!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ye().supportDualStreamEncoding){let o=this.localTrackMap.get(Q.LocalVideoLowTrack);if(o){let a=e._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=a,o.track._originMediaStreamTrack=a,await new ne((l,d)=>{this.handleReplaceTrack(o.track,l,d,!0)})}}}filterTobePublishedTracks(e,t,i){let r=[],n=this.getAllTracks();e=Cl(e=e.filter(d=>n.indexOf(d)===-1));let o,a=!1,l=this.localTrackMap.get(Q.LocalAudioTrack);for(let d of e){if(d instanceof Et&&(this.localTrackMap.has(Q.LocalVideoTrack)||a?new j(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(r.push({track:d,type:Q.LocalVideoTrack}),a=!0),t)){let u=this.getLowVideoTrack(d,i);r.push({track:u,type:Q.LocalVideoLowTrack})}if(d instanceof jt)if(l){let u=l.track;if(u instanceof ai)Iv([d]),u.addAudioTrack(d),this.bindLocalAudioTrackEvents(d,!0);else{let p=wv([u,d]);S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(p.getTrackId(),"]")),this.replaceTrack(u,p)}}else o instanceof ai?(Iv([d]),o.addAudioTrack(d)):o||!d._useAudioElement&&Ye().webAudioMediaStreamDest&&!d._bypassWebAudio?o=wv(o?[d,o]:[d]):o=d}return o&&(S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),r.push({track:o,type:Q.LocalAudioTrack})),r}filterTobeUnpublishedTracks(e){let t=[],i=this.getAllTracks();e=Cl(e=e.filter(r=>i.indexOf(r)!==-1));for(let r of e){if(r instanceof jt){let n=this.localTrackMap.get(Q.LocalAudioTrack);if(!n)continue;n.track instanceof ai?(n.track.removeAudioTrack(r),this.unbindLocalAudioTrackEvents(r),n.track.trackList.length===0&&(t.push([Q.LocalAudioTrack,n]),n.track.close())):t.push([Q.LocalAudioTrack,n])}if(r instanceof Et){let n=this.localTrackMap.get(Q.LocalVideoTrack);if(!n)continue;t.push([Q.LocalVideoTrack,n]);let o=this.localTrackMap.get(Q.LocalVideoLowTrack);o&&t.push([Q.LocalVideoLowTrack,o])}}return t}filterTobePublishedDataChannels(e){return e=(e=Cl(e)).filter(t=>this.localDataChannels.findIndex(i=>i.id===t.id)===-1)}filterTobeUnpublishedDataChannels(e){return e=(e=(e=Cl(e)).filter(t=>this.localDataChannels.indexOf(t)!==-1)).filter(t=>t._originDataChannel)}bindLocalTrackEvents(e){e.forEach(t=>{let{track:i,type:r}=t;switch(r){case Q.LocalVideoTrack:i.addListener(ce.GET_STATS,this.handleGetLocalVideoStats),i.addListener(ce.GET_RTC_STATS,this.handleGetRTCStats),i.addListener(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(ce.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(ce.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.addListener(ce.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Q.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case Q.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof ai?e.trackList.forEach(i=>{i.addListener(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(ce.GET_STATS,this.handleGetLocalAudioStats),i.addListener(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(ce.GET_STATS,this.handleGetLocalAudioStats),e.addListener(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(ce.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(ce.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[i,{track:r}]=t;return{track:r,type:i}})),e.forEach(t=>{let{track:i,type:r}=t;switch(r){case Q.LocalVideoTrack:i.off(ce.GET_STATS,this.handleGetLocalVideoStats),i.off(ce.GET_RTC_STATS,this.handleGetRTCStats),i.off(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(ce.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(ce.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.off(ce.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case Q.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case Q.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof ai?e.trackList.forEach(t=>{t.off(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(ce.GET_STATS,this.handleGetLocalAudioStats),t.off(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(ce.GET_STATS,this.handleGetLocalAudioStats),e.off(ce.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(ce.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(ce.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(ce.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(ce.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(ce.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof $l&&t.addListener(ce.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(e))}),t instanceof ed&&t.addListener(ce.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(ce.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,i]=e;i.has(me.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),i.has(me.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((i,r)=>{var n;let o,a,{track:l,type:d}=i;switch(d){case Q.LocalAudioTrack:o=ot.Audio,a={dtx:l instanceof i_&&l._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case Q.LocalVideoTrack:o=se(n=l._hints).call(n,Rt.SCREEN_TRACK)?ot.Screen:ot.High,a=$o($o({},pN(l)),{},{codec:this.store.codec});break;case Q.LocalVideoLowTrack:o=ot.Low,a=$o($o({},pN(l)),{},{codec:this.store.codec})}return{stream_type:o,attributes:a,ssrcs:t[r]}})}createGatewayUnpublishMessage(e){return e.map(t=>{var i;let r,[n,{track:o,ssrcs:a,id:l}]=t;switch(n){case Q.LocalVideoTrack:r=se(i=o._hints).call(i,Rt.SCREEN_TRACK)?ot.Screen:ot.High;break;case Q.LocalAudioTrack:r=ot.Audio;break;case Q.LocalVideoLowTrack:r=ot.Low}return{stream_type:r,ssrcs:a,mid:l}})}assignLocalTracks(e,t){e.forEach((i,r)=>{let{track:n,type:o}=i;this.localTrackMap.set(o,{track:n,id:t[r].id,ssrcs:t[r].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[i]=t;this.localTrackMap.delete(i)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(ye.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),N("NEW_ICE_RESTART")){var i;if(se(i=this._restartStates).call(i,t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;let r=a=>{(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")&&(S.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(a)),Ur(this,ye.QueryClientConnectionState)==="CONNECTED"&&this.emit(ye.RequestRestartICE,a))},n=()=>{e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="checking"&&e.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),S.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(ye.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},o=N("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(N("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Ye().supportPCSetConfiguration)r(Ji.RELAY),this._restartTimer=window.setTimeout(n,o);else if(mt())r(Ji.UDP),this._restartTimer=window.setTimeout(n,4e3);else{if(r(Ji.TCP),Ye().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{r(Ji.RELAY),this._restartTimer=window.setTimeout(n,o)},o));this._restartTimer=window.setTimeout(n,o)}},800))}}else{if(t==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout(()=>{e.iceConnectionState==="disconnected"&&N("ICE_RESTART")&&Ur(this,ye.QueryClientConnectionState)==="CONNECTED"&&this.emit(ye.RequestRestartICE)},800),void setTimeout(()=>{e.peerConnectionState==="disconnected"&&(S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(ye.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);t==="failed"&&(S.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(ye.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),_e.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:xt.TRACER}).onSuccess(),this.emit(ye.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{var i;let r=Array.from(Yr(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===t);var n;r&&(this.store.subscribe(r.uid,"audio",void 0,void 0,void 0,Date.now()),(n=r.audioTrack)===null||n===void 0||n.emit(Jl.FIRST_FRAME_DECODED),_e.firstRemoteFrame(this.store.sessionId,vi.FIRST_AUDIO_DECODE,kt.FIRST_AUDIO_DECODE,{peer:r._uintid,subscribeElapse:Gi.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{var i;let r=Array.from(Yr(i=this.remoteUserMap).call(i)).find(n=>n._audioSSRC===t);r&&_e.firstRemoteFrame(this.store.sessionId,vi.FIRST_AUDIO_RECEIVED,kt.FIRST_AUDIO_RECEIVED,{peer:r._uintid,subscribeElapse:Gi.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,i,r)=>{this.reportVideoFirstFrameDecoded(t,i,r)},e.onFirstVideoReceived=t=>{var i;let r=Array.from(Yr(i=this.remoteUserMap).call(i)).find(n=>n._videoSSRC===t);r&&_e.firstRemoteFrame(this.store.sessionId,vi.FIRST_VIDEO_RECEIVED,kt.FIRST_VIDEO_RECEIVED,{peer:r._uintid,subscribeElapse:Gi.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,i)=>{let r=t.candidateType==="relay",n=i.candidateType==="relay";i.candidateType!=="unknown"&&r===n||this.emit(ye.ConnectionTypeChange,r),S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(ia(i))," -> ").concat(JSON.stringify(ia(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,i)=>{S.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(ia(i))," -> ").concat(JSON.stringify(ia(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.getLocalVideoStats=()=>{let t=this.statsCollector.getLocalVideoTrackStats(),i=this.statsCollector.getRTCStats();return $o($o({},t),i)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}filterTobeMutedTracks(e){let t=[];if(this.getAllTracks().indexOf(e)===-1)return t;let i=this.localTrackMap.get(Q.LocalAudioTrack);if(e instanceof jt&&(i==null?void 0:i.track)instanceof ai)return i.track.isActive||t.push([Q.LocalAudioTrack,i]),t;let r=Array.from(this.localTrackMap.entries()).find(n=>{let[,{track:o}]=n;return e===o});if(r&&(t.push(r),r[0]===Q.LocalVideoTrack)){let n=this.localTrackMap.get(Q.LocalVideoLowTrack);n&&t.push([Q.LocalVideoLowTrack,n])}return t}filterTobeUnmutedTracks(e){let t=[],i=this.localTrackMap.get(Q.LocalAudioTrack);if(e instanceof jt&&(i==null?void 0:i.track)instanceof ai)return i.track.isActive&&t.push([Q.LocalAudioTrack,i]),t;let r=Array.from(this.localTrackMap.entries()).find(n=>{let[,{track:o}]=n;return e===o});if(r)if(r[0]===Q.LocalVideoTrack){t.push(r);let n=this.localTrackMap.get(Q.LocalVideoLowTrack);n&&t.push([Q.LocalVideoLowTrack,n])}else t.push(r);return t}createMuteMessage(e){return e.map(t=>{var i;let r,[n,{track:o,ssrcs:a,id:l}]=t;switch(n){case Q.LocalAudioTrack:r=ot.Audio;break;case Q.LocalVideoTrack:r=se(i=o._hints).call(i,Rt.SCREEN_TRACK)?ot.Screen:ot.High;break;case Q.LocalVideoLowTrack:r=ot.Low}return{stream_type:r,ssrcs:a,mid:l}})}createUnmuteMessage(e){return e.map(t=>{var i;let r,[n,{track:o,ssrcs:a,id:l}]=t;switch(n){case Q.LocalAudioTrack:r=ot.Audio;break;case Q.LocalVideoTrack:r=se(i=o._hints).call(i,Rt.SCREEN_TRACK)?ot.Screen:ot.High;break;case Q.LocalVideoLowTrack:r=ot.Low}return{stream_type:r,ssrcs:a,mid:l}})}filterTobeUnSubscribedTracks(e,t){let i=[],r=this.remoteUserMap.get(e);if(!r)return i;if(t){let n=r.get(t);if(!n)return i;i.push([e,{kind:t,id:n}])}else Array.from(r.entries()).forEach(n=>{let[o,a]=n;i.push([e,{kind:o,id:a}])});return i}filterTobeUnSubscribedDataChannels(e,t){let i=[];return t.forEach(r=>{var n;(n=this.remoteDataChannelMap.get(e))!==null&&n!==void 0&&n.has(r.id)&&i.push(r)}),i}createUnsubscribeMessage(e){let t=[];return e.forEach(i=>{let[r,{kind:n,id:o}]=i;switch(n){case me.VIDEO:return void(r._videoSSRC&&t.push({stream_type:me.VIDEO,ssrcId:r._videoSSRC}));case me.AUDIO:return void(r._audioSSRC&&t.push({stream_type:me.AUDIO,ssrcId:r._audioSSRC}))}}),t}createUnsubscribeAllMessage(e){let t=new Map;return e.forEach(i=>{let[r,{kind:n}]=i;if(t.has(r)){let o=t.get(r);n===me.VIDEO?o|=_i.Video:o|=_i.Audio,t.set(r,o)}else n===me.VIDEO?t.set(r,_i.Video):t.set(r,_i.Audio)}),{users:Array.from(t.entries()).map(i=>{let[r,n]=i;return{stream_id:r.uid,stream_type:n}})}}withdrawRemoteTracks(e){e.forEach(t=>{let[i,{kind:r}]=t,n=this.remoteUserMap.get(i);n&&(n.delete(r),Array.from(n.entries()).length===0&&this.remoteUserMap.delete(i))})}async updateBitrateLimit(e){let t=this.localTrackMap.get(Q.LocalVideoTrack),i=this.localTrackMap.get(Q.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),i&&e.low_stream_uplink&&await i.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(e,t){return e.map((i,r)=>{var n;let{stream_type:o}=i;return(n=t.find(a=>{let{stream_type:l}=a;return o===l}))===null||n===void 0?void 0:n.attributes})}async tryToUnmuteAudio(e){for(let i=0;i<e.length;i++)if(e[i]instanceof jt){var t;let r=this.filterTobeUnmutedTracks(e[i]);if(r.length===0)continue;await((t=this.connection)===null||t===void 0?void 0:t.unmuteLocal(r.map(o=>{let[,{id:a}]=o;return a})));let n=this.createUnmuteMessage(r);return void await _t(this,ye.RequestUnmuteLocal,n)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.connection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(ye.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(ye.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await mi(_m(this.dtlsFailedCount,Jt)),this.emit(ye.RequestReconnect)}async reconnectP2P(){let e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await ti(this,ye.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(ye.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(Q.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof Et)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof Et).length>1)throw new j(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof jt).length>1&&(e.some(t=>t instanceof jt&&t._bypassWebAudio)||!Ye().webAudioMediaStreamDest))throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let t of e){if(t instanceof Et&&this.pendingLocalTracks.some(i=>i instanceof Et))throw new j(A.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof jt&&this.pendingLocalTracks.some(i=>i instanceof jt)&&(!Ye().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof jt&&i._bypassWebAudio)))throw new j(A.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){let i=!N("DISABLE_DUAL_STREAM_USE_ENCODING")&&Ye().supportDualStreamEncoding,r=$o($o({},{width:160,height:120,framerate:15,bitrate:50}),t),n;n=i?e._mediaStreamTrack.clone():yv(e,r);let o=ft(8,"track-low-"),a=new Et(n,$o($o({},i&&{scaleResolutionDownBy:eT(r,e)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,o);return a.on(gc.TRANSCEIVER_UPDATED,l=>{e._updateRtpTransceiver(l,Yl.LOW_STREAM)}),a._hints.push(Rt.LOW_STREAM),e.on("sei-to-send",l=>{a.emit("sei-to-send",l)}),e.addListener(ce.NEED_CLOSE,()=>{a.close()}),a}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,i){let r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Ro){var n,o,a,l;let d=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:u,dtlsTransportState:p,peerConnectionState:m}=this.connection,{local:f,remote:E}=await this.connection.getSelectedCandidatePair();_e.pcStats(this.store.sessionId,{startTime:d,eventElapse:e-d||0,iceconnectionsate:u,dtlsstate:p,connectionstate:m,intSucc:t?1:2,error:r,selectedLocalCandidateProtocol:(n=f==null?void 0:f.protocol)!==null&&n!==void 0?n:"",selectedLocalCandidateType:(o=f.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(f.address,":").concat(f.port),selectedRemoteCandidateProtocol:(a=E.protocol)!==null&&a!==void 0?a:"",selectedRemoteCandidateType:(l=E.candidateType)!==null&&l!==void 0?l:"",selectedRemoteCandidateAddress:"".concat(E.address,":").concat(E.port),restartCnt:i})}}reportVideoFirstFrameDecoded(e,t,i,r){var n;let o=Array.from(Yr(n=this.remoteUserMap).call(n)).find(a=>a._videoSSRC===e);if(o){r||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let a=this.store.keyMetrics,l=a.subscribe.find(d=>d.userId===o.uid&&d.type==="video");_e.firstRemoteVideoDecode(this.store.sessionId,vi.FIRST_VIDEO_DECODE,kt.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:t,videoheight:i,subscribeElapse:Gi.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:a.requestAPEnd||0,apStart:a.requestAPStart||0,joinGwEnd:a.joinGatewayEnd||0,joinGwStart:a.joinGatewayStart||0,pcEnd:a.peerConnectionEnd||0,pcStart:a.peerConnectionStart||0,subscriberEnd:(l==null?void 0:l.subscribeEnd)||0,subscriberStart:(l==null?void 0:l.subscribeStart)||0,videoAddNotify:(l==null?void 0:l.streamAdded)||0,state:r?1:0})}}async remoteMediaSsrcChanged(e,t,i){if(!this.connection)return!1;let r=this.remoteUserMap.get(e);if(!r)return!1;let n=r.get(t);if(!n)return!1;let o=await this.connection.getRemoteSSRC(n);return o!==void 0&&o!==i}resetConnection(e){S.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===st.Connected?(S.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===rN.datachannel?new _a({},this.store):this.isPlanB?new rd({},this.store):new Ro({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:i}]=e;t===Q.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Yl.LOW_STREAM):i._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof Ro&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===ms.TCP_RESTART&&e===Ji.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,ms.DISCONNECTED_OR_FAILED)))}},ie(xe.prototype,"startP2PConnection",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"startP2PConnection"),xe.prototype),ie(xe.prototype,"connect",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"connect"),xe.prototype),ie(xe.prototype,"updateRemoteRTPCapabilities",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"updateRemoteRTPCapabilities"),xe.prototype),ie(xe.prototype,"preConnect",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"preConnect"),xe.prototype),ie(xe.prototype,"publishDataChannel",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"publishDataChannel"),xe.prototype),ie(xe.prototype,"unpublish",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"unpublish"),xe.prototype),ie(xe.prototype,"unpublishDataChannel",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"unpublishDataChannel"),xe.prototype),ie(xe.prototype,"unpublishLowStream",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"unpublishLowStream"),xe.prototype),ie(xe.prototype,"subscribeDataChannel",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"subscribeDataChannel"),xe.prototype),ie(xe.prototype,"subscribe",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"subscribe"),xe.prototype),ie(xe.prototype,"massSubscribe",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"massSubscribe"),xe.prototype),ie(xe.prototype,"unsubscribe",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"unsubscribe"),xe.prototype),ie(xe.prototype,"unsubscribeDataChannel",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"unsubscribeDataChannel"),xe.prototype),ie(xe.prototype,"massUnsubscribe",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"massUnsubscribe"),xe.prototype),ie(xe.prototype,"muteRemote",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"muteRemote"),xe.prototype),ie(xe.prototype,"unmuteRemote",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"unmuteRemote"),xe.prototype),ie(xe.prototype,"hasRemoteMediaWithLock",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"hasRemoteMediaWithLock"),xe.prototype),ie(xe.prototype,"disconnectForReconnect",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"disconnectForReconnect"),xe.prototype),ie(xe.prototype,"updateBitrateLimit",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"updateBitrateLimit"),xe.prototype),ie(xe.prototype,"remoteMediaSsrcChanged",[zi],Object.getOwnPropertyDescriptor(xe.prototype,"remoteMediaSsrcChanged"),xe.prototype),xe);function zi(e,t,i){let r=e[t];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){let n=this.mutex,o=await n.lock("From P2PChannel.".concat(t));try{for(var a=arguments.length,l=new Array(a),d=0;d<a;d++)l[d]=arguments[d];return await r.apply(this,l)}finally{o()}},i}function z9(e){let t=_1();return function(i,r){let n=i.appId;n!==void 0&&(ct(r,10),es(r,n));let o=i.cid;o!==void 0&&(ct(r,16),ct(r,o));let a=i.cname;a!==void 0&&(ct(r,26),es(r,a));let l=i.deviceId;l!==void 0&&(ct(r,34),es(r,l));let d=i.elapse;d!==void 0&&(ct(r,40),fa(r,d));let u=i.fileSize;u!==void 0&&(ct(r,48),fa(r,od(u)));let p=i.height;p!==void 0&&(ct(r,56),fa(r,od(p)));let m=i.jpg;m!==void 0&&(ct(r,66),ct(r,m.length),function($n,z){let re=sd($n,z.length);$n.bytes.set(z,re)}(r,m));let f=i.networkType;f!==void 0&&(ct(r,72),fa(r,od(f)));let E=i.osType;E!==void 0&&(ct(r,80),fa(r,od(E)));let I=i.requestId;I!==void 0&&(ct(r,90),es(r,I));let T=i.sdkVersion;T!==void 0&&(ct(r,98),es(r,T));let R=i.sequence;R!==void 0&&(ct(r,104),fa(r,od(R)));let w=i.sid;w!==void 0&&(ct(r,114),es(r,w));let O=i.timestamp;O!==void 0&&(ct(r,120),fa(r,O));let P=i.uid;P!==void 0&&(ct(r,128),ct(r,P));let M=i.vid;M!==void 0&&(ct(r,136),ct(r,M));let V=i.width;V!==void 0&&(ct(r,144),fa(r,od(V)));let F=i.service;F!==void 0&&(ct(r,152),ct(r,F));let Y=i.callbackData;Y!==void 0&&(ct(r,162),es(r,Y));let J=i.jpgEncryption;J!==void 0&&(ct(r,168),ct(r,J));let Z=i.requestType;Z!==void 0&&(ct(r,176),ct(r,Z));let pe=i.scorePorn;pe!==void 0&&(ct(r,185),Lv(r,pe));let Ke=i.scoreSexy;Ke!==void 0&&(ct(r,193),Lv(r,Ke));let rt=i.scoreNeutral;rt!==void 0&&(ct(r,201),Lv(r,rt));let Ct=i.scene;Ct!==void 0&&(ct(r,208),ct(r,Ct));let Zt=i.ossFilePrefix;Zt!==void 0&&(ct(r,218),es(r,Zt));let Mt=i.serviceVendor;if(Mt!==void 0)for(let $n of Mt){ct(r,226);let z=_1();J9($n,z),ct(r,z.limit),$9(r,z),Z9(z)}}(e,t),function(i){let r=i.bytes,n=i.limit;return r.length===n?r:r.subarray(0,n)}(t)}function Y9(e){return function(i){let r={};e:for(;!f1(i);){let n=ts(i);switch(n>>>3){case 0:break e;case 1:r.code=ts(i);break;case 2:r.msg=E1(i,ts(i));break;case 3:{let o=X9(i);r.data=q9(i),i.limit=o;break}default:p1(i,7&n)}}return r}({bytes:t=e,offset:0,limit:t.length});var t}function q9(e){let t={};e:for(;!f1(e);){let i=ts(e);switch(i>>>3){case 0:break e;case 1:t.requestId=E1(e,ts(e));break;case 2:t.requestType=ts(e)>>>0;break;case 3:t.scorePorn=kv(e);break;case 4:t.scoreSexy=kv(e);break;case 5:t.scoreNeutral=kv(e);break;case 6:t.requestScene=ts(e)>>>0;break;case 7:t.scene=ts(e)>>>0;break;default:p1(e,7&i)}}return t}function J9(e,t){let i=e.service;i!==void 0&&(ct(t,8),ct(t,i));let r=e.vendor;r!==void 0&&(ct(t,16),ct(t,r));let n=e.token;n!==void 0&&(ct(t,26),es(t,n));let o=e.callbackUrl;o!==void 0&&(ct(t,34),es(t,o))}function X9(e){let t=ts(e),i=e.limit;return e.limit=e.offset+t,i}function p1(e,t){switch(t){case 0:for(;128&g1(e););break;case 2:Dv(e,ts(e));break;case 5:Dv(e,4);break;case 1:Dv(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let Q9=new Float32Array(1);new Uint8Array(Q9.buffer);let Nv=new Float64Array(1),Ir=new Uint8Array(Nv.buffer);function od(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let m1=[];function _1(){let e=m1.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function Z9(e){m1.push(e)}function Dv(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function f1(e){return e.offset>=e.limit}function sd(e,t){let i=e.bytes,r=e.offset,n=e.limit,o=r+t;if(o>i.length){let a=new Uint8Array(2*o);a.set(i),e.bytes=a}return e.offset=o,o>n&&(e.limit=o),r}function Pv(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function E1(e,t){let i=Pv(e,t),r=String.fromCharCode,n=e.bytes,o="�",a="";for(let l=0;l<t;l++){let d,u,p,m,f=n[l+i];128&f?(224&f)==192?l+1>=t?a+=o:(d=n[l+i+1],(192&d)!=128?a+=o:(m=(31&f)<<6|63&d,m<128?a+=o:(a+=r(m),l++))):(240&f)==224?l+2>=t?a+=o:(d=n[l+i+1],u=n[l+i+2],(49344&(d|u<<8))!=32896?a+=o:(m=(15&f)<<12|(63&d)<<6|63&u,m<2048||m>=55296&&m<=57343?a+=o:(a+=r(m),l+=2))):(248&f)==240?l+3>=t?a+=o:(d=n[l+i+1],u=n[l+i+2],p=n[l+i+3],(12632256&(d|u<<8|p<<16))!=8421504?a+=o:(m=(7&f)<<18|(63&d)<<12|(63&u)<<6|63&p,m<65536||m>1114111?a+=o:(m-=65536,a+=r(55296+(m>>10),56320+(1023&m)),l+=3))):a+=o:a+=r(f)}return a}function es(e,t){let i=t.length,r=0;for(let a=0;a<i;a++){let l=t.charCodeAt(a);l>=55296&&l<=56319&&a+1<i&&(l=(l<<10)+t.charCodeAt(++a)-56613888),r+=l<128?1:l<2048?2:l<65536?3:4}ct(e,r);let n=sd(e,r),o=e.bytes;for(let a=0;a<i;a++){let l=t.charCodeAt(a);l>=55296&&l<=56319&&a+1<i&&(l=(l<<10)+t.charCodeAt(++a)-56613888),l<128?o[n++]=l:(l<2048?o[n++]=l>>6&31|192:(l<65536?o[n++]=l>>12&15|224:(o[n++]=l>>18&7|240,o[n++]=l>>12&63|128),o[n++]=l>>6&63|128),o[n++]=63&l|128)}}function $9(e,t){let i=sd(e,t.limit),r=e.bytes,n=t.bytes;for(let o=0,a=t.limit;o<a;o++)r[o+i]=n[o]}function g1(e){return e.bytes[Pv(e,1)]}function S1(e,t){let i=sd(e,1);e.bytes[i]=t}function kv(e){let t=Pv(e,8),i=e.bytes;return Ir[0]=i[t++],Ir[1]=i[t++],Ir[2]=i[t++],Ir[3]=i[t++],Ir[4]=i[t++],Ir[5]=i[t++],Ir[6]=i[t++],Ir[7]=i[t++],Nv[0]}function Lv(e,t){let i=sd(e,8),r=e.bytes;Nv[0]=t,r[i++]=Ir[0],r[i++]=Ir[1],r[i++]=Ir[2],r[i++]=Ir[3],r[i++]=Ir[4],r[i++]=Ir[5],r[i++]=Ir[6],r[i++]=Ir[7]}function ts(e){let t,i=0,r=0;do t=g1(e),i<32&&(r|=(127&t)<<i),i+=7;while(128&t);return r}function ct(e,t){for(t>>>=0;t>=128;)S1(e,127&t|128),t>>>=7;S1(e,t)}function fa(e,t){let i=t.low>>>0,r=(t.low>>>28|t.high<<4)>>>0,n=t.high>>>24,o=n===0?r===0?i<16384?i<128?1:2:i<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:n<128?9:10,a=sd(e,o),l=e.bytes;switch(o){case 10:l[a+9]=n>>>7&1;case 9:l[a+8]=o!==9?128|n:127&n;case 8:l[a+7]=o!==8?r>>>21|128:r>>>21&127;case 7:l[a+6]=o!==7?r>>>14|128:r>>>14&127;case 6:l[a+5]=o!==6?r>>>7|128:r>>>7&127;case 5:l[a+4]=o!==5?128|r:127&r;case 4:l[a+3]=o!==4?i>>>21|128:i>>>21&127;case 3:l[a+2]=o!==3?i>>>14|128:i>>>14&127;case 2:l[a+1]=o!==2?i>>>7|128:i>>>7&127;case 1:l[a]=o!==1?128|i:127&i}}function T1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}let e7=new Map([["moderation",1],["supervise",2]]);class C_ extends Ot{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;let i=this._connectionState;this._connectionState=t,this.emit(Ci.CONNECTION_STATE_CHANGE,i,t)}get inspectType(){return this._inspectType}set inspectType(t){var i;this._inspectMode=ao(i=t.map(r=>e7.get(r)||0)).call(i,(r,n)=>r+n),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(t){super(),y(this,"name","AgoraRTCVideoContentInspect"),y(this,"_connectionState",xn.CONNECTING),y(this,"_innerConnectionState",void 0),y(this,"sequence",0),y(this,"inspectStartTime",void 0),y(this,"workerManagerConnection",void 0),y(this,"workerConnection",void 0),y(this,"workerMessageLengthLimit",void 0),y(this,"inspectIntervalMinimum",void 0),y(this,"qualityRatio",void 0),y(this,"_connectInfo",void 0),y(this,"_cancelTokenSource",ur.CancelToken.source()),y(this,"_retryConfig",void 0),y(this,"wmSequence",0),y(this,"inspectInterval",void 0),y(this,"inspectTimer",null),y(this,"ossFilePrefix",void 0),y(this,"extraInfo",void 0),y(this,"_inspectType",void 0),y(this,"_inspectMode",void 0),y(this,"_quality",1),y(this,"qualityTimer",null),y(this,"_inspectId",void 0),y(this,"_needWorkUrlOnly",!1),y(this,"inspectImage",()=>{if(this.connectionState!==xn.CONNECTED)throw new U(A.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===xn.CONNECTED?this.requestToInspectImage():S.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=ft(5,"inspect-"),this.workerMessageLengthLimit=N("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=N("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=N("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new yu("worker-manager-"+this._inspectId,Jt),this.on(Ci.STATE_CHANGE,(i,r)=>{this._innerConnectionState=i,S.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Vn[i]," ").concat(r||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new yu("worker-"+this._inspectId,Jt),this.handleWorkerEvents()}async init(t,i){this.emit(Ci.STATE_CHANGE,Vn.CONNECT_AP),this._connectInfo=t;let r=this._cancelTokenSource.token;return this._retryConfig=i,new ne((n,o)=>{this.on(Ci.CONNECTION_STATE_CHANGE,(a,l)=>{l===xn.CONNECTED&&n()}),this.requestAP(t,r,i).then(a=>{this.connectWorkerManager(a)}).catch(a=>{o(a)})})}async requestAP(t,i,r){let n=N("WEBCS_DOMAIN").map(l=>"https://".concat(l,"/api/v1")),o=await function(l,d,u,p){let{appId:m,areaCode:f,cname:E,sid:I,token:T,uid:R}=d;Pl++;let w="image_moderation_api",O={service_name:w,json_body:JSON.stringify({appId:m,areaCode:f,cname:E,command:"allocateEdge",requestId:Pl,seq:Pl,sid:I,token:T,ts:Date.now(),uid:R+""})},P,M,V=l[0];return uo(async()=>{P=Date.now();let F=await _o(V,{data:O,cancelToken:u,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(M=Date.now()-P,F.code!==0){let pe=new U(A.UNEXPECTED_RESPONSE,"image inspect ap error, code"+F.code,{retry:!0,responseTime:M});throw S.error(pe.toString()),pe}let Y=JSON.parse(F.json_body);if(Y.code!==200){let pe=new U(A.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(Y.code,", reason: ").concat(Y.reason),{code:Y.code,responseTime:M});throw S.error(pe.toString()),pe}if(!Y.servers||!Array.isArray(Y.servers)||Y.servers.length===0){let pe=new U(A.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:Y.code,responseTime:M});throw S.error(pe.toString()),pe}let J=N("VIDEO_INSPECT_WORKER_MANAGER_HOST"),Z=N("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:Y.servers.map(pe=>{let{address:Ke,wss:rt}=pe;if(Ke&&rt)return"wss://".concat(Ke.replace(/\./g,"-"),".").concat(J,":").concat(Z||rt)}).filter(pe=>!!pe),workerToken:Y.workerToken,vid:Y.vid,responseTime:M}},(F,Y)=>(_e.apworkerEvent(I,{success:!0,sc:200,serviceName:w,responseDetail:JSON.stringify(F.addressList),firstSuccess:Y===0,responseTime:M,serverIp:l[Y%l.length]}),!1),(F,Y)=>(_e.apworkerEvent(I,{success:!1,sc:F.data&&F.data.code||200,serviceName:w,responseTime:M,serverIp:l[Y%l.length]}),!!(F.code!==A.OPERATION_ABORTED&&F.code!==A.UNEXPECTED_RESPONSE||F.data&&F.data.retry)&&(V=l[(Y+1)%l.length],!0)),p)}(n,t,i,r);this.emit(Ci.STATE_CHANGE,Vn.AP_CONNECTED);let{addressList:a}=o;return this.wmSequence++,a}async connectWorkerManager(t){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=i,this.emit(Ci.STATE_CHANGE,Vn.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(Ae.CONNECTED,async()=>{this.emit(Ci.STATE_CHANGE,Vn.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.21.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(Ae.CLOSED,()=>{this._innerConnectionState<Vn.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(Ae.FAILED,()=>{this._innerConnectionState<Vn.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(Ae.RECONNECTING,()=>{this._innerConnectionState<Vn.GET_WORKER_MANAGER_RESPONSE&&S.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(Ae.ON_MESSAGE,async t=>{this.emit(Ci.STATE_CHANGE,Vn.GET_WORKER_MANAGER_RESPONSE);let i=this.workerManagerConnection.url;this.workerManagerConnection.close();let r=JSON.parse(t.data);if(r.code!==200)throw S.error("[".concat(this._inspectId,"] Unexpected code ").concat(r.code," from worker manager")),new U(A.UNEXPECTED_RESPONSE,"response code of worker is unexpected",r);if(!(r.serverResponse&&r.serverResponse.portWss&&i))throw S.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(r))),new U(A.UNEXPECTED_RESPONSE,"response content of worker is unexpected",r);{let n=N("VIDEO_INSPECT_WORKER_PORT")||r.serverResponse.portWss,o=i.replace(/:\d+\/?$/,":".concat(n));this.emit(Ci.STATE_CHANGE,Vn.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(Ci.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o)}}),this.workerManagerConnection.on(Ae.WILL_RECONNECT,(t,i,r)=>{r(t)}),this.workerManagerConnection.on(Ae.REQUEST_NEW_URLS,(t,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(i)})}handleWorkerEvents(){this.workerConnection.on(Ae.CONNECTED,async()=>{this.emit(Ci.STATE_CHANGE,Vn.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=xn.CONNECTED}),this.workerConnection.on(Ae.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){let r=Y9(new Uint8Array(t.data));if(N("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&S.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(r)),r.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Ci.INSPECT_RESULT,void 0,void 0);if(r.data&&r.data.scorePorn&&r.data.scoreSexy&&r.data.scoreNeutral){var i;let n={porn:r.data.scorePorn,sexy:r.data.scoreSexy,neutral:r.data.scoreNeutral},o=ao(i=Object.keys(n)).call(i,(l,d)=>n[l]>n[d]?l:d,"porn"),a=Object.keys(n).find(l=>l===o);this.emit(Ci.INSPECT_RESULT,a)}else this.emit(Ci.INSPECT_RESULT,void 0,new U(A.UNEXPECTED_RESPONSE,r.code+"","There is an unexpected data on message"))}else this.emit(Ci.INSPECT_RESULT,void 0,new U(A.UNEXPECTED_RESPONSE,r.code+"",r.msg))}else S.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Ci.INSPECT_RESULT,void 0,new U(A.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(Ae.CLOSED,()=>{this.connectionState=xn.CLOSED}),this.workerConnection.on(Ae.FAILED,()=>{this.connectionState=xn.CLOSED}),this.workerConnection.on(Ae.RECONNECTING,()=>{this.connectionState=this.connectionState===xn.CONNECTED?xn.RECONNECTING:xn.CONNECTING}),this.workerConnection.on(Ae.WILL_RECONNECT,(t,i,r)=>{t==="recover"&&r(t),r("tryNext")}),this.workerConnection.on(Ae.REQUEST_NEW_URLS,(t,i)=>{this.workerManagerConnection.close(),this.once(Ci.REQUEST_NEW_WORKER_URL,r=>{t([r])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(r=>{this.connectWorkerManager(r,!0)}).catch(r=>{i(r)})})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){this.sequence++;let t=Ur(this,Ci.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(Ci.INSPECT_RESULT,void 0,new U(A.INVALID_OPERATION,"Only the track being played can be inspected"));let r=await this.generateRequestData(t,i);this.workerConnection.sendMessage(r,!0,!0)}else this.emit(Ci.INSPECT_RESULT,void 0,new U(A.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,i){let{appId:r,cname:n,cid:o,vid:a,sid:l,uid:d}=i,u=Date.now(),p=await t.getCurrentFrameImage("image/jpeg",this.quality),m=await vP(p,r,n),f=this.sequence+"-"+o+"-"+d+"-"+u+"-"+ft(12,""),E={appId:r,cid:o,cname:n,deviceId:"",elapse:C_.intToLong(Number(u-this.inspectStartTime)),fileSize:m.byteLength,jpgEncryption:2,height:p.height,width:p.width,jpg:m,networkType:6,osType:7,requestId:f,sdkVersion:"4.21.0",sequence:this.sequence,sid:l,timestamp:C_.intToLong(u),uid:d,vid:a,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete E.callbackData,this.ossFilePrefix===void 0&&delete E.ossFilePrefix;let I=z9(E);if(I.byteLength<this.workerMessageLengthLimit){if(N("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){let T=function(R){for(var w=1;w<arguments.length;w++){var O=arguments[w]!=null?arguments[w]:{};w%2?T1(Object(O),!0).forEach(function(P){y(R,P,O[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(R,Object.getOwnPropertyDescriptors(O)):T1(Object(O)).forEach(function(P){Object.defineProperty(R,P,Object.getOwnPropertyDescriptor(O,P))})}return R}({},E);delete T.jpg,S.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(T))}return I}{let T=this.quality*this.qualityRatio;return this.quality=T,await this.generateRequestData(t,{appId:r,cname:n,cid:o,vid:a,sid:l,uid:d})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ur.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=xn.CLOSED,this.emit(Ci.STATE_CHANGE,Vn.CLOSED)}}function t7(e){let t=function(){let i=n7.pop();return i?(i.offset=i.limit=0,i):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(i,r){let n=i.appId;n!==void 0&&(Qt(r,10),Ea(r,n));let o=i.cid;o!==void 0&&(Qt(r,16),Qt(r,o));let a=i.cname;a!==void 0&&(Qt(r,26),Ea(r,a));let l=i.deviceId;l!==void 0&&(Qt(r,34),Ea(r,l));let d=i.elapse;d!==void 0&&(Qt(r,40),ga(r,d));let u=i.fileSize;u!==void 0&&(Qt(r,48),ga(r,ad(u)));let p=i.height;p!==void 0&&(Qt(r,56),ga(r,ad(p)));let m=i.jpg;m!==void 0&&(Qt(r,66),Qt(r,m.length),R1(r,m));let f=i.networkType;f!==void 0&&(Qt(r,72),ga(r,ad(f)));let E=i.osType;E!==void 0&&(Qt(r,80),ga(r,ad(E)));let I=i.requestId;I!==void 0&&(Qt(r,90),Ea(r,I));let T=i.sdkVersion;T!==void 0&&(Qt(r,98),Ea(r,T));let R=i.sequence;R!==void 0&&(Qt(r,104),ga(r,ad(R)));let w=i.sid;w!==void 0&&(Qt(r,114),Ea(r,w));let O=i.timestamp;O!==void 0&&(Qt(r,120),ga(r,O));let P=i.uid;P!==void 0&&(Qt(r,128),Qt(r,P));let M=i.vid;M!==void 0&&(Qt(r,136),Qt(r,M));let V=i.width;V!==void 0&&(Qt(r,144),ga(r,ad(V)));let F=i.service;F!==void 0&&(Qt(r,152),Qt(r,F));let Y=i.callbackData;Y!==void 0&&(Qt(r,162),Qt(r,Y.length),R1(r,Y));let J=i.ticket;J!==void 0&&(Qt(r,170),Ea(r,J));let Z=i.vendorConfigs;Z!==void 0&&(Qt(r,178),Ea(r,Z))}(e,t),function(i){let r=i.bytes,n=i.limit;return r.length===n?r:r.subarray(0,n)}(t)}function i7(e){return function(i){let r={};e:for(;!o7(i);){let n=sh(i);switch(n>>>3){case 0:break e;case 1:r.code=sh(i);break;case 2:r.msg=C1(i,sh(i));break;case 3:r.requestId=C1(i,sh(i));break;case 4:r.timestamp=s7(i,!1);break;default:r7(i,7&n)}}return r}({bytes:t=e,offset:0,limit:t.length});var t}function r7(e,t){switch(t){case 0:for(;128&Zn(e););break;case 2:Mv(e,sh(e));break;case 5:Mv(e,4);break;case 1:Mv(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function ad(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let n7=[];function Mv(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function o7(e){return e.offset>=e.limit}function y_(e,t){let i=e.bytes,r=e.offset,n=e.limit,o=r+t;if(o>i.length){let a=new Uint8Array(2*o);a.set(i),e.bytes=a}return e.offset=o,o>n&&(e.limit=o),r}function v1(e,t){let i=e.offset;if(i+t>e.limit)throw new Error("Read past limit");return e.offset+=t,i}function R1(e,t){let i=y_(e,t.length);e.bytes.set(t,i)}function C1(e,t){let i=v1(e,t),r=String.fromCharCode,n=e.bytes,o="�",a="";for(let l=0;l<t;l++){let d,u,p,m,f=n[l+i];128&f?(224&f)==192?l+1>=t?a+=o:(d=n[l+i+1],(192&d)!=128?a+=o:(m=(31&f)<<6|63&d,m<128?a+=o:(a+=r(m),l++))):(240&f)==224?l+2>=t?a+=o:(d=n[l+i+1],u=n[l+i+2],(49344&(d|u<<8))!=32896?a+=o:(m=(15&f)<<12|(63&d)<<6|63&u,m<2048||m>=55296&&m<=57343?a+=o:(a+=r(m),l+=2))):(248&f)==240?l+3>=t?a+=o:(d=n[l+i+1],u=n[l+i+2],p=n[l+i+3],(12632256&(d|u<<8|p<<16))!=8421504?a+=o:(m=(7&f)<<18|(63&d)<<12|(63&u)<<6|63&p,m<65536||m>1114111?a+=o:(m-=65536,a+=r(55296+(m>>10),56320+(1023&m)),l+=3))):a+=o:a+=r(f)}return a}function Ea(e,t){let i=t.length,r=0;for(let a=0;a<i;a++){let l=t.charCodeAt(a);l>=55296&&l<=56319&&a+1<i&&(l=(l<<10)+t.charCodeAt(++a)-56613888),r+=l<128?1:l<2048?2:l<65536?3:4}Qt(e,r);let n=y_(e,r),o=e.bytes;for(let a=0;a<i;a++){let l=t.charCodeAt(a);l>=55296&&l<=56319&&a+1<i&&(l=(l<<10)+t.charCodeAt(++a)-56613888),l<128?o[n++]=l:(l<2048?o[n++]=l>>6&31|192:(l<65536?o[n++]=l>>12&15|224:(o[n++]=l>>18&7|240,o[n++]=l>>12&63|128),o[n++]=l>>6&63|128),o[n++]=63&l|128)}}function Zn(e){return e.bytes[v1(e,1)]}function y1(e,t){let i=y_(e,1);e.bytes[i]=t}function sh(e){let t,i=0,r=0;do t=Zn(e),i<32&&(r|=(127&t)<<i),i+=7;while(128&t);return r}function Qt(e,t){for(t>>>=0;t>=128;)y1(e,127&t|128),t>>>=7;y1(e,t)}function s7(e,t){let i,r=0,n=0,o=0;return i=Zn(e),r=127&i,128&i&&(i=Zn(e),r|=(127&i)<<7,128&i&&(i=Zn(e),r|=(127&i)<<14,128&i&&(i=Zn(e),r|=(127&i)<<21,128&i&&(i=Zn(e),n=127&i,128&i&&(i=Zn(e),n|=(127&i)<<7,128&i&&(i=Zn(e),n|=(127&i)<<14,128&i&&(i=Zn(e),n|=(127&i)<<21,128&i&&(i=Zn(e),o=127&i,128&i&&(i=Zn(e),o|=(127&i)<<7))))))))),{low:r|n<<28,high:n>>>4|o<<24,unsigned:t}}function ga(e,t){let i=t.low>>>0,r=(t.low>>>28|t.high<<4)>>>0,n=t.high>>>24,o=n===0?r===0?i<16384?i<128?1:2:i<1<<21?3:4:r<16384?r<128?5:6:r<1<<21?7:8:n<128?9:10,a=y_(e,o),l=e.bytes;switch(o){case 10:l[a+9]=n>>>7&1;case 9:l[a+8]=o!==9?128|n:127&n;case 8:l[a+7]=o!==8?r>>>21|128:r>>>21&127;case 7:l[a+6]=o!==7?r>>>14|128:r>>>14&127;case 6:l[a+5]=o!==6?r>>>7|128:r>>>7&127;case 5:l[a+4]=o!==5?128|r:127&r;case 4:l[a+3]=o!==4?i>>>21|128:i>>>21&127;case 3:l[a+2]=o!==3?i>>>14|128:i>>>14&127;case 2:l[a+1]=o!==2?i>>>7|128:i>>>7&127;case 1:l[a]=o!==1?128|i:127&i}}let I1={},w1={},I_=4294967296,a7=I_*I_,A1=a7/2;b1(0,!0);let O1=b1(0),c7=ah(0,-2147483648,!1),l7=ah(-1,2147483647,!1);function b1(e,t){let i,r,n;return t?(n=0<=(e>>>=0)&&e<256)&&(r=w1[e],r)?r:(i=ah(e,0,!0),n&&(w1[e]=i),i):(n=-128<=(e|=0)&&e<128)&&(r=I1[e],r)?r:(i=ah(e,e<0?-1:0,!1),n&&(I1[e]=i),i)}function ah(e,t,i){return{low:0|e,high:0|t,unsigned:!!i}}function d7(e,t){if(isNaN(e))return O1;{if(e<=-A1)return c7;if(e+1>=A1)return l7}return e<0?O1:ah(e%I_|0,e/I_|0,t)}function N1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}class Uv extends Ot{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;let i=this._connectionState;this._connectionState=t,this.emit(po.CONNECTION_STATE_CHANGE,t,i)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(t){var i;super(),y(this,"name","AgoraRTCImageModeration"),y(this,"_connectionState",fn.CONNECTING),y(this,"_sequence",0),y(this,"_moderationStartTime",void 0),y(this,"_workerConnection",void 0),y(this,"_workerMessageLengthLimit",void 0),y(this,"_qualityRatio",void 0),y(this,"_connectInfo",void 0),y(this,"_cancelTokenSource",ur.CancelToken.source()),y(this,"_retryConfig",void 0),y(this,"_moderationInterval",void 0),y(this,"_moderationTimer",null),y(this,"_moderationMode",1),y(this,"_quality",1),y(this,"_qualityTimer",null),y(this,"_ticket",void 0),y(this,"_moderationIntervalMinimum",void 0),y(this,"_uploadFailedNum",0),y(this,"_uploadNum",0),y(this,"_uploadTimer",null),y(this,"_extraInfo",void 0),y(this,"_vendor",""),y(this,"_encoder",new TextEncoder),y(this,"_moderationId",void 0),y(this,"inspectImage",()=>{if(this.connectionState!==fn.CONNECTED)throw new U(A.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===fn.CONNECTED?this.requestToInspectImage():S.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=ft(5,"image-moderation-"),this._workerMessageLengthLimit=N("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=N("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(i=t.interval)!==null&&i!==void 0?i:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=N("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new yu("worker-"+this._moderationId,Jt),this.on(po.STATE_CHANGE,(r,n)=>{S.debug("[".concat(this._moderationId,"] Moderation operation :").concat(bl[r]," ").concat(n||""))}),this.handleWorkerEvents()}async init(t,i){this.emit(po.STATE_CHANGE,bl.CONNECT_AP),this._connectInfo=t;let r=this._cancelTokenSource.token;return this._retryConfig=i,new ne((n,o)=>{this.on(po.CONNECTION_STATE_CHANGE,(a,l)=>{a===fn.CONNECTED&&n()}),this.requestAP(t,r,i).then(a=>{this.connectWorker(a)}).catch(a=>{o(a)})})}updateConfig(t){var i;this._moderationInterval=(i=t.interval)!==null&&i!==void 0?i:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),S.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===fn.CONNECTED&&this.inspectImage()}async requestAP(t,i,r){let n=N("WEBCS_DOMAIN").map(d=>"https://".concat(d,"/api/v1")),o=await function(d,u,p,m){let{appId:f,areaCode:E,cname:I,sid:T,token:R,uid:w}=u;Pl++;let O="moderation_plugin",P={service_name:O,json_body:JSON.stringify({appId:f,areaCode:E,cname:I,command:"allocateEdge",requestId:Pl,seq:Pl,sid:T,appToken:R,ts:Date.now(),uid:w+""})},M,V,F=d[0];return uo(async()=>{M=Date.now();let Y=await _o(F,{data:P,cancelToken:p,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(V=Date.now()-M,Y.code!==0){let pe=new U(A.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+Y.code,{retry:!0,responseTime:V});throw S.error(pe.toString()),pe}let J=JSON.parse(Y.json_body);if(J.code!==200){let pe=new U(A.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(J.code,", reason: ").concat(J.reason),{code:J.code,responseTime:V});throw S.error(pe.toString()),pe}if(!J.servers||!Array.isArray(J.servers)||J.servers.length===0){let pe=new U(A.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:J.code,responseTime:V});throw S.error(pe.toString()),pe}if(!J.servers.some(pe=>!!pe.wss)){let pe=new U(A.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:J.code,responseTime:V});throw S.error(pe.toString()),pe}let Z=N("IMAGE_MODERATION_WORKER_HOST");return{addressList:J.servers.map(pe=>{let{address:Ke,wss:rt}=pe;if(Ke&&rt)return"wss://".concat(Ke.replace(/\./g,"-"),".").concat(Z,":").concat(rt,"/moderation")}).filter(pe=>!!pe),workerToken:J.workerToken,vid:J.vid,ticket:J.appTicket,responseTime:V}},(Y,J)=>(_e.apworkerEvent(T,{success:!0,sc:200,serviceName:O,responseDetail:JSON.stringify(Y.addressList),firstSuccess:J===0,responseTime:V,serverIp:d[J%d.length]}),!1),(Y,J)=>(_e.apworkerEvent(T,{success:!1,sc:Y.data&&Y.data.code||200,serviceName:O,responseTime:V,serverIp:d[J%d.length]}),!!(Y.code!==A.OPERATION_ABORTED&&Y.code!==A.UNEXPECTED_RESPONSE||Y.data&&Y.data.retry)&&(F=d[(J+1)%d.length],!0)),m)}(n,t,i,r);this.emit(po.STATE_CHANGE,bl.AP_CONNECTED);let{addressList:a,ticket:l}=o;return this._ticket=l,a}async connectWorker(t){this.emit(po.STATE_CHANGE,bl.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(Ae.CONNECTED,async()=>{this.emit(po.STATE_CHANGE,bl.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=fn.CONNECTED}),this._workerConnection.on(Ae.CLOSED,()=>{this.connectionState=fn.CLOSED}),this._workerConnection.on(Ae.FAILED,()=>{this.connectionState=fn.CLOSED}),this._workerConnection.on(Ae.RECONNECTING,()=>{this.connectionState=this.connectionState===fn.CONNECTED?fn.RECONNECTING:fn.CONNECTING}),this._workerConnection.on(Ae.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){let i=i7(new Uint8Array(t.data));N("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(i)),this._uploadNum++,i.code===void 0||i.code===0||(this._uploadFailedNum++,S.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(i.code,", msg is ").concat(i.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{_e.reportApiInvoke(this._connectInfo.sid||null,{name:ei.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,i.code],tag:xt.TRACER}).onError(new U(A.IMAGE_MODERATION_UPLOAD_FAILED,i.msg)),this._uploadTimer=null},N("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else S.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(Ae.WILL_RECONNECT,(t,i,r)=>{t==="recover"&&r(t),r("tryNext")}),this._workerConnection.on(Ae.REQUEST_NEW_URLS,(t,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(i)})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){let t=Ur(this,po.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(N("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("Only the track being played can be inspected"));this._sequence++;let r=await this.generateRequestData(t,i);this._workerConnection.sendMessage(r,!0,!0)}else N("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&S.debug("Only the track being published can be inspected")}async generateRequestData(t,i){let{appId:r,cname:n,cid:o,vid:a,sid:l,uid:d}=i,u=Date.now(),p=await t.getCurrentFrameImage("image/jpeg",this.quality),m=await vP(p,r,n),f=this._sequence+"-"+o+"-"+d+"-"+u+"-"+ft(12,""),E={appId:r,cid:o,cname:n,deviceId:"",elapse:Uv.intToLong(Number(u-this._moderationStartTime)),fileSize:p.buffer.byteLength,height:p.height,width:p.width,jpg:m,networkType:6,osType:7,requestId:f,sdkVersion:"4.21.0",sequence:this._sequence,sid:l,timestamp:d7(u),uid:d,vid:a,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete E.callbackData;let I=t7(E);if(I.byteLength<this._workerMessageLengthLimit){if(N("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){let T=function(R){for(var w=1;w<arguments.length;w++){var O=arguments[w]!=null?arguments[w]:{};w%2?N1(Object(O),!0).forEach(function(P){y(R,P,O[P])}):Object.getOwnPropertyDescriptors?Object.defineProperties(R,Object.getOwnPropertyDescriptors(O)):N1(Object(O)).forEach(function(P){Object.defineProperty(R,P,Object.getOwnPropertyDescriptor(O,P))})}return R}({},E);delete T.jpg,S.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(T))}return I}{let T=this.quality*this._qualityRatio;return this.quality=T,await this.generateRequestData(t,{appId:r,cname:n,cid:o,vid:a,sid:l,uid:d})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=ur.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=fn.CLOSED,this.emit(po.STATE_CHANGE,bl.CLOSED)}}function D1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function P1(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?D1(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):D1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let u7=Date.now(),h7=20,xv=new Map,w_=new Map;async function k1(e){let t=xv.get(e),i=Array.isArray(t)&&t[t.length-1],r=w_.get(e);if(!i)return void(r.isSyncing=!1);let n={uid:i.uid,payload:i.payload};r.firstRecvTs===0&&(r.firstRecvTs=i.recvTs,r.firstSendTs=i.sendTs);let o=i.sendTs-r.firstSendTs,a=o-(Date.now()-r.firstRecvTs);a>0&&(r.firstRecvTs=Date.now()-o);let l=i.mediaDelay+a;l<=0?(t.pop(),L1(i.context,n),l=0):l=Math.min(l,h7),setTimeout(()=>t.length&&k1(e),l)}function L1(e,t){e.safeEmit(We.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function p7(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return L1(i,{uid:e.uid,payload:e.payload});let r="".concat(i.id,"-").concat(e.uid),n=xv.get(r)||[],o=n.findIndex(u=>e.sendTs>=u.sendTs),a=P1(P1({},e),{},{context:i,mediaDelay:t,recvTs:Date.now()});o===-1?n.push(a):n.splice(o,0,a),xv.set(r,n);let l=!1;var d;w_.has(r)?l=!((d=w_.get(r))===null||d===void 0||!d.isSyncing):w_.set(r,{isSyncing:l,firstRecvTs:0,firstSendTs:0}),l||k1(r)}let m7=Xe().name;function M1(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function U1(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?M1(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):M1(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let cd="websdk_ng_cache_parameter",_7=N("MAX_PRELOAD_ASYNC_LENGTH"),f7=1e4,Ac=new Map,Oc=[],Vv=null,Fv=0,jv=0,A_=new Map,E7=function(e,t){let i=[],r=0,n=async()=>{let o=i.shift();o&&await o(),i.length>0&&r<t?n():r--};return async function(){for(var o=arguments.length,a=new Array(o),l=0;l<o;l++)a[l]=arguments[l];return new ne(async(d,u)=>{i.push(async()=>{try{let p=await e(...a);d(p)}catch(p){u(p)}}),r<t&&(r++,n())})}}(x1,_7),Bv=ur.CancelToken.source();async function x1(e,t,i,r,n){try{if(!N("ENABLE_PRELOAD"))return;if(!Ye().supportWebCrypto)return void Js(()=>{S.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!i&&i!==null)throw new j(A.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Ai(i,"token",1,2047),Ai(e,"appid",1,2047),Tm(t),r&&vm(r);let o=Su();S.debug("preload channel ".concat(t,", uid is ").concat(r));let a={appId:e,cname:t,token:i||e,uid:typeof r!="string"?r:null,sid:o,proxyServer:n},l,d;typeof r=="string"?(a.stringUid=r,[d,l]=await ne.all([Vz(r,{sid:o,appId:e},Bv.token),bN(U1(U1({},a),{},{token:i||e,uid:0}),Bv.token)]),a.uid=d.uid,l.gatewayInfo.uid=a.uid,l.gatewayInfo.res.uid=a.uid):l=await bN(a,Bv.token);let u={sid:o,appId:e,cname:t,token:i||e,uid:a.stringUid||r,intUid:a.uid||l.gatewayInfo.uid,stringUid:a.stringUid,ts:Date.now(),sua:d,ap:l};await async function(p){let m;try{p.uid&&F1({appId:p.appId,cname:p.cname,token:p.token,uid:p.uid,stringUid:p.stringUid});let f=W1(p),E=await async function(T,R){try{let w=await window.crypto.subtle.importKey("raw",kb(R),"AES-GCM",!1,["encrypt"]),O=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},w,nc(window.btoa(JSON.stringify(T))));return Xs(new Uint8Array(O))}catch{return}}(p,p.token||p.appId);if(!E)return;m=G1(cd);let I=m?JSON.parse(m):[];I.push({[f]:E}),I.length>N("AP_CACHE_NUM")&&I.shift(),O_(cd,JSON.stringify(I))}catch(f){S.warn("Error caching server parameters:",f.message),O_(cd,"")}}(u),Fv++}catch(o){throw jv++,function(a){Vv||(Vv=window.setTimeout(()=>{let d="";A_.forEach((u,p)=>{d+="".concat(p,": ").concat(u," ;")}),_e.reportApiInvoke(null,{name:ei.PRELOAD,options:{success:Fv,failed:jv,err:d}}).onError(a),Fv=0,jv=0,A_.clear(),Vv=null},f7));let l=A_.get(a.code)||0;A_.set(a.code,l+1)}(o),o}}async function V1(e){try{let t=F1(e);if(!t||e.cloudProxyServer!=="disabled")return;let i=await async function(r,n){try{let o=await window.crypto.subtle.importKey("raw",kb(n),"AES-GCM",!1,["decrypt"]),a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},o,nc(r));return JSON.parse(window.atob(Xs(new Uint8Array(a))))}catch{return}}(t,e.token||e.appId);if(!i||!function(r,n){return r.cname===n.cname&&r.appId===n.appId&&r.token===n.token?n.stringUid?r.stringUid===n.stringUid:typeof n.uid=="number"?r.uid===n.uid:r.uid==n.uid:!1}(i,e))return;if(i&&Date.now()-i.ts<N("AP_CACHE_LIFETIME"))return i}catch(t){S.warn("Error get preloadInfo",t.message)}}function F1(e){let t;try{if(t=G1(cd),!t)return;let i=JSON.parse(t),r=W1(e),n=function(a,l){for(let d=a.length-1;d>=0;d--)if(l(a[d]))return d;return-1}(i,a=>r in a);if(n===-1)return;let o=i.splice(n,1)[0];return O_(cd,JSON.stringify(i)),o[r]}catch(i){S.warn("Error delete preload info: ".concat(t),i.message),O_(cd,"")}}function Gv(e){if(e){let t=Ac.get(e);t&&(window.clearTimeout(t),t=null,Ac.delete(e)),se(Oc).call(Oc,e)||e.cloudProxyServer!=="disabled"||Oc.push(e)}if(Ac.size<N("AP_CACHE_NUM")&&Oc.length>0){let t=Oc.shift();Ac.set(t,window.setTimeout(async()=>{let{appId:i,cname:r,token:n,uid:o,proxyServer:a}=t;try{await E7(i,r,n,o,a),Ac.has(t)&&Gv(t)}catch(l){S.warn("update preload failed",l.message),j1(t)}},N("AP_UPDATE_INTERVAL")))}}function j1(e){let t=Oc.indexOf(e);t!==-1&&Oc.splice(t,1);let i=Ac.get(e);i&&(window.clearTimeout(i),i=null,Ac.delete(e),Gv())}function B1(e,t){let i=e.sua,r=e.ap;t&&i&&_e.reqUserAccount(e.sid,{lts:i.requestTime,elapse:i.elapse,success:!0,serverAddr:i.url,stringUid:t,uid:e.intUid,errorCode:null,extend:i.req}),_e.reportResourceTiming(e.ap.url,e.sid),_e.joinWebProxyAP(e.sid,{lts:r.requestTime,elapse:r.elapse,sucess:1,apServerAddr:r.url,turnServerAddrList:r.proxyInfo.addresses.map(n=>n.ip).join(","),eventType:"disabled",unilbsServerIds:[Xt.CHOOSE_SERVER,Xt.CLOUD_PROXY_FALLBACK].toString()}),_e.joinChooseServer(e.sid,{lts:r.requestTime,elapse:r.elapse,succ:!0,csAddr:r.url,opid:r.opid,serverList:r.gatewayInfo.gatewayAddrs.map(n=>n.address),ec:null,cid:r.gatewayInfo.cid.toString(),uid:r.gatewayInfo.uid.toString(),csIp:r.gatewayInfo.csIp,unilbsServerIds:[Xt.CHOOSE_SERVER].toString(),isHttp3:r.isHttp3})}function G1(e){return window.atob(window.localStorage.getItem(e)||"")}function O_(e,t){window.localStorage.setItem(e,window.btoa(t))}function W1(e){let t="".concat(e.appId,"_").concat(e.cname);return typeof e.uid=="string"&&(t+="_s_".concat(e.uid)),typeof e.uid=="number"&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),jb(t)}var H1,K1,z1,Y1,q1,J1,X1,Q1,Z1,$1,eM,tM,iM,rM,nM,oM,sM,aM,cM,lM,dM,uM,hM,pM,mM,_M,fM,EM,gM,SM,TM,vM,RM,CM,yM,IM,wM,AM,OM,bM,NM,DM,ae;function PM(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function Rn(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?PM(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):PM(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}Ti.setLogger(S);let g7=(H1=Ce(),K1=Ce({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof Xl))return[t];t=[t]}return t.map(i=>i?Object(i).toString():"null")}}),z1=Ce({argsMap:(e,t)=>(t||(t=[]),t instanceof tL?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map(i=>i.getTrackId())))}),Y1=Ce({argsMap:(e,t,i,r)=>[typeof t=="object"?t.uid:t,i,r]}),q1=Ce({argsMap:(e,t,i)=>[t,i]}),J1=Ce({argsMap:(e,t)=>t.map(i=>{let{user:r,mediaType:n}=i;return[r==null?void 0:r.uid,n]})}),X1=Ce({argsMap:(e,t,i,r)=>[typeof t=="object"?t.uid:t,i,r]}),Q1=Ce({argsMap:(e,t)=>t.map(i=>{let{user:r,mediaType:n}=i;return{uid:r==null?void 0:r.uid,mediaType:n}})}),Z1=Ce(),$1=Ce(),eM=Ce(),tM=Ce(),iM=Ce(),rM=Ce(),nM=Ce(),oM=Ce(),sM=Ce(),aM=Ce(),cM=Ce(),lM=Ce(),dM=Ce(),uM=Ce(),hM=Ce({argsMap:(e,t)=>[t]}),pM=Ce(),mM=Ce(),_M=Ce(),fM=Ce(),EM=Ce(),gM=Ce(),SM=Ce(),TM=Ce(),vM=Ce(),RM=Ce(),CM=Ce({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),yM=Ce(),IM=Ce(),wM=Ce(),AM=Ce(),OM=Ce(),bM=Ce(),NM=Ce({reportResult:!0}),DM=Ce(),ae=class extends Ot{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let t;if(super(),y(this,"store",void 0),y(this,"_uid",void 0),y(this,"_channelName",void 0),y(this,"_uintUid",void 0),y(this,"_users",[]),y(this,"_config",void 0),y(this,"_clientId",void 0),y(this,"_appId",void 0),y(this,"_sessionId",null),y(this,"_key",void 0),y(this,"_rtmConfig",{}),y(this,"_joinInfo",void 0),y(this,"_gateway",void 0),y(this,"_statsCollector",void 0),y(this,"_configDistribute",void 0),y(this,"_leaveMutex",new Ti("client-leave")),y(this,"_publishMutex",new Ti("client-publish")),y(this,"_renewTokenMutex",new Ti("client-renewtoken")),y(this,"_subscribeMutex",new Ti("client-subscribe")),y(this,"_encryptionMode","none"),y(this,"_encryptionSecret",null),y(this,"_encryptionSalt",null),y(this,"_encryptDataStream",!1),y(this,"_encryptDataStreamKey",null),y(this,"_encryptDataStreamIv",null),y(this,"_proxyServer",void 0),y(this,"_turnServer",{servers:[],mode:"auto"}),y(this,"_cloudProxyServerMode","disabled"),y(this,"_isDualStreamEnabled",!1),y(this,"_defaultStreamFallbackType",void 0),y(this,"_lowStreamParameter",void 0),y(this,"_streamFallbackTypeCacheMap",new Map),y(this,"_remoteStreamTypeCacheMap",new Map),y(this,"_axiosCancelSource",ur.CancelToken.source()),y(this,"_audioVolumeIndicationInterval",void 0),y(this,"_networkQualityInterval",void 0),y(this,"_userOfflineTimeout",void 0),y(this,"_streamRemovedTimeout",void 0),y(this,"_injectStreamingClient",void 0),y(this,"_liveTranscodeStreamingClient",void 0),y(this,"_liveRawStreamingClient",void 0),y(this,"_channelMediaRelayClient",void 0),y(this,"_networkQualitySensitivity","normal"),y(this,"_p2pChannel",void 0),y(this,"_useLocalAccessPoint",!1),y(this,"_setLocalAPVersion",void 0),y(this,"_joinAndNotLeaveYet",!1),y(this,"_numberOfJoinCount",0),y(this,"_remoteDefaultVideoStreamType",void 0),y(this,"_inspect",void 0),y(this,"_moderation",void 0),y(this,"_license",void 0),y(this,"_pendingPublishedUsers",[]),y(this,"ntpAlignErrorCount",0),y(this,"remoteInboundOffset",0),y(this,"_handleLocalTrackEnable",(i,r,n)=>{this.publish(i,!1).then(r).catch(n)}),y(this,"_handleLocalTrackDisable",(i,r,n)=>{this.unpublish(i).then(r).catch(n)}),y(this,"_handleUserOnline",i=>{if(N("BLOCK_LOCAL_CLIENT")&&sc(i.uid,this.channelName))return void S.debug("[".concat(i.uid,"] will be ignored in local"));this.isStringUID&&typeof i.uid!="string"&&S.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));let r=this._users.find(n=>n.uid===i.uid);if(r)r._trust_in_room_=!0,r._is_pre_created&&(r._is_pre_created=!1,this.safeEmit(We.USER_JOINED,r));else{let n=new ha(i.uid,i.uint_id||i.uid);this._users.push(n),S.debug("[".concat(this._clientId,"] user online"),i.uid),this.safeEmit(We.USER_JOINED,n)}}),y(this,"_handleUserOffline",i=>{if(N("BLOCK_LOCAL_CLIENT")&&sc(i.uid,this.channelName))return;let r=this._users.find(n=>n.uid===i.uid);r&&(this._handleRemoveStream(i),this._handleRemoveDataChannels(i),r._audio_pre_subscribed||r._video_pre_subscribed?r._is_pre_created=!0:um(this._users,r),this._remoteStreamTypeCacheMap.delete(r.uid),this._streamFallbackTypeCacheMap.delete(r.uid),S.debug("[".concat(this._clientId,"] user offline"),i.uid,"reason:",i.reason),this.safeEmit(We.USER_LEAVED,r,i.reason))}),y(this,"_handleAddAudioOrVideoStream",(i,r,n,o,a,l,d)=>{if(N("BLOCK_LOCAL_CLIENT")&&sc(r,this.channelName))return;let u=this._users.find(m=>m.uid===r);if(!u)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));S.debug("[".concat(this._clientId,"] stream added with uid ").concat(r,", type ").concat(i)),this.store.subscribe(u.uid,i,void 0,void 0,void 0,Date.now());let p=i==="audio"?u.hasAudio:u.hasVideo;u._uintid||(u._uintid=a||r),i==="audio"?u._trust_audio_stream_added_state_=!0:u._trust_video_stream_added_state_=!0,i==="audio"?(u._audio_added_=!0,n!==void 0&&(u._audioSSRC=n),o!==void 0&&(u._cname=o),l&&(u._audioOrtc=l)):(u._video_added_=!0,n!==void 0&&(u._videoSSRC=n),o!==void 0&&(u._cname=o),d!==void 0&&(u._rtxSsrcId=d),l&&(u._videoOrtc=l)),(i==="audio"?u.hasAudio:u.hasVideo)&&!p&&(S.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published ").concat(i)),this.safeEmit(We.USER_PUBLISHED,u,i)),i==="video"?_e.onGatewayStream(this._sessionId,vi.ON_ADD_VIDEO_STREAM,kt.ON_ADD_VIDEO_STREAM,{peer:a||r,ssrc:u._videoSSRC}):_e.onGatewayStream(this._sessionId,vi.ON_ADD_AUDIO_STREAM,kt.ON_ADD_AUDIO_STREAM,{peer:a||r,ssrc:u._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(u,i,n).then(m=>{if(m&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(u.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof R_))return this._p2pChannel.unsubscribe(u,i,!0).then(()=>this._subscribe(u,i,!0).catch(f=>{S.error("[".concat(this._clientId,"] resubscribe error"),f.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(u,i)&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(u.uid," after reconnect.")),this._subscribe(u,i,!0).catch(m=>{S.error("[".concat(this._clientId,"] resubscribe error"),m.toString())}))}),y(this,"_handleRemoveStream",i=>{if(N("BLOCK_LOCAL_CLIENT")&&sc(i.uid,this.channelName))return;let r=this._users.find(o=>o.uid===i.uid);if(!r)return void S.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));S.debug("[".concat(this._clientId,"] stream removed with uid ").concat(i.uid));let n=()=>{};r.hasAudio&&r.hasVideo?n=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(r.uid," unpublished audio track")),this.safeEmit(We.USER_UNPUBLISHED,r,"audio"),S.info("[".concat(this._clientId,"] remote user ").concat(r.uid," unpublished video track")),this.safeEmit(We.USER_UNPUBLISHED,r,"video")}:r.hasVideo?n=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(r.uid," unpublished video track")),this.safeEmit(We.USER_UNPUBLISHED,r,"video")}:r.hasAudio&&(n=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(r.uid," unpublished audio track")),this.safeEmit(We.USER_UNPUBLISHED,r,"audio")}),r._video_pre_subscribed||r._audio_pre_subscribed||(r._trust_audio_stream_added_state_=!0,r._trust_video_stream_added_state_=!0,r._audio_added_=!1,r._video_added_=!1,this._p2pChannel instanceof R_&&this._p2pChannel.unsubscribe(r).then(o=>{if(o)return this._gateway.unsubscribe(o,r.uid)}),r._audioSSRC=void 0,r._videoSSRC=void 0,r._audioOrtc=void 0,r._videoOrtc=void 0,r._rtxSsrcId=void 0),_e.onGatewayStream(this._sessionId,vi.ON_REMOVE_STREAM,kt.ON_REMOVE_STREAM,{peer:i.uint_id||i.uid}),n()}),y(this,"_handleSetStreamLocalEnable",(i,r,n)=>{if(N("BLOCK_LOCAL_CLIENT")&&sc(r,this.channelName))return;let o=this._users.find(d=>d.uid===r);if(!o)return void S.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));S.debug("[".concat(this._clientId,"] local ").concat(i," ").concat(n?"enabled":"disabled"," with uid ").concat(r));let a=i==="audio"?o.hasAudio:o.hasVideo;if(i==="audio"){o._trust_audio_enabled_state_=!0;let d=o._audio_enabled_;if(o._audio_enabled_=n,o._audio_enabled_===d)return;{let u=o._audio_enabled_?"enable-local-audio":"disable-local-audio";S.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(We.USER_INFO_UPDATED,r,u)}}else{o._trust_video_enabled_state_=!0;let d=o._video_enabled_;if(o._video_enabled_=n,o._video_enabled_===d)return;{let u=o._video_enabled_?"enable-local-video":"disable-local-video";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(We.USER_INFO_UPDATED,r,u)}}let l=i==="audio"?o.hasAudio:o.hasVideo;return a!==l?!a&&l?(S.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(i)),void this.safeEmit(We.USER_PUBLISHED,o,i)):(i==="video"&&o._videoTrack&&o._videoTrack._destroy(),i==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,i),S.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(i)),void this.safeEmit(We.USER_UNPUBLISHED,o,i)):void 0}),y(this,"_handleMuteStream",(i,r,n)=>{if(N("BLOCK_LOCAL_CLIENT")&&sc(i,this.channelName))return;S.debug("[".concat(this._clientId,"] receive mute message"),i,r,n);let o=this._users.find(d=>d.uid===i);if(!o)return void S.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(i));let a=r==="audio"?o.hasAudio:o.hasVideo;if(r==="audio"){o._trust_audio_mute_state_=!0;let d=o._audio_muted_;if(o._audio_muted_=n,o._audio_muted_===d)return;{let u=o._audio_muted_?"mute-audio":"unmute-audio";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(u)),this.safeEmit(We.USER_INFO_UPDATED,i,u)}}else{o._trust_video_mute_state_=!0;let d=o._video_muted_;if(o._video_muted_=n,o._video_muted_===d)return;{let u=o._video_muted_?"mute-video":"unmute-video";S.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(u)),this.safeEmit(We.USER_INFO_UPDATED,i,u)}}let l=r==="audio"?o.hasAudio:o.hasVideo;if(a!==l){if(!a&&l)return(r==="audio"?o._audioSSRC:o._videoSSRC)?(S.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(r)),void this.safeEmit(We.USER_PUBLISHED,o,r)):void S.warning("[".concat(this._clientId,"] remote user ").concat(i," receive ").concat(r," unmute message  before add stream message, ").concat(r," SSRC doesn't exist yet."));r==="video"&&o._videoTrack&&!o._video_pre_subscribed&&o._videoTrack._destroy(),r==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,r),S.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(r)),this.safeEmit(We.USER_UNPUBLISHED,o,r)}}),y(this,"_handleP2PLost",async i=>{S.debug("[".concat(this._clientId,"] receive p2p lost"),i),parseInt(i.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():S.warning("[".concat(this._clientId,"] P2PLost stream not found"),i)}),y(this,"_handleTokenWillExpire",()=>{S.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(We.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),y(this,"_handleBeforeUnload",i=>{i.type==="beforeunload"&&i.returnValue!==void 0&&i.returnValue!==""||(this.leave(),S.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),y(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(We.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});let i={downlinkNetworkQuality:0,uplinkNetworkQuality:0};i.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),i.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(We.NETWORK_QUALITY,i)}),y(this,"_handleP2PAddAudioOrVideoStream",(i,r,n,o)=>{let a=this._users.find(d=>d.uid===r);if(!a)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));S.debug("[".concat(this._clientId,"] stream added with uid ").concat(r,", type ").concat(i)),this.store.subscribe(a.uid,i,void 0,void 0,void 0,Date.now());let l=i==="audio"?a.hasAudio:a.hasVideo;i==="audio"?a._trust_audio_stream_added_state_=!0:a._trust_video_stream_added_state_=!0,i==="audio"?(a._audio_added_=!0,n!==void 0&&(a._audioSSRC=n),o!==void 0&&(a._audioMid=o)):(a._video_added_=!0,n!==void 0&&(a._videoSSRC=n),o!==void 0&&(a._videoMid=o)),(i==="audio"?a.hasAudio:a.hasVideo)&&!l&&(S.info("[".concat(this._clientId,"] remote user ").concat(a.uid," published ").concat(i)),this.safeEmit(We.USER_PUBLISHED,a,i)),this._p2pChannel.hasPendingRemoteMedia(a,i)&&(S.debug("[".concat(this._clientId,"] resubscribe ").concat(i," for user ").concat(a.uid," after reconnect.")),this._subscribe(a,i,!0).catch(d=>{S.error("[".concat(this._clientId,"] resubscribe error"),d.toString())}))}),this._config=e,this._clientId=ft(5,"client-"),this.store=new R8(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),S.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(mn," build: ").concat(BS,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{Db(e.clientRoleOptions),t=Object.assign({},e.clientRoleOptions)}catch(i){S.warning("[".concat(this._clientId,"] ").concat(i.toString()))}this._statsCollector=new rh(this.store),this._statsCollector.onStatsException=(i,r,n)=>{S.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(i,", msg: ").concat(r,", uid: ").concat(n)),this.safeEmit(We.EXCEPTION,{code:i,msg:r,uid:n})},this._statsCollector.onUploadPublishDuration=(i,r,n,o)=>{let a=this._users.find(l=>l.uid===i);a&&_e.peerPublishStatus(this._sessionId,{subscribeElapse:o,audioPublishDuration:r,videoPublishDuration:n,peer:a._uintid})},this.store.useDataChannel=Ye().supportDataChannel&&N("SIGNAL_CHANNEL"),this.store.useP2P=e.mode==="p2p",this._gateway=new Pz(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||Jt,httpRetryConfig:e.httpRetryConfig||Jt,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:t}),this._configDistribute=new Gz,this.store.useP2P?(this._p2pChannel=new Fr(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new R_(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,i,r,n){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],a=arguments.length>6&&arguments[6]!==void 0&&arguments[6];ht("JOIN_GATEWAY_USE_443PORT_ONLY",o),ht("JOIN_GATEWAY_USE_DUAL_DOMAIN",a);let l=this._gateway.signal.websocket;return l instanceof Cu&&(l.use443PortOnly=o,l.tryDoubleDomain=a),async function(d,u,p){sm.get(d)||sm.set(d,[]),am.get(d)||am.set(d,u),jo.get(d)||jo.set(d,0);let m=sm.get(d),f=am.get(d);if(!m||!f)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(jo.get(d)===f){let w=_u();m.push(w),await w.promise}jo.set(d,jo.get(d)+1);for(var E=arguments.length,I=new Array(E>3?E-3:0),T=3;T<E;T++)I[T-3]=arguments[T];let R=await p(...I);return jo.set(d,jo.get(d)-1),jo.get(d)===f-1&&m.length>0&&(m[0].resolve(),m.shift()),jo.get(d)===0&&(sm.set(d,[]),am.set(d,0),jo.set(d,0)),R}("client.join",N("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,i,r,n)}async join(e,t,i,r,n){let o=++this._numberOfJoinCount;this.store.joinStart(),r&&(this.store.uid=r);let a=(fm||fm||(fm=(window.location.protocol.split(":")[0]||"").toUpperCase(),fm))==="HTTPS",l=Bb()?window.isSecureContext:"Browser Not Support";(!Bb()&&!a||!window.isSecureContext)&&S.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser"),this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),S.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),_e.setAppId(e);try{if(!i&&i!==null)throw new U(A.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Ai(i,"token",1,2047),Ai(e,"appid",1,2047),Tm(t),r&&vm(r),n&&Ai(n,"optionalInfo",1,2047)}catch(T){throw _e.reportApiInvoke(Su(),{name:ei.JOIN,options:[e,t,i,r],states:{isHttps:a,isSecureContext:l},tag:xt.TRACER}).onError(T),T}let d=await V1({appId:e,cname:t,uid:r,stringUid:typeof r=="string"?r:void 0,token:i||e,cloudProxyServer:this._cloudProxyServerMode}),u=(d==null?void 0:d.sid)||Su(),p=_e.reportApiInvoke(u,{name:ei.JOIN,options:[e,t,i,r],states:{isHttps:a,isSecureContext:l},tag:xt.TRACER});if(S.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(o)),this._leaveMutex.isLocked&&(S.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),S.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){let T=new U(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw p.onError(T),T}this._sessionId||(this._sessionId=u,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";let m=Rn(Rn({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:typeof r!="string"?r:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:n,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!d},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(m.setLocalAPVersion=this._setLocalAPVersion),typeof r=="string"&&(m.stringUid=r,this._uintUid?(m.uid=this._uintUid,this._uintUid=void 0):m.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(m.aesmode=this._encryptionMode,m.aespassword=await(async T=>{let R=function(M){let V=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),F=new Uint8Array(new ArrayBuffer(V.length));for(let Y=0;Y<V.length;Y+=1)F[Y]=V.charCodeAt(Y);return F}(),w=await window.crypto.subtle.importKey("spki",R,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),O=PS(T),P=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},w,O);return function(M){let V="";for(let F=0;F<M.length;F+=1)V+=String.fromCharCode(M[F]);return window.btoa(V)}(new Uint8Array(P))})(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new U(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(m.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){let T=new TextEncoder,R=N("USE_PURE_ENCRYPTION_MASTER_KEY")?T.encode(m.appId+this._encryptionSecret+this._encryptionSecret):T.encode(m.appId+m.cname+this._encryptionSecret);this._encryptDataStreamIv=await async function(w,O,P){let M=await window.crypto.subtle.importKey("raw",O,"PBKDF2",!1,["deriveBits","deriveKey"]),V=w==="aes-128-gcm2"?128:256,F=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:Wb,hash:"SHA-256",salt:P},M,V+C8);return new Uint8Array(F).subarray(V/8)}(this._encryptionMode,R,nc(this._encryptionSalt)),this._encryptDataStreamKey=await async function(w,O,P){let M=await window.crypto.subtle.importKey("raw",O,"PBKDF2",!1,["deriveBits","deriveKey"]),V=w==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:Wb,hash:"SHA-256",salt:P},M,{name:"AES-GCM",length:V},!0,["encrypt","decrypt"])}(this._encryptionMode,R,nc(this._encryptionSalt))}else l?S.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):S.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,S.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:m.stringUid,preload:m.preload});let f=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&f===this._sessionId&&_e.joinChannelTimeout(this._sessionId,5)},5e3);try{var E;let T,R=m.cloudProxyServer;if(se(E=["proxy3","proxy4","proxy5"]).call(E,R)){let V=N("PROXY_SERVER_TYPE3");Array.isArray(V)?m.proxyServer=V[0]:m.proxyServer=V}if(_e.setProxyServer(m.proxyServer),S.setProxyServer(m.proxyServer),this.store.requestAPStart(),d){if(S.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(m.stringUid?", ".concat(m.stringUid," => ").concat(d.intUid):""," ")),m.stringUid&&!m.uid&&(m.uid=d.intUid),T={gatewayInfo:d.ap.gatewayInfo},N("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&m.turnServer.mode==="auto")if(d.ap.proxyInfo.addresses.length===0)S.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{let V=(await _N(d.ap.proxyInfo,d.ap.gatewayInfo.uid)).map(F=>({turnServerURL:F.address,tcpport:F.tcpport||Li.tcpport,udpport:F.udpport||Li.udpport,username:F.username||Li.username,password:F.password||Li.password,forceturn:!1,security:!0}));m.turnServer={mode:"manual",servers:V}}B1(d,m.stringUid)}else{if(m.stringUid&&!m.uid){let V;[V,T]=await ne.all([ON(m.stringUid,m,this._axiosCancelSource.token,this._config.httpRetryConfig||Jt,this.store),AN(m,this._axiosCancelSource.token,this._config.httpRetryConfig||Jt,!0,this.store)]),S.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(m.stringUid," => ").concat(V)),m.uid=V,T.gatewayInfo.uid=V,T.gatewayInfo.res.uid=V}else T=await AN(m,this._axiosCancelSource.token,this._config.httpRetryConfig||Jt,!0,this.store);if(!this._joinAndNotLeaveYet)throw new U(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(m,this._axiosCancelSource.token),this._configDistribute.on(QS.UPDATE_BITRATE_LIMIT,V=>{this._p2pChannel.updateBitrateLimit(V)})},0),this._key=i||e;let w=T.gatewayInfo,O=m.uid?m.uid:w.uid;this._joinInfo=Rn(Rn({},m),{},{cid:w.cid,uid:O,vid:w.vid,apResponse:w.res,uni_lbs_ip:w.uni_lbs_ip,gatewayAddrs:w.gatewayAddrs}),this.store.intUid=O;let P=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new U(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));p.onSuccess(P),this._appId=e,this._channelName=m.cname,this._uid=P,this.store.uid=P,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(pi()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);let M=m.stringUid?"string uid: ".concat(m.stringUid,",uid: ").concat(m.uid):"uid: ".concat(this._uid);return S.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(M)),setTimeout(()=>{S.startUpload()},5e3),this.store.joinEnd(),I=this,se(Zs).call(Zs,I)||Zs.push(I),this._cloudProxyServerMode==="disabled"&&Ye().supportWebCrypto&&N("ENABLE_PRELOAD")&&Gv(this._joinInfo),P}catch(T){let R=Array.isArray(T)?T[0]:T;throw R&&R.code===A.OPERATION_ABORTED?S.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),R):S.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),R),R.code!==A.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),p.onError(R),R}var I}_joinGateway(){if(!this._joinInfo||!this._key)throw new U(A.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!N("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(e=>e).catch(e=>{if(e.code===A.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,Ge.FALLBACK),e;if(e.code===A.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,Ge.FALLBACK),e;throw e}).then(e=>{if(e instanceof U){if(e.code===A.INIT_WEBSOCKET_TIMEOUT){if(S.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new U(A.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";let t=N("PROXY_SERVER_TYPE3");if(Array.isArray(t))if(this._joinInfo.apUrl){let r=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),n=r.slice(r.length-2).join(".");t.forEach(o=>{this._joinInfo&&se(o).call(o,n)&&(this._joinInfo.proxyServer=o)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=t[0])}else this._joinInfo.proxyServer=t[0];else this._joinInfo.proxyServer=t;let i=N("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return i&&i[1]&&i[1]!=="443"&&S.setProxyServer(this._joinInfo.proxyServer),N("STATS_COLLECTOR_PORT").toString()!=="443"&&_e.setProxyServer(this._joinInfo.proxyServer),_e.reportApiInvoke(this._sessionId,{name:ei.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:xt.TRACER}).onSuccess(),this.safeEmit(We.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),N("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(r=>{"forceturn"in r&&(r.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(S.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new U(A.INVALID_OPERATION);return _e.reportApiInvoke(this._sessionId,{name:ei.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:xt.TRACER}).onSuccess(),this._joinGateway()}return e}).then(e=>e)}async leave(){S.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(pi()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(t){let i=Zs.indexOf(t);i!==-1&&Zs.splice(i,1)}(this),this._statsCollector.stopUpdateStats();let e=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return S.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave(this.connectionState!=="CONNECTED"),S.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof Xl))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new U(A.INVALID_PARAMS,"param list is empty");let i=e;if(this._gateway.role==="audience")throw new U(A.INVALID_OPERATION,"audience can not publish stream");for(let n of i){if(!(n instanceof Xl))throw new U(A.INVALID_PARAMS,"parameter is not local track");if(!n._enabled&&t)throw new U(A.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(n.getTrackId()))}S.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(i.map(n=>"".concat(n.getTrackId()," "))));let r=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&i.forEach(n=>{let o=this._configDistribute.getBitrateLimit();n instanceof Et&&o&&n.setBitrateLimit(o.uplink)});try{await this._publishHighStream(i),S.info("[".concat(this._clientId,"] Publish success, id ").concat(i.map(n=>"".concat(n.getTrackId()," "))))}catch(n){throw S.error("[".concat(this._clientId,"] publish error"),n.toString()),n}finally{r()}}async _publishDataChannel(e){ut(e.id,"id",0,65535,!0),us(e.ordered,"ordered"),Ai(e.metadata,"metadata",0,512),S.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));let t=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(r=>r.id===e.id)!==-1)throw new U(A.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new U(A.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&N("FORCE_TURN")&&!N("TURN_ENABLE_TCP")&&!N("TURN_ENABLE_UDP"))throw new U(A.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");let i=new tL(e);if(await this._p2pChannel.publishDataChannel([i]),!this._p2pChannel.isP2PDisconnected()){if(typeof i._originDataChannelId!="number")throw S.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new U(A.CREATE_DATACHANNEL_ERROR);try{let r={streamId:e.id,ordered:e.ordered,maxRetransmits:N("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:i._originDataChannelId};await this._gateway.publishDataChannel(this._uid,r,!0),await i._waitTillOpen()}catch(r){if(r.code!==A.DISCONNECT_P2P)throw r}}return S.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(i){throw S.error("[".concat(this._clientId,"] publish datachannels error"),i.toString()),i}finally{t()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new U(A.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof Xl))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);S.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map(r=>"".concat(r.getTrackId()," "))," "));let i=await this._publishMutex.lock();try{if(this._p2pChannel instanceof Fr){let r=await this._p2pChannel.unpublish(t);r&&await this._gateway.sendExtensionMessage(Ht.UNPUBLISH,{unpubMsg:r},!0)}else{let r=await this._p2pChannel.unpublish(t);r&&await this._gateway.unpublish(r,this._uid),S.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map(n=>"".concat(n.getTrackId()))))}}catch(r){throw S.error("[".concat(this._clientId,"] unpublish error"),r.toString()),r}finally{i&&i()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),S.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map(i=>"".concat(i.id," "))," "));let t=await this._publishMutex.lock();try{let i=await this._p2pChannel.unpublishDataChannel(e);i&&await this._gateway.unpublishDataChannel(i),S.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map(r=>"".concat(r.id))))}catch(i){throw S.error("[".concat(this._clientId,"] unpublish dataChannel error"),i.toString()),i}finally{t&&t()}}async subscribe(e,t,i){if(!(e instanceof ha)){let r=this.remoteUsers.find(n=>n.uid===e);if(!r)throw new U(A.INVALID_REMOTE_USER,"user is not in the channel");e=r}return t==="datachannel"?this._subscribeDataChannel(e,i):this._subscribe(e,t)}async presubscribe(e,t){if(ci(t,"mediaType",["audio","video"]),this._p2pChannel instanceof Fr)throw new U(A.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new U(A.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));let i=t===me.AUDIO,r=t===me.VIDEO,n=await this._subscribeMutex.lock();try{let{ssrcId:o,ortc:a,rtxSsrcId:l,cname:d,uint_id:u}=await this._gateway.presubscribe(e,t,!0);if(o==null)throw new U(A.UNEXPECTED_RESPONSE,"no ssrc id");let p=this._users.find(f=>f.uid===e);p||(p=new ha(e,u||e),p._is_pre_created=!0,this._users.push(p)),d&&(p._cname=d),p._uintid||(p._uintid=u||e),i&&(p._audioSSRC=o,p._audio_pre_subscribed=!0,a&&(p._audioOrtc=a)),r&&(p._videoSSRC=o,p._video_pre_subscribed=!0,a&&(p._videoOrtc=a),l!=null&&(p._rtxSsrcId=l)),S.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(p,t,o,l,a);let m=i?p._audioTrack:p._videoTrack;if(!m)throw new U(A.UNEXPECTED_ERROR,"can not find remote track in user");return i&&(p._trust_audio_stream_added_state_=!0,p._audio_added_=!0),r&&(p._trust_video_stream_added_state_=!0,p._video_added_=!0),m}catch(o){throw S.error("[".concat(this._clientId,"] presub user ").concat(e," error"),o),o}finally{n()}}async _subscribeDataChannel(e,t){var i;if(ut(t,"channelId",0,65535,!0),!this._joinInfo)throw new U(A.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(a=>a===e))throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new U(A.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new U(A.INVALID_REMOTE_USER,"user is not published");let r=(i=e._dataChannels)===null||i===void 0?void 0:i.find(a=>a.id===t);if(!r)throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new U(A.REMOTE_USER_IS_NOT_PUBLISHED);let n=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{let a=await this._p2pChannel.subscribeDataChannel(e,[r]);if(a&&se(a).call(a,r.id))try{var o;if(typeof r._originDataChannelId!="number")throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new U(A.CREATE_DATACHANNEL_ERROR);let l={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(o=r.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(e.uid,l,!0),await r._waitTillOpen()}catch(l){if((l==null?void 0:l.code)!==A.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[r]),l;await this._p2pChannel.unsubscribeDataChannel(e,[r]),this._p2pChannel.setPendingRemoteDataChannel(e,r.id)}return S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),r}finally{n()}}async _p2pSubscribe(e,t,i){if(ci(t,"mediaType",["audio","video"]),!this._joinInfo)throw new U(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(n=>n===e)){let n=new U(A.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),n}if(!e.hasAudio&&!e.hasVideo){let n=new U(A.INVALID_REMOTE_USER,"user is not published");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),n}if(!i&&(t==="audio"&&!e.hasAudio||t==="video"&&!e.hasVideo)){let n=new U(A.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),n}let r=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{let o=t==="audio"?e._audioSSRC:e._videoSSRC,a=t==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this._p2pChannel instanceof Fr&&await this._p2pChannel.subscribe(e,t,o,a)}catch(o){throw o}S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(o=>{S.warning("[".concat(this._clientId,"] auto set fallback failed"),o)});let n=t==="audio"?e._audioTrack:e._videoTrack;if(!n)throw new U(A.UNEXPECTED_ERROR,"can not find remote track in user object");return n}catch(n){throw S.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),n),n}finally{r()}}async _subscribe(e,t,i){if(this._p2pChannel instanceof Fr)return this._p2pSubscribe(e,t);if(ci(t,"mediaType",["audio","video"]),!this._joinInfo)throw new U(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===e)){let d=new U(A.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),d}if(!e.hasAudio&&!e.hasVideo){let d=new U(A.INVALID_REMOTE_USER,"user is not published");throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),d}if(!(i||(t!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(t!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){let d=new U(A.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),d}let r=t==="audio"?e._audioSSRC:e._videoSSRC,n=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,a={stream_type:t==="audio"?me.AUDIO:me.VIDEO,ssrcId:r},l=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{let u=t==="audio"?e._audioSSRC:e._videoSSRC;u!==void 0&&u!==r&&(r=u,n=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,a={stream_type:t==="audio"?me.AUDIO:me.VIDEO,ssrcId:r}),Gi.markSubscribeStart(this.store.clientId,r),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,r,o,n);try{await this._gateway.subscribe(e.uid,a,!0)}catch(p){if((p==null?void 0:p.code)!==A.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),p;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(u){throw this._p2pChannel.reportSubscribeEvent(!1,u==null?void 0:u.code,e,t),u}S.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(u=>{S.warning("[".concat(this._clientId,"] auto set fallback failed"),u)});let d=t==="audio"?e._audioTrack:e._videoTrack;if(!d)throw new U(A.UNEXPECTED_ERROR,"can not find remote track in user object");return d}catch(d){throw S.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),d),d}finally{l()}}async massSubscribe(e){if(hs(e,"subscribeList"),!this._joinInfo)throw new U(A.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let t=Date.now(),i=new Map,r=await this._subscribeMutex.lock();S.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map(l=>{let{user:d,mediaType:u}=l;return"user: ".concat(d==null?void 0:d.uid,", mediaType: ").concat(u)}).join("; ")));let n=(e=[...e]).map(l=>{let{user:d,mediaType:u}=l;return{user:d,mediaType:u}}),o=await this._p2pChannel.globalLock();try{var a;for(let d=e.length-1;d>=0;d--){let u=e[d],{user:p,mediaType:m}=u;if(ci(m,"mediaType",["audio","video"]),!p){let I=new U(A.INVALID_PARAMS,"user property does not exist in subscribeList item");throw S.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),I}if(!this._users.find(I=>I===p)){let I=new U(A.INVALID_REMOTE_USER,"user is not in the channel");S.error("[".concat(this._clientId,"] can not massSubscribe ").concat(p.uid,", this user is not in the channel")),n[d].error=I,e.splice(d,1);continue}if(m==="audio"&&(!p.hasAudio||p._audioSSRC===void 0)||m==="video"&&(!p.hasVideo||p._videoSSRC===void 0)){let I=new U(A.REMOTE_USER_IS_NOT_PUBLISHED);S.error("[".concat(this._clientId,"] can not subscribe ").concat(p.uid," with mediaType ").concat(m,", remote user is not published")),n[d].error=I,e.splice(d,1);continue}let f=_i.Video|_i.LwoVideo,E=i.get(p);if(E){if(m==="video"?E&f:E&_i.Audio){e.splice(d,1),S.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(p.uid,", mediaType:").concat(m," twice"));continue}i.set(p,E|(m==="video"?f:_i.Audio))}else i.set(p,m==="video"?f:_i.Audio)}for(let d=e.length-1;d>=0;d--){let u=e[d],{user:p,mediaType:m}=u,f=_i.Video|_i.LwoVideo;if(this._p2pChannel.hasRemoteMedia(p,m)){await this._p2pChannel.unmuteRemoteNoLock(p,m);let E=i.get(p);i.set(p,m==="video"?E^f:E^_i.Audio),e.splice(d,1)}}this.store.massSubscribe(e.map(d=>({userId:d.user.uid,type:d.mediaType})),t);let l=ao(a=Array.from(i.entries())).call(a,(d,u)=>{let[p,m]=u;if(m===0)return d;let f={stream_id:p.uid,stream_type:m};return m&_i.Audio&&(f.audio_ssrc=p._audioSSRC),m&_i.Video&&(f.video_ssrc=p._videoSSRC),d.push(f),d},[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map(u=>{let{user:p,mediaType:m}=u;return{user:p,mediaType:m,ssrcId:m===me.VIDEO?p._videoSSRC:p._audioSSRC,rtxSsrcId:m===me.VIDEO?p._rtxSsrcId:void 0}}));let d=new Map;if(l.length>0){let u=await this._gateway.subscribeAll(l,!0);((u==null?void 0:u.users)||[]).forEach(p=>{let{stream_id:m,video_error_code:f,audio_error_code:E,error_code:I}=p;(f||E||I)&&d.set(m,{video_error_code:f,audio_error_code:E,error_code:I})})}if(Array.from(d.entries()).length>0){let u=[];Array.from(d.entries()).forEach(p=>{let[m,f]=p,E=this.remoteUsers.find(I=>I.uid===m);if(E){let I;f.error_code||f.video_error_code&&f.audio_error_code?I=void 0:f.video_error_code?I=me.VIDEO:f.audio_error_code&&(I=me.AUDIO),u.push({user:E,mediaType:I})}}),u.length>0&&await this._p2pChannel.massUnsubscribeNoLock(u)}for(let u of n){let p=d.get(u.user.uid);if(p){let m=p.error_code||u.mediaType==="audio"&&p.audio_error_code||u.mediaType==="video"&&p.video_error_code;if(m){let f=cc(m);S.error("user:".concat(u.user.uid," mediaType:").concat(u.mediaType," has massSubscribe error ").concat(f.desc)),u.error=new U(A.SUBSCRIBE_FAILED,"code ".concat(m,": ").concat(f.desc))}}u.error||(u.mediaType==="video"?u.track=u.user.videoTrack:u.track=u.user.audioTrack)}return this.store.massSubscribe(n.filter(u=>!u.error).map(u=>({userId:u.user.uid,type:u.mediaType})),void 0,Date.now()),n.forEach(u=>{var p;_e.subscribe(this.store.sessionId,{succ:!!u.error,ec:((p=u.error)===null||p===void 0?void 0:p.code)||null,video:u.mediaType===me.VIDEO,audio:u.mediaType===me.AUDIO,peerid:u.user.uid,subscribeRequestid:u.mediaType===me.VIDEO?u.user._videoSSRC:u.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t)},!0)}),S.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map(u=>{let{user:p,mediaType:m}=u;return"user: ".concat(p==null?void 0:p.uid,", mediaType: ").concat(m)}).join("; "))),n}catch(d){throw await this._p2pChannel.massUnsubscribeNoLock(e),d}}finally{o(),r()}}async unsubscribe(e,t,i){if(!(e instanceof ha)){let n=this.remoteUsers.find(o=>o.uid===e);if(!n)throw new U(A.INVALID_REMOTE_USER,"user is not in the channel");e=n}if(t||this.store.useP2P){if(t==="datachannel")return this._unsubscribeDataChannel(e,i)}else await this._unsubscribeDataChannel(e,i);if(t&&ci(t,"mediaType",["audio","video"]),!this._joinInfo)throw new U(A.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(n=>n===e)){let n=new U(A.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),n}S.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));let r=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof Fr)await this._p2pChannel.unsubscribe(e,t);else{let n=await this._p2pChannel.unsubscribe(e,t);n&&await this._gateway.unsubscribe(n,e.uid),t&&t!=="audio"||(e._audio_pre_subscribed=!1),t&&t!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&um(this._users,e),S.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(n){if(n.code===A.DISCONNECT_P2P)return void S.warning("disconnecting p2p, abort unsubscribe request.");throw S.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),n.toString()),n}finally{r()}}async _unsubscribeDataChannel(e,t){if(t&&ut(t,"id",0,65535,!0),!this._joinInfo)throw new U(A.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(r=>r===e)){let r=new U(A.INVALID_REMOTE_USER,"user is not in the channel");throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),r}let i;if(typeof t=="number"){let r=e._dataChannels.find(n=>n.id===t);r&&(i=[r])}else i=e._dataChannels;if(i===void 0){let r=new U(A.REMOTE_USER_IS_NOT_PUBLISHED);throw S.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),r}S.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i.map(r=>r.id)));try{let r=await this._p2pChannel.unsubscribeDataChannel(e,i);r&&await this._gateway.unsubscribeDataChannel(r,e.uid),S.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===A.DISCONNECT_P2P)return void S.warning("disconnecting p2p, abort unsubscribe request.");throw S.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),r.toString()),r}}async massUnsubscribe(e){if(hs(e,"unsubscribeList"),!this._joinInfo)throw new U(A.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");S.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map(i=>{let{user:r,mediaType:n}=i;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(n,";")}).join())),e=[...e];let t=new Map;for(let i=e.length-1;i>=0;i--){let{user:r,mediaType:n}=e[i];if(!r){let a=new U(A.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw S.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(ci(n,"mediaType",["video","audio",void 0]),!this._users.find(a=>a===r)){S.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(r.uid,", user is not in the channel")),e.splice(i,1);continue}let o=_i.Video|_i.LwoVideo;if(t.has(r)){let a=t.get(r),l;switch(n){case"video":l=a&o;break;case"audio":l=a&_i.Audio;break;default:l=a&(_i.Audio|o)}if(l){S.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(r.uid,",mediaType:").concat(n," twice.")),e.splice(i,1);continue}n?n==="audio"?t.set(r,a|_i.Audio):n==="video"&&t.set(r,a|o):t.set(r,a|_i.Audio|o)}else n?n==="audio"?t.set(r,_i.Audio):n==="video"&&t.set(r,o):t.set(r,_i.Audio|o)}try{let i=await this._p2pChannel.massUnsubscribe(e);i&&await this._gateway.massUnsubscribe(i),S.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map(r=>{let{user:n,mediaType:o}=r;return"user: ".concat(n==null?void 0:n.uid,", mediaType: ").concat(o,";")}).join()))}catch(i){if(i.code===A.DISCONNECT_P2P)return void S.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw S.error("[".concat(this._clientId,"] massUnsubscribe error"),i.toString()),i}}async setLowStreamParameter(e){(function(i){if(!i)throw new j(A.INVALID_PARAMS);Ut(i.width)||NS(i.width,"streamParameter.width"),Ut(i.height)||NS(i.height,"streamParameter.height"),Ut(i.framerate)||NS(i.framerate,"streamParameter.framerate"),Ut(i.bitrate)||ut(i.bitrate,"streamParameter.bitrate")})(e),(!e.width&&e.height||e.width&&!e.height)&&S.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),S.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));let t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,Q.LocalVideoLowTrack)}async enableDualStream(){if(!Ye().supportDualStream)throw _e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new U(A.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new U(A.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw _e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,_e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),S.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new U(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(Q.LocalVideoLowTrack))try{let e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw _e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,_e.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),S.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(function(i){ci(i,"role",["audience","host"])}(e),t&&Db(t),this.mode==="rtc"||this.mode==="p2p")throw S.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new U(A.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&e==="host")throw new U(A.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new U(A.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,t),this._config.role=e,S.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level))}getRemoteInboundOffset(){var e;let t=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;let i=t.timestamp-Date.now();return Math.abs(i)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(Ai(e,"proxyServer"),!t){if(this.connectionState!=="DISCONNECTED")throw new U(A.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new U(A.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,_e.setProxyServer(this._proxyServer),S.setProxyServer(this._proxyServer),S.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if(this.connectionState!=="DISCONNECTED")throw new U(A.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new U(A.INVALID_OPERATION,"You have already set the proxy")}if(Rl(e))return this._turnServer={servers:e,mode:"original-manual"},void S.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map(i=>i.urls).join(","),"."));e.forEach(i=>Nb(i)),this._turnServer={servers:e,mode:"manual"},S.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new U(A.INVALID_OPERATION,"you should set license before join channel");if(Ai(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new U(A.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,S.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new U(A.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new U(A.INVALID_OPERATION,"You have already set the proxy");let t=[3,4,5],i;switch(e===void 0&&(e=3),e){case 1:case 2:throw new U(A.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new U(A.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,S.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new U(A.INVALID_OPERATION,"Stop proxy server after leave channel");_e.setProxyServer(),S.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",S.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new U(A.INVALID_PARAMS,"accessPoints is required.");hs(e.accessPoints.serverList,"accessPoints.serverList"),Ai(e.accessPoints.domain,"accessPoints.domain");let t=(f,E)=>{ut(f,E,0,65535,!0)},i=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),i=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new U(A.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");N("CLOSE_AFB_FOR_LOCAL_AP")&&(ht("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),ht("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));let r=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,n=e.accessPoints.domain,o=e.accessPoints.serverList.map(f=>r.test(f)?"".concat(f.replace(/\./g,"-"),".").concat(n):f),a=o.map(f=>"".concat(f,":").concat(i));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,ht("WEBCS_DOMAIN",a),ht("WEBCS_DOMAIN_BACKUP_LIST",a),ht("GATEWAY_DOMAINS",[n]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(hs(e.report.hostname,"report.hostname"),ht("EVENT_REPORT_DOMAIN",e.report.hostname[0]),ht("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(ht("EVENT_REPORT_DOMAIN",o[0]),ht("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let l=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),l=e.report.port),ht("STATS_COLLECTOR_PORT",l),e.report?ht("ENABLE_EVENT_REPORT",!0):ht("ENABLE_EVENT_REPORT",!1);let d="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(hs(e.log.hostname,"log.hostname"),d=e.log.hostname[0]):d=o[0];let u=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),u=e.log.port),ht("LOG_UPLOAD_SERVER","".concat(d,":").concat(u));let p=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(hs(e.cds.hostname,"cds.hostname"),p=e.cds.hostname):p=o;let m=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),m=e.cds.port),ht("CDS_AP",p.map(f=>"".concat(f,":").concat(m))),e.cds?ht("ENABLE_CONFIG_DISTRIBUTE",!0):ht("ENABLE_CONFIG_DISTRIBUTE",!1),S.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(hs(e,"serverList"),Ai(t,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new U(A.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");let i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map(r=>i.test(r)?"".concat(r.replace(/\./g,"-"),".").concat(t):r),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,ht("WEBCS_DOMAIN",e),ht("WEBCS_DOMAIN_BACKUP_LIST",e),ht("GATEWAY_DOMAINS",[t]),ht("EVENT_REPORT_DOMAIN",e[0]),ht("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),ht("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),S.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(ci(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw S.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else S.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){ci(t,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout(()=>{let i=this._users.find(r=>r.uid===e);i&&i.videoTrack&&i.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(i){throw S.error("[".concat(this._clientId,"] set remote video stream type error"),i.toString()),i}S.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){ci(t,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(i){throw S.error("[".concat(this._clientId,"] set stream fallback option"),i.toString()),i}S.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,i,r){(function(o){ci(o,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(e),Ai(t,"secret");let n=["aes-128-gcm2","aes-256-gcm2"];if(se(n).call(n,e)){if(!i||!(i instanceof Uint8Array&&i.length===32))throw new U(A.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new U(A.INVALID_PARAMS,"current encrypt mode does not need salt");if(r){if(us(r,"encryptDataStream"),!se(n).call(n,e))throw new U(A.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(t)||S.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=t,i&&(this._encryptionSalt=Xs(i))}async renewToken(e){if(Ai(e,"token",1,2047),!this._key||!this._joinInfo)throw new U(A.INVALID_OPERATION,"renewToken should not be called before user join");let t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);let i=await this._renewTokenMutex.lock();try{if(N("USE_NEW_TOKEN")){S.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));let r=await Bz(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Jt);S.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:r})}else S.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});S.debug("[".concat(this._clientId,"] renewToken success"))}catch(r){throw this._key=t,this._joinInfo.token=t,S.error("[".concat(this._clientId,"] renewToken failed"),r.toString()),r}finally{i()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?S.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{let e=this._p2pChannel.getAudioLevels();this.safeEmit(We.VOLUME_INDICATOR,e)},N("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){let e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if(this.codec!=="h264")throw new U(A.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new U(A.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new U(A.LIVE_STREAMING_TASK_CONFLICT);let i=t?Ri.TRANSCODE:Ri.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(e,i)}setLiveTranscoding(e){return this._createLiveStreamingClient(Ri.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){let t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(i=>i&&i.hasUrl(e));if(!t.length)throw new U(A.INVALID_PARAMS,"can not find live streaming url to stop");await ne.all(t.map(i=>i&&i.stopLiveStreamingTask(e)))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new U(A.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");let i=this._createLiveStreamingClient(Ri.INJECT);i.setInjectStreamConfig(t,0),await i.startLiveStreamingTask(e,Ri.INJECT)}async removeInjectStreamUrl(){var e;let t=this._createLiveStreamingClient(Ri.INJECT),i=Array.from(ho(e=t.streamingTasks).call(e)).find(r=>r.mode===Ri.INJECT);if(!this._joinInfo||!i)throw new U(A.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await t.stopLiveStreamingTask(i.url)}async startChannelMediaRelay(e){zL(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){zL(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(e){var t;let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new U(A.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){let n=new TextEncoder;e.payload=n.encode(e.payload)}let r=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&se(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)&&(r=!0,e.payload=await async function(n,o,a){var l;let d=ao(l=Array.from(a)).call(l,(T,R)=>T+R,0),u={serverTs:0,seq:y8++,length:a.length,checkSum:d},p=new Uint8Array(Fb(d,2)),m=new ArrayBuffer(wl),f=new DataView(m);f.setUint32(0,u.serverTs),f.setUint16(4,u.seq),f.setUint16(6,u.length),f.setUint16(8,u.checkSum);let E=16-a.length%16;a=Lb(a,new Uint8Array(E));let I=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:n,tagLength:Gb,additionalData:p},o,a);return Lb(new Uint8Array(m),new Uint8Array(I))}(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new U(A.INVALID_PARAMS,r?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(Se.DATA_STREAM,{payload:Xs(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-u7},!i)}sendMetadata(e){if(!this._joinInfo)throw new U(A.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new U(A.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(Se.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Xs(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(w8),!this._joinInfo)throw new U(A.INVALID_OPERATION,"can not send custom report, not joined");await _e.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,t){ci(t.spatialLayer,"spatialLayer",[0,1,2,3]),ci(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(i){throw S.error("[".concat(this._clientId,"] pick SVC layer failed"),i.toString()),i}}async setRTMConfig(e){let{apRTM:t=!1,rtmFlag:i}=e;if(us(t,"apRTM"),ut(i,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=i,S.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=i,this._gateway.setRTM2Flag(i)}_reset(){if(S.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=ur.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&j1(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach(t=>t._close()),e._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Ti("client-publish"),this._subscribeMutex=new Ti("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,t){var i;let r=e||Su();e?S.debug("[".concat(this._clientId,"] new Session ").concat(r)):S.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(r));let n=e?"":this._sessionId||"";this._sessionId=r,this.store.sessionId=r;let o={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:(t==null?void 0:t.stringUid)||((i=this._joinInfo)===null||i===void 0?void 0:i.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:n,clientRole:this.role==="audience"?2:1};t?_e.sessionInit(this._sessionId,Rn({cname:t.channel,appid:t.appId,preload:t.preload},o)):this._joinInfo?_e.sessionInit(this._sessionId,Rn({cname:this._joinInfo.cname,appid:this._joinInfo.appId,preload:!!this._joinInfo.recoverPreloadCache},o)):this._gateway.joinInfo&&_e.sessionInit(this._sessionId,Rn({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},o)),this._joinInfo&&(this._joinInfo.sid=r),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=r)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new U(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&N("FORCE_TURN")&&!N("TURN_ENABLE_TCP")&&!N("TURN_ENABLE_UDP"))throw new U(A.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");S.debug("[".concat(this._clientId,"] publish high stream"));try{let i=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof Fr){let r=(await i.next()).value;if(r){try{await this._gateway.sendExtensionMessage(Ht.PUBLISH,r,!0)}catch(n){throw i.throw(n),n}await i.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{let r=(await i.next()).value;if(r){var t;let n;try{n=await this._gateway.publish(this._uid,r,!0)}catch(o){if(o.code!==A.DISCONNECT_P2P)throw i.throw(o),o}await i.next(((t=n)===null||t===void 0?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(let n of e)n instanceof Et&&n._encoderConfig&&this._gateway.setVideoProfile(n._encoderConfig),!n.muted&&n.enabled||await this._p2pChannel.muteLocalTrack(n)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,e),(i==null?void 0:i.code)===A.WS_ABORT)return;throw i}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new U(A.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new U(A.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));S.debug("[".concat(this._clientId,"] publish low stream"));let e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{let i=await this._p2pChannel.publishLowStream(this._lowStreamParameter),r=(await i.next()).value;if(r){var t;let n;try{n=await this._gateway.publish(this._uid,r,!0)}catch(o){if(o.code!==A.DISCONNECT_P2P)throw i.throw(o),o}i.next(((t=n)===null||t===void 0?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i==null?void 0:i.code,void 0,!0),(i==null?void 0:i.code)===A.WS_ABORT)return;throw i}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new U(A.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();let t=()=>new F9(this._joinInfo,this._config.websocketRetryConfig||Jt,this._config.httpRetryConfig||Jt),i=r=>{r.onLiveStreamError=(n,o)=>{_e.reportApiInvoke(this._sessionId,{name:ei.ON_LIVE_STREAM_ERROR,options:[n,o],tag:xt.TRACER}).onSuccess(),this.safeEmit(We.LIVE_STREAMING_ERROR,n,o)},r.onLiveStreamWarning=(n,o)=>{_e.reportApiInvoke(this._sessionId,{name:ei.ON_LIVE_STREAM_WARNING,options:[n,o],tag:xt.TRACER}).onSuccess(),this.safeEmit(We.LIVE_STREAMING_WARNING,n,o)},r.on(Rm.REQUEST_WORKER_MANAGER_LIST,(n,o,a)=>{if(!this._joinInfo)return a(new U(A.INVALID_OPERATION,"can not find join info to get worker manager"));DN(n,this._joinInfo,this._axiosCancelSource.token,Jt).then(o).catch(a)})};switch(e){case Ri.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),i(this._liveRawStreamingClient)),this._liveRawStreamingClient;case Ri.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),i(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case Ri.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(Rm.REQUEST_WORKER_MANAGER_LIST,(r,n,o)=>{if(!this._joinInfo)return o(new U(A.INVALID_OPERATION,"can not find join info to get worker manager"));DN(r,this._joinInfo,this._axiosCancelSource.token,Jt).then(n).catch(o)}),this._injectStreamingClient.onInjectStatusChange=(r,n,o)=>{this.safeEmit(We.INJECT_STREAM_STATUS,r,n,o)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new U(A.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){let{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),i={width:e,height:t};this._channelMediaRelayClient=new B9(this._joinInfo,this._clientId,this._config.websocketRetryConfig||Jt,this._config.httpRetryConfig||Jt,i),this._channelMediaRelayClient.on("state",r=>{r===vr.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(We.CHANNEL_MEDIA_RELAY_STATE,r)}),this._channelMediaRelayClient.on("event",r=>{this.safeEmit(We.CHANNEL_MEDIA_RELAY_EVENT,r)}),this._statsCollector.onStatsChanged=(r,n)=>{var o;r==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(n))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){let{added:i,deleted:r}=e,n=[];Array.isArray(i)&&i.length>0&&i.forEach(o=>{let{uid:a,stream_id:l,ordered:d,max_retrans_times:u,metadata:p}=o,m=this._users.find(f=>f._uintid===a);if(!m)return void S.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(S.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(a)),se(n).call(n,m)||n.push(m),m._uintid||(m._uintid=a),m._dataChannels.findIndex(f=>f.id===o.stream_id)===-1){let f={id:l,ordered:!!d,maxRetransmits:u,metadata:p},E=new f9(f);m._dataChannels.push(E),S.info("[".concat(this._clientId,"] remote user ").concat(m.uid," published datachannel")),t||this.safeEmit(We.USER_PUBLISHED,m,"datachannel",f)}this._p2pChannel.hasPendingRemoteDataChannel(m,o.stream_id)&&(S.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(m.uid," after reconnect.")),this._subscribeDataChannel(m,o.stream_id).catch(f=>{S.error("[".concat(this._clientId,"] resubscribe datachannel error"),f.toString())}))}),t&&(this.safeEmit(We.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(r)&&r.length>0&&r.forEach(o=>{let{uid:a,stream_id:l}=o,d=this._users.find(p=>p._uintid===a);if(!d)return void S.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));let u=d._dataChannels.find(p=>p.id===o.stream_id);u&&(S.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(a)),this._p2pChannel.unsubscribeDataChannel(d,[u]).then(p=>{if(d._dataChannels=d._dataChannels.filter(m=>m!==u),p)return this._gateway.unsubscribeDataChannel(p,d.uid)}),S.info("[".concat(this._clientId,"] remote user ").concat(a," unpublished datachannel ,id:").concat(u.id)),this.safeEmit(We.USER_UNPUBLISHED,d,"datachannel",u._config))})}_handleRemoveDataChannels(e){let t=this._users.find(i=>i.uid===e.uid);if(t){if(t._dataChannels!==void 0&&t._dataChannels.length>0){S.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));let i=()=>{S.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach(r=>{this.safeEmit(We.USER_UNPUBLISHED,t,"datachannel",r._config)})};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then(r=>{if(r)return this._gateway.unsubscribeDataChannel(r,t.uid)}),i()}}else S.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(Wt.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(Wt.CONNECTION_STATE_CHANGE,(e,t,i)=>{var r;if(i===Ge.FALLBACK)return;let n=()=>{this.safeEmit(We.CONNECTION_STATE_CHANGE,e,t,i)};if(_e.reportApiInvoke(this._sessionId||((r=this._gateway.joinInfo)===null||r===void 0?void 0:r.sid)||null,{name:ei.CONNECTION_STATE_CHANGE,options:[e,t,i],tag:xt.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:i})),S.info("[".concat(this._clientId,"] connection state change: ").concat(t," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void n();if(e==="RECONNECTING")this._users.forEach(a=>{a._trust_in_room_=!1,a._trust_audio_enabled_state_=!1,a._trust_video_enabled_state_=!1,a._trust_audio_mute_state_=!1,a._trust_video_mute_state_=!1,a._trust_audio_stream_added_state_=!1,a._trust_video_stream_added_state_=!1,a._is_pre_created||(a._audio_pre_subscribed||(a._audioSSRC=void 0,a._audioOrtc=void 0),a._video_pre_subscribed||(a._videoSSRC=void 0,a._videoOrtc=void 0,a._rtxSsrcId=void 0),a._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((a,l)=>{this._gateway.setStreamFallbackOption(l,a).catch(d=>{S.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),d)})}),this._remoteStreamTypeCacheMap.forEach((a,l)=>{this._gateway.setRemoteVideoStreamType(l,a).catch(d=>{S.warning("[".concat(this._clientId,"] auto set remote stream type failed"),d)})}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{S.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(a=>{S.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(a))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(a=>!a._trust_in_room_).forEach(a=>{S.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(a.uid)),this._handleUserOffline({uid:a.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(a=>{a._trust_audio_mute_state_||(S.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,me.AUDIO,!1)),a._trust_video_mute_state_||(S.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(a.uid)),this._handleMuteStream(a.uid,me.VIDEO,!1)),a._trust_audio_enabled_state_||(S.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(a.uid)),this._handleSetStreamLocalEnable("audio",a.uid,!0)),a._trust_video_enabled_state_||(S.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(a.uid)),this._handleSetStreamLocalEnable("video",a.uid,!0)),a._trust_video_stream_added_state_||(S.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(a.uid)),this._handleResetAddStream(a,"video")),a._trust_audio_stream_added_state_||(S.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(a.uid)),this._handleResetAddStream(a,"audio")),a._video_added_||a._audio_added_||(S.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(a.uid)),this._handleRemoveStream({uid:a.uid,uint_id:a._uintid}))}))},1e3))}n()}),this._gateway.on(Wt.REQUEST_NEW_GATEWAY_LIST,async(e,t)=>{if(!this._joinInfo)return t(new U(A.UNEXPECTED_ERROR,"can not recover, no join info"));try{let i;this._joinInfo.recoverPreloadCache?(i=this._joinInfo.recoverPreloadCache.ap,B1(this._joinInfo.recoverPreloadCache),this._joinInfo.recoverPreloadCache=void 0):i=await dT(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Jt,this.store),this._joinInfo&&(this._joinInfo.apResponse=i.gatewayInfo.res,this._joinInfo.gatewayAddrs=i.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=i.gatewayInfo.uni_lbs_ip);let r=[];i.gatewayInfo.gatewayAddrs.forEach(n=>{let{address:o}=n,[a,l]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?r.push({proxy:this._joinInfo.proxyServer,host:a,port:l}):r.push({host:a,port:l})}),e(r)}catch(i){t(i)}}),this._gateway.on(Wt.NETWORK_QUALITY,e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(We.NETWORK_QUALITY,e)}),this._gateway.on(Wt.STREAM_TYPE_CHANGE,(e,t)=>{this.safeEmit(We.STREAM_TYPE_CHANGED,e,t),_e.reportApiInvoke(this._sessionId,{name:ei.STREAM_TYPE_CHANGE,options:[e,t],tag:xt.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))}),this._gateway.on(Wt.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(Wt.NEED_RENEW_SESSION,async e=>{if(e==="recover"&&this._joinInfo){let t=await V1(Rn(Rn({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));this._joinInfo.recoverPreloadCache=t,this._startSession(t==null?void 0:t.sid)}else this._startSession()}),this._gateway.on(Wt.REQUEST_P2P_CONNECTION_PARAMS,async(e,t,i)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(r){i(r)}}),this._gateway.on(Wt.JOIN_RESPONSE,(e,t)=>{if(this.store.useP2P)return;let{dtlsParameters:i,iceParameters:r,candidates:n,rtpCapabilities:o,setup:a,cname:l}=TL(e.ortc,t);this._p2pChannel.connect(r,i,n,o,a,l)}),this._gateway.on(Wt.REQUEST_DC_CONNECTION_PARAMS,e=>{e(this._p2pChannel.getEstablishParams())}),this._gateway.on(Wt.RESET_SIGNAL,e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()}),this._gateway.on(Wt.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(Wt.DATACHANNEL_PRECONNECT,async(e,t,i,r)=>{var n,o,a,l,d,u;await this._p2pChannel.startP2PConnection({turnServer:(n=this._joinInfo)===null||n===void 0?void 0:n.turnServer},!0);let p=function(m,f){let E;return f&&f.ip&&typeof f.port=="number"?(E=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:f.ip,port:f.port.toString(),type:"host",extension:{}}],S.debug("Using remote candidate from AP ".concat(f.ip,":").concat(f.port)),f.ip6&&(E.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:f.ip6,port:f.port.toString(),type:"host",extension:{}}),S.debug("Using IPV6 remote candidate from AP ".concat(f.ip6,":").concat(f.port)))):E=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:m.ip,port:m.port.toString(),type:"host",extension:{}}],E}(e,t);return this._p2pChannel.preConnect({iceUfrag:"".concat((o=this._joinInfo)===null||o===void 0?void 0:o.apResponse.cid,"_").concat((a=this._joinInfo)===null||a===void 0?void 0:a.apResponse.cert),icePwd:"".concat((l=this._joinInfo)===null||l===void 0?void 0:l.apResponse.cid,"_").concat((d=this._joinInfo)===null||d===void 0?void 0:d.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(u=N("FINGERPRINT"))!==null&&u!==void 0?u:e.fingerprint}]},p,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(i).catch(r)})}_handleGatewaySignalEvents(){this._gateway.signal.on(Oe.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(Oe.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(Oe.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc)),this._gateway.signal.on(Oe.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(Oe.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(Oe.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)}),this._gateway.signal.on(Oe.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(Oe.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(Oe.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,me.AUDIO,!0)),this._gateway.signal.on(Oe.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,me.AUDIO,!1)),this._gateway.signal.on(Oe.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,me.VIDEO,!0)),this._gateway.signal.on(Oe.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,me.VIDEO,!1)),this._gateway.signal.on(Oe.RECEIVE_METADATA,e=>{let t=nc(e.metadata);this.safeEmit(We.RECEIVE_METADATA,e.uid,t)}),this._gateway.signal.on(Oe.ON_DATA_STREAM,async e=>{var t;if(!e)return;let i=nc(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&se(t=["aes-128-gcm2","aes-256-gcm2"]).call(t,this._encryptionMode)){if(e.payload.length<wl)throw new U(A.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(wl));i=await async function(n,o,a){let l=a.subarray(0,wl),d=l.slice(8,wl),u=(d[0]<<8)+d[1],p=(l[6]<<8)+l[7],m=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:n,tagLength:Gb,additionalData:new Uint8Array(Fb(u,2))},o,a.subarray(wl));return new Uint8Array(m).subarray(0,p)}(this._encryptDataStreamIv,this._encryptDataStreamKey,i)}let r=0;if(e.ordered||e.syncWithAudio){let n=this._p2pChannel.getStats(),o=this.remoteUsers.find(l=>l.uid===e.uid),a=n==null?void 0:n.audioRecv.find(l=>l.ssrc===(o==null?void 0:o._audioSSRC));r=a==null?void 0:a.jitterBufferMs}r==null&&(r=0),p7(Rn(Rn({},e),{},{payload:i}),r,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(Oe.ON_CRYPT_ERROR,()=>{Js(()=>{S.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(We.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(Oe.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(Oe.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{S.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ge.TOKEN_EXPIRE),this.safeEmit(We.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(Oe.ON_STREAM_FALLBACK_UPDATE,e=>{S.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(We.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(Oe.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),S.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(Oe.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(Oe.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(de.REQUEST_TIMEOUT,(e,t)=>{if(this._joinInfo)switch(e){case Se.PUBLISH:{if(!t)return;let n=t.ortc;if(n){var i,r;let o=n.some(d=>{let{stream_type:u}=d;return u===ot.Audio}),a=n.some(d=>{let{stream_type:u}=d;return u!==ot.Audio}),l=n.some(d=>{let{stream_type:u}=d;return u===ot.Screen||u===ot.ScreenLow});t.state==="offer"&&_e.publish(this._joinInfo.sid,{eventElapse:Gi.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:A.TIMEOUT,audio:o,video:a,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:l,audioName:o?(i=n.find(d=>{let{stream_type:u}=d;return u===ot.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0,videoName:a?(r=n.find(d=>{let{stream_type:u}=d;return u!==ot.Audio}))===null||r===void 0||(r=r.ssrcs[0])===null||r===void 0?void 0:r.ssrcId.toString():void 0})}break}case Se.SUBSCRIBE:t&&_e.subscribe(this._joinInfo.sid,{succ:!1,ec:A.TIMEOUT,audio:t.stream_type===me.AUDIO,video:t.stream_type===me.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:Gi.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}}),this._gateway.signal.on(Oe.ON_P2P_OK,e=>{this.uid,this._uid}),this._gateway.signal.on(Oe.ON_PUBLISHED_USER_LIST,e=>{if(e==null||!e.users)return;N("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(r=>!sc(r.string_id||r.stream_id,this.channelName)));let t=[],i=[];for(let r of e.users){let n=this._users.find(p=>p._uintid===r.stream_id);n?n._trust_in_room_=!0:(n=new ha(r.string_id||r.stream_id,r.stream_id),this._users.push(n),this.getListeners(We.PUBLISHED_USER_LIST).length===0&&(S.debug("[".concat(this._clientId,"] user online"),r.stream_id),this.safeEmit(We.USER_JOINED,n)));let o=_i.Audio&r.stream_type,a=(_i.Video|_i.LwoVideo)&r.stream_type,l=(65280&r.stream_type)!=0,d=o&&n.hasAudio,u=a&&n.hasVideo;a&&(n._trust_video_stream_added_state_=!0,n._video_added_=!0,n._videoSSRC=r.video_ssrc,n._rtxSsrcId=r.video_rtx),o&&(n._trust_audio_stream_added_state_=!0,n._audio_added_=!0,n._audioSSRC=r.audio_ssrc),o&&!d&&this.getListeners(We.PUBLISHED_USER_LIST).length===0&&(S.info("[".concat(this._clientId,"] remote user ").concat(n.uid," published audio")),this.safeEmit(We.USER_PUBLISHED,n,"audio")),a&&!u&&this.getListeners(We.PUBLISHED_USER_LIST).length===0&&(S.info("[".concat(this._clientId,"] remote user ").concat(n.uid," published video")),this.safeEmit(We.USER_PUBLISHED,n,"video")),(o&&!d||a&&!u||l)&&t.push(n),a&&this._p2pChannel.hasPendingRemoteMedia(n,"video")&&i.push({user:n,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(n,"audio")&&i.push({user:n,mediaType:"audio"})}i.length>0&&(S.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map(r=>"user: ".concat(r.user.uid,", mediaType: ").concat(r.mediaType)).join("; ")," ")),this.massSubscribe(i).catch(r=>{S.error("[".concat(this._clientId,"] mass resubscribe error"),r.toString())})),this.getListeners(We.PUBLISHED_USER_LIST).length>0?N("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(S.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map(r=>r.uid).join(", "))),this.safeEmit(We.PUBLISHED_USER_LIST,t)):S.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map(r=>r.uid).join(", ")))}),this._gateway.signal.on(Oe.ON_RTP_CAPABILITY_CHANGE,e=>{let{video_codec:t}=e;this._p2pChannel instanceof R_&&this._p2pChannel.updateRemoteRTPCapabilities(t.map(i=>i.toLowerCase()).filter(i=>{var r;return se(r=Object.keys(Il)).call(r,i)}))})}_handleP2PEvents(){this._gateway.signal.on(Oe.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(Ht.PUBLISH,(e,t,i)=>{let{uid:r}=e;e.forEach(n=>{let{kind:o,ssrcs:a,mid:l,isMuted:d}=n;this._handleP2PAddAudioOrVideoStream(o,r,a[0].ssrcId,l);let u=this._users.find(p=>p.uid===r);return u&&this._p2pChannel instanceof Fr?this._p2pChannel.mockSubscribe(u,o,a[0].ssrcId,l).then(()=>{t()}).catch(i):t(),this._handleMuteStream(r,o,!!d)})}),this._gateway.signal.on(Ht.CALL,async(e,t,i)=>{if(this._p2pChannel instanceof Fr)try{var r;t(await this._p2pChannel.startP2P({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},e))}catch(n){i(n)}}),this._gateway.signal.on(de.P2P_CONNECTION,async e=>{this._p2pChannel instanceof Fr&&await this._p2pChannel.p2pConnect(e)}),this._gateway.signal.on(Ht.UNPUBLISH,async(e,t,i)=>{if(this._p2pChannel instanceof Fr){let{unpubMsg:r,uid:n}=e,o=this._users.find(a=>a.uid===n);if(!o)return S.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(n)),void t();try{r.forEach(async a=>{let{stream_type:l}=a,d=l===ot.Audio?me.AUDIO:me.VIDEO;await this._p2pChannel.unsubscribe(o,d),this._handleMuteStream(n,d,!0)}),t()}catch(a){i(a)}}}),this._gateway.signal.on(Ht.CONTROL,async(e,t)=>{let{action:i}=e;switch(i){case ea.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,me.VIDEO,!0);break;case ea.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,me.AUDIO,!0);break;case ea.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,me.VIDEO,!1);break;case ea.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,me.AUDIO,!1)}}),this._gateway.signal.on(Ht.RESTART_ICE,async(e,t,i)=>{if(this._p2pChannel instanceof Fr)try{let{direction:r,iceParameter:n}=e;r!==nr.SEND_ONLY||n?t(await this._p2pChannel.restartICE(r,n)):(this._p2pChannel.handleDisconnect(r),t())}catch(r){i(r)}}),this._gateway.signal.on(Ht.CANDIDATE,e=>{if(this._p2pChannel instanceof Fr){let{candidate:t,direction:i}=e;this._p2pChannel.addRemoteCandidate(t,i)}}),this._p2pChannel.on(ye.RequestP2PRestartICE,async(e,t,i)=>{try{let{direction:r}=e;t(await this._gateway.sendExtensionMessage(Ht.RESTART_ICE,e,r===nr.SEND_ONLY))}catch(r){i(r)}}),this._p2pChannel.on(ye.LocalCandidate,e=>{this._gateway.sendExtensionMessage(Ht.CANDIDATE,JSON.stringify(e),!0)}),this._p2pChannel.on(ye.RequestP2PMuteLocal,async(e,t,i)=>{try{await this._gateway.sendExtensionMessage(Ht.CONTROL,e,!0),t()}catch(r){i(r)}}),this._p2pChannel.on(ye.RequestP2PUnmuteRemote,async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===A.DISCONNECT_P2P?t():i(r)}else t()}),this._p2pChannel.on(ye.RequestP2PMuteRemote,async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===A.DISCONNECT_P2P?t():i(r)}else t()}),this._p2pChannel.on(ye.StateChange,(e,t)=>{t===st.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(ye.RequestMuteLocal,async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===A.DISCONNECT_P2P?t():i(r)}else t()}),this._p2pChannel.on(ye.RequestUnmuteLocal,async(e,t,i)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(r){r.code===A.DISCONNECT_P2P?t():i(r)}else t()}),this._p2pChannel.on(ye.RequestRePublish,(e,t,i)=>{this.publish(e,!1).then(t).catch(i)}),this._p2pChannel.on(ye.RequestRePublishDataChannel,(e,t,i)=>{ne.all(e.map(async r=>{await this._p2pChannel.publishDataChannel([r]);let n={streamId:r.id,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:r.metadata,channelId:r._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,n,!0)}catch(o){if(o.code!==A.DISCONNECT_P2P)throw o}})).then(t).catch(i)}),this._p2pChannel.on(ye.RequestReSubscribe,async(e,t,i)=>{try{for(let{user:r,kind:n}of e)n===me.VIDEO?await this.subscribe(r,"video"):await this.subscribe(r,"audio");t()}catch(r){i(r)}}),this._p2pChannel.on(ye.RequestUpload,(e,t)=>{this._gateway.upload(e,t)}),this._p2pChannel.on(ye.RequestUploadStats,e=>{this._gateway.uploadWRTCStats(e)}),this._p2pChannel.on(ye.MediaReconnectStart,e=>{this.safeEmit(We.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(ye.MediaReconnectEnd,e=>{this.safeEmit(We.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(ye.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(ye.RequestRestartICE,async e=>{if(this._p2pChannel instanceof Fr)return;let t=await this._p2pChannel.restartICE(e),i=await t.next();if(i.done)return;let r=i.value,n;try{n=await this._gateway.restartICE({iceParameters:r})}catch(a){return void t.throw(a)}let{iceParameters:o}=function(a){let l=a.iceParameters;return{iceParameters:{iceUfrag:l.iceUfrag,icePwd:l.icePwd}}}(n);await t.next({remoteIceParameters:o})}),this._p2pChannel.on(ye.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(ye.RequestReconnectPC,async()=>{var e;let{iceParameters:t,dtlsParameters:i,rtpCapabilities:r}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:n,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:i,rtpCapabilities:r}),{dtlsParameters:a,iceParameters:l,candidates:d,rtpCapabilities:u,setup:p,cname:m}=TL(n,o);await this._p2pChannel.connect(l,a,d,u,p,m),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(ye.RequestUnpublishForReconnectPC,async(e,t,i)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),t()):i()}),this._p2pChannel.on(ye.P2PLost,()=>{this.safeEmit(We.P2P_LOST,this.store.uid)}),this._p2pChannel.on(ye.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(ye.ConnectionTypeChange,e=>{this.safeEmit(We.IS_USING_CLOUD_PROXY,e)}),this._p2pChannel.on(ye.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(ye.QueryClientConnectionState,e=>{e(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new U(A.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new U(A.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new U(A.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new U(A.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{let t=[...new Set(e.inspectType)];t.forEach(i=>{var r;if(!se(r=["supervise","moderation"]).call(r,i))throw new U(A.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(i," is not a valid inspect type."))}),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new U(A.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{let t=new C_(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Jt)}catch(t){throw Array.isArray(t)?t[0]:t}}async disableContentInspect(){if(!this._inspect)throw new U(A.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(us(e,"enabled"),e){if(!t)throw new U(A.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(ut(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new U(A.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(t&&t.vendor&&t.vendor.length>1024)throw new U(A.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new U(A.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);let i=new Uv(t);this._moderation=i,this.handleImageModerationEvents(this._moderation),await i.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},Jt)}catch(i){throw Array.isArray(i)?i[0]:i}}else{if(!this._moderation)throw new U(A.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(i){throw Array.isArray(i)?i[0]:i}}}setP2PTransport(e){if(function(t){ci(t,"transport",["default","auto","relay","sd-rtn"])}(e),this.mode!=="p2p")throw new U(A.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,S.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(po.CONNECTION_STATE_CHANGE,(t,i)=>{if(this.safeEmit(We.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,i),t===fn.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new U(A.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}}),e.on(po.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}handleVideoInspectEvents(e){e.on(Ci.CONNECTION_STATE_CHANGE,(t,i)=>{if(this.safeEmit(We.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,i),i===xn.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(We.CONTENT_INSPECT_ERROR,new U(A.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}}),e.on(Ci.INSPECT_RESULT,(t,i)=>{var r;if((i==null?void 0:i.code)===A.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return S.debug("Stop inspect content because that has left channel"),this==null||(r=this._inspect)===null||r===void 0||r.close(),void(this._inspect=void 0);this.safeEmit(We.CONTENT_INSPECT_RESULT,t,i)}),e.on(Ci.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return S.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){us(e,"enabled"),ht("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}},ie(ae.prototype,"leave",[H1],Object.getOwnPropertyDescriptor(ae.prototype,"leave"),ae.prototype),ie(ae.prototype,"publish",[K1],Object.getOwnPropertyDescriptor(ae.prototype,"publish"),ae.prototype),ie(ae.prototype,"unpublish",[z1],Object.getOwnPropertyDescriptor(ae.prototype,"unpublish"),ae.prototype),ie(ae.prototype,"subscribe",[Y1],Object.getOwnPropertyDescriptor(ae.prototype,"subscribe"),ae.prototype),ie(ae.prototype,"presubscribe",[q1],Object.getOwnPropertyDescriptor(ae.prototype,"presubscribe"),ae.prototype),ie(ae.prototype,"massSubscribe",[J1],Object.getOwnPropertyDescriptor(ae.prototype,"massSubscribe"),ae.prototype),ie(ae.prototype,"unsubscribe",[X1],Object.getOwnPropertyDescriptor(ae.prototype,"unsubscribe"),ae.prototype),ie(ae.prototype,"massUnsubscribe",[Q1],Object.getOwnPropertyDescriptor(ae.prototype,"massUnsubscribe"),ae.prototype),ie(ae.prototype,"setLowStreamParameter",[Z1],Object.getOwnPropertyDescriptor(ae.prototype,"setLowStreamParameter"),ae.prototype),ie(ae.prototype,"enableDualStream",[$1],Object.getOwnPropertyDescriptor(ae.prototype,"enableDualStream"),ae.prototype),ie(ae.prototype,"disableDualStream",[eM],Object.getOwnPropertyDescriptor(ae.prototype,"disableDualStream"),ae.prototype),ie(ae.prototype,"setClientRole",[tM],Object.getOwnPropertyDescriptor(ae.prototype,"setClientRole"),ae.prototype),ie(ae.prototype,"setProxyServer",[iM],Object.getOwnPropertyDescriptor(ae.prototype,"setProxyServer"),ae.prototype),ie(ae.prototype,"setTurnServer",[rM],Object.getOwnPropertyDescriptor(ae.prototype,"setTurnServer"),ae.prototype),ie(ae.prototype,"setLicense",[nM],Object.getOwnPropertyDescriptor(ae.prototype,"setLicense"),ae.prototype),ie(ae.prototype,"startProxyServer",[oM],Object.getOwnPropertyDescriptor(ae.prototype,"startProxyServer"),ae.prototype),ie(ae.prototype,"stopProxyServer",[sM],Object.getOwnPropertyDescriptor(ae.prototype,"stopProxyServer"),ae.prototype),ie(ae.prototype,"setLocalAccessPointsV2",[aM],Object.getOwnPropertyDescriptor(ae.prototype,"setLocalAccessPointsV2"),ae.prototype),ie(ae.prototype,"setLocalAccessPoints",[cM],Object.getOwnPropertyDescriptor(ae.prototype,"setLocalAccessPoints"),ae.prototype),ie(ae.prototype,"setRemoteDefaultVideoStreamType",[lM],Object.getOwnPropertyDescriptor(ae.prototype,"setRemoteDefaultVideoStreamType"),ae.prototype),ie(ae.prototype,"setRemoteVideoStreamType",[dM],Object.getOwnPropertyDescriptor(ae.prototype,"setRemoteVideoStreamType"),ae.prototype),ie(ae.prototype,"setStreamFallbackOption",[uM],Object.getOwnPropertyDescriptor(ae.prototype,"setStreamFallbackOption"),ae.prototype),ie(ae.prototype,"setEncryptionConfig",[hM],Object.getOwnPropertyDescriptor(ae.prototype,"setEncryptionConfig"),ae.prototype),ie(ae.prototype,"renewToken",[pM],Object.getOwnPropertyDescriptor(ae.prototype,"renewToken"),ae.prototype),ie(ae.prototype,"enableAudioVolumeIndicator",[mM],Object.getOwnPropertyDescriptor(ae.prototype,"enableAudioVolumeIndicator"),ae.prototype),ie(ae.prototype,"startLiveStreaming",[_M],Object.getOwnPropertyDescriptor(ae.prototype,"startLiveStreaming"),ae.prototype),ie(ae.prototype,"setLiveTranscoding",[fM],Object.getOwnPropertyDescriptor(ae.prototype,"setLiveTranscoding"),ae.prototype),ie(ae.prototype,"stopLiveStreaming",[EM],Object.getOwnPropertyDescriptor(ae.prototype,"stopLiveStreaming"),ae.prototype),ie(ae.prototype,"addInjectStreamUrl",[gM],Object.getOwnPropertyDescriptor(ae.prototype,"addInjectStreamUrl"),ae.prototype),ie(ae.prototype,"removeInjectStreamUrl",[SM],Object.getOwnPropertyDescriptor(ae.prototype,"removeInjectStreamUrl"),ae.prototype),ie(ae.prototype,"startChannelMediaRelay",[TM],Object.getOwnPropertyDescriptor(ae.prototype,"startChannelMediaRelay"),ae.prototype),ie(ae.prototype,"updateChannelMediaRelay",[vM],Object.getOwnPropertyDescriptor(ae.prototype,"updateChannelMediaRelay"),ae.prototype),ie(ae.prototype,"stopChannelMediaRelay",[RM],Object.getOwnPropertyDescriptor(ae.prototype,"stopChannelMediaRelay"),ae.prototype),ie(ae.prototype,"sendCustomReportMessage",[CM],Object.getOwnPropertyDescriptor(ae.prototype,"sendCustomReportMessage"),ae.prototype),ie(ae.prototype,"pickSVCLayer",[yM],Object.getOwnPropertyDescriptor(ae.prototype,"pickSVCLayer"),ae.prototype),ie(ae.prototype,"setRTMConfig",[IM],Object.getOwnPropertyDescriptor(ae.prototype,"setRTMConfig"),ae.prototype),ie(ae.prototype,"enableContentInspect",[wM],Object.getOwnPropertyDescriptor(ae.prototype,"enableContentInspect"),ae.prototype),ie(ae.prototype,"disableContentInspect",[AM],Object.getOwnPropertyDescriptor(ae.prototype,"disableContentInspect"),ae.prototype),ie(ae.prototype,"setImageModeration",[OM],Object.getOwnPropertyDescriptor(ae.prototype,"setImageModeration"),ae.prototype),ie(ae.prototype,"setP2PTransport",[bM],Object.getOwnPropertyDescriptor(ae.prototype,"setP2PTransport"),ae.prototype),ie(ae.prototype,"getJoinChannelServiceRecords",[NM],Object.getOwnPropertyDescriptor(ae.prototype,"getJoinChannelServiceRecords"),ae.prototype),ie(ae.prototype,"setPublishAudioFilterEnabled",[DM],Object.getOwnPropertyDescriptor(ae.prototype,"setPublishAudioFilterEnabled"),ae.prototype),ae);class ch{constructor(t,i){y(this,"id",0),y(this,"element",void 0),y(this,"peerPair",void 0),y(this,"context",void 0),y(this,"audioPlayerElement",void 0),y(this,"audioTrack",void 0),ch.count+=1,this.id=ch.count,this.element=t,this.context=i}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{let i=document.createElement("audio");i.srcObject=new MediaStream([t.track]),i.play(),this.audioPlayerElement=i}}async switchSdp(){if(!this.peerPair)return;let t=async(r,n)=>{let o=n==="offer"?await r.createOffer():await r.createAnswer();return await r.setLocalDescription(o),r.iceGatheringState==="complete"?r.localDescription:new ne(a=>{r.onicegatheringstatechange=()=>{r.iceGatheringState==="complete"&&a(r.localDescription)}})},i=async(r,n)=>await r.setRemoteDescription(n);try{let r=await t(this.peerPair[0],"offer");await i(this.peerPair[1],r);let n=await t(this.peerPair[1],"answer");await i(this.peerPair[0],n)}catch(r){throw new U(A.LOCAL_AEC_ERROR,r.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let i;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),i=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(i)}catch(n){throw new U(A.LOCAL_AEC_ERROR,n.toString()).print()}if(!i)throw new U(A.LOCAL_AEC_ERROR,"no dest node when local aec").print();let r=i.stream.getAudioTracks()[0];return this.audioTrack=r,r}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();let t=this.element,i=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(i),await this.switchSdp()}close(){S.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(t=>{t.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var kM,b_;y(ch,"count",0);let S7=window.AudioContext||window.webkitAudioContext,T7=new(kM=Ce({report:_e}),ie((b_=class{constructor(){y(this,"units",[]),y(this,"context",void 0)}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return S.debug("the system does not need to process local aec"),-1;this.context||(this.context=new S7);let t=this.units.find(i=>i&&i.getElement()===e);return t||(t=new ch(e,this.context),this.units.push(t)),t.startEchoCancellation(),S.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return Xe().name!==nt.SAFARI}}).prototype,"processExternalMediaAEC",[kM],Object.getOwnPropertyDescriptor(b_.prototype,"processExternalMediaAEC"),b_.prototype),b_);function LM(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable})),i.push.apply(i,r)}return i}function MM(e){for(var t=1;t<arguments.length;t++){var i=arguments[t]!=null?arguments[t]:{};t%2?LM(Object(i),!0).forEach(function(r){y(e,r,i[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):LM(Object(i)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(i,r))})}return e}let Wv=window||document;function UM(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!Wv)return;let i=ri._cspEventHandlerPointer;if(i&&t)return void console.error(i,t);let r=n=>{if(!(n&&n.blockedURI&&(ri.onSecurityPolicyViolation||ri.getListeners(Wo.SECURITY_POLICY_VIOLATION).length>0)))return;let o=n.blockedURI;N("CSP_DETECTED_HOSTNAME_LIST").some(a=>se(o).call(o,a))&&(ri.onSecurityPolicyViolation&&typeof ri.onSecurityPolicyViolation=="function"&&ri.onSecurityPolicyViolation(n),ri.getListeners(Wo.SECURITY_POLICY_VIOLATION).length>0&&ri.safeEmit(Wo.SECURITY_POLICY_VIOLATION,n))};i&&Wv.removeEventListener("securitypolicyviolation",i),(t||e&&typeof e=="function"||ri.getListeners(Wo.SECURITY_POLICY_VIOLATION).length>0)&&Wv.addEventListener("securitypolicyviolation",r),ri._cspEventHandlerPointer=r}ht("PROCESS_ID","process-".concat(ft(8,""),"-").concat(ft(4,""),"-").concat(ft(4,""),"-").concat(ft(4,""),"-").concat(ft(12,""))),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void S.error("Error loading sdk config",t.message)}if(e)try{let t=JSON.parse(window.atob(e)),i=Date.now();S.debug("Loading global parameters from cache",t),Object.keys(t).forEach(r=>{if(Object.prototype.hasOwnProperty.call(oi,r)){let{value:n,expires:o}=t[r];if(o&&o<=i)return;Qs[r]=n,oi[r]=n}})}catch(t){S.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(Qs.AREAS)&&Qs.AREAS.length>0&&nT(Qs.AREAS,!0);let xM=(e,t,i)=>{S.debug("setParameter key:".concat(e,", value:").concat(JSON.stringify(t))),ht(e,t,i)},ri=function(e){let t=new Ot,i=e,r={getListeners:t.getListeners.bind(t),on:(n,o)=>(function(a,l){a===Wo.SECURITY_POLICY_VIOLATION&&UM(l,!0)}(n,o),t.on.bind(t)(n,o)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return MM(MM({},i),r)}({__TRACK_LIST__:zl,VERSION:mn,BUILD:BS,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:xM,getParameter:N,getSupportedCodec:async function(){let e={audio:[],video:[]};try{let t=new RTCPeerConnection,i=await async function(r){let n;return Ye().supportUnifiedPlan?(r.addTransceiver("video",{direction:"recvonly"}),r.addTransceiver("audio",{direction:"recvonly"}),n=(await r.createOffer()).sdp):n=(await r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,n}(t);if(!i)return e;t.close(),t=null,e=function(r){let n={video:[],audio:[]};return r.match(/ VP8/i)&&n.video.push("VP8"),r.match(/ VP9/i)&&n.video.push("VP9"),r.match(/ AV1/i)&&n.video.push("AV1"),r.match(/ H264/i)&&n.video.push("H264"),r.match(/ H265/i)&&n.video.push("H265"),r.match(/ opus/i)&&n.audio.push("OPUS"),r.match(/ PCMU/i)&&n.audio.push("PCMU"),r.match(/ PCMA/i)&&n.audio.push("PCMA"),r.match(/ G722/i)&&n.audio.push("G722"),n}(i)}catch(t){throw new U(A.CREATE_OFFER_FAILED,t.toString&&t.toString()).print()}return e},checkSystemRequirements:function(){let e=_e.reportApiInvoke(null,{name:ei.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:xt.TRACER}),t=!1;try{let o=window.RTCPeerConnection,a=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,l=window.WebSocket;t=!!(o&&a&&l),t&&bS()&&function(d){let u=Xe();return!(u.name!==nt.CHROME||!u.osVersion)&&Number(u.version)<d}(75)&&new o().close()}catch(o){return S.error("check system requirement failed: ",o),!1}let i=!1,r=Xe();r.name===nt.CHROME&&Number(r.version)>=58&&(lo.engine.name!=="WebKit"||function(){let o=Xe();if(lm()){if(o.os===hi.MAC_OS)return!0;if(o.os===hi.IOS){let a=lo.os.version&&lo.os.version.split(".");if(a&&Number(a[0])===14&&a[1]&&Number(a[1])>=3||a&&Number(a[0])>14)return!0}}return!1}())&&(i=!0),(r.name===nt.FIREFOX&&Number(r.version)>=56||r.name===nt.OPERA&&Number(r.version)>=45||r.name===nt.SAFARI&&Number(r.version)>=11||r.name==="WebKit"&&(ji()||Mn())&&r.osVersion&&Number(r.osVersion.split(".")[0])>=11||Tb()||Xe().name===nt.QQ)&&(i=!0),S.debug("checkSystemRequirements, api:",t,"browser",i);let n=t&&i;return e.onSuccess(n),n},getDevices:function(e){return tn.enumerateDevices(!0,!0,e)},getMicrophones:function(e){return tn.getRecordingDevices(e)},getCameras:function(e){return tn.getCamerasDevices(e)},getElectronScreenSources:dP,getPlaybackDevices:function(e){return tn.getSpeakers(e)},createClient:function(){var e;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"},i=_e.reportApiInvoke(null,{name:ei.CREATE_CLIENT,options:[t],tag:xt.TRACER});try{(function(r){ci(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),ci(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&ci(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&Ai(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&Nb(r.turnServer),r.httpRetryConfig!==void 0&&bb(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&bb(r.websocketRetryConfig)})(t)}catch(r){throw i.onError(r),r}return(mb(16,0)||_b(16,0))&&(t.codec==="vp9"&&(t.codec="vp8",S.debug("browser not support vp9, force use vp8")),ht("UNSUPPORTED_VIDEO_CODEC",["vp9"])),t.audioCodec===void 0&&(t.audioCodec="opus"),i.onSuccess(),new g7(Rn(Rn({forceWaitGatewayResponse:!0},t),{},{role:se(e=["rtc","p2p"]).call(e,t.mode)?"host":t.role||"audience"}))},createCameraVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=N("CAMERA_CAPTURE_CONFIG"),i=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CREATE_CAM_VIDEO_TRACK,options:[bt({},e),t]});t&&(e.encoderConfig=t);let r=t_(e),n=ft(8,"track-cam-"),o=null,a=e.encoderConfig==="720p_auto";S.info("start create camera video track with config",JSON.stringify(e),"trackId",n);try{o=(await en({video:r},n)).getVideoTracks()[0]||null}catch(d){throw i.onError(d),d}if(!o){let d=new j(A.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(d),d.throw(S)}e.optimizationMode&&hv(n,o,e,Jo(e.encoderConfig));let l=new uv(o,e,r,e.scalabiltyMode?Qm(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,n);return a&&l.startMonitorStats(),i.onSuccess(l.getTrackId()),S.info("create camera video success, trackId:",n),l},createCustomVideoTrack:function(e){let t=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CREATE_CUSTOM_VIDEO_TRACK,options:[e]}),i=new Et(e.mediaStreamTrack,{width:e.width,height:e.height,frameRate:e.frameRate,bitrateMax:e.bitrateMax,bitrateMin:e.bitrateMin},e.scalabiltyMode?Qm(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,ft(8,"track-cus-"),[Rt.CUSTOM_TRACK]);return t.onSuccess(i.getTrackId()),S.info("create custom video track success with config",e,"trackId",i.getTrackId()),i},createScreenVideoTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable",i=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CREATE_SCREEN_VIDEO_TRACK,options:[bt({},e),t]}),r=e.encoderConfig==="720p_auto";e.encoderConfig?typeof e.encoderConfig=="string"||e.encoderConfig.width&&e.encoderConfig.height||(e.encoderConfig.width={max:1920},e.encoderConfig.height={max:1080}):e.encoderConfig="1080p_2";let n=function(m){let f={};m.screenSourceType&&(f.mediaSource=m.screenSourceType),m.extensionId&&Ys()&&(f.extensionId=m.extensionId);let{displaySurface:E,selfBrowserSurface:I,surfaceSwitching:T,systemAudio:R}=m;(AS(107)||hb(107)||fb(93))&&(E&&(ci(E,"displaySurface",["browser","window","monitor"]),f.displaySurface=E),I?(ci(I,"selfBrowserSurface",["exclude","include"]),f.selfBrowserSurface=I):f.selfBrowserSurface="include",T&&(ci(T,"surfaceSwitching",["exclude","include"]),f.surfaceSwitching=T)),(AS(105)||hb(105)||fb(91))&&R&&(ci(R,"systemAudio",["exclude","include"]),f.systemAudio=R),m.electronScreenSourceId&&(f.sourceId=m.electronScreenSourceId);let w=m.encoderConfig?ev(m.encoderConfig):null;return f.mandatory={chromeMediaSource:"desktop",maxWidth:w?w.width:void 0,maxHeight:w?w.height:void 0},w&&(w.frameRate&&(typeof w.frameRate=="number"?(f.mandatory.maxFrameRate=w.frameRate,f.mandatory.minFrameRate=w.frameRate):(f.mandatory.maxFrameRate=w.frameRate.max||w.frameRate.ideal||w.frameRate.exact||void 0,f.mandatory.minFrameRate=w.frameRate.min||w.frameRate.ideal||w.frameRate.exact||void 0),f.frameRate=w.frameRate),w.width&&(f.width=w.width),w.height&&(f.height=w.height)),f}(e),o=ft(8,"track-scr-v-"),a=null,l=null,d=Ye();if(!d.supportShareAudio&&t==="enable"){let m=new j(A.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return i.onError(m),m.throw(S)}S.info("start create screen video track with config",e,"withAudio",t,"trackId",o);try{let m=await en({screen:n,screenAudio:t==="auto"?d.supportShareAudio:t==="enable"},o);a=m.getVideoTracks()[0]||null,l=m.getAudioTracks()[0]||null}catch(m){throw i.onError(m),m}if(!a){let m=new j(A.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(m),m.throw(S)}if(!l&&t==="enable"){a&&a.stop();let m=new j(A.SHARE_AUDIO_NOT_ALLOWED);return i.onError(m),m.throw(S)}e.optimizationMode||(e.optimizationMode="detail"),e.optimizationMode&&(hv(o,a,e,e.encoderConfig&&ev(e.encoderConfig)||void 0),e.encoderConfig&&typeof e.encoderConfig!="string"&&(e.encoderConfig.bitrateMin=e.encoderConfig.bitrateMax));let u=new Et(a,e.encoderConfig?ev(e.encoderConfig):{},e.scalabiltyMode?Qm(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,o,[Rt.SCREEN_TRACK]);if(r&&u.startMonitorStats(),!l)return i.onSuccess(u.getTrackId()),S.info("create screen video track success","video:",u.getTrackId()),u;let p=new jt(l,void 0,ft(8,"track-scr-a-"),!1);return i.onSuccess([u.getTrackId(),p.getTrackId()]),S.info("create screen video track success","video:",u.getTrackId(),"audio:",p.getTrackId()),[u,p]},createMicrophoneAndCameraTracks:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=N("CAMERA_CAPTURE_CONFIG"),r=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CREATE_MIC_AND_CAM_TRACKS,options:[e,t,i]});i&&(t.encoderConfig=i);let n=t.encoderConfig==="720p_auto",o=t_(t),a=TP(e),l=ft(8,"track-mic-"),d=ft(8,"track-cam-"),u=null,p=null;S.info("start create camera video track(".concat(d,") and microphone audio track(").concat(l,") with config, audio: ").concat(JSON.stringify(e),", video: ").concat(JSON.stringify(t)));try{let E=await en({audio:a,video:o},"".concat(l,"-").concat(d));u=E.getAudioTracks()[0],p=E.getVideoTracks()[0]}catch(E){throw r.onError(E),E}if(!u||!p){let E=new j(A.UNEXPECTED_ERROR,"can not find tracks in media stream");return r.onError(E),E.throw(S)}t.optimizationMode&&hv(d,p,t,Jo(t.encoderConfig));let m=new i_(u,e,a,l),f=new uv(p,t,o,t.scalabiltyMode?Qm(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,d);return n&&f.startMonitorStats(),r.onSuccess([m.getTrackId(),f.getTrackId()]),S.info("create camera video track(".concat(d,") and microphone audio track(").concat(l,") success")),[m,f]},createMicrophoneAudioTrack:async function(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CREATE_MIC_AUDIO_TRACK,options:[e]}),i=TP(e),r=ft(8,"track-mic-"),n=null;S.info("start create microphone audio track with config",JSON.stringify(e),"trackId",r);try{n=(await en({audio:i},r)).getAudioTracks()[0]||null}catch(a){throw t.onError(a),a}if(!n){let a=new j(A.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(a),a.throw(S)}let o=new i_(n,e,i,r);return t.onSuccess(o.getTrackId()),S.info("create microphone audio track success, trackId:",r),o},createCustomAudioTrack:function(e){let t=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CREATE_CUSTOM_AUDIO_TRACK,options:[e]}),i=new jt(e.mediaStreamTrack,e.encoderConfig?Zm(e.encoderConfig):{},ft(8,"track-cus-"),!1);return S.info("create custom audio track success with config",e,"trackId",i.getTrackId()),t.onSuccess(i.getTrackId()),i},createBufferSourceAudioTrack:async function(e){var t;let{cacheOnlineFile:i,encoderConfig:r}=e,{source:n}=e,o={source:n instanceof AudioBuffer?"AudioBuffer":n instanceof File?(t=File.name)!==null&&t!==void 0?t:"File":n,cacheOnlineFile:i,encoderConfig:r},a=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(N("DISABLE_WEBAUDIO"))throw new j(A.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");let l=ft(8,"track-buf-");S.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",l);let d=n;if(!(n instanceof AudioBuffer))try{n=await async function(m,f){let E=null;if(typeof m=="string"){let T=sk.get(m);if(T)return S.debug("use cached audio resource: ",m),T;try{E=(await uo(()=>ur.get(m,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(R){throw new j(A.FETCH_AUDIO_FILE_FAILED,R.toString())}}else E=await new ne((T,R)=>{let w=new FileReader;w.onload=O=>{O.target?T(O.target.result):R(new j(A.READ_LOCAL_AUDIO_FILE_ERROR))},w.onerror=()=>{R(new j(A.READ_LOCAL_AUDIO_FILE_ERROR))},w.readAsArrayBuffer(m)});let I=await function(T){let R=Ql();return new ne((w,O)=>{R.decodeAudioData(T,P=>{w(P)},P=>{O(new j(A.DECODE_AUDIO_FILE_FAILED,P.toString()))})})}(E);return typeof m=="string"&&f&&sk.set(m,I),I}(n,i)}catch(m){return a.onError(m),m.throw(S)}let u=new m9(n),p=new p9(d,u,r?Zm(r):{},l);return S.info("create buffer source audio track success, trackId:",l),a.onSuccess(p.getTrackId()),p},setAppType:function(e){if(S.debug("setAppType: ".concat(e)),!(Number.isInteger(e)&&e>=0))throw S.debug("Invalid appType"),new U(A.INVALID_PARAMS,"invalid app type",e);ht("APP_TYPE",Math.floor(e))},setLogLevel:function(e){S.setLogLevel(e)},enableLogUpload:function(){N("USE_NEW_LOG")?ht("UPLOAD_LOG",!0):S.enableLogUpload()},disableLogUpload:function(){N("USE_NEW_LOG")?ht("UPLOAD_LOG",!1):S.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new KL},checkAudioTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,i=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof jt||e instanceof ed)){let d=new U(A.INVALID_TRACK,"the parameter is not a audio track");return i.onError(d),d.throw()}t&&t<1e3&&(t=1e3);let r=e instanceof jt?e.getTrackLabel():"remote_track",n=e.getVolumeLevel(),o=n,a=n,l=Date.now();return new ne(d=>{let u=setInterval(()=>{let p=e.getVolumeLevel();o=p>o?p:o,a=p<a?p:a;let m=o-a>1e-4,f=Date.now()-l;if(m||f>t){clearInterval(u);let E=m,I={duration:f,deviceLabel:r,maxVolumeLevel:o,result:E};S.info("[track-".concat(e.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(I))),i.onSuccess(I),d(E)}},200)})},checkVideoTrackIsActive:async function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,i=_e.reportApiInvoke(null,{tag:xt.TRACER,name:ei.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[t]});if(!(e instanceof Et||e instanceof $l)){let m=new U(A.INVALID_TRACK,"the parameter is not a video track");return i.onError(m),m.throw()}t&&t<1e3&&(t=1e3);let r=e instanceof Et?e.getTrackLabel():"remote_track",n=e.getMediaStreamTrack(!0),o=document.createElement("video");o.style.width="1px",o.style.height="1px",o.setAttribute("muted",""),o.muted=!0,o.setAttribute("playsinline",""),o.controls=!1,(pi()||lm())&&(o.style.opacity="0.01",o.style.position="fixed",o.style.left="0",o.style.top="0",document.body.appendChild(o)),o.srcObject=new MediaStream([n]),o.play();let a=document.createElement("canvas");a.width=160,a.height=120;let l=0,d=0;try{let m=Date.now();l=await function(f,E,I,T){let R,w=0,O=null;return new ne((P,M)=>{function V(){w>T&&R&&(R(),P(w));let F=I.getContext("2d");if(!F){let Z=new U(A.UNEXPECTED_ERROR,"can not get canvas 2d context.");return S.error(Z.toString()),void M(Z)}F.drawImage(f,0,0,160,120);let Y=F.getImageData(0,0,I.width,I.height),J=Math.floor(Y.data.length/3);if(O){for(let Z=0;Z<J;Z+=3)if(Y.data[Z]!==O[Z])return w+=1,void(O=Y.data);O=Y.data}else O=Y.data}setTimeout(()=>{R&&(R(),P(w))},E),R=ov(()=>{V()},30)})}(o,t,a,4),d=Date.now()-m}catch(m){throw i.onError(m),m}m7===nt.SAFARI&&(o.pause(),o.remove()),o.srcObject=null;let u=l>4,p={duration:d,changedPicNum:l,deviceLabel:r,result:u};return S.info("[track-".concat(e.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(p))),i.onSuccess(p),u},setArea:nT,audioElementPlayCenter:pr,resumeAudioContext:function(){pr.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(e){T7.processExternalMediaAEC(e)},registerExtensions:function(e){let t=N("PLUGIN_INFO")||[];e.forEach(i=>{"name"in i&&!se(t).call(t,i.name)&&t.push(i.name);let r=i;r.__registered__=!0,r.logger.hookLog=S.extLog,r.reporter.hookApiInvoke=_e.extApiInvoke,r.parameters&&Object.keys(r.parameters).forEach(n=>{r.parameters[n]=N(n)})}),xM("PLUGIN_INFO",t)},ChannelMediaRelayError:Ol,ChannelMediaRelayEvent:ps,ChannelMediaRelayState:vr,RemoteStreamFallbackType:s9,RemoteStreamType:o9,ConnectionDisconnectedReason:Ge,AudienceLatencyLevelType:g8,AREAS:et,preload:async function(e,t,i,r){return x1(e,t,i,r)}});return Object.defineProperties(ri,{onAudioAutoplayFailed:{get:()=>rn.onAudioAutoplayFailed,set:e=>{rn.onAudioAutoplayFailed=e}},onAutoplayFailed:{get:()=>rn.onAutoplayFailed,set:e=>{rn.onAutoplayFailed=e}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>ri._onSecurityPolicyViolation,set(e){ri._onSecurityPolicyViolation=e,UM(e)}},__CLIENT_LIST__:{get:()=>N("SHOW_GLOBAL_CLIENT_LIST")?Zs:[]}}),tn.on(Sc.CAMERA_DEVICE_CHANGED,e=>{S.info("camera device changed",JSON.stringify(e)),ri.onCameraChanged&&ri.onCameraChanged(e),ri.safeEmit(Wo.CAMERA_CHANGED,e)}),tn.on(Sc.RECORDING_DEVICE_CHANGED,e=>{S.info("microphone device changed",JSON.stringify(e)),ri.onMicrophoneChanged&&ri.onMicrophoneChanged(e),ri.safeEmit(Wo.MICROPHONE_CHANGED,e)}),tn.on(Sc.PLAYOUT_DEVICE_CHANGED,e=>{S.debug("playout device changed",JSON.stringify(e)),ri.onPlaybackDeviceChanged&&ri.onPlaybackDeviceChanged(e),ri.safeEmit(Wo.PLAYBACK_DEVICE_CHANGED,e)}),pr.onAutoplayFailed=()=>{S.info("detect audio element autoplay failed"),rn.onAudioAutoplayFailed&&rn.onAudioAutoplayFailed()},dt.on("autoplay-failed",()=>{S.info("detect webaudio autoplay failed"),rn.onAudioAutoplayFailed&&rn.onAudioAutoplayFailed(),ri.safeEmit(Wo.AUTOPLAY_FAILED)}),dt.on(Oi.STATE_CHANGE,(e,t)=>{S.info("audio context state changed: ".concat(t," => ").concat(e)),ri.onAudioContextStateChanged&&ri.onAudioContextStateChanged(e,t),ri.safeEmit(Wo.AUDIO_CONTEXT_STATE_CHANGED,e,t)}),Vt.on(tc.NETWORK_STATE_CHANGE,(e,t)=>{S.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))}),window&&(window.__ARTC__=ri),ri})}),dV={};rQ(dV,{AgoraRTCProvider:()=>pV,AgoraRTCReactError:()=>Wr,AgoraRTCScreenShareProvider:()=>mQ,LocalAudioTrack:()=>TV,LocalUser:()=>IV,LocalVideoTrack:()=>CV,RemoteAudioTrack:()=>wV,RemoteUser:()=>OV,RemoteVideoTrack:()=>AV,TrackBoundary:()=>OQ,VERSION:()=>kQ,default:()=>bV,useAutoPlayAudioTrack:()=>cy,useAutoPlayVideoTrack:()=>ay,useClientEvent:()=>uQ,useConnectionState:()=>fQ,useCurrentUID:()=>EQ,useIsConnected:()=>Ms,useJoin:()=>_V,useLocalCameraTrack:()=>gV,useLocalMicrophoneTrack:()=>EV,useLocalScreenTrack:()=>wQ,useNetworkQuality:()=>gQ,usePublish:()=>fV,useRTCClient:()=>Do,useRTCScreenShareClient:()=>_Q,useRemoteAudioTracks:()=>CQ,useRemoteUserTrack:()=>lC,useRemoteUsers:()=>SV,useRemoteVideoTracks:()=>yQ,useTrackEvent:()=>hQ,useVolumeLevel:()=>TQ});var oQ=Wc(Hc());function Dr(s,c,h){return s.on(c,h),()=>s.off(c,h)}function sQ(s){try{return s()}catch(c){console.error(c)}}function Kc(s){return()=>s.forEach(sQ)}function aQ(s,c){let h=setInterval(s,c);return()=>clearInterval(h)}function Xf(s,c){let h=setTimeout(s,c);return()=>clearTimeout(h)}function oy(){let s,c,h;function _(){if(c){let W=c;c=void 0,W()}}async function g(){if(h){let W=h;h=void 0;try{await W()}catch(ee){console.error(ee)}}}async function v(W){s=!0,await g();try{h=await W()}catch(ee){console.error(ee)}s=!1,_()}async function b(){s=!0,await g(),s=!1,_()}function L(W){s?c=()=>v(W):v(W)}function x(){s?c=b:b()}return{run:L,dispose:x}}var Qf=typeof document<"u"?Ie.useLayoutEffect:Ie.useEffect;function cQ(s){return s!=null&&typeof s.then=="function"}function Ba(){let s=Ie.useRef(!1);return Ie.useEffect(()=>(s.current=!1,()=>{s.current=!0}),[]),s}function lQ(){let s=Ba();function c(h,_){return new Promise(async(g,v)=>{try{let b=await h;s.current||g(b)}catch(b){s.current?_&&_(b):v(b)}})}return Ie.useCallback(c,[s])}function uV(s){let c=lQ(),[h,_]=Ie.useState();return Qf(()=>{cQ(s)?c(s).then(_):_(s)},[s,c]),h}function zc(s,c){let h=Ie.useRef();Ie.useEffect(()=>{let{run:_,dispose:g}=h.current||(h.current=oy());return _(s),g},c)}function dQ(s,c){let h=s.split("."),_=c.split("."),g=Math.max(h.length,_.length);for(let v=0;v<g;v++){let b=parseInt(h[v]||"0"),L=parseInt(_[v]||"0");if(b>L)return 1;if(b<L)return-1}return 0}function uQ(s,c,h){let _=Ie.useRef(h);Qf(()=>{_.current=h},[h]),Ie.useEffect(()=>{if(s)return Dr(s,c,(...g)=>{_.current&&_.current(...g)})},[c,s])}function hQ(s,c,h){let _=Ie.useRef(h);Qf(()=>{_.current=h},[h]),Ie.useEffect(()=>{if(s)return Dr(s,c,(...g)=>{_.current&&_.current(...g)})},[c,s])}var hV=Ie.createContext(null);function pV({client:s,children:c}){return $e.jsx(hV.Provider,{value:s,children:c})}function pQ(s){let c=Ie.useContext(hV);return s||c}function Do(s){let c=pQ(s);if(!c)throw new Error("Agora RTC client not found. Should be wrapped in <AgoraRTCProvider value={client} />");return c}var mV=Ie.createContext(null);function mQ({client:s,children:c}){return $e.jsx(mV.Provider,{value:s,children:c})}function _Q(s){let c=Ie.useContext(mV);return s||c}function fQ(s){let c=Do(s),[h,_]=Ie.useState(c?c.connectionState:"DISCONNECTED");return Ie.useEffect(()=>{if(c){_(c.connectionState);let g;return Kc([Dr(c,"connection-state-change",v=>{g==null||g(),v==="CONNECTED"?g=Xf(()=>_(v),0):_(v)}),()=>g==null?void 0:g()])}else _("DISCONNECTED")},[c]),h}function Ms(s){let c=Do(s),[h,_]=Ie.useState(c?c.connectionState==="CONNECTED":!1);return Ie.useEffect(()=>{if(c){_(c.connectionState==="CONNECTED");let g;return Kc([Dr(c,"connection-state-change",v=>{g==null||g(),g=Xf(()=>_(v==="CONNECTED"),0)}),()=>g==null?void 0:g()])}else _(!1)},[c]),h}function EQ(s){let c=Do(s),[h,_]=Ie.useState(c==null?void 0:c.uid);return Ie.useEffect(()=>{if(c)return Dr(c,"connection-state-change",g=>{if(g==="CONNECTED")return Xf(()=>_(c.uid),0);g==="DISCONNECTED"&&_(void 0)})},[c]),h}var Wr=class extends Error{constructor(c,h){var s=(...args)=>{super(...args);lh(this,"rtcMethod");lh(this,"rtcError");lh(this,"name","AgoraRTCReactException")};s(typeof h=="string"?h:h.message),this.rtcMethod=c,this.rtcError=h}log(c){console[c](this)}};function _V(s,c=!0,h){let _=Do(h),g=Ms(h),v=Ie.useRef(),[b,L]=Ie.useState(!1),[x,W]=Ie.useState(0),[ee,K]=Ie.useState(null),$=Ba();return zc(async()=>{if($.current||(K(null),W(0),L(!1)),c&&_){try{$.current||L(!0);let{appid:le,channel:X,token:ve,uid:H}=typeof s=="function"?await s():s,G=await _.join(le,X,ve,H);$.current||W(G)}catch(le){console.error(le),$.current||K(new Wr("IAgoraRTCClient.join",le))}$.current||L(!1);let ge=v.current||(v.current=oy());return Kc([()=>{ge.dispose()},()=>{ge.run(()=>_.unpublish(_.localTracks))},()=>{for(let le of _.localTracks)le.isPlaying&&le.stop(),le.close();ge.run(()=>_.leave())}])}},[c,h]),{data:x,isLoading:b,isConnected:g,error:ee}}var qU=()=>({uplinkNetworkQuality:0,downlinkNetworkQuality:0,delay:0});function gQ(s){let c=Do(s),[h,_]=Ie.useState(qU);return Ie.useEffect(()=>{if(c)return Dr(c,"network-quality",g=>_({uplinkNetworkQuality:g.uplinkNetworkQuality,downlinkNetworkQuality:g.downlinkNetworkQuality,delay:c.getRTCStats().RTT??0}));_(qU())},[c]),h}var SQ=Wc(Hc());function fV(s,c=!0,h){let _=Do(h),g=Ms(h),v=Ie.useRef([]),[b,L]=Ie.useState(!1),[x,W]=Ie.useState(null),ee=Ba();return zc(async()=>{if(ee.current||(L(!1),W(null)),!_||!g||!c)return;let K=s.filter(Boolean),$=X=>{let ve=dQ(SQ.default.VERSION,"4.18.2")>=0;return ve||new Wr("usePublish","please check your agora-rtc-sdk-ng version in package.json, it's recommend upgrade to >= 4.18.2").log("warn"),ve?_.mode!=="live"||_.role!=="audience":!0},ge=X=>v.current.some(ve=>ve&&ve.getTrackId()===X.getTrackId()),le=X=>$()&&X.enabled&&c&&!ge(X);for(let X=0;X<K.length;X++){let ve=K[X];if(ve&&le(ve)){await _.unpublish(v.current.filter(H=>(H==null?void 0:H.trackMediaType)===ve.trackMediaType));try{ee.current||L(!0),await _.publish(ve)}catch(H){console.error(H),ee.current||W(new Wr("IAgoraRTCClient.publish",H))}ee.current||L(!1)}}v.current=K},[g,c,_,s]),{isLoading:b,error:x}}function TQ(s){let[c,h]=Ie.useState(0);return Ie.useEffect(()=>{if(s)return aQ(()=>{h(s.getVolumeLevel())},1e3)},[s]),c}var vQ=Wc(Hc());function EV(s=!0,c={ANS:!0,AEC:!0},h){let _=Ms(h),[g,v]=Ie.useState(null),[b,L]=Ie.useState(!1),[x,W]=Ie.useState(null),ee=Ba();return zc(async()=>{if(ee.current||(L(!1),W(null)),_&&s&&!g){try{ee.current||L(!0);let K=await vQ.default.createMicrophoneAudioTrack(c);ee.current||v(K)}catch(K){console.error(K),ee.current||W(new Wr("IAgoraRTC.createMicrophoneAudioTrack",K))}ee.current||L(!1)}!_&&!ee.current&&v(null)},[_,s]),{localMicrophoneTrack:g,isLoading:b,error:x}}var RQ=Wc(Hc());function gV(s=!0,c,h){let _=Ms(h),[g,v]=Ie.useState(null),[b,L]=Ie.useState(!1),[x,W]=Ie.useState(null),ee=Ba();return zc(async()=>{if(ee.current||(L(!1),W(null)),_&&s&&!g){try{ee.current||L(!0);let K=await RQ.default.createCameraVideoTrack(c);ee.current||v(K)}catch(K){console.error(K),ee.current||W(new Wr("IAgoraRTC.createCameraVideoTrack",K))}ee.current||L(!1)}!_&&!ee.current&&v(null)},[_,s]),{localCameraTrack:g,isLoading:b,error:x}}function CQ(s,c){let h=Do(c),[_,g]=Ie.useState([]),v=Ms(),b=Ie.useRef([]),[L,x]=Ie.useState(!1),[W,ee]=Ie.useState(null),K=Ba();return zc(async()=>{if(K.current||ee(null),!Array.isArray(s)||!v)return;let $=async X=>{if(!X.audioTrack&&s.some(({uid:ve})=>X.uid===ve)){try{K.current||x(!0),await h.subscribe(X,"audio")}catch(ve){console.error(ve),K.current||ee(new Wr("IAgoraRTCClient.subscribe",ve))}X.audioTrack&&!b.current.some(ve=>ve.getUserId()===X.uid)&&b.current.push(X.audioTrack),b.current=b.current.map(ve=>X.audioTrack&&ve.getUserId()===X.uid&&ve.getTrackId()!==X.audioTrack.getTrackId()?X.audioTrack:ve),K.current||(g([...b.current]),x(!1))}},ge=async X=>{if(s.some(({uid:ve})=>X.uid===ve)){K.current||(b.current=b.current.filter(ve=>ve.getUserId()!==X.uid),g([...b.current]));try{K.current||x(!0),await h.unsubscribe(X,"audio")}catch(ve){console.error(ve),K.current||ee(new Wr("IAgoraRTCClient.unsubscribe",ve))}K.current||x(!1)}};s.map(X=>{!X.audioTrack&&X.hasAudio&&$(X)});let le=[];for(let X=0;X<b.current.length;X++){let ve=b.current[X];if(!s.some(H=>H.uid===ve.getUserId())){let H=h.remoteUsers.find(G=>G.uid===ve.getUserId());H&&le.push({user:H,mediaType:"audio"}),b.current.splice(X,1),X--}}if(le.length>0){try{K.current||x(!0),await h.massUnsubscribe(le)}catch(X){console.error(X),K.current||ee(new Wr("IAgoraRTCClient.massUnsubscribe",X))}K.current||(g(b.current.slice()),x(!1))}return Kc([Dr(h,"user-published",(X,ve)=>{s.find(H=>H.uid===X.uid)&&ve==="audio"&&$(X)}),Dr(h,"user-unpublished",(X,ve)=>{s.find(H=>H.uid===X.uid)&&ve==="audio"&&ge(X)})])},[v,h,s]),{audioTracks:_,isLoading:L,error:W}}function yQ(s,c){let h=Do(c),[_,g]=Ie.useState([]),v=Ms(),b=Ie.useRef([]),[L,x]=Ie.useState(!1),[W,ee]=Ie.useState(null),K=Ba();return zc(async()=>{if(K.current||ee(null),!Array.isArray(s)||!v)return;let $=async X=>{if(!X.videoTrack&&s.some(({uid:ve})=>X.uid===ve)){try{K.current||x(!0),await h.subscribe(X,"video")}catch(ve){console.error(ve),K.current||ee(new Wr("IAgoraRTCClient.subscribe",ve))}X.videoTrack&&!b.current.some(ve=>ve.getUserId()===X.uid)&&b.current.push(X.videoTrack),b.current=b.current.map(ve=>X.videoTrack&&ve.getUserId()===X.uid&&ve.getTrackId()!==X.videoTrack.getTrackId()?X.videoTrack:ve),K.current||(g([...b.current]),x(!1))}},ge=async X=>{if(s.some(({uid:ve})=>X.uid===ve)){K.current||(b.current=b.current.filter(ve=>ve.getUserId()!==X.uid),g([...b.current]));try{K.current||x(!0),await h.unsubscribe(X,"video")}catch(ve){console.error(ve),K.current||ee(new Wr("IAgoraRTCClient.unsubscribe",ve))}K.current||x(!1)}};s.map(X=>{!X.videoTrack&&X.hasVideo&&$(X)});let le=[];for(let X=0;X<b.current.length;X++){let ve=b.current[X];if(!s.some(H=>H.uid===ve.getUserId())){let H=h.remoteUsers.find(G=>G.uid===ve.getUserId());H&&le.push({user:H,mediaType:"video"}),b.current.splice(X,1),X--}}if(le.length>0){try{K.current||x(!0),await h.massUnsubscribe(le)}catch(X){console.error(X),K.current||ee(new Wr("IAgoraRTCClient.massUnsubscribe",X))}K.current||(g(b.current.slice()),x(!1))}return Kc([Dr(h,"user-published",(X,ve)=>{s.find(H=>H.uid===X.uid)&&ve==="video"&&$(X)}),Dr(h,"user-unpublished",(X,ve)=>{s.find(H=>H.uid===X.uid)&&ve==="video"&&ge(X)})])},[v,h,s]),{videoTracks:_,isLoading:L,error:W}}function lC(s,c,h){let _=Do(h),g=c==="audio"?"audioTrack":"videoTrack",[v,b]=Ie.useState(s&&s[g]),L=Ms(),x=Ie.useRef(),[W,ee]=Ie.useState(!1),[K,$]=Ie.useState(null);return Ie.useEffect(()=>{if(!s||!L)return;let ge=!1;ge||$(null);let le=c==="audio"?"hasAudio":"hasVideo",X=s.uid,ve=async(q,Ee)=>{if(q[g]&&_.remoteUsers.some(({uid:we})=>q.uid===we))try{ge||ee(!0),await _.unsubscribe(q,Ee)}catch(we){ge||$(new Wr("IAgoraRTCClient.unsubscribe",we)),console.error(we)}ge||(b(void 0),ee(!1))},H=async(q,Ee)=>{try{!q[g]&&_.remoteUsers.some(({uid:we})=>q.uid===we)&&(ge||ee(!0),await _.subscribe(q,Ee)),ge||b(q[g])}catch(we){ge||$(new Wr("IAgoraRTCClient.subscribe",we)),console.error(we)}ge||ee(!1)},G=x.current||(x.current=oy());return!s[g]&&s[le]?G.run(()=>H(s,c)):b(s[g]),Kc([()=>{ge=!0,G.dispose()},Dr(_,"user-published",(q,Ee)=>{q.uid===X&&Ee===c&&G.run(()=>H(q,c))}),Dr(_,"user-unpublished",(q,Ee)=>{q.uid===X&&Ee===c&&G.run(()=>ve(q,c))})])},[L,_,s,c,g]),{track:v,isLoading:W,error:K}}function SV(s){let c=Do(s),[h,_]=Ie.useState(c?c.remoteUsers:[]);return Ie.useEffect(()=>{if(c){let g=()=>_(c.remoteUsers.slice());return Kc([Dr(c,"user-joined",g),Dr(c,"user-left",g),Dr(c,"user-published",g),Dr(c,"user-unpublished",g)])}},[c]),h}var IQ=Wc(Hc());function wQ(s=!0,c,h,_){let g=Ms(_),[v,b]=Ie.useState(null),[L,x]=Ie.useState(!1),[W,ee]=Ie.useState(null),K=Ba();return zc(async()=>{if(K.current||(x(!1),ee(null)),g&&s&&!v){try{K.current||x(!0);let $=await IQ.default.createScreenVideoTrack(c,h);K.current||b($)}catch($){console.error($),K.current||ee(new Wr("IAgoraRTC.createScreenVideoTrack",$))}K.current||x(!1)}(!g||!s)&&!K.current&&b(null)},[g,s]),{screenTrack:v,isLoading:L,error:W}}function AQ(){let s=new Map,c=1500;return{onMount:h=>{let _=s.get(h);_&&(_(),s.delete(h))},onUnmount:h=>{let _=s.get(h);_&&_(),s.set(h,Xf(()=>{h.isPlaying&&h.stop(),s.delete(h)},c))},dispose:()=>{for(let[h,_]of s)h.isPlaying&&h.stop(),_&&_();s.clear()}}}var sy=Ie.createContext(void 0);function OQ({children:s}){let[c]=Ie.useState(AQ);return Ie.useEffect(()=>c.dispose,[c]),$e.jsx(sy.Provider,{value:c,children:s})}function ay(s,c,h,_){let g=Ie.useContext(sy);Ie.useEffect(()=>{if(s)return _&&c?s.play(_,h||void 0):s.stop(),g?(g.onMount(s),()=>g.onUnmount(s)):()=>{s.isPlaying&&s.stop()}},[s,_,c,g,h])}function cy(s,c){let h=Ie.useContext(sy);Qf(()=>{if(s)return c?s.play():s.stop(),h?(h.onMount(s),()=>h.onUnmount(s)):()=>{s.isPlaying&&s.stop()}},[s,c,h])}function TV({track:s,play:c=!1,volume:h,disabled:_,muted:g,children:v}){let b=uV(s);return cy(b,c),Ie.useEffect(()=>{b&&h!=null&&b.setVolume(h)},[b,h]),Ie.useEffect(()=>{b&&_!=null&&b.setEnabled(!_).catch(console.warn)},[_,b]),Ie.useEffect(()=>{b&&g!=null&&b.setMuted(g).catch(console.warn)},[g,b]),v?$e.jsx($e.Fragment,{children:v}):null}var vV={position:"relative",width:"100%",height:"100%",overflow:"hidden",background:"#000"},RV={width:"100%",height:"100%"},ly={position:"absolute",top:0,left:0,width:"100%",height:"100%",overflow:"hidden",zIndex:2},Zf=(s,c)=>Ie.useMemo(()=>({...s,...c}),[s,c]);function CV({track:s,play:c,disabled:h,muted:_,style:g,videoPlayerConfig:v,...b}){let L=Zf(RV,g),[x,W]=Ie.useState(null),ee=uV(s);return ay(ee,c,v,x),Ie.useEffect(()=>{ee&&h!=null&&ee.setEnabled(!h).catch(console.warn)},[h,ee]),Ie.useEffect(()=>{ee&&_!=null&&ee.setMuted(_).catch(console.warn)},[_,ee]),$e.jsx("div",{...b,ref:W,style:L})}var bQ={width:"100%",height:"100%",background:"#1a1e21 center/cover no-repeat",filter:"blur(16px) brightness(0.4)"},NQ={position:"absolute",top:"50%",left:"50%",maxWidth:"50%",maxHeight:"50%",aspectRatio:"1",transform:"translate(-50%, -50%)",borderRadius:"50%",overflow:"hidden",objectFit:"cover"};function yV({cover:s}){return $e.jsx("div",{style:ly,children:typeof s=="string"?$e.jsxs($e.Fragment,{children:[$e.jsx("div",{style:{...bQ,backgroundImage:`url(${s})`}}),$e.jsx("img",{src:s,style:NQ})]}):s()})}function IV({micOn:s,cameraOn:c,audioTrack:h,videoTrack:_,playAudio:g,playVideo:v,volume:b,cover:L,children:x,style:W,...ee}){let K=Zf(vV,W);return v=v??!!c,g=g??!!s,$e.jsxs("div",{...ee,style:K,children:[$e.jsx(CV,{disabled:!c,play:v,track:_}),$e.jsx(TV,{disabled:!s,play:g,track:h,volume:b}),L&&!c&&$e.jsx(yV,{cover:L}),$e.jsx("div",{style:ly,children:x})]})}function wV({track:s,play:c=!1,playbackDeviceId:h,volume:_,children:g}){return cy(s,c),Ie.useEffect(()=>{s&&h!=null&&s.setPlaybackDevice(h).catch(console.warn)},[s,h]),Ie.useEffect(()=>{s&&_!=null&&s.setVolume(_)},[s,_]),g?$e.jsx($e.Fragment,{children:g}):null}function AV({track:s,play:c,style:h,videoPlayerConfig:_,...g}){let v=Zf(RV,h),[b,L]=Ie.useState(null);return ay(s,c,_,b),$e.jsx("div",{...g,ref:L,style:v})}function OV({user:s,playVideo:c,playAudio:h,playbackDeviceId:_,volume:g,cover:v,style:b,children:L,videoPlayerConfig:x,...W}){let ee=Zf(vV,b),{track:K}=lC(s,"video"),{track:$}=lC(s,"audio");return c=c??(s==null?void 0:s.hasVideo),h=h??(s==null?void 0:s.hasAudio),$e.jsxs("div",{...W,style:ee,children:[$e.jsx(AV,{play:c,track:K,videoPlayerConfig:x}),$e.jsx(wV,{play:h,playbackDeviceId:_,track:$,volume:g}),v&&!c&&$e.jsx(yV,{cover:v}),$e.jsx("div",{style:ly,children:L})]})}var DQ=Wc(Hc()),PQ=class{constructor(){lh(this,"appType",1001);DQ.default.setAppType(this.appType)}};new PQ;var kQ="2.2.0";nQ(dV,Wc(Hc()));var bV=oQ.default;/*! Bundled license information:

agora-rtc-sdk-ng/AgoraRTC_N-production.js:
  (*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> *)
*/const LQ="5634944c8a88556f84e824bf36fcf12a",MQ=new TextEncoder;function UQ(s){const c=LQ.split(""),h=MQ.encode(s);return Array.from({length:32},(_,g)=>{const v=h[g]?h[g]%c.length:0,b=c[v];return c.splice(v,1),b}).join("")}const xQ="https://gcore.jsdelivr.net/gh/ommyzhang/our-call@gh-pages/assets/mao-efc5f358.png",VQ="https://gcore.jsdelivr.net/gh/ommyzhang/our-call@gh-pages/assets/ji-47ca8d8e.png";const FQ=()=>{const[s,c]=Ie.useState(!1),[h,_]=Ie.useState(""),[g,v]=Ie.useState("123"),b=s?UQ(h):"",L=_V({appid:b,channel:g,token:null},s),[x,W]=Ie.useState(!0),[ee,K]=Ie.useState(!0),{localMicrophoneTrack:$}=EV(x),{localCameraTrack:ge}=gV(ee),le=SV();return fV([$,ge]),$e.jsxs("div",{className:"our-call",children:[$e.jsx("div",{className:"header",children:"OUR CALL"}),L.isConnected?$e.jsxs("div",{className:"room",children:[$e.jsxs("div",{className:"user-list",children:[$e.jsx("div",{className:"user",children:$e.jsx(IV,{cameraOn:ee,micOn:x,videoTrack:ge,cover:VQ,children:$e.jsx("samp",{className:"user-name",children:"You"})})}),le.map(X=>$e.jsx("div",{className:"user",children:$e.jsx(OV,{cover:xQ,user:X})},X.uid))]}),$e.jsxs("div",{className:"control",children:[$e.jsxs("div",{className:"left-control",children:[$e.jsx("div",{onClick:()=>W(X=>!X),className:`microphone ${x?"":"off"}`}),$e.jsx("div",{onClick:()=>K(X=>!X),className:`camera ${ee?"":"off"}`})]}),$e.jsx("div",{onClick:()=>c(X=>!X),className:`phone ${s?"":"off"}`})]})]}):$e.jsxs("div",{className:"join",children:[$e.jsxs("div",{className:"input",children:[$e.jsx("label",{children:"CHANNEL"}),$e.jsx("input",{onChange:X=>v(X.target.value),placeholder:"Your channel Name",value:g})]}),$e.jsxs("div",{className:"input",children:[$e.jsx("label",{children:"KEY"}),$e.jsx("input",{onKeyDown:X=>{X.key==="Enter"&&(c(!0),X.stopPropagation())},onChange:X=>{c(!1),_(X.target.value)},placeholder:"请输入密钥",value:h})]}),$e.jsx("button",{className:`join-channel ${!h||!g?"disabled":""}`,disabled:!h||!g||s,onClick:()=>c(!0),children:$e.jsxs("span",{children:["    ",s?L.isLoading?"芝麻努力开门 ing":L.error?"密钥有误":"?":"芝麻开门！"]})})]})]})},jQ=bV.createClient({mode:"rtc",codec:"vp8"});fR.createRoot(document.getElementById("root")).render($e.jsx(F7.StrictMode,{children:$e.jsx(pV,{client:jQ,children:$e.jsx(FQ,{})})}));
