function kw(e,t){for(var n=0;n<t.length;n++){const i=t[n];if(typeof i!="string"&&!Array.isArray(i)){for(const r in i)if(r!=="default"&&!(r in e)){const o=Object.getOwnPropertyDescriptor(i,r);o&&Object.defineProperty(e,r,o.get?o:{enumerable:!0,get:()=>i[r]})}}}return Object.freeze(Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}))}(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();var Qp=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function Pf(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var dv={exports:{}},ju={},lv={exports:{}},We={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Id=Symbol.for("react.element"),Mw=Symbol.for("react.portal"),Uw=Symbol.for("react.fragment"),xw=Symbol.for("react.strict_mode"),Vw=Symbol.for("react.profiler"),Fw=Symbol.for("react.provider"),Bw=Symbol.for("react.context"),Gw=Symbol.for("react.forward_ref"),jw=Symbol.for("react.suspense"),Ww=Symbol.for("react.memo"),Hw=Symbol.for("react.lazy"),pm=Symbol.iterator;function Kw(e){return e===null||typeof e!="object"?null:(e=pm&&e[pm]||e["@@iterator"],typeof e=="function"?e:null)}var uv={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},hv=Object.assign,pv={};function Ma(e,t,n){this.props=e,this.context=t,this.refs=pv,this.updater=n||uv}Ma.prototype.isReactComponent={};Ma.prototype.setState=function(e,t){if(typeof e!="object"&&typeof e!="function"&&e!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,e,t,"setState")};Ma.prototype.forceUpdate=function(e){this.updater.enqueueForceUpdate(this,e,"forceUpdate")};function _v(){}_v.prototype=Ma.prototype;function Lf(e,t,n){this.props=e,this.context=t,this.refs=pv,this.updater=n||uv}var kf=Lf.prototype=new _v;kf.constructor=Lf;hv(kf,Ma.prototype);kf.isPureReactComponent=!0;var _m=Array.isArray,fv=Object.prototype.hasOwnProperty,Mf={current:null},Ev={key:!0,ref:!0,__self:!0,__source:!0};function mv(e,t,n){var i,r={},o=null,s=null;if(t!=null)for(i in t.ref!==void 0&&(s=t.ref),t.key!==void 0&&(o=""+t.key),t)fv.call(t,i)&&!Ev.hasOwnProperty(i)&&(r[i]=t[i]);var a=arguments.length-2;if(a===1)r.children=n;else if(1<a){for(var c=Array(a),d=0;d<a;d++)c[d]=arguments[d+2];r.children=c}if(e&&e.defaultProps)for(i in a=e.defaultProps,a)r[i]===void 0&&(r[i]=a[i]);return{$$typeof:Id,type:e,key:o,ref:s,props:r,_owner:Mf.current}}function zw(e,t){return{$$typeof:Id,type:e.type,key:t,ref:e.ref,props:e.props,_owner:e._owner}}function Uf(e){return typeof e=="object"&&e!==null&&e.$$typeof===Id}function Yw(e){var t={"=":"=0",":":"=2"};return"$"+e.replace(/[=:]/g,function(n){return t[n]})}var fm=/\/+/g;function Dh(e,t){return typeof e=="object"&&e!==null&&e.key!=null?Yw(""+e.key):t.toString(36)}function Il(e,t,n,i,r){var o=typeof e;(o==="undefined"||o==="boolean")&&(e=null);var s=!1;if(e===null)s=!0;else switch(o){case"string":case"number":s=!0;break;case"object":switch(e.$$typeof){case Id:case Mw:s=!0}}if(s)return s=e,r=r(s),e=i===""?"."+Dh(s,0):i,_m(r)?(n="",e!=null&&(n=e.replace(fm,"$&/")+"/"),Il(r,t,n,"",function(d){return d})):r!=null&&(Uf(r)&&(r=zw(r,n+(!r.key||s&&s.key===r.key?"":(""+r.key).replace(fm,"$&/")+"/")+e)),t.push(r)),1;if(s=0,i=i===""?".":i+":",_m(e))for(var a=0;a<e.length;a++){o=e[a];var c=i+Dh(o,a);s+=Il(o,t,n,c,r)}else if(c=Kw(e),typeof c=="function")for(e=c.call(e),a=0;!(o=e.next()).done;)o=o.value,c=i+Dh(o,a++),s+=Il(o,t,n,c,r);else if(o==="object")throw t=String(e),Error("Objects are not valid as a React child (found: "+(t==="[object Object]"?"object with keys {"+Object.keys(e).join(", ")+"}":t)+"). If you meant to render a collection of children, use an array instead.");return s}function Fd(e,t,n){if(e==null)return e;var i=[],r=0;return Il(e,i,"","",function(o){return t.call(n,o,r++)}),i}function $w(e){if(e._status===-1){var t=e._result;t=t(),t.then(function(n){(e._status===0||e._status===-1)&&(e._status=1,e._result=n)},function(n){(e._status===0||e._status===-1)&&(e._status=2,e._result=n)}),e._status===-1&&(e._status=0,e._result=t)}if(e._status===1)return e._result.default;throw e._result}var Kn={current:null},yl={transition:null},qw={ReactCurrentDispatcher:Kn,ReactCurrentBatchConfig:yl,ReactCurrentOwner:Mf};function gv(){throw Error("act(...) is not supported in production builds of React.")}We.Children={map:Fd,forEach:function(e,t,n){Fd(e,function(){t.apply(this,arguments)},n)},count:function(e){var t=0;return Fd(e,function(){t++}),t},toArray:function(e){return Fd(e,function(t){return t})||[]},only:function(e){if(!Uf(e))throw Error("React.Children.only expected to receive a single React element child.");return e}};We.Component=Ma;We.Fragment=Uw;We.Profiler=Vw;We.PureComponent=Lf;We.StrictMode=xw;We.Suspense=jw;We.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=qw;We.act=gv;We.cloneElement=function(e,t,n){if(e==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+e+".");var i=hv({},e.props),r=e.key,o=e.ref,s=e._owner;if(t!=null){if(t.ref!==void 0&&(o=t.ref,s=Mf.current),t.key!==void 0&&(r=""+t.key),e.type&&e.type.defaultProps)var a=e.type.defaultProps;for(c in t)fv.call(t,c)&&!Ev.hasOwnProperty(c)&&(i[c]=t[c]===void 0&&a!==void 0?a[c]:t[c])}var c=arguments.length-2;if(c===1)i.children=n;else if(1<c){a=Array(c);for(var d=0;d<c;d++)a[d]=arguments[d+2];i.children=a}return{$$typeof:Id,type:e.type,key:r,ref:o,props:i,_owner:s}};We.createContext=function(e){return e={$$typeof:Bw,_currentValue:e,_currentValue2:e,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},e.Provider={$$typeof:Fw,_context:e},e.Consumer=e};We.createElement=mv;We.createFactory=function(e){var t=mv.bind(null,e);return t.type=e,t};We.createRef=function(){return{current:null}};We.forwardRef=function(e){return{$$typeof:Gw,render:e}};We.isValidElement=Uf;We.lazy=function(e){return{$$typeof:Hw,_payload:{_status:-1,_result:e},_init:$w}};We.memo=function(e,t){return{$$typeof:Ww,type:e,compare:t===void 0?null:t}};We.startTransition=function(e){var t=yl.transition;yl.transition={};try{e()}finally{yl.transition=t}};We.unstable_act=gv;We.useCallback=function(e,t){return Kn.current.useCallback(e,t)};We.useContext=function(e){return Kn.current.useContext(e)};We.useDebugValue=function(){};We.useDeferredValue=function(e){return Kn.current.useDeferredValue(e)};We.useEffect=function(e,t){return Kn.current.useEffect(e,t)};We.useId=function(){return Kn.current.useId()};We.useImperativeHandle=function(e,t,n){return Kn.current.useImperativeHandle(e,t,n)};We.useInsertionEffect=function(e,t){return Kn.current.useInsertionEffect(e,t)};We.useLayoutEffect=function(e,t){return Kn.current.useLayoutEffect(e,t)};We.useMemo=function(e,t){return Kn.current.useMemo(e,t)};We.useReducer=function(e,t,n){return Kn.current.useReducer(e,t,n)};We.useRef=function(e){return Kn.current.useRef(e)};We.useState=function(e){return Kn.current.useState(e)};We.useSyncExternalStore=function(e,t,n){return Kn.current.useSyncExternalStore(e,t,n)};We.useTransition=function(){return Kn.current.useTransition()};We.version="18.3.1";lv.exports=We;var zi=lv.exports;const Jw=Pf(zi);/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Xw=zi,Qw=Symbol.for("react.element"),Zw=Symbol.for("react.fragment"),eN=Object.prototype.hasOwnProperty,tN=Xw.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,nN={key:!0,ref:!0,__self:!0,__source:!0};function Sv(e,t,n){var i,r={},o=null,s=null;n!==void 0&&(o=""+n),t.key!==void 0&&(o=""+t.key),t.ref!==void 0&&(s=t.ref);for(i in t)eN.call(t,i)&&!nN.hasOwnProperty(i)&&(r[i]=t[i]);if(e&&e.defaultProps)for(i in t=e.defaultProps,t)r[i]===void 0&&(r[i]=t[i]);return{$$typeof:Qw,type:e,key:o,ref:s,props:r,_owner:tN.current}}ju.Fragment=Zw;ju.jsx=Sv;ju.jsxs=Sv;dv.exports=ju;var en=dv.exports,Zp={},Tv={exports:{}},Si={},Rv={exports:{}},Cv={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */(function(e){function t(te,le){var V=te.length;te.push(le);e:for(;0<V;){var _=V-1>>>1,R=te[_];if(0<r(R,le))te[_]=le,te[V]=R,V=_;else break e}}function n(te){return te.length===0?null:te[0]}function i(te){if(te.length===0)return null;var le=te[0],V=te.pop();if(V!==le){te[0]=V;e:for(var _=0,R=te.length,v=R>>>1;_<v;){var b=2*(_+1)-1,K=te[b],re=b+1,Ne=te[re];if(0>r(K,V))re<R&&0>r(Ne,K)?(te[_]=Ne,te[re]=V,_=re):(te[_]=K,te[b]=V,_=b);else if(re<R&&0>r(Ne,V))te[_]=Ne,te[re]=V,_=re;else break e}}return le}function r(te,le){var V=te.sortIndex-le.sortIndex;return V!==0?V:te.id-le.id}if(typeof performance=="object"&&typeof performance.now=="function"){var o=performance;e.unstable_now=function(){return o.now()}}else{var s=Date,a=s.now();e.unstable_now=function(){return s.now()-a}}var c=[],d=[],l=1,u=null,h=3,p=!1,m=!1,E=!1,g=typeof setTimeout=="function"?setTimeout:null,S=typeof clearTimeout=="function"?clearTimeout:null,T=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function I(te){for(var le=n(d);le!==null;){if(le.callback===null)i(d);else if(le.startTime<=te)i(d),le.sortIndex=le.expirationTime,t(c,le);else break;le=n(d)}}function y(te){if(E=!1,I(te),!m)if(n(c)!==null)m=!0,Lt(w);else{var le=n(d);le!==null&&mt(y,le.startTime-te)}}function w(te,le){m=!1,E&&(E=!1,S(P),P=-1),p=!0;var V=h;try{for(I(le),u=n(c);u!==null&&(!(u.expirationTime>le)||te&&!J());){var _=u.callback;if(typeof _=="function"){u.callback=null,h=u.priorityLevel;var R=_(u.expirationTime<=le);le=e.unstable_now(),typeof R=="function"?u.callback=R:u===n(c)&&i(c),I(le)}else i(c);u=n(c)}if(u!==null)var v=!0;else{var b=n(d);b!==null&&mt(y,b.startTime-le),v=!1}return v}finally{u=null,h=V,p=!1}}var D=!1,O=null,P=-1,x=5,U=-1;function J(){return!(e.unstable_now()-U<x)}function Le(){if(O!==null){var te=e.unstable_now();U=te;var le=!0;try{le=O(!0,te)}finally{le?Be():(D=!1,O=null)}}else D=!1}var Be;if(typeof T=="function")Be=function(){T(Le)};else if(typeof MessageChannel<"u"){var ot=new MessageChannel,vt=ot.port2;ot.port1.onmessage=Le,Be=function(){vt.postMessage(null)}}else Be=function(){g(Le,0)};function Lt(te){O=te,D||(D=!0,Be())}function mt(te,le){P=g(function(){te(e.unstable_now())},le)}e.unstable_IdlePriority=5,e.unstable_ImmediatePriority=1,e.unstable_LowPriority=4,e.unstable_NormalPriority=3,e.unstable_Profiling=null,e.unstable_UserBlockingPriority=2,e.unstable_cancelCallback=function(te){te.callback=null},e.unstable_continueExecution=function(){m||p||(m=!0,Lt(w))},e.unstable_forceFrameRate=function(te){0>te||125<te?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):x=0<te?Math.floor(1e3/te):5},e.unstable_getCurrentPriorityLevel=function(){return h},e.unstable_getFirstCallbackNode=function(){return n(c)},e.unstable_next=function(te){switch(h){case 1:case 2:case 3:var le=3;break;default:le=h}var V=h;h=le;try{return te()}finally{h=V}},e.unstable_pauseExecution=function(){},e.unstable_requestPaint=function(){},e.unstable_runWithPriority=function(te,le){switch(te){case 1:case 2:case 3:case 4:case 5:break;default:te=3}var V=h;h=te;try{return le()}finally{h=V}},e.unstable_scheduleCallback=function(te,le,V){var _=e.unstable_now();switch(typeof V=="object"&&V!==null?(V=V.delay,V=typeof V=="number"&&0<V?_+V:_):V=_,te){case 1:var R=-1;break;case 2:R=250;break;case 5:R=1073741823;break;case 4:R=1e4;break;default:R=5e3}return R=V+R,te={id:l++,callback:le,priorityLevel:te,startTime:V,expirationTime:R,sortIndex:-1},V>_?(te.sortIndex=V,t(d,te),n(c)===null&&te===n(d)&&(E?(S(P),P=-1):E=!0,mt(y,V-_))):(te.sortIndex=R,t(c,te),m||p||(m=!0,Lt(w))),te},e.unstable_shouldYield=J,e.unstable_wrapCallback=function(te){var le=h;return function(){var V=h;h=le;try{return te.apply(this,arguments)}finally{h=V}}}})(Cv);Rv.exports=Cv;var iN=Rv.exports;/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var rN=zi,gi=iN;function X(e){for(var t="https://reactjs.org/docs/error-decoder.html?invariant="+e,n=1;n<arguments.length;n++)t+="&args[]="+encodeURIComponent(arguments[n]);return"Minified React error #"+e+"; visit "+t+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var vv=new Set,Bc={};function ys(e,t){ga(e,t),ga(e+"Capture",t)}function ga(e,t){for(Bc[e]=t,e=0;e<t.length;e++)vv.add(t[e])}var Hr=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),e_=Object.prototype.hasOwnProperty,oN=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,Em={},mm={};function sN(e){return e_.call(mm,e)?!0:e_.call(Em,e)?!1:oN.test(e)?mm[e]=!0:(Em[e]=!0,!1)}function aN(e,t,n,i){if(n!==null&&n.type===0)return!1;switch(typeof t){case"function":case"symbol":return!0;case"boolean":return i?!1:n!==null?!n.acceptsBooleans:(e=e.toLowerCase().slice(0,5),e!=="data-"&&e!=="aria-");default:return!1}}function cN(e,t,n,i){if(t===null||typeof t>"u"||aN(e,t,n,i))return!0;if(i)return!1;if(n!==null)switch(n.type){case 3:return!t;case 4:return t===!1;case 5:return isNaN(t);case 6:return isNaN(t)||1>t}return!1}function zn(e,t,n,i,r,o,s){this.acceptsBooleans=t===2||t===3||t===4,this.attributeName=i,this.attributeNamespace=r,this.mustUseProperty=n,this.propertyName=e,this.type=t,this.sanitizeURL=o,this.removeEmptyString=s}var wn={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(e){wn[e]=new zn(e,0,!1,e,null,!1,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(e){var t=e[0];wn[t]=new zn(t,1,!1,e[1],null,!1,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(e){wn[e]=new zn(e,2,!1,e.toLowerCase(),null,!1,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(e){wn[e]=new zn(e,2,!1,e,null,!1,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(e){wn[e]=new zn(e,3,!1,e.toLowerCase(),null,!1,!1)});["checked","multiple","muted","selected"].forEach(function(e){wn[e]=new zn(e,3,!0,e,null,!1,!1)});["capture","download"].forEach(function(e){wn[e]=new zn(e,4,!1,e,null,!1,!1)});["cols","rows","size","span"].forEach(function(e){wn[e]=new zn(e,6,!1,e,null,!1,!1)});["rowSpan","start"].forEach(function(e){wn[e]=new zn(e,5,!1,e.toLowerCase(),null,!1,!1)});var xf=/[\-:]([a-z])/g;function Vf(e){return e[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(e){var t=e.replace(xf,Vf);wn[t]=new zn(t,1,!1,e,null,!1,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(e){var t=e.replace(xf,Vf);wn[t]=new zn(t,1,!1,e,"http://www.w3.org/1999/xlink",!1,!1)});["xml:base","xml:lang","xml:space"].forEach(function(e){var t=e.replace(xf,Vf);wn[t]=new zn(t,1,!1,e,"http://www.w3.org/XML/1998/namespace",!1,!1)});["tabIndex","crossOrigin"].forEach(function(e){wn[e]=new zn(e,1,!1,e.toLowerCase(),null,!1,!1)});wn.xlinkHref=new zn("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1);["src","href","action","formAction"].forEach(function(e){wn[e]=new zn(e,1,!1,e.toLowerCase(),null,!0,!0)});function Ff(e,t,n,i){var r=wn.hasOwnProperty(t)?wn[t]:null;(r!==null?r.type!==0:i||!(2<t.length)||t[0]!=="o"&&t[0]!=="O"||t[1]!=="n"&&t[1]!=="N")&&(cN(t,n,r,i)&&(n=null),i||r===null?sN(t)&&(n===null?e.removeAttribute(t):e.setAttribute(t,""+n)):r.mustUseProperty?e[r.propertyName]=n===null?r.type===3?!1:"":n:(t=r.attributeName,i=r.attributeNamespace,n===null?e.removeAttribute(t):(r=r.type,n=r===3||r===4&&n===!0?"":""+n,i?e.setAttributeNS(i,t,n):e.setAttribute(t,n))))}var $r=rN.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,Bd=Symbol.for("react.element"),Hs=Symbol.for("react.portal"),Ks=Symbol.for("react.fragment"),Bf=Symbol.for("react.strict_mode"),t_=Symbol.for("react.profiler"),Iv=Symbol.for("react.provider"),yv=Symbol.for("react.context"),Gf=Symbol.for("react.forward_ref"),n_=Symbol.for("react.suspense"),i_=Symbol.for("react.suspense_list"),jf=Symbol.for("react.memo"),so=Symbol.for("react.lazy"),Av=Symbol.for("react.offscreen"),gm=Symbol.iterator;function Ja(e){return e===null||typeof e!="object"?null:(e=gm&&e[gm]||e["@@iterator"],typeof e=="function"?e:null)}var Yt=Object.assign,Ph;function pc(e){if(Ph===void 0)try{throw Error()}catch(n){var t=n.stack.trim().match(/\n( *(at )?)/);Ph=t&&t[1]||""}return`
`+Ph+e}var Lh=!1;function kh(e,t){if(!e||Lh)return"";Lh=!0;var n=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(t)if(t=function(){throw Error()},Object.defineProperty(t.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(t,[])}catch(d){var i=d}Reflect.construct(e,[],t)}else{try{t.call()}catch(d){i=d}e.call(t.prototype)}else{try{throw Error()}catch(d){i=d}e()}}catch(d){if(d&&i&&typeof d.stack=="string"){for(var r=d.stack.split(`
`),o=i.stack.split(`
`),s=r.length-1,a=o.length-1;1<=s&&0<=a&&r[s]!==o[a];)a--;for(;1<=s&&0<=a;s--,a--)if(r[s]!==o[a]){if(s!==1||a!==1)do if(s--,a--,0>a||r[s]!==o[a]){var c=`
`+r[s].replace(" at new "," at ");return e.displayName&&c.includes("<anonymous>")&&(c=c.replace("<anonymous>",e.displayName)),c}while(1<=s&&0<=a);break}}}finally{Lh=!1,Error.prepareStackTrace=n}return(e=e?e.displayName||e.name:"")?pc(e):""}function dN(e){switch(e.tag){case 5:return pc(e.type);case 16:return pc("Lazy");case 13:return pc("Suspense");case 19:return pc("SuspenseList");case 0:case 2:case 15:return e=kh(e.type,!1),e;case 11:return e=kh(e.type.render,!1),e;case 1:return e=kh(e.type,!0),e;default:return""}}function r_(e){if(e==null)return null;if(typeof e=="function")return e.displayName||e.name||null;if(typeof e=="string")return e;switch(e){case Ks:return"Fragment";case Hs:return"Portal";case t_:return"Profiler";case Bf:return"StrictMode";case n_:return"Suspense";case i_:return"SuspenseList"}if(typeof e=="object")switch(e.$$typeof){case yv:return(e.displayName||"Context")+".Consumer";case Iv:return(e._context.displayName||"Context")+".Provider";case Gf:var t=e.render;return e=e.displayName,e||(e=t.displayName||t.name||"",e=e!==""?"ForwardRef("+e+")":"ForwardRef"),e;case jf:return t=e.displayName||null,t!==null?t:r_(e.type)||"Memo";case so:t=e._payload,e=e._init;try{return r_(e(t))}catch{}}return null}function lN(e){var t=e.type;switch(e.tag){case 24:return"Cache";case 9:return(t.displayName||"Context")+".Consumer";case 10:return(t._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return e=t.render,e=e.displayName||e.name||"",t.displayName||(e!==""?"ForwardRef("+e+")":"ForwardRef");case 7:return"Fragment";case 5:return t;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return r_(t);case 8:return t===Bf?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof t=="function")return t.displayName||t.name||null;if(typeof t=="string")return t}return null}function Po(e){switch(typeof e){case"boolean":case"number":case"string":case"undefined":return e;case"object":return e;default:return""}}function wv(e){var t=e.type;return(e=e.nodeName)&&e.toLowerCase()==="input"&&(t==="checkbox"||t==="radio")}function uN(e){var t=wv(e)?"checked":"value",n=Object.getOwnPropertyDescriptor(e.constructor.prototype,t),i=""+e[t];if(!e.hasOwnProperty(t)&&typeof n<"u"&&typeof n.get=="function"&&typeof n.set=="function"){var r=n.get,o=n.set;return Object.defineProperty(e,t,{configurable:!0,get:function(){return r.call(this)},set:function(s){i=""+s,o.call(this,s)}}),Object.defineProperty(e,t,{enumerable:n.enumerable}),{getValue:function(){return i},setValue:function(s){i=""+s},stopTracking:function(){e._valueTracker=null,delete e[t]}}}}function Gd(e){e._valueTracker||(e._valueTracker=uN(e))}function Nv(e){if(!e)return!1;var t=e._valueTracker;if(!t)return!0;var n=t.getValue(),i="";return e&&(i=wv(e)?e.checked?"true":"false":e.value),e=i,e!==n?(t.setValue(e),!0):!1}function nu(e){if(e=e||(typeof document<"u"?document:void 0),typeof e>"u")return null;try{return e.activeElement||e.body}catch{return e.body}}function o_(e,t){var n=t.checked;return Yt({},t,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:n??e._wrapperState.initialChecked})}function Sm(e,t){var n=t.defaultValue==null?"":t.defaultValue,i=t.checked!=null?t.checked:t.defaultChecked;n=Po(t.value!=null?t.value:n),e._wrapperState={initialChecked:i,initialValue:n,controlled:t.type==="checkbox"||t.type==="radio"?t.checked!=null:t.value!=null}}function Ov(e,t){t=t.checked,t!=null&&Ff(e,"checked",t,!1)}function s_(e,t){Ov(e,t);var n=Po(t.value),i=t.type;if(n!=null)i==="number"?(n===0&&e.value===""||e.value!=n)&&(e.value=""+n):e.value!==""+n&&(e.value=""+n);else if(i==="submit"||i==="reset"){e.removeAttribute("value");return}t.hasOwnProperty("value")?a_(e,t.type,n):t.hasOwnProperty("defaultValue")&&a_(e,t.type,Po(t.defaultValue)),t.checked==null&&t.defaultChecked!=null&&(e.defaultChecked=!!t.defaultChecked)}function Tm(e,t,n){if(t.hasOwnProperty("value")||t.hasOwnProperty("defaultValue")){var i=t.type;if(!(i!=="submit"&&i!=="reset"||t.value!==void 0&&t.value!==null))return;t=""+e._wrapperState.initialValue,n||t===e.value||(e.value=t),e.defaultValue=t}n=e.name,n!==""&&(e.name=""),e.defaultChecked=!!e._wrapperState.initialChecked,n!==""&&(e.name=n)}function a_(e,t,n){(t!=="number"||nu(e.ownerDocument)!==e)&&(n==null?e.defaultValue=""+e._wrapperState.initialValue:e.defaultValue!==""+n&&(e.defaultValue=""+n))}var _c=Array.isArray;function oa(e,t,n,i){if(e=e.options,t){t={};for(var r=0;r<n.length;r++)t["$"+n[r]]=!0;for(n=0;n<e.length;n++)r=t.hasOwnProperty("$"+e[n].value),e[n].selected!==r&&(e[n].selected=r),r&&i&&(e[n].defaultSelected=!0)}else{for(n=""+Po(n),t=null,r=0;r<e.length;r++){if(e[r].value===n){e[r].selected=!0,i&&(e[r].defaultSelected=!0);return}t!==null||e[r].disabled||(t=e[r])}t!==null&&(t.selected=!0)}}function c_(e,t){if(t.dangerouslySetInnerHTML!=null)throw Error(X(91));return Yt({},t,{value:void 0,defaultValue:void 0,children:""+e._wrapperState.initialValue})}function Rm(e,t){var n=t.value;if(n==null){if(n=t.children,t=t.defaultValue,n!=null){if(t!=null)throw Error(X(92));if(_c(n)){if(1<n.length)throw Error(X(93));n=n[0]}t=n}t==null&&(t=""),n=t}e._wrapperState={initialValue:Po(n)}}function bv(e,t){var n=Po(t.value),i=Po(t.defaultValue);n!=null&&(n=""+n,n!==e.value&&(e.value=n),t.defaultValue==null&&e.defaultValue!==n&&(e.defaultValue=n)),i!=null&&(e.defaultValue=""+i)}function Cm(e){var t=e.textContent;t===e._wrapperState.initialValue&&t!==""&&t!==null&&(e.value=t)}function Dv(e){switch(e){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function d_(e,t){return e==null||e==="http://www.w3.org/1999/xhtml"?Dv(t):e==="http://www.w3.org/2000/svg"&&t==="foreignObject"?"http://www.w3.org/1999/xhtml":e}var jd,Pv=function(e){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(t,n,i,r){MSApp.execUnsafeLocalFunction(function(){return e(t,n,i,r)})}:e}(function(e,t){if(e.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in e)e.innerHTML=t;else{for(jd=jd||document.createElement("div"),jd.innerHTML="<svg>"+t.valueOf().toString()+"</svg>",t=jd.firstChild;e.firstChild;)e.removeChild(e.firstChild);for(;t.firstChild;)e.appendChild(t.firstChild)}});function Gc(e,t){if(t){var n=e.firstChild;if(n&&n===e.lastChild&&n.nodeType===3){n.nodeValue=t;return}}e.textContent=t}var yc={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},hN=["Webkit","ms","Moz","O"];Object.keys(yc).forEach(function(e){hN.forEach(function(t){t=t+e.charAt(0).toUpperCase()+e.substring(1),yc[t]=yc[e]})});function Lv(e,t,n){return t==null||typeof t=="boolean"||t===""?"":n||typeof t!="number"||t===0||yc.hasOwnProperty(e)&&yc[e]?(""+t).trim():t+"px"}function kv(e,t){e=e.style;for(var n in t)if(t.hasOwnProperty(n)){var i=n.indexOf("--")===0,r=Lv(n,t[n],i);n==="float"&&(n="cssFloat"),i?e.setProperty(n,r):e[n]=r}}var pN=Yt({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function l_(e,t){if(t){if(pN[e]&&(t.children!=null||t.dangerouslySetInnerHTML!=null))throw Error(X(137,e));if(t.dangerouslySetInnerHTML!=null){if(t.children!=null)throw Error(X(60));if(typeof t.dangerouslySetInnerHTML!="object"||!("__html"in t.dangerouslySetInnerHTML))throw Error(X(61))}if(t.style!=null&&typeof t.style!="object")throw Error(X(62))}}function u_(e,t){if(e.indexOf("-")===-1)return typeof t.is=="string";switch(e){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var h_=null;function Wf(e){return e=e.target||e.srcElement||window,e.correspondingUseElement&&(e=e.correspondingUseElement),e.nodeType===3?e.parentNode:e}var p_=null,sa=null,aa=null;function vm(e){if(e=wd(e)){if(typeof p_!="function")throw Error(X(280));var t=e.stateNode;t&&(t=Yu(t),p_(e.stateNode,e.type,t))}}function Mv(e){sa?aa?aa.push(e):aa=[e]:sa=e}function Uv(){if(sa){var e=sa,t=aa;if(aa=sa=null,vm(e),t)for(e=0;e<t.length;e++)vm(t[e])}}function xv(e,t){return e(t)}function Vv(){}var Mh=!1;function Fv(e,t,n){if(Mh)return e(t,n);Mh=!0;try{return xv(e,t,n)}finally{Mh=!1,(sa!==null||aa!==null)&&(Vv(),Uv())}}function jc(e,t){var n=e.stateNode;if(n===null)return null;var i=Yu(n);if(i===null)return null;n=i[t];e:switch(t){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(i=!i.disabled)||(e=e.type,i=!(e==="button"||e==="input"||e==="select"||e==="textarea")),e=!i;break e;default:e=!1}if(e)return null;if(n&&typeof n!="function")throw Error(X(231,t,typeof n));return n}var __=!1;if(Hr)try{var Xa={};Object.defineProperty(Xa,"passive",{get:function(){__=!0}}),window.addEventListener("test",Xa,Xa),window.removeEventListener("test",Xa,Xa)}catch{__=!1}function _N(e,t,n,i,r,o,s,a,c){var d=Array.prototype.slice.call(arguments,3);try{t.apply(n,d)}catch(l){this.onError(l)}}var Ac=!1,iu=null,ru=!1,f_=null,fN={onError:function(e){Ac=!0,iu=e}};function EN(e,t,n,i,r,o,s,a,c){Ac=!1,iu=null,_N.apply(fN,arguments)}function mN(e,t,n,i,r,o,s,a,c){if(EN.apply(this,arguments),Ac){if(Ac){var d=iu;Ac=!1,iu=null}else throw Error(X(198));ru||(ru=!0,f_=d)}}function As(e){var t=e,n=e;if(e.alternate)for(;t.return;)t=t.return;else{e=t;do t=e,t.flags&4098&&(n=t.return),e=t.return;while(e)}return t.tag===3?n:null}function Bv(e){if(e.tag===13){var t=e.memoizedState;if(t===null&&(e=e.alternate,e!==null&&(t=e.memoizedState)),t!==null)return t.dehydrated}return null}function Im(e){if(As(e)!==e)throw Error(X(188))}function gN(e){var t=e.alternate;if(!t){if(t=As(e),t===null)throw Error(X(188));return t!==e?null:e}for(var n=e,i=t;;){var r=n.return;if(r===null)break;var o=r.alternate;if(o===null){if(i=r.return,i!==null){n=i;continue}break}if(r.child===o.child){for(o=r.child;o;){if(o===n)return Im(r),e;if(o===i)return Im(r),t;o=o.sibling}throw Error(X(188))}if(n.return!==i.return)n=r,i=o;else{for(var s=!1,a=r.child;a;){if(a===n){s=!0,n=r,i=o;break}if(a===i){s=!0,i=r,n=o;break}a=a.sibling}if(!s){for(a=o.child;a;){if(a===n){s=!0,n=o,i=r;break}if(a===i){s=!0,i=o,n=r;break}a=a.sibling}if(!s)throw Error(X(189))}}if(n.alternate!==i)throw Error(X(190))}if(n.tag!==3)throw Error(X(188));return n.stateNode.current===n?e:t}function Gv(e){return e=gN(e),e!==null?jv(e):null}function jv(e){if(e.tag===5||e.tag===6)return e;for(e=e.child;e!==null;){var t=jv(e);if(t!==null)return t;e=e.sibling}return null}var Wv=gi.unstable_scheduleCallback,ym=gi.unstable_cancelCallback,SN=gi.unstable_shouldYield,TN=gi.unstable_requestPaint,rn=gi.unstable_now,RN=gi.unstable_getCurrentPriorityLevel,Hf=gi.unstable_ImmediatePriority,Hv=gi.unstable_UserBlockingPriority,ou=gi.unstable_NormalPriority,CN=gi.unstable_LowPriority,Kv=gi.unstable_IdlePriority,Wu=null,Cr=null;function vN(e){if(Cr&&typeof Cr.onCommitFiberRoot=="function")try{Cr.onCommitFiberRoot(Wu,e,void 0,(e.current.flags&128)===128)}catch{}}var Qi=Math.clz32?Math.clz32:AN,IN=Math.log,yN=Math.LN2;function AN(e){return e>>>=0,e===0?32:31-(IN(e)/yN|0)|0}var Wd=64,Hd=4194304;function fc(e){switch(e&-e){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return e&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return e&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return e}}function su(e,t){var n=e.pendingLanes;if(n===0)return 0;var i=0,r=e.suspendedLanes,o=e.pingedLanes,s=n&268435455;if(s!==0){var a=s&~r;a!==0?i=fc(a):(o&=s,o!==0&&(i=fc(o)))}else s=n&~r,s!==0?i=fc(s):o!==0&&(i=fc(o));if(i===0)return 0;if(t!==0&&t!==i&&!(t&r)&&(r=i&-i,o=t&-t,r>=o||r===16&&(o&4194240)!==0))return t;if(i&4&&(i|=n&16),t=e.entangledLanes,t!==0)for(e=e.entanglements,t&=i;0<t;)n=31-Qi(t),r=1<<n,i|=e[n],t&=~r;return i}function wN(e,t){switch(e){case 1:case 2:case 4:return t+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return t+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function NN(e,t){for(var n=e.suspendedLanes,i=e.pingedLanes,r=e.expirationTimes,o=e.pendingLanes;0<o;){var s=31-Qi(o),a=1<<s,c=r[s];c===-1?(!(a&n)||a&i)&&(r[s]=wN(a,t)):c<=t&&(e.expiredLanes|=a),o&=~a}}function E_(e){return e=e.pendingLanes&-1073741825,e!==0?e:e&1073741824?1073741824:0}function zv(){var e=Wd;return Wd<<=1,!(Wd&4194240)&&(Wd=64),e}function Uh(e){for(var t=[],n=0;31>n;n++)t.push(e);return t}function yd(e,t,n){e.pendingLanes|=t,t!==536870912&&(e.suspendedLanes=0,e.pingedLanes=0),e=e.eventTimes,t=31-Qi(t),e[t]=n}function ON(e,t){var n=e.pendingLanes&~t;e.pendingLanes=t,e.suspendedLanes=0,e.pingedLanes=0,e.expiredLanes&=t,e.mutableReadLanes&=t,e.entangledLanes&=t,t=e.entanglements;var i=e.eventTimes;for(e=e.expirationTimes;0<n;){var r=31-Qi(n),o=1<<r;t[r]=0,i[r]=-1,e[r]=-1,n&=~o}}function Kf(e,t){var n=e.entangledLanes|=t;for(e=e.entanglements;n;){var i=31-Qi(n),r=1<<i;r&t|e[i]&t&&(e[i]|=t),n&=~r}}var Et=0;function Yv(e){return e&=-e,1<e?4<e?e&268435455?16:536870912:4:1}var $v,zf,qv,Jv,Xv,m_=!1,Kd=[],To=null,Ro=null,Co=null,Wc=new Map,Hc=new Map,co=[],bN="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function Am(e,t){switch(e){case"focusin":case"focusout":To=null;break;case"dragenter":case"dragleave":Ro=null;break;case"mouseover":case"mouseout":Co=null;break;case"pointerover":case"pointerout":Wc.delete(t.pointerId);break;case"gotpointercapture":case"lostpointercapture":Hc.delete(t.pointerId)}}function Qa(e,t,n,i,r,o){return e===null||e.nativeEvent!==o?(e={blockedOn:t,domEventName:n,eventSystemFlags:i,nativeEvent:o,targetContainers:[r]},t!==null&&(t=wd(t),t!==null&&zf(t)),e):(e.eventSystemFlags|=i,t=e.targetContainers,r!==null&&t.indexOf(r)===-1&&t.push(r),e)}function DN(e,t,n,i,r){switch(t){case"focusin":return To=Qa(To,e,t,n,i,r),!0;case"dragenter":return Ro=Qa(Ro,e,t,n,i,r),!0;case"mouseover":return Co=Qa(Co,e,t,n,i,r),!0;case"pointerover":var o=r.pointerId;return Wc.set(o,Qa(Wc.get(o)||null,e,t,n,i,r)),!0;case"gotpointercapture":return o=r.pointerId,Hc.set(o,Qa(Hc.get(o)||null,e,t,n,i,r)),!0}return!1}function Qv(e){var t=Xo(e.target);if(t!==null){var n=As(t);if(n!==null){if(t=n.tag,t===13){if(t=Bv(n),t!==null){e.blockedOn=t,Xv(e.priority,function(){qv(n)});return}}else if(t===3&&n.stateNode.current.memoizedState.isDehydrated){e.blockedOn=n.tag===3?n.stateNode.containerInfo:null;return}}}e.blockedOn=null}function Al(e){if(e.blockedOn!==null)return!1;for(var t=e.targetContainers;0<t.length;){var n=g_(e.domEventName,e.eventSystemFlags,t[0],e.nativeEvent);if(n===null){n=e.nativeEvent;var i=new n.constructor(n.type,n);h_=i,n.target.dispatchEvent(i),h_=null}else return t=wd(n),t!==null&&zf(t),e.blockedOn=n,!1;t.shift()}return!0}function wm(e,t,n){Al(e)&&n.delete(t)}function PN(){m_=!1,To!==null&&Al(To)&&(To=null),Ro!==null&&Al(Ro)&&(Ro=null),Co!==null&&Al(Co)&&(Co=null),Wc.forEach(wm),Hc.forEach(wm)}function Za(e,t){e.blockedOn===t&&(e.blockedOn=null,m_||(m_=!0,gi.unstable_scheduleCallback(gi.unstable_NormalPriority,PN)))}function Kc(e){function t(r){return Za(r,e)}if(0<Kd.length){Za(Kd[0],e);for(var n=1;n<Kd.length;n++){var i=Kd[n];i.blockedOn===e&&(i.blockedOn=null)}}for(To!==null&&Za(To,e),Ro!==null&&Za(Ro,e),Co!==null&&Za(Co,e),Wc.forEach(t),Hc.forEach(t),n=0;n<co.length;n++)i=co[n],i.blockedOn===e&&(i.blockedOn=null);for(;0<co.length&&(n=co[0],n.blockedOn===null);)Qv(n),n.blockedOn===null&&co.shift()}var ca=$r.ReactCurrentBatchConfig,au=!0;function LN(e,t,n,i){var r=Et,o=ca.transition;ca.transition=null;try{Et=1,Yf(e,t,n,i)}finally{Et=r,ca.transition=o}}function kN(e,t,n,i){var r=Et,o=ca.transition;ca.transition=null;try{Et=4,Yf(e,t,n,i)}finally{Et=r,ca.transition=o}}function Yf(e,t,n,i){if(au){var r=g_(e,t,n,i);if(r===null)zh(e,t,i,cu,n),Am(e,i);else if(DN(r,e,t,n,i))i.stopPropagation();else if(Am(e,i),t&4&&-1<bN.indexOf(e)){for(;r!==null;){var o=wd(r);if(o!==null&&$v(o),o=g_(e,t,n,i),o===null&&zh(e,t,i,cu,n),o===r)break;r=o}r!==null&&i.stopPropagation()}else zh(e,t,i,null,n)}}var cu=null;function g_(e,t,n,i){if(cu=null,e=Wf(i),e=Xo(e),e!==null)if(t=As(e),t===null)e=null;else if(n=t.tag,n===13){if(e=Bv(t),e!==null)return e;e=null}else if(n===3){if(t.stateNode.current.memoizedState.isDehydrated)return t.tag===3?t.stateNode.containerInfo:null;e=null}else t!==e&&(e=null);return cu=e,null}function Zv(e){switch(e){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(RN()){case Hf:return 1;case Hv:return 4;case ou:case CN:return 16;case Kv:return 536870912;default:return 16}default:return 16}}var po=null,$f=null,wl=null;function eI(){if(wl)return wl;var e,t=$f,n=t.length,i,r="value"in po?po.value:po.textContent,o=r.length;for(e=0;e<n&&t[e]===r[e];e++);var s=n-e;for(i=1;i<=s&&t[n-i]===r[o-i];i++);return wl=r.slice(e,1<i?1-i:void 0)}function Nl(e){var t=e.keyCode;return"charCode"in e?(e=e.charCode,e===0&&t===13&&(e=13)):e=t,e===10&&(e=13),32<=e||e===13?e:0}function zd(){return!0}function Nm(){return!1}function Ti(e){function t(n,i,r,o,s){this._reactName=n,this._targetInst=r,this.type=i,this.nativeEvent=o,this.target=s,this.currentTarget=null;for(var a in e)e.hasOwnProperty(a)&&(n=e[a],this[a]=n?n(o):o[a]);return this.isDefaultPrevented=(o.defaultPrevented!=null?o.defaultPrevented:o.returnValue===!1)?zd:Nm,this.isPropagationStopped=Nm,this}return Yt(t.prototype,{preventDefault:function(){this.defaultPrevented=!0;var n=this.nativeEvent;n&&(n.preventDefault?n.preventDefault():typeof n.returnValue!="unknown"&&(n.returnValue=!1),this.isDefaultPrevented=zd)},stopPropagation:function(){var n=this.nativeEvent;n&&(n.stopPropagation?n.stopPropagation():typeof n.cancelBubble!="unknown"&&(n.cancelBubble=!0),this.isPropagationStopped=zd)},persist:function(){},isPersistent:zd}),t}var Ua={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(e){return e.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},qf=Ti(Ua),Ad=Yt({},Ua,{view:0,detail:0}),MN=Ti(Ad),xh,Vh,ec,Hu=Yt({},Ad,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Jf,button:0,buttons:0,relatedTarget:function(e){return e.relatedTarget===void 0?e.fromElement===e.srcElement?e.toElement:e.fromElement:e.relatedTarget},movementX:function(e){return"movementX"in e?e.movementX:(e!==ec&&(ec&&e.type==="mousemove"?(xh=e.screenX-ec.screenX,Vh=e.screenY-ec.screenY):Vh=xh=0,ec=e),xh)},movementY:function(e){return"movementY"in e?e.movementY:Vh}}),Om=Ti(Hu),UN=Yt({},Hu,{dataTransfer:0}),xN=Ti(UN),VN=Yt({},Ad,{relatedTarget:0}),Fh=Ti(VN),FN=Yt({},Ua,{animationName:0,elapsedTime:0,pseudoElement:0}),BN=Ti(FN),GN=Yt({},Ua,{clipboardData:function(e){return"clipboardData"in e?e.clipboardData:window.clipboardData}}),jN=Ti(GN),WN=Yt({},Ua,{data:0}),bm=Ti(WN),HN={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},KN={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},zN={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function YN(e){var t=this.nativeEvent;return t.getModifierState?t.getModifierState(e):(e=zN[e])?!!t[e]:!1}function Jf(){return YN}var $N=Yt({},Ad,{key:function(e){if(e.key){var t=HN[e.key]||e.key;if(t!=="Unidentified")return t}return e.type==="keypress"?(e=Nl(e),e===13?"Enter":String.fromCharCode(e)):e.type==="keydown"||e.type==="keyup"?KN[e.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Jf,charCode:function(e){return e.type==="keypress"?Nl(e):0},keyCode:function(e){return e.type==="keydown"||e.type==="keyup"?e.keyCode:0},which:function(e){return e.type==="keypress"?Nl(e):e.type==="keydown"||e.type==="keyup"?e.keyCode:0}}),qN=Ti($N),JN=Yt({},Hu,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Dm=Ti(JN),XN=Yt({},Ad,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Jf}),QN=Ti(XN),ZN=Yt({},Ua,{propertyName:0,elapsedTime:0,pseudoElement:0}),eO=Ti(ZN),tO=Yt({},Hu,{deltaX:function(e){return"deltaX"in e?e.deltaX:"wheelDeltaX"in e?-e.wheelDeltaX:0},deltaY:function(e){return"deltaY"in e?e.deltaY:"wheelDeltaY"in e?-e.wheelDeltaY:"wheelDelta"in e?-e.wheelDelta:0},deltaZ:0,deltaMode:0}),nO=Ti(tO),iO=[9,13,27,32],Xf=Hr&&"CompositionEvent"in window,wc=null;Hr&&"documentMode"in document&&(wc=document.documentMode);var rO=Hr&&"TextEvent"in window&&!wc,tI=Hr&&(!Xf||wc&&8<wc&&11>=wc),Pm=String.fromCharCode(32),Lm=!1;function nI(e,t){switch(e){case"keyup":return iO.indexOf(t.keyCode)!==-1;case"keydown":return t.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function iI(e){return e=e.detail,typeof e=="object"&&"data"in e?e.data:null}var zs=!1;function oO(e,t){switch(e){case"compositionend":return iI(t);case"keypress":return t.which!==32?null:(Lm=!0,Pm);case"textInput":return e=t.data,e===Pm&&Lm?null:e;default:return null}}function sO(e,t){if(zs)return e==="compositionend"||!Xf&&nI(e,t)?(e=eI(),wl=$f=po=null,zs=!1,e):null;switch(e){case"paste":return null;case"keypress":if(!(t.ctrlKey||t.altKey||t.metaKey)||t.ctrlKey&&t.altKey){if(t.char&&1<t.char.length)return t.char;if(t.which)return String.fromCharCode(t.which)}return null;case"compositionend":return tI&&t.locale!=="ko"?null:t.data;default:return null}}var aO={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function km(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t==="input"?!!aO[e.type]:t==="textarea"}function rI(e,t,n,i){Mv(i),t=du(t,"onChange"),0<t.length&&(n=new qf("onChange","change",null,n,i),e.push({event:n,listeners:t}))}var Nc=null,zc=null;function cO(e){fI(e,0)}function Ku(e){var t=qs(e);if(Nv(t))return e}function dO(e,t){if(e==="change")return t}var oI=!1;if(Hr){var Bh;if(Hr){var Gh="oninput"in document;if(!Gh){var Mm=document.createElement("div");Mm.setAttribute("oninput","return;"),Gh=typeof Mm.oninput=="function"}Bh=Gh}else Bh=!1;oI=Bh&&(!document.documentMode||9<document.documentMode)}function Um(){Nc&&(Nc.detachEvent("onpropertychange",sI),zc=Nc=null)}function sI(e){if(e.propertyName==="value"&&Ku(zc)){var t=[];rI(t,zc,e,Wf(e)),Fv(cO,t)}}function lO(e,t,n){e==="focusin"?(Um(),Nc=t,zc=n,Nc.attachEvent("onpropertychange",sI)):e==="focusout"&&Um()}function uO(e){if(e==="selectionchange"||e==="keyup"||e==="keydown")return Ku(zc)}function hO(e,t){if(e==="click")return Ku(t)}function pO(e,t){if(e==="input"||e==="change")return Ku(t)}function _O(e,t){return e===t&&(e!==0||1/e===1/t)||e!==e&&t!==t}var ir=typeof Object.is=="function"?Object.is:_O;function Yc(e,t){if(ir(e,t))return!0;if(typeof e!="object"||e===null||typeof t!="object"||t===null)return!1;var n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(i=0;i<n.length;i++){var r=n[i];if(!e_.call(t,r)||!ir(e[r],t[r]))return!1}return!0}function xm(e){for(;e&&e.firstChild;)e=e.firstChild;return e}function Vm(e,t){var n=xm(e);e=0;for(var i;n;){if(n.nodeType===3){if(i=e+n.textContent.length,e<=t&&i>=t)return{node:n,offset:t-e};e=i}e:{for(;n;){if(n.nextSibling){n=n.nextSibling;break e}n=n.parentNode}n=void 0}n=xm(n)}}function aI(e,t){return e&&t?e===t?!0:e&&e.nodeType===3?!1:t&&t.nodeType===3?aI(e,t.parentNode):"contains"in e?e.contains(t):e.compareDocumentPosition?!!(e.compareDocumentPosition(t)&16):!1:!1}function cI(){for(var e=window,t=nu();t instanceof e.HTMLIFrameElement;){try{var n=typeof t.contentWindow.location.href=="string"}catch{n=!1}if(n)e=t.contentWindow;else break;t=nu(e.document)}return t}function Qf(e){var t=e&&e.nodeName&&e.nodeName.toLowerCase();return t&&(t==="input"&&(e.type==="text"||e.type==="search"||e.type==="tel"||e.type==="url"||e.type==="password")||t==="textarea"||e.contentEditable==="true")}function fO(e){var t=cI(),n=e.focusedElem,i=e.selectionRange;if(t!==n&&n&&n.ownerDocument&&aI(n.ownerDocument.documentElement,n)){if(i!==null&&Qf(n)){if(t=i.start,e=i.end,e===void 0&&(e=t),"selectionStart"in n)n.selectionStart=t,n.selectionEnd=Math.min(e,n.value.length);else if(e=(t=n.ownerDocument||document)&&t.defaultView||window,e.getSelection){e=e.getSelection();var r=n.textContent.length,o=Math.min(i.start,r);i=i.end===void 0?o:Math.min(i.end,r),!e.extend&&o>i&&(r=i,i=o,o=r),r=Vm(n,o);var s=Vm(n,i);r&&s&&(e.rangeCount!==1||e.anchorNode!==r.node||e.anchorOffset!==r.offset||e.focusNode!==s.node||e.focusOffset!==s.offset)&&(t=t.createRange(),t.setStart(r.node,r.offset),e.removeAllRanges(),o>i?(e.addRange(t),e.extend(s.node,s.offset)):(t.setEnd(s.node,s.offset),e.addRange(t)))}}for(t=[],e=n;e=e.parentNode;)e.nodeType===1&&t.push({element:e,left:e.scrollLeft,top:e.scrollTop});for(typeof n.focus=="function"&&n.focus(),n=0;n<t.length;n++)e=t[n],e.element.scrollLeft=e.left,e.element.scrollTop=e.top}}var EO=Hr&&"documentMode"in document&&11>=document.documentMode,Ys=null,S_=null,Oc=null,T_=!1;function Fm(e,t,n){var i=n.window===n?n.document:n.nodeType===9?n:n.ownerDocument;T_||Ys==null||Ys!==nu(i)||(i=Ys,"selectionStart"in i&&Qf(i)?i={start:i.selectionStart,end:i.selectionEnd}:(i=(i.ownerDocument&&i.ownerDocument.defaultView||window).getSelection(),i={anchorNode:i.anchorNode,anchorOffset:i.anchorOffset,focusNode:i.focusNode,focusOffset:i.focusOffset}),Oc&&Yc(Oc,i)||(Oc=i,i=du(S_,"onSelect"),0<i.length&&(t=new qf("onSelect","select",null,t,n),e.push({event:t,listeners:i}),t.target=Ys)))}function Yd(e,t){var n={};return n[e.toLowerCase()]=t.toLowerCase(),n["Webkit"+e]="webkit"+t,n["Moz"+e]="moz"+t,n}var $s={animationend:Yd("Animation","AnimationEnd"),animationiteration:Yd("Animation","AnimationIteration"),animationstart:Yd("Animation","AnimationStart"),transitionend:Yd("Transition","TransitionEnd")},jh={},dI={};Hr&&(dI=document.createElement("div").style,"AnimationEvent"in window||(delete $s.animationend.animation,delete $s.animationiteration.animation,delete $s.animationstart.animation),"TransitionEvent"in window||delete $s.transitionend.transition);function zu(e){if(jh[e])return jh[e];if(!$s[e])return e;var t=$s[e],n;for(n in t)if(t.hasOwnProperty(n)&&n in dI)return jh[e]=t[n];return e}var lI=zu("animationend"),uI=zu("animationiteration"),hI=zu("animationstart"),pI=zu("transitionend"),_I=new Map,Bm="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function xo(e,t){_I.set(e,t),ys(t,[e])}for(var Wh=0;Wh<Bm.length;Wh++){var Hh=Bm[Wh],mO=Hh.toLowerCase(),gO=Hh[0].toUpperCase()+Hh.slice(1);xo(mO,"on"+gO)}xo(lI,"onAnimationEnd");xo(uI,"onAnimationIteration");xo(hI,"onAnimationStart");xo("dblclick","onDoubleClick");xo("focusin","onFocus");xo("focusout","onBlur");xo(pI,"onTransitionEnd");ga("onMouseEnter",["mouseout","mouseover"]);ga("onMouseLeave",["mouseout","mouseover"]);ga("onPointerEnter",["pointerout","pointerover"]);ga("onPointerLeave",["pointerout","pointerover"]);ys("onChange","change click focusin focusout input keydown keyup selectionchange".split(" "));ys("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" "));ys("onBeforeInput",["compositionend","keypress","textInput","paste"]);ys("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" "));ys("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" "));ys("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var Ec="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),SO=new Set("cancel close invalid load scroll toggle".split(" ").concat(Ec));function Gm(e,t,n){var i=e.type||"unknown-event";e.currentTarget=n,mN(i,t,void 0,e),e.currentTarget=null}function fI(e,t){t=(t&4)!==0;for(var n=0;n<e.length;n++){var i=e[n],r=i.event;i=i.listeners;e:{var o=void 0;if(t)for(var s=i.length-1;0<=s;s--){var a=i[s],c=a.instance,d=a.currentTarget;if(a=a.listener,c!==o&&r.isPropagationStopped())break e;Gm(r,a,d),o=c}else for(s=0;s<i.length;s++){if(a=i[s],c=a.instance,d=a.currentTarget,a=a.listener,c!==o&&r.isPropagationStopped())break e;Gm(r,a,d),o=c}}}if(ru)throw e=f_,ru=!1,f_=null,e}function At(e,t){var n=t[y_];n===void 0&&(n=t[y_]=new Set);var i=e+"__bubble";n.has(i)||(EI(t,e,2,!1),n.add(i))}function Kh(e,t,n){var i=0;t&&(i|=4),EI(n,e,i,t)}var $d="_reactListening"+Math.random().toString(36).slice(2);function $c(e){if(!e[$d]){e[$d]=!0,vv.forEach(function(n){n!=="selectionchange"&&(SO.has(n)||Kh(n,!1,e),Kh(n,!0,e))});var t=e.nodeType===9?e:e.ownerDocument;t===null||t[$d]||(t[$d]=!0,Kh("selectionchange",!1,t))}}function EI(e,t,n,i){switch(Zv(t)){case 1:var r=LN;break;case 4:r=kN;break;default:r=Yf}n=r.bind(null,t,n,e),r=void 0,!__||t!=="touchstart"&&t!=="touchmove"&&t!=="wheel"||(r=!0),i?r!==void 0?e.addEventListener(t,n,{capture:!0,passive:r}):e.addEventListener(t,n,!0):r!==void 0?e.addEventListener(t,n,{passive:r}):e.addEventListener(t,n,!1)}function zh(e,t,n,i,r){var o=i;if(!(t&1)&&!(t&2)&&i!==null)e:for(;;){if(i===null)return;var s=i.tag;if(s===3||s===4){var a=i.stateNode.containerInfo;if(a===r||a.nodeType===8&&a.parentNode===r)break;if(s===4)for(s=i.return;s!==null;){var c=s.tag;if((c===3||c===4)&&(c=s.stateNode.containerInfo,c===r||c.nodeType===8&&c.parentNode===r))return;s=s.return}for(;a!==null;){if(s=Xo(a),s===null)return;if(c=s.tag,c===5||c===6){i=o=s;continue e}a=a.parentNode}}i=i.return}Fv(function(){var d=o,l=Wf(n),u=[];e:{var h=_I.get(e);if(h!==void 0){var p=qf,m=e;switch(e){case"keypress":if(Nl(n)===0)break e;case"keydown":case"keyup":p=qN;break;case"focusin":m="focus",p=Fh;break;case"focusout":m="blur",p=Fh;break;case"beforeblur":case"afterblur":p=Fh;break;case"click":if(n.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":p=Om;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":p=xN;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":p=QN;break;case lI:case uI:case hI:p=BN;break;case pI:p=eO;break;case"scroll":p=MN;break;case"wheel":p=nO;break;case"copy":case"cut":case"paste":p=jN;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":p=Dm}var E=(t&4)!==0,g=!E&&e==="scroll",S=E?h!==null?h+"Capture":null:h;E=[];for(var T=d,I;T!==null;){I=T;var y=I.stateNode;if(I.tag===5&&y!==null&&(I=y,S!==null&&(y=jc(T,S),y!=null&&E.push(qc(T,y,I)))),g)break;T=T.return}0<E.length&&(h=new p(h,m,null,n,l),u.push({event:h,listeners:E}))}}if(!(t&7)){e:{if(h=e==="mouseover"||e==="pointerover",p=e==="mouseout"||e==="pointerout",h&&n!==h_&&(m=n.relatedTarget||n.fromElement)&&(Xo(m)||m[Kr]))break e;if((p||h)&&(h=l.window===l?l:(h=l.ownerDocument)?h.defaultView||h.parentWindow:window,p?(m=n.relatedTarget||n.toElement,p=d,m=m?Xo(m):null,m!==null&&(g=As(m),m!==g||m.tag!==5&&m.tag!==6)&&(m=null)):(p=null,m=d),p!==m)){if(E=Om,y="onMouseLeave",S="onMouseEnter",T="mouse",(e==="pointerout"||e==="pointerover")&&(E=Dm,y="onPointerLeave",S="onPointerEnter",T="pointer"),g=p==null?h:qs(p),I=m==null?h:qs(m),h=new E(y,T+"leave",p,n,l),h.target=g,h.relatedTarget=I,y=null,Xo(l)===d&&(E=new E(S,T+"enter",m,n,l),E.target=I,E.relatedTarget=g,y=E),g=y,p&&m)t:{for(E=p,S=m,T=0,I=E;I;I=Ps(I))T++;for(I=0,y=S;y;y=Ps(y))I++;for(;0<T-I;)E=Ps(E),T--;for(;0<I-T;)S=Ps(S),I--;for(;T--;){if(E===S||S!==null&&E===S.alternate)break t;E=Ps(E),S=Ps(S)}E=null}else E=null;p!==null&&jm(u,h,p,E,!1),m!==null&&g!==null&&jm(u,g,m,E,!0)}}e:{if(h=d?qs(d):window,p=h.nodeName&&h.nodeName.toLowerCase(),p==="select"||p==="input"&&h.type==="file")var w=dO;else if(km(h))if(oI)w=pO;else{w=uO;var D=lO}else(p=h.nodeName)&&p.toLowerCase()==="input"&&(h.type==="checkbox"||h.type==="radio")&&(w=hO);if(w&&(w=w(e,d))){rI(u,w,n,l);break e}D&&D(e,h,d),e==="focusout"&&(D=h._wrapperState)&&D.controlled&&h.type==="number"&&a_(h,"number",h.value)}switch(D=d?qs(d):window,e){case"focusin":(km(D)||D.contentEditable==="true")&&(Ys=D,S_=d,Oc=null);break;case"focusout":Oc=S_=Ys=null;break;case"mousedown":T_=!0;break;case"contextmenu":case"mouseup":case"dragend":T_=!1,Fm(u,n,l);break;case"selectionchange":if(EO)break;case"keydown":case"keyup":Fm(u,n,l)}var O;if(Xf)e:{switch(e){case"compositionstart":var P="onCompositionStart";break e;case"compositionend":P="onCompositionEnd";break e;case"compositionupdate":P="onCompositionUpdate";break e}P=void 0}else zs?nI(e,n)&&(P="onCompositionEnd"):e==="keydown"&&n.keyCode===229&&(P="onCompositionStart");P&&(tI&&n.locale!=="ko"&&(zs||P!=="onCompositionStart"?P==="onCompositionEnd"&&zs&&(O=eI()):(po=l,$f="value"in po?po.value:po.textContent,zs=!0)),D=du(d,P),0<D.length&&(P=new bm(P,e,null,n,l),u.push({event:P,listeners:D}),O?P.data=O:(O=iI(n),O!==null&&(P.data=O)))),(O=rO?oO(e,n):sO(e,n))&&(d=du(d,"onBeforeInput"),0<d.length&&(l=new bm("onBeforeInput","beforeinput",null,n,l),u.push({event:l,listeners:d}),l.data=O))}fI(u,t)})}function qc(e,t,n){return{instance:e,listener:t,currentTarget:n}}function du(e,t){for(var n=t+"Capture",i=[];e!==null;){var r=e,o=r.stateNode;r.tag===5&&o!==null&&(r=o,o=jc(e,n),o!=null&&i.unshift(qc(e,o,r)),o=jc(e,t),o!=null&&i.push(qc(e,o,r))),e=e.return}return i}function Ps(e){if(e===null)return null;do e=e.return;while(e&&e.tag!==5);return e||null}function jm(e,t,n,i,r){for(var o=t._reactName,s=[];n!==null&&n!==i;){var a=n,c=a.alternate,d=a.stateNode;if(c!==null&&c===i)break;a.tag===5&&d!==null&&(a=d,r?(c=jc(n,o),c!=null&&s.unshift(qc(n,c,a))):r||(c=jc(n,o),c!=null&&s.push(qc(n,c,a)))),n=n.return}s.length!==0&&e.push({event:t,listeners:s})}var TO=/\r\n?/g,RO=/\u0000|\uFFFD/g;function Wm(e){return(typeof e=="string"?e:""+e).replace(TO,`
`).replace(RO,"")}function qd(e,t,n){if(t=Wm(t),Wm(e)!==t&&n)throw Error(X(425))}function lu(){}var R_=null,C_=null;function v_(e,t){return e==="textarea"||e==="noscript"||typeof t.children=="string"||typeof t.children=="number"||typeof t.dangerouslySetInnerHTML=="object"&&t.dangerouslySetInnerHTML!==null&&t.dangerouslySetInnerHTML.__html!=null}var I_=typeof setTimeout=="function"?setTimeout:void 0,CO=typeof clearTimeout=="function"?clearTimeout:void 0,Hm=typeof Promise=="function"?Promise:void 0,vO=typeof queueMicrotask=="function"?queueMicrotask:typeof Hm<"u"?function(e){return Hm.resolve(null).then(e).catch(IO)}:I_;function IO(e){setTimeout(function(){throw e})}function Yh(e,t){var n=t,i=0;do{var r=n.nextSibling;if(e.removeChild(n),r&&r.nodeType===8)if(n=r.data,n==="/$"){if(i===0){e.removeChild(r),Kc(t);return}i--}else n!=="$"&&n!=="$?"&&n!=="$!"||i++;n=r}while(n);Kc(t)}function vo(e){for(;e!=null;e=e.nextSibling){var t=e.nodeType;if(t===1||t===3)break;if(t===8){if(t=e.data,t==="$"||t==="$!"||t==="$?")break;if(t==="/$")return null}}return e}function Km(e){e=e.previousSibling;for(var t=0;e;){if(e.nodeType===8){var n=e.data;if(n==="$"||n==="$!"||n==="$?"){if(t===0)return e;t--}else n==="/$"&&t++}e=e.previousSibling}return null}var xa=Math.random().toString(36).slice(2),Er="__reactFiber$"+xa,Jc="__reactProps$"+xa,Kr="__reactContainer$"+xa,y_="__reactEvents$"+xa,yO="__reactListeners$"+xa,AO="__reactHandles$"+xa;function Xo(e){var t=e[Er];if(t)return t;for(var n=e.parentNode;n;){if(t=n[Kr]||n[Er]){if(n=t.alternate,t.child!==null||n!==null&&n.child!==null)for(e=Km(e);e!==null;){if(n=e[Er])return n;e=Km(e)}return t}e=n,n=e.parentNode}return null}function wd(e){return e=e[Er]||e[Kr],!e||e.tag!==5&&e.tag!==6&&e.tag!==13&&e.tag!==3?null:e}function qs(e){if(e.tag===5||e.tag===6)return e.stateNode;throw Error(X(33))}function Yu(e){return e[Jc]||null}var A_=[],Js=-1;function Vo(e){return{current:e}}function Dt(e){0>Js||(e.current=A_[Js],A_[Js]=null,Js--)}function yt(e,t){Js++,A_[Js]=e.current,e.current=t}var Lo={},Mn=Vo(Lo),ni=Vo(!1),hs=Lo;function Sa(e,t){var n=e.type.contextTypes;if(!n)return Lo;var i=e.stateNode;if(i&&i.__reactInternalMemoizedUnmaskedChildContext===t)return i.__reactInternalMemoizedMaskedChildContext;var r={},o;for(o in n)r[o]=t[o];return i&&(e=e.stateNode,e.__reactInternalMemoizedUnmaskedChildContext=t,e.__reactInternalMemoizedMaskedChildContext=r),r}function ii(e){return e=e.childContextTypes,e!=null}function uu(){Dt(ni),Dt(Mn)}function zm(e,t,n){if(Mn.current!==Lo)throw Error(X(168));yt(Mn,t),yt(ni,n)}function mI(e,t,n){var i=e.stateNode;if(t=t.childContextTypes,typeof i.getChildContext!="function")return n;i=i.getChildContext();for(var r in i)if(!(r in t))throw Error(X(108,lN(e)||"Unknown",r));return Yt({},n,i)}function hu(e){return e=(e=e.stateNode)&&e.__reactInternalMemoizedMergedChildContext||Lo,hs=Mn.current,yt(Mn,e),yt(ni,ni.current),!0}function Ym(e,t,n){var i=e.stateNode;if(!i)throw Error(X(169));n?(e=mI(e,t,hs),i.__reactInternalMemoizedMergedChildContext=e,Dt(ni),Dt(Mn),yt(Mn,e)):Dt(ni),yt(ni,n)}var Ur=null,$u=!1,$h=!1;function gI(e){Ur===null?Ur=[e]:Ur.push(e)}function wO(e){$u=!0,gI(e)}function Fo(){if(!$h&&Ur!==null){$h=!0;var e=0,t=Et;try{var n=Ur;for(Et=1;e<n.length;e++){var i=n[e];do i=i(!0);while(i!==null)}Ur=null,$u=!1}catch(r){throw Ur!==null&&(Ur=Ur.slice(e+1)),Wv(Hf,Fo),r}finally{Et=t,$h=!1}}return null}var Xs=[],Qs=0,pu=null,_u=0,wi=[],Ni=0,ps=null,Br=1,Gr="";function Ho(e,t){Xs[Qs++]=_u,Xs[Qs++]=pu,pu=e,_u=t}function SI(e,t,n){wi[Ni++]=Br,wi[Ni++]=Gr,wi[Ni++]=ps,ps=e;var i=Br;e=Gr;var r=32-Qi(i)-1;i&=~(1<<r),n+=1;var o=32-Qi(t)+r;if(30<o){var s=r-r%5;o=(i&(1<<s)-1).toString(32),i>>=s,r-=s,Br=1<<32-Qi(t)+r|n<<r|i,Gr=o+e}else Br=1<<o|n<<r|i,Gr=e}function Zf(e){e.return!==null&&(Ho(e,1),SI(e,1,0))}function eE(e){for(;e===pu;)pu=Xs[--Qs],Xs[Qs]=null,_u=Xs[--Qs],Xs[Qs]=null;for(;e===ps;)ps=wi[--Ni],wi[Ni]=null,Gr=wi[--Ni],wi[Ni]=null,Br=wi[--Ni],wi[Ni]=null}var mi=null,_i=null,Ft=!1,qi=null;function TI(e,t){var n=Pi(5,null,null,0);n.elementType="DELETED",n.stateNode=t,n.return=e,t=e.deletions,t===null?(e.deletions=[n],e.flags|=16):t.push(n)}function $m(e,t){switch(e.tag){case 5:var n=e.type;return t=t.nodeType!==1||n.toLowerCase()!==t.nodeName.toLowerCase()?null:t,t!==null?(e.stateNode=t,mi=e,_i=vo(t.firstChild),!0):!1;case 6:return t=e.pendingProps===""||t.nodeType!==3?null:t,t!==null?(e.stateNode=t,mi=e,_i=null,!0):!1;case 13:return t=t.nodeType!==8?null:t,t!==null?(n=ps!==null?{id:Br,overflow:Gr}:null,e.memoizedState={dehydrated:t,treeContext:n,retryLane:1073741824},n=Pi(18,null,null,0),n.stateNode=t,n.return=e,e.child=n,mi=e,_i=null,!0):!1;default:return!1}}function w_(e){return(e.mode&1)!==0&&(e.flags&128)===0}function N_(e){if(Ft){var t=_i;if(t){var n=t;if(!$m(e,t)){if(w_(e))throw Error(X(418));t=vo(n.nextSibling);var i=mi;t&&$m(e,t)?TI(i,n):(e.flags=e.flags&-4097|2,Ft=!1,mi=e)}}else{if(w_(e))throw Error(X(418));e.flags=e.flags&-4097|2,Ft=!1,mi=e}}}function qm(e){for(e=e.return;e!==null&&e.tag!==5&&e.tag!==3&&e.tag!==13;)e=e.return;mi=e}function Jd(e){if(e!==mi)return!1;if(!Ft)return qm(e),Ft=!0,!1;var t;if((t=e.tag!==3)&&!(t=e.tag!==5)&&(t=e.type,t=t!=="head"&&t!=="body"&&!v_(e.type,e.memoizedProps)),t&&(t=_i)){if(w_(e))throw RI(),Error(X(418));for(;t;)TI(e,t),t=vo(t.nextSibling)}if(qm(e),e.tag===13){if(e=e.memoizedState,e=e!==null?e.dehydrated:null,!e)throw Error(X(317));e:{for(e=e.nextSibling,t=0;e;){if(e.nodeType===8){var n=e.data;if(n==="/$"){if(t===0){_i=vo(e.nextSibling);break e}t--}else n!=="$"&&n!=="$!"&&n!=="$?"||t++}e=e.nextSibling}_i=null}}else _i=mi?vo(e.stateNode.nextSibling):null;return!0}function RI(){for(var e=_i;e;)e=vo(e.nextSibling)}function Ta(){_i=mi=null,Ft=!1}function tE(e){qi===null?qi=[e]:qi.push(e)}var NO=$r.ReactCurrentBatchConfig;function tc(e,t,n){if(e=n.ref,e!==null&&typeof e!="function"&&typeof e!="object"){if(n._owner){if(n=n._owner,n){if(n.tag!==1)throw Error(X(309));var i=n.stateNode}if(!i)throw Error(X(147,e));var r=i,o=""+e;return t!==null&&t.ref!==null&&typeof t.ref=="function"&&t.ref._stringRef===o?t.ref:(t=function(s){var a=r.refs;s===null?delete a[o]:a[o]=s},t._stringRef=o,t)}if(typeof e!="string")throw Error(X(284));if(!n._owner)throw Error(X(290,e))}return e}function Xd(e,t){throw e=Object.prototype.toString.call(t),Error(X(31,e==="[object Object]"?"object with keys {"+Object.keys(t).join(", ")+"}":e))}function Jm(e){var t=e._init;return t(e._payload)}function CI(e){function t(S,T){if(e){var I=S.deletions;I===null?(S.deletions=[T],S.flags|=16):I.push(T)}}function n(S,T){if(!e)return null;for(;T!==null;)t(S,T),T=T.sibling;return null}function i(S,T){for(S=new Map;T!==null;)T.key!==null?S.set(T.key,T):S.set(T.index,T),T=T.sibling;return S}function r(S,T){return S=wo(S,T),S.index=0,S.sibling=null,S}function o(S,T,I){return S.index=I,e?(I=S.alternate,I!==null?(I=I.index,I<T?(S.flags|=2,T):I):(S.flags|=2,T)):(S.flags|=1048576,T)}function s(S){return e&&S.alternate===null&&(S.flags|=2),S}function a(S,T,I,y){return T===null||T.tag!==6?(T=tp(I,S.mode,y),T.return=S,T):(T=r(T,I),T.return=S,T)}function c(S,T,I,y){var w=I.type;return w===Ks?l(S,T,I.props.children,y,I.key):T!==null&&(T.elementType===w||typeof w=="object"&&w!==null&&w.$$typeof===so&&Jm(w)===T.type)?(y=r(T,I.props),y.ref=tc(S,T,I),y.return=S,y):(y=Ml(I.type,I.key,I.props,null,S.mode,y),y.ref=tc(S,T,I),y.return=S,y)}function d(S,T,I,y){return T===null||T.tag!==4||T.stateNode.containerInfo!==I.containerInfo||T.stateNode.implementation!==I.implementation?(T=np(I,S.mode,y),T.return=S,T):(T=r(T,I.children||[]),T.return=S,T)}function l(S,T,I,y,w){return T===null||T.tag!==7?(T=ds(I,S.mode,y,w),T.return=S,T):(T=r(T,I),T.return=S,T)}function u(S,T,I){if(typeof T=="string"&&T!==""||typeof T=="number")return T=tp(""+T,S.mode,I),T.return=S,T;if(typeof T=="object"&&T!==null){switch(T.$$typeof){case Bd:return I=Ml(T.type,T.key,T.props,null,S.mode,I),I.ref=tc(S,null,T),I.return=S,I;case Hs:return T=np(T,S.mode,I),T.return=S,T;case so:var y=T._init;return u(S,y(T._payload),I)}if(_c(T)||Ja(T))return T=ds(T,S.mode,I,null),T.return=S,T;Xd(S,T)}return null}function h(S,T,I,y){var w=T!==null?T.key:null;if(typeof I=="string"&&I!==""||typeof I=="number")return w!==null?null:a(S,T,""+I,y);if(typeof I=="object"&&I!==null){switch(I.$$typeof){case Bd:return I.key===w?c(S,T,I,y):null;case Hs:return I.key===w?d(S,T,I,y):null;case so:return w=I._init,h(S,T,w(I._payload),y)}if(_c(I)||Ja(I))return w!==null?null:l(S,T,I,y,null);Xd(S,I)}return null}function p(S,T,I,y,w){if(typeof y=="string"&&y!==""||typeof y=="number")return S=S.get(I)||null,a(T,S,""+y,w);if(typeof y=="object"&&y!==null){switch(y.$$typeof){case Bd:return S=S.get(y.key===null?I:y.key)||null,c(T,S,y,w);case Hs:return S=S.get(y.key===null?I:y.key)||null,d(T,S,y,w);case so:var D=y._init;return p(S,T,I,D(y._payload),w)}if(_c(y)||Ja(y))return S=S.get(I)||null,l(T,S,y,w,null);Xd(T,y)}return null}function m(S,T,I,y){for(var w=null,D=null,O=T,P=T=0,x=null;O!==null&&P<I.length;P++){O.index>P?(x=O,O=null):x=O.sibling;var U=h(S,O,I[P],y);if(U===null){O===null&&(O=x);break}e&&O&&U.alternate===null&&t(S,O),T=o(U,T,P),D===null?w=U:D.sibling=U,D=U,O=x}if(P===I.length)return n(S,O),Ft&&Ho(S,P),w;if(O===null){for(;P<I.length;P++)O=u(S,I[P],y),O!==null&&(T=o(O,T,P),D===null?w=O:D.sibling=O,D=O);return Ft&&Ho(S,P),w}for(O=i(S,O);P<I.length;P++)x=p(O,S,P,I[P],y),x!==null&&(e&&x.alternate!==null&&O.delete(x.key===null?P:x.key),T=o(x,T,P),D===null?w=x:D.sibling=x,D=x);return e&&O.forEach(function(J){return t(S,J)}),Ft&&Ho(S,P),w}function E(S,T,I,y){var w=Ja(I);if(typeof w!="function")throw Error(X(150));if(I=w.call(I),I==null)throw Error(X(151));for(var D=w=null,O=T,P=T=0,x=null,U=I.next();O!==null&&!U.done;P++,U=I.next()){O.index>P?(x=O,O=null):x=O.sibling;var J=h(S,O,U.value,y);if(J===null){O===null&&(O=x);break}e&&O&&J.alternate===null&&t(S,O),T=o(J,T,P),D===null?w=J:D.sibling=J,D=J,O=x}if(U.done)return n(S,O),Ft&&Ho(S,P),w;if(O===null){for(;!U.done;P++,U=I.next())U=u(S,U.value,y),U!==null&&(T=o(U,T,P),D===null?w=U:D.sibling=U,D=U);return Ft&&Ho(S,P),w}for(O=i(S,O);!U.done;P++,U=I.next())U=p(O,S,P,U.value,y),U!==null&&(e&&U.alternate!==null&&O.delete(U.key===null?P:U.key),T=o(U,T,P),D===null?w=U:D.sibling=U,D=U);return e&&O.forEach(function(Le){return t(S,Le)}),Ft&&Ho(S,P),w}function g(S,T,I,y){if(typeof I=="object"&&I!==null&&I.type===Ks&&I.key===null&&(I=I.props.children),typeof I=="object"&&I!==null){switch(I.$$typeof){case Bd:e:{for(var w=I.key,D=T;D!==null;){if(D.key===w){if(w=I.type,w===Ks){if(D.tag===7){n(S,D.sibling),T=r(D,I.props.children),T.return=S,S=T;break e}}else if(D.elementType===w||typeof w=="object"&&w!==null&&w.$$typeof===so&&Jm(w)===D.type){n(S,D.sibling),T=r(D,I.props),T.ref=tc(S,D,I),T.return=S,S=T;break e}n(S,D);break}else t(S,D);D=D.sibling}I.type===Ks?(T=ds(I.props.children,S.mode,y,I.key),T.return=S,S=T):(y=Ml(I.type,I.key,I.props,null,S.mode,y),y.ref=tc(S,T,I),y.return=S,S=y)}return s(S);case Hs:e:{for(D=I.key;T!==null;){if(T.key===D)if(T.tag===4&&T.stateNode.containerInfo===I.containerInfo&&T.stateNode.implementation===I.implementation){n(S,T.sibling),T=r(T,I.children||[]),T.return=S,S=T;break e}else{n(S,T);break}else t(S,T);T=T.sibling}T=np(I,S.mode,y),T.return=S,S=T}return s(S);case so:return D=I._init,g(S,T,D(I._payload),y)}if(_c(I))return m(S,T,I,y);if(Ja(I))return E(S,T,I,y);Xd(S,I)}return typeof I=="string"&&I!==""||typeof I=="number"?(I=""+I,T!==null&&T.tag===6?(n(S,T.sibling),T=r(T,I),T.return=S,S=T):(n(S,T),T=tp(I,S.mode,y),T.return=S,S=T),s(S)):n(S,T)}return g}var Ra=CI(!0),vI=CI(!1),fu=Vo(null),Eu=null,Zs=null,nE=null;function iE(){nE=Zs=Eu=null}function rE(e){var t=fu.current;Dt(fu),e._currentValue=t}function O_(e,t,n){for(;e!==null;){var i=e.alternate;if((e.childLanes&t)!==t?(e.childLanes|=t,i!==null&&(i.childLanes|=t)):i!==null&&(i.childLanes&t)!==t&&(i.childLanes|=t),e===n)break;e=e.return}}function da(e,t){Eu=e,nE=Zs=null,e=e.dependencies,e!==null&&e.firstContext!==null&&(e.lanes&t&&(ei=!0),e.firstContext=null)}function Ui(e){var t=e._currentValue;if(nE!==e)if(e={context:e,memoizedValue:t,next:null},Zs===null){if(Eu===null)throw Error(X(308));Zs=e,Eu.dependencies={lanes:0,firstContext:e}}else Zs=Zs.next=e;return t}var Qo=null;function oE(e){Qo===null?Qo=[e]:Qo.push(e)}function II(e,t,n,i){var r=t.interleaved;return r===null?(n.next=n,oE(t)):(n.next=r.next,r.next=n),t.interleaved=n,zr(e,i)}function zr(e,t){e.lanes|=t;var n=e.alternate;for(n!==null&&(n.lanes|=t),n=e,e=e.return;e!==null;)e.childLanes|=t,n=e.alternate,n!==null&&(n.childLanes|=t),n=e,e=e.return;return n.tag===3?n.stateNode:null}var ao=!1;function sE(e){e.updateQueue={baseState:e.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function yI(e,t){e=e.updateQueue,t.updateQueue===e&&(t.updateQueue={baseState:e.baseState,firstBaseUpdate:e.firstBaseUpdate,lastBaseUpdate:e.lastBaseUpdate,shared:e.shared,effects:e.effects})}function Wr(e,t){return{eventTime:e,lane:t,tag:0,payload:null,callback:null,next:null}}function Io(e,t,n){var i=e.updateQueue;if(i===null)return null;if(i=i.shared,nt&2){var r=i.pending;return r===null?t.next=t:(t.next=r.next,r.next=t),i.pending=t,zr(e,n)}return r=i.interleaved,r===null?(t.next=t,oE(i)):(t.next=r.next,r.next=t),i.interleaved=t,zr(e,n)}function Ol(e,t,n){if(t=t.updateQueue,t!==null&&(t=t.shared,(n&4194240)!==0)){var i=t.lanes;i&=e.pendingLanes,n|=i,t.lanes=n,Kf(e,n)}}function Xm(e,t){var n=e.updateQueue,i=e.alternate;if(i!==null&&(i=i.updateQueue,n===i)){var r=null,o=null;if(n=n.firstBaseUpdate,n!==null){do{var s={eventTime:n.eventTime,lane:n.lane,tag:n.tag,payload:n.payload,callback:n.callback,next:null};o===null?r=o=s:o=o.next=s,n=n.next}while(n!==null);o===null?r=o=t:o=o.next=t}else r=o=t;n={baseState:i.baseState,firstBaseUpdate:r,lastBaseUpdate:o,shared:i.shared,effects:i.effects},e.updateQueue=n;return}e=n.lastBaseUpdate,e===null?n.firstBaseUpdate=t:e.next=t,n.lastBaseUpdate=t}function mu(e,t,n,i){var r=e.updateQueue;ao=!1;var o=r.firstBaseUpdate,s=r.lastBaseUpdate,a=r.shared.pending;if(a!==null){r.shared.pending=null;var c=a,d=c.next;c.next=null,s===null?o=d:s.next=d,s=c;var l=e.alternate;l!==null&&(l=l.updateQueue,a=l.lastBaseUpdate,a!==s&&(a===null?l.firstBaseUpdate=d:a.next=d,l.lastBaseUpdate=c))}if(o!==null){var u=r.baseState;s=0,l=d=c=null,a=o;do{var h=a.lane,p=a.eventTime;if((i&h)===h){l!==null&&(l=l.next={eventTime:p,lane:0,tag:a.tag,payload:a.payload,callback:a.callback,next:null});e:{var m=e,E=a;switch(h=t,p=n,E.tag){case 1:if(m=E.payload,typeof m=="function"){u=m.call(p,u,h);break e}u=m;break e;case 3:m.flags=m.flags&-65537|128;case 0:if(m=E.payload,h=typeof m=="function"?m.call(p,u,h):m,h==null)break e;u=Yt({},u,h);break e;case 2:ao=!0}}a.callback!==null&&a.lane!==0&&(e.flags|=64,h=r.effects,h===null?r.effects=[a]:h.push(a))}else p={eventTime:p,lane:h,tag:a.tag,payload:a.payload,callback:a.callback,next:null},l===null?(d=l=p,c=u):l=l.next=p,s|=h;if(a=a.next,a===null){if(a=r.shared.pending,a===null)break;h=a,a=h.next,h.next=null,r.lastBaseUpdate=h,r.shared.pending=null}}while(1);if(l===null&&(c=u),r.baseState=c,r.firstBaseUpdate=d,r.lastBaseUpdate=l,t=r.shared.interleaved,t!==null){r=t;do s|=r.lane,r=r.next;while(r!==t)}else o===null&&(r.shared.lanes=0);fs|=s,e.lanes=s,e.memoizedState=u}}function Qm(e,t,n){if(e=t.effects,t.effects=null,e!==null)for(t=0;t<e.length;t++){var i=e[t],r=i.callback;if(r!==null){if(i.callback=null,i=n,typeof r!="function")throw Error(X(191,r));r.call(i)}}}var Nd={},vr=Vo(Nd),Xc=Vo(Nd),Qc=Vo(Nd);function Zo(e){if(e===Nd)throw Error(X(174));return e}function aE(e,t){switch(yt(Qc,t),yt(Xc,e),yt(vr,Nd),e=t.nodeType,e){case 9:case 11:t=(t=t.documentElement)?t.namespaceURI:d_(null,"");break;default:e=e===8?t.parentNode:t,t=e.namespaceURI||null,e=e.tagName,t=d_(t,e)}Dt(vr),yt(vr,t)}function Ca(){Dt(vr),Dt(Xc),Dt(Qc)}function AI(e){Zo(Qc.current);var t=Zo(vr.current),n=d_(t,e.type);t!==n&&(yt(Xc,e),yt(vr,n))}function cE(e){Xc.current===e&&(Dt(vr),Dt(Xc))}var Wt=Vo(0);function gu(e){for(var t=e;t!==null;){if(t.tag===13){var n=t.memoizedState;if(n!==null&&(n=n.dehydrated,n===null||n.data==="$?"||n.data==="$!"))return t}else if(t.tag===19&&t.memoizedProps.revealOrder!==void 0){if(t.flags&128)return t}else if(t.child!==null){t.child.return=t,t=t.child;continue}if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return null;t=t.return}t.sibling.return=t.return,t=t.sibling}return null}var qh=[];function dE(){for(var e=0;e<qh.length;e++)qh[e]._workInProgressVersionPrimary=null;qh.length=0}var bl=$r.ReactCurrentDispatcher,Jh=$r.ReactCurrentBatchConfig,_s=0,zt=null,pn=null,Sn=null,Su=!1,bc=!1,Zc=0,OO=0;function Nn(){throw Error(X(321))}function lE(e,t){if(t===null)return!1;for(var n=0;n<t.length&&n<e.length;n++)if(!ir(e[n],t[n]))return!1;return!0}function uE(e,t,n,i,r,o){if(_s=o,zt=t,t.memoizedState=null,t.updateQueue=null,t.lanes=0,bl.current=e===null||e.memoizedState===null?LO:kO,e=n(i,r),bc){o=0;do{if(bc=!1,Zc=0,25<=o)throw Error(X(301));o+=1,Sn=pn=null,t.updateQueue=null,bl.current=MO,e=n(i,r)}while(bc)}if(bl.current=Tu,t=pn!==null&&pn.next!==null,_s=0,Sn=pn=zt=null,Su=!1,t)throw Error(X(300));return e}function hE(){var e=Zc!==0;return Zc=0,e}function pr(){var e={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return Sn===null?zt.memoizedState=Sn=e:Sn=Sn.next=e,Sn}function xi(){if(pn===null){var e=zt.alternate;e=e!==null?e.memoizedState:null}else e=pn.next;var t=Sn===null?zt.memoizedState:Sn.next;if(t!==null)Sn=t,pn=e;else{if(e===null)throw Error(X(310));pn=e,e={memoizedState:pn.memoizedState,baseState:pn.baseState,baseQueue:pn.baseQueue,queue:pn.queue,next:null},Sn===null?zt.memoizedState=Sn=e:Sn=Sn.next=e}return Sn}function ed(e,t){return typeof t=="function"?t(e):t}function Xh(e){var t=xi(),n=t.queue;if(n===null)throw Error(X(311));n.lastRenderedReducer=e;var i=pn,r=i.baseQueue,o=n.pending;if(o!==null){if(r!==null){var s=r.next;r.next=o.next,o.next=s}i.baseQueue=r=o,n.pending=null}if(r!==null){o=r.next,i=i.baseState;var a=s=null,c=null,d=o;do{var l=d.lane;if((_s&l)===l)c!==null&&(c=c.next={lane:0,action:d.action,hasEagerState:d.hasEagerState,eagerState:d.eagerState,next:null}),i=d.hasEagerState?d.eagerState:e(i,d.action);else{var u={lane:l,action:d.action,hasEagerState:d.hasEagerState,eagerState:d.eagerState,next:null};c===null?(a=c=u,s=i):c=c.next=u,zt.lanes|=l,fs|=l}d=d.next}while(d!==null&&d!==o);c===null?s=i:c.next=a,ir(i,t.memoizedState)||(ei=!0),t.memoizedState=i,t.baseState=s,t.baseQueue=c,n.lastRenderedState=i}if(e=n.interleaved,e!==null){r=e;do o=r.lane,zt.lanes|=o,fs|=o,r=r.next;while(r!==e)}else r===null&&(n.lanes=0);return[t.memoizedState,n.dispatch]}function Qh(e){var t=xi(),n=t.queue;if(n===null)throw Error(X(311));n.lastRenderedReducer=e;var i=n.dispatch,r=n.pending,o=t.memoizedState;if(r!==null){n.pending=null;var s=r=r.next;do o=e(o,s.action),s=s.next;while(s!==r);ir(o,t.memoizedState)||(ei=!0),t.memoizedState=o,t.baseQueue===null&&(t.baseState=o),n.lastRenderedState=o}return[o,i]}function wI(){}function NI(e,t){var n=zt,i=xi(),r=t(),o=!ir(i.memoizedState,r);if(o&&(i.memoizedState=r,ei=!0),i=i.queue,pE(DI.bind(null,n,i,e),[e]),i.getSnapshot!==t||o||Sn!==null&&Sn.memoizedState.tag&1){if(n.flags|=2048,td(9,bI.bind(null,n,i,r,t),void 0,null),vn===null)throw Error(X(349));_s&30||OI(n,t,r)}return r}function OI(e,t,n){e.flags|=16384,e={getSnapshot:t,value:n},t=zt.updateQueue,t===null?(t={lastEffect:null,stores:null},zt.updateQueue=t,t.stores=[e]):(n=t.stores,n===null?t.stores=[e]:n.push(e))}function bI(e,t,n,i){t.value=n,t.getSnapshot=i,PI(t)&&LI(e)}function DI(e,t,n){return n(function(){PI(t)&&LI(e)})}function PI(e){var t=e.getSnapshot;e=e.value;try{var n=t();return!ir(e,n)}catch{return!0}}function LI(e){var t=zr(e,1);t!==null&&Zi(t,e,1,-1)}function Zm(e){var t=pr();return typeof e=="function"&&(e=e()),t.memoizedState=t.baseState=e,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:ed,lastRenderedState:e},t.queue=e,e=e.dispatch=PO.bind(null,zt,e),[t.memoizedState,e]}function td(e,t,n,i){return e={tag:e,create:t,destroy:n,deps:i,next:null},t=zt.updateQueue,t===null?(t={lastEffect:null,stores:null},zt.updateQueue=t,t.lastEffect=e.next=e):(n=t.lastEffect,n===null?t.lastEffect=e.next=e:(i=n.next,n.next=e,e.next=i,t.lastEffect=e)),e}function kI(){return xi().memoizedState}function Dl(e,t,n,i){var r=pr();zt.flags|=e,r.memoizedState=td(1|t,n,void 0,i===void 0?null:i)}function qu(e,t,n,i){var r=xi();i=i===void 0?null:i;var o=void 0;if(pn!==null){var s=pn.memoizedState;if(o=s.destroy,i!==null&&lE(i,s.deps)){r.memoizedState=td(t,n,o,i);return}}zt.flags|=e,r.memoizedState=td(1|t,n,o,i)}function eg(e,t){return Dl(8390656,8,e,t)}function pE(e,t){return qu(2048,8,e,t)}function MI(e,t){return qu(4,2,e,t)}function UI(e,t){return qu(4,4,e,t)}function xI(e,t){if(typeof t=="function")return e=e(),t(e),function(){t(null)};if(t!=null)return e=e(),t.current=e,function(){t.current=null}}function VI(e,t,n){return n=n!=null?n.concat([e]):null,qu(4,4,xI.bind(null,t,e),n)}function _E(){}function FI(e,t){var n=xi();t=t===void 0?null:t;var i=n.memoizedState;return i!==null&&t!==null&&lE(t,i[1])?i[0]:(n.memoizedState=[e,t],e)}function BI(e,t){var n=xi();t=t===void 0?null:t;var i=n.memoizedState;return i!==null&&t!==null&&lE(t,i[1])?i[0]:(e=e(),n.memoizedState=[e,t],e)}function GI(e,t,n){return _s&21?(ir(n,t)||(n=zv(),zt.lanes|=n,fs|=n,e.baseState=!0),t):(e.baseState&&(e.baseState=!1,ei=!0),e.memoizedState=n)}function bO(e,t){var n=Et;Et=n!==0&&4>n?n:4,e(!0);var i=Jh.transition;Jh.transition={};try{e(!1),t()}finally{Et=n,Jh.transition=i}}function jI(){return xi().memoizedState}function DO(e,t,n){var i=Ao(e);if(n={lane:i,action:n,hasEagerState:!1,eagerState:null,next:null},WI(e))HI(t,n);else if(n=II(e,t,n,i),n!==null){var r=Hn();Zi(n,e,i,r),KI(n,t,i)}}function PO(e,t,n){var i=Ao(e),r={lane:i,action:n,hasEagerState:!1,eagerState:null,next:null};if(WI(e))HI(t,r);else{var o=e.alternate;if(e.lanes===0&&(o===null||o.lanes===0)&&(o=t.lastRenderedReducer,o!==null))try{var s=t.lastRenderedState,a=o(s,n);if(r.hasEagerState=!0,r.eagerState=a,ir(a,s)){var c=t.interleaved;c===null?(r.next=r,oE(t)):(r.next=c.next,c.next=r),t.interleaved=r;return}}catch{}finally{}n=II(e,t,r,i),n!==null&&(r=Hn(),Zi(n,e,i,r),KI(n,t,i))}}function WI(e){var t=e.alternate;return e===zt||t!==null&&t===zt}function HI(e,t){bc=Su=!0;var n=e.pending;n===null?t.next=t:(t.next=n.next,n.next=t),e.pending=t}function KI(e,t,n){if(n&4194240){var i=t.lanes;i&=e.pendingLanes,n|=i,t.lanes=n,Kf(e,n)}}var Tu={readContext:Ui,useCallback:Nn,useContext:Nn,useEffect:Nn,useImperativeHandle:Nn,useInsertionEffect:Nn,useLayoutEffect:Nn,useMemo:Nn,useReducer:Nn,useRef:Nn,useState:Nn,useDebugValue:Nn,useDeferredValue:Nn,useTransition:Nn,useMutableSource:Nn,useSyncExternalStore:Nn,useId:Nn,unstable_isNewReconciler:!1},LO={readContext:Ui,useCallback:function(e,t){return pr().memoizedState=[e,t===void 0?null:t],e},useContext:Ui,useEffect:eg,useImperativeHandle:function(e,t,n){return n=n!=null?n.concat([e]):null,Dl(4194308,4,xI.bind(null,t,e),n)},useLayoutEffect:function(e,t){return Dl(4194308,4,e,t)},useInsertionEffect:function(e,t){return Dl(4,2,e,t)},useMemo:function(e,t){var n=pr();return t=t===void 0?null:t,e=e(),n.memoizedState=[e,t],e},useReducer:function(e,t,n){var i=pr();return t=n!==void 0?n(t):t,i.memoizedState=i.baseState=t,e={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:e,lastRenderedState:t},i.queue=e,e=e.dispatch=DO.bind(null,zt,e),[i.memoizedState,e]},useRef:function(e){var t=pr();return e={current:e},t.memoizedState=e},useState:Zm,useDebugValue:_E,useDeferredValue:function(e){return pr().memoizedState=e},useTransition:function(){var e=Zm(!1),t=e[0];return e=bO.bind(null,e[1]),pr().memoizedState=e,[t,e]},useMutableSource:function(){},useSyncExternalStore:function(e,t,n){var i=zt,r=pr();if(Ft){if(n===void 0)throw Error(X(407));n=n()}else{if(n=t(),vn===null)throw Error(X(349));_s&30||OI(i,t,n)}r.memoizedState=n;var o={value:n,getSnapshot:t};return r.queue=o,eg(DI.bind(null,i,o,e),[e]),i.flags|=2048,td(9,bI.bind(null,i,o,n,t),void 0,null),n},useId:function(){var e=pr(),t=vn.identifierPrefix;if(Ft){var n=Gr,i=Br;n=(i&~(1<<32-Qi(i)-1)).toString(32)+n,t=":"+t+"R"+n,n=Zc++,0<n&&(t+="H"+n.toString(32)),t+=":"}else n=OO++,t=":"+t+"r"+n.toString(32)+":";return e.memoizedState=t},unstable_isNewReconciler:!1},kO={readContext:Ui,useCallback:FI,useContext:Ui,useEffect:pE,useImperativeHandle:VI,useInsertionEffect:MI,useLayoutEffect:UI,useMemo:BI,useReducer:Xh,useRef:kI,useState:function(){return Xh(ed)},useDebugValue:_E,useDeferredValue:function(e){var t=xi();return GI(t,pn.memoizedState,e)},useTransition:function(){var e=Xh(ed)[0],t=xi().memoizedState;return[e,t]},useMutableSource:wI,useSyncExternalStore:NI,useId:jI,unstable_isNewReconciler:!1},MO={readContext:Ui,useCallback:FI,useContext:Ui,useEffect:pE,useImperativeHandle:VI,useInsertionEffect:MI,useLayoutEffect:UI,useMemo:BI,useReducer:Qh,useRef:kI,useState:function(){return Qh(ed)},useDebugValue:_E,useDeferredValue:function(e){var t=xi();return pn===null?t.memoizedState=e:GI(t,pn.memoizedState,e)},useTransition:function(){var e=Qh(ed)[0],t=xi().memoizedState;return[e,t]},useMutableSource:wI,useSyncExternalStore:NI,useId:jI,unstable_isNewReconciler:!1};function Yi(e,t){if(e&&e.defaultProps){t=Yt({},t),e=e.defaultProps;for(var n in e)t[n]===void 0&&(t[n]=e[n]);return t}return t}function b_(e,t,n,i){t=e.memoizedState,n=n(i,t),n=n==null?t:Yt({},t,n),e.memoizedState=n,e.lanes===0&&(e.updateQueue.baseState=n)}var Ju={isMounted:function(e){return(e=e._reactInternals)?As(e)===e:!1},enqueueSetState:function(e,t,n){e=e._reactInternals;var i=Hn(),r=Ao(e),o=Wr(i,r);o.payload=t,n!=null&&(o.callback=n),t=Io(e,o,r),t!==null&&(Zi(t,e,r,i),Ol(t,e,r))},enqueueReplaceState:function(e,t,n){e=e._reactInternals;var i=Hn(),r=Ao(e),o=Wr(i,r);o.tag=1,o.payload=t,n!=null&&(o.callback=n),t=Io(e,o,r),t!==null&&(Zi(t,e,r,i),Ol(t,e,r))},enqueueForceUpdate:function(e,t){e=e._reactInternals;var n=Hn(),i=Ao(e),r=Wr(n,i);r.tag=2,t!=null&&(r.callback=t),t=Io(e,r,i),t!==null&&(Zi(t,e,i,n),Ol(t,e,i))}};function tg(e,t,n,i,r,o,s){return e=e.stateNode,typeof e.shouldComponentUpdate=="function"?e.shouldComponentUpdate(i,o,s):t.prototype&&t.prototype.isPureReactComponent?!Yc(n,i)||!Yc(r,o):!0}function zI(e,t,n){var i=!1,r=Lo,o=t.contextType;return typeof o=="object"&&o!==null?o=Ui(o):(r=ii(t)?hs:Mn.current,i=t.contextTypes,o=(i=i!=null)?Sa(e,r):Lo),t=new t(n,o),e.memoizedState=t.state!==null&&t.state!==void 0?t.state:null,t.updater=Ju,e.stateNode=t,t._reactInternals=e,i&&(e=e.stateNode,e.__reactInternalMemoizedUnmaskedChildContext=r,e.__reactInternalMemoizedMaskedChildContext=o),t}function ng(e,t,n,i){e=t.state,typeof t.componentWillReceiveProps=="function"&&t.componentWillReceiveProps(n,i),typeof t.UNSAFE_componentWillReceiveProps=="function"&&t.UNSAFE_componentWillReceiveProps(n,i),t.state!==e&&Ju.enqueueReplaceState(t,t.state,null)}function D_(e,t,n,i){var r=e.stateNode;r.props=n,r.state=e.memoizedState,r.refs={},sE(e);var o=t.contextType;typeof o=="object"&&o!==null?r.context=Ui(o):(o=ii(t)?hs:Mn.current,r.context=Sa(e,o)),r.state=e.memoizedState,o=t.getDerivedStateFromProps,typeof o=="function"&&(b_(e,t,o,n),r.state=e.memoizedState),typeof t.getDerivedStateFromProps=="function"||typeof r.getSnapshotBeforeUpdate=="function"||typeof r.UNSAFE_componentWillMount!="function"&&typeof r.componentWillMount!="function"||(t=r.state,typeof r.componentWillMount=="function"&&r.componentWillMount(),typeof r.UNSAFE_componentWillMount=="function"&&r.UNSAFE_componentWillMount(),t!==r.state&&Ju.enqueueReplaceState(r,r.state,null),mu(e,n,r,i),r.state=e.memoizedState),typeof r.componentDidMount=="function"&&(e.flags|=4194308)}function va(e,t){try{var n="",i=t;do n+=dN(i),i=i.return;while(i);var r=n}catch(o){r=`
Error generating stack: `+o.message+`
`+o.stack}return{value:e,source:t,stack:r,digest:null}}function Zh(e,t,n){return{value:e,source:null,stack:n??null,digest:t??null}}function P_(e,t){try{console.error(t.value)}catch(n){setTimeout(function(){throw n})}}var UO=typeof WeakMap=="function"?WeakMap:Map;function YI(e,t,n){n=Wr(-1,n),n.tag=3,n.payload={element:null};var i=t.value;return n.callback=function(){Cu||(Cu=!0,j_=i),P_(e,t)},n}function $I(e,t,n){n=Wr(-1,n),n.tag=3;var i=e.type.getDerivedStateFromError;if(typeof i=="function"){var r=t.value;n.payload=function(){return i(r)},n.callback=function(){P_(e,t)}}var o=e.stateNode;return o!==null&&typeof o.componentDidCatch=="function"&&(n.callback=function(){P_(e,t),typeof i!="function"&&(yo===null?yo=new Set([this]):yo.add(this));var s=t.stack;this.componentDidCatch(t.value,{componentStack:s!==null?s:""})}),n}function ig(e,t,n){var i=e.pingCache;if(i===null){i=e.pingCache=new UO;var r=new Set;i.set(t,r)}else r=i.get(t),r===void 0&&(r=new Set,i.set(t,r));r.has(n)||(r.add(n),e=JO.bind(null,e,t,n),t.then(e,e))}function rg(e){do{var t;if((t=e.tag===13)&&(t=e.memoizedState,t=t!==null?t.dehydrated!==null:!0),t)return e;e=e.return}while(e!==null);return null}function og(e,t,n,i,r){return e.mode&1?(e.flags|=65536,e.lanes=r,e):(e===t?e.flags|=65536:(e.flags|=128,n.flags|=131072,n.flags&=-52805,n.tag===1&&(n.alternate===null?n.tag=17:(t=Wr(-1,1),t.tag=2,Io(n,t,1))),n.lanes|=1),e)}var xO=$r.ReactCurrentOwner,ei=!1;function Fn(e,t,n,i){t.child=e===null?vI(t,null,n,i):Ra(t,e.child,n,i)}function sg(e,t,n,i,r){n=n.render;var o=t.ref;return da(t,r),i=uE(e,t,n,i,o,r),n=hE(),e!==null&&!ei?(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,Yr(e,t,r)):(Ft&&n&&Zf(t),t.flags|=1,Fn(e,t,i,r),t.child)}function ag(e,t,n,i,r){if(e===null){var o=n.type;return typeof o=="function"&&!CE(o)&&o.defaultProps===void 0&&n.compare===null&&n.defaultProps===void 0?(t.tag=15,t.type=o,qI(e,t,o,i,r)):(e=Ml(n.type,null,i,t,t.mode,r),e.ref=t.ref,e.return=t,t.child=e)}if(o=e.child,!(e.lanes&r)){var s=o.memoizedProps;if(n=n.compare,n=n!==null?n:Yc,n(s,i)&&e.ref===t.ref)return Yr(e,t,r)}return t.flags|=1,e=wo(o,i),e.ref=t.ref,e.return=t,t.child=e}function qI(e,t,n,i,r){if(e!==null){var o=e.memoizedProps;if(Yc(o,i)&&e.ref===t.ref)if(ei=!1,t.pendingProps=i=o,(e.lanes&r)!==0)e.flags&131072&&(ei=!0);else return t.lanes=e.lanes,Yr(e,t,r)}return L_(e,t,n,i,r)}function JI(e,t,n){var i=t.pendingProps,r=i.children,o=e!==null?e.memoizedState:null;if(i.mode==="hidden")if(!(t.mode&1))t.memoizedState={baseLanes:0,cachePool:null,transitions:null},yt(ta,ui),ui|=n;else{if(!(n&1073741824))return e=o!==null?o.baseLanes|n:n,t.lanes=t.childLanes=1073741824,t.memoizedState={baseLanes:e,cachePool:null,transitions:null},t.updateQueue=null,yt(ta,ui),ui|=e,null;t.memoizedState={baseLanes:0,cachePool:null,transitions:null},i=o!==null?o.baseLanes:n,yt(ta,ui),ui|=i}else o!==null?(i=o.baseLanes|n,t.memoizedState=null):i=n,yt(ta,ui),ui|=i;return Fn(e,t,r,n),t.child}function XI(e,t){var n=t.ref;(e===null&&n!==null||e!==null&&e.ref!==n)&&(t.flags|=512,t.flags|=2097152)}function L_(e,t,n,i,r){var o=ii(n)?hs:Mn.current;return o=Sa(t,o),da(t,r),n=uE(e,t,n,i,o,r),i=hE(),e!==null&&!ei?(t.updateQueue=e.updateQueue,t.flags&=-2053,e.lanes&=~r,Yr(e,t,r)):(Ft&&i&&Zf(t),t.flags|=1,Fn(e,t,n,r),t.child)}function cg(e,t,n,i,r){if(ii(n)){var o=!0;hu(t)}else o=!1;if(da(t,r),t.stateNode===null)Pl(e,t),zI(t,n,i),D_(t,n,i,r),i=!0;else if(e===null){var s=t.stateNode,a=t.memoizedProps;s.props=a;var c=s.context,d=n.contextType;typeof d=="object"&&d!==null?d=Ui(d):(d=ii(n)?hs:Mn.current,d=Sa(t,d));var l=n.getDerivedStateFromProps,u=typeof l=="function"||typeof s.getSnapshotBeforeUpdate=="function";u||typeof s.UNSAFE_componentWillReceiveProps!="function"&&typeof s.componentWillReceiveProps!="function"||(a!==i||c!==d)&&ng(t,s,i,d),ao=!1;var h=t.memoizedState;s.state=h,mu(t,i,s,r),c=t.memoizedState,a!==i||h!==c||ni.current||ao?(typeof l=="function"&&(b_(t,n,l,i),c=t.memoizedState),(a=ao||tg(t,n,a,i,h,c,d))?(u||typeof s.UNSAFE_componentWillMount!="function"&&typeof s.componentWillMount!="function"||(typeof s.componentWillMount=="function"&&s.componentWillMount(),typeof s.UNSAFE_componentWillMount=="function"&&s.UNSAFE_componentWillMount()),typeof s.componentDidMount=="function"&&(t.flags|=4194308)):(typeof s.componentDidMount=="function"&&(t.flags|=4194308),t.memoizedProps=i,t.memoizedState=c),s.props=i,s.state=c,s.context=d,i=a):(typeof s.componentDidMount=="function"&&(t.flags|=4194308),i=!1)}else{s=t.stateNode,yI(e,t),a=t.memoizedProps,d=t.type===t.elementType?a:Yi(t.type,a),s.props=d,u=t.pendingProps,h=s.context,c=n.contextType,typeof c=="object"&&c!==null?c=Ui(c):(c=ii(n)?hs:Mn.current,c=Sa(t,c));var p=n.getDerivedStateFromProps;(l=typeof p=="function"||typeof s.getSnapshotBeforeUpdate=="function")||typeof s.UNSAFE_componentWillReceiveProps!="function"&&typeof s.componentWillReceiveProps!="function"||(a!==u||h!==c)&&ng(t,s,i,c),ao=!1,h=t.memoizedState,s.state=h,mu(t,i,s,r);var m=t.memoizedState;a!==u||h!==m||ni.current||ao?(typeof p=="function"&&(b_(t,n,p,i),m=t.memoizedState),(d=ao||tg(t,n,d,i,h,m,c)||!1)?(l||typeof s.UNSAFE_componentWillUpdate!="function"&&typeof s.componentWillUpdate!="function"||(typeof s.componentWillUpdate=="function"&&s.componentWillUpdate(i,m,c),typeof s.UNSAFE_componentWillUpdate=="function"&&s.UNSAFE_componentWillUpdate(i,m,c)),typeof s.componentDidUpdate=="function"&&(t.flags|=4),typeof s.getSnapshotBeforeUpdate=="function"&&(t.flags|=1024)):(typeof s.componentDidUpdate!="function"||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),typeof s.getSnapshotBeforeUpdate!="function"||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),t.memoizedProps=i,t.memoizedState=m),s.props=i,s.state=m,s.context=c,i=d):(typeof s.componentDidUpdate!="function"||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=4),typeof s.getSnapshotBeforeUpdate!="function"||a===e.memoizedProps&&h===e.memoizedState||(t.flags|=1024),i=!1)}return k_(e,t,n,i,o,r)}function k_(e,t,n,i,r,o){XI(e,t);var s=(t.flags&128)!==0;if(!i&&!s)return r&&Ym(t,n,!1),Yr(e,t,o);i=t.stateNode,xO.current=t;var a=s&&typeof n.getDerivedStateFromError!="function"?null:i.render();return t.flags|=1,e!==null&&s?(t.child=Ra(t,e.child,null,o),t.child=Ra(t,null,a,o)):Fn(e,t,a,o),t.memoizedState=i.state,r&&Ym(t,n,!0),t.child}function QI(e){var t=e.stateNode;t.pendingContext?zm(e,t.pendingContext,t.pendingContext!==t.context):t.context&&zm(e,t.context,!1),aE(e,t.containerInfo)}function dg(e,t,n,i,r){return Ta(),tE(r),t.flags|=256,Fn(e,t,n,i),t.child}var M_={dehydrated:null,treeContext:null,retryLane:0};function U_(e){return{baseLanes:e,cachePool:null,transitions:null}}function ZI(e,t,n){var i=t.pendingProps,r=Wt.current,o=!1,s=(t.flags&128)!==0,a;if((a=s)||(a=e!==null&&e.memoizedState===null?!1:(r&2)!==0),a?(o=!0,t.flags&=-129):(e===null||e.memoizedState!==null)&&(r|=1),yt(Wt,r&1),e===null)return N_(t),e=t.memoizedState,e!==null&&(e=e.dehydrated,e!==null)?(t.mode&1?e.data==="$!"?t.lanes=8:t.lanes=1073741824:t.lanes=1,null):(s=i.children,e=i.fallback,o?(i=t.mode,o=t.child,s={mode:"hidden",children:s},!(i&1)&&o!==null?(o.childLanes=0,o.pendingProps=s):o=Zu(s,i,0,null),e=ds(e,i,n,null),o.return=t,e.return=t,o.sibling=e,t.child=o,t.child.memoizedState=U_(n),t.memoizedState=M_,e):fE(t,s));if(r=e.memoizedState,r!==null&&(a=r.dehydrated,a!==null))return VO(e,t,s,i,a,r,n);if(o){o=i.fallback,s=t.mode,r=e.child,a=r.sibling;var c={mode:"hidden",children:i.children};return!(s&1)&&t.child!==r?(i=t.child,i.childLanes=0,i.pendingProps=c,t.deletions=null):(i=wo(r,c),i.subtreeFlags=r.subtreeFlags&14680064),a!==null?o=wo(a,o):(o=ds(o,s,n,null),o.flags|=2),o.return=t,i.return=t,i.sibling=o,t.child=i,i=o,o=t.child,s=e.child.memoizedState,s=s===null?U_(n):{baseLanes:s.baseLanes|n,cachePool:null,transitions:s.transitions},o.memoizedState=s,o.childLanes=e.childLanes&~n,t.memoizedState=M_,i}return o=e.child,e=o.sibling,i=wo(o,{mode:"visible",children:i.children}),!(t.mode&1)&&(i.lanes=n),i.return=t,i.sibling=null,e!==null&&(n=t.deletions,n===null?(t.deletions=[e],t.flags|=16):n.push(e)),t.child=i,t.memoizedState=null,i}function fE(e,t){return t=Zu({mode:"visible",children:t},e.mode,0,null),t.return=e,e.child=t}function Qd(e,t,n,i){return i!==null&&tE(i),Ra(t,e.child,null,n),e=fE(t,t.pendingProps.children),e.flags|=2,t.memoizedState=null,e}function VO(e,t,n,i,r,o,s){if(n)return t.flags&256?(t.flags&=-257,i=Zh(Error(X(422))),Qd(e,t,s,i)):t.memoizedState!==null?(t.child=e.child,t.flags|=128,null):(o=i.fallback,r=t.mode,i=Zu({mode:"visible",children:i.children},r,0,null),o=ds(o,r,s,null),o.flags|=2,i.return=t,o.return=t,i.sibling=o,t.child=i,t.mode&1&&Ra(t,e.child,null,s),t.child.memoizedState=U_(s),t.memoizedState=M_,o);if(!(t.mode&1))return Qd(e,t,s,null);if(r.data==="$!"){if(i=r.nextSibling&&r.nextSibling.dataset,i)var a=i.dgst;return i=a,o=Error(X(419)),i=Zh(o,i,void 0),Qd(e,t,s,i)}if(a=(s&e.childLanes)!==0,ei||a){if(i=vn,i!==null){switch(s&-s){case 4:r=2;break;case 16:r=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:r=32;break;case 536870912:r=268435456;break;default:r=0}r=r&(i.suspendedLanes|s)?0:r,r!==0&&r!==o.retryLane&&(o.retryLane=r,zr(e,r),Zi(i,e,r,-1))}return RE(),i=Zh(Error(X(421))),Qd(e,t,s,i)}return r.data==="$?"?(t.flags|=128,t.child=e.child,t=XO.bind(null,e),r._reactRetry=t,null):(e=o.treeContext,_i=vo(r.nextSibling),mi=t,Ft=!0,qi=null,e!==null&&(wi[Ni++]=Br,wi[Ni++]=Gr,wi[Ni++]=ps,Br=e.id,Gr=e.overflow,ps=t),t=fE(t,i.children),t.flags|=4096,t)}function lg(e,t,n){e.lanes|=t;var i=e.alternate;i!==null&&(i.lanes|=t),O_(e.return,t,n)}function ep(e,t,n,i,r){var o=e.memoizedState;o===null?e.memoizedState={isBackwards:t,rendering:null,renderingStartTime:0,last:i,tail:n,tailMode:r}:(o.isBackwards=t,o.rendering=null,o.renderingStartTime=0,o.last=i,o.tail=n,o.tailMode=r)}function ey(e,t,n){var i=t.pendingProps,r=i.revealOrder,o=i.tail;if(Fn(e,t,i.children,n),i=Wt.current,i&2)i=i&1|2,t.flags|=128;else{if(e!==null&&e.flags&128)e:for(e=t.child;e!==null;){if(e.tag===13)e.memoizedState!==null&&lg(e,n,t);else if(e.tag===19)lg(e,n,t);else if(e.child!==null){e.child.return=e,e=e.child;continue}if(e===t)break e;for(;e.sibling===null;){if(e.return===null||e.return===t)break e;e=e.return}e.sibling.return=e.return,e=e.sibling}i&=1}if(yt(Wt,i),!(t.mode&1))t.memoizedState=null;else switch(r){case"forwards":for(n=t.child,r=null;n!==null;)e=n.alternate,e!==null&&gu(e)===null&&(r=n),n=n.sibling;n=r,n===null?(r=t.child,t.child=null):(r=n.sibling,n.sibling=null),ep(t,!1,r,n,o);break;case"backwards":for(n=null,r=t.child,t.child=null;r!==null;){if(e=r.alternate,e!==null&&gu(e)===null){t.child=r;break}e=r.sibling,r.sibling=n,n=r,r=e}ep(t,!0,n,null,o);break;case"together":ep(t,!1,null,null,void 0);break;default:t.memoizedState=null}return t.child}function Pl(e,t){!(t.mode&1)&&e!==null&&(e.alternate=null,t.alternate=null,t.flags|=2)}function Yr(e,t,n){if(e!==null&&(t.dependencies=e.dependencies),fs|=t.lanes,!(n&t.childLanes))return null;if(e!==null&&t.child!==e.child)throw Error(X(153));if(t.child!==null){for(e=t.child,n=wo(e,e.pendingProps),t.child=n,n.return=t;e.sibling!==null;)e=e.sibling,n=n.sibling=wo(e,e.pendingProps),n.return=t;n.sibling=null}return t.child}function FO(e,t,n){switch(t.tag){case 3:QI(t),Ta();break;case 5:AI(t);break;case 1:ii(t.type)&&hu(t);break;case 4:aE(t,t.stateNode.containerInfo);break;case 10:var i=t.type._context,r=t.memoizedProps.value;yt(fu,i._currentValue),i._currentValue=r;break;case 13:if(i=t.memoizedState,i!==null)return i.dehydrated!==null?(yt(Wt,Wt.current&1),t.flags|=128,null):n&t.child.childLanes?ZI(e,t,n):(yt(Wt,Wt.current&1),e=Yr(e,t,n),e!==null?e.sibling:null);yt(Wt,Wt.current&1);break;case 19:if(i=(n&t.childLanes)!==0,e.flags&128){if(i)return ey(e,t,n);t.flags|=128}if(r=t.memoizedState,r!==null&&(r.rendering=null,r.tail=null,r.lastEffect=null),yt(Wt,Wt.current),i)break;return null;case 22:case 23:return t.lanes=0,JI(e,t,n)}return Yr(e,t,n)}var ty,x_,ny,iy;ty=function(e,t){for(var n=t.child;n!==null;){if(n.tag===5||n.tag===6)e.appendChild(n.stateNode);else if(n.tag!==4&&n.child!==null){n.child.return=n,n=n.child;continue}if(n===t)break;for(;n.sibling===null;){if(n.return===null||n.return===t)return;n=n.return}n.sibling.return=n.return,n=n.sibling}};x_=function(){};ny=function(e,t,n,i){var r=e.memoizedProps;if(r!==i){e=t.stateNode,Zo(vr.current);var o=null;switch(n){case"input":r=o_(e,r),i=o_(e,i),o=[];break;case"select":r=Yt({},r,{value:void 0}),i=Yt({},i,{value:void 0}),o=[];break;case"textarea":r=c_(e,r),i=c_(e,i),o=[];break;default:typeof r.onClick!="function"&&typeof i.onClick=="function"&&(e.onclick=lu)}l_(n,i);var s;n=null;for(d in r)if(!i.hasOwnProperty(d)&&r.hasOwnProperty(d)&&r[d]!=null)if(d==="style"){var a=r[d];for(s in a)a.hasOwnProperty(s)&&(n||(n={}),n[s]="")}else d!=="dangerouslySetInnerHTML"&&d!=="children"&&d!=="suppressContentEditableWarning"&&d!=="suppressHydrationWarning"&&d!=="autoFocus"&&(Bc.hasOwnProperty(d)?o||(o=[]):(o=o||[]).push(d,null));for(d in i){var c=i[d];if(a=r!=null?r[d]:void 0,i.hasOwnProperty(d)&&c!==a&&(c!=null||a!=null))if(d==="style")if(a){for(s in a)!a.hasOwnProperty(s)||c&&c.hasOwnProperty(s)||(n||(n={}),n[s]="");for(s in c)c.hasOwnProperty(s)&&a[s]!==c[s]&&(n||(n={}),n[s]=c[s])}else n||(o||(o=[]),o.push(d,n)),n=c;else d==="dangerouslySetInnerHTML"?(c=c?c.__html:void 0,a=a?a.__html:void 0,c!=null&&a!==c&&(o=o||[]).push(d,c)):d==="children"?typeof c!="string"&&typeof c!="number"||(o=o||[]).push(d,""+c):d!=="suppressContentEditableWarning"&&d!=="suppressHydrationWarning"&&(Bc.hasOwnProperty(d)?(c!=null&&d==="onScroll"&&At("scroll",e),o||a===c||(o=[])):(o=o||[]).push(d,c))}n&&(o=o||[]).push("style",n);var d=o;(t.updateQueue=d)&&(t.flags|=4)}};iy=function(e,t,n,i){n!==i&&(t.flags|=4)};function nc(e,t){if(!Ft)switch(e.tailMode){case"hidden":t=e.tail;for(var n=null;t!==null;)t.alternate!==null&&(n=t),t=t.sibling;n===null?e.tail=null:n.sibling=null;break;case"collapsed":n=e.tail;for(var i=null;n!==null;)n.alternate!==null&&(i=n),n=n.sibling;i===null?t||e.tail===null?e.tail=null:e.tail.sibling=null:i.sibling=null}}function On(e){var t=e.alternate!==null&&e.alternate.child===e.child,n=0,i=0;if(t)for(var r=e.child;r!==null;)n|=r.lanes|r.childLanes,i|=r.subtreeFlags&14680064,i|=r.flags&14680064,r.return=e,r=r.sibling;else for(r=e.child;r!==null;)n|=r.lanes|r.childLanes,i|=r.subtreeFlags,i|=r.flags,r.return=e,r=r.sibling;return e.subtreeFlags|=i,e.childLanes=n,t}function BO(e,t,n){var i=t.pendingProps;switch(eE(t),t.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return On(t),null;case 1:return ii(t.type)&&uu(),On(t),null;case 3:return i=t.stateNode,Ca(),Dt(ni),Dt(Mn),dE(),i.pendingContext&&(i.context=i.pendingContext,i.pendingContext=null),(e===null||e.child===null)&&(Jd(t)?t.flags|=4:e===null||e.memoizedState.isDehydrated&&!(t.flags&256)||(t.flags|=1024,qi!==null&&(K_(qi),qi=null))),x_(e,t),On(t),null;case 5:cE(t);var r=Zo(Qc.current);if(n=t.type,e!==null&&t.stateNode!=null)ny(e,t,n,i,r),e.ref!==t.ref&&(t.flags|=512,t.flags|=2097152);else{if(!i){if(t.stateNode===null)throw Error(X(166));return On(t),null}if(e=Zo(vr.current),Jd(t)){i=t.stateNode,n=t.type;var o=t.memoizedProps;switch(i[Er]=t,i[Jc]=o,e=(t.mode&1)!==0,n){case"dialog":At("cancel",i),At("close",i);break;case"iframe":case"object":case"embed":At("load",i);break;case"video":case"audio":for(r=0;r<Ec.length;r++)At(Ec[r],i);break;case"source":At("error",i);break;case"img":case"image":case"link":At("error",i),At("load",i);break;case"details":At("toggle",i);break;case"input":Sm(i,o),At("invalid",i);break;case"select":i._wrapperState={wasMultiple:!!o.multiple},At("invalid",i);break;case"textarea":Rm(i,o),At("invalid",i)}l_(n,o),r=null;for(var s in o)if(o.hasOwnProperty(s)){var a=o[s];s==="children"?typeof a=="string"?i.textContent!==a&&(o.suppressHydrationWarning!==!0&&qd(i.textContent,a,e),r=["children",a]):typeof a=="number"&&i.textContent!==""+a&&(o.suppressHydrationWarning!==!0&&qd(i.textContent,a,e),r=["children",""+a]):Bc.hasOwnProperty(s)&&a!=null&&s==="onScroll"&&At("scroll",i)}switch(n){case"input":Gd(i),Tm(i,o,!0);break;case"textarea":Gd(i),Cm(i);break;case"select":case"option":break;default:typeof o.onClick=="function"&&(i.onclick=lu)}i=r,t.updateQueue=i,i!==null&&(t.flags|=4)}else{s=r.nodeType===9?r:r.ownerDocument,e==="http://www.w3.org/1999/xhtml"&&(e=Dv(n)),e==="http://www.w3.org/1999/xhtml"?n==="script"?(e=s.createElement("div"),e.innerHTML="<script><\/script>",e=e.removeChild(e.firstChild)):typeof i.is=="string"?e=s.createElement(n,{is:i.is}):(e=s.createElement(n),n==="select"&&(s=e,i.multiple?s.multiple=!0:i.size&&(s.size=i.size))):e=s.createElementNS(e,n),e[Er]=t,e[Jc]=i,ty(e,t,!1,!1),t.stateNode=e;e:{switch(s=u_(n,i),n){case"dialog":At("cancel",e),At("close",e),r=i;break;case"iframe":case"object":case"embed":At("load",e),r=i;break;case"video":case"audio":for(r=0;r<Ec.length;r++)At(Ec[r],e);r=i;break;case"source":At("error",e),r=i;break;case"img":case"image":case"link":At("error",e),At("load",e),r=i;break;case"details":At("toggle",e),r=i;break;case"input":Sm(e,i),r=o_(e,i),At("invalid",e);break;case"option":r=i;break;case"select":e._wrapperState={wasMultiple:!!i.multiple},r=Yt({},i,{value:void 0}),At("invalid",e);break;case"textarea":Rm(e,i),r=c_(e,i),At("invalid",e);break;default:r=i}l_(n,r),a=r;for(o in a)if(a.hasOwnProperty(o)){var c=a[o];o==="style"?kv(e,c):o==="dangerouslySetInnerHTML"?(c=c?c.__html:void 0,c!=null&&Pv(e,c)):o==="children"?typeof c=="string"?(n!=="textarea"||c!=="")&&Gc(e,c):typeof c=="number"&&Gc(e,""+c):o!=="suppressContentEditableWarning"&&o!=="suppressHydrationWarning"&&o!=="autoFocus"&&(Bc.hasOwnProperty(o)?c!=null&&o==="onScroll"&&At("scroll",e):c!=null&&Ff(e,o,c,s))}switch(n){case"input":Gd(e),Tm(e,i,!1);break;case"textarea":Gd(e),Cm(e);break;case"option":i.value!=null&&e.setAttribute("value",""+Po(i.value));break;case"select":e.multiple=!!i.multiple,o=i.value,o!=null?oa(e,!!i.multiple,o,!1):i.defaultValue!=null&&oa(e,!!i.multiple,i.defaultValue,!0);break;default:typeof r.onClick=="function"&&(e.onclick=lu)}switch(n){case"button":case"input":case"select":case"textarea":i=!!i.autoFocus;break e;case"img":i=!0;break e;default:i=!1}}i&&(t.flags|=4)}t.ref!==null&&(t.flags|=512,t.flags|=2097152)}return On(t),null;case 6:if(e&&t.stateNode!=null)iy(e,t,e.memoizedProps,i);else{if(typeof i!="string"&&t.stateNode===null)throw Error(X(166));if(n=Zo(Qc.current),Zo(vr.current),Jd(t)){if(i=t.stateNode,n=t.memoizedProps,i[Er]=t,(o=i.nodeValue!==n)&&(e=mi,e!==null))switch(e.tag){case 3:qd(i.nodeValue,n,(e.mode&1)!==0);break;case 5:e.memoizedProps.suppressHydrationWarning!==!0&&qd(i.nodeValue,n,(e.mode&1)!==0)}o&&(t.flags|=4)}else i=(n.nodeType===9?n:n.ownerDocument).createTextNode(i),i[Er]=t,t.stateNode=i}return On(t),null;case 13:if(Dt(Wt),i=t.memoizedState,e===null||e.memoizedState!==null&&e.memoizedState.dehydrated!==null){if(Ft&&_i!==null&&t.mode&1&&!(t.flags&128))RI(),Ta(),t.flags|=98560,o=!1;else if(o=Jd(t),i!==null&&i.dehydrated!==null){if(e===null){if(!o)throw Error(X(318));if(o=t.memoizedState,o=o!==null?o.dehydrated:null,!o)throw Error(X(317));o[Er]=t}else Ta(),!(t.flags&128)&&(t.memoizedState=null),t.flags|=4;On(t),o=!1}else qi!==null&&(K_(qi),qi=null),o=!0;if(!o)return t.flags&65536?t:null}return t.flags&128?(t.lanes=n,t):(i=i!==null,i!==(e!==null&&e.memoizedState!==null)&&i&&(t.child.flags|=8192,t.mode&1&&(e===null||Wt.current&1?fn===0&&(fn=3):RE())),t.updateQueue!==null&&(t.flags|=4),On(t),null);case 4:return Ca(),x_(e,t),e===null&&$c(t.stateNode.containerInfo),On(t),null;case 10:return rE(t.type._context),On(t),null;case 17:return ii(t.type)&&uu(),On(t),null;case 19:if(Dt(Wt),o=t.memoizedState,o===null)return On(t),null;if(i=(t.flags&128)!==0,s=o.rendering,s===null)if(i)nc(o,!1);else{if(fn!==0||e!==null&&e.flags&128)for(e=t.child;e!==null;){if(s=gu(e),s!==null){for(t.flags|=128,nc(o,!1),i=s.updateQueue,i!==null&&(t.updateQueue=i,t.flags|=4),t.subtreeFlags=0,i=n,n=t.child;n!==null;)o=n,e=i,o.flags&=14680066,s=o.alternate,s===null?(o.childLanes=0,o.lanes=e,o.child=null,o.subtreeFlags=0,o.memoizedProps=null,o.memoizedState=null,o.updateQueue=null,o.dependencies=null,o.stateNode=null):(o.childLanes=s.childLanes,o.lanes=s.lanes,o.child=s.child,o.subtreeFlags=0,o.deletions=null,o.memoizedProps=s.memoizedProps,o.memoizedState=s.memoizedState,o.updateQueue=s.updateQueue,o.type=s.type,e=s.dependencies,o.dependencies=e===null?null:{lanes:e.lanes,firstContext:e.firstContext}),n=n.sibling;return yt(Wt,Wt.current&1|2),t.child}e=e.sibling}o.tail!==null&&rn()>Ia&&(t.flags|=128,i=!0,nc(o,!1),t.lanes=4194304)}else{if(!i)if(e=gu(s),e!==null){if(t.flags|=128,i=!0,n=e.updateQueue,n!==null&&(t.updateQueue=n,t.flags|=4),nc(o,!0),o.tail===null&&o.tailMode==="hidden"&&!s.alternate&&!Ft)return On(t),null}else 2*rn()-o.renderingStartTime>Ia&&n!==1073741824&&(t.flags|=128,i=!0,nc(o,!1),t.lanes=4194304);o.isBackwards?(s.sibling=t.child,t.child=s):(n=o.last,n!==null?n.sibling=s:t.child=s,o.last=s)}return o.tail!==null?(t=o.tail,o.rendering=t,o.tail=t.sibling,o.renderingStartTime=rn(),t.sibling=null,n=Wt.current,yt(Wt,i?n&1|2:n&1),t):(On(t),null);case 22:case 23:return TE(),i=t.memoizedState!==null,e!==null&&e.memoizedState!==null!==i&&(t.flags|=8192),i&&t.mode&1?ui&1073741824&&(On(t),t.subtreeFlags&6&&(t.flags|=8192)):On(t),null;case 24:return null;case 25:return null}throw Error(X(156,t.tag))}function GO(e,t){switch(eE(t),t.tag){case 1:return ii(t.type)&&uu(),e=t.flags,e&65536?(t.flags=e&-65537|128,t):null;case 3:return Ca(),Dt(ni),Dt(Mn),dE(),e=t.flags,e&65536&&!(e&128)?(t.flags=e&-65537|128,t):null;case 5:return cE(t),null;case 13:if(Dt(Wt),e=t.memoizedState,e!==null&&e.dehydrated!==null){if(t.alternate===null)throw Error(X(340));Ta()}return e=t.flags,e&65536?(t.flags=e&-65537|128,t):null;case 19:return Dt(Wt),null;case 4:return Ca(),null;case 10:return rE(t.type._context),null;case 22:case 23:return TE(),null;case 24:return null;default:return null}}var Zd=!1,Ln=!1,jO=typeof WeakSet=="function"?WeakSet:Set,oe=null;function ea(e,t){var n=e.ref;if(n!==null)if(typeof n=="function")try{n(null)}catch(i){Qt(e,t,i)}else n.current=null}function V_(e,t,n){try{n()}catch(i){Qt(e,t,i)}}var ug=!1;function WO(e,t){if(R_=au,e=cI(),Qf(e)){if("selectionStart"in e)var n={start:e.selectionStart,end:e.selectionEnd};else e:{n=(n=e.ownerDocument)&&n.defaultView||window;var i=n.getSelection&&n.getSelection();if(i&&i.rangeCount!==0){n=i.anchorNode;var r=i.anchorOffset,o=i.focusNode;i=i.focusOffset;try{n.nodeType,o.nodeType}catch{n=null;break e}var s=0,a=-1,c=-1,d=0,l=0,u=e,h=null;t:for(;;){for(var p;u!==n||r!==0&&u.nodeType!==3||(a=s+r),u!==o||i!==0&&u.nodeType!==3||(c=s+i),u.nodeType===3&&(s+=u.nodeValue.length),(p=u.firstChild)!==null;)h=u,u=p;for(;;){if(u===e)break t;if(h===n&&++d===r&&(a=s),h===o&&++l===i&&(c=s),(p=u.nextSibling)!==null)break;u=h,h=u.parentNode}u=p}n=a===-1||c===-1?null:{start:a,end:c}}else n=null}n=n||{start:0,end:0}}else n=null;for(C_={focusedElem:e,selectionRange:n},au=!1,oe=t;oe!==null;)if(t=oe,e=t.child,(t.subtreeFlags&1028)!==0&&e!==null)e.return=t,oe=e;else for(;oe!==null;){t=oe;try{var m=t.alternate;if(t.flags&1024)switch(t.tag){case 0:case 11:case 15:break;case 1:if(m!==null){var E=m.memoizedProps,g=m.memoizedState,S=t.stateNode,T=S.getSnapshotBeforeUpdate(t.elementType===t.type?E:Yi(t.type,E),g);S.__reactInternalSnapshotBeforeUpdate=T}break;case 3:var I=t.stateNode.containerInfo;I.nodeType===1?I.textContent="":I.nodeType===9&&I.documentElement&&I.removeChild(I.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(X(163))}}catch(y){Qt(t,t.return,y)}if(e=t.sibling,e!==null){e.return=t.return,oe=e;break}oe=t.return}return m=ug,ug=!1,m}function Dc(e,t,n){var i=t.updateQueue;if(i=i!==null?i.lastEffect:null,i!==null){var r=i=i.next;do{if((r.tag&e)===e){var o=r.destroy;r.destroy=void 0,o!==void 0&&V_(t,n,o)}r=r.next}while(r!==i)}}function Xu(e,t){if(t=t.updateQueue,t=t!==null?t.lastEffect:null,t!==null){var n=t=t.next;do{if((n.tag&e)===e){var i=n.create;n.destroy=i()}n=n.next}while(n!==t)}}function F_(e){var t=e.ref;if(t!==null){var n=e.stateNode;switch(e.tag){case 5:e=n;break;default:e=n}typeof t=="function"?t(e):t.current=e}}function ry(e){var t=e.alternate;t!==null&&(e.alternate=null,ry(t)),e.child=null,e.deletions=null,e.sibling=null,e.tag===5&&(t=e.stateNode,t!==null&&(delete t[Er],delete t[Jc],delete t[y_],delete t[yO],delete t[AO])),e.stateNode=null,e.return=null,e.dependencies=null,e.memoizedProps=null,e.memoizedState=null,e.pendingProps=null,e.stateNode=null,e.updateQueue=null}function oy(e){return e.tag===5||e.tag===3||e.tag===4}function hg(e){e:for(;;){for(;e.sibling===null;){if(e.return===null||oy(e.return))return null;e=e.return}for(e.sibling.return=e.return,e=e.sibling;e.tag!==5&&e.tag!==6&&e.tag!==18;){if(e.flags&2||e.child===null||e.tag===4)continue e;e.child.return=e,e=e.child}if(!(e.flags&2))return e.stateNode}}function B_(e,t,n){var i=e.tag;if(i===5||i===6)e=e.stateNode,t?n.nodeType===8?n.parentNode.insertBefore(e,t):n.insertBefore(e,t):(n.nodeType===8?(t=n.parentNode,t.insertBefore(e,n)):(t=n,t.appendChild(e)),n=n._reactRootContainer,n!=null||t.onclick!==null||(t.onclick=lu));else if(i!==4&&(e=e.child,e!==null))for(B_(e,t,n),e=e.sibling;e!==null;)B_(e,t,n),e=e.sibling}function G_(e,t,n){var i=e.tag;if(i===5||i===6)e=e.stateNode,t?n.insertBefore(e,t):n.appendChild(e);else if(i!==4&&(e=e.child,e!==null))for(G_(e,t,n),e=e.sibling;e!==null;)G_(e,t,n),e=e.sibling}var In=null,$i=!1;function Jr(e,t,n){for(n=n.child;n!==null;)sy(e,t,n),n=n.sibling}function sy(e,t,n){if(Cr&&typeof Cr.onCommitFiberUnmount=="function")try{Cr.onCommitFiberUnmount(Wu,n)}catch{}switch(n.tag){case 5:Ln||ea(n,t);case 6:var i=In,r=$i;In=null,Jr(e,t,n),In=i,$i=r,In!==null&&($i?(e=In,n=n.stateNode,e.nodeType===8?e.parentNode.removeChild(n):e.removeChild(n)):In.removeChild(n.stateNode));break;case 18:In!==null&&($i?(e=In,n=n.stateNode,e.nodeType===8?Yh(e.parentNode,n):e.nodeType===1&&Yh(e,n),Kc(e)):Yh(In,n.stateNode));break;case 4:i=In,r=$i,In=n.stateNode.containerInfo,$i=!0,Jr(e,t,n),In=i,$i=r;break;case 0:case 11:case 14:case 15:if(!Ln&&(i=n.updateQueue,i!==null&&(i=i.lastEffect,i!==null))){r=i=i.next;do{var o=r,s=o.destroy;o=o.tag,s!==void 0&&(o&2||o&4)&&V_(n,t,s),r=r.next}while(r!==i)}Jr(e,t,n);break;case 1:if(!Ln&&(ea(n,t),i=n.stateNode,typeof i.componentWillUnmount=="function"))try{i.props=n.memoizedProps,i.state=n.memoizedState,i.componentWillUnmount()}catch(a){Qt(n,t,a)}Jr(e,t,n);break;case 21:Jr(e,t,n);break;case 22:n.mode&1?(Ln=(i=Ln)||n.memoizedState!==null,Jr(e,t,n),Ln=i):Jr(e,t,n);break;default:Jr(e,t,n)}}function pg(e){var t=e.updateQueue;if(t!==null){e.updateQueue=null;var n=e.stateNode;n===null&&(n=e.stateNode=new jO),t.forEach(function(i){var r=QO.bind(null,e,i);n.has(i)||(n.add(i),i.then(r,r))})}}function Bi(e,t){var n=t.deletions;if(n!==null)for(var i=0;i<n.length;i++){var r=n[i];try{var o=e,s=t,a=s;e:for(;a!==null;){switch(a.tag){case 5:In=a.stateNode,$i=!1;break e;case 3:In=a.stateNode.containerInfo,$i=!0;break e;case 4:In=a.stateNode.containerInfo,$i=!0;break e}a=a.return}if(In===null)throw Error(X(160));sy(o,s,r),In=null,$i=!1;var c=r.alternate;c!==null&&(c.return=null),r.return=null}catch(d){Qt(r,t,d)}}if(t.subtreeFlags&12854)for(t=t.child;t!==null;)ay(t,e),t=t.sibling}function ay(e,t){var n=e.alternate,i=e.flags;switch(e.tag){case 0:case 11:case 14:case 15:if(Bi(t,e),cr(e),i&4){try{Dc(3,e,e.return),Xu(3,e)}catch(E){Qt(e,e.return,E)}try{Dc(5,e,e.return)}catch(E){Qt(e,e.return,E)}}break;case 1:Bi(t,e),cr(e),i&512&&n!==null&&ea(n,n.return);break;case 5:if(Bi(t,e),cr(e),i&512&&n!==null&&ea(n,n.return),e.flags&32){var r=e.stateNode;try{Gc(r,"")}catch(E){Qt(e,e.return,E)}}if(i&4&&(r=e.stateNode,r!=null)){var o=e.memoizedProps,s=n!==null?n.memoizedProps:o,a=e.type,c=e.updateQueue;if(e.updateQueue=null,c!==null)try{a==="input"&&o.type==="radio"&&o.name!=null&&Ov(r,o),u_(a,s);var d=u_(a,o);for(s=0;s<c.length;s+=2){var l=c[s],u=c[s+1];l==="style"?kv(r,u):l==="dangerouslySetInnerHTML"?Pv(r,u):l==="children"?Gc(r,u):Ff(r,l,u,d)}switch(a){case"input":s_(r,o);break;case"textarea":bv(r,o);break;case"select":var h=r._wrapperState.wasMultiple;r._wrapperState.wasMultiple=!!o.multiple;var p=o.value;p!=null?oa(r,!!o.multiple,p,!1):h!==!!o.multiple&&(o.defaultValue!=null?oa(r,!!o.multiple,o.defaultValue,!0):oa(r,!!o.multiple,o.multiple?[]:"",!1))}r[Jc]=o}catch(E){Qt(e,e.return,E)}}break;case 6:if(Bi(t,e),cr(e),i&4){if(e.stateNode===null)throw Error(X(162));r=e.stateNode,o=e.memoizedProps;try{r.nodeValue=o}catch(E){Qt(e,e.return,E)}}break;case 3:if(Bi(t,e),cr(e),i&4&&n!==null&&n.memoizedState.isDehydrated)try{Kc(t.containerInfo)}catch(E){Qt(e,e.return,E)}break;case 4:Bi(t,e),cr(e);break;case 13:Bi(t,e),cr(e),r=e.child,r.flags&8192&&(o=r.memoizedState!==null,r.stateNode.isHidden=o,!o||r.alternate!==null&&r.alternate.memoizedState!==null||(gE=rn())),i&4&&pg(e);break;case 22:if(l=n!==null&&n.memoizedState!==null,e.mode&1?(Ln=(d=Ln)||l,Bi(t,e),Ln=d):Bi(t,e),cr(e),i&8192){if(d=e.memoizedState!==null,(e.stateNode.isHidden=d)&&!l&&e.mode&1)for(oe=e,l=e.child;l!==null;){for(u=oe=l;oe!==null;){switch(h=oe,p=h.child,h.tag){case 0:case 11:case 14:case 15:Dc(4,h,h.return);break;case 1:ea(h,h.return);var m=h.stateNode;if(typeof m.componentWillUnmount=="function"){i=h,n=h.return;try{t=i,m.props=t.memoizedProps,m.state=t.memoizedState,m.componentWillUnmount()}catch(E){Qt(i,n,E)}}break;case 5:ea(h,h.return);break;case 22:if(h.memoizedState!==null){fg(u);continue}}p!==null?(p.return=h,oe=p):fg(u)}l=l.sibling}e:for(l=null,u=e;;){if(u.tag===5){if(l===null){l=u;try{r=u.stateNode,d?(o=r.style,typeof o.setProperty=="function"?o.setProperty("display","none","important"):o.display="none"):(a=u.stateNode,c=u.memoizedProps.style,s=c!=null&&c.hasOwnProperty("display")?c.display:null,a.style.display=Lv("display",s))}catch(E){Qt(e,e.return,E)}}}else if(u.tag===6){if(l===null)try{u.stateNode.nodeValue=d?"":u.memoizedProps}catch(E){Qt(e,e.return,E)}}else if((u.tag!==22&&u.tag!==23||u.memoizedState===null||u===e)&&u.child!==null){u.child.return=u,u=u.child;continue}if(u===e)break e;for(;u.sibling===null;){if(u.return===null||u.return===e)break e;l===u&&(l=null),u=u.return}l===u&&(l=null),u.sibling.return=u.return,u=u.sibling}}break;case 19:Bi(t,e),cr(e),i&4&&pg(e);break;case 21:break;default:Bi(t,e),cr(e)}}function cr(e){var t=e.flags;if(t&2){try{e:{for(var n=e.return;n!==null;){if(oy(n)){var i=n;break e}n=n.return}throw Error(X(160))}switch(i.tag){case 5:var r=i.stateNode;i.flags&32&&(Gc(r,""),i.flags&=-33);var o=hg(e);G_(e,o,r);break;case 3:case 4:var s=i.stateNode.containerInfo,a=hg(e);B_(e,a,s);break;default:throw Error(X(161))}}catch(c){Qt(e,e.return,c)}e.flags&=-3}t&4096&&(e.flags&=-4097)}function HO(e,t,n){oe=e,cy(e)}function cy(e,t,n){for(var i=(e.mode&1)!==0;oe!==null;){var r=oe,o=r.child;if(r.tag===22&&i){var s=r.memoizedState!==null||Zd;if(!s){var a=r.alternate,c=a!==null&&a.memoizedState!==null||Ln;a=Zd;var d=Ln;if(Zd=s,(Ln=c)&&!d)for(oe=r;oe!==null;)s=oe,c=s.child,s.tag===22&&s.memoizedState!==null?Eg(r):c!==null?(c.return=s,oe=c):Eg(r);for(;o!==null;)oe=o,cy(o),o=o.sibling;oe=r,Zd=a,Ln=d}_g(e)}else r.subtreeFlags&8772&&o!==null?(o.return=r,oe=o):_g(e)}}function _g(e){for(;oe!==null;){var t=oe;if(t.flags&8772){var n=t.alternate;try{if(t.flags&8772)switch(t.tag){case 0:case 11:case 15:Ln||Xu(5,t);break;case 1:var i=t.stateNode;if(t.flags&4&&!Ln)if(n===null)i.componentDidMount();else{var r=t.elementType===t.type?n.memoizedProps:Yi(t.type,n.memoizedProps);i.componentDidUpdate(r,n.memoizedState,i.__reactInternalSnapshotBeforeUpdate)}var o=t.updateQueue;o!==null&&Qm(t,o,i);break;case 3:var s=t.updateQueue;if(s!==null){if(n=null,t.child!==null)switch(t.child.tag){case 5:n=t.child.stateNode;break;case 1:n=t.child.stateNode}Qm(t,s,n)}break;case 5:var a=t.stateNode;if(n===null&&t.flags&4){n=a;var c=t.memoizedProps;switch(t.type){case"button":case"input":case"select":case"textarea":c.autoFocus&&n.focus();break;case"img":c.src&&(n.src=c.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(t.memoizedState===null){var d=t.alternate;if(d!==null){var l=d.memoizedState;if(l!==null){var u=l.dehydrated;u!==null&&Kc(u)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(X(163))}Ln||t.flags&512&&F_(t)}catch(h){Qt(t,t.return,h)}}if(t===e){oe=null;break}if(n=t.sibling,n!==null){n.return=t.return,oe=n;break}oe=t.return}}function fg(e){for(;oe!==null;){var t=oe;if(t===e){oe=null;break}var n=t.sibling;if(n!==null){n.return=t.return,oe=n;break}oe=t.return}}function Eg(e){for(;oe!==null;){var t=oe;try{switch(t.tag){case 0:case 11:case 15:var n=t.return;try{Xu(4,t)}catch(c){Qt(t,n,c)}break;case 1:var i=t.stateNode;if(typeof i.componentDidMount=="function"){var r=t.return;try{i.componentDidMount()}catch(c){Qt(t,r,c)}}var o=t.return;try{F_(t)}catch(c){Qt(t,o,c)}break;case 5:var s=t.return;try{F_(t)}catch(c){Qt(t,s,c)}}}catch(c){Qt(t,t.return,c)}if(t===e){oe=null;break}var a=t.sibling;if(a!==null){a.return=t.return,oe=a;break}oe=t.return}}var KO=Math.ceil,Ru=$r.ReactCurrentDispatcher,EE=$r.ReactCurrentOwner,ki=$r.ReactCurrentBatchConfig,nt=0,vn=null,cn=null,An=0,ui=0,ta=Vo(0),fn=0,nd=null,fs=0,Qu=0,mE=0,Pc=null,Qn=null,gE=0,Ia=1/0,kr=null,Cu=!1,j_=null,yo=null,el=!1,_o=null,vu=0,Lc=0,W_=null,Ll=-1,kl=0;function Hn(){return nt&6?rn():Ll!==-1?Ll:Ll=rn()}function Ao(e){return e.mode&1?nt&2&&An!==0?An&-An:NO.transition!==null?(kl===0&&(kl=zv()),kl):(e=Et,e!==0||(e=window.event,e=e===void 0?16:Zv(e.type)),e):1}function Zi(e,t,n,i){if(50<Lc)throw Lc=0,W_=null,Error(X(185));yd(e,n,i),(!(nt&2)||e!==vn)&&(e===vn&&(!(nt&2)&&(Qu|=n),fn===4&&lo(e,An)),ri(e,i),n===1&&nt===0&&!(t.mode&1)&&(Ia=rn()+500,$u&&Fo()))}function ri(e,t){var n=e.callbackNode;NN(e,t);var i=su(e,e===vn?An:0);if(i===0)n!==null&&ym(n),e.callbackNode=null,e.callbackPriority=0;else if(t=i&-i,e.callbackPriority!==t){if(n!=null&&ym(n),t===1)e.tag===0?wO(mg.bind(null,e)):gI(mg.bind(null,e)),vO(function(){!(nt&6)&&Fo()}),n=null;else{switch(Yv(i)){case 1:n=Hf;break;case 4:n=Hv;break;case 16:n=ou;break;case 536870912:n=Kv;break;default:n=ou}n=Ey(n,dy.bind(null,e))}e.callbackPriority=t,e.callbackNode=n}}function dy(e,t){if(Ll=-1,kl=0,nt&6)throw Error(X(327));var n=e.callbackNode;if(la()&&e.callbackNode!==n)return null;var i=su(e,e===vn?An:0);if(i===0)return null;if(i&30||i&e.expiredLanes||t)t=Iu(e,i);else{t=i;var r=nt;nt|=2;var o=uy();(vn!==e||An!==t)&&(kr=null,Ia=rn()+500,cs(e,t));do try{$O();break}catch(a){ly(e,a)}while(1);iE(),Ru.current=o,nt=r,cn!==null?t=0:(vn=null,An=0,t=fn)}if(t!==0){if(t===2&&(r=E_(e),r!==0&&(i=r,t=H_(e,r))),t===1)throw n=nd,cs(e,0),lo(e,i),ri(e,rn()),n;if(t===6)lo(e,i);else{if(r=e.current.alternate,!(i&30)&&!zO(r)&&(t=Iu(e,i),t===2&&(o=E_(e),o!==0&&(i=o,t=H_(e,o))),t===1))throw n=nd,cs(e,0),lo(e,i),ri(e,rn()),n;switch(e.finishedWork=r,e.finishedLanes=i,t){case 0:case 1:throw Error(X(345));case 2:Ko(e,Qn,kr);break;case 3:if(lo(e,i),(i&130023424)===i&&(t=gE+500-rn(),10<t)){if(su(e,0)!==0)break;if(r=e.suspendedLanes,(r&i)!==i){Hn(),e.pingedLanes|=e.suspendedLanes&r;break}e.timeoutHandle=I_(Ko.bind(null,e,Qn,kr),t);break}Ko(e,Qn,kr);break;case 4:if(lo(e,i),(i&4194240)===i)break;for(t=e.eventTimes,r=-1;0<i;){var s=31-Qi(i);o=1<<s,s=t[s],s>r&&(r=s),i&=~o}if(i=r,i=rn()-i,i=(120>i?120:480>i?480:1080>i?1080:1920>i?1920:3e3>i?3e3:4320>i?4320:1960*KO(i/1960))-i,10<i){e.timeoutHandle=I_(Ko.bind(null,e,Qn,kr),i);break}Ko(e,Qn,kr);break;case 5:Ko(e,Qn,kr);break;default:throw Error(X(329))}}}return ri(e,rn()),e.callbackNode===n?dy.bind(null,e):null}function H_(e,t){var n=Pc;return e.current.memoizedState.isDehydrated&&(cs(e,t).flags|=256),e=Iu(e,t),e!==2&&(t=Qn,Qn=n,t!==null&&K_(t)),e}function K_(e){Qn===null?Qn=e:Qn.push.apply(Qn,e)}function zO(e){for(var t=e;;){if(t.flags&16384){var n=t.updateQueue;if(n!==null&&(n=n.stores,n!==null))for(var i=0;i<n.length;i++){var r=n[i],o=r.getSnapshot;r=r.value;try{if(!ir(o(),r))return!1}catch{return!1}}}if(n=t.child,t.subtreeFlags&16384&&n!==null)n.return=t,t=n;else{if(t===e)break;for(;t.sibling===null;){if(t.return===null||t.return===e)return!0;t=t.return}t.sibling.return=t.return,t=t.sibling}}return!0}function lo(e,t){for(t&=~mE,t&=~Qu,e.suspendedLanes|=t,e.pingedLanes&=~t,e=e.expirationTimes;0<t;){var n=31-Qi(t),i=1<<n;e[n]=-1,t&=~i}}function mg(e){if(nt&6)throw Error(X(327));la();var t=su(e,0);if(!(t&1))return ri(e,rn()),null;var n=Iu(e,t);if(e.tag!==0&&n===2){var i=E_(e);i!==0&&(t=i,n=H_(e,i))}if(n===1)throw n=nd,cs(e,0),lo(e,t),ri(e,rn()),n;if(n===6)throw Error(X(345));return e.finishedWork=e.current.alternate,e.finishedLanes=t,Ko(e,Qn,kr),ri(e,rn()),null}function SE(e,t){var n=nt;nt|=1;try{return e(t)}finally{nt=n,nt===0&&(Ia=rn()+500,$u&&Fo())}}function Es(e){_o!==null&&_o.tag===0&&!(nt&6)&&la();var t=nt;nt|=1;var n=ki.transition,i=Et;try{if(ki.transition=null,Et=1,e)return e()}finally{Et=i,ki.transition=n,nt=t,!(nt&6)&&Fo()}}function TE(){ui=ta.current,Dt(ta)}function cs(e,t){e.finishedWork=null,e.finishedLanes=0;var n=e.timeoutHandle;if(n!==-1&&(e.timeoutHandle=-1,CO(n)),cn!==null)for(n=cn.return;n!==null;){var i=n;switch(eE(i),i.tag){case 1:i=i.type.childContextTypes,i!=null&&uu();break;case 3:Ca(),Dt(ni),Dt(Mn),dE();break;case 5:cE(i);break;case 4:Ca();break;case 13:Dt(Wt);break;case 19:Dt(Wt);break;case 10:rE(i.type._context);break;case 22:case 23:TE()}n=n.return}if(vn=e,cn=e=wo(e.current,null),An=ui=t,fn=0,nd=null,mE=Qu=fs=0,Qn=Pc=null,Qo!==null){for(t=0;t<Qo.length;t++)if(n=Qo[t],i=n.interleaved,i!==null){n.interleaved=null;var r=i.next,o=n.pending;if(o!==null){var s=o.next;o.next=r,i.next=s}n.pending=i}Qo=null}return e}function ly(e,t){do{var n=cn;try{if(iE(),bl.current=Tu,Su){for(var i=zt.memoizedState;i!==null;){var r=i.queue;r!==null&&(r.pending=null),i=i.next}Su=!1}if(_s=0,Sn=pn=zt=null,bc=!1,Zc=0,EE.current=null,n===null||n.return===null){fn=1,nd=t,cn=null;break}e:{var o=e,s=n.return,a=n,c=t;if(t=An,a.flags|=32768,c!==null&&typeof c=="object"&&typeof c.then=="function"){var d=c,l=a,u=l.tag;if(!(l.mode&1)&&(u===0||u===11||u===15)){var h=l.alternate;h?(l.updateQueue=h.updateQueue,l.memoizedState=h.memoizedState,l.lanes=h.lanes):(l.updateQueue=null,l.memoizedState=null)}var p=rg(s);if(p!==null){p.flags&=-257,og(p,s,a,o,t),p.mode&1&&ig(o,d,t),t=p,c=d;var m=t.updateQueue;if(m===null){var E=new Set;E.add(c),t.updateQueue=E}else m.add(c);break e}else{if(!(t&1)){ig(o,d,t),RE();break e}c=Error(X(426))}}else if(Ft&&a.mode&1){var g=rg(s);if(g!==null){!(g.flags&65536)&&(g.flags|=256),og(g,s,a,o,t),tE(va(c,a));break e}}o=c=va(c,a),fn!==4&&(fn=2),Pc===null?Pc=[o]:Pc.push(o),o=s;do{switch(o.tag){case 3:o.flags|=65536,t&=-t,o.lanes|=t;var S=YI(o,c,t);Xm(o,S);break e;case 1:a=c;var T=o.type,I=o.stateNode;if(!(o.flags&128)&&(typeof T.getDerivedStateFromError=="function"||I!==null&&typeof I.componentDidCatch=="function"&&(yo===null||!yo.has(I)))){o.flags|=65536,t&=-t,o.lanes|=t;var y=$I(o,a,t);Xm(o,y);break e}}o=o.return}while(o!==null)}py(n)}catch(w){t=w,cn===n&&n!==null&&(cn=n=n.return);continue}break}while(1)}function uy(){var e=Ru.current;return Ru.current=Tu,e===null?Tu:e}function RE(){(fn===0||fn===3||fn===2)&&(fn=4),vn===null||!(fs&268435455)&&!(Qu&268435455)||lo(vn,An)}function Iu(e,t){var n=nt;nt|=2;var i=uy();(vn!==e||An!==t)&&(kr=null,cs(e,t));do try{YO();break}catch(r){ly(e,r)}while(1);if(iE(),nt=n,Ru.current=i,cn!==null)throw Error(X(261));return vn=null,An=0,fn}function YO(){for(;cn!==null;)hy(cn)}function $O(){for(;cn!==null&&!SN();)hy(cn)}function hy(e){var t=fy(e.alternate,e,ui);e.memoizedProps=e.pendingProps,t===null?py(e):cn=t,EE.current=null}function py(e){var t=e;do{var n=t.alternate;if(e=t.return,t.flags&32768){if(n=GO(n,t),n!==null){n.flags&=32767,cn=n;return}if(e!==null)e.flags|=32768,e.subtreeFlags=0,e.deletions=null;else{fn=6,cn=null;return}}else if(n=BO(n,t,ui),n!==null){cn=n;return}if(t=t.sibling,t!==null){cn=t;return}cn=t=e}while(t!==null);fn===0&&(fn=5)}function Ko(e,t,n){var i=Et,r=ki.transition;try{ki.transition=null,Et=1,qO(e,t,n,i)}finally{ki.transition=r,Et=i}return null}function qO(e,t,n,i){do la();while(_o!==null);if(nt&6)throw Error(X(327));n=e.finishedWork;var r=e.finishedLanes;if(n===null)return null;if(e.finishedWork=null,e.finishedLanes=0,n===e.current)throw Error(X(177));e.callbackNode=null,e.callbackPriority=0;var o=n.lanes|n.childLanes;if(ON(e,o),e===vn&&(cn=vn=null,An=0),!(n.subtreeFlags&2064)&&!(n.flags&2064)||el||(el=!0,Ey(ou,function(){return la(),null})),o=(n.flags&15990)!==0,n.subtreeFlags&15990||o){o=ki.transition,ki.transition=null;var s=Et;Et=1;var a=nt;nt|=4,EE.current=null,WO(e,n),ay(n,e),fO(C_),au=!!R_,C_=R_=null,e.current=n,HO(n),TN(),nt=a,Et=s,ki.transition=o}else e.current=n;if(el&&(el=!1,_o=e,vu=r),o=e.pendingLanes,o===0&&(yo=null),vN(n.stateNode),ri(e,rn()),t!==null)for(i=e.onRecoverableError,n=0;n<t.length;n++)r=t[n],i(r.value,{componentStack:r.stack,digest:r.digest});if(Cu)throw Cu=!1,e=j_,j_=null,e;return vu&1&&e.tag!==0&&la(),o=e.pendingLanes,o&1?e===W_?Lc++:(Lc=0,W_=e):Lc=0,Fo(),null}function la(){if(_o!==null){var e=Yv(vu),t=ki.transition,n=Et;try{if(ki.transition=null,Et=16>e?16:e,_o===null)var i=!1;else{if(e=_o,_o=null,vu=0,nt&6)throw Error(X(331));var r=nt;for(nt|=4,oe=e.current;oe!==null;){var o=oe,s=o.child;if(oe.flags&16){var a=o.deletions;if(a!==null){for(var c=0;c<a.length;c++){var d=a[c];for(oe=d;oe!==null;){var l=oe;switch(l.tag){case 0:case 11:case 15:Dc(8,l,o)}var u=l.child;if(u!==null)u.return=l,oe=u;else for(;oe!==null;){l=oe;var h=l.sibling,p=l.return;if(ry(l),l===d){oe=null;break}if(h!==null){h.return=p,oe=h;break}oe=p}}}var m=o.alternate;if(m!==null){var E=m.child;if(E!==null){m.child=null;do{var g=E.sibling;E.sibling=null,E=g}while(E!==null)}}oe=o}}if(o.subtreeFlags&2064&&s!==null)s.return=o,oe=s;else e:for(;oe!==null;){if(o=oe,o.flags&2048)switch(o.tag){case 0:case 11:case 15:Dc(9,o,o.return)}var S=o.sibling;if(S!==null){S.return=o.return,oe=S;break e}oe=o.return}}var T=e.current;for(oe=T;oe!==null;){s=oe;var I=s.child;if(s.subtreeFlags&2064&&I!==null)I.return=s,oe=I;else e:for(s=T;oe!==null;){if(a=oe,a.flags&2048)try{switch(a.tag){case 0:case 11:case 15:Xu(9,a)}}catch(w){Qt(a,a.return,w)}if(a===s){oe=null;break e}var y=a.sibling;if(y!==null){y.return=a.return,oe=y;break e}oe=a.return}}if(nt=r,Fo(),Cr&&typeof Cr.onPostCommitFiberRoot=="function")try{Cr.onPostCommitFiberRoot(Wu,e)}catch{}i=!0}return i}finally{Et=n,ki.transition=t}}return!1}function gg(e,t,n){t=va(n,t),t=YI(e,t,1),e=Io(e,t,1),t=Hn(),e!==null&&(yd(e,1,t),ri(e,t))}function Qt(e,t,n){if(e.tag===3)gg(e,e,n);else for(;t!==null;){if(t.tag===3){gg(t,e,n);break}else if(t.tag===1){var i=t.stateNode;if(typeof t.type.getDerivedStateFromError=="function"||typeof i.componentDidCatch=="function"&&(yo===null||!yo.has(i))){e=va(n,e),e=$I(t,e,1),t=Io(t,e,1),e=Hn(),t!==null&&(yd(t,1,e),ri(t,e));break}}t=t.return}}function JO(e,t,n){var i=e.pingCache;i!==null&&i.delete(t),t=Hn(),e.pingedLanes|=e.suspendedLanes&n,vn===e&&(An&n)===n&&(fn===4||fn===3&&(An&130023424)===An&&500>rn()-gE?cs(e,0):mE|=n),ri(e,t)}function _y(e,t){t===0&&(e.mode&1?(t=Hd,Hd<<=1,!(Hd&130023424)&&(Hd=4194304)):t=1);var n=Hn();e=zr(e,t),e!==null&&(yd(e,t,n),ri(e,n))}function XO(e){var t=e.memoizedState,n=0;t!==null&&(n=t.retryLane),_y(e,n)}function QO(e,t){var n=0;switch(e.tag){case 13:var i=e.stateNode,r=e.memoizedState;r!==null&&(n=r.retryLane);break;case 19:i=e.stateNode;break;default:throw Error(X(314))}i!==null&&i.delete(t),_y(e,n)}var fy;fy=function(e,t,n){if(e!==null)if(e.memoizedProps!==t.pendingProps||ni.current)ei=!0;else{if(!(e.lanes&n)&&!(t.flags&128))return ei=!1,FO(e,t,n);ei=!!(e.flags&131072)}else ei=!1,Ft&&t.flags&1048576&&SI(t,_u,t.index);switch(t.lanes=0,t.tag){case 2:var i=t.type;Pl(e,t),e=t.pendingProps;var r=Sa(t,Mn.current);da(t,n),r=uE(null,t,i,e,r,n);var o=hE();return t.flags|=1,typeof r=="object"&&r!==null&&typeof r.render=="function"&&r.$$typeof===void 0?(t.tag=1,t.memoizedState=null,t.updateQueue=null,ii(i)?(o=!0,hu(t)):o=!1,t.memoizedState=r.state!==null&&r.state!==void 0?r.state:null,sE(t),r.updater=Ju,t.stateNode=r,r._reactInternals=t,D_(t,i,e,n),t=k_(null,t,i,!0,o,n)):(t.tag=0,Ft&&o&&Zf(t),Fn(null,t,r,n),t=t.child),t;case 16:i=t.elementType;e:{switch(Pl(e,t),e=t.pendingProps,r=i._init,i=r(i._payload),t.type=i,r=t.tag=eb(i),e=Yi(i,e),r){case 0:t=L_(null,t,i,e,n);break e;case 1:t=cg(null,t,i,e,n);break e;case 11:t=sg(null,t,i,e,n);break e;case 14:t=ag(null,t,i,Yi(i.type,e),n);break e}throw Error(X(306,i,""))}return t;case 0:return i=t.type,r=t.pendingProps,r=t.elementType===i?r:Yi(i,r),L_(e,t,i,r,n);case 1:return i=t.type,r=t.pendingProps,r=t.elementType===i?r:Yi(i,r),cg(e,t,i,r,n);case 3:e:{if(QI(t),e===null)throw Error(X(387));i=t.pendingProps,o=t.memoizedState,r=o.element,yI(e,t),mu(t,i,null,n);var s=t.memoizedState;if(i=s.element,o.isDehydrated)if(o={element:i,isDehydrated:!1,cache:s.cache,pendingSuspenseBoundaries:s.pendingSuspenseBoundaries,transitions:s.transitions},t.updateQueue.baseState=o,t.memoizedState=o,t.flags&256){r=va(Error(X(423)),t),t=dg(e,t,i,n,r);break e}else if(i!==r){r=va(Error(X(424)),t),t=dg(e,t,i,n,r);break e}else for(_i=vo(t.stateNode.containerInfo.firstChild),mi=t,Ft=!0,qi=null,n=vI(t,null,i,n),t.child=n;n;)n.flags=n.flags&-3|4096,n=n.sibling;else{if(Ta(),i===r){t=Yr(e,t,n);break e}Fn(e,t,i,n)}t=t.child}return t;case 5:return AI(t),e===null&&N_(t),i=t.type,r=t.pendingProps,o=e!==null?e.memoizedProps:null,s=r.children,v_(i,r)?s=null:o!==null&&v_(i,o)&&(t.flags|=32),XI(e,t),Fn(e,t,s,n),t.child;case 6:return e===null&&N_(t),null;case 13:return ZI(e,t,n);case 4:return aE(t,t.stateNode.containerInfo),i=t.pendingProps,e===null?t.child=Ra(t,null,i,n):Fn(e,t,i,n),t.child;case 11:return i=t.type,r=t.pendingProps,r=t.elementType===i?r:Yi(i,r),sg(e,t,i,r,n);case 7:return Fn(e,t,t.pendingProps,n),t.child;case 8:return Fn(e,t,t.pendingProps.children,n),t.child;case 12:return Fn(e,t,t.pendingProps.children,n),t.child;case 10:e:{if(i=t.type._context,r=t.pendingProps,o=t.memoizedProps,s=r.value,yt(fu,i._currentValue),i._currentValue=s,o!==null)if(ir(o.value,s)){if(o.children===r.children&&!ni.current){t=Yr(e,t,n);break e}}else for(o=t.child,o!==null&&(o.return=t);o!==null;){var a=o.dependencies;if(a!==null){s=o.child;for(var c=a.firstContext;c!==null;){if(c.context===i){if(o.tag===1){c=Wr(-1,n&-n),c.tag=2;var d=o.updateQueue;if(d!==null){d=d.shared;var l=d.pending;l===null?c.next=c:(c.next=l.next,l.next=c),d.pending=c}}o.lanes|=n,c=o.alternate,c!==null&&(c.lanes|=n),O_(o.return,n,t),a.lanes|=n;break}c=c.next}}else if(o.tag===10)s=o.type===t.type?null:o.child;else if(o.tag===18){if(s=o.return,s===null)throw Error(X(341));s.lanes|=n,a=s.alternate,a!==null&&(a.lanes|=n),O_(s,n,t),s=o.sibling}else s=o.child;if(s!==null)s.return=o;else for(s=o;s!==null;){if(s===t){s=null;break}if(o=s.sibling,o!==null){o.return=s.return,s=o;break}s=s.return}o=s}Fn(e,t,r.children,n),t=t.child}return t;case 9:return r=t.type,i=t.pendingProps.children,da(t,n),r=Ui(r),i=i(r),t.flags|=1,Fn(e,t,i,n),t.child;case 14:return i=t.type,r=Yi(i,t.pendingProps),r=Yi(i.type,r),ag(e,t,i,r,n);case 15:return qI(e,t,t.type,t.pendingProps,n);case 17:return i=t.type,r=t.pendingProps,r=t.elementType===i?r:Yi(i,r),Pl(e,t),t.tag=1,ii(i)?(e=!0,hu(t)):e=!1,da(t,n),zI(t,i,r),D_(t,i,r,n),k_(null,t,i,!0,e,n);case 19:return ey(e,t,n);case 22:return JI(e,t,n)}throw Error(X(156,t.tag))};function Ey(e,t){return Wv(e,t)}function ZO(e,t,n,i){this.tag=e,this.key=n,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=t,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=i,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function Pi(e,t,n,i){return new ZO(e,t,n,i)}function CE(e){return e=e.prototype,!(!e||!e.isReactComponent)}function eb(e){if(typeof e=="function")return CE(e)?1:0;if(e!=null){if(e=e.$$typeof,e===Gf)return 11;if(e===jf)return 14}return 2}function wo(e,t){var n=e.alternate;return n===null?(n=Pi(e.tag,t,e.key,e.mode),n.elementType=e.elementType,n.type=e.type,n.stateNode=e.stateNode,n.alternate=e,e.alternate=n):(n.pendingProps=t,n.type=e.type,n.flags=0,n.subtreeFlags=0,n.deletions=null),n.flags=e.flags&14680064,n.childLanes=e.childLanes,n.lanes=e.lanes,n.child=e.child,n.memoizedProps=e.memoizedProps,n.memoizedState=e.memoizedState,n.updateQueue=e.updateQueue,t=e.dependencies,n.dependencies=t===null?null:{lanes:t.lanes,firstContext:t.firstContext},n.sibling=e.sibling,n.index=e.index,n.ref=e.ref,n}function Ml(e,t,n,i,r,o){var s=2;if(i=e,typeof e=="function")CE(e)&&(s=1);else if(typeof e=="string")s=5;else e:switch(e){case Ks:return ds(n.children,r,o,t);case Bf:s=8,r|=8;break;case t_:return e=Pi(12,n,t,r|2),e.elementType=t_,e.lanes=o,e;case n_:return e=Pi(13,n,t,r),e.elementType=n_,e.lanes=o,e;case i_:return e=Pi(19,n,t,r),e.elementType=i_,e.lanes=o,e;case Av:return Zu(n,r,o,t);default:if(typeof e=="object"&&e!==null)switch(e.$$typeof){case Iv:s=10;break e;case yv:s=9;break e;case Gf:s=11;break e;case jf:s=14;break e;case so:s=16,i=null;break e}throw Error(X(130,e==null?e:typeof e,""))}return t=Pi(s,n,t,r),t.elementType=e,t.type=i,t.lanes=o,t}function ds(e,t,n,i){return e=Pi(7,e,i,t),e.lanes=n,e}function Zu(e,t,n,i){return e=Pi(22,e,i,t),e.elementType=Av,e.lanes=n,e.stateNode={isHidden:!1},e}function tp(e,t,n){return e=Pi(6,e,null,t),e.lanes=n,e}function np(e,t,n){return t=Pi(4,e.children!==null?e.children:[],e.key,t),t.lanes=n,t.stateNode={containerInfo:e.containerInfo,pendingChildren:null,implementation:e.implementation},t}function tb(e,t,n,i,r){this.tag=t,this.containerInfo=e,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Uh(0),this.expirationTimes=Uh(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Uh(0),this.identifierPrefix=i,this.onRecoverableError=r,this.mutableSourceEagerHydrationData=null}function vE(e,t,n,i,r,o,s,a,c){return e=new tb(e,t,n,a,c),t===1?(t=1,o===!0&&(t|=8)):t=0,o=Pi(3,null,null,t),e.current=o,o.stateNode=e,o.memoizedState={element:i,isDehydrated:n,cache:null,transitions:null,pendingSuspenseBoundaries:null},sE(o),e}function nb(e,t,n){var i=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:Hs,key:i==null?null:""+i,children:e,containerInfo:t,implementation:n}}function my(e){if(!e)return Lo;e=e._reactInternals;e:{if(As(e)!==e||e.tag!==1)throw Error(X(170));var t=e;do{switch(t.tag){case 3:t=t.stateNode.context;break e;case 1:if(ii(t.type)){t=t.stateNode.__reactInternalMemoizedMergedChildContext;break e}}t=t.return}while(t!==null);throw Error(X(171))}if(e.tag===1){var n=e.type;if(ii(n))return mI(e,n,t)}return t}function gy(e,t,n,i,r,o,s,a,c){return e=vE(n,i,!0,e,r,o,s,a,c),e.context=my(null),n=e.current,i=Hn(),r=Ao(n),o=Wr(i,r),o.callback=t??null,Io(n,o,r),e.current.lanes=r,yd(e,r,i),ri(e,i),e}function eh(e,t,n,i){var r=t.current,o=Hn(),s=Ao(r);return n=my(n),t.context===null?t.context=n:t.pendingContext=n,t=Wr(o,s),t.payload={element:e},i=i===void 0?null:i,i!==null&&(t.callback=i),e=Io(r,t,s),e!==null&&(Zi(e,r,s,o),Ol(e,r,s)),s}function yu(e){if(e=e.current,!e.child)return null;switch(e.child.tag){case 5:return e.child.stateNode;default:return e.child.stateNode}}function Sg(e,t){if(e=e.memoizedState,e!==null&&e.dehydrated!==null){var n=e.retryLane;e.retryLane=n!==0&&n<t?n:t}}function IE(e,t){Sg(e,t),(e=e.alternate)&&Sg(e,t)}function ib(){return null}var Sy=typeof reportError=="function"?reportError:function(e){console.error(e)};function yE(e){this._internalRoot=e}th.prototype.render=yE.prototype.render=function(e){var t=this._internalRoot;if(t===null)throw Error(X(409));eh(e,t,null,null)};th.prototype.unmount=yE.prototype.unmount=function(){var e=this._internalRoot;if(e!==null){this._internalRoot=null;var t=e.containerInfo;Es(function(){eh(null,e,null,null)}),t[Kr]=null}};function th(e){this._internalRoot=e}th.prototype.unstable_scheduleHydration=function(e){if(e){var t=Jv();e={blockedOn:null,target:e,priority:t};for(var n=0;n<co.length&&t!==0&&t<co[n].priority;n++);co.splice(n,0,e),n===0&&Qv(e)}};function AE(e){return!(!e||e.nodeType!==1&&e.nodeType!==9&&e.nodeType!==11)}function nh(e){return!(!e||e.nodeType!==1&&e.nodeType!==9&&e.nodeType!==11&&(e.nodeType!==8||e.nodeValue!==" react-mount-point-unstable "))}function Tg(){}function rb(e,t,n,i,r){if(r){if(typeof i=="function"){var o=i;i=function(){var d=yu(s);o.call(d)}}var s=gy(t,i,e,0,null,!1,!1,"",Tg);return e._reactRootContainer=s,e[Kr]=s.current,$c(e.nodeType===8?e.parentNode:e),Es(),s}for(;r=e.lastChild;)e.removeChild(r);if(typeof i=="function"){var a=i;i=function(){var d=yu(c);a.call(d)}}var c=vE(e,0,!1,null,null,!1,!1,"",Tg);return e._reactRootContainer=c,e[Kr]=c.current,$c(e.nodeType===8?e.parentNode:e),Es(function(){eh(t,c,n,i)}),c}function ih(e,t,n,i,r){var o=n._reactRootContainer;if(o){var s=o;if(typeof r=="function"){var a=r;r=function(){var c=yu(s);a.call(c)}}eh(t,s,e,r)}else s=rb(n,t,e,r,i);return yu(s)}$v=function(e){switch(e.tag){case 3:var t=e.stateNode;if(t.current.memoizedState.isDehydrated){var n=fc(t.pendingLanes);n!==0&&(Kf(t,n|1),ri(t,rn()),!(nt&6)&&(Ia=rn()+500,Fo()))}break;case 13:Es(function(){var i=zr(e,1);if(i!==null){var r=Hn();Zi(i,e,1,r)}}),IE(e,1)}};zf=function(e){if(e.tag===13){var t=zr(e,134217728);if(t!==null){var n=Hn();Zi(t,e,134217728,n)}IE(e,134217728)}};qv=function(e){if(e.tag===13){var t=Ao(e),n=zr(e,t);if(n!==null){var i=Hn();Zi(n,e,t,i)}IE(e,t)}};Jv=function(){return Et};Xv=function(e,t){var n=Et;try{return Et=e,t()}finally{Et=n}};p_=function(e,t,n){switch(t){case"input":if(s_(e,n),t=n.name,n.type==="radio"&&t!=null){for(n=e;n.parentNode;)n=n.parentNode;for(n=n.querySelectorAll("input[name="+JSON.stringify(""+t)+'][type="radio"]'),t=0;t<n.length;t++){var i=n[t];if(i!==e&&i.form===e.form){var r=Yu(i);if(!r)throw Error(X(90));Nv(i),s_(i,r)}}}break;case"textarea":bv(e,n);break;case"select":t=n.value,t!=null&&oa(e,!!n.multiple,t,!1)}};xv=SE;Vv=Es;var ob={usingClientEntryPoint:!1,Events:[wd,qs,Yu,Mv,Uv,SE]},ic={findFiberByHostInstance:Xo,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},sb={bundleType:ic.bundleType,version:ic.version,rendererPackageName:ic.rendererPackageName,rendererConfig:ic.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:$r.ReactCurrentDispatcher,findHostInstanceByFiber:function(e){return e=Gv(e),e===null?null:e.stateNode},findFiberByHostInstance:ic.findFiberByHostInstance||ib,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var tl=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!tl.isDisabled&&tl.supportsFiber)try{Wu=tl.inject(sb),Cr=tl}catch{}}Si.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=ob;Si.createPortal=function(e,t){var n=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!AE(t))throw Error(X(200));return nb(e,t,null,n)};Si.createRoot=function(e,t){if(!AE(e))throw Error(X(299));var n=!1,i="",r=Sy;return t!=null&&(t.unstable_strictMode===!0&&(n=!0),t.identifierPrefix!==void 0&&(i=t.identifierPrefix),t.onRecoverableError!==void 0&&(r=t.onRecoverableError)),t=vE(e,1,!1,null,null,n,!1,i,r),e[Kr]=t.current,$c(e.nodeType===8?e.parentNode:e),new yE(t)};Si.findDOMNode=function(e){if(e==null)return null;if(e.nodeType===1)return e;var t=e._reactInternals;if(t===void 0)throw typeof e.render=="function"?Error(X(188)):(e=Object.keys(e).join(","),Error(X(268,e)));return e=Gv(t),e=e===null?null:e.stateNode,e};Si.flushSync=function(e){return Es(e)};Si.hydrate=function(e,t,n){if(!nh(t))throw Error(X(200));return ih(null,e,t,!0,n)};Si.hydrateRoot=function(e,t,n){if(!AE(e))throw Error(X(405));var i=n!=null&&n.hydratedSources||null,r=!1,o="",s=Sy;if(n!=null&&(n.unstable_strictMode===!0&&(r=!0),n.identifierPrefix!==void 0&&(o=n.identifierPrefix),n.onRecoverableError!==void 0&&(s=n.onRecoverableError)),t=gy(t,null,e,1,n??null,r,!1,o,s),e[Kr]=t.current,$c(e),i)for(e=0;e<i.length;e++)n=i[e],r=n._getVersion,r=r(n._source),t.mutableSourceEagerHydrationData==null?t.mutableSourceEagerHydrationData=[n,r]:t.mutableSourceEagerHydrationData.push(n,r);return new th(t)};Si.render=function(e,t,n){if(!nh(t))throw Error(X(200));return ih(null,e,t,!1,n)};Si.unmountComponentAtNode=function(e){if(!nh(e))throw Error(X(40));return e._reactRootContainer?(Es(function(){ih(null,null,e,!1,function(){e._reactRootContainer=null,e[Kr]=null})}),!0):!1};Si.unstable_batchedUpdates=SE;Si.unstable_renderSubtreeIntoContainer=function(e,t,n,i){if(!nh(n))throw Error(X(200));if(e==null||e._reactInternals===void 0)throw Error(X(38));return ih(e,t,n,!1,i)};Si.version="18.3.1-next-f1338f8080-20240426";function Ty(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(Ty)}catch(e){console.error(e)}}Ty(),Tv.exports=Si;var ab=Tv.exports,Rg=ab;Zp.createRoot=Rg.createRoot,Zp.hydrateRoot=Rg.hydrateRoot;let Ry=!0,Cy=!0;function Ul(e,t,n){const i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)}function ws(e,t,n){if(!e.RTCPeerConnection)return;const i=e.RTCPeerConnection.prototype,r=i.addEventListener;i.addEventListener=function(s,a){if(s!==t)return r.apply(this,arguments);const c=d=>{const l=n(d);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(a,c),r.apply(this,[s,c])};const o=i.removeEventListener;i.removeEventListener=function(s,a){if(s!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(a))return o.apply(this,arguments);const c=this._eventMap[t].get(a);return this._eventMap[t].delete(a),this._eventMap[t].size===0&&delete this._eventMap[t],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[s,c])},Object.defineProperty(i,"on"+t,{get(){return this["_on"+t]},set(s){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),s&&this.addEventListener(t,this["_on"+t]=s)},enumerable:!0,configurable:!0})}function cb(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Ry=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function db(e){return typeof e!="boolean"?new Error("Argument type: "+typeof e+". Please use a boolean."):(Cy=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function vy(){if(typeof window=="object"){if(Ry)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function wE(e,t){Cy&&console.warn(e+" is deprecated, please use "+t+" instead.")}function lb(e){const t={browser:null,version:null};if(typeof e>"u"||!e.navigator)return t.browser="Not a browser.",t;const{navigator:n}=e;if(n.mozGetUserMedia)t.browser="firefox",t.version=Ul(n.userAgent,/Firefox\/(\d+)\./,1);else if(n.webkitGetUserMedia||e.isSecureContext===!1&&e.webkitRTCPeerConnection)t.browser="chrome",t.version=Ul(n.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(e.RTCPeerConnection&&n.userAgent.match(/AppleWebKit\/(\d+)\./))t.browser="safari",t.version=Ul(n.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype;else return t.browser="Not a supported browser.",t;return t}function Cg(e){return Object.prototype.toString.call(e)==="[object Object]"}function Iy(e){return Cg(e)?Object.keys(e).reduce(function(t,n){const i=Cg(e[n]),r=i?Iy(e[n]):e[n],o=i&&!Object.keys(r).length;return r===void 0||o?t:Object.assign(t,{[n]:r})},{}):e}function z_(e,t,n){!t||n.has(t.id)||(n.set(t.id,t),Object.keys(t).forEach(i=>{i.endsWith("Id")?z_(e,e.get(t[i]),n):i.endsWith("Ids")&&t[i].forEach(r=>{z_(e,e.get(r),n)})}))}function vg(e,t,n){const i=n?"outbound-rtp":"inbound-rtp",r=new Map;if(t===null)return r;const o=[];return e.forEach(s=>{s.type==="track"&&s.trackIdentifier===t.id&&o.push(s)}),o.forEach(s=>{e.forEach(a=>{a.type===i&&a.trackId===s.id&&z_(e,a,r)})}),r}const Ig=vy;function yy(e,t){const n=e&&e.navigator;if(!n.mediaDevices)return;const i=function(a){if(typeof a!="object"||a.mandatory||a.optional)return a;const c={};return Object.keys(a).forEach(d=>{if(d==="require"||d==="advanced"||d==="mediaSource")return;const l=typeof a[d]=="object"?a[d]:{ideal:a[d]};l.exact!==void 0&&typeof l.exact=="number"&&(l.min=l.max=l.exact);const u=function(h,p){return h?h+p.charAt(0).toUpperCase()+p.slice(1):p==="deviceId"?"sourceId":p};if(l.ideal!==void 0){c.optional=c.optional||[];let h={};typeof l.ideal=="number"?(h[u("min",d)]=l.ideal,c.optional.push(h),h={},h[u("max",d)]=l.ideal,c.optional.push(h)):(h[u("",d)]=l.ideal,c.optional.push(h))}l.exact!==void 0&&typeof l.exact!="number"?(c.mandatory=c.mandatory||{},c.mandatory[u("",d)]=l.exact):["min","max"].forEach(h=>{l[h]!==void 0&&(c.mandatory=c.mandatory||{},c.mandatory[u(h,d)]=l[h])})}),a.advanced&&(c.optional=(c.optional||[]).concat(a.advanced)),c},r=function(a,c){if(t.version>=61)return c(a);if(a=JSON.parse(JSON.stringify(a)),a&&typeof a.audio=="object"){const d=function(l,u,h){u in l&&!(h in l)&&(l[h]=l[u],delete l[u])};a=JSON.parse(JSON.stringify(a)),d(a.audio,"autoGainControl","googAutoGainControl"),d(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=i(a.audio)}if(a&&typeof a.video=="object"){let d=a.video.facingMode;d=d&&(typeof d=="object"?d:{ideal:d});const l=t.version<66;if(d&&(d.exact==="user"||d.exact==="environment"||d.ideal==="user"||d.ideal==="environment")&&!(n.mediaDevices.getSupportedConstraints&&n.mediaDevices.getSupportedConstraints().facingMode&&!l)){delete a.video.facingMode;let u;if(d.exact==="environment"||d.ideal==="environment"?u=["back","rear"]:(d.exact==="user"||d.ideal==="user")&&(u=["front"]),u)return n.mediaDevices.enumerateDevices().then(h=>{h=h.filter(m=>m.kind==="videoinput");let p=h.find(m=>u.some(E=>m.label.toLowerCase().includes(E)));return!p&&h.length&&u.includes("back")&&(p=h[h.length-1]),p&&(a.video.deviceId=d.exact?{exact:p.deviceId}:{ideal:p.deviceId}),a.video=i(a.video),Ig("chrome: "+JSON.stringify(a)),c(a)})}a.video=i(a.video)}return Ig("chrome: "+JSON.stringify(a)),c(a)},o=function(a){return t.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},s=function(a,c,d){r(a,l=>{n.webkitGetUserMedia(l,c,u=>{d&&d(o(u))})})};if(n.getUserMedia=s.bind(n),n.mediaDevices.getUserMedia){const a=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(c){return r(c,d=>a(d).then(l=>{if(d.audio&&!l.getAudioTracks().length||d.video&&!l.getVideoTracks().length)throw l.getTracks().forEach(u=>{u.stop()}),new DOMException("","NotFoundError");return l},l=>Promise.reject(o(l))))}}}function ub(e,t){if(!(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices)&&e.navigator.mediaDevices){if(typeof t!="function"){console.error("shimGetDisplayMedia: getSourceId argument is not a function");return}e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then(r=>{const o=i.video&&i.video.width,s=i.video&&i.video.height,a=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r,maxFrameRate:a||3}},o&&(i.video.mandatory.maxWidth=o),s&&(i.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(i)})}}}function Ay(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function wy(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(n){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=n)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",r=>{let o;e.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(a=>a.track&&a.track.id===r.track.id):o={track:r.track};const s=new Event("track");s.track=r.track,s.receiver=o,s.transceiver={receiver:o},s.streams=[i.stream],this.dispatchEvent(s)}),i.stream.getTracks().forEach(r=>{let o;e.RTCPeerConnection.prototype.getReceivers?o=this.getReceivers().find(a=>a.track&&a.track.id===r.id):o={track:r};const s=new Event("track");s.track=r,s.receiver=o,s.transceiver={receiver:o},s.streams=[i.stream],this.dispatchEvent(s)})},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else ws(e,"track",t=>(t.transceiver||Object.defineProperty(t,"transceiver",{value:{receiver:t.receiver}}),t))}function Ny(e){if(typeof e=="object"&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(r,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=r.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:r}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(a,c){let d=r.apply(this,arguments);return d||(d=t(this,a),this._senders.push(d)),d};const o=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(a){o.apply(this,arguments);const c=this._senders.indexOf(a);c!==-1&&this._senders.splice(c,1)}}const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(o){this._senders=this._senders||[],n.apply(this,[o]),o.getTracks().forEach(s=>{this._senders.push(t(this,s))})};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(o){this._senders=this._senders||[],i.apply(this,[o]),o.getTracks().forEach(s=>{const a=this._senders.find(c=>c.track===s);a&&this._senders.splice(this._senders.indexOf(a),1)})}}else if(typeof e=="object"&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const i=t.apply(this,[]);return i.forEach(r=>r._pc=this),i},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function Oy(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[i,r,o]=arguments;if(arguments.length>0&&typeof i=="function")return t.apply(this,arguments);if(t.length===0&&(arguments.length===0||typeof i!="function"))return t.apply(this,[]);const s=function(c){const d={};return c.result().forEach(u=>{const h={id:u.id,timestamp:u.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[u.type]||u.type};u.names().forEach(p=>{h[p]=u.stat(p)}),d[h.id]=h}),d},a=function(c){return new Map(Object.keys(c).map(d=>[d,c[d]]))};if(arguments.length>=2){const c=function(d){r(a(s(d)))};return t.apply(this,[c,i])}return new Promise((c,d)=>{t.apply(this,[function(l){c(a(s(l)))},d])}).then(r,o)}}function by(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const n=e.RTCPeerConnection.prototype.getSenders;n&&(e.RTCPeerConnection.prototype.getSenders=function(){const o=n.apply(this,[]);return o.forEach(s=>s._pc=this),o});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const o=i.apply(this,arguments);return o._pc=this,o}),e.RTCRtpSender.prototype.getStats=function(){const o=this;return this._pc.getStats().then(s=>vg(s,o.track,!0))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const n=e.RTCPeerConnection.prototype.getReceivers;n&&(e.RTCPeerConnection.prototype.getReceivers=function(){const r=n.apply(this,[]);return r.forEach(o=>o._pc=this),r}),ws(e,"track",i=>(i.receiver._pc=i.srcElement,i)),e.RTCRtpReceiver.prototype.getStats=function(){const r=this;return this._pc.getStats().then(o=>vg(o,r.track,!1))}}if(!("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const i=arguments[0];let r,o,s;return this.getSenders().forEach(a=>{a.track===i&&(r?s=!0:r=a)}),this.getReceivers().forEach(a=>(a.track===i&&(o?s=!0:o=a),a.track===i)),s||r&&o?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():o?o.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function Dy(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(s=>this._shimmedLocalStreams[s][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(s,a){if(!a)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const c=t.apply(this,arguments);return this._shimmedLocalStreams[a.id]?this._shimmedLocalStreams[a.id].indexOf(c)===-1&&this._shimmedLocalStreams[a.id].push(c):this._shimmedLocalStreams[a.id]=[a,c],c};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(s){this._shimmedLocalStreams=this._shimmedLocalStreams||{},s.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")});const a=this.getSenders();n.apply(this,arguments);const c=this.getSenders().filter(d=>a.indexOf(d)===-1);this._shimmedLocalStreams[s.id]=[s].concat(c)};const i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[s.id],i.apply(this,arguments)};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(s){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},s&&Object.keys(this._shimmedLocalStreams).forEach(a=>{const c=this._shimmedLocalStreams[a].indexOf(s);c!==-1&&this._shimmedLocalStreams[a].splice(c,1),this._shimmedLocalStreams[a].length===1&&delete this._shimmedLocalStreams[a]}),r.apply(this,arguments)}}function Py(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return Dy(e);const n=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const l=n.apply(this);return this._reverseStreams=this._reverseStreams||{},l.map(u=>this._reverseStreams[u.id])};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(l){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},l.getTracks().forEach(u=>{if(this.getSenders().find(p=>p.track===u))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[l.id]){const u=new e.MediaStream(l.getTracks());this._streams[l.id]=u,this._reverseStreams[u.id]=l,l=u}i.apply(this,[l])};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(l){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[l.id]||l]),delete this._reverseStreams[this._streams[l.id]?this._streams[l.id].id:l.id],delete this._streams[l.id]},e.RTCPeerConnection.prototype.addTrack=function(l,u){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const h=[].slice.call(arguments,1);if(h.length!==1||!h[0].getTracks().find(E=>E===l))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(E=>E.track===l))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const m=this._streams[u.id];if(m)m.addTrack(l),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const E=new e.MediaStream([l]);this._streams[u.id]=E,this._reverseStreams[E.id]=u,this.addStream(E)}return this.getSenders().find(E=>E.track===l)};function o(d,l){let u=l.sdp;return Object.keys(d._reverseStreams||[]).forEach(h=>{const p=d._reverseStreams[h],m=d._streams[p.id];u=u.replace(new RegExp(m.id,"g"),p.id)}),new RTCSessionDescription({type:l.type,sdp:u})}function s(d,l){let u=l.sdp;return Object.keys(d._reverseStreams||[]).forEach(h=>{const p=d._reverseStreams[h],m=d._streams[p.id];u=u.replace(new RegExp(p.id,"g"),m.id)}),new RTCSessionDescription({type:l.type,sdp:u})}["createOffer","createAnswer"].forEach(function(d){const l=e.RTCPeerConnection.prototype[d],u={[d](){const h=arguments;return arguments.length&&typeof arguments[0]=="function"?l.apply(this,[m=>{const E=o(this,m);h[0].apply(null,[E])},m=>{h[1]&&h[1].apply(null,m)},arguments[2]]):l.apply(this,arguments).then(m=>o(this,m))}};e.RTCPeerConnection.prototype[d]=u[d]});const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?a.apply(this,arguments):(arguments[0]=s(this,arguments[0]),a.apply(this,arguments))};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const d=c.get.apply(this);return d.type===""?d:o(this,d)}}),e.RTCPeerConnection.prototype.removeTrack=function(l){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!l._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(l._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let h;Object.keys(this._streams).forEach(p=>{this._streams[p].getTracks().find(E=>l.track===E)&&(h=this._streams[p])}),h&&(h.getTracks().length===1?this.removeStream(this._reverseStreams[h.id]):h.removeTrack(l.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Y_(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(n){const i=e.RTCPeerConnection.prototype[n],r={[n](){return arguments[0]=new(n==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[n]=r[n]})}function Ly(e,t){ws(e,"negotiationneeded",n=>{const i=n.target;if(!((t.version<72||i.getConfiguration&&i.getConfiguration().sdpSemantics==="plan-b")&&i.signalingState!=="stable"))return n})}const yg=Object.freeze(Object.defineProperty({__proto__:null,fixNegotiationNeeded:Ly,shimAddTrackRemoveTrack:Py,shimAddTrackRemoveTrackWithNative:Dy,shimGetDisplayMedia:ub,shimGetSendersWithDtmf:Ny,shimGetStats:Oy,shimGetUserMedia:yy,shimMediaStream:Ay,shimOnTrack:wy,shimPeerConnection:Y_,shimSenderReceiverGetStats:by},Symbol.toStringTag,{value:"Module"}));function ky(e,t){const n=e&&e.navigator,i=e&&e.MediaStreamTrack;if(n.getUserMedia=function(r,o,s){wE("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(r).then(o,s)},!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){const r=function(s,a,c){a in s&&!(c in s)&&(s[c]=s[a],delete s[a])},o=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s.audio,"autoGainControl","mozAutoGainControl"),r(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},i&&i.prototype.getSettings){const s=i.prototype.getSettings;i.prototype.getSettings=function(){const a=s.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(i&&i.prototype.applyConstraints){const s=i.prototype.applyConstraints;i.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[a])}}}}function hb(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!(i&&i.video)){const r=new DOMException("getDisplayMedia without video constraints is undefined");return r.name="NotFoundError",r.code=8,Promise.reject(r)}return i.video===!0?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}function My(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function $_(e,t){if(typeof e!="object"||!(e.RTCPeerConnection||e.mozRTCPeerConnection))return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){const o=e.RTCPeerConnection.prototype[r],s={[r](){return arguments[0]=new(r==="addIceCandidate"?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};e.RTCPeerConnection.prototype[r]=s[r]});const n={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},i=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[o,s,a]=arguments;return i.apply(this,[o||null]).then(c=>{if(t.version<53&&!s)try{c.forEach(d=>{d.type=n[d.type]||d.type})}catch(d){if(d.name!=="TypeError")throw d;c.forEach((l,u)=>{c.set(u,Object.assign({},l,{type:n[l.type]||l.type}))})}return c}).then(s,a)}}function Uy(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender)||e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const r=t.apply(this,[]);return r.forEach(o=>o._pc=this),r});const n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){const r=n.apply(this,arguments);return r._pc=this,r}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function xy(e){if(!(typeof e=="object"&&e.RTCPeerConnection&&e.RTCRtpSender)||e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const i=t.apply(this,[]);return i.forEach(r=>r._pc=this),i}),ws(e,"track",n=>(n.receiver._pc=n.srcElement,n)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function Vy(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(n){wE("removeStream","removeTrack"),this.getSenders().forEach(i=>{i.track&&n.getTracks().includes(i.track)&&this.removeTrack(i)})})}function Fy(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function By(e){if(!(typeof e=="object"&&e.RTCPeerConnection))return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];const r=i.length>0;r&&i.forEach(s=>{if("rid"in s&&!/^[a-z0-9]{0,16}$/i.test(s.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in s&&!(parseFloat(s.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in s&&!(parseFloat(s.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const o=t.apply(this,arguments);if(r){const{sender:s}=o,a=s.getParameters();(!("encodings"in a)||a.encodings.length===1&&Object.keys(a.encodings[0]).length===0)&&(a.encodings=i,s.sendEncodings=i,this.setParametersPromises.push(s.setParameters(a).then(()=>{delete s.sendEncodings}).catch(()=>{delete s.sendEncodings})))}return o})}function Gy(e){if(!(typeof e=="object"&&e.RTCRtpSender))return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const i=t.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function jy(e){if(!(typeof e=="object"&&e.RTCPeerConnection))return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}function Wy(e){if(!(typeof e=="object"&&e.RTCPeerConnection))return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):t.apply(this,arguments)}}const Ag=Object.freeze(Object.defineProperty({__proto__:null,shimAddTransceiver:By,shimCreateAnswer:Wy,shimCreateOffer:jy,shimGetDisplayMedia:hb,shimGetParameters:Gy,shimGetUserMedia:ky,shimOnTrack:My,shimPeerConnection:$_,shimRTCDataChannel:Fy,shimReceiverGetStats:xy,shimRemoveStream:Vy,shimSenderGetStats:Uy},Symbol.toStringTag,{value:"Module"}));function Hy(e){if(!(typeof e!="object"||!e.RTCPeerConnection)){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(i){this._localStreams||(this._localStreams=[]),this._localStreams.includes(i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>t.call(this,r,i)),i.getVideoTracks().forEach(r=>t.call(this,r,i))},e.RTCPeerConnection.prototype.addTrack=function(i,...r){return r&&r.forEach(o=>{this._localStreams?this._localStreams.includes(o)||this._localStreams.push(o):this._localStreams=[o]}),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(n){this._localStreams||(this._localStreams=[]);const i=this._localStreams.indexOf(n);if(i===-1)return;this._localStreams.splice(i,1);const r=n.getTracks();this.getSenders().forEach(o=>{r.includes(o.track)&&this.removeTrack(o)})})}}function Ky(e){if(!(typeof e!="object"||!e.RTCPeerConnection)&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(n){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=n),this.addEventListener("track",this._onaddstreampoly=i=>{i.streams.forEach(r=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(r))return;this._remoteStreams.push(r);const o=new Event("addstream");o.stream=r,this.dispatchEvent(o)})})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(r){r.streams.forEach(o=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(o)>=0)return;i._remoteStreams.push(o);const s=new Event("addstream");s.stream=o,i.dispatchEvent(s)})}),t.apply(i,arguments)}}}function zy(e){if(typeof e!="object"||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,n=t.createOffer,i=t.createAnswer,r=t.setLocalDescription,o=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(d,l){const u=arguments.length>=2?arguments[2]:arguments[0],h=n.apply(this,[u]);return l?(h.then(d,l),Promise.resolve()):h},t.createAnswer=function(d,l){const u=arguments.length>=2?arguments[2]:arguments[0],h=i.apply(this,[u]);return l?(h.then(d,l),Promise.resolve()):h};let a=function(c,d,l){const u=r.apply(this,[c]);return l?(u.then(d,l),Promise.resolve()):u};t.setLocalDescription=a,a=function(c,d,l){const u=o.apply(this,[c]);return l?(u.then(d,l),Promise.resolve()):u},t.setRemoteDescription=a,a=function(c,d,l){const u=s.apply(this,[c]);return l?(u.then(d,l),Promise.resolve()):u},t.addIceCandidate=a}function Yy(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const n=t.mediaDevices,i=n.getUserMedia.bind(n);t.mediaDevices.getUserMedia=r=>i($y(r))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=(function(i,r,o){t.mediaDevices.getUserMedia(i).then(r,o)}).bind(t))}function $y(e){return e&&e.video!==void 0?Object.assign({},e,{video:Iy(e.video)}):e}function qy(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(i,r){if(i&&i.iceServers){const o=[];for(let s=0;s<i.iceServers.length;s++){let a=i.iceServers[s];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(wE("RTCIceServer.url","RTCIceServer.urls"),a=JSON.parse(JSON.stringify(a)),a.urls=a.url,delete a.url,o.push(a)):o.push(i.iceServers[s])}i.iceServers=o}return new t(i,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get(){return t.generateCertificate}})}function Jy(e){typeof e=="object"&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function Xy(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(i){if(i){typeof i.offerToReceiveAudio<"u"&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);const r=this.getTransceivers().find(s=>s.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveAudio===!0&&!r&&this.addTransceiver("audio",{direction:"recvonly"}),typeof i.offerToReceiveVideo<"u"&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);const o=this.getTransceivers().find(s=>s.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):i.offerToReceiveVideo===!0&&!o&&this.addTransceiver("video",{direction:"recvonly"})}return t.apply(this,arguments)}}function Qy(e){typeof e!="object"||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}const wg=Object.freeze(Object.defineProperty({__proto__:null,shimAudioContext:Qy,shimCallbacksAPI:zy,shimConstraints:$y,shimCreateOfferLegacy:Xy,shimGetUserMedia:Yy,shimLocalStreamsAPI:Hy,shimRTCIceServerUrls:qy,shimRemoteStreamsAPI:Ky,shimTrackEventTransceiver:Jy},Symbol.toStringTag,{value:"Module"}));var Zy={exports:{}};(function(e){const t={};t.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},t.localCName=t.generateIdentifier(),t.splitLines=function(n){return n.trim().split(`
`).map(i=>i.trim())},t.splitSections=function(n){return n.split(`
m=`).map((r,o)=>(o>0?"m="+r:r).trim()+`\r
`)},t.getDescription=function(n){const i=t.splitSections(n);return i&&i[0]},t.getMediaSections=function(n){const i=t.splitSections(n);return i.shift(),i},t.matchPrefix=function(n,i){return t.splitLines(n).filter(r=>r.indexOf(i)===0)},t.parseCandidate=function(n){let i;n.indexOf("a=candidate:")===0?i=n.substring(12).split(" "):i=n.substring(10).split(" ");const r={foundation:i[0],component:{1:"rtp",2:"rtcp"}[i[1]]||i[1],protocol:i[2].toLowerCase(),priority:parseInt(i[3],10),ip:i[4],address:i[4],port:parseInt(i[5],10),type:i[7]};for(let o=8;o<i.length;o+=2)switch(i[o]){case"raddr":r.relatedAddress=i[o+1];break;case"rport":r.relatedPort=parseInt(i[o+1],10);break;case"tcptype":r.tcpType=i[o+1];break;case"ufrag":r.ufrag=i[o+1],r.usernameFragment=i[o+1];break;default:r[i[o]]===void 0&&(r[i[o]]=i[o+1]);break}return r},t.writeCandidate=function(n){const i=[];i.push(n.foundation);const r=n.component;r==="rtp"?i.push(1):r==="rtcp"?i.push(2):i.push(r),i.push(n.protocol.toUpperCase()),i.push(n.priority),i.push(n.address||n.ip),i.push(n.port);const o=n.type;return i.push("typ"),i.push(o),o!=="host"&&n.relatedAddress&&n.relatedPort&&(i.push("raddr"),i.push(n.relatedAddress),i.push("rport"),i.push(n.relatedPort)),n.tcpType&&n.protocol.toLowerCase()==="tcp"&&(i.push("tcptype"),i.push(n.tcpType)),(n.usernameFragment||n.ufrag)&&(i.push("ufrag"),i.push(n.usernameFragment||n.ufrag)),"candidate:"+i.join(" ")},t.parseIceOptions=function(n){return n.substring(14).split(" ")},t.parseRtpMap=function(n){let i=n.substring(9).split(" ");const r={payloadType:parseInt(i.shift(),10)};return i=i[0].split("/"),r.name=i[0],r.clockRate=parseInt(i[1],10),r.channels=i.length===3?parseInt(i[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(n){let i=n.payloadType;n.preferredPayloadType!==void 0&&(i=n.preferredPayloadType);const r=n.channels||n.numChannels||1;return"a=rtpmap:"+i+" "+n.name+"/"+n.clockRate+(r!==1?"/"+r:"")+`\r
`},t.parseExtmap=function(n){const i=n.substring(9).split(" ");return{id:parseInt(i[0],10),direction:i[0].indexOf("/")>0?i[0].split("/")[1]:"sendrecv",uri:i[1],attributes:i.slice(2).join(" ")}},t.writeExtmap=function(n){return"a=extmap:"+(n.id||n.preferredId)+(n.direction&&n.direction!=="sendrecv"?"/"+n.direction:"")+" "+n.uri+(n.attributes?" "+n.attributes:"")+`\r
`},t.parseFmtp=function(n){const i={};let r;const o=n.substring(n.indexOf(" ")+1).split(";");for(let s=0;s<o.length;s++)r=o[s].trim().split("="),i[r[0].trim()]=r[1];return i},t.writeFmtp=function(n){let i="",r=n.payloadType;if(n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.parameters&&Object.keys(n.parameters).length){const o=[];Object.keys(n.parameters).forEach(s=>{n.parameters[s]!==void 0?o.push(s+"="+n.parameters[s]):o.push(s)}),i+="a=fmtp:"+r+" "+o.join(";")+`\r
`}return i},t.parseRtcpFb=function(n){const i=n.substring(n.indexOf(" ")+1).split(" ");return{type:i.shift(),parameter:i.join(" ")}},t.writeRtcpFb=function(n){let i="",r=n.payloadType;return n.preferredPayloadType!==void 0&&(r=n.preferredPayloadType),n.rtcpFeedback&&n.rtcpFeedback.length&&n.rtcpFeedback.forEach(o=>{i+="a=rtcp-fb:"+r+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),i},t.parseSsrcMedia=function(n){const i=n.indexOf(" "),r={ssrc:parseInt(n.substring(7,i),10)},o=n.indexOf(":",i);return o>-1?(r.attribute=n.substring(i+1,o),r.value=n.substring(o+1)):r.attribute=n.substring(i+1),r},t.parseSsrcGroup=function(n){const i=n.substring(13).split(" ");return{semantics:i.shift(),ssrcs:i.map(r=>parseInt(r,10))}},t.getMid=function(n){const i=t.matchPrefix(n,"a=mid:")[0];if(i)return i.substring(6)},t.parseFingerprint=function(n){const i=n.substring(14).split(" ");return{algorithm:i[0].toLowerCase(),value:i[1].toUpperCase()}},t.getDtlsParameters=function(n,i){return{role:"auto",fingerprints:t.matchPrefix(n+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(n,i){let r="a=setup:"+i+`\r
`;return n.fingerprints.forEach(o=>{r+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),r},t.parseCryptoLine=function(n){const i=n.substring(9).split(" ");return{tag:parseInt(i[0],10),cryptoSuite:i[1],keyParams:i[2],sessionParams:i.slice(3)}},t.writeCryptoLine=function(n){return"a=crypto:"+n.tag+" "+n.cryptoSuite+" "+(typeof n.keyParams=="object"?t.writeCryptoKeyParams(n.keyParams):n.keyParams)+(n.sessionParams?" "+n.sessionParams.join(" "):"")+`\r
`},t.parseCryptoKeyParams=function(n){if(n.indexOf("inline:")!==0)return null;const i=n.substring(7).split("|");return{keyMethod:"inline",keySalt:i[0],lifeTime:i[1],mkiValue:i[2]?i[2].split(":")[0]:void 0,mkiLength:i[2]?i[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(n){return n.keyMethod+":"+n.keySalt+(n.lifeTime?"|"+n.lifeTime:"")+(n.mkiValue&&n.mkiLength?"|"+n.mkiValue+":"+n.mkiLength:"")},t.getCryptoParameters=function(n,i){return t.matchPrefix(n+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(n,i){const r=t.matchPrefix(n+i,"a=ice-ufrag:")[0],o=t.matchPrefix(n+i,"a=ice-pwd:")[0];return r&&o?{usernameFragment:r.substring(12),password:o.substring(10)}:null},t.writeIceParameters=function(n){let i="a=ice-ufrag:"+n.usernameFragment+`\r
a=ice-pwd:`+n.password+`\r
`;return n.iceLite&&(i+=`a=ice-lite\r
`),i},t.parseRtpParameters=function(n){const i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},o=t.splitLines(n)[0].split(" ");i.profile=o[2];for(let a=3;a<o.length;a++){const c=o[a],d=t.matchPrefix(n,"a=rtpmap:"+c+" ")[0];if(d){const l=t.parseRtpMap(d),u=t.matchPrefix(n,"a=fmtp:"+c+" ");switch(l.parameters=u.length?t.parseFmtp(u[0]):{},l.rtcpFeedback=t.matchPrefix(n,"a=rtcp-fb:"+c+" ").map(t.parseRtcpFb),i.codecs.push(l),l.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(l.name.toUpperCase());break}}}t.matchPrefix(n,"a=extmap:").forEach(a=>{i.headerExtensions.push(t.parseExtmap(a))});const s=t.matchPrefix(n,"a=rtcp-fb:* ").map(t.parseRtcpFb);return i.codecs.forEach(a=>{s.forEach(c=>{a.rtcpFeedback.find(l=>l.type===c.type&&l.parameter===c.parameter)||a.rtcpFeedback.push(c)})}),i},t.writeRtpDescription=function(n,i){let r="";r+="m="+n+" ",r+=i.codecs.length>0?"9":"0",r+=" "+(i.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=i.codecs.map(s=>s.preferredPayloadType!==void 0?s.preferredPayloadType:s.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,i.codecs.forEach(s=>{r+=t.writeRtpMap(s),r+=t.writeFmtp(s),r+=t.writeRtcpFb(s)});let o=0;return i.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime)}),o>0&&(r+="a=maxptime:"+o+`\r
`),i.headerExtensions&&i.headerExtensions.forEach(s=>{r+=t.writeExtmap(s)}),r},t.parseRtpEncodingParameters=function(n){const i=[],r=t.parseRtpParameters(n),o=r.fecMechanisms.indexOf("RED")!==-1,s=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=t.matchPrefix(n,"a=ssrc:").map(h=>t.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=a.length>0&&a[0].ssrc;let d;const l=t.matchPrefix(n,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(m=>parseInt(m,10)));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&d&&(p.rtx={ssrc:d}),i.push(p),o&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},i.push(p))}}),i.length===0&&c&&i.push({ssrc:c});let u=t.matchPrefix(n,"b=");return u.length&&(u[0].indexOf("b=TIAS:")===0?u=parseInt(u[0].substring(7),10):u[0].indexOf("b=AS:")===0?u=parseInt(u[0].substring(5),10)*1e3*.95-50*40*8:u=void 0,i.forEach(h=>{h.maxBitrate=u})),i},t.parseRtcpParameters=function(n){const i={},r=t.matchPrefix(n,"a=ssrc:").map(a=>t.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);const o=t.matchPrefix(n,"a=rtcp-rsize");i.reducedSize=o.length>0,i.compound=o.length===0;const s=t.matchPrefix(n,"a=rtcp-mux");return i.mux=s.length>0,i},t.writeRtcpParameters=function(n){let i="";return n.reducedSize&&(i+=`a=rtcp-rsize\r
`),n.mux&&(i+=`a=rtcp-mux\r
`),n.ssrc!==void 0&&n.cname&&(i+="a=ssrc:"+n.ssrc+" cname:"+n.cname+`\r
`),i},t.parseMsid=function(n){let i;const r=t.matchPrefix(n,"a=msid:");if(r.length===1)return i=r[0].substring(7).split(" "),{stream:i[0],track:i[1]};const o=t.matchPrefix(n,"a=ssrc:").map(s=>t.parseSsrcMedia(s)).filter(s=>s.attribute==="msid");if(o.length>0)return i=o[0].value.split(" "),{stream:i[0],track:i[1]}},t.parseSctpDescription=function(n){const i=t.parseMLine(n),r=t.matchPrefix(n,"a=max-message-size:");let o;r.length>0&&(o=parseInt(r[0].substring(19),10)),isNaN(o)&&(o=65536);const s=t.matchPrefix(n,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:i.fmt,maxMessageSize:o};const a=t.matchPrefix(n,"a=sctpmap:");if(a.length>0){const c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},t.writeSctpDescription=function(n,i){let r=[];return n.protocol!=="DTLS/SCTP"?r=["m="+n.kind+" 9 "+n.protocol+" "+i.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+i.port+`\r
`]:r=["m="+n.kind+" 9 "+n.protocol+" "+i.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+i.port+" "+i.protocol+` 65535\r
`],i.maxMessageSize!==void 0&&r.push("a=max-message-size:"+i.maxMessageSize+`\r
`),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,22)},t.writeSessionBoilerplate=function(n,i,r){let o;const s=i!==void 0?i:2;return n?o=n:o=t.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+o+" "+s+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},t.getDirection=function(n,i){const r=t.splitLines(n);for(let o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substring(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(n){return t.splitLines(n)[0].split(" ")[0].substring(2)},t.isRejected=function(n){return n.split(" ",2)[1]==="0"},t.parseMLine=function(n){const r=t.splitLines(n)[0].substring(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(n){const r=t.matchPrefix(n,"o=")[0].substring(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(n){if(typeof n!="string"||n.length===0)return!1;const i=t.splitLines(n);for(let r=0;r<i.length;r++)if(i[r].length<2||i[r].charAt(1)!=="=")return!1;return!0},e.exports=t})(Zy);var eA=Zy.exports;const ua=Pf(eA),pb=kw({__proto__:null,default:ua},[eA]);function xl(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&(i=JSON.parse(JSON.stringify(i)),i.candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){const r=new t(i),o=ua.parseCandidate(i.candidate),s=Object.assign(r,o);return s.toJSON=function(){return{candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(i)},e.RTCIceCandidate.prototype=t.prototype,ws(e,"icecandidate",n=>(n.candidate&&Object.defineProperty(n,"candidate",{value:new e.RTCIceCandidate(n.candidate),writable:"false"}),n))}function q_(e){!e.RTCIceCandidate||e.RTCIceCandidate&&"relayProtocol"in e.RTCIceCandidate.prototype||ws(e,"icecandidate",t=>{if(t.candidate){const n=ua.parseCandidate(t.candidate.candidate);n.type==="relay"&&(t.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[n.priority>>24])}return t})}function Vl(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const n=function(a){if(!a||!a.sdp)return!1;const c=ua.splitSections(a.sdp);return c.shift(),c.some(d=>{const l=ua.parseMLine(d);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1})},i=function(a){const c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;const d=parseInt(c[1],10);return d!==d?-1:d},r=function(a){let c=65536;return t.browser==="firefox"&&(t.version<57?a===-1?c=16384:c=2147483637:t.version<60?c=t.version===57?65535:65536:c=2147483637),c},o=function(a,c){let d=65536;t.browser==="firefox"&&t.version===57&&(d=65535);const l=ua.matchPrefix(a.sdp,"a=max-message-size:");return l.length>0?d=parseInt(l[0].substr(19),10):t.browser==="firefox"&&c!==-1&&(d=2147483637),d},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,t.browser==="chrome"&&t.version>=76){const{sdpSemantics:c}=this.getConfiguration();c==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(n(arguments[0])){const c=i(arguments[0]),d=r(c),l=o(arguments[0],c);let u;d===0&&l===0?u=Number.POSITIVE_INFINITY:d===0||l===0?u=Math.max(d,l):u=Math.min(d,l);const h={};Object.defineProperty(h,"maxMessageSize",{get(){return u}}),this._sctp=h}return s.apply(this,arguments)}}function Fl(e){if(!(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype))return;function t(i,r){const o=i.send;i.send=function(){const a=arguments[0],c=a.length||a.size||a.byteLength;if(i.readyState==="open"&&r.sctp&&c>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return o.apply(i,arguments)}}const n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const r=n.apply(this,arguments);return t(r,this),r},ws(e,"datachannel",i=>(t(i.channel,i.target),i))}function J_(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(n){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),n&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=n)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(n=>{const i=t[n];t[n]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{const o=r.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;const s=new Event("connectionstatechange",r);o.dispatchEvent(s)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}})}function X_(e,t){if(!e.RTCPeerConnection||t.browser==="chrome"&&t.version>=71||t.browser==="safari"&&t.version>=605)return;const n=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(r){if(r&&r.sdp&&r.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const o=r.sdp.split(`
`).filter(s=>s.trim()!=="a=extmap-allow-mixed").join(`
`);e.RTCSessionDescription&&r instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:r.type,sdp:o}):r.sdp=o}return n.apply(this,arguments)}}function Bl(e,t){if(!(e.RTCPeerConnection&&e.RTCPeerConnection.prototype))return;const n=e.RTCPeerConnection.prototype.addIceCandidate;!n||n.length===0||(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(t.browser==="chrome"&&t.version<78||t.browser==="firefox"&&t.version<68||t.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function Gl(e,t){if(!(e.RTCPeerConnection&&e.RTCPeerConnection.prototype))return;const n=e.RTCPeerConnection.prototype.setLocalDescription;!n||n.length===0||(e.RTCPeerConnection.prototype.setLocalDescription=function(){let r=arguments[0]||{};if(typeof r!="object"||r.type&&r.sdp)return n.apply(this,arguments);if(r={type:r.type,sdp:r.sdp},!r.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":r.type="offer";break;default:r.type="answer";break}return r.sdp||r.type!=="offer"&&r.type!=="answer"?n.apply(this,[r]):(r.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(s=>n.apply(this,[s]))})}const _b=Object.freeze(Object.defineProperty({__proto__:null,removeExtmapAllowMixed:X_,shimAddIceCandidateNullOrEmpty:Bl,shimConnectionState:J_,shimMaxMessageSize:Vl,shimParameterlessSetLocalDescription:Gl,shimRTCIceCandidate:xl,shimRTCIceCandidateRelayProtocol:q_,shimSendThrowTypeError:Fl},Symbol.toStringTag,{value:"Module"}));function fb({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const n=vy,i=lb(e),r={browserDetails:i,commonShim:_b,extractVersion:Ul,disableLog:cb,disableWarnings:db,sdp:pb};switch(i.browser){case"chrome":if(!yg||!Y_||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),r;if(i.version===null)return n("Chrome shim can not determine version, not shimming."),r;n("adapter.js shimming chrome."),r.browserShim=yg,Bl(e,i),Gl(e),yy(e,i),Ay(e),Y_(e,i),wy(e),Py(e,i),Ny(e),Oy(e),by(e),Ly(e,i),xl(e),q_(e),J_(e),Vl(e,i),Fl(e),X_(e,i);break;case"firefox":if(!Ag||!$_||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),r;n("adapter.js shimming firefox."),r.browserShim=Ag,Bl(e,i),Gl(e),ky(e,i),$_(e,i),My(e),Vy(e),Uy(e),xy(e),Fy(e),By(e),Gy(e),jy(e),Wy(e),xl(e),J_(e),Vl(e,i),Fl(e);break;case"safari":if(!wg||!t.shimSafari)return n("Safari shim is not included in this adapter release."),r;n("adapter.js shimming safari."),r.browserShim=wg,Bl(e,i),Gl(e),qy(e),Xy(e),zy(e),Hy(e),Ky(e),Jy(e),Yy(e),Qy(e),xl(e),q_(e),Vl(e,i),Fl(e),X_(e,i);break;default:n("Unsupported browser!");break}return r}fb({window:typeof window>"u"?void 0:window});var Q_={exports:{}};(function(e,t){(function(n,i){var r="0.7.38",o="",s="?",a="function",c="undefined",d="object",l="string",u="major",h="model",p="name",m="type",E="vendor",g="version",S="architecture",T="console",I="mobile",y="tablet",w="smarttv",D="wearable",O="embedded",P=500,x="Amazon",U="Apple",J="ASUS",Le="BlackBerry",Be="Browser",ot="Chrome",vt="Edge",Lt="Firefox",mt="Google",te="Huawei",le="LG",V="Microsoft",_="Motorola",R="Opera",v="Samsung",b="Sharp",K="Sony",re="Xiaomi",Ne="Zebra",kt="Facebook",qr="Chromium OS",Ud="Mac OS",wh=function(ze,ut){var be={};for(var It in ze)ut[It]&&ut[It].length%2===0?be[It]=ut[It].concat(ze[It]):be[It]=ze[It];return be},bs=function(ze){for(var ut={},be=0;be<ze.length;be++)ut[ze[be].toUpperCase()]=ze[be];return ut},xd=function(ze,ut){return typeof ze===l?Bo(ut).indexOf(Bo(ze))!==-1:!1},Bo=function(ze){return ze.toLowerCase()},Nh=function(ze){return typeof ze===l?ze.replace(/[^\d\.]/g,o).split(".")[0]:i},$a=function(ze,ut){if(typeof ze===l)return ze=ze.replace(/^\s\s*/,o),typeof ut===c?ze:ze.substring(0,P)},qa=function(ze,ut){for(var be=0,It,Nr,sr,st,Ce,ar;be<ut.length&&!Ce;){var bh=ut[be],hm=ut[be+1];for(It=Nr=0;It<bh.length&&!Ce&&bh[It];)if(Ce=bh[It++].exec(ze),Ce)for(sr=0;sr<hm.length;sr++)ar=Ce[++Nr],st=hm[sr],typeof st===d&&st.length>0?st.length===2?typeof st[1]==a?this[st[0]]=st[1].call(this,ar):this[st[0]]=st[1]:st.length===3?typeof st[1]===a&&!(st[1].exec&&st[1].test)?this[st[0]]=ar?st[1].call(this,ar,st[2]):i:this[st[0]]=ar?ar.replace(st[1],st[2]):i:st.length===4&&(this[st[0]]=ar?st[3].call(this,ar.replace(st[1],st[2])):i):this[st]=ar||i;be+=2}},Oh=function(ze,ut){for(var be in ut)if(typeof ut[be]===d&&ut[be].length>0){for(var It=0;It<ut[be].length;It++)if(xd(ut[be][It],ze))return be===s?i:be}else if(xd(ut[be],ze))return be===s?i:be;return ze},Lw={"1.0":"/8","1.2":"/1","1.3":"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"},lm={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2","8.1":"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},um={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[g,[p,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[g,[p,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[p,g],[/opios[\/ ]+([\w\.]+)/i],[g,[p,R+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[g,[p,R+" GX"]],[/\bopr\/([\w\.]+)/i],[g,[p,R]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[g,[p,"Baidu"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim)\s?(?:browser)?[\/ ]?([\w\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|qq|duckduckgo)\/([-\w\.]+)/i,/(heytap|ovi)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[p,g],[/\bddg\/([\w\.]+)/i],[g,[p,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[g,[p,"UC"+Be]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[g,[p,"WeChat"]],[/konqueror\/([\w\.]+)/i],[g,[p,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[g,[p,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[g,[p,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[g,[p,"Smart Lenovo "+Be]],[/(avast|avg)\/([\w\.]+)/i],[[p,/(.+)/,"$1 Secure "+Be],g],[/\bfocus\/([\w\.]+)/i],[g,[p,Lt+" Focus"]],[/\bopt\/([\w\.]+)/i],[g,[p,R+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[g,[p,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[g,[p,"Dolphin"]],[/coast\/([\w\.]+)/i],[g,[p,R+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[g,[p,"MIUI "+Be]],[/fxios\/([-\w\.]+)/i],[g,[p,Lt]],[/\bqihu|(qi?ho?o?|360)browser/i],[[p,"360 "+Be]],[/(oculus|sailfish|huawei|vivo)browser\/([\w\.]+)/i],[[p,/(.+)/,"$1 "+Be],g],[/samsungbrowser\/([\w\.]+)/i],[g,[p,v+" Internet"]],[/(comodo_dragon)\/([\w\.]+)/i],[[p,/_/g," "],g],[/metasr[\/ ]?([\d\.]+)/i],[g,[p,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[p,"Sogou Mobile"],g],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345Explorer)[\/ ]?([\w\.]+)/i],[p,g],[/(lbbrowser)/i,/\[(linkedin)app\]/i],[p],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[p,kt],g],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[p,g],[/\bgsa\/([\w\.]+) .*safari\//i],[g,[p,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[g,[p,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[g,[p,ot+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[p,ot+" WebView"],g],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[g,[p,"Android "+Be]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[p,g],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[g,[p,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[g,p],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[p,[g,Oh,Lw]],[/(webkit|khtml)\/([\w\.]+)/i],[p,g],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[p,"Netscape"],g],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[g,[p,Lt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i,/panasonic;(viera)/i],[p,g],[/(cobalt)\/([\w\.]+)/i],[p,[g,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[S,"amd64"]],[/(ia32(?=;))/i],[[S,Bo]],[/((?:i[346]|x)86)[;\)]/i],[[S,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[S,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[S,"armhf"]],[/windows (ce|mobile); ppc;/i],[[S,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[S,/ower/,o,Bo]],[/(sun4\w)[;\)]/i],[[S,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[S,Bo]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[h,[E,v],[m,y]],[/\b((?:s[cgp]h|gt|sm)-\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[h,[E,v],[m,I]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[h,[E,U],[m,I]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[h,[E,U],[m,y]],[/(macintosh);/i],[h,[E,U]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[h,[E,b],[m,I]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[h,[E,te],[m,y]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[h,[E,te],[m,I]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[h,/_/g," "],[E,re],[m,I]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[h,/_/g," "],[E,re],[m,y]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[h,[E,"OPPO"],[m,I]],[/\b(opd2\d{3}a?) bui/i],[h,[E,"OPPO"],[m,y]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[h,[E,"Vivo"],[m,I]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[h,[E,"Realme"],[m,I]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[h,[E,_],[m,I]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[h,[E,_],[m,y]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[h,[E,le],[m,y]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[h,[E,le],[m,I]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[h,[E,"Lenovo"],[m,y]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[h,/_/g," "],[E,"Nokia"],[m,I]],[/(pixel c)\b/i],[h,[E,mt],[m,y]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[h,[E,mt],[m,I]],[/droid.+ (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[h,[E,K],[m,I]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[h,"Xperia Tablet"],[E,K],[m,y]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[h,[E,"OnePlus"],[m,I]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo[c-r]{2})( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[h,[E,x],[m,y]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[h,/(.+)/g,"Fire Phone $1"],[E,x],[m,I]],[/(playbook);[-\w\),; ]+(rim)/i],[h,E,[m,y]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[h,[E,Le],[m,I]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[h,[E,J],[m,y]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[h,[E,J],[m,I]],[/(nexus 9)/i],[h,[E,"HTC"],[m,y]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[E,[h,/_/g," "],[m,I]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[h,[E,"Acer"],[m,y]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[h,[E,"Meizu"],[m,I]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[h,[E,"Ulefone"],[m,I]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[E,h,[m,I]],[/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[E,h,[m,y]],[/(surface duo)/i],[h,[E,V],[m,y]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[h,[E,"Fairphone"],[m,I]],[/(u304aa)/i],[h,[E,"AT&T"],[m,I]],[/\bsie-(\w*)/i],[h,[E,"Siemens"],[m,I]],[/\b(rct\w+) b/i],[h,[E,"RCA"],[m,y]],[/\b(venue[\d ]{2,7}) b/i],[h,[E,"Dell"],[m,y]],[/\b(q(?:mv|ta)\w+) b/i],[h,[E,"Verizon"],[m,y]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[h,[E,"Barnes & Noble"],[m,y]],[/\b(tm\d{3}\w+) b/i],[h,[E,"NuVision"],[m,y]],[/\b(k88) b/i],[h,[E,"ZTE"],[m,y]],[/\b(nx\d{3}j) b/i],[h,[E,"ZTE"],[m,I]],[/\b(gen\d{3}) b.+49h/i],[h,[E,"Swiss"],[m,I]],[/\b(zur\d{3}) b/i],[h,[E,"Swiss"],[m,y]],[/\b((zeki)?tb.*\b) b/i],[h,[E,"Zeki"],[m,y]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[E,"Dragon Touch"],h,[m,y]],[/\b(ns-?\w{0,9}) b/i],[h,[E,"Insignia"],[m,y]],[/\b((nxa|next)-?\w{0,9}) b/i],[h,[E,"NextBook"],[m,y]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[E,"Voice"],h,[m,I]],[/\b(lvtel\-)?(v1[12]) b/i],[[E,"LvTel"],h,[m,I]],[/\b(ph-1) /i],[h,[E,"Essential"],[m,I]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[h,[E,"Envizen"],[m,y]],[/\b(trio[-\w\. ]+) b/i],[h,[E,"MachSpeed"],[m,y]],[/\btu_(1491) b/i],[h,[E,"Rotor"],[m,y]],[/(shield[\w ]+) b/i],[h,[E,"Nvidia"],[m,y]],[/(sprint) (\w+)/i],[E,h,[m,I]],[/(kin\.[onetw]{3})/i],[[h,/\./g," "],[E,V],[m,I]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[h,[E,Ne],[m,y]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[h,[E,Ne],[m,I]],[/smart-tv.+(samsung)/i],[E,[m,w]],[/hbbtv.+maple;(\d+)/i],[[h,/^/,"SmartTV"],[E,v],[m,w]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[E,le],[m,w]],[/(apple) ?tv/i],[E,[h,U+" TV"],[m,w]],[/crkey/i],[[h,ot+"cast"],[E,mt],[m,w]],[/droid.+aft(\w+)( bui|\))/i],[h,[E,x],[m,w]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[h,[E,b],[m,w]],[/(bravia[\w ]+)( bui|\))/i],[h,[E,K],[m,w]],[/(mitv-\w{5}) bui/i],[h,[E,re],[m,w]],[/Hbbtv.*(technisat) (.*);/i],[E,h,[m,w]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[E,$a],[h,$a],[m,w]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[m,w]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[E,h,[m,T]],[/droid.+; (shield) bui/i],[h,[E,"Nvidia"],[m,T]],[/(playstation [345portablevi]+)/i],[h,[E,K],[m,T]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[h,[E,V],[m,T]],[/((pebble))app/i],[E,h,[m,D]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[h,[E,U],[m,D]],[/droid.+; (glass) \d/i],[h,[E,mt],[m,D]],[/droid.+; (wt63?0{2,3})\)/i],[h,[E,Ne],[m,D]],[/(quest( \d| pro)?)/i],[h,[E,kt],[m,D]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[E,[m,O]],[/(aeobc)\b/i],[h,[E,x],[m,O]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[h,[m,I]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[h,[m,y]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[m,y]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[m,I]],[/(android[-\w\. ]{0,9});.+buil/i],[h,[E,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[g,[p,vt+"HTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[g,[p,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[p,g],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[g,p]],os:[[/microsoft (windows) (vista|xp)/i],[p,g],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[p,[g,Oh,lm]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[g,Oh,lm],[p,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[g,/_/g,"."],[p,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[p,Ud],[g,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[g,p],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[p,g],[/\(bb(10);/i],[g,[p,Le]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[g,[p,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[g,[p,Lt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[g,[p,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[g,[p,"watchOS"]],[/crkey\/([\d\.]+)/i],[g,[p,ot+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[p,qr],g],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[p,g],[/(sunos) ?([\w\.\d]*)/i],[[p,"Solaris"],g],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[p,g]]},Fi=function(ze,ut){if(typeof ze===d&&(ut=ze,ze=i),!(this instanceof Fi))return new Fi(ze,ut).getResult();var be=typeof n!==c&&n.navigator?n.navigator:i,It=ze||(be&&be.userAgent?be.userAgent:o),Nr=be&&be.userAgentData?be.userAgentData:i,sr=ut?wh(um,ut):um,st=be&&be.userAgent==It;return this.getBrowser=function(){var Ce={};return Ce[p]=i,Ce[g]=i,qa.call(Ce,It,sr.browser),Ce[u]=Nh(Ce[g]),st&&be&&be.brave&&typeof be.brave.isBrave==a&&(Ce[p]="Brave"),Ce},this.getCPU=function(){var Ce={};return Ce[S]=i,qa.call(Ce,It,sr.cpu),Ce},this.getDevice=function(){var Ce={};return Ce[E]=i,Ce[h]=i,Ce[m]=i,qa.call(Ce,It,sr.device),st&&!Ce[m]&&Nr&&Nr.mobile&&(Ce[m]=I),st&&Ce[h]=="Macintosh"&&be&&typeof be.standalone!==c&&be.maxTouchPoints&&be.maxTouchPoints>2&&(Ce[h]="iPad",Ce[m]=y),Ce},this.getEngine=function(){var Ce={};return Ce[p]=i,Ce[g]=i,qa.call(Ce,It,sr.engine),Ce},this.getOS=function(){var Ce={};return Ce[p]=i,Ce[g]=i,qa.call(Ce,It,sr.os),st&&!Ce[p]&&Nr&&Nr.platform&&Nr.platform!="Unknown"&&(Ce[p]=Nr.platform.replace(/chrome os/i,qr).replace(/macos/i,Ud)),Ce},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return It},this.setUA=function(Ce){return It=typeof Ce===l&&Ce.length>P?$a(Ce,P):Ce,this},this.setUA(It),this};Fi.VERSION=r,Fi.BROWSER=bs([p,g,u]),Fi.CPU=bs([S]),Fi.DEVICE=bs([h,E,m,T,I,w,y,D,O]),Fi.ENGINE=Fi.OS=bs([p,g]),e.exports&&(t=e.exports=Fi),t.UAParser=Fi;var Ds=typeof n!==c&&(n.jQuery||n.Zepto);if(Ds&&!Ds.ua){var Vd=new Fi;Ds.ua=Vd.getResult(),Ds.ua.get=function(){return Vd.getUA()},Ds.ua.set=function(ze){Vd.setUA(ze);var ut=Vd.getResult();for(var be in ut)Ds.ua[be]=ut[be]}}})(typeof window=="object"?window:Qp)})(Q_,Q_.exports);var Eb=Q_.exports;const mb=Pf(Eb);function tA(e,t){return function(){return e.apply(t,arguments)}}const{toString:gb}=Object.prototype,{getPrototypeOf:NE}=Object,rh=(e=>t=>{const n=gb.call(t);return e[n]||(e[n]=n.slice(8,-1).toLowerCase())})(Object.create(null)),rr=e=>(e=e.toLowerCase(),t=>rh(t)===e),oh=e=>t=>typeof t===e,{isArray:Va}=Array,id=oh("undefined");function Sb(e){return e!==null&&!id(e)&&e.constructor!==null&&!id(e.constructor)&&Mi(e.constructor.isBuffer)&&e.constructor.isBuffer(e)}const nA=rr("ArrayBuffer");function Tb(e){let t;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?t=ArrayBuffer.isView(e):t=e&&e.buffer&&nA(e.buffer),t}const Rb=oh("string"),Mi=oh("function"),iA=oh("number"),sh=e=>e!==null&&typeof e=="object",Cb=e=>e===!0||e===!1,jl=e=>{if(rh(e)!=="object")return!1;const t=NE(e);return(t===null||t===Object.prototype||Object.getPrototypeOf(t)===null)&&!(Symbol.toStringTag in e)&&!(Symbol.iterator in e)},vb=rr("Date"),Ib=rr("File"),yb=rr("Blob"),Ab=rr("FileList"),wb=e=>sh(e)&&Mi(e.pipe),Nb=e=>{let t;return e&&(typeof FormData=="function"&&e instanceof FormData||Mi(e.append)&&((t=rh(e))==="formdata"||t==="object"&&Mi(e.toString)&&e.toString()==="[object FormData]"))},Ob=rr("URLSearchParams"),[bb,Db,Pb,Lb]=["ReadableStream","Request","Response","Headers"].map(rr),kb=e=>e.trim?e.trim():e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function Od(e,t,{allOwnKeys:n=!1}={}){if(e===null||typeof e>"u")return;let i,r;if(typeof e!="object"&&(e=[e]),Va(e))for(i=0,r=e.length;i<r;i++)t.call(null,e[i],i,e);else{const o=n?Object.getOwnPropertyNames(e):Object.keys(e),s=o.length;let a;for(i=0;i<s;i++)a=o[i],t.call(null,e[a],a,e)}}function rA(e,t){t=t.toLowerCase();const n=Object.keys(e);let i=n.length,r;for(;i-- >0;)if(r=n[i],t===r.toLowerCase())return r;return null}const oA=(()=>typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global)(),sA=e=>!id(e)&&e!==oA;function Z_(){const{caseless:e}=sA(this)&&this||{},t={},n=(i,r)=>{const o=e&&rA(t,r)||r;jl(t[o])&&jl(i)?t[o]=Z_(t[o],i):jl(i)?t[o]=Z_({},i):Va(i)?t[o]=i.slice():t[o]=i};for(let i=0,r=arguments.length;i<r;i++)arguments[i]&&Od(arguments[i],n);return t}const Mb=(e,t,n,{allOwnKeys:i}={})=>(Od(t,(r,o)=>{n&&Mi(r)?e[o]=tA(r,n):e[o]=r},{allOwnKeys:i}),e),Ub=e=>(e.charCodeAt(0)===65279&&(e=e.slice(1)),e),xb=(e,t,n,i)=>{e.prototype=Object.create(t.prototype,i),e.prototype.constructor=e,Object.defineProperty(e,"super",{value:t.prototype}),n&&Object.assign(e.prototype,n)},Vb=(e,t,n,i)=>{let r,o,s;const a={};if(t=t||{},e==null)return t;do{for(r=Object.getOwnPropertyNames(e),o=r.length;o-- >0;)s=r[o],(!i||i(s,e,t))&&!a[s]&&(t[s]=e[s],a[s]=!0);e=n!==!1&&NE(e)}while(e&&(!n||n(e,t))&&e!==Object.prototype);return t},Fb=(e,t,n)=>{e=String(e),(n===void 0||n>e.length)&&(n=e.length),n-=t.length;const i=e.indexOf(t,n);return i!==-1&&i===n},Bb=e=>{if(!e)return null;if(Va(e))return e;let t=e.length;if(!iA(t))return null;const n=new Array(t);for(;t-- >0;)n[t]=e[t];return n},Gb=(e=>t=>e&&t instanceof e)(typeof Uint8Array<"u"&&NE(Uint8Array)),jb=(e,t)=>{const i=(e&&e[Symbol.iterator]).call(e);let r;for(;(r=i.next())&&!r.done;){const o=r.value;t.call(e,o[0],o[1])}},Wb=(e,t)=>{let n;const i=[];for(;(n=e.exec(t))!==null;)i.push(n);return i},Hb=rr("HTMLFormElement"),Kb=e=>e.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(n,i,r){return i.toUpperCase()+r}),Ng=(({hasOwnProperty:e})=>(t,n)=>e.call(t,n))(Object.prototype),zb=rr("RegExp"),aA=(e,t)=>{const n=Object.getOwnPropertyDescriptors(e),i={};Od(n,(r,o)=>{let s;(s=t(r,o,e))!==!1&&(i[o]=s||r)}),Object.defineProperties(e,i)},Yb=e=>{aA(e,(t,n)=>{if(Mi(e)&&["arguments","caller","callee"].indexOf(n)!==-1)return!1;const i=e[n];if(Mi(i)){if(t.enumerable=!1,"writable"in t){t.writable=!1;return}t.set||(t.set=()=>{throw Error("Can not rewrite read-only method '"+n+"'")})}})},$b=(e,t)=>{const n={},i=r=>{r.forEach(o=>{n[o]=!0})};return Va(e)?i(e):i(String(e).split(t)),n},qb=()=>{},Jb=(e,t)=>e!=null&&Number.isFinite(e=+e)?e:t,ip="abcdefghijklmnopqrstuvwxyz",Og="0123456789",cA={DIGIT:Og,ALPHA:ip,ALPHA_DIGIT:ip+ip.toUpperCase()+Og},Xb=(e=16,t=cA.ALPHA_DIGIT)=>{let n="";const{length:i}=t;for(;e--;)n+=t[Math.random()*i|0];return n};function Qb(e){return!!(e&&Mi(e.append)&&e[Symbol.toStringTag]==="FormData"&&e[Symbol.iterator])}const Zb=e=>{const t=new Array(10),n=(i,r)=>{if(sh(i)){if(t.indexOf(i)>=0)return;if(!("toJSON"in i)){t[r]=i;const o=Va(i)?[]:{};return Od(i,(s,a)=>{const c=n(s,r+1);!id(c)&&(o[a]=c)}),t[r]=void 0,o}}return i};return n(e,0)},eD=rr("AsyncFunction"),tD=e=>e&&(sh(e)||Mi(e))&&Mi(e.then)&&Mi(e.catch),G={isArray:Va,isArrayBuffer:nA,isBuffer:Sb,isFormData:Nb,isArrayBufferView:Tb,isString:Rb,isNumber:iA,isBoolean:Cb,isObject:sh,isPlainObject:jl,isReadableStream:bb,isRequest:Db,isResponse:Pb,isHeaders:Lb,isUndefined:id,isDate:vb,isFile:Ib,isBlob:yb,isRegExp:zb,isFunction:Mi,isStream:wb,isURLSearchParams:Ob,isTypedArray:Gb,isFileList:Ab,forEach:Od,merge:Z_,extend:Mb,trim:kb,stripBOM:Ub,inherits:xb,toFlatObject:Vb,kindOf:rh,kindOfTest:rr,endsWith:Fb,toArray:Bb,forEachEntry:jb,matchAll:Wb,isHTMLForm:Hb,hasOwnProperty:Ng,hasOwnProp:Ng,reduceDescriptors:aA,freezeMethods:Yb,toObjectSet:$b,toCamelCase:Kb,noop:qb,toFiniteNumber:Jb,findKey:rA,global:oA,isContextDefined:sA,ALPHABET:cA,generateString:Xb,isSpecCompliantForm:Qb,toJSONObject:Zb,isAsyncFn:eD,isThenable:tD};function Pe(e,t,n,i,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=e,this.name="AxiosError",t&&(this.code=t),n&&(this.config=n),i&&(this.request=i),r&&(this.response=r)}G.inherits(Pe,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:G.toJSONObject(this.config),code:this.code,status:this.response&&this.response.status?this.response.status:null}}});const dA=Pe.prototype,lA={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(e=>{lA[e]={value:e}});Object.defineProperties(Pe,lA);Object.defineProperty(dA,"isAxiosError",{value:!0});Pe.from=(e,t,n,i,r,o)=>{const s=Object.create(dA);return G.toFlatObject(e,s,function(c){return c!==Error.prototype},a=>a!=="isAxiosError"),Pe.call(s,e.message,t,n,i,r),s.cause=e,s.name=e.name,o&&Object.assign(s,o),s};const nD=null;function ef(e){return G.isPlainObject(e)||G.isArray(e)}function uA(e){return G.endsWith(e,"[]")?e.slice(0,-2):e}function bg(e,t,n){return e?e.concat(t).map(function(r,o){return r=uA(r),!n&&o?"["+r+"]":r}).join(n?".":""):t}function iD(e){return G.isArray(e)&&!e.some(ef)}const rD=G.toFlatObject(G,{},null,function(t){return/^is[A-Z]/.test(t)});function ah(e,t,n){if(!G.isObject(e))throw new TypeError("target must be an object");t=t||new FormData,n=G.toFlatObject(n,{metaTokens:!0,dots:!1,indexes:!1},!1,function(E,g){return!G.isUndefined(g[E])});const i=n.metaTokens,r=n.visitor||l,o=n.dots,s=n.indexes,c=(n.Blob||typeof Blob<"u"&&Blob)&&G.isSpecCompliantForm(t);if(!G.isFunction(r))throw new TypeError("visitor must be a function");function d(m){if(m===null)return"";if(G.isDate(m))return m.toISOString();if(!c&&G.isBlob(m))throw new Pe("Blob is not supported. Use a Buffer instead.");return G.isArrayBuffer(m)||G.isTypedArray(m)?c&&typeof Blob=="function"?new Blob([m]):Buffer.from(m):m}function l(m,E,g){let S=m;if(m&&!g&&typeof m=="object"){if(G.endsWith(E,"{}"))E=i?E:E.slice(0,-2),m=JSON.stringify(m);else if(G.isArray(m)&&iD(m)||(G.isFileList(m)||G.endsWith(E,"[]"))&&(S=G.toArray(m)))return E=uA(E),S.forEach(function(I,y){!(G.isUndefined(I)||I===null)&&t.append(s===!0?bg([E],y,o):s===null?E:E+"[]",d(I))}),!1}return ef(m)?!0:(t.append(bg(g,E,o),d(m)),!1)}const u=[],h=Object.assign(rD,{defaultVisitor:l,convertValue:d,isVisitable:ef});function p(m,E){if(!G.isUndefined(m)){if(u.indexOf(m)!==-1)throw Error("Circular reference detected in "+E.join("."));u.push(m),G.forEach(m,function(S,T){(!(G.isUndefined(S)||S===null)&&r.call(t,S,G.isString(T)?T.trim():T,E,h))===!0&&p(S,E?E.concat(T):[T])}),u.pop()}}if(!G.isObject(e))throw new TypeError("data must be an object");return p(e),t}function Dg(e){const t={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(e).replace(/[!'()~]|%20|%00/g,function(i){return t[i]})}function OE(e,t){this._pairs=[],e&&ah(e,this,t)}const hA=OE.prototype;hA.append=function(t,n){this._pairs.push([t,n])};hA.toString=function(t){const n=t?function(i){return t.call(this,i,Dg)}:Dg;return this._pairs.map(function(r){return n(r[0])+"="+n(r[1])},"").join("&")};function oD(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function pA(e,t,n){if(!t)return e;const i=n&&n.encode||oD,r=n&&n.serialize;let o;if(r?o=r(t,n):o=G.isURLSearchParams(t)?t.toString():new OE(t,n).toString(i),o){const s=e.indexOf("#");s!==-1&&(e=e.slice(0,s)),e+=(e.indexOf("?")===-1?"?":"&")+o}return e}class sD{constructor(){this.handlers=[]}use(t,n,i){return this.handlers.push({fulfilled:t,rejected:n,synchronous:i?i.synchronous:!1,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){G.forEach(this.handlers,function(i){i!==null&&t(i)})}}const Pg=sD,_A={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},aD=typeof URLSearchParams<"u"?URLSearchParams:OE,cD=typeof FormData<"u"?FormData:null,dD=typeof Blob<"u"?Blob:null,lD={isBrowser:!0,classes:{URLSearchParams:aD,FormData:cD,Blob:dD},protocols:["http","https","file","blob","url","data"]},bE=typeof window<"u"&&typeof document<"u",uD=(e=>bE&&["ReactNative","NativeScript","NS"].indexOf(e)<0)(typeof navigator<"u"&&navigator.product),hD=(()=>typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function")(),pD=bE&&window.location.href||"http://localhost",_D=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv:bE,hasStandardBrowserEnv:uD,hasStandardBrowserWebWorkerEnv:hD,origin:pD},Symbol.toStringTag,{value:"Module"})),er={..._D,...lD};function fD(e,t){return ah(e,new er.classes.URLSearchParams,Object.assign({visitor:function(n,i,r,o){return er.isNode&&G.isBuffer(n)?(this.append(i,n.toString("base64")),!1):o.defaultVisitor.apply(this,arguments)}},t))}function ED(e){return G.matchAll(/\w+|\[(\w*)]/g,e).map(t=>t[0]==="[]"?"":t[1]||t[0])}function mD(e){const t={},n=Object.keys(e);let i;const r=n.length;let o;for(i=0;i<r;i++)o=n[i],t[o]=e[o];return t}function fA(e){function t(n,i,r,o){let s=n[o++];if(s==="__proto__")return!0;const a=Number.isFinite(+s),c=o>=n.length;return s=!s&&G.isArray(r)?r.length:s,c?(G.hasOwnProp(r,s)?r[s]=[r[s],i]:r[s]=i,!a):((!r[s]||!G.isObject(r[s]))&&(r[s]=[]),t(n,i,r[s],o)&&G.isArray(r[s])&&(r[s]=mD(r[s])),!a)}if(G.isFormData(e)&&G.isFunction(e.entries)){const n={};return G.forEachEntry(e,(i,r)=>{t(ED(i),r,n,0)}),n}return null}function gD(e,t,n){if(G.isString(e))try{return(t||JSON.parse)(e),G.trim(e)}catch(i){if(i.name!=="SyntaxError")throw i}return(n||JSON.stringify)(e)}const DE={transitional:_A,adapter:["xhr","http","fetch"],transformRequest:[function(t,n){const i=n.getContentType()||"",r=i.indexOf("application/json")>-1,o=G.isObject(t);if(o&&G.isHTMLForm(t)&&(t=new FormData(t)),G.isFormData(t))return r?JSON.stringify(fA(t)):t;if(G.isArrayBuffer(t)||G.isBuffer(t)||G.isStream(t)||G.isFile(t)||G.isBlob(t)||G.isReadableStream(t))return t;if(G.isArrayBufferView(t))return t.buffer;if(G.isURLSearchParams(t))return n.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let a;if(o){if(i.indexOf("application/x-www-form-urlencoded")>-1)return fD(t,this.formSerializer).toString();if((a=G.isFileList(t))||i.indexOf("multipart/form-data")>-1){const c=this.env&&this.env.FormData;return ah(a?{"files[]":t}:t,c&&new c,this.formSerializer)}}return o||r?(n.setContentType("application/json",!1),gD(t)):t}],transformResponse:[function(t){const n=this.transitional||DE.transitional,i=n&&n.forcedJSONParsing,r=this.responseType==="json";if(G.isResponse(t)||G.isReadableStream(t))return t;if(t&&G.isString(t)&&(i&&!this.responseType||r)){const s=!(n&&n.silentJSONParsing)&&r;try{return JSON.parse(t)}catch(a){if(s)throw a.name==="SyntaxError"?Pe.from(a,Pe.ERR_BAD_RESPONSE,this,null,this.response):a}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:er.classes.FormData,Blob:er.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};G.forEach(["delete","get","head","post","put","patch"],e=>{DE.headers[e]={}});const PE=DE,SD=G.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),TD=e=>{const t={};let n,i,r;return e&&e.split(`
`).forEach(function(s){r=s.indexOf(":"),n=s.substring(0,r).trim().toLowerCase(),i=s.substring(r+1).trim(),!(!n||t[n]&&SD[n])&&(n==="set-cookie"?t[n]?t[n].push(i):t[n]=[i]:t[n]=t[n]?t[n]+", "+i:i)}),t},Lg=Symbol("internals");function rc(e){return e&&String(e).trim().toLowerCase()}function Wl(e){return e===!1||e==null?e:G.isArray(e)?e.map(Wl):String(e)}function RD(e){const t=Object.create(null),n=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let i;for(;i=n.exec(e);)t[i[1]]=i[2];return t}const CD=e=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(e.trim());function rp(e,t,n,i,r){if(G.isFunction(i))return i.call(this,t,n);if(r&&(t=n),!!G.isString(t)){if(G.isString(i))return t.indexOf(i)!==-1;if(G.isRegExp(i))return i.test(t)}}function vD(e){return e.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(t,n,i)=>n.toUpperCase()+i)}function ID(e,t){const n=G.toCamelCase(" "+t);["get","set","has"].forEach(i=>{Object.defineProperty(e,i+n,{value:function(r,o,s){return this[i].call(this,t,r,o,s)},configurable:!0})})}class ch{constructor(t){t&&this.set(t)}set(t,n,i){const r=this;function o(a,c,d){const l=rc(c);if(!l)throw new Error("header name must be a non-empty string");const u=G.findKey(r,l);(!u||r[u]===void 0||d===!0||d===void 0&&r[u]!==!1)&&(r[u||c]=Wl(a))}const s=(a,c)=>G.forEach(a,(d,l)=>o(d,l,c));if(G.isPlainObject(t)||t instanceof this.constructor)s(t,n);else if(G.isString(t)&&(t=t.trim())&&!CD(t))s(TD(t),n);else if(G.isHeaders(t))for(const[a,c]of t.entries())o(c,a,i);else t!=null&&o(n,t,i);return this}get(t,n){if(t=rc(t),t){const i=G.findKey(this,t);if(i){const r=this[i];if(!n)return r;if(n===!0)return RD(r);if(G.isFunction(n))return n.call(this,r,i);if(G.isRegExp(n))return n.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(t,n){if(t=rc(t),t){const i=G.findKey(this,t);return!!(i&&this[i]!==void 0&&(!n||rp(this,this[i],i,n)))}return!1}delete(t,n){const i=this;let r=!1;function o(s){if(s=rc(s),s){const a=G.findKey(i,s);a&&(!n||rp(i,i[a],a,n))&&(delete i[a],r=!0)}}return G.isArray(t)?t.forEach(o):o(t),r}clear(t){const n=Object.keys(this);let i=n.length,r=!1;for(;i--;){const o=n[i];(!t||rp(this,this[o],o,t,!0))&&(delete this[o],r=!0)}return r}normalize(t){const n=this,i={};return G.forEach(this,(r,o)=>{const s=G.findKey(i,o);if(s){n[s]=Wl(r),delete n[o];return}const a=t?vD(o):String(o).trim();a!==o&&delete n[o],n[a]=Wl(r),i[a]=!0}),this}concat(...t){return this.constructor.concat(this,...t)}toJSON(t){const n=Object.create(null);return G.forEach(this,(i,r)=>{i!=null&&i!==!1&&(n[r]=t&&G.isArray(i)?i.join(", "):i)}),n}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([t,n])=>t+": "+n).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(t){return t instanceof this?t:new this(t)}static concat(t,...n){const i=new this(t);return n.forEach(r=>i.set(r)),i}static accessor(t){const i=(this[Lg]=this[Lg]={accessors:{}}).accessors,r=this.prototype;function o(s){const a=rc(s);i[a]||(ID(r,s),i[a]=!0)}return G.isArray(t)?t.forEach(o):o(t),this}}ch.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);G.reduceDescriptors(ch.prototype,({value:e},t)=>{let n=t[0].toUpperCase()+t.slice(1);return{get:()=>e,set(i){this[n]=i}}});G.freezeMethods(ch);const tr=ch;function op(e,t){const n=this||PE,i=t||n,r=tr.from(i.headers);let o=i.data;return G.forEach(e,function(a){o=a.call(n,o,r.normalize(),t?t.status:void 0)}),r.normalize(),o}function EA(e){return!!(e&&e.__CANCEL__)}function Fa(e,t,n){Pe.call(this,e??"canceled",Pe.ERR_CANCELED,t,n),this.name="CanceledError"}G.inherits(Fa,Pe,{__CANCEL__:!0});function mA(e,t,n){const i=n.config.validateStatus;!n.status||!i||i(n.status)?e(n):t(new Pe("Request failed with status code "+n.status,[Pe.ERR_BAD_REQUEST,Pe.ERR_BAD_RESPONSE][Math.floor(n.status/100)-4],n.config,n.request,n))}function yD(e){const t=/^([-+\w]{1,25})(:?\/\/|:)/.exec(e);return t&&t[1]||""}function AD(e,t){e=e||10;const n=new Array(e),i=new Array(e);let r=0,o=0,s;return t=t!==void 0?t:1e3,function(c){const d=Date.now(),l=i[o];s||(s=d),n[r]=c,i[r]=d;let u=o,h=0;for(;u!==r;)h+=n[u++],u=u%e;if(r=(r+1)%e,r===o&&(o=(o+1)%e),d-s<t)return;const p=l&&d-l;return p?Math.round(h*1e3/p):void 0}}function wD(e,t){let n=0;const i=1e3/t;let r=null;return function(){const s=this===!0,a=Date.now();if(s||a-n>i)return r&&(clearTimeout(r),r=null),n=a,e.apply(null,arguments);r||(r=setTimeout(()=>(r=null,n=Date.now(),e.apply(null,arguments)),i-(a-n)))}}const Au=(e,t,n=3)=>{let i=0;const r=AD(50,250);return wD(o=>{const s=o.loaded,a=o.lengthComputable?o.total:void 0,c=s-i,d=r(c),l=s<=a;i=s;const u={loaded:s,total:a,progress:a?s/a:void 0,bytes:c,rate:d||void 0,estimated:d&&a&&l?(a-s)/d:void 0,event:o,lengthComputable:a!=null};u[t?"download":"upload"]=!0,e(u)},n)},ND=er.hasStandardBrowserEnv?function(){const t=/(msie|trident)/i.test(navigator.userAgent),n=document.createElement("a");let i;function r(o){let s=o;return t&&(n.setAttribute("href",s),s=n.href),n.setAttribute("href",s),{href:n.href,protocol:n.protocol?n.protocol.replace(/:$/,""):"",host:n.host,search:n.search?n.search.replace(/^\?/,""):"",hash:n.hash?n.hash.replace(/^#/,""):"",hostname:n.hostname,port:n.port,pathname:n.pathname.charAt(0)==="/"?n.pathname:"/"+n.pathname}}return i=r(window.location.href),function(s){const a=G.isString(s)?r(s):s;return a.protocol===i.protocol&&a.host===i.host}}():function(){return function(){return!0}}(),OD=er.hasStandardBrowserEnv?{write(e,t,n,i,r,o){const s=[e+"="+encodeURIComponent(t)];G.isNumber(n)&&s.push("expires="+new Date(n).toGMTString()),G.isString(i)&&s.push("path="+i),G.isString(r)&&s.push("domain="+r),o===!0&&s.push("secure"),document.cookie=s.join("; ")},read(e){const t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove(e){this.write(e,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function bD(e){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(e)}function DD(e,t){return t?e.replace(/\/?\/$/,"")+"/"+t.replace(/^\/+/,""):e}function gA(e,t){return e&&!bD(t)?DD(e,t):t}const kg=e=>e instanceof tr?{...e}:e;function ms(e,t){t=t||{};const n={};function i(d,l,u){return G.isPlainObject(d)&&G.isPlainObject(l)?G.merge.call({caseless:u},d,l):G.isPlainObject(l)?G.merge({},l):G.isArray(l)?l.slice():l}function r(d,l,u){if(G.isUndefined(l)){if(!G.isUndefined(d))return i(void 0,d,u)}else return i(d,l,u)}function o(d,l){if(!G.isUndefined(l))return i(void 0,l)}function s(d,l){if(G.isUndefined(l)){if(!G.isUndefined(d))return i(void 0,d)}else return i(void 0,l)}function a(d,l,u){if(u in t)return i(d,l);if(u in e)return i(void 0,d)}const c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(d,l)=>r(kg(d),kg(l),!0)};return G.forEach(Object.keys(Object.assign({},e,t)),function(l){const u=c[l]||r,h=u(e[l],t[l],l);G.isUndefined(h)&&u!==a||(n[l]=h)}),n}const SA=e=>{const t=ms({},e);let{data:n,withXSRFToken:i,xsrfHeaderName:r,xsrfCookieName:o,headers:s,auth:a}=t;t.headers=s=tr.from(s),t.url=pA(gA(t.baseURL,t.url),e.params,e.paramsSerializer),a&&s.set("Authorization","Basic "+btoa((a.username||"")+":"+(a.password?unescape(encodeURIComponent(a.password)):"")));let c;if(G.isFormData(n)){if(er.hasStandardBrowserEnv||er.hasStandardBrowserWebWorkerEnv)s.setContentType(void 0);else if((c=s.getContentType())!==!1){const[d,...l]=c?c.split(";").map(u=>u.trim()).filter(Boolean):[];s.setContentType([d||"multipart/form-data",...l].join("; "))}}if(er.hasStandardBrowserEnv&&(i&&G.isFunction(i)&&(i=i(t)),i||i!==!1&&ND(t.url))){const d=r&&o&&OD.read(o);d&&s.set(r,d)}return t},PD=typeof XMLHttpRequest<"u",LD=PD&&function(e){return new Promise(function(n,i){const r=SA(e);let o=r.data;const s=tr.from(r.headers).normalize();let{responseType:a}=r,c;function d(){r.cancelToken&&r.cancelToken.unsubscribe(c),r.signal&&r.signal.removeEventListener("abort",c)}let l=new XMLHttpRequest;l.open(r.method.toUpperCase(),r.url,!0),l.timeout=r.timeout;function u(){if(!l)return;const p=tr.from("getAllResponseHeaders"in l&&l.getAllResponseHeaders()),E={data:!a||a==="text"||a==="json"?l.responseText:l.response,status:l.status,statusText:l.statusText,headers:p,config:e,request:l};mA(function(S){n(S),d()},function(S){i(S),d()},E),l=null}"onloadend"in l?l.onloadend=u:l.onreadystatechange=function(){!l||l.readyState!==4||l.status===0&&!(l.responseURL&&l.responseURL.indexOf("file:")===0)||setTimeout(u)},l.onabort=function(){l&&(i(new Pe("Request aborted",Pe.ECONNABORTED,r,l)),l=null)},l.onerror=function(){i(new Pe("Network Error",Pe.ERR_NETWORK,r,l)),l=null},l.ontimeout=function(){let m=r.timeout?"timeout of "+r.timeout+"ms exceeded":"timeout exceeded";const E=r.transitional||_A;r.timeoutErrorMessage&&(m=r.timeoutErrorMessage),i(new Pe(m,E.clarifyTimeoutError?Pe.ETIMEDOUT:Pe.ECONNABORTED,r,l)),l=null},o===void 0&&s.setContentType(null),"setRequestHeader"in l&&G.forEach(s.toJSON(),function(m,E){l.setRequestHeader(E,m)}),G.isUndefined(r.withCredentials)||(l.withCredentials=!!r.withCredentials),a&&a!=="json"&&(l.responseType=r.responseType),typeof r.onDownloadProgress=="function"&&l.addEventListener("progress",Au(r.onDownloadProgress,!0)),typeof r.onUploadProgress=="function"&&l.upload&&l.upload.addEventListener("progress",Au(r.onUploadProgress)),(r.cancelToken||r.signal)&&(c=p=>{l&&(i(!p||p.type?new Fa(null,e,l):p),l.abort(),l=null)},r.cancelToken&&r.cancelToken.subscribe(c),r.signal&&(r.signal.aborted?c():r.signal.addEventListener("abort",c)));const h=yD(r.url);if(h&&er.protocols.indexOf(h)===-1){i(new Pe("Unsupported protocol "+h+":",Pe.ERR_BAD_REQUEST,e));return}l.send(o||null)})},kD=(e,t)=>{let n=new AbortController,i;const r=function(c){if(!i){i=!0,s();const d=c instanceof Error?c:this.reason;n.abort(d instanceof Pe?d:new Fa(d instanceof Error?d.message:d))}};let o=t&&setTimeout(()=>{r(new Pe(`timeout ${t} of ms exceeded`,Pe.ETIMEDOUT))},t);const s=()=>{e&&(o&&clearTimeout(o),o=null,e.forEach(c=>{c&&(c.removeEventListener?c.removeEventListener("abort",r):c.unsubscribe(r))}),e=null)};e.forEach(c=>c&&c.addEventListener&&c.addEventListener("abort",r));const{signal:a}=n;return a.unsubscribe=s,[a,()=>{o&&clearTimeout(o),o=null}]},MD=kD,UD=function*(e,t){let n=e.byteLength;if(!t||n<t){yield e;return}let i=0,r;for(;i<n;)r=i+t,yield e.slice(i,r),i=r},xD=async function*(e,t,n){for await(const i of e)yield*UD(ArrayBuffer.isView(i)?i:await n(String(i)),t)},Mg=(e,t,n,i,r)=>{const o=xD(e,t,r);let s=0;return new ReadableStream({type:"bytes",async pull(a){const{done:c,value:d}=await o.next();if(c){a.close(),i();return}let l=d.byteLength;n&&n(s+=l),a.enqueue(new Uint8Array(d))},cancel(a){return i(a),o.return()}},{highWaterMark:2})},Ug=(e,t)=>{const n=e!=null;return i=>setTimeout(()=>t({lengthComputable:n,total:e,loaded:i}))},dh=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",TA=dh&&typeof ReadableStream=="function",tf=dh&&(typeof TextEncoder=="function"?(e=>t=>e.encode(t))(new TextEncoder):async e=>new Uint8Array(await new Response(e).arrayBuffer())),VD=TA&&(()=>{let e=!1;const t=new Request(er.origin,{body:new ReadableStream,method:"POST",get duplex(){return e=!0,"half"}}).headers.has("Content-Type");return e&&!t})(),xg=64*1024,nf=TA&&!!(()=>{try{return G.isReadableStream(new Response("").body)}catch{}})(),wu={stream:nf&&(e=>e.body)};dh&&(e=>{["text","arrayBuffer","blob","formData","stream"].forEach(t=>{!wu[t]&&(wu[t]=G.isFunction(e[t])?n=>n[t]():(n,i)=>{throw new Pe(`Response type '${t}' is not supported`,Pe.ERR_NOT_SUPPORT,i)})})})(new Response);const FD=async e=>{if(e==null)return 0;if(G.isBlob(e))return e.size;if(G.isSpecCompliantForm(e))return(await new Request(e).arrayBuffer()).byteLength;if(G.isArrayBufferView(e))return e.byteLength;if(G.isURLSearchParams(e)&&(e=e+""),G.isString(e))return(await tf(e)).byteLength},BD=async(e,t)=>{const n=G.toFiniteNumber(e.getContentLength());return n??FD(t)},GD=dh&&(async e=>{let{url:t,method:n,data:i,signal:r,cancelToken:o,timeout:s,onDownloadProgress:a,onUploadProgress:c,responseType:d,headers:l,withCredentials:u="same-origin",fetchOptions:h}=SA(e);d=d?(d+"").toLowerCase():"text";let[p,m]=r||o||s?MD([r,o],s):[],E,g;const S=()=>{!E&&setTimeout(()=>{p&&p.unsubscribe()}),E=!0};let T;try{if(c&&VD&&n!=="get"&&n!=="head"&&(T=await BD(l,i))!==0){let D=new Request(t,{method:"POST",body:i,duplex:"half"}),O;G.isFormData(i)&&(O=D.headers.get("content-type"))&&l.setContentType(O),D.body&&(i=Mg(D.body,xg,Ug(T,Au(c)),null,tf))}G.isString(u)||(u=u?"cors":"omit"),g=new Request(t,{...h,signal:p,method:n.toUpperCase(),headers:l.normalize().toJSON(),body:i,duplex:"half",withCredentials:u});let I=await fetch(g);const y=nf&&(d==="stream"||d==="response");if(nf&&(a||y)){const D={};["status","statusText","headers"].forEach(P=>{D[P]=I[P]});const O=G.toFiniteNumber(I.headers.get("content-length"));I=new Response(Mg(I.body,xg,a&&Ug(O,Au(a,!0)),y&&S,tf),D)}d=d||"text";let w=await wu[G.findKey(wu,d)||"text"](I,e);return!y&&S(),m&&m(),await new Promise((D,O)=>{mA(D,O,{data:w,headers:tr.from(I.headers),status:I.status,statusText:I.statusText,config:e,request:g})})}catch(I){throw S(),I&&I.name==="TypeError"&&/fetch/i.test(I.message)?Object.assign(new Pe("Network Error",Pe.ERR_NETWORK,e,g),{cause:I.cause||I}):Pe.from(I,I&&I.code,e,g)}}),rf={http:nD,xhr:LD,fetch:GD};G.forEach(rf,(e,t)=>{if(e){try{Object.defineProperty(e,"name",{value:t})}catch{}Object.defineProperty(e,"adapterName",{value:t})}});const Vg=e=>`- ${e}`,jD=e=>G.isFunction(e)||e===null||e===!1,RA={getAdapter:e=>{e=G.isArray(e)?e:[e];const{length:t}=e;let n,i;const r={};for(let o=0;o<t;o++){n=e[o];let s;if(i=n,!jD(n)&&(i=rf[(s=String(n)).toLowerCase()],i===void 0))throw new Pe(`Unknown adapter '${s}'`);if(i)break;r[s||"#"+o]=i}if(!i){const o=Object.entries(r).map(([a,c])=>`adapter ${a} `+(c===!1?"is not supported by the environment":"is not available in the build"));let s=t?o.length>1?`since :
`+o.map(Vg).join(`
`):" "+Vg(o[0]):"as no adapter specified";throw new Pe("There is no suitable adapter to dispatch the request "+s,"ERR_NOT_SUPPORT")}return i},adapters:rf};function sp(e){if(e.cancelToken&&e.cancelToken.throwIfRequested(),e.signal&&e.signal.aborted)throw new Fa(null,e)}function Fg(e){return sp(e),e.headers=tr.from(e.headers),e.data=op.call(e,e.transformRequest),["post","put","patch"].indexOf(e.method)!==-1&&e.headers.setContentType("application/x-www-form-urlencoded",!1),RA.getAdapter(e.adapter||PE.adapter)(e).then(function(i){return sp(e),i.data=op.call(e,e.transformResponse,i),i.headers=tr.from(i.headers),i},function(i){return EA(i)||(sp(e),i&&i.response&&(i.response.data=op.call(e,e.transformResponse,i.response),i.response.headers=tr.from(i.response.headers))),Promise.reject(i)})}const CA="1.7.2",LE={};["object","boolean","number","function","string","symbol"].forEach((e,t)=>{LE[e]=function(i){return typeof i===e||"a"+(t<1?"n ":" ")+e}});const Bg={};LE.transitional=function(t,n,i){function r(o,s){return"[Axios v"+CA+"] Transitional option '"+o+"'"+s+(i?". "+i:"")}return(o,s,a)=>{if(t===!1)throw new Pe(r(s," has been removed"+(n?" in "+n:"")),Pe.ERR_DEPRECATED);return n&&!Bg[s]&&(Bg[s]=!0,console.warn(r(s," has been deprecated since v"+n+" and will be removed in the near future"))),t?t(o,s,a):!0}};function WD(e,t,n){if(typeof e!="object")throw new Pe("options must be an object",Pe.ERR_BAD_OPTION_VALUE);const i=Object.keys(e);let r=i.length;for(;r-- >0;){const o=i[r],s=t[o];if(s){const a=e[o],c=a===void 0||s(a,o,e);if(c!==!0)throw new Pe("option "+o+" must be "+c,Pe.ERR_BAD_OPTION_VALUE);continue}if(n!==!0)throw new Pe("Unknown option "+o,Pe.ERR_BAD_OPTION)}}const of={assertOptions:WD,validators:LE},Xr=of.validators;class Nu{constructor(t){this.defaults=t,this.interceptors={request:new Pg,response:new Pg}}async request(t,n){try{return await this._request(t,n)}catch(i){if(i instanceof Error){let r;Error.captureStackTrace?Error.captureStackTrace(r={}):r=new Error;const o=r.stack?r.stack.replace(/^.+\n/,""):"";try{i.stack?o&&!String(i.stack).endsWith(o.replace(/^.+\n.+\n/,""))&&(i.stack+=`
`+o):i.stack=o}catch{}}throw i}}_request(t,n){typeof t=="string"?(n=n||{},n.url=t):n=t||{},n=ms(this.defaults,n);const{transitional:i,paramsSerializer:r,headers:o}=n;i!==void 0&&of.assertOptions(i,{silentJSONParsing:Xr.transitional(Xr.boolean),forcedJSONParsing:Xr.transitional(Xr.boolean),clarifyTimeoutError:Xr.transitional(Xr.boolean)},!1),r!=null&&(G.isFunction(r)?n.paramsSerializer={serialize:r}:of.assertOptions(r,{encode:Xr.function,serialize:Xr.function},!0)),n.method=(n.method||this.defaults.method||"get").toLowerCase();let s=o&&G.merge(o.common,o[n.method]);o&&G.forEach(["delete","get","head","post","put","patch","common"],m=>{delete o[m]}),n.headers=tr.concat(s,o);const a=[];let c=!0;this.interceptors.request.forEach(function(E){typeof E.runWhen=="function"&&E.runWhen(n)===!1||(c=c&&E.synchronous,a.unshift(E.fulfilled,E.rejected))});const d=[];this.interceptors.response.forEach(function(E){d.push(E.fulfilled,E.rejected)});let l,u=0,h;if(!c){const m=[Fg.bind(this),void 0];for(m.unshift.apply(m,a),m.push.apply(m,d),h=m.length,l=Promise.resolve(n);u<h;)l=l.then(m[u++],m[u++]);return l}h=a.length;let p=n;for(u=0;u<h;){const m=a[u++],E=a[u++];try{p=m(p)}catch(g){E.call(this,g);break}}try{l=Fg.call(this,p)}catch(m){return Promise.reject(m)}for(u=0,h=d.length;u<h;)l=l.then(d[u++],d[u++]);return l}getUri(t){t=ms(this.defaults,t);const n=gA(t.baseURL,t.url);return pA(n,t.params,t.paramsSerializer)}}G.forEach(["delete","get","head","options"],function(t){Nu.prototype[t]=function(n,i){return this.request(ms(i||{},{method:t,url:n,data:(i||{}).data}))}});G.forEach(["post","put","patch"],function(t){function n(i){return function(o,s,a){return this.request(ms(a||{},{method:t,headers:i?{"Content-Type":"multipart/form-data"}:{},url:o,data:s}))}}Nu.prototype[t]=n(),Nu.prototype[t+"Form"]=n(!0)});const Hl=Nu;class kE{constructor(t){if(typeof t!="function")throw new TypeError("executor must be a function.");let n;this.promise=new Promise(function(o){n=o});const i=this;this.promise.then(r=>{if(!i._listeners)return;let o=i._listeners.length;for(;o-- >0;)i._listeners[o](r);i._listeners=null}),this.promise.then=r=>{let o;const s=new Promise(a=>{i.subscribe(a),o=a}).then(r);return s.cancel=function(){i.unsubscribe(o)},s},t(function(o,s,a){i.reason||(i.reason=new Fa(o,s,a),n(i.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(t){if(this.reason){t(this.reason);return}this._listeners?this._listeners.push(t):this._listeners=[t]}unsubscribe(t){if(!this._listeners)return;const n=this._listeners.indexOf(t);n!==-1&&this._listeners.splice(n,1)}static source(){let t;return{token:new kE(function(r){t=r}),cancel:t}}}const HD=kE;function KD(e){return function(n){return e.apply(null,n)}}function zD(e){return G.isObject(e)&&e.isAxiosError===!0}const sf={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(sf).forEach(([e,t])=>{sf[t]=e});const YD=sf;function vA(e){const t=new Hl(e),n=tA(Hl.prototype.request,t);return G.extend(n,Hl.prototype,t,{allOwnKeys:!0}),G.extend(n,t,null,{allOwnKeys:!0}),n.create=function(r){return vA(ms(e,r))},n}const ln=vA(PE);ln.Axios=Hl;ln.CanceledError=Fa;ln.CancelToken=HD;ln.isCancel=EA;ln.VERSION=CA;ln.toFormData=ah;ln.AxiosError=Pe;ln.Cancel=ln.CanceledError;ln.all=function(t){return Promise.all(t)};ln.spread=KD;ln.isAxiosError=zD;ln.mergeConfig=ms;ln.AxiosHeaders=tr;ln.formToJSON=e=>fA(G.isHTMLForm(e)?new FormData(e):e);ln.getAdapter=RA.getAdapter;ln.HttpStatusCode=YD;ln.default=ln;const Un=ln,$D=()=>{};function rd(){const e={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:$D};return e.promise=new Promise((t,n)=>{e.resolve=i=>{e.isFinished||(e.isResolved=!0,e.isFinished=!0,t(i),e.value=i)},e.reject=i=>{e.isFinished||(e.isRejected=!0,e.isFinished=!0,n(i))}}),e}const nl=new Map,il=new Map,dr=new Map;async function qD(e,t,n){nl.get(e)||nl.set(e,[]),il.get(e)||il.set(e,t),dr.get(e)||dr.set(e,0);const i=nl.get(e),r=il.get(e);if(!i||!r)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(dr.get(e)===r){const d=rd();i.push(d),await d.promise}dr.set(e,dr.get(e)+1);for(var o=arguments.length,s=new Array(o>3?o-3:0),a=3;a<o;a++)s[a-3]=arguments[a];const c=await n(...s);return dr.set(e,dr.get(e)-1),dr.get(e)===r-1&&i.length>0&&(i[0].resolve(),i.shift()),dr.get(e)===0&&(nl.set(e,[]),il.set(e,0),dr.set(e,0)),c}let Ht=function(e){return e.WIN_10="Windows 10",e.WIN_81="Windows 8.1",e.WIN_8="Windows 8",e.WIN_7="Windows 7",e.WIN_VISTA="Windows Vista",e.WIN_SERVER_2003="Windows Server 2003",e.WIN_XP="Windows XP",e.WIN_2000="Windows 2000",e.ANDROID="Android",e.HARMONY_OS="HarmonyOS",e.OPEN_BSD="Open BSD",e.SUN_OS="Sun OS",e.LINUX="Linux",e.IOS="iOS",e.MAC_OS="Mac OS",e.CHROMIUM_OS="Chromium OS",e.QNX="QNX",e.UNIX="UNIX",e.BEOS="BeOS",e.OS_2="OS/2",e.SEARCH_BOT="Search Bot",e}({}),Ke=function(e){return e.CHROME="Chrome",e.SAFARI="Safari",e.EDGE="Edge",e.FIREFOX="Firefox",e.OPERA="OPR",e.QQ="QQBrowser",e.WECHAT="MicroMessenger",e}({});const af=new mb;let ro=af.getResult(),ap=null;function Ie(e){if(!ap){e&&af.setUA(e),ro=af.getResult();const t=JD(ro),n=Gg(ro),i=XD(ro),r=ro.os.version,o=Gg(ro,!1),s=ro.device.type;if(!(t&&n&&i&&r))return{name:t,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s};ap={name:t,version:n,os:i,osVersion:r,browserVersion:o,deviceType:s}}return ap}function JD(e){if(e.engine.name==="Blink"&&e.browser.name!=="WeChat")return Ke.CHROME;switch(e.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return Ke.CHROME;case"Safari":case"Mobile Safari":return Ke.SAFARI;case"Edge":return Ke.EDGE;case"Firefox":return Ke.FIREFOX;case"QQ":case"QQBrowser":return Ke.QQ;case"Opera":return Ke.OPERA;case"WeChat":return Ke.WECHAT;default:return e.browser.name||""}}function Gg(e){let t,n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return t=e.engine.name==="Blink"?e.engine.version||"":e.browser.version||"",n?t.split(".")[0]:t}function XD(e){return e.os.name==="Windows"?e.os.version?e.os.name+" "+e.os.version:e.os.name:e.os.name||""}function lh(){return Ie().os}function jg(){const e=Ie();return"".concat(e.os," ").concat(e.osVersion)}function IA(){const e=Ie();return!!(ro.engine.name==="WebKit"&&e.os===Ht.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&e.name!==Ke.SAFARI||dn()&&e.name!==Ke.SAFARI)}function Ns(){return Ie().name===Ke.CHROME}function Gt(){return Ie().name===Ke.SAFARI}function yA(){return Ie().name===Ke.EDGE}function Me(){return Ie().name===Ke.FIREFOX}function dn(){return Ie().os===Ht.IOS}function QD(e){const t=Ie();return!(t.name!==Ke.CHROME||!t.osVersion)&&Number(t.version)>=e}function ZD(e,t,n){const i=Ie();return!(i.name!==e||!i.osVersion)&&(n?Number(i.version)>=t&&Number(i.version)<=n:Number(i.version)===t)}function eP(e){const t=Ie();return!(t.name!==Ke.FIREFOX||!t.osVersion)&&Number(t.version)>=e}function AA(e){const t=Ie();return!(t.name!==Ke.SAFARI||!t.osVersion)&&Number(t.version)>=e}function tP(e){const t=Ie();if(t.os!==Ht.IOS||!t.osVersion)return!1;const n=t.osVersion.split(".");return Number(n[0])>=e}function wA(e,t,n){const i=Ie();if(i.os!==Ht.IOS||!i.osVersion)return!1;const r=i.osVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function NA(e,t,n){const i=Ie();if(i.name!==Ke.SAFARI||!i.osVersion||!i.browserVersion)return!1;const r=i.browserVersion.split(".");return n?t&&Number(r[0])===e&&Number(r[1])<t||Number(r[0])<e:t?Number(r[0])===e&&Number(r[1])<=t||Number(r[0])<e:Number(r[0])<=e}function OA(){const e=Ie();return!(e.name!==Ke.CHROME||!e.osVersion)&&Number(e.version)<=90}function nP(){return Ie().os===Ht.MAC_OS}function Wg(){const e=Ie();if(e.os!==Ht.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])<14||Number(t[0])===14&&Number(t[1])<=6}function ya(){const e=Ie();if(e.os!==Ht.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15}function cf(){const e=Ie();if(e.os!==Ht.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===16}function Hg(){const e=Ie();if(e.os!==Ht.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=1}function iP(){const e=Ie();if(e.os!==Ht.IOS||!e.osVersion)return!1;const t=e.osVersion.split(".");return Number(t[0])===15&&Number(t[1])>=2}function nr(){return Gt()&&navigator.maxTouchPoints>0}function rP(){return Ie().name===Ke.WECHAT}function bA(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function oP(){return lh().indexOf("Windows")!==-1}function sP(){const{deviceType:e}=Ie();return e==="mobile"||e==="tablet"}function DA(){const e=lh();return sP()||e===Ht.ANDROID||e===Ht.IOS||e===Ht.HARMONY_OS}function ko(){const e=Ie();return e.name===Ke.EDGE||e.name===Ke.SAFARI?!1:!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function aP(){return lh()===Ht.HARMONY_OS}function uh(){return lh()===Ht.ANDROID}function od(){const e=Ie();return uh()&&(e.name===Ke.CHROME||e.name===Ke.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function Kg(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),n.push.apply(n,i)}return n}function Y(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?Kg(Object(n),!0).forEach(function(i){He(e,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Kg(Object(n)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))})}return e}function He(e,t,n){return(t=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,s||"default");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(o)}(i,"string");return typeof r=="symbol"?r:String(r)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}let C=function(e){return e.UNEXPECTED_ERROR="UNEXPECTED_ERROR",e.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",e.TIMEOUT="TIMEOUT",e.INVALID_PARAMS="INVALID_PARAMS",e.NOT_READABLE="NOT_READABLE",e.NOT_SUPPORTED="NOT_SUPPORTED",e.INVALID_OPERATION="INVALID_OPERATION",e.OPERATION_ABORTED="OPERATION_ABORTED",e.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",e.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",e.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",e.DATACHANNEL_FAILED="DATACHANNEL_FAILED",e.NETWORK_ERROR="NETWORK_ERROR",e.NETWORK_TIMEOUT="NETWORK_TIMEOUT",e.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",e.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",e.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",e.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",e.ELECTRON_IS_NULL="ELECTRON_IS_NULL",e.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",e.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",e.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",e.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",e.TRACK_IS_DISABLED="TRACK_IS_DISABLED",e.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",e.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",e.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",e.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",e.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",e.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",e.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",e.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",e.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",e.UID_CONFLICT="UID_CONFLICT",e.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",e.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",e.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",e.INVALID_TRACK="INVALID_TRACK",e.SENDER_NOT_FOUND="SENDER_NOT_FOUND",e.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",e.SET_ANSWER_FAILED="SET_ANSWER_FAILED",e.ICE_FAILED="ICE_FAILED",e.PC_CLOSED="PC_CLOSED",e.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",e.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",e.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",e.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",e.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",e.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",e.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",e.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",e.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",e.INVALID_REMOTE_USER="INVALID_REMOTE_USER",e.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",e.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",e.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",e.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",e.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",e.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",e.WS_ABORT="WS_ABORT",e.WS_DISCONNECT="WS_DISCONNECT",e.WS_ERR="WS_ERR",e.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",e.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",e.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",e.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",e.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",e.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",e.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",e.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",e.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",e.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",e.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",e.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",e.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",e.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",e.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",e.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",e.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",e.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",e.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",e.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",e.INVALID_PLUGIN="INVALID_PLUGIN",e.DISCONNECT_P2P="DISCONNECT_P2P",e.INIT_WEBSOCKET_TIMEOUT="INIT_WEBSOCKET_TIMEOUT",e.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",e.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",e.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",e.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",e.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",e.PROHIBITED_OPERATION="PROHIBITED_OPERATION",e.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",e.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",e}({});class L extends Error{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(n),He(this,"code",void 0),He(this,"message",void 0),He(this,"data",void 0),He(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(n),this.data=i}toString(){return this.data?"data: ".concat(JSON.stringify(this.data),`
`).concat(this.stack):"".concat(this.stack)}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",n=arguments.length>1?arguments[1]:void 0;return t==="error"&&(n||console).error(this.toString()),t==="warning"&&(n||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}}function Fr(e,t){if(typeof e!="boolean")throw new L(C.INVALID_PARAMS,"Invalid ".concat(t,": The value is of the boolean type."))}function Xt(e,t,n){if(!n.includes(e))throw new L(C.INVALID_PARAMS,"".concat(t," can only be set as ").concat(JSON.stringify(n)))}function De(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(e<n||e>i||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(e))throw new L(C.INVALID_PARAMS,"invalid ".concat(t,": the value range is [").concat(n,", ").concat(i,"]. integer only"))}function cp(e,t){if(typeof e!="number"){if(!(e.min||e.max||e.ideal||e.exact))throw new L(C.INVALID_PARAMS,"".concat(t," is not a valid ConstrainLong"));e.min!==void 0&&De(e.min,"".concat(t,".min"),0,1/0),e.max!==void 0&&De(e.max,"".concat(t,".max"),1,1/0),e.exact!==void 0&&De(e.exact,"".concat(t,".exact"),1,1/0),e.ideal!==void 0&&De(e.ideal,"".concat(t,".ideal"),1,1/0)}else De(e,t,1,1/0)}function jt(e,t){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(e==null)throw new L(C.INVALID_PARAMS,"".concat(t||"param"," cannot be empty"));if(!PA(e,n,i,r))throw new L(C.INVALID_PARAMS,"Invalid ".concat(t||"string param",": Length of the string: [").concat(n,",").concat(i,"].").concat(r?" ASCII characters only.":""))}function Mr(e,t){if(!Array.isArray(e))throw new L(C.INVALID_PARAMS,"".concat(t," should be an array"))}function tt(e){return e==null}function PA(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,i=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof e=="string"&&e.length<=n&&e.length>=t&&(!i||function(r){if(typeof r!="string")return!1;for(let o=0;o<r.length;o+=1){const s=r.charCodeAt(o);if(s<0||s>255)return!1}return!0}(e))}function zg(e,t,n){if("getBigUint64"in DataView.prototype)return e.getBigUint64(t,n);const i=e.getUint32(t,n),r=e.getUint32(t+4,n),o=+!!n,s=+!n;return BigInt(i*s+r*o)<<BigInt(32)|BigInt(i*o+r*s)}function Yg(e,t,n,i){if("setBigUint64"in DataView.prototype)return e.setBigUint64(t,n,i);const r=Number(n>>BigInt(32)),o=Number(n&BigInt(4294967295));i?(e.setUint32(t+4,r,i),e.setUint32(t,o,i)):(e.setUint32(t,r,i),e.setUint32(t+4,o,i))}var mc=function(e){return e.COVERED="COVERED",e.POSITION="POSITION",e.SIZE="SIZE",e.STYLE="STYLE",e}(mc||{}),df=function(e){return e.UNMOUNTED="UNMOUNTED",e.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",e}(df||{});const LA=new class{constructor(){He(this,"_clientSize",null),He(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),He(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),He(this,"getStyle",e=>window.getComputedStyle(e,null)),He(this,"checkCssVisibleProperty",e=>{let t=!0;const n=this.getStyle(e),{display:i,visibility:r,opacity:o,filter:s}=n;return(i==="none"||["hidden","collapse"].includes(r)||Number(o)<.1)&&(t=!1),t?(s&&s.split(" ").filter(a=>{const c=a.split("(")[0];return["brightness","blur","opacity"].includes(c)}).map(a=>{const[c,d]=a.split(/\(|\)/);return[c,Number(d.match(/^[0-9\.]+/))]}).forEach(a=>{const[c,d]=a;switch(c){case"brightness":(d<.1||d>3)&&(t=!1);break;case"blur":d>3&&(t=!1);break;case"opacity":d<.1&&(t=!1)}}),t):!1}),He(this,"checkPropertyUpToAllParentNodes",(e,t)=>{let n=!0,i=!0;const r=s=>t(s);let o=e;for(;o&&i;)r(o)||(n=!1,i=!1),o=o.parentElement,o||(i=!1);return n}),He(this,"checkActualCssVisibleIncludeInherit",e=>this.checkPropertyUpToAllParentNodes(e,this.checkCssVisibleProperty)),He(this,"getSizeAboutClient",e=>{const{width:t,height:n,left:i,right:r,top:o,bottom:s}=e.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:t,height:n,left:i,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),He(this,"checkActualSize",()=>{const{width:e,height:t,clientMin:n}=this._clientSize;return this.checkSizeIsVisible(e,t,n)}),He(this,"elementFromPoint",(e,t)=>document.elementFromPoint?document.elementFromPoint(e,t):null),He(this,"checkCoverForAPoint",(e,t,n)=>{const i=this.elementFromPoint(e,t);return i!==null&&i!==n}),He(this,"getPointPositionList",()=>{const{width:e,height:t,left:n,top:i}=this._clientSize,r=e/6,o=t/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){const l=(n*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,u=(i*a+(d===0?.1:d===4?(o*d*a-1e5)/a:o*d)*a)/a;s.push({x:l,y:u})}return[...s]}),He(this,"checkElementCover",e=>this.getPointPositionList().map(t=>this.checkCoverForAPoint(t.x,t.y,e)).filter(t=>!!t).length>6),He(this,"checkSizeIsVisible",(e,t,n)=>(e>50||n/e<=10)&&(t>50||n/t<=10)),He(this,"checkSizeOfPartInClient",()=>{const{left:e,right:t,top:n,bottom:i,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize;let a,c,d,l;if(e<0)a=0;else{if(!(e<o))return!1;a=e}if(t<0)return!1;if(c=t<o?t:o,n<0)d=0;else{if(!(n<r))return!1;d=n}if(i<0)return!1;l=i<r?i:r;const u=c-a,h=l-d;return this.checkSizeIsVisible(u,h,s)}),He(this,"returnHiddenResult",e=>(this._clientSize=null,{visible:!1,reason:e})),He(this,"checkOneElementVisible",e=>{if(e instanceof HTMLElement){if(this.checkElementIsMountedOnDom(e)){if(this.checkActualCssVisibleIncludeInherit(e)){if(this._clientSize=this.getSizeAboutClient(e),this.checkElementCover(e))return this.returnHiddenResult(mc.COVERED);{const t=this.checkActualSize(),n=this.checkSizeOfPartInClient();return t&&!n?this.returnHiddenResult(mc.POSITION):t?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(mc.SIZE)}}return this.returnHiddenResult(mc.STYLE)}return this.returnHiddenResult(df.UNMOUNTED)}return this.returnHiddenResult(df.INVALID_HTML_ELEMENT)}),He(this,"checkElementIsMountedOnDom",e=>this.checkPropertyUpToAllParentNodes(e,t=>t.nodeName.toUpperCase()!=="HTML"?t.parentElement!==null:!!document.documentElement))}};function ME(e){return new TextEncoder().encode(e)}const $g=function(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n};function cP(e,t){let n="";return new Uint8Array(e).forEach(i=>{n+=i.toString(t).padStart(2,"0")}),n}const dP=async e=>{const t=function(o){const s=window.atob(o),a=new Uint8Array(new ArrayBuffer(s.length));for(let c=0;c<s.length;c+=1)a[c]=s.charCodeAt(c);return a}(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),n=await window.crypto.subtle.importKey("spki",t,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),i=ME(e),r=await window.crypto.subtle.encrypt({name:"RSA-OAEP"},n,i);return function(o){let s="";for(let a=0;a<o.length;a+=1)s+=String.fromCharCode(o[a]);return window.btoa(s)}(new Uint8Array(r))},lf=async e=>cP(await crypto.subtle.digest("SHA-256",ME(e)),16);let qe=class{constructor(){He(this,"_events",{}),He(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(n=>n.listener):[]}on(t,n){this._events[t]||(this._events[t]=[]);const i=this._events[t];this._indexOfListener(i,n)===-1&&i.push({listener:n,once:!1})}once(t,n){this._events[t]||(this._events[t]=[]);const i=this._events[t];this._indexOfListener(i,n)===-1&&i.push({listener:n,once:!0})}off(t,n){if(!this._events[t])return;const i=this._events[t],r=this._indexOfListener(i,n);r!==-1&&i.splice(r,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);const n=this._events[t].map(s=>s);for(var i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];for(let s=0;s<n.length;s+=1){const a=n[s];a.once&&this.off(t,a.listener),a.listener.apply(this,r||[])}}safeEmit(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];[...this._events[t]||[]].forEach(o=>{o.once&&this.off(t,o.listener);try{o.listener.apply(this,i)}catch(s){console.error("safeEmit event:".concat(t," error ").concat(s==null?void 0:s.toString()))}})}_indexOfListener(t,n){let i=t.length;for(;i--;)if(t[i].listener===n)return i;return-1}};function lP(){return!!kA()}function uP(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Promise((n,i)=>{const r=document.createElement("div");r.innerText="share screen",r.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");const o=document.createElement("div");o.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");const s=document.createElement("div");s.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",s.setAttribute("style","height: 12%;");const a=document.createElement("div");a.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");const c=document.createElement("div");c.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");const d=document.createElement("button");d.innerHTML="cancel",d.setAttribute("style","width: 85px;"),d.onclick=()=>{document.body.removeChild(h);const p=new Error("NotAllowedError");p.name="NotAllowedError",i(p)};let l=t;const u=document.createElement("div");if(t){const p=document.createElement("input");p.setAttribute("type","checkbox");const m=document.createElement("span");p.setAttribute("style","margin-right: 6px;"),m.innerText="Share audio",p.checked=l,p.onchange=()=>{l=p.checked},u.appendChild(p),u.appendChild(m)}c.appendChild(u),c.appendChild(d),o.appendChild(s),o.appendChild(a),o.appendChild(c);const h=document.createElement("div");h.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),h.appendChild(r),h.appendChild(o),document.body.appendChild(h),e.map(p=>{if(p.id){const m=document.createElement("div");m.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let E=p.thumbnail;try{const{width:g}=E.getSize();g>1920&&(E=E.resize({width:1920}))}catch(g){throw g&&g.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),g}m.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+E.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+(p.name.replace(/[\u00A0-\u9999<>\&]/g,function(g){return"&#"+g.charCodeAt(0)+";"})+"</span>"),m.onclick=()=>{document.body.removeChild(h),n({sourceId:p.id,audio:l})},a.appendChild(m)}})})}let oc=null;function kA(){if(oc)return oc;if(window.electron)return oc=window.electron;if(!window.require)return null;try{return oc=window.require("electron"),oc}catch{return null}}let an=function(e){return e.CREATE_CLIENT="createClient",e.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",e.SET_AREA="setArea",e.PRELOAD="PRELOAD",e.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",e.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",e.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",e.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",e.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",e.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",e.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",e.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",e.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",e.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",e.START_PROXY_SERVER="Client.startProxyServer",e.STOP_PROXY_SERVER="Client.stopProxyServer",e.SET_PROXY_SERVER="Client.setProxyServer",e.SET_TURN_SERVER="Client.setTurnServer",e.SET_CLIENT_ROLE="Client.setClientRole",e.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",e.ENABLE_DUAL_STREAM="Client.enableDualStream",e.DISABLE_DUAL_STREAM="Client.disableDualStream",e.JOIN="Client.join",e.LEAVE="Client.leave",e.PUBLISH="Client.publish",e.UNPUBLISH="Client.unpublish",e.SUBSCRIBE="Client.subscribe",e.MASS_SUBSCRIBE="Client.massSubscribe",e.MASS_UNSUBSCRIBE="Client.massUnsubscribe",e.UNSUBSCRIBE="Client.unsubscribe",e.RENEW_TOKEN="Client.renewToken",e.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",e.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",e.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",e.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",e.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",e.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",e.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",e.DATACHANNEL_FAILBACK="Client._datachannelFailback",e.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",e.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",e.START_LIVE_STREAMING="Client.startLiveStreaming",e.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",e.STOP_LIVE_STREAMING="Client.stopLiveStreaming",e.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",e.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",e.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",e.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",e.SET_CONFIG_DISTRIBUTE="_configDistribute",e.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",e.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",e.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",e.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",e.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",e.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",e.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",e.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",e.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",e.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",e.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",e.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",e.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",e.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",e.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",e.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",e.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",e.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",e.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",e.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",e.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",e.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",e.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",e.STREAM_TYPE_CHANGE="streamTypeChange",e.CONNECTION_STATE_CHANGE="connectionStateChange",e.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",e.IMAGE_MODERATION_UPLOAD="imageModerationUpload",e}({}),bt=function(e){return e.TRACER="tracer",e}({});function qg(e){return De(e.timeout,"config.timeout",0,1e5),De(e.timeoutFactor,"config.timeoutFactor",0,100,!1),De(e.maxRetryCount,"config.maxRetryConfig",0,1/0),De(e.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}function hP(e){return Xt(e.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),Xt(e.mode,"config.mode",["rtc","live","p2p"]),e.audioCodec!==void 0&&Xt(e.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),e.proxyServer!==void 0&&jt(e.proxyServer,"config.proxyServer",1,1e4),e.turnServer!==void 0&&MA(e.turnServer),e.httpRetryConfig!==void 0&&qg(e.httpRetryConfig),e.websocketRetryConfig!==void 0&&qg(e.websocketRetryConfig),!0}(function(e){return e[e.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",e[e.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",e[e.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",e})({});let fe=function(e){return e.LEAVE="LEAVE",e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.UID_BANNED="UID_BANNED",e.IP_BANNED="IP_BANNED",e.CHANNEL_BANNED="CHANNEL_BANNED",e.FALLBACK="FALLBACK",e.LICENSE_MISSING="LICENSE_MISSING",e.LICENSE_EXPIRED="LICENSE_EXPIRED",e.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",e.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",e.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",e.LICENSE_ILLEGAL="LICENSE_ILLEGAL",e.TOKEN_EXPIRE="TOKEN_EXPIRE",e}({});function Ba(e){if(!Array.isArray(e)||e.length<1)return!1;try{e.forEach(t=>{if(!t.urls)throw Error()})}catch{return!1}return!0}function MA(e){return jt(e.turnServerURL,"turnServerURL"),jt(e.username,"username"),jt(e.password,"password"),e.udpport&&De(e.udpport,"udpport",1,99999,!0),e.forceturn&&Fr(e.forceturn,"forceturn"),e.security&&Fr(e.security,"security"),e.tcpport&&De(e.tcpport,"tcpport",1,99999,!0),!0}function pP(e){return Xt(e,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"]),!0}function _P(e){return Xt(e,"role",["audience","host"]),!0}function fP(e){return Xt(e,"transport",["default","auto","relay","sd-rtn"]),!0}function Jg(e){return e.level!==void 0&&Xt(e.level,"level",[1,2,3]),e.delay!==void 0&&De(e.delay,"delay",0,3e3,!0),!0}let _e=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.MEDIA_RECONNECT_START="media-reconnect-start",e.MEDIA_RECONNECT_END="media-reconnect-end",e.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",e.USER_JOINED="user-joined",e.USER_LEAVED="user-left",e.USER_PUBLISHED="user-published",e.USER_UNPUBLISHED="user-unpublished",e.USER_INFO_UPDATED="user-info-updated",e.CLIENT_BANNED="client-banned",e.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",e.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",e.VOLUME_INDICATOR="volume-indicator",e.CRYPT_ERROR="crypt-error",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGED="stream-type-changed",e.STREAM_FALLBACK="stream-fallback",e.RECEIVE_METADATA="receive-metadata",e.STREAM_MESSAGE="stream-message",e.LIVE_STREAMING_ERROR="live-streaming-error",e.LIVE_STREAMING_WARNING="live-streaming-warning",e.INJECT_STREAM_STATUS="stream-inject-status",e.EXCEPTION="exception",e.ERROR="error",e.P2P_LOST="p2p_lost",e.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",e.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",e.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",e.PUBLISHED_USER_LIST="published-user-list",e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",e.CONTENT_INSPECT_ERROR="content-inspect-error",e.CONTENT_INSPECT_RESULT="content-inspect-result",e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",e}({}),Zt=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),Tn=function(e){return e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({}),es=function(e){return e.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",e.ONLINE="ONLINE",e.OFFLINE="OFFLINE",e}({});function Tt(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return e.getListeners(t).length===0?Promise.reject(new L(C.UNEXPECTED_ERROR,"can not emit promise")):new Promise((o,s)=>{e.emit(t,...i,o,s)})}function Ue(e,t){if(e.getListeners(t).length===0)return Promise.resolve();for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return Tt(e,t,...i)}function Gn(e,t){if(e.getListeners(t).length===0)return null;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return gs(e,t,...i)}function gs(e,t){let n=null,i=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(e.emit(t,...o,a=>{n=a},a=>{i=a}),i!==null)throw i;if(n===null)throw new L(C.UNEXPECTED_ERROR,"handler is not sync");return n}const it=new class extends qe{set networkState(e){this.emit(es.NETWORK_STATE_CHANGE,e,this._networkState),e===Tn.ONLINE?this.emit(es.ONLINE):e===Tn.OFFLINE&&(this.onlineWaiter=new Promise(t=>{this.once(es.ONLINE,()=>{this.onlineWaiter=void 0,t(Tn.ONLINE)})}),this.emit(es.OFFLINE)),this._networkState=e}get networkState(){return this._networkState}get isOnline(){return this._networkState===Tn.ONLINE}constructor(){super(),He(this,"_moduleName","network-indicator"),He(this,"_networkState",Tn.ONLINE),He(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Tn.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Tn.OFFLINE})}};function Ou(e,t){const n=e.indexOf(t);n!==-1&&e.splice(n,1)}function na(e){const t=[];return e.forEach(n=>{t.indexOf(n)===-1&&t.push(n)}),t}function hh(e){typeof Promise<"u"?Promise.resolve().then(e):setTimeout(e,0)}function xe(e){return JSON.parse(JSON.stringify(e))}function ts(e){try{return xe(e)}catch{return e}}const Xg={};function Mo(e,t){Xg[t]||(Xg[t]=!0,e())}function EP(){return typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1"}function ns(e){const t=window.atob(e),n=new Uint8Array(new ArrayBuffer(t.length));for(let i=0;i<t.length;i+=1)n[i]=t.charCodeAt(i);return n}function No(e){let t="";for(let n=0;n<e.length;n+=1)t+=String.fromCharCode(e[n]);return window.btoa(t)}function UA(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,n=new TextEncoder().encode(e);if(n.length>t)n=n.slice(0,t);else if(n.length<t){const i=new Uint8Array(t);i.set(n),n=i}return n}function Qg(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const i=t.reduce((s,a)=>s+a.length,0),r=new Uint8Array(new ArrayBuffer(i));let o=0;return t.forEach(s=>{r.set(s,o),o+=s.length}),r}function Tr(e){return window.TextEncoder?new TextEncoder().encode(e).length:e.length}function xA(e){let t=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&e.realFormData&&(e=e.realFormData),e.forEach(n=>{t+=typeof n=="string"?Tr(n):n.size}),t+138}function mP(e,t,n){const i=e[t];if(!i||typeof i!="string")return[e];e[t]="";const r=Tr(JSON.stringify(e));let o=0;const s=[];let a=0;for(let c=0;c<i.length;c++)a+=i.charCodeAt(c)<=127?1:3,a<=n-r||(s[s.length]=Y(Y({},e),{},{[t]:i.substring(o,c)}),o=c,a=i.charCodeAt(c)<=127?1:3);return o!==i.length-1&&(s[s.length]=Y(Y({},e),{},{[t]:i.substring(o)})),s}function gP(e){const t=new L(C.TIMEOUT,"timeout");return new Promise((n,i)=>{window.setTimeout(()=>i(t),e)})}function SP(e,t){return t===1/0?e:Promise.race([e,gP(t)])}function Pt(e){return new Promise(t=>{window.setTimeout(t,e)})}function et(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,t=arguments.length>1?arguments[1]:void 0;const n=Math.random().toString(16).substr(2,e).toLowerCase();return n.length===e?"".concat(t).concat(n):"".concat(t).concat(n)+et(e-n.length,"")}function TP(){return"process-".concat(et(8,""),"-").concat(et(4,""),"-").concat(et(4,""),"-").concat(et(4,""),"-").concat(et(12,""))}function kc(){return et(32,"").toUpperCase()}const ph=()=>{},Zg=new class{constructor(){He(this,"fnMap",new Map)}throttleByKey(e,t,n,i){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(t)){const a=this.fnMap.get(t);if(a.threshold!==n){a.fn(...a.args),clearTimeout(a.timer);const c=window.setTimeout(()=>{const d=this.fnMap.get(t);d&&d.fn(...d.args),this.fnMap.delete(t)},n);this.fnMap.set(t,{fn:e,threshold:n,timer:c,args:o,skipFn:i})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(t,Y(Y({},a),{},{fn:e,args:o,skipFn:i}))}else{const a=window.setTimeout(()=>{const c=this.fnMap.get(t);c&&c.fn(...c.args),this.fnMap.delete(t)},n);this.fnMap.set(t,{fn:e,threshold:n,timer:a,args:o,skipFn:i})}}},eS=Zg.throttleByKey.bind(Zg);function tS(e){return typeof e=="object"&&e!==null&&!(e instanceof RegExp)}function uf(e,t){if(!tS(e)||!tS(t)||Array.isArray(e)&&!Array.isArray(t)||!Array.isArray(e)&&Array.isArray(t))return t;if(Array.isArray(t)&&Array.isArray(e)){const n=[...e];for(let i=0;i<t.length;i++)n[i]=uf(e[i],t[i]);return n}{const n=Y({},e);for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(Object.prototype.hasOwnProperty.call(e,i)?n[i]=uf(e[i],t[i]):n[i]=t[i]);return n}}function RP(e){return e!==document.body&&document.body.contains(e)}function VA(e,t){let n=[0];if(t&&(n=new Array(t).fill(0)),e===0)return n;let i=0;for(;e>0&&(n[i]=255&e,e>>=8,i++,!t||i!==t););return n}function dp(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function FA(e){const t="0123456789abcdef";function n(I){let y,w="";for(y=0;y<=3;y++)w+=t.charAt(I>>8*y+4&15)+t.charAt(I>>8*y&15);return w}function i(I,y){const w=(65535&I)+(65535&y);return(I>>16)+(y>>16)+(w>>16)<<16|65535&w}function r(I,y,w,D,O,P){return i(function(x,U){return x<<U|x>>>32-U}(i(i(y,I),i(D,P)),O),w)}function o(I,y,w,D,O,P,x){return r(y&w|~y&D,I,y,O,P,x)}function s(I,y,w,D,O,P,x){return r(y&D|w&~D,I,y,O,P,x)}function a(I,y,w,D,O,P,x){return r(y^w^D,I,y,O,P,x)}function c(I,y,w,D,O,P,x){return r(w^(y|~D),I,y,O,P,x)}const d=function(I){let y;const w=1+(I.length+8>>6),D=new Array(16*w);for(y=0;y<16*w;y++)D[y]=0;for(y=0;y<I.length;y++)D[y>>2]|=I.charCodeAt(y)<<y%4*8;return D[y>>2]|=128<<y%4*8,D[16*w-2]=8*I.length,D}(e);let l,u,h,p,m,E=1732584193,g=-271733879,S=-1732584194,T=271733878;for(l=0;l<d.length;l+=16)u=E,h=g,p=S,m=T,E=o(E,g,S,T,d[l+0],7,-680876936),T=o(T,E,g,S,d[l+1],12,-389564586),S=o(S,T,E,g,d[l+2],17,606105819),g=o(g,S,T,E,d[l+3],22,-1044525330),E=o(E,g,S,T,d[l+4],7,-176418897),T=o(T,E,g,S,d[l+5],12,1200080426),S=o(S,T,E,g,d[l+6],17,-1473231341),g=o(g,S,T,E,d[l+7],22,-45705983),E=o(E,g,S,T,d[l+8],7,1770035416),T=o(T,E,g,S,d[l+9],12,-1958414417),S=o(S,T,E,g,d[l+10],17,-42063),g=o(g,S,T,E,d[l+11],22,-1990404162),E=o(E,g,S,T,d[l+12],7,1804603682),T=o(T,E,g,S,d[l+13],12,-40341101),S=o(S,T,E,g,d[l+14],17,-1502002290),g=o(g,S,T,E,d[l+15],22,1236535329),E=s(E,g,S,T,d[l+1],5,-165796510),T=s(T,E,g,S,d[l+6],9,-1069501632),S=s(S,T,E,g,d[l+11],14,643717713),g=s(g,S,T,E,d[l+0],20,-373897302),E=s(E,g,S,T,d[l+5],5,-701558691),T=s(T,E,g,S,d[l+10],9,38016083),S=s(S,T,E,g,d[l+15],14,-660478335),g=s(g,S,T,E,d[l+4],20,-405537848),E=s(E,g,S,T,d[l+9],5,568446438),T=s(T,E,g,S,d[l+14],9,-1019803690),S=s(S,T,E,g,d[l+3],14,-187363961),g=s(g,S,T,E,d[l+8],20,1163531501),E=s(E,g,S,T,d[l+13],5,-1444681467),T=s(T,E,g,S,d[l+2],9,-51403784),S=s(S,T,E,g,d[l+7],14,1735328473),g=s(g,S,T,E,d[l+12],20,-1926607734),E=a(E,g,S,T,d[l+5],4,-378558),T=a(T,E,g,S,d[l+8],11,-2022574463),S=a(S,T,E,g,d[l+11],16,1839030562),g=a(g,S,T,E,d[l+14],23,-35309556),E=a(E,g,S,T,d[l+1],4,-1530992060),T=a(T,E,g,S,d[l+4],11,1272893353),S=a(S,T,E,g,d[l+7],16,-155497632),g=a(g,S,T,E,d[l+10],23,-1094730640),E=a(E,g,S,T,d[l+13],4,681279174),T=a(T,E,g,S,d[l+0],11,-358537222),S=a(S,T,E,g,d[l+3],16,-722521979),g=a(g,S,T,E,d[l+6],23,76029189),E=a(E,g,S,T,d[l+9],4,-640364487),T=a(T,E,g,S,d[l+12],11,-421815835),S=a(S,T,E,g,d[l+15],16,530742520),g=a(g,S,T,E,d[l+2],23,-995338651),E=c(E,g,S,T,d[l+0],6,-198630844),T=c(T,E,g,S,d[l+7],10,1126891415),S=c(S,T,E,g,d[l+14],15,-1416354905),g=c(g,S,T,E,d[l+5],21,-57434055),E=c(E,g,S,T,d[l+12],6,1700485571),T=c(T,E,g,S,d[l+3],10,-1894986606),S=c(S,T,E,g,d[l+10],15,-1051523),g=c(g,S,T,E,d[l+1],21,-2054922799),E=c(E,g,S,T,d[l+8],6,1873313359),T=c(T,E,g,S,d[l+15],10,-30611744),S=c(S,T,E,g,d[l+6],15,-1560198380),g=c(g,S,T,E,d[l+13],21,1309151649),E=c(E,g,S,T,d[l+4],6,-145523070),T=c(T,E,g,S,d[l+11],10,-1120210379),S=c(S,T,E,g,d[l+2],15,718787259),g=c(g,S,T,E,d[l+9],21,-343485551),E=i(E,u),g=i(g,h),S=i(S,p),T=i(T,m);return n(E)+n(g)+n(S)+n(T)}function CP(e){const t=[];for(let n=0;n<e.length;n+=2)t.push(parseInt(e.slice(n,n+2),16));return Uint8Array.from(t)}let vP=1,rl=console,Bt=class{static setLogger(t){rl=t}constructor(t){He(this,"lockingPromise",Promise.resolve()),He(this,"locks",0),He(this,"name",""),He(this,"lockId",void 0),this.lockId=vP++,t&&(this.name=t),rl.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is created."))}get isLocked(){return this.locks>0}lock(t){let n;this.locks+=1,rl.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:""));const i=new Promise(o=>{n=()=>{this.locks-=1,rl.debug("[lock-".concat(this.name,"-").concat(this.lockId,"] is not locked, current queue ").concat(this.locks,". ").concat(typeof t=="string"?t:"")),o()}}),r=this.lockingPromise.then(()=>n);return this.lockingPromise=this.lockingPromise.then(()=>i),r}};function Aa(e,t){return function(n,i,r){const o=r.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return r.value=async function(){const s=this[t];if(!s)throw new Error("mutex property key ".concat(t," doesn't exist on ").concat(e));const a=await s.lock("From ".concat(e,".").concat(i));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return await o.apply(this,d)}finally{a()}},r}}const _t={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function _h(e,t){const n=Math.floor(t.timeout*Math.pow(t.timeoutFactor,e));return Math.min(t.maxRetryTimeout,n)}function wr(e,t,n,i){const r=Object.assign({},_t,i);let o=r.timeout;const s=async()=>{await function(d){return new Promise(l=>{window.setTimeout(l,d)})}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o)};let a=!1;const c=new Promise(async(d,l)=>{t=t||(()=>!1),n=n||(()=>!0);for(let u=0;u<r.maxRetryCount;u+=1){if(a)return l(new L(C.OPERATION_ABORTED));try{const h=await e();if(!t(h,u)||u+1===r.maxRetryCount)return d(h);await s()}catch(h){if(!n(h,u)||u+1===r.maxRetryCount)return l(h);await s()}}});return c.cancel=()=>a=!0,c}let UE=class{constructor(t){He(this,"input",[]),He(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){return this.input.length===0?0:this.input.reduce((t,n)=>t+n)/this.input.length}},ol,sl=0,lp=0;function hf(e,t,n,i){return new Promise((r,o)=>{t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),sl+=Tr(t.data)):n&&(t.data.size?sl+=t.data.size:t.data instanceof FormData?sl+=xA(t.data):sl+=Tr(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,Un.request(t).then(s=>{typeof s.data=="string"?lp+=Tr(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?lp+=s.data.byteLength:lp+=Tr(JSON.stringify(s.data)),i&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{Un.isCancel(s)?o(new L(C.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new L(C.NETWORK_TIMEOUT,s.message)):s.response?o(new L(C.NETWORK_RESPONSE_ERROR,s.response.status)):o(new L(C.NETWORK_ERROR,s.message))})})}async function IP(e,t){const n=new Blob([t.data],{type:"buffer"});return await hf(e,Y(Y({},t),{},{data:n,headers:{"Content-Type":"application/octet-stream"}}),!0)}function yP(e){if(e.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return e;const t=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-alpha\.([0-9]+)/);if(t&&t[1]&&t[2]){const i=t[1],r=t[2];return"".concat(i,".").concat(r)}const n=e.match(/([0-9]+\.[0-9]+\.[0-9]+)\-special\.([0-9]+)/);if(n&&n[1]&&n[2]){const i=n[1],r=n[2];return"".concat(i,".").concat(100*(Number(r)+1))}return"4.0.0.999"}const AP=()=>(ol||ol||(ol=(window.location.protocol.split(":")[0]||"").toUpperCase(),ol))==="HTTPS",nS=()=>window.isSecureContext!==void 0;function wP(){return new Promise(e=>{document.body?e():window.addEventListener("load",()=>e())})}const fi=yP("4.21.0"),xE=function(){try{return JSON.parse("true")===!0}catch{return!0}}(),NP=["CHINA","GLOBAL"];let zo=function(e){return e.Default="default",e.Auto="auto",e.Relay="relay",e.SdRtn="sd-rtn",e}({});const VE={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},BA="v4.21.0-0-g16fdae2c-dirty(6/3/2024, 2:55:18 PM)",Ct={PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:NP,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",ENABLE_EVENT_REPORT:!0,GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,UPLOAD_LOG:!1,NOT_REPORT_EVENT:[],SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",TURN_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,USE_PUB_RTX:!0,USE_SUB_RTX:!0,USE_XR:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:void 0,ENABLE_CC_FALLBACK:void 0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,DISABLE_FEC:void 0,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,ICE_RESTART_INTERVAL:1e4,NEW_ICE_RESTART:!1,ENABLE_USER_LICENSE_CHECK:!0,SIGNAL_CHANNEL:0,TRANSMITTER_INITIAL_RTT:30,TRANSMITTER_INITIAL_RTO:30,TRANSMITTER_MAX_BATCH_ACK_COUNT:2,TRANSMITTER_MAX_RTO:500,DATACHANNEL_COMPRESS:!1,FINGERPRINT:null,DC_JOIN_WITH_FAILBACK:5e3,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,AP_AREA:!0,SVC:[],ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,ENABLE_DATASTREAM_2:!1,DATASTREAM_MAX_RETRANSMITS:10,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_INSTANT_VIDEO:!1,ENABLE_NTP_REPORT:!1,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:VE,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,CUSTOM_ADAPTATION_DEFAULT_MODE:"",ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,ENABLE_PRELOAD:!0};function Fe(e,t,n){var i;Object.keys(Ct).includes(e)&&(!n&&Object.keys(fo).includes(e)||(Ct[e]=t,e==="ENABLE_VIDEO_SEI"&&t===!0&&(Ct.ENABLE_ENCODED_TRANSFORM=!0),e==="USE_NEW_NETWORK_CONFIG"&&t&&(i=!!t,Ct.USE_NEW_NETWORK_CONFIG=i,i&&(Ct.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],Ct.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],Ct.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],Ct.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],Ct.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",Ct.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",Ct.GATEWAY_DOMAINS=["edge.sd-rtn.com"]))))}function A(e){return Ct[e]}const fo={};var ue=function(e){return e.SET_SESSION_ID="SET_SESSION_ID",e.SET_P2P_ID="SET_P2P_id",e.SET_DC_ID="SET_DC_id",e.SET_UID="SET_UID",e.SET_INT_UID="SET_INT_UID",e.SET_PUB_ID="SET_PUB_ID",e.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",e.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",e.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",e.AVOID_JOIN_START="AVOID_JOIN_START",e.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",e.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",e.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",e.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",e.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",e.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",e.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",e.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",e.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",e.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",e.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",e.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",e.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",e.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",e.RESET_KEY_METRICS="RESET_KEY_METRICS",e.SET_USE_DATACHANNEL="SET_USE_DATACHANNEL",e.SET_USE_P2P="SET_USE_P2P",e.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",e}(ue||{});let OP=class{constructor(t,n,i,r){He(this,"state",void 0),this.state={codec:t,audioCodec:n,mode:i,clientId:r,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,avoidJoinStart:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useDataChannel:!1,useP2P:!1,p2pTransport:zo.Default}}dispatch(t){this.state=function(n,i){switch(i.type){case ue.SET_SESSION_ID:return Y(Y({},n),{},{sessionId:i.sessionId});case ue.SET_P2P_ID:return Y(Y({},n),{},{p2pId:i.p2pId});case ue.SET_UID:return Y(Y({},n),{},{uid:i.uid});case ue.SET_INT_UID:return Y(Y({},n),{},{intUid:i.intUid});case ue.SET_PUB_ID:return Y(Y({},n),{},{pubId:i.pubId});case ue.KEY_METRIC_CLIENT_CREATED:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{clientCreated:i.metric})});case ue.KEY_METRIC_JOIN_START:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{joinStart:i.metric})});case ue.AVOID_JOIN_START:return Y(Y({},n),{},{avoidJoinStart:i.avoidJoinStart});case ue.KEY_METRIC_JOIN_END:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{joinEnd:i.metric})});case ue.KEY_METRIC_REQUEST_AP_START:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{requestAPStart:i.metric})});case ue.KEY_METRIC_REQUEST_AP_END:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{requestAPEnd:i.metric})});case ue.KEY_METRIC_JOIN_GATEWAY_START:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{joinGatewayStart:i.metric})});case ue.KEY_METRIC_JOIN_GATEWAY_END:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{joinGatewayEnd:i.metric})});case ue.KEY_METRIC_PEER_CONNECTION_START:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{peerConnectionStart:i.metric})});case ue.KEY_METRIC_PEER_CONNECTION_END:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{peerConnectionEnd:i.metric})});case ue.KEY_METRIC_DESCRIPTION_START:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{descriptionStart:i.metric})});case ue.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{signalChannelOpen:i.metric})});case ue.KEY_METRIC_ICE_CONNECTION_END:return Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{iceConnectionEnd:i.metric})});case ue.KEY_METRIC_PUBLISH:{const r=n.keyMetrics.publish,o=r.findIndex(s=>s.trackId===i.metric.trackId);return o!==-1?(r[o]=Y(Y({},r[o]),i.metric),Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{publish:[...r]})})):Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{publish:[...n.keyMetrics.publish,i.metric]})})}case ue.KEY_METRIC_SUBSCRIBE:{const r=n.keyMetrics.subscribe,o=r.findIndex(s=>s.userId===i.metric.userId&&s.type===i.metric.type);return o!==-1?(r[o]=Y(Y({},r[o]),i.metric),Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{subscribe:[...r]})})):Y(Y({},n),{},{keyMetrics:Y(Y({},n.keyMetrics),{},{subscribe:[...n.keyMetrics.subscribe,i.metric]})})}case ue.SET_CLOUD_PROXY_SERVER_MODE:return n.cloudProxyServerMode=i.mode,n;case ue.RECORD_JOIN_CHANNEL_SERVICE:return typeof i.index!="number"?n.joinChannelServiceRecords=[...n.joinChannelServiceRecords,i.record]:(n.joinChannelServiceRecords[i.index]=Y(Y({},n.joinChannelServiceRecords[i.index]),i.record),n.joinChannelServiceRecords=[...n.joinChannelServiceRecords]),n;case ue.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return n.joinChannelServiceRecords=[],n;case ue.RESET_KEY_METRICS:return n.keyMetrics={publish:[],subscribe:[]},n;case ue.SET_USE_DATACHANNEL:return Y(Y({},n),{},{useDataChannel:i.val});case ue.SET_USE_P2P:return Y(Y({},n),{},{useP2P:i.val});case ue.SET_TRANSPORT_TYPE:return Y(Y({},n),{},{p2pTransport:i.val});default:return n}}(this.state,t)}set sessionId(t){this.dispatch({type:ue.SET_SESSION_ID,sessionId:t})}get sessionId(){return this.state.sessionId}set codec(t){this.state.codec=t}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(t){this.dispatch({type:ue.SET_P2P_ID,p2pId:t})}get p2pId(){return this.state.p2pId}set dcId(t){this.dispatch({type:ue.SET_DC_ID,dcId:t})}get dcId(){return this.state.dcId}set uid(t){this.dispatch({type:ue.SET_UID,uid:t})}get uid(){return this.state.uid}set intUid(t){this.dispatch({type:ue.SET_INT_UID,intUid:t})}get intUid(){return this.state.intUid}set pubId(t){this.dispatch({type:ue.SET_PUB_ID,pubId:t})}get pubId(){return this.state.pubId}set cloudProxyServerMode(t){this.dispatch({type:ue.SET_CLOUD_PROXY_SERVER_MODE,mode:t})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useDataChannel(t){this.dispatch({type:ue.SET_USE_DATACHANNEL,val:t})}get useDataChannel(){return this.state.useDataChannel}set useP2P(t){this.dispatch({type:ue.SET_USE_P2P,val:t})}get useP2P(){return this.state.useP2P}set p2pTransport(t){this.dispatch({type:ue.SET_TRANSPORT_TYPE,val:t})}get p2pTransport(){return this.state.p2pTransport}clientCreated(){this.dispatch({type:ue.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:ue.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:ue.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:ue.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:ue.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:ue.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:ue.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:ue.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:ue.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:ue.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:ue.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:ue.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(t,n,i,r){this.dispatch({type:ue.KEY_METRIC_PUBLISH,metric:Y(Y({trackId:t,type:n},i&&{publishStart:i}),r&&{publishEnd:r})})}subscribe(t,n,i,r,o,s,a){this.dispatch({type:ue.KEY_METRIC_SUBSCRIBE,metric:Y(Y(Y(Y(Y({userId:t,type:n},i&&{subscribeStart:i}),r&&{subscribeEnd:r}),o&&{firstFrame:o}),s&&{streamAdded:s}),a&&{firstDecoded:a})})}massSubscribe(t,n,i,r){t.forEach(o=>{this.dispatch({type:ue.KEY_METRIC_SUBSCRIBE,metric:Y(Y(Y({userId:o.userId,type:o.type},n&&{subscribeStart:n}),i&&{subscribeEnd:i}),r&&{firstFrame:r})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(t,n){t.service==="gateway"&&Array.isArray(t.urls)&&(t.urls=t.urls.map(i=>i.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof n!="number"?(this.dispatch({type:ue.RECORD_JOIN_CHANNEL_SERVICE,record:Y(Y({},t),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(n<0||n>=this.state.joinChannelServiceRecords.length||this.dispatch({type:ue.RECORD_JOIN_CHANNEL_SERVICE,record:t,index:n}),n)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:ue.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:ue.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}get avoidJoinStart(){return this.state.avoidJoinStart}set avoidJoinStart(t){this.dispatch({type:ue.AVOID_JOIN_START,avoidJoinStart:t})}},wa=function(e){return e.h264="h264",e.h265="h265",e.vp8="vp8",e.vp9="vp9",e.av1="av1",e}({});(function(e){return e.opus="opus",e.pcma="pcma",e.pcmu="pcmu",e.g722="g722",e})({});const GA=128,bP=96,jA=1e3,ha=10;let DP=0;async function PP(e,t,n){const i=Array.from(n).reduce((l,u)=>l+u,0),r={serverTs:0,seq:DP++,length:n.length,checkSum:i},o=new Uint8Array(VA(i,2)),s=new ArrayBuffer(ha),a=new DataView(s);a.setUint32(0,r.serverTs),a.setUint16(4,r.seq),a.setUint16(6,r.length),a.setUint16(8,r.checkSum);const c=16-n.length%16;n=Qg(n,new Uint8Array(c));const d=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:e,tagLength:GA,additionalData:o},t,n);return Qg(new Uint8Array(s),new Uint8Array(d))}async function LP(e,t,n){const i=n.subarray(0,ha),r=i.slice(8,ha),o=(r[0]<<8)+r[1],s=(i[6]<<8)+i[7],a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:e,tagLength:GA,additionalData:new Uint8Array(VA(o,2))},t,n.subarray(ha));return n=new Uint8Array(a).subarray(0,s)}async function kP(e,t,n){const i=await window.crypto.subtle.importKey("raw",t,"PBKDF2",!1,["deriveBits","deriveKey"]),r=e==="aes-128-gcm2"?128:256,o=await window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:jA,hash:"SHA-256",salt:n},i,r+bP);return new Uint8Array(o).subarray(r/8)}async function MP(e,t,n){const i=await window.crypto.subtle.importKey("raw",t,"PBKDF2",!1,["deriveBits","deriveKey"]),r=e==="aes-128-gcm2"?128:256;return await window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:jA,hash:"SHA-256",salt:n},i,{name:"AES-GCM",length:r},!0,["encrypt","decrypt"])}function iS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),n.push.apply(n,i)}return n}function se(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?iS(Object(n),!0).forEach(function(i){dt(e,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):iS(Object(n)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))})}return e}function dt(e,t,n){return(t=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,s||"default");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(o)}(i,"string");return typeof r=="symbol"?r:String(r)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const WA=new class extends qe{constructor(){super(...arguments),dt(this,"currentUploadLogID",0)}reportLogUploadError(e){const{errorRange:t}=e;t[t.length-1]&&t[t.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=t[t.length-1],this.emit("REPORT_LOG_UPLOAD",e))}};class UP{constructor(t){dt(this,"logger",void 0),dt(this,"prefixLists",[]),this.logger=t}debug(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.debug(...this.prefixLists,...n)}info(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.info(...this.prefixLists,...n)}warning(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.warning(...this.prefixLists,...n)}error(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];this.logger.error(...this.prefixLists,...n)}prefix(t){return this.prefixLists.push(t),this}popPrefix(){return this.prefixLists.pop(),this}}function up(){const e=new Date;return e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}function rS(){const e=new Date,t=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return t?(t==null?void 0:t[0])+":"+e.getUTCMilliseconds():e.toTimeString().split(" ")[0]+":"+e.getMilliseconds()}const di={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},al=Date.now(),sc=e=>{for(const t in di)if(Object.prototype.hasOwnProperty.call(di,t)&&di[t]===e)return t;return"DEFAULT"};class xP{constructor(){dt(this,"proxyServerURL",void 0),dt(this,"logLevel",di.DEBUG),dt(this,"uploadState","collecting"),dt(this,"uploadLogWaitingList",[]),dt(this,"uploadLogUploadingList",[]),dt(this,"uploadErrorCount",0),dt(this,"currentLogID",0),dt(this,"url",void 0),dt(this,"extLog",(t,n)=>{this.appendLogToWaitingList(t,...n)})}debug(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];const r=[di.DEBUG].concat(n);this.log.apply(this,r)}info(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];const r=[di.INFO].concat(n);this.log.apply(this,r)}warning(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];const r=[di.WARNING].concat(n);this.log.apply(this,r)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];const r=[di.ERROR].concat(n);this.log.apply(this,r)}upload(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];const r=[di.DEBUG].concat(n);this.uploadLog.apply(this,r)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){Fe("UPLOAD_LOG",!0)}disableLogUpload(){Fe("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new UP(this).prefix(t)}log(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];if(Date.now()-al<100)return void setTimeout(()=>{this.log(...n)},Date.now()-al);const r=Math.max(0,Math.min(4,n[0]));if(n[0]=up()+" Agora-SDK [".concat(sc(r),"]:"),this.appendLogToWaitingList(r,...n),r<this.logLevel)return;const o=up()+" %cAgora-SDK [".concat(sc(r),"]:");let s=[];if(!A("USE_NEW_LOG"))switch(r){case di.DEBUG:s=[o,"color: #64B5F6;"].concat(n.slice(1)),console.log.apply(console,s);break;case di.INFO:s=[o,"color: #1E88E5; font-weight: bold;"].concat(n.slice(1)),console.log.apply(console,s);break;case di.WARNING:s=[o,"color: #FB8C00; font-weight: bold;"].concat(n.slice(1)),console.warn.apply(console,s);break;case di.ERROR:s=[o,"color: #B00020; font-weight: bold;"].concat(n.slice(1)),console.error.apply(console,s)}}uploadLog(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];if(Date.now()-al<100)return void setTimeout(()=>{this.uploadLog(...n)},Date.now()-al);const r=Math.max(0,Math.min(4,n[0]));n[0]=up()+" Agora-SDK [".concat(sc(r),"]:"),this.appendLogToWaitingList(r,...n)}appendLogToWaitingList(t){if(!A("UPLOAD_LOG"))return;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];Array.isArray(i[0])?i[0][0]=rS()+" Agora-SDK [".concat(sc(t),"]:"):i[0]=rS()+" Agora-SDK [".concat(sc(t),"]:");let o="";i.forEach(s=>{typeof s=="object"&&(s=JSON.stringify(s)),o+="".concat(s," ")}),this.uploadLogWaitingList.push({payload_str:o,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}async uploadLogs(){const t=this.uploadLogUploadingList,n={sdk_version:fi,process_id:A("PROCESS_ID"),payload:JSON.stringify(t)};return wr(async()=>{const i=await Un.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(A("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(A("LOG_UPLOAD_SERVER"),"/upload/v1")),n,{responseType:"text"});if(i.data!=="OK"){const r=new Error("unexpected upload log response");throw r.response=i,r}},()=>(this.uploadLogUploadingList=[],!1),i=>{const r={status:-1,message:i.message,errorRange:t.map(o=>o.log_item_id)};return i.response?(r.status=i.response.status,r.data=i.response.data,r.headers=i.response.headers):i.request&&(r.status=i.request.status),WA.reportLogUploadError(r),!0},{timeout:A("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:A("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,A("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}}const f=new xP;(function(e){return e.FREE="free",e.UPLOADING="uploading",e})({});(function(e){return e[e.MISC=0]="MISC",e[e.INTERNAL_EVENT=1]="INTERNAL_EVENT",e[e.PUBLIC_EVENT=2]="PUBLIC_EVENT",e[e.WEB_EVENT=3]="WEB_EVENT",e[e.INTERNAL_API=4]="INTERNAL_API",e[e.WEB_API=5]="WEB_API",e[e.PUBLIC_API=6]="PUBLIC_API",e})({});function VP(e){return jt(e.reportId,"params.reportId",0,100,!1),jt(e.category,"params.category",0,100,!1),jt(e.event,"params.event",0,100,!1),jt(e.label,"params.label",0,100,!1),De(e.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}const FP={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0};let xt=function(e){return e.PUBLISH="publish",e.SUBSCRIBE="subscribe",e.WS_COMPRESSOR_INIT="ws_compressor_init",e.SESSION_INIT="session_init",e.JOIN_CHOOSE_SERVER="join_choose_server",e.REQ_USER_ACCOUNT="req_user_account",e.JOIN_GATEWAY="join_gateway",e.REJOIN_GATEWAY="rejoin_gateway",e.STREAM_SWITCH="stream_switch",e.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",e.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",e.FIRST_VIDEO_RECEIVED="first_video_received",e.FIRST_AUDIO_RECEIVED="first_audio_received",e.FIRST_VIDEO_DECODE="first_video_decode",e.FIRST_AUDIO_DECODE="first_audio_decode",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_UPDATE_STREAM="on_update_stream",e.ON_REMOVE_STREAM="on_remove_stream",e.USER_ANALYTICS="req_user_analytics",e.PC_STATS="pc_stats",e.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",e}({}),Qe=function(e){return e.SESSION="io.agora.pb.Wrtc.Session",e.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",e.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",e.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",e.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",e.PUBLISH="io.agora.pb.Wrtc.Publish",e.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",e.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",e.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",e.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",e.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",e.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",e.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",e.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",e.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",e.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",e.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",e.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",e.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",e.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",e.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",e.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",e.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",e.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",e.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",e.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",e.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",e.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",e.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",e.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",e.PC_STATS="io.agora.pb.Wrtc.PCStats",e.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",e}({});(function(e){return e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e})({});(function(e){return e[e.SESSION=26]="SESSION",e[e.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",e[e.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",e[e.JOIN_GATEWAY=28]="JOIN_GATEWAY",e[e.PUBLISH=30]="PUBLISH",e[e.SUBSCRIBE=29]="SUBSCRIBE",e[e.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",e[e.STREAM_SWITCH=32]="STREAM_SWITCH",e[e.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",e[e.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",e[e.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",e[e.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",e[e.API_INVOKE=41]="API_INVOKE",e[e.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",e[e.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",e[e.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",e[e.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",e[e.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",e[e.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",e[e.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",e[e.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",e[e.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",e[e.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",e[e.WORKER_EVENT=156]="WORKER_EVENT",e[e.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",e[e.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",e[e.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",e[e.USER_ANALYTICS=1e4]="USER_ANALYTICS",e[e.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",e})({});class bd{constructor(){dt(this,"baseInfoMap",new Map),dt(this,"proxyServer",void 0),dt(this,"eventUploadTimer",void 0),dt(this,"setSessionIdTimer",void 0),dt(this,"url",void 0),dt(this,"backupUrl",void 0),dt(this,"_appId",void 0),dt(this,"keyEventUploadPendingItems",[]),dt(this,"normalEventUploadPendingItems",[]),dt(this,"apiInvokeUploadPendingItems",[]),dt(this,"apiInvokeCount",0),dt(this,"ltsList",[]),dt(this,"lastSendNormalEventTime",Date.now()),dt(this,"customReportCounterTimer",void 0),dt(this,"customReportCount",0),dt(this,"extApiInvoke",async t=>{for(const n of t){const i=se(se({},n),{},{sid:null,invokeId:++this.apiInvokeCount,tag:bt.TRACER});this.sendApiInvoke(i)}}),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),A("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),A("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}adjustSessionStartTime(t){if(!this.baseInfoMap.has(t)&&!this.baseInfoMap.get(t))return void f.error("adjust session ".concat(t," start time, sid is not exist or info is undefined"));const n=this.baseInfoMap.get(t),i=Date.now(),r=n.startTime;n.startTime=i,f.debug("rewrite session ".concat(t," startTime: ").concat(i," , ").concat(i-r,"ms")),this.baseInfoMap.set(t,n)}setAppId(t){this._appId=t}reportApiInvoke(t,n,i){n.timeout=n.timeout||6e4,n.reportResult=n.reportResult===void 0||n.reportResult;const r=Date.now();this.apiInvokeCount+=1;const o=this.apiInvokeCount,s=()=>({tag:n.tag,invokeId:o,sid:t,name:n.name,apiInvokeTime:r,options:n.options,states:n.states||null}),a=!!A("SHOW_REPORT_INVOKER_LOG");a&&f.info("".concat(n.name," start"),n.options);let c=!1;Pt(n.timeout).then(()=>{c||(this.sendApiInvoke(se(se({},s()),{},{error:C.API_INVOKE_TIMEOUT,success:!1})),f.debug("".concat(n.name," timeout")))});const d=new L(C.UNEXPECTED_ERROR,"".concat(n.name,": this api invoke is end"));return{onSuccess:l=>{const u=()=>{if(c)throw d;return c=!0,this.sendApiInvoke(se(se({},s()),{},{success:!0},n.reportResult&&{result:l})),a&&f.info("".concat(n.name," onSuccess")),l};return i?eS(u,n.name+"Success",i,()=>c=!0):u()},onError:l=>{const u=()=>{if(c)throw l;c=!0,this.sendApiInvoke(se(se({},s()),{},{success:!1,error:l})),a&&f.info("".concat(n.name," onFailure"),l.toString())};return i?eS(u,n.name+"Error",i,()=>c=!0):u()}}}sessionInit(t,n){if(this.baseInfoMap.has(t))return;const i=Date.now(),r=this.createBaseInfo(t,i);r.cname=n.cname;const o=Object.assign({},{willUploadConsoleLog:A("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:xE?"global":"oversea",areas:A("AREAS")&&A("AREAS").join(",")},n.extend),{stringUid:s,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:l,clientRole:u}=n,h=Date.now(),p=se(se({},r),{},{eventType:xt.SESSION_INIT,appid:n.appid,browser:navigator.userAgent,buildFormat:n.buildFormat,build:BA,lts:h,elapse:h-i,extend:JSON.stringify(o),mode:n.mode,process:A("PROCESS_ID"),appType:A("APP_TYPE"),success:!0,version:fi,stringUid:s,channelProfile:a,channelMode:c,isABTestSuccess:d,lsid:l,clientType:20,clientRole:u,serviceId:A("PROCESS_ID"),extensionID:A("PLUGIN_INFO").join(",")||"",preload:n.preload?1:0});this.send({type:Qe.SESSION,data:p},!0)}joinChooseServer(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se({},r),{},{eventType:xt.JOIN_CHOOSE_SERVER,lts:o,eventElapse:n.elapse||o-n.lts,chooseServerAddr:n.csAddr,errorCode:n.ec,elapse:o-i.startTime,success:n.succ,chooseServerAddrList:JSON.stringify(n.serverList),uid:n.uid?parseInt(n.uid):null,cid:n.cid?parseInt(n.cid):null,chooseServerIp:n.csIp||"",opid:n.opid,unilbsServerIds:n.unilbsServerIds,extend:n.extend||void 0,isHttp3:n.isHttp3});this.send({type:Qe.JOIN_CHOOSE_SERVER,data:s},!0)}reqUserAccount(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se({},r),{},{eventType:xt.REQ_USER_ACCOUNT,lts:o,success:n.success,serverAddress:n.serverAddr,stringUid:n.stringUid,uid:n.uid,errorCode:n.errorCode,elapse:n.elapse||o-i.startTime,eventElapse:o-n.lts,extend:JSON.stringify(n.extend)});this.send({type:Qe.REQ_USER_ACCOUNT,data:s},!0)}joinGateway(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info;n.vid&&(r.vid=n.vid),r.uid=n.uid,r.cid=n.cid;const o=Date.now(),{firstSuccess:s,avoidJoinStartTime:a,isProxy:c,addr:d}=n,l=o-(s&&a?a:i.startTime),u=se(se({},r),{},{eventType:xt.JOIN_GATEWAY,lts:o,gatewayAddr:n.addr,success:n.succ,errorCode:n.ec,elapse:l,eventElapse:o-n.lts,firstSuccess:s,signalChannel:n.signalChannel}),h=u.success?1:0;if(n.succ&&(i.lastJoinSuccessTime=o),s)this.send({type:Qe.JOIN_GATEWAY,data:u},!0);else{let p;if(d)if(c){const E=d.match(/h=(\d{1,3}-){3}\d{1,3}/g),g=d.match(/p=[0-9]{1,6}/g);p={isSuccess:h,gatewayIp:E&&E.length?E[0].split("=")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split("=")[1]:"",isProxy:c?1:0}}else{const E=d.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),g=d.match(/(:|p=)[0-9]{1,6}/g);p={isSuccess:h,gatewayIp:E&&E.length?E[0].split("//")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split(/:|p=/g)[1]:"",isProxy:c?1:0}}else p={isSuccess:h,gatewayIp:"",port:"",isProxy:c?1:0};delete u.success,delete u.eventType,delete u.firstSuccess,u.vid=Number(u.vid);const m=Object.assign({},u,p,{eventType:xt.REJOIN_GATEWAY});this.send({type:Qe.RE_JOIN_GATEWAY,data:m},!0)}}joinChannelTimeout(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=Date.now(),o=se(se({},i.info),{},{lts:r,timeout:n,elapse:r-i.startTime});this.send({type:Qe.JOIN_CHANNEL_TIMEOUT,data:o},!0)}publish(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se({},r),{},{eventType:xt.PUBLISH,lts:o,eventElapse:n.eventElapse,elapse:o-i.startTime,success:n.succ,errorCode:n.ec,videoName:n.videoName,audioName:n.audioName,screenName:n.screenName,screenshare:n.screenshare,audio:n.audio,video:n.video,p2pid:n.p2pid,publishRequestid:n.publishRequestid});this.send({type:Qe.PUBLISH,data:s},!0)}subscribe(t,n,i){const r=this.baseInfoMap.get(t);if(!r)return;const o=r.info,s=Date.now(),a=se(se({},o),{},{eventType:xt.SUBSCRIBE,lts:s,eventElapse:n.eventElapse,elapse:s-r.startTime,success:n.succ,errorCode:n.ec,video:n.video,audio:n.audio,subscribeRequestid:n.subscribeRequestid,p2pid:n.p2pid},i&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof n.peerid=="string"?a.peerSuid=n.peerid:a.peer=n.peerid,this.send({type:Qe.SUBSCRIBE,data:a},!0)}wsCompressorInit(t){const n=[...this.baseInfoMap.keys()],i=n.length?n[0]:"UnableToGetSid",r=this.baseInfoMap.get(i);if(!r)return;const o=r.info,s=Date.now(),a=se(se({},o),{},{eventType:xt.WS_COMPRESSOR_INIT,lts:s,eventElapse:t.eventElapse,elapse:s-r.startTime,status:t.status?1:2});this.send({type:Qe.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(t,n,i,r){const o=this.baseInfoMap.get(t);if(!o)return;const s=o.info,a=Date.now(),c=se(se(se({},s),r),{},{elapse:a-o.startTime,eventType:n,lts:a,firstDecodeFrame:Math.max(a-o.startTime,0),apEnd:Math.max(r.apEnd-o.startTime,0),apStart:Math.max(r.apStart-o.startTime,0),joinGwEnd:Math.max(r.joinGwEnd-o.startTime,0),joinGwStart:Math.max(r.joinGwStart-o.startTime,0),pcEnd:Math.max(r.pcEnd-o.startTime,0),pcStart:Math.max(r.pcStart-o.startTime,0),subscriberEnd:Math.max(r.subscriberEnd-o.startTime,0),subscriberStart:Math.max(r.subscriberStart-o.startTime,0),videoAddNotify:Math.max(r.videoAddNotify-o.startTime,0)});this.send({type:i,data:c},!0)}firstRemoteFrame(t,n,i,r){const o=this.baseInfoMap.get(t);if(!o)return;const s=o.info,a=Date.now(),c=se(se(se({},s),r),{},{elapse:a-o.startTime,eventType:n,lts:a});this.send({type:i,data:c},!0)}pcStats(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se(se({},r),n),{},{vid:r.vid===void 0?0:Number(r.vid),elapse:o-i.startTime,eventType:xt.PC_STATS,lts:o});this.send({type:Qe.PC_STATS,data:s},!0)}updateRemoteRTPCapabilities(t,n){if(t){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se(se({},r),n),{},{vid:r.vid===void 0?0:Number(r.vid),eventType:xt.UPDATE_REMOTE_RTPCAPABILITIES,lts:o});this.send({type:Qe.UPDATE_REMOTE_RTPCAPABILITIES,data:s},!0)}}onGatewayStream(t,n,i,r){const o=this.baseInfoMap.get(t);if(!o)return;const s=o.info,a=Date.now(),c=se(se(se({},s),r),{},{eventType:n,lts:a});this.send({type:i,data:c},!0)}streamSwitch(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se({},r),{},{eventType:xt.STREAM_SWITCH,lts:o,isDual:n.isdual,elapse:o-i.startTime,success:n.succ});this.send({type:Qe.STREAM_SWITCH,data:s},!0)}requestProxyAppCenter(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se({},r),{},{eventType:xt.REQUEST_PROXY_APPCENTER,lts:o,eventElapse:o-n.lts,elapse:o-i.startTime,APAddr:n.APAddr,workerManagerList:n.workerManagerList,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:Qe.REQUEST_PROXY_APPCENTER,data:s},!0)}requestProxyWorkerManager(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se({},r),{},{eventType:xt.REQUEST_PROXY_WORKER_MANAGER,lts:o,eventElapse:o-n.lts,elapse:o-i.startTime,workerManagerAddr:n.workerManagerAddr,response:n.response,errorCode:n.ec,success:n.succ});this.send({type:Qe.REQUEST_PROXY_WORKER_MANAGER,data:s},!0)}setProxyServer(t){this.proxyServer=t,t?f.debug("reportProxyServerurl: ".concat(t)):f.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se({},r),{},{subscribeElapse:n.subscribeElapse,peer:n.peer,peerPublishDuration:Math.max(n.audioPublishDuration,n.videoPublishDuration),audiotag:n.audioPublishDuration>0?1:-1,videotag:n.videoPublishDuration>0?1:-1,lts:o,elapse:o-i.startTime,joinChannelSuccessElapse:o-(i.lastJoinSuccessTime||o),peerPublishDurationVideo:n.videoPublishDuration,peerPublishDurationAudio:n.audioPublishDuration});this.send({type:Qe.PEER_PUBLISH_STATUS,data:s},!0)}workerEvent(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se(se({},r),n),{},{elapse:o-i.startTime,lts:o,productType:"WebRTC"});mP(s,"payload",1300).forEach(a=>this.send({type:Qe.WORKER_EVENT,data:a},!0))}apworkerEvent(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se(se({},r),n),{},{elapse:o-i.startTime,lts:o});this.send({type:Qe.AP_WORKER_EVENT,data:s},!0)}joinWebProxyAP(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se(se({},r),n),{},{elapse:o-i.startTime,lts:o,extend:n.extend||void 0});this.send({type:Qe.JOIN_WEB_PROXY_AP,data:s},!0)}WebSocketQuit(t,n){const i=this.baseInfoMap.get(t);if(!i)return;const r=i.info,o=Date.now(),s=se(se(se({},r),n),{},{elapse:o-i.startTime,lts:o});this.send({type:Qe.WEBSOCKET_QUIT,data:s},!0)}async sendCustomReportMessage(t,n){if(this.customReportCount+=n.length,this.customReportCount>A("CUSTOM_REPORT_LIMIT"))throw new L(C.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));const i=Date.now(),r=n.map(o=>({type:Qe.USER_ANALYTICS,data:se(se({sid:t},o),{},{lts:i})}));try{A("NEW_REPORT_SERVER")?await this.postDataToStatsCollector2(r):await this.postDataToStatsCollector(r)}catch(o){throw f.error("send custom report message failed",o.toString()),new L(C.CUSTOM_REPORT_SEND_FAILED,o.message)}}sendApiInvoke(t){const n=A("NOT_REPORT_EVENT");if(t.tag&&n.includes&&n.includes(t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;const i=this.baseInfoMap.get(t.sid);if(!i)return this.apiInvokeUploadPendingItems.push(t),!1;const{cname:r,uid:o,cid:s}=i.info;let a;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof L){const{code:d,message:l}=t.error;a=d||l||t.error.toString()}else a=t.error.toString();const c={invokeId:t.invokeId,sid:t.sid,cname:r,cid:s,uid:o,lts:t.lts,success:t.success,elapse:t.lts-i.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?a:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:Qe.API_INVOKE,data:c},!1),!0}appendSessionId(){bd.__CLIENT_LIST__.forEach(t=>{if(t._sessionId){const n=this.apiInvokeUploadPendingItems.length;for(let i=0;i<n;i++){const r=this.apiInvokeUploadPendingItems.shift();r&&(r.sid=t._sessionId,this.sendApiInvoke(Object.assign({},r)))}}})}send(t,n){if(n)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>A("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,n){const i=[],r=[];for(;t.length;){const o=t.shift();i.length<20?i.push(o):r.push(o)}t.push(...r);for(const o of[...i])this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),this.ltsList.sort((s,a)=>s-a));return n||(this.lastSendNormalEventTime=Date.now()),A("ENABLE_EVENT_REPORT")&&i.length&&(A("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((o=>s=>{A("EVENT_REPORT_RETRY")&&(n?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>A("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-A("NORMAL_EVENT_QUEUE_CAPACITY")),f.warning("report: drop normal events"))))})(i)),t}async postDataToStatsCollector2(t){it.networkState===Tn.OFFLINE&&await Promise.race([it.onlineWaiter,Pt(2*_t.maxRetryTimeout)]);const n=o=>{let s=new Uint8Array;return o.forEach(a=>{const c=ME(JSON.stringify(a.data)),d=new ArrayBuffer(5),l=(h=>{let p=0;return Object.entries(Qe).forEach(m=>{let[E,g]=m;g===h.type&&(p=EventNameToID[E])}),p})(a),u=new DataView(d);u.setUint16(0,c.byteLength,!0),u.setUint8(2,255&l),u.setUint8(3,l>>>8&255),u.setUint8(4,l>>>16&255),s=$g(s,new Uint8Array(d)),s=$g(s,c)}),s},i="event";let r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(A("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(A("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let o=0;o<2;o+=1){o===1&&(r=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(A("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(A("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{await hf(r,{timeout:1e4,data:n(t),headers:se(se({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(s){if(o===1)throw s;continue}return}}async postDataToStatsCollector(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const i={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(s=>JSON.stringify(s)),vid:(s=>{const a=s&&s.data.sid&&this.baseInfoMap.get(s.data.sid);return a&&a.info.vid&&+a.info.vid||0})(t[0])};it.networkState===Tn.OFFLINE&&await Promise.race([it.onlineWaiter,Pt(2*_t.maxRetryTimeout)]);const r=n?"/events/proto-raws":"/events/messages";let o=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(A("EVENT_REPORT_DOMAIN"),"&p=").concat(A("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(A("EVENT_REPORT_DOMAIN"),":").concat(A("STATS_COLLECTOR_PORT")).concat(r));for(let s=0;s<2;s+=1){s===1&&(o=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(A("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(A("STATS_COLLECTOR_PORT"),"&d=").concat(r):"https://".concat(A("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(A("STATS_COLLECTOR_PORT")).concat(r)));try{n?await IP(o,{timeout:1e4,data:i}):await hf(o,{timeout:1e4,data:i})}catch(a){if(s===1)throw a;continue}return}}createBaseInfo(t,n){const i=Object.assign({},FP);return i.sid=t,this.baseInfoMap.set(t,{info:i,startTime:n}),i}reportResourceTiming(t,n){const i=performance.getEntriesByName(t),r=i[i.length-1];r&&this.reportApiInvoke(n,{name:"Client.resourceTiming",options:r,tag:bt.TRACER}).onSuccess()}}function Z(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(t,n,i){const r=i.value;if(typeof r=="function"){const o=e.className||t.__className__||(t.constructor.name==="AgoraRTCClient"?"Client":t.constructor.name);i.value=function(){for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];let d=a;if(e.argsMap)try{d=e.argsMap(this,...a)}catch(u){f.warning(u),d=[]}try{JSON.stringify(d)}catch{f.warning("arguments for method ".concat(o,".").concat(String(n)," not serializable for apiInvoke.")),d=[]}const l=(e.report||q).reportApiInvoke(this._sessionId||null,{name:"".concat(o,".").concat(String(n)),options:d,tag:bt.TRACER,reportResult:e.reportResult},e.throttleTime);try{const u=r.apply(this,a);return u instanceof Promise?u.then(h=>(l.onSuccess(e.reportResult&&h),h)).catch(h=>{throw l.onError(h),h}):(l.onSuccess(e.reportResult&&u),u)}catch(u){throw l.onError(u),u}}}return i}}dt(bd,"__CLIENT_LIST__",[]);const q=new bd;WA.on("REPORT_LOG_UPLOAD",e=>{e.networkState=it.networkState,q.reportApiInvoke(null,{name:"logUploadError",options:e,tag:bt.TRACER}).onSuccess("logUploadError")});/*! formdata-polyfill. MIT License. Jimmy W?rting <https://jimmy.warting.se/opensource> */(function(){var e;function t(_){var R=0;return function(){return R<_.length?{done:!1,value:_[R++]}:{done:!0}}}var n=typeof Object.defineProperties=="function"?Object.defineProperty:function(_,R,v){return _==Array.prototype||_==Object.prototype||(_[R]=v.value),_};function i(_){_=[typeof globalThis=="object"&&globalThis,_,typeof window=="object"&&window,typeof self=="object"&&self,typeof Qp=="object"&&Qp];for(var R=0;R<_.length;++R){var v=_[R];if(v&&v.Math==Math)return v}throw Error("Cannot find global object")}var r=i(this);function o(_,R){if(R)e:{var v=r;_=_.split(".");for(var b=0;b<_.length-1;b++){var K=_[b];if(!(K in v))break e;v=v[K]}_=_[_.length-1],b=v[_],R=R(b),R!=b&&R!=null&&n(v,_,{configurable:!0,writable:!0,value:R})}}o("Symbol",function(_){function R(re){if(this instanceof R)throw new TypeError("Symbol is not a constructor");return new v(b+(re||"")+"_"+K++,re)}function v(re,Ne){this.A=re,n(this,"description",{configurable:!0,writable:!0,value:Ne})}if(_)return _;v.prototype.toString=function(){return this.A};var b="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",K=0;return R}),o("Symbol.iterator",function(_){if(_)return _;_=Symbol("Symbol.iterator");for(var R="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),v=0;v<R.length;v++){var b=r[R[v]];typeof b=="function"&&typeof b.prototype[_]!="function"&&n(b.prototype,_,{configurable:!0,writable:!0,value:function(){return s(t(this))}})}return _});function s(_){return _={next:_},_[Symbol.iterator]=function(){return this},_}function a(_){var R=typeof Symbol<"u"&&Symbol.iterator&&_[Symbol.iterator];return R?R.call(_):{next:t(_)}}var c;if(typeof Object.setPrototypeOf=="function")c=Object.setPrototypeOf;else{var d;e:{var l={a:!0},u={};try{u.__proto__=l,d=u.a;break e}catch{}d=!1}c=d?function(_,R){if(_.__proto__=R,_.__proto__!==R)throw new TypeError(_+" is not extensible");return _}:null}var h=c;function p(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function m(_){if(_.m)throw new TypeError("Generator is already running");_.m=!0}p.prototype.o=function(_){this.v=_},p.prototype.s=function(_){this.l={D:_,F:!0},this.h=this.C||this.u},p.prototype.return=function(_){this.l={return:_},this.h=this.u};function E(_,R){return _.h=3,{value:R}}function g(_){this.g=new p,this.G=_}g.prototype.o=function(_){return m(this.g),this.g.j?T(this,this.g.j.next,_,this.g.o):(this.g.o(_),I(this))};function S(_,R){m(_.g);var v=_.g.j;return v?T(_,"return"in v?v.return:function(b){return{value:b,done:!0}},R,_.g.return):(_.g.return(R),I(_))}g.prototype.s=function(_){return m(this.g),this.g.j?T(this,this.g.j.throw,_,this.g.o):(this.g.s(_),I(this))};function T(_,R,v,b){try{var K=R.call(_.g.j,v);if(!(K instanceof Object))throw new TypeError("Iterator result "+K+" is not an object");if(!K.done)return _.g.m=!1,K;var re=K.value}catch(Ne){return _.g.j=null,_.g.s(Ne),I(_)}return _.g.j=null,b.call(_.g,re),I(_)}function I(_){for(;_.g.h;)try{var R=_.G(_.g);if(R)return _.g.m=!1,{value:R.value,done:!1}}catch(v){_.g.v=void 0,_.g.s(v)}if(_.g.m=!1,_.g.l){if(R=_.g.l,_.g.l=null,R.F)throw R.D;return{value:R.return,done:!0}}return{value:void 0,done:!0}}function y(_){this.next=function(R){return _.o(R)},this.throw=function(R){return _.s(R)},this.return=function(R){return S(_,R)},this[Symbol.iterator]=function(){return this}}function w(_,R){return R=new y(new g(R)),h&&_.prototype&&h(R,_.prototype),R}function D(_,R){_ instanceof String&&(_+="");var v=0,b=!1,K={next:function(){if(!b&&v<_.length){var re=v++;return{value:R(re,_[re]),done:!1}}return b=!0,{done:!0,value:void 0}}};return K[Symbol.iterator]=function(){return K},K}if(o("Array.prototype.entries",function(_){return _||function(){return D(this,function(R,v){return[R,v]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var O=function(_,R){for(var v=0;v<_.length;v++)R(_[v])},P=function(_){return _.replace(/\r?\n|\r/g,`\r
`)},x=function(_,R,v){return R instanceof Blob?(v=v!==void 0?v+"":typeof R.name=="string"?R.name:"blob",(R.name!==v||Object.prototype.toString.call(R)==="[object Blob]")&&(R=new File([R],v)),[String(_),R]):[String(_),String(R)]},U=function(_,R){if(_.length<R)throw new TypeError(R+" argument required, but only "+_.length+" present.")},J=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,Le=J.FormData,Be=J.XMLHttpRequest&&J.XMLHttpRequest.prototype.send,ot=J.Request&&J.fetch,vt=J.navigator&&J.navigator.sendBeacon,Lt=J.Element&&J.Element.prototype,mt=J.Symbol&&Symbol.toStringTag;mt&&(Blob.prototype[mt]||(Blob.prototype[mt]="Blob"),"File"in J&&!File.prototype[mt]&&(File.prototype[mt]="File"));try{new File([],"")}catch{J.File=function(R,v,b){return R=new Blob(R,b||{}),Object.defineProperties(R,{name:{value:v},lastModified:{value:+(b&&b.lastModified!==void 0?new Date(b.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),mt&&Object.defineProperty(R,mt,{value:"File"}),R}}var te=function(_){return _.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},le=function(_){this.i=[];var R=this;_&&O(_.elements,function(v){if(v.name&&!v.disabled&&v.type!=="submit"&&v.type!=="button"&&!v.matches("form fieldset[disabled] *"))if(v.type==="file"){var b=v.files&&v.files.length?v.files:[new File([],"",{type:"application/octet-stream"})];O(b,function(K){R.append(v.name,K)})}else v.type==="select-multiple"||v.type==="select-one"?O(v.options,function(K){!K.disabled&&K.selected&&R.append(v.name,K.value)}):v.type==="checkbox"||v.type==="radio"?v.checked&&R.append(v.name,v.value):(b=v.type==="textarea"?P(v.value):v.value,R.append(v.name,b))})};if(e=le.prototype,e.append=function(_,R,v){U(arguments,2),this.i.push(x(_,R,v))},e.delete=function(_){U(arguments,1);var R=[];_=String(_),O(this.i,function(v){v[0]!==_&&R.push(v)}),this.i=R},e.entries=function _(){var R,v=this;return w(_,function(b){if(b.h==1&&(R=0),b.h!=3)return R<v.i.length?b=E(b,v.i[R]):(b.h=0,b=void 0),b;R++,b.h=2})},e.forEach=function(_,R){U(arguments,1);for(var v=a(this),b=v.next();!b.done;b=v.next()){var K=a(b.value);b=K.next().value,K=K.next().value,_.call(R,K,b,this)}},e.get=function(_){U(arguments,1);var R=this.i;_=String(_);for(var v=0;v<R.length;v++)if(R[v][0]===_)return R[v][1];return null},e.getAll=function(_){U(arguments,1);var R=[];return _=String(_),O(this.i,function(v){v[0]===_&&R.push(v[1])}),R},e.has=function(_){U(arguments,1),_=String(_);for(var R=0;R<this.i.length;R++)if(this.i[R][0]===_)return!0;return!1},e.keys=function _(){var R=this,v,b,K,re,Ne;return w(_,function(kt){if(kt.h==1&&(v=a(R),b=v.next()),kt.h!=3){if(b.done){kt.h=0;return}return K=b.value,re=a(K),Ne=re.next().value,E(kt,Ne)}b=v.next(),kt.h=2})},e.set=function(_,R,v){U(arguments,2),_=String(_);var b=[],K=x(_,R,v),re=!0;O(this.i,function(Ne){Ne[0]===_?re&&(re=!b.push(K)):b.push(Ne)}),re&&b.push(K),this.i=b},e.values=function _(){var R=this,v,b,K,re,Ne;return w(_,function(kt){if(kt.h==1&&(v=a(R),b=v.next()),kt.h!=3){if(b.done){kt.h=0;return}return K=b.value,re=a(K),re.next(),Ne=re.next().value,E(kt,Ne)}b=v.next(),kt.h=2})},le.prototype._asNative=function(){for(var _=new Le,R=a(this),v=R.next();!v.done;v=R.next()){var b=a(v.value);v=b.next().value,b=b.next().value,_.append(v,b)}return _},le.prototype._blob=function(){var _="----formdata-polyfill-"+Math.random(),R=[],v="--"+_+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(b,K){return typeof b=="string"?R.push(v+te(P(K))+(`"\r
\r
`+P(b)+`\r
`)):R.push(v+te(P(K))+('"; filename="'+te(b.name)+`"\r
Content-Type: `+(b.type||"application/octet-stream")+`\r
\r
`),b,`\r
`)}),R.push("--"+_+"--"),new Blob(R,{type:"multipart/form-data; boundary="+_})},le.prototype[Symbol.iterator]=function(){return this.entries()},le.prototype.toString=function(){return"[object FormData]"},Lt&&!Lt.matches&&(Lt.matches=Lt.matchesSelector||Lt.mozMatchesSelector||Lt.msMatchesSelector||Lt.oMatchesSelector||Lt.webkitMatchesSelector||function(_){_=(this.document||this.ownerDocument).querySelectorAll(_);for(var R=_.length;0<=--R&&_.item(R)!==this;);return-1<R}),mt&&(le.prototype[mt]="FormData"),Be){var V=J.XMLHttpRequest.prototype.setRequestHeader;J.XMLHttpRequest.prototype.setRequestHeader=function(_,R){V.call(this,_,R),_.toLowerCase()==="content-type"&&(this.B=!0)},J.XMLHttpRequest.prototype.send=function(_){_ instanceof le?(_=_._blob(),this.B||this.setRequestHeader("Content-Type",_.type),Be.call(this,_)):Be.call(this,_)}}ot&&(J.fetch=function(_,R){return R&&R.body&&R.body instanceof le&&(R.body=R.body._blob()),ot.call(this,_,R)}),vt&&(J.navigator.sendBeacon=function(_,R){return R instanceof le&&(R=R._asNative()),vt.call(this,_,R)}),J.FormData=le}})();/*! pako 2.1.0 https://github.com/nodeca/pako @license (MIT AND Zlib) */const BP=4,oS=0,sS=1,GP=2;function Ga(e){let t=e.length;for(;--t>=0;)e[t]=0}const jP=0,HA=1,WP=2,HP=3,KP=258,FE=29,Dd=256,sd=Dd+1+FE,pa=30,BE=19,KA=2*sd+1,is=15,hp=16,zP=7,GE=256,zA=16,YA=17,$A=18,pf=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Kl=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),YP=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),qA=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),$P=512,xr=new Array((sd+2)*2);Ga(xr);const Mc=new Array(pa*2);Ga(Mc);const ad=new Array($P);Ga(ad);const cd=new Array(KP-HP+1);Ga(cd);const jE=new Array(FE);Ga(jE);const bu=new Array(pa);Ga(bu);function pp(e,t,n,i,r){this.static_tree=e,this.extra_bits=t,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=e&&e.length}let JA,XA,QA;function _p(e,t){this.dyn_tree=e,this.max_code=0,this.stat_desc=t}const ZA=e=>e<256?ad[e]:ad[256+(e>>>7)],dd=(e,t)=>{e.pending_buf[e.pending++]=t&255,e.pending_buf[e.pending++]=t>>>8&255},ti=(e,t,n)=>{e.bi_valid>hp-n?(e.bi_buf|=t<<e.bi_valid&65535,dd(e,e.bi_buf),e.bi_buf=t>>hp-e.bi_valid,e.bi_valid+=n-hp):(e.bi_buf|=t<<e.bi_valid&65535,e.bi_valid+=n)},mr=(e,t,n)=>{ti(e,n[t*2],n[t*2+1])},e0=(e,t)=>{let n=0;do n|=e&1,e>>>=1,n<<=1;while(--t>0);return n>>>1},qP=e=>{e.bi_valid===16?(dd(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=e.bi_buf&255,e.bi_buf>>=8,e.bi_valid-=8)},JP=(e,t)=>{const n=t.dyn_tree,i=t.max_code,r=t.stat_desc.static_tree,o=t.stat_desc.has_stree,s=t.stat_desc.extra_bits,a=t.stat_desc.extra_base,c=t.stat_desc.max_length;let d,l,u,h,p,m,E=0;for(h=0;h<=is;h++)e.bl_count[h]=0;for(n[e.heap[e.heap_max]*2+1]=0,d=e.heap_max+1;d<KA;d++)l=e.heap[d],h=n[n[l*2+1]*2+1]+1,h>c&&(h=c,E++),n[l*2+1]=h,!(l>i)&&(e.bl_count[h]++,p=0,l>=a&&(p=s[l-a]),m=n[l*2],e.opt_len+=m*(h+p),o&&(e.static_len+=m*(r[l*2+1]+p)));if(E!==0){do{for(h=c-1;e.bl_count[h]===0;)h--;e.bl_count[h]--,e.bl_count[h+1]+=2,e.bl_count[c]--,E-=2}while(E>0);for(h=c;h!==0;h--)for(l=e.bl_count[h];l!==0;)u=e.heap[--d],!(u>i)&&(n[u*2+1]!==h&&(e.opt_len+=(h-n[u*2+1])*n[u*2],n[u*2+1]=h),l--)}},t0=(e,t,n)=>{const i=new Array(is+1);let r=0,o,s;for(o=1;o<=is;o++)r=r+n[o-1]<<1,i[o]=r;for(s=0;s<=t;s++){let a=e[s*2+1];a!==0&&(e[s*2]=e0(i[a]++,a))}},XP=()=>{let e,t,n,i,r;const o=new Array(is+1);for(n=0,i=0;i<FE-1;i++)for(jE[i]=n,e=0;e<1<<pf[i];e++)cd[n++]=i;for(cd[n-1]=i,r=0,i=0;i<16;i++)for(bu[i]=r,e=0;e<1<<Kl[i];e++)ad[r++]=i;for(r>>=7;i<pa;i++)for(bu[i]=r<<7,e=0;e<1<<Kl[i]-7;e++)ad[256+r++]=i;for(t=0;t<=is;t++)o[t]=0;for(e=0;e<=143;)xr[e*2+1]=8,e++,o[8]++;for(;e<=255;)xr[e*2+1]=9,e++,o[9]++;for(;e<=279;)xr[e*2+1]=7,e++,o[7]++;for(;e<=287;)xr[e*2+1]=8,e++,o[8]++;for(t0(xr,sd+1,o),e=0;e<pa;e++)Mc[e*2+1]=5,Mc[e*2]=e0(e,5);JA=new pp(xr,pf,Dd+1,sd,is),XA=new pp(Mc,Kl,0,pa,is),QA=new pp(new Array(0),YP,0,BE,zP)},n0=e=>{let t;for(t=0;t<sd;t++)e.dyn_ltree[t*2]=0;for(t=0;t<pa;t++)e.dyn_dtree[t*2]=0;for(t=0;t<BE;t++)e.bl_tree[t*2]=0;e.dyn_ltree[GE*2]=1,e.opt_len=e.static_len=0,e.sym_next=e.matches=0},i0=e=>{e.bi_valid>8?dd(e,e.bi_buf):e.bi_valid>0&&(e.pending_buf[e.pending++]=e.bi_buf),e.bi_buf=0,e.bi_valid=0},aS=(e,t,n,i)=>{const r=t*2,o=n*2;return e[r]<e[o]||e[r]===e[o]&&i[t]<=i[n]},fp=(e,t,n)=>{const i=e.heap[n];let r=n<<1;for(;r<=e.heap_len&&(r<e.heap_len&&aS(t,e.heap[r+1],e.heap[r],e.depth)&&r++,!aS(t,i,e.heap[r],e.depth));)e.heap[n]=e.heap[r],n=r,r<<=1;e.heap[n]=i},cS=(e,t,n)=>{let i,r,o=0,s,a;if(e.sym_next!==0)do i=e.pending_buf[e.sym_buf+o++]&255,i+=(e.pending_buf[e.sym_buf+o++]&255)<<8,r=e.pending_buf[e.sym_buf+o++],i===0?mr(e,r,t):(s=cd[r],mr(e,s+Dd+1,t),a=pf[s],a!==0&&(r-=jE[s],ti(e,r,a)),i--,s=ZA(i),mr(e,s,n),a=Kl[s],a!==0&&(i-=bu[s],ti(e,i,a)));while(o<e.sym_next);mr(e,GE,t)},_f=(e,t)=>{const n=t.dyn_tree,i=t.stat_desc.static_tree,r=t.stat_desc.has_stree,o=t.stat_desc.elems;let s,a,c=-1,d;for(e.heap_len=0,e.heap_max=KA,s=0;s<o;s++)n[s*2]!==0?(e.heap[++e.heap_len]=c=s,e.depth[s]=0):n[s*2+1]=0;for(;e.heap_len<2;)d=e.heap[++e.heap_len]=c<2?++c:0,n[d*2]=1,e.depth[d]=0,e.opt_len--,r&&(e.static_len-=i[d*2+1]);for(t.max_code=c,s=e.heap_len>>1;s>=1;s--)fp(e,n,s);d=o;do s=e.heap[1],e.heap[1]=e.heap[e.heap_len--],fp(e,n,1),a=e.heap[1],e.heap[--e.heap_max]=s,e.heap[--e.heap_max]=a,n[d*2]=n[s*2]+n[a*2],e.depth[d]=(e.depth[s]>=e.depth[a]?e.depth[s]:e.depth[a])+1,n[s*2+1]=n[a*2+1]=d,e.heap[1]=d++,fp(e,n,1);while(e.heap_len>=2);e.heap[--e.heap_max]=e.heap[1],JP(e,t),t0(n,c,e.bl_count)},dS=(e,t,n)=>{let i,r=-1,o,s=t[0*2+1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),t[(n+1)*2+1]=65535,i=0;i<=n;i++)o=s,s=t[(i+1)*2+1],!(++a<c&&o===s)&&(a<d?e.bl_tree[o*2]+=a:o!==0?(o!==r&&e.bl_tree[o*2]++,e.bl_tree[zA*2]++):a<=10?e.bl_tree[YA*2]++:e.bl_tree[$A*2]++,a=0,r=o,s===0?(c=138,d=3):o===s?(c=6,d=3):(c=7,d=4))},lS=(e,t,n)=>{let i,r=-1,o,s=t[0*2+1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),i=0;i<=n;i++)if(o=s,s=t[(i+1)*2+1],!(++a<c&&o===s)){if(a<d)do mr(e,o,e.bl_tree);while(--a!==0);else o!==0?(o!==r&&(mr(e,o,e.bl_tree),a--),mr(e,zA,e.bl_tree),ti(e,a-3,2)):a<=10?(mr(e,YA,e.bl_tree),ti(e,a-3,3)):(mr(e,$A,e.bl_tree),ti(e,a-11,7));a=0,r=o,s===0?(c=138,d=3):o===s?(c=6,d=3):(c=7,d=4)}},QP=e=>{let t;for(dS(e,e.dyn_ltree,e.l_desc.max_code),dS(e,e.dyn_dtree,e.d_desc.max_code),_f(e,e.bl_desc),t=BE-1;t>=3&&e.bl_tree[qA[t]*2+1]===0;t--);return e.opt_len+=3*(t+1)+5+5+4,t},ZP=(e,t,n,i)=>{let r;for(ti(e,t-257,5),ti(e,n-1,5),ti(e,i-4,4),r=0;r<i;r++)ti(e,e.bl_tree[qA[r]*2+1],3);lS(e,e.dyn_ltree,t-1),lS(e,e.dyn_dtree,n-1)},eL=e=>{let t=4093624447,n;for(n=0;n<=31;n++,t>>>=1)if(t&1&&e.dyn_ltree[n*2]!==0)return oS;if(e.dyn_ltree[9*2]!==0||e.dyn_ltree[10*2]!==0||e.dyn_ltree[13*2]!==0)return sS;for(n=32;n<Dd;n++)if(e.dyn_ltree[n*2]!==0)return sS;return oS};let uS=!1;const tL=e=>{uS||(XP(),uS=!0),e.l_desc=new _p(e.dyn_ltree,JA),e.d_desc=new _p(e.dyn_dtree,XA),e.bl_desc=new _p(e.bl_tree,QA),e.bi_buf=0,e.bi_valid=0,n0(e)},r0=(e,t,n,i)=>{ti(e,(jP<<1)+(i?1:0),3),i0(e),dd(e,n),dd(e,~n),n&&e.pending_buf.set(e.window.subarray(t,t+n),e.pending),e.pending+=n},nL=e=>{ti(e,HA<<1,3),mr(e,GE,xr),qP(e)},iL=(e,t,n,i)=>{let r,o,s=0;e.level>0?(e.strm.data_type===GP&&(e.strm.data_type=eL(e)),_f(e,e.l_desc),_f(e,e.d_desc),s=QP(e),r=e.opt_len+3+7>>>3,o=e.static_len+3+7>>>3,o<=r&&(r=o)):r=o=n+5,n+4<=r&&t!==-1?r0(e,t,n,i):e.strategy===BP||o===r?(ti(e,(HA<<1)+(i?1:0),3),cS(e,xr,Mc)):(ti(e,(WP<<1)+(i?1:0),3),ZP(e,e.l_desc.max_code+1,e.d_desc.max_code+1,s+1),cS(e,e.dyn_ltree,e.dyn_dtree)),n0(e),i&&i0(e)},rL=(e,t,n)=>(e.pending_buf[e.sym_buf+e.sym_next++]=t,e.pending_buf[e.sym_buf+e.sym_next++]=t>>8,e.pending_buf[e.sym_buf+e.sym_next++]=n,t===0?e.dyn_ltree[n*2]++:(e.matches++,t--,e.dyn_ltree[(cd[n]+Dd+1)*2]++,e.dyn_dtree[ZA(t)*2]++),e.sym_next===e.sym_end);var oL=tL,sL=r0,aL=iL,cL=rL,dL=nL,lL={_tr_init:oL,_tr_stored_block:sL,_tr_flush_block:aL,_tr_tally:cL,_tr_align:dL};const uL=(e,t,n,i)=>{let r=e&65535|0,o=e>>>16&65535|0,s=0;for(;n!==0;){s=n>2e3?2e3:n,n-=s;do r=r+t[i++]|0,o=o+r|0;while(--s);r%=65521,o%=65521}return r|o<<16|0};var ld=uL;const hL=()=>{let e,t=[];for(var n=0;n<256;n++){e=n;for(var i=0;i<8;i++)e=e&1?3988292384^e>>>1:e>>>1;t[n]=e}return t},pL=new Uint32Array(hL()),_L=(e,t,n,i)=>{const r=pL,o=i+n;e^=-1;for(let s=i;s<o;s++)e=e>>>8^r[(e^t[s])&255];return e^-1};var gn=_L,Ss={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},ja={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:fL,_tr_stored_block:ff,_tr_flush_block:EL,_tr_tally:Oo,_tr_align:mL}=lL,{Z_NO_FLUSH:bo,Z_PARTIAL_FLUSH:gL,Z_FULL_FLUSH:SL,Z_FINISH:bi,Z_BLOCK:hS,Z_OK:yn,Z_STREAM_END:pS,Z_STREAM_ERROR:Ir,Z_DATA_ERROR:TL,Z_BUF_ERROR:Ep,Z_DEFAULT_COMPRESSION:RL,Z_FILTERED:CL,Z_HUFFMAN_ONLY:cl,Z_RLE:vL,Z_FIXED:IL,Z_DEFAULT_STRATEGY:yL,Z_UNKNOWN:AL,Z_DEFLATED:fh}=ja,wL=9,NL=15,OL=8,bL=29,DL=256,Ef=DL+1+bL,PL=30,LL=19,kL=2*Ef+1,ML=15,Ye=3,Eo=258,yr=Eo+Ye+1,UL=32,Na=42,WE=57,mf=69,gf=73,Sf=91,Tf=103,rs=113,gc=666,jn=1,Wa=2,Ts=3,Ha=4,xL=3,os=(e,t)=>(e.msg=Ss[t],t),_S=e=>e*2-(e>4?9:0),uo=e=>{let t=e.length;for(;--t>=0;)e[t]=0},VL=e=>{let t,n,i,r=e.w_size;t=e.hash_size,i=t;do n=e.head[--i],e.head[i]=n>=r?n-r:0;while(--t);t=r,i=t;do n=e.prev[--i],e.prev[i]=n>=r?n-r:0;while(--t)};let FL=(e,t,n)=>(t<<e.hash_shift^n)&e.hash_mask,Do=FL;const li=e=>{const t=e.state;let n=t.pending;n>e.avail_out&&(n=e.avail_out),n!==0&&(e.output.set(t.pending_buf.subarray(t.pending_out,t.pending_out+n),e.next_out),e.next_out+=n,t.pending_out+=n,e.total_out+=n,e.avail_out-=n,t.pending-=n,t.pending===0&&(t.pending_out=0))},Ei=(e,t)=>{EL(e,e.block_start>=0?e.block_start:-1,e.strstart-e.block_start,t),e.block_start=e.strstart,li(e.strm)},rt=(e,t)=>{e.pending_buf[e.pending++]=t},ac=(e,t)=>{e.pending_buf[e.pending++]=t>>>8&255,e.pending_buf[e.pending++]=t&255},Rf=(e,t,n,i)=>{let r=e.avail_in;return r>i&&(r=i),r===0?0:(e.avail_in-=r,t.set(e.input.subarray(e.next_in,e.next_in+r),n),e.state.wrap===1?e.adler=ld(e.adler,t,r,n):e.state.wrap===2&&(e.adler=gn(e.adler,t,r,n)),e.next_in+=r,e.total_in+=r,r)},o0=(e,t)=>{let n=e.max_chain_length,i=e.strstart,r,o,s=e.prev_length,a=e.nice_match;const c=e.strstart>e.w_size-yr?e.strstart-(e.w_size-yr):0,d=e.window,l=e.w_mask,u=e.prev,h=e.strstart+Eo;let p=d[i+s-1],m=d[i+s];e.prev_length>=e.good_match&&(n>>=2),a>e.lookahead&&(a=e.lookahead);do if(r=t,!(d[r+s]!==m||d[r+s-1]!==p||d[r]!==d[i]||d[++r]!==d[i+1])){i+=2,r++;do;while(d[++i]===d[++r]&&d[++i]===d[++r]&&d[++i]===d[++r]&&d[++i]===d[++r]&&d[++i]===d[++r]&&d[++i]===d[++r]&&d[++i]===d[++r]&&d[++i]===d[++r]&&i<h);if(o=Eo-(h-i),i=h-Eo,o>s){if(e.match_start=t,s=o,o>=a)break;p=d[i+s-1],m=d[i+s]}}while((t=u[t&l])>c&&--n!==0);return s<=e.lookahead?s:e.lookahead},Oa=e=>{const t=e.w_size;let n,i,r;do{if(i=e.window_size-e.lookahead-e.strstart,e.strstart>=t+(t-yr)&&(e.window.set(e.window.subarray(t,t+t-i),0),e.match_start-=t,e.strstart-=t,e.block_start-=t,e.insert>e.strstart&&(e.insert=e.strstart),VL(e),i+=t),e.strm.avail_in===0)break;if(n=Rf(e.strm,e.window,e.strstart+e.lookahead,i),e.lookahead+=n,e.lookahead+e.insert>=Ye)for(r=e.strstart-e.insert,e.ins_h=e.window[r],e.ins_h=Do(e,e.ins_h,e.window[r+1]);e.insert&&(e.ins_h=Do(e,e.ins_h,e.window[r+Ye-1]),e.prev[r&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=r,r++,e.insert--,!(e.lookahead+e.insert<Ye)););}while(e.lookahead<yr&&e.strm.avail_in!==0)},s0=(e,t)=>{let n=e.pending_buf_size-5>e.w_size?e.w_size:e.pending_buf_size-5,i,r,o,s=0,a=e.strm.avail_in;do{if(i=65535,o=e.bi_valid+42>>3,e.strm.avail_out<o||(o=e.strm.avail_out-o,r=e.strstart-e.block_start,i>r+e.strm.avail_in&&(i=r+e.strm.avail_in),i>o&&(i=o),i<n&&(i===0&&t!==bi||t===bo||i!==r+e.strm.avail_in)))break;s=t===bi&&i===r+e.strm.avail_in?1:0,ff(e,0,0,s),e.pending_buf[e.pending-4]=i,e.pending_buf[e.pending-3]=i>>8,e.pending_buf[e.pending-2]=~i,e.pending_buf[e.pending-1]=~i>>8,li(e.strm),r&&(r>i&&(r=i),e.strm.output.set(e.window.subarray(e.block_start,e.block_start+r),e.strm.next_out),e.strm.next_out+=r,e.strm.avail_out-=r,e.strm.total_out+=r,e.block_start+=r,i-=r),i&&(Rf(e.strm,e.strm.output,e.strm.next_out,i),e.strm.next_out+=i,e.strm.avail_out-=i,e.strm.total_out+=i)}while(s===0);return a-=e.strm.avail_in,a&&(a>=e.w_size?(e.matches=2,e.window.set(e.strm.input.subarray(e.strm.next_in-e.w_size,e.strm.next_in),0),e.strstart=e.w_size,e.insert=e.strstart):(e.window_size-e.strstart<=a&&(e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,e.insert>e.strstart&&(e.insert=e.strstart)),e.window.set(e.strm.input.subarray(e.strm.next_in-a,e.strm.next_in),e.strstart),e.strstart+=a,e.insert+=a>e.w_size-e.insert?e.w_size-e.insert:a),e.block_start=e.strstart),e.high_water<e.strstart&&(e.high_water=e.strstart),s?Ha:t!==bo&&t!==bi&&e.strm.avail_in===0&&e.strstart===e.block_start?Wa:(o=e.window_size-e.strstart,e.strm.avail_in>o&&e.block_start>=e.w_size&&(e.block_start-=e.w_size,e.strstart-=e.w_size,e.window.set(e.window.subarray(e.w_size,e.w_size+e.strstart),0),e.matches<2&&e.matches++,o+=e.w_size,e.insert>e.strstart&&(e.insert=e.strstart)),o>e.strm.avail_in&&(o=e.strm.avail_in),o&&(Rf(e.strm,e.window,e.strstart,o),e.strstart+=o,e.insert+=o>e.w_size-e.insert?e.w_size-e.insert:o),e.high_water<e.strstart&&(e.high_water=e.strstart),o=e.bi_valid+42>>3,o=e.pending_buf_size-o>65535?65535:e.pending_buf_size-o,n=o>e.w_size?e.w_size:o,r=e.strstart-e.block_start,(r>=n||(r||t===bi)&&t!==bo&&e.strm.avail_in===0&&r<=o)&&(i=r>o?o:r,s=t===bi&&e.strm.avail_in===0&&i===r?1:0,ff(e,e.block_start,i,s),e.block_start+=i,li(e.strm)),s?Ts:jn)},mp=(e,t)=>{let n,i;for(;;){if(e.lookahead<yr){if(Oa(e),e.lookahead<yr&&t===bo)return jn;if(e.lookahead===0)break}if(n=0,e.lookahead>=Ye&&(e.ins_h=Do(e,e.ins_h,e.window[e.strstart+Ye-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),n!==0&&e.strstart-n<=e.w_size-yr&&(e.match_length=o0(e,n)),e.match_length>=Ye)if(i=Oo(e,e.strstart-e.match_start,e.match_length-Ye),e.lookahead-=e.match_length,e.match_length<=e.max_lazy_match&&e.lookahead>=Ye){e.match_length--;do e.strstart++,e.ins_h=Do(e,e.ins_h,e.window[e.strstart+Ye-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart;while(--e.match_length!==0);e.strstart++}else e.strstart+=e.match_length,e.match_length=0,e.ins_h=e.window[e.strstart],e.ins_h=Do(e,e.ins_h,e.window[e.strstart+1]);else i=Oo(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++;if(i&&(Ei(e,!1),e.strm.avail_out===0))return jn}return e.insert=e.strstart<Ye-1?e.strstart:Ye-1,t===bi?(Ei(e,!0),e.strm.avail_out===0?Ts:Ha):e.sym_next&&(Ei(e,!1),e.strm.avail_out===0)?jn:Wa},Ls=(e,t)=>{let n,i,r;for(;;){if(e.lookahead<yr){if(Oa(e),e.lookahead<yr&&t===bo)return jn;if(e.lookahead===0)break}if(n=0,e.lookahead>=Ye&&(e.ins_h=Do(e,e.ins_h,e.window[e.strstart+Ye-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart),e.prev_length=e.match_length,e.prev_match=e.match_start,e.match_length=Ye-1,n!==0&&e.prev_length<e.max_lazy_match&&e.strstart-n<=e.w_size-yr&&(e.match_length=o0(e,n),e.match_length<=5&&(e.strategy===CL||e.match_length===Ye&&e.strstart-e.match_start>4096)&&(e.match_length=Ye-1)),e.prev_length>=Ye&&e.match_length<=e.prev_length){r=e.strstart+e.lookahead-Ye,i=Oo(e,e.strstart-1-e.prev_match,e.prev_length-Ye),e.lookahead-=e.prev_length-1,e.prev_length-=2;do++e.strstart<=r&&(e.ins_h=Do(e,e.ins_h,e.window[e.strstart+Ye-1]),n=e.prev[e.strstart&e.w_mask]=e.head[e.ins_h],e.head[e.ins_h]=e.strstart);while(--e.prev_length!==0);if(e.match_available=0,e.match_length=Ye-1,e.strstart++,i&&(Ei(e,!1),e.strm.avail_out===0))return jn}else if(e.match_available){if(i=Oo(e,0,e.window[e.strstart-1]),i&&Ei(e,!1),e.strstart++,e.lookahead--,e.strm.avail_out===0)return jn}else e.match_available=1,e.strstart++,e.lookahead--}return e.match_available&&(i=Oo(e,0,e.window[e.strstart-1]),e.match_available=0),e.insert=e.strstart<Ye-1?e.strstart:Ye-1,t===bi?(Ei(e,!0),e.strm.avail_out===0?Ts:Ha):e.sym_next&&(Ei(e,!1),e.strm.avail_out===0)?jn:Wa},BL=(e,t)=>{let n,i,r,o;const s=e.window;for(;;){if(e.lookahead<=Eo){if(Oa(e),e.lookahead<=Eo&&t===bo)return jn;if(e.lookahead===0)break}if(e.match_length=0,e.lookahead>=Ye&&e.strstart>0&&(r=e.strstart-1,i=s[r],i===s[++r]&&i===s[++r]&&i===s[++r])){o=e.strstart+Eo;do;while(i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&i===s[++r]&&r<o);e.match_length=Eo-(o-r),e.match_length>e.lookahead&&(e.match_length=e.lookahead)}if(e.match_length>=Ye?(n=Oo(e,1,e.match_length-Ye),e.lookahead-=e.match_length,e.strstart+=e.match_length,e.match_length=0):(n=Oo(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++),n&&(Ei(e,!1),e.strm.avail_out===0))return jn}return e.insert=0,t===bi?(Ei(e,!0),e.strm.avail_out===0?Ts:Ha):e.sym_next&&(Ei(e,!1),e.strm.avail_out===0)?jn:Wa},GL=(e,t)=>{let n;for(;;){if(e.lookahead===0&&(Oa(e),e.lookahead===0)){if(t===bo)return jn;break}if(e.match_length=0,n=Oo(e,0,e.window[e.strstart]),e.lookahead--,e.strstart++,n&&(Ei(e,!1),e.strm.avail_out===0))return jn}return e.insert=0,t===bi?(Ei(e,!0),e.strm.avail_out===0?Ts:Ha):e.sym_next&&(Ei(e,!1),e.strm.avail_out===0)?jn:Wa};function lr(e,t,n,i,r){this.good_length=e,this.max_lazy=t,this.nice_length=n,this.max_chain=i,this.func=r}const Sc=[new lr(0,0,0,0,s0),new lr(4,4,8,4,mp),new lr(4,5,16,8,mp),new lr(4,6,32,32,mp),new lr(4,4,16,16,Ls),new lr(8,16,32,32,Ls),new lr(8,16,128,128,Ls),new lr(8,32,128,256,Ls),new lr(32,128,258,1024,Ls),new lr(32,258,258,4096,Ls)],jL=e=>{e.window_size=2*e.w_size,uo(e.head),e.max_lazy_match=Sc[e.level].max_lazy,e.good_match=Sc[e.level].good_length,e.nice_match=Sc[e.level].nice_length,e.max_chain_length=Sc[e.level].max_chain,e.strstart=0,e.block_start=0,e.lookahead=0,e.insert=0,e.match_length=e.prev_length=Ye-1,e.match_available=0,e.ins_h=0};function WL(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=fh,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(kL*2),this.dyn_dtree=new Uint16Array((2*PL+1)*2),this.bl_tree=new Uint16Array((2*LL+1)*2),uo(this.dyn_ltree),uo(this.dyn_dtree),uo(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(ML+1),this.heap=new Uint16Array(2*Ef+1),uo(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*Ef+1),uo(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Pd=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.status!==Na&&t.status!==WE&&t.status!==mf&&t.status!==gf&&t.status!==Sf&&t.status!==Tf&&t.status!==rs&&t.status!==gc?1:0},a0=e=>{if(Pd(e))return os(e,Ir);e.total_in=e.total_out=0,e.data_type=AL;const t=e.state;return t.pending=0,t.pending_out=0,t.wrap<0&&(t.wrap=-t.wrap),t.status=t.wrap===2?WE:t.wrap?Na:rs,e.adler=t.wrap===2?0:1,t.last_flush=-2,fL(t),yn},c0=e=>{const t=a0(e);return t===yn&&jL(e.state),t},HL=(e,t)=>Pd(e)||e.state.wrap!==2?Ir:(e.state.gzhead=t,yn),d0=(e,t,n,i,r,o)=>{if(!e)return Ir;let s=1;if(t===RL&&(t=6),i<0?(s=0,i=-i):i>15&&(s=2,i-=16),r<1||r>wL||n!==fh||i<8||i>15||t<0||t>9||o<0||o>IL||i===8&&s!==1)return os(e,Ir);i===8&&(i=9);const a=new WL;return e.state=a,a.strm=e,a.status=Na,a.wrap=s,a.gzhead=null,a.w_bits=i,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+Ye-1)/Ye),a.window=new Uint8Array(a.w_size*2),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=a.lit_bufsize*4,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=(a.lit_bufsize-1)*3,a.level=t,a.strategy=o,a.method=n,c0(e)},KL=(e,t)=>d0(e,t,fh,NL,OL,yL),zL=(e,t)=>{if(Pd(e)||t>hS||t<0)return e?os(e,Ir):Ir;const n=e.state;if(!e.output||e.avail_in!==0&&!e.input||n.status===gc&&t!==bi)return os(e,e.avail_out===0?Ep:Ir);const i=n.last_flush;if(n.last_flush=t,n.pending!==0){if(li(e),e.avail_out===0)return n.last_flush=-1,yn}else if(e.avail_in===0&&_S(t)<=_S(i)&&t!==bi)return os(e,Ep);if(n.status===gc&&e.avail_in!==0)return os(e,Ep);if(n.status===Na&&n.wrap===0&&(n.status=rs),n.status===Na){let r=fh+(n.w_bits-8<<4)<<8,o=-1;if(n.strategy>=cl||n.level<2?o=0:n.level<6?o=1:n.level===6?o=2:o=3,r|=o<<6,n.strstart!==0&&(r|=UL),r+=31-r%31,ac(n,r),n.strstart!==0&&(ac(n,e.adler>>>16),ac(n,e.adler&65535)),e.adler=1,n.status=rs,li(e),n.pending!==0)return n.last_flush=-1,yn}if(n.status===WE){if(e.adler=0,rt(n,31),rt(n,139),rt(n,8),n.gzhead)rt(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),rt(n,n.gzhead.time&255),rt(n,n.gzhead.time>>8&255),rt(n,n.gzhead.time>>16&255),rt(n,n.gzhead.time>>24&255),rt(n,n.level===9?2:n.strategy>=cl||n.level<2?4:0),rt(n,n.gzhead.os&255),n.gzhead.extra&&n.gzhead.extra.length&&(rt(n,n.gzhead.extra.length&255),rt(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(e.adler=gn(e.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=mf;else if(rt(n,0),rt(n,0),rt(n,0),rt(n,0),rt(n,0),rt(n,n.level===9?2:n.strategy>=cl||n.level<2?4:0),rt(n,xL),n.status=rs,li(e),n.pending!==0)return n.last_flush=-1,yn}if(n.status===mf){if(n.gzhead.extra){let r=n.pending,o=(n.gzhead.extra.length&65535)-n.gzindex;for(;n.pending+o>n.pending_buf_size;){let a=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+a),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>r&&(e.adler=gn(e.adler,n.pending_buf,n.pending-r,r)),n.gzindex+=a,li(e),n.pending!==0)return n.last_flush=-1,yn;r=0,o-=a}let s=new Uint8Array(n.gzhead.extra);n.pending_buf.set(s.subarray(n.gzindex,n.gzindex+o),n.pending),n.pending+=o,n.gzhead.hcrc&&n.pending>r&&(e.adler=gn(e.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=gf}if(n.status===gf){if(n.gzhead.name){let r=n.pending,o;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>r&&(e.adler=gn(e.adler,n.pending_buf,n.pending-r,r)),li(e),n.pending!==0)return n.last_flush=-1,yn;r=0}n.gzindex<n.gzhead.name.length?o=n.gzhead.name.charCodeAt(n.gzindex++)&255:o=0,rt(n,o)}while(o!==0);n.gzhead.hcrc&&n.pending>r&&(e.adler=gn(e.adler,n.pending_buf,n.pending-r,r)),n.gzindex=0}n.status=Sf}if(n.status===Sf){if(n.gzhead.comment){let r=n.pending,o;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>r&&(e.adler=gn(e.adler,n.pending_buf,n.pending-r,r)),li(e),n.pending!==0)return n.last_flush=-1,yn;r=0}n.gzindex<n.gzhead.comment.length?o=n.gzhead.comment.charCodeAt(n.gzindex++)&255:o=0,rt(n,o)}while(o!==0);n.gzhead.hcrc&&n.pending>r&&(e.adler=gn(e.adler,n.pending_buf,n.pending-r,r))}n.status=Tf}if(n.status===Tf){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(li(e),n.pending!==0))return n.last_flush=-1,yn;rt(n,e.adler&255),rt(n,e.adler>>8&255),e.adler=0}if(n.status=rs,li(e),n.pending!==0)return n.last_flush=-1,yn}if(e.avail_in!==0||n.lookahead!==0||t!==bo&&n.status!==gc){let r=n.level===0?s0(n,t):n.strategy===cl?GL(n,t):n.strategy===vL?BL(n,t):Sc[n.level].func(n,t);if((r===Ts||r===Ha)&&(n.status=gc),r===jn||r===Ts)return e.avail_out===0&&(n.last_flush=-1),yn;if(r===Wa&&(t===gL?mL(n):t!==hS&&(ff(n,0,0,!1),t===SL&&(uo(n.head),n.lookahead===0&&(n.strstart=0,n.block_start=0,n.insert=0))),li(e),e.avail_out===0))return n.last_flush=-1,yn}return t!==bi?yn:n.wrap<=0?pS:(n.wrap===2?(rt(n,e.adler&255),rt(n,e.adler>>8&255),rt(n,e.adler>>16&255),rt(n,e.adler>>24&255),rt(n,e.total_in&255),rt(n,e.total_in>>8&255),rt(n,e.total_in>>16&255),rt(n,e.total_in>>24&255)):(ac(n,e.adler>>>16),ac(n,e.adler&65535)),li(e),n.wrap>0&&(n.wrap=-n.wrap),n.pending!==0?yn:pS)},YL=e=>{if(Pd(e))return Ir;const t=e.state.status;return e.state=null,t===rs?os(e,TL):yn},$L=(e,t)=>{let n=t.length;if(Pd(e))return Ir;const i=e.state,r=i.wrap;if(r===2||r===1&&i.status!==Na||i.lookahead)return Ir;if(r===1&&(e.adler=ld(e.adler,t,n,0)),i.wrap=0,n>=i.w_size){r===0&&(uo(i.head),i.strstart=0,i.block_start=0,i.insert=0);let c=new Uint8Array(i.w_size);c.set(t.subarray(n-i.w_size,n),0),t=c,n=i.w_size}const o=e.avail_in,s=e.next_in,a=e.input;for(e.avail_in=n,e.next_in=0,e.input=t,Oa(i);i.lookahead>=Ye;){let c=i.strstart,d=i.lookahead-(Ye-1);do i.ins_h=Do(i,i.ins_h,i.window[c+Ye-1]),i.prev[c&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=c,c++;while(--d);i.strstart=c,i.lookahead=Ye-1,Oa(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=Ye-1,i.match_available=0,e.next_in=s,e.input=a,e.avail_in=o,i.wrap=r,yn};var qL=KL,JL=d0,XL=c0,QL=a0,ZL=HL,ek=zL,tk=YL,nk=$L,ik="pako deflate (from Nodeca project)",Uc={deflateInit:qL,deflateInit2:JL,deflateReset:XL,deflateResetKeep:QL,deflateSetHeader:ZL,deflate:ek,deflateEnd:tk,deflateSetDictionary:nk,deflateInfo:ik};const rk=(e,t)=>Object.prototype.hasOwnProperty.call(e,t);var ok=function(e){const t=Array.prototype.slice.call(arguments,1);for(;t.length;){const n=t.shift();if(n){if(typeof n!="object")throw new TypeError(n+"must be non-object");for(const i in n)rk(n,i)&&(e[i]=n[i])}}return e},sk=e=>{let t=0;for(let i=0,r=e.length;i<r;i++)t+=e[i].length;const n=new Uint8Array(t);for(let i=0,r=0,o=e.length;i<o;i++){let s=e[i];n.set(s,r),r+=s.length}return n},Eh={assign:ok,flattenChunks:sk};let l0=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{l0=!1}const ud=new Uint8Array(256);for(let e=0;e<256;e++)ud[e]=e>=252?6:e>=248?5:e>=240?4:e>=224?3:e>=192?2:1;ud[254]=ud[254]=1;var ak=e=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(e);let t,n,i,r,o,s=e.length,a=0;for(r=0;r<s;r++)n=e.charCodeAt(r),(n&64512)===55296&&r+1<s&&(i=e.charCodeAt(r+1),(i&64512)===56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),a+=n<128?1:n<2048?2:n<65536?3:4;for(t=new Uint8Array(a),o=0,r=0;o<a;r++)n=e.charCodeAt(r),(n&64512)===55296&&r+1<s&&(i=e.charCodeAt(r+1),(i&64512)===56320&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?t[o++]=n:n<2048?(t[o++]=192|n>>>6,t[o++]=128|n&63):n<65536?(t[o++]=224|n>>>12,t[o++]=128|n>>>6&63,t[o++]=128|n&63):(t[o++]=240|n>>>18,t[o++]=128|n>>>12&63,t[o++]=128|n>>>6&63,t[o++]=128|n&63);return t};const ck=(e,t)=>{if(t<65534&&e.subarray&&l0)return String.fromCharCode.apply(null,e.length===t?e:e.subarray(0,t));let n="";for(let i=0;i<t;i++)n+=String.fromCharCode(e[i]);return n};var dk=(e,t)=>{const n=t||e.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(e.subarray(0,t));let i,r;const o=new Array(n*2);for(r=0,i=0;i<n;){let s=e[i++];if(s<128){o[r++]=s;continue}let a=ud[s];if(a>4){o[r++]=65533,i+=a-1;continue}for(s&=a===2?31:a===3?15:7;a>1&&i<n;)s=s<<6|e[i++]&63,a--;if(a>1){o[r++]=65533;continue}s<65536?o[r++]=s:(s-=65536,o[r++]=55296|s>>10&1023,o[r++]=56320|s&1023)}return ck(o,r)},lk=(e,t)=>{t=t||e.length,t>e.length&&(t=e.length);let n=t-1;for(;n>=0&&(e[n]&192)===128;)n--;return n<0||n===0?t:n+ud[e[n]]>t?n:t},hd={string2buf:ak,buf2string:dk,utf8border:lk};function uk(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0}var u0=uk;const h0=Object.prototype.toString,{Z_NO_FLUSH:hk,Z_SYNC_FLUSH:pk,Z_FULL_FLUSH:_k,Z_FINISH:fk,Z_OK:Du,Z_STREAM_END:Ek,Z_DEFAULT_COMPRESSION:mk,Z_DEFAULT_STRATEGY:gk,Z_DEFLATED:Sk}=ja;function Ld(e){this.options=Eh.assign({level:mk,method:Sk,chunkSize:16384,windowBits:15,memLevel:8,strategy:gk},e||{});let t=this.options;t.raw&&t.windowBits>0?t.windowBits=-t.windowBits:t.gzip&&t.windowBits>0&&t.windowBits<16&&(t.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u0,this.strm.avail_out=0;let n=Uc.deflateInit2(this.strm,t.level,t.method,t.windowBits,t.memLevel,t.strategy);if(n!==Du)throw new Error(Ss[n]);if(t.header&&Uc.deflateSetHeader(this.strm,t.header),t.dictionary){let i;if(typeof t.dictionary=="string"?i=hd.string2buf(t.dictionary):h0.call(t.dictionary)==="[object ArrayBuffer]"?i=new Uint8Array(t.dictionary):i=t.dictionary,n=Uc.deflateSetDictionary(this.strm,i),n!==Du)throw new Error(Ss[n]);this._dict_set=!0}}Ld.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize;let r,o;if(this.ended)return!1;for(t===~~t?o=t:o=t===!0?fk:hk,typeof e=="string"?n.input=hd.string2buf(e):h0.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){if(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(o===pk||o===_k)&&n.avail_out<=6){this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;continue}if(r=Uc.deflate(n,o),r===Ek)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=Uc.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===Du;if(n.avail_out===0){this.onData(n.output);continue}if(o>0&&n.next_out>0){this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;continue}if(n.avail_in===0)break}return!0};Ld.prototype.onData=function(e){this.chunks.push(e)};Ld.prototype.onEnd=function(e){e===Du&&(this.result=Eh.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function HE(e,t){const n=new Ld(t);if(n.push(e,!0),n.err)throw n.msg||Ss[n.err];return n.result}function Tk(e,t){return t=t||{},t.raw=!0,HE(e,t)}function Rk(e,t){return t=t||{},t.gzip=!0,HE(e,t)}var Ck=Ld,vk=HE,Ik=Tk,yk=Rk,Ak=ja,wk={Deflate:Ck,deflate:vk,deflateRaw:Ik,gzip:yk,constants:Ak};const dl=16209,Nk=16191;var Ok=function(t,n){let i,r,o,s,a,c,d,l,u,h,p,m,E,g,S,T,I,y,w,D,O,P,x,U;const J=t.state;i=t.next_in,x=t.input,r=i+(t.avail_in-5),o=t.next_out,U=t.output,s=o-(n-t.avail_out),a=o+(t.avail_out-257),c=J.dmax,d=J.wsize,l=J.whave,u=J.wnext,h=J.window,p=J.hold,m=J.bits,E=J.lencode,g=J.distcode,S=(1<<J.lenbits)-1,T=(1<<J.distbits)-1;e:do{m<15&&(p+=x[i++]<<m,m+=8,p+=x[i++]<<m,m+=8),I=E[p&S];t:for(;;){if(y=I>>>24,p>>>=y,m-=y,y=I>>>16&255,y===0)U[o++]=I&65535;else if(y&16){w=I&65535,y&=15,y&&(m<y&&(p+=x[i++]<<m,m+=8),w+=p&(1<<y)-1,p>>>=y,m-=y),m<15&&(p+=x[i++]<<m,m+=8,p+=x[i++]<<m,m+=8),I=g[p&T];n:for(;;){if(y=I>>>24,p>>>=y,m-=y,y=I>>>16&255,y&16){if(D=I&65535,y&=15,m<y&&(p+=x[i++]<<m,m+=8,m<y&&(p+=x[i++]<<m,m+=8)),D+=p&(1<<y)-1,D>c){t.msg="invalid distance too far back",J.mode=dl;break e}if(p>>>=y,m-=y,y=o-s,D>y){if(y=D-y,y>l&&J.sane){t.msg="invalid distance too far back",J.mode=dl;break e}if(O=0,P=h,u===0){if(O+=d-y,y<w){w-=y;do U[o++]=h[O++];while(--y);O=o-D,P=U}}else if(u<y){if(O+=d+u-y,y-=u,y<w){w-=y;do U[o++]=h[O++];while(--y);if(O=0,u<w){y=u,w-=y;do U[o++]=h[O++];while(--y);O=o-D,P=U}}}else if(O+=u-y,y<w){w-=y;do U[o++]=h[O++];while(--y);O=o-D,P=U}for(;w>2;)U[o++]=P[O++],U[o++]=P[O++],U[o++]=P[O++],w-=3;w&&(U[o++]=P[O++],w>1&&(U[o++]=P[O++]))}else{O=o-D;do U[o++]=U[O++],U[o++]=U[O++],U[o++]=U[O++],w-=3;while(w>2);w&&(U[o++]=U[O++],w>1&&(U[o++]=U[O++]))}}else if(y&64){t.msg="invalid distance code",J.mode=dl;break e}else{I=g[(I&65535)+(p&(1<<y)-1)];continue n}break}}else if(y&64)if(y&32){J.mode=Nk;break e}else{t.msg="invalid literal/length code",J.mode=dl;break e}else{I=E[(I&65535)+(p&(1<<y)-1)];continue t}break}}while(i<r&&o<a);w=m>>3,i-=w,m-=w<<3,p&=(1<<m)-1,t.next_in=i,t.next_out=o,t.avail_in=i<r?5+(r-i):5-(i-r),t.avail_out=o<a?257+(a-o):257-(o-a),J.hold=p,J.bits=m};const ks=15,fS=852,ES=592,mS=0,gp=1,gS=2,bk=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),Dk=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),Pk=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),Lk=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]),kk=(e,t,n,i,r,o,s,a)=>{const c=a.bits;let d=0,l=0,u=0,h=0,p=0,m=0,E=0,g=0,S=0,T=0,I,y,w,D,O,P=null,x;const U=new Uint16Array(ks+1),J=new Uint16Array(ks+1);let Le=null,Be,ot,vt;for(d=0;d<=ks;d++)U[d]=0;for(l=0;l<i;l++)U[t[n+l]]++;for(p=c,h=ks;h>=1&&U[h]===0;h--);if(p>h&&(p=h),h===0)return r[o++]=1<<24|64<<16|0,r[o++]=1<<24|64<<16|0,a.bits=1,0;for(u=1;u<h&&U[u]===0;u++);for(p<u&&(p=u),g=1,d=1;d<=ks;d++)if(g<<=1,g-=U[d],g<0)return-1;if(g>0&&(e===mS||h!==1))return-1;for(J[1]=0,d=1;d<ks;d++)J[d+1]=J[d]+U[d];for(l=0;l<i;l++)t[n+l]!==0&&(s[J[t[n+l]]++]=l);if(e===mS?(P=Le=s,x=20):e===gp?(P=bk,Le=Dk,x=257):(P=Pk,Le=Lk,x=0),T=0,l=0,d=u,O=o,m=p,E=0,w=-1,S=1<<p,D=S-1,e===gp&&S>fS||e===gS&&S>ES)return 1;for(;;){Be=d-E,s[l]+1<x?(ot=0,vt=s[l]):s[l]>=x?(ot=Le[s[l]-x],vt=P[s[l]-x]):(ot=32+64,vt=0),I=1<<d-E,y=1<<m,u=y;do y-=I,r[O+(T>>E)+y]=Be<<24|ot<<16|vt|0;while(y!==0);for(I=1<<d-1;T&I;)I>>=1;if(I!==0?(T&=I-1,T+=I):T=0,l++,--U[d]===0){if(d===h)break;d=t[n+s[l]]}if(d>p&&(T&D)!==w){for(E===0&&(E=p),O+=u,m=d-E,g=1<<m;m+E<h&&(g-=U[m+E],!(g<=0));)m++,g<<=1;if(S+=1<<m,e===gp&&S>fS||e===gS&&S>ES)return 1;w=T&D,r[w]=p<<24|m<<16|O-o|0}}return T!==0&&(r[O+T]=d-E<<24|64<<16|0),a.bits=p,0};var xc=kk;const Mk=0,p0=1,_0=2,{Z_FINISH:SS,Z_BLOCK:Uk,Z_TREES:ll,Z_OK:Rs,Z_STREAM_END:xk,Z_NEED_DICT:Vk,Z_STREAM_ERROR:Vi,Z_DATA_ERROR:f0,Z_MEM_ERROR:E0,Z_BUF_ERROR:Fk,Z_DEFLATED:TS}=ja,mh=16180,RS=16181,CS=16182,vS=16183,IS=16184,yS=16185,AS=16186,wS=16187,NS=16188,OS=16189,Pu=16190,Or=16191,Sp=16192,bS=16193,Tp=16194,DS=16195,PS=16196,LS=16197,kS=16198,ul=16199,hl=16200,MS=16201,US=16202,xS=16203,VS=16204,FS=16205,Rp=16206,BS=16207,GS=16208,Mt=16209,m0=16210,g0=16211,Bk=852,Gk=592,jk=15,Wk=jk,jS=e=>(e>>>24&255)+(e>>>8&65280)+((e&65280)<<8)+((e&255)<<24);function Hk(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Os=e=>{if(!e)return 1;const t=e.state;return!t||t.strm!==e||t.mode<mh||t.mode>g0?1:0},S0=e=>{if(Os(e))return Vi;const t=e.state;return e.total_in=e.total_out=t.total=0,e.msg="",t.wrap&&(e.adler=t.wrap&1),t.mode=mh,t.last=0,t.havedict=0,t.flags=-1,t.dmax=32768,t.head=null,t.hold=0,t.bits=0,t.lencode=t.lendyn=new Int32Array(Bk),t.distcode=t.distdyn=new Int32Array(Gk),t.sane=1,t.back=-1,Rs},T0=e=>{if(Os(e))return Vi;const t=e.state;return t.wsize=0,t.whave=0,t.wnext=0,S0(e)},R0=(e,t)=>{let n;if(Os(e))return Vi;const i=e.state;return t<0?(n=0,t=-t):(n=(t>>4)+5,t<48&&(t&=15)),t&&(t<8||t>15)?Vi:(i.window!==null&&i.wbits!==t&&(i.window=null),i.wrap=n,i.wbits=t,T0(e))},C0=(e,t)=>{if(!e)return Vi;const n=new Hk;e.state=n,n.strm=e,n.window=null,n.mode=mh;const i=R0(e,t);return i!==Rs&&(e.state=null),i},Kk=e=>C0(e,Wk);let WS=!0,Cp,vp;const zk=e=>{if(WS){Cp=new Int32Array(512),vp=new Int32Array(32);let t=0;for(;t<144;)e.lens[t++]=8;for(;t<256;)e.lens[t++]=9;for(;t<280;)e.lens[t++]=7;for(;t<288;)e.lens[t++]=8;for(xc(p0,e.lens,0,288,Cp,0,e.work,{bits:9}),t=0;t<32;)e.lens[t++]=5;xc(_0,e.lens,0,32,vp,0,e.work,{bits:5}),WS=!1}e.lencode=Cp,e.lenbits=9,e.distcode=vp,e.distbits=5},v0=(e,t,n,i)=>{let r;const o=e.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),i>=o.wsize?(o.window.set(t.subarray(n-o.wsize,n),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>i&&(r=i),o.window.set(t.subarray(n-i,n-i+r),o.wnext),i-=r,i?(o.window.set(t.subarray(n-i,n),0),o.wnext=i,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0},Yk=(e,t)=>{let n,i,r,o,s,a,c,d,l,u,h,p,m,E,g=0,S,T,I,y,w,D,O,P;const x=new Uint8Array(4);let U,J;const Le=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Os(e)||!e.output||!e.input&&e.avail_in!==0)return Vi;n=e.state,n.mode===Or&&(n.mode=Sp),s=e.next_out,r=e.output,c=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,d=n.hold,l=n.bits,u=a,h=c,P=Rs;e:for(;;)switch(n.mode){case mh:if(n.wrap===0){n.mode=Sp;break}for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(n.wrap&2&&d===35615){n.wbits===0&&(n.wbits=15),n.check=0,x[0]=d&255,x[1]=d>>>8&255,n.check=gn(n.check,x,2,0),d=0,l=0,n.mode=RS;break}if(n.head&&(n.head.done=!1),!(n.wrap&1)||(((d&255)<<8)+(d>>8))%31){e.msg="incorrect header check",n.mode=Mt;break}if((d&15)!==TS){e.msg="unknown compression method",n.mode=Mt;break}if(d>>>=4,l-=4,O=(d&15)+8,n.wbits===0&&(n.wbits=O),O>15||O>n.wbits){e.msg="invalid window size",n.mode=Mt;break}n.dmax=1<<n.wbits,n.flags=0,e.adler=n.check=1,n.mode=d&512?OS:Or,d=0,l=0;break;case RS:for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(n.flags=d,(n.flags&255)!==TS){e.msg="unknown compression method",n.mode=Mt;break}if(n.flags&57344){e.msg="unknown header flags set",n.mode=Mt;break}n.head&&(n.head.text=d>>8&1),n.flags&512&&n.wrap&4&&(x[0]=d&255,x[1]=d>>>8&255,n.check=gn(n.check,x,2,0)),d=0,l=0,n.mode=CS;case CS:for(;l<32;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}n.head&&(n.head.time=d),n.flags&512&&n.wrap&4&&(x[0]=d&255,x[1]=d>>>8&255,x[2]=d>>>16&255,x[3]=d>>>24&255,n.check=gn(n.check,x,4,0)),d=0,l=0,n.mode=vS;case vS:for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}n.head&&(n.head.xflags=d&255,n.head.os=d>>8),n.flags&512&&n.wrap&4&&(x[0]=d&255,x[1]=d>>>8&255,n.check=gn(n.check,x,2,0)),d=0,l=0,n.mode=IS;case IS:if(n.flags&1024){for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}n.length=d,n.head&&(n.head.extra_len=d),n.flags&512&&n.wrap&4&&(x[0]=d&255,x[1]=d>>>8&255,n.check=gn(n.check,x,2,0)),d=0,l=0}else n.head&&(n.head.extra=null);n.mode=yS;case yS:if(n.flags&1024&&(p=n.length,p>a&&(p=a),p&&(n.head&&(O=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(o,o+p),O)),n.flags&512&&n.wrap&4&&(n.check=gn(n.check,i,p,o)),a-=p,o+=p,n.length-=p),n.length))break e;n.length=0,n.mode=AS;case AS:if(n.flags&2048){if(a===0)break e;p=0;do O=i[o+p++],n.head&&O&&n.length<65536&&(n.head.name+=String.fromCharCode(O));while(O&&p<a);if(n.flags&512&&n.wrap&4&&(n.check=gn(n.check,i,p,o)),a-=p,o+=p,O)break e}else n.head&&(n.head.name=null);n.length=0,n.mode=wS;case wS:if(n.flags&4096){if(a===0)break e;p=0;do O=i[o+p++],n.head&&O&&n.length<65536&&(n.head.comment+=String.fromCharCode(O));while(O&&p<a);if(n.flags&512&&n.wrap&4&&(n.check=gn(n.check,i,p,o)),a-=p,o+=p,O)break e}else n.head&&(n.head.comment=null);n.mode=NS;case NS:if(n.flags&512){for(;l<16;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(n.wrap&4&&d!==(n.check&65535)){e.msg="header crc mismatch",n.mode=Mt;break}d=0,l=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),e.adler=n.check=0,n.mode=Or;break;case OS:for(;l<32;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}e.adler=n.check=jS(d),d=0,l=0,n.mode=Pu;case Pu:if(n.havedict===0)return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=d,n.bits=l,Vk;e.adler=n.check=1,n.mode=Or;case Or:if(t===Uk||t===ll)break e;case Sp:if(n.last){d>>>=l&7,l-=l&7,n.mode=Rp;break}for(;l<3;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}switch(n.last=d&1,d>>>=1,l-=1,d&3){case 0:n.mode=bS;break;case 1:if(zk(n),n.mode=ul,t===ll){d>>>=2,l-=2;break e}break;case 2:n.mode=PS;break;case 3:e.msg="invalid block type",n.mode=Mt}d>>>=2,l-=2;break;case bS:for(d>>>=l&7,l-=l&7;l<32;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if((d&65535)!==(d>>>16^65535)){e.msg="invalid stored block lengths",n.mode=Mt;break}if(n.length=d&65535,d=0,l=0,n.mode=Tp,t===ll)break e;case Tp:n.mode=DS;case DS:if(p=n.length,p){if(p>a&&(p=a),p>c&&(p=c),p===0)break e;r.set(i.subarray(o,o+p),s),a-=p,o+=p,c-=p,s+=p,n.length-=p;break}n.mode=Or;break;case PS:for(;l<14;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(n.nlen=(d&31)+257,d>>>=5,l-=5,n.ndist=(d&31)+1,d>>>=5,l-=5,n.ncode=(d&15)+4,d>>>=4,l-=4,n.nlen>286||n.ndist>30){e.msg="too many length or distance symbols",n.mode=Mt;break}n.have=0,n.mode=LS;case LS:for(;n.have<n.ncode;){for(;l<3;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}n.lens[Le[n.have++]]=d&7,d>>>=3,l-=3}for(;n.have<19;)n.lens[Le[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,U={bits:n.lenbits},P=xc(Mk,n.lens,0,19,n.lencode,0,n.work,U),n.lenbits=U.bits,P){e.msg="invalid code lengths set",n.mode=Mt;break}n.have=0,n.mode=kS;case kS:for(;n.have<n.nlen+n.ndist;){for(;g=n.lencode[d&(1<<n.lenbits)-1],S=g>>>24,T=g>>>16&255,I=g&65535,!(S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(I<16)d>>>=S,l-=S,n.lens[n.have++]=I;else{if(I===16){for(J=S+2;l<J;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(d>>>=S,l-=S,n.have===0){e.msg="invalid bit length repeat",n.mode=Mt;break}O=n.lens[n.have-1],p=3+(d&3),d>>>=2,l-=2}else if(I===17){for(J=S+3;l<J;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}d>>>=S,l-=S,O=0,p=3+(d&7),d>>>=3,l-=3}else{for(J=S+7;l<J;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}d>>>=S,l-=S,O=0,p=11+(d&127),d>>>=7,l-=7}if(n.have+p>n.nlen+n.ndist){e.msg="invalid bit length repeat",n.mode=Mt;break}for(;p--;)n.lens[n.have++]=O}}if(n.mode===Mt)break;if(n.lens[256]===0){e.msg="invalid code -- missing end-of-block",n.mode=Mt;break}if(n.lenbits=9,U={bits:n.lenbits},P=xc(p0,n.lens,0,n.nlen,n.lencode,0,n.work,U),n.lenbits=U.bits,P){e.msg="invalid literal/lengths set",n.mode=Mt;break}if(n.distbits=6,n.distcode=n.distdyn,U={bits:n.distbits},P=xc(_0,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,U),n.distbits=U.bits,P){e.msg="invalid distances set",n.mode=Mt;break}if(n.mode=ul,t===ll)break e;case ul:n.mode=hl;case hl:if(a>=6&&c>=258){e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=d,n.bits=l,Ok(e,h),s=e.next_out,r=e.output,c=e.avail_out,o=e.next_in,i=e.input,a=e.avail_in,d=n.hold,l=n.bits,n.mode===Or&&(n.back=-1);break}for(n.back=0;g=n.lencode[d&(1<<n.lenbits)-1],S=g>>>24,T=g>>>16&255,I=g&65535,!(S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(T&&!(T&240)){for(y=S,w=T,D=I;g=n.lencode[D+((d&(1<<y+w)-1)>>y)],S=g>>>24,T=g>>>16&255,I=g&65535,!(y+S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}d>>>=y,l-=y,n.back+=y}if(d>>>=S,l-=S,n.back+=S,n.length=I,T===0){n.mode=FS;break}if(T&32){n.back=-1,n.mode=Or;break}if(T&64){e.msg="invalid literal/length code",n.mode=Mt;break}n.extra=T&15,n.mode=MS;case MS:if(n.extra){for(J=n.extra;l<J;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}n.length+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=US;case US:for(;g=n.distcode[d&(1<<n.distbits)-1],S=g>>>24,T=g>>>16&255,I=g&65535,!(S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(!(T&240)){for(y=S,w=T,D=I;g=n.distcode[D+((d&(1<<y+w)-1)>>y)],S=g>>>24,T=g>>>16&255,I=g&65535,!(y+S<=l);){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}d>>>=y,l-=y,n.back+=y}if(d>>>=S,l-=S,n.back+=S,T&64){e.msg="invalid distance code",n.mode=Mt;break}n.offset=I,n.extra=T&15,n.mode=xS;case xS:if(n.extra){for(J=n.extra;l<J;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}n.offset+=d&(1<<n.extra)-1,d>>>=n.extra,l-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){e.msg="invalid distance too far back",n.mode=Mt;break}n.mode=VS;case VS:if(c===0)break e;if(p=h-c,n.offset>p){if(p=n.offset-p,p>n.whave&&n.sane){e.msg="invalid distance too far back",n.mode=Mt;break}p>n.wnext?(p-=n.wnext,m=n.wsize-p):m=n.wnext-p,p>n.length&&(p=n.length),E=n.window}else E=r,m=s-n.offset,p=n.length;p>c&&(p=c),c-=p,n.length-=p;do r[s++]=E[m++];while(--p);n.length===0&&(n.mode=hl);break;case FS:if(c===0)break e;r[s++]=n.length,c--,n.mode=hl;break;case Rp:if(n.wrap){for(;l<32;){if(a===0)break e;a--,d|=i[o++]<<l,l+=8}if(h-=c,e.total_out+=h,n.total+=h,n.wrap&4&&h&&(e.adler=n.check=n.flags?gn(n.check,r,h,s-h):ld(n.check,r,h,s-h)),h=c,n.wrap&4&&(n.flags?d:jS(d))!==n.check){e.msg="incorrect data check",n.mode=Mt;break}d=0,l=0}n.mode=BS;case BS:if(n.wrap&&n.flags){for(;l<32;){if(a===0)break e;a--,d+=i[o++]<<l,l+=8}if(n.wrap&4&&d!==(n.total&4294967295)){e.msg="incorrect length check",n.mode=Mt;break}d=0,l=0}n.mode=GS;case GS:P=xk;break e;case Mt:P=f0;break e;case m0:return E0;case g0:default:return Vi}return e.next_out=s,e.avail_out=c,e.next_in=o,e.avail_in=a,n.hold=d,n.bits=l,(n.wsize||h!==e.avail_out&&n.mode<Mt&&(n.mode<Rp||t!==SS))&&v0(e,e.output,e.next_out,h-e.avail_out),u-=e.avail_in,h-=e.avail_out,e.total_in+=u,e.total_out+=h,n.total+=h,n.wrap&4&&h&&(e.adler=n.check=n.flags?gn(n.check,r,h,e.next_out-h):ld(n.check,r,h,e.next_out-h)),e.data_type=n.bits+(n.last?64:0)+(n.mode===Or?128:0)+(n.mode===ul||n.mode===Tp?256:0),(u===0&&h===0||t===SS)&&P===Rs&&(P=Fk),P},$k=e=>{if(Os(e))return Vi;let t=e.state;return t.window&&(t.window=null),e.state=null,Rs},qk=(e,t)=>{if(Os(e))return Vi;const n=e.state;return n.wrap&2?(n.head=t,t.done=!1,Rs):Vi},Jk=(e,t)=>{const n=t.length;let i,r,o;return Os(e)||(i=e.state,i.wrap!==0&&i.mode!==Pu)?Vi:i.mode===Pu&&(r=1,r=ld(r,t,n,0),r!==i.check)?f0:(o=v0(e,t,n,n),o?(i.mode=m0,E0):(i.havedict=1,Rs))};var Xk=T0,Qk=R0,Zk=S0,e1=Kk,t1=C0,n1=Yk,i1=$k,r1=qk,o1=Jk,s1="pako inflate (from Nodeca project)",Vr={inflateReset:Xk,inflateReset2:Qk,inflateResetKeep:Zk,inflateInit:e1,inflateInit2:t1,inflate:n1,inflateEnd:i1,inflateGetHeader:r1,inflateSetDictionary:o1,inflateInfo:s1};function a1(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1}var c1=a1;const I0=Object.prototype.toString,{Z_NO_FLUSH:d1,Z_FINISH:l1,Z_OK:pd,Z_STREAM_END:Ip,Z_NEED_DICT:yp,Z_STREAM_ERROR:u1,Z_DATA_ERROR:HS,Z_MEM_ERROR:h1}=ja;function kd(e){this.options=Eh.assign({chunkSize:1024*64,windowBits:15,to:""},e||{});const t=this.options;t.raw&&t.windowBits>=0&&t.windowBits<16&&(t.windowBits=-t.windowBits,t.windowBits===0&&(t.windowBits=-15)),t.windowBits>=0&&t.windowBits<16&&!(e&&e.windowBits)&&(t.windowBits+=32),t.windowBits>15&&t.windowBits<48&&(t.windowBits&15||(t.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new u0,this.strm.avail_out=0;let n=Vr.inflateInit2(this.strm,t.windowBits);if(n!==pd)throw new Error(Ss[n]);if(this.header=new c1,Vr.inflateGetHeader(this.strm,this.header),t.dictionary&&(typeof t.dictionary=="string"?t.dictionary=hd.string2buf(t.dictionary):I0.call(t.dictionary)==="[object ArrayBuffer]"&&(t.dictionary=new Uint8Array(t.dictionary)),t.raw&&(n=Vr.inflateSetDictionary(this.strm,t.dictionary),n!==pd)))throw new Error(Ss[n])}kd.prototype.push=function(e,t){const n=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let o,s,a;if(this.ended)return!1;for(t===~~t?s=t:s=t===!0?l1:d1,I0.call(e)==="[object ArrayBuffer]"?n.input=new Uint8Array(e):n.input=e,n.next_in=0,n.avail_in=n.input.length;;){for(n.avail_out===0&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),o=Vr.inflate(n,s),o===yp&&r&&(o=Vr.inflateSetDictionary(n,r),o===pd?o=Vr.inflate(n,s):o===HS&&(o=yp));n.avail_in>0&&o===Ip&&n.state.wrap>0&&e[n.next_in]!==0;)Vr.inflateReset(n),o=Vr.inflate(n,s);switch(o){case u1:case HS:case yp:case h1:return this.onEnd(o),this.ended=!0,!1}if(a=n.avail_out,n.next_out&&(n.avail_out===0||o===Ip))if(this.options.to==="string"){let c=hd.utf8border(n.output,n.next_out),d=n.next_out-c,l=hd.buf2string(n.output,c);n.next_out=d,n.avail_out=i-d,d&&n.output.set(n.output.subarray(c,c+d),0),this.onData(l)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(!(o===pd&&a===0)){if(o===Ip)return o=Vr.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(n.avail_in===0)break}}return!0};kd.prototype.onData=function(e){this.chunks.push(e)};kd.prototype.onEnd=function(e){e===pd&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=Eh.flattenChunks(this.chunks)),this.chunks=[],this.err=e,this.msg=this.strm.msg};function KE(e,t){const n=new kd(t);if(n.push(e),n.err)throw n.msg||Ss[n.err];return n.result}function p1(e,t){return t=t||{},t.raw=!0,KE(e,t)}var _1=kd,f1=KE,E1=p1,m1=KE,g1=ja,S1={Inflate:_1,inflate:f1,inflateRaw:E1,ungzip:m1,constants:g1};const{Deflate:MU,deflate:T1,deflateRaw:UU,gzip:xU}=wk,{Inflate:VU,inflate:R1,inflateRaw:FU,ungzip:BU}=S1;var C1=T1,v1=R1;const qt={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function I1(){const e=Ie();qt.getDisplayMedia=function(t){return!!(navigator.mediaDevices&&navigator.mediaDevices.getDisplayMedia)}(),qt.getStreamFromExtension=e.name===Ke.CHROME&&Number(e.version)>34,qt.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;const t=new RTCPeerConnection;let n=!1;try{t.addTransceiver("audio"),n=!0}catch{}return t.close(),n}(),qt.supportMinBitrate=e.name===Ke.CHROME||e.name===Ke.EDGE,qt.supportSetRtpSenderParameters=function(){const t=Ie();return!window.RTCRtpSender||!window.RTCRtpSender.prototype.setParameters||!window.RTCRtpSender.prototype.getParameters?!1:!!ko()||!(!Gt()&&!IA())||t.name===Ke.FIREFOX&&Number(t.version)>=64}(),e.name===Ke.SAFARI&&(Number(e.version)>=14?qt.supportDualStream=!0:qt.supportDualStream=!1),qt.webAudioMediaStreamDest=function(){const t=Ie();return!(t.name===Ke.SAFARI&&Number(t.version)<12)}(),qt.supportReplaceTrack=function(){return window.RTCRtpSender?typeof RTCRtpSender.prototype.replaceTrack=="function":!1}(),qt.supportWebGL=typeof WebGLRenderingContext<"u",qt.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,ko()||(qt.webAudioWithAEC=!0),qt.supportShareAudio=function(){const t=Ie();return(t.os===Ht.WIN_10||t.os===Ht.WIN_81||t.os===Ht.WIN_7||t.os===Ht.LINUX||t.os===Ht.MAC_OS||t.os===Ht.CHROMIUM_OS)&&t.name===Ke.CHROME&&Number(t.version)>=74}(),qt.supportDataChannel=function(){return!!(QD(76)||eP(68)||AA(14))}(),qt.supportPCSetConfiguration=function(){const t=window.RTCPeerConnection;return!Me()&&!!t&&t.prototype.setConfiguration instanceof Function}(),qt.supportWebRTCEncodedTransform=function(){const t=Ie();return t.name==="Chrome"&&Number(t.version)>=86||t.name==="Safari"&&Number(t.version)>=15}(),qt.supportWebRTCInsertableStream=function(){const t=Ie();return(t.name===Ke.CHROME||t.name===Ke.EDGE)&&Number(t.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),qt.supportRequestVideoFrameCallback=function(){return"requestVideoFrameCallback"in HTMLVideoElement.prototype}(),qt.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,hh(()=>{qt.supportDualStreamEncoding=function(){const t=Ie();return A("DISABLE_WEBAUDIO")?!0:t.name==="Safari"&&Number(t.version)>=14||!!(t.name==="Chrome"&&/Windows/i.test(t.os||"")&&Number(t.version)>=100&&A("CHROME_DUAL_STREAM_USE_ENCODING"))}(),f.info("browser compatibility",JSON.stringify(qt),JSON.stringify(e))})}function ge(){return qt}function y0(){return"setSinkId"in HTMLAudioElement.prototype&&(!A("RESTRICTION_SET_PLAYBACK_DEVICE")||(Ns()||yA())&&!DA())}let Kt=function(e){return e.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",e.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",e.IOS_INTERRUPTION_START="ios-interruption-start",e.IOS_INTERRUPTION_END="ios-interruption-end",e.STATE_CHANGE="state-change",e}({});function Ms(e,t,n){return{sampleRate:e,stereo:t,bitrate:n}}function me(e,t,n,i,r){return{width:e,height:t,frameRate:n,bitrateMin:i,bitrateMax:r}}function Ap(e,t){return{numSpatialLayers:e,numTemporalLayers:t}}const y1={"90p":me(160,90),"90p_1":me(160,90),"120p":me(160,120,15,30,65),"120p_1":me(160,120,15,30,65),"120p_3":me(120,120,15,30,50),"120p_4":me(212,120),"180p":me(320,180,15,30,140),"180p_1":me(320,180,15,30,140),"180p_3":me(180,180,15,30,100),"180p_4":me(240,180,15,30,120),"240p":me(320,240,15,40,200),"240p_1":me(320,240,15,40,200),"240p_3":me(240,240,15,40,140),"240p_4":me(424,240,15,40,220),"360p":me(640,360,15,80,400),"360p_1":me(640,360,15,80,400),"360p_3":me(360,360,15,80,260),"360p_4":me(640,360,30,80,600),"360p_6":me(360,360,30,80,400),"360p_7":me(480,360,15,80,320),"360p_8":me(480,360,30,80,490),"360p_9":me(640,360,15,80,800),"360p_10":me(640,360,24,80,800),"360p_11":me(640,360,24,80,1e3),"480p":me(640,480,15,100,500),"480p_1":me(640,480,15,100,500),"480p_2":me(640,480,30,100,1e3),"480p_3":me(480,480,15,100,400),"480p_4":me(640,480,30,100,750),"480p_6":me(480,480,30,100,600),"480p_8":me(848,480,15,100,610),"480p_9":me(848,480,30,100,930),"480p_10":me(640,480,10,100,400),"720p":me(1280,720,15,120,1130),"720p_auto":me(1280,720,30,900,3e3),"720p_1":me(1280,720,15,120,1130),"720p_2":me(1280,720,30,120,2e3),"720p_3":me(1280,720,30,120,1710),"720p_5":me(960,720,15,120,910),"720p_6":me(960,720,30,120,1380),"1080p":me(1920,1080,15,120,2080),"1080p_1":me(1920,1080,15,120,2080),"1080p_2":me(1920,1080,30,120,3e3),"1080p_3":me(1920,1080,30,120,3150),"1080p_5":me(1920,1080,60,120,4780),"1440p":me(2560,1440,30,120,4850),"1440p_1":me(2560,1440,30,120,4850),"1440p_2":me(2560,1440,60,120,7350),"4k":me(3840,2160,30,120,8910),"4k_1":me(3840,2160,30,120,8910),"4k_3":me(3840,2160,60,120,13500)},pl=[{scaleResolutionDownBy:2,width:1280,height:720,frameRate:30,bitrateMin:300,bitrateMax:900},{scaleResolutionDownBy:1.333333,width:1280,height:720,frameRate:30,bitrateMin:600,bitrateMax:2e3},{scaleResolutionDownBy:1,width:1280,height:720,frameRate:30,bitrateMin:900,bitrateMax:3e3}],A1={"1SL1TL":Ap(1,1),"3SL3TL":Ap(3,3),"2SL3TL":Ap(2,3)};function jr(e){return e||(e="480p_1"),typeof e=="string"?Object.assign({},y1[e]):e}function w1(e){return typeof e=="string"?Object.assign({},A1[e]):e}const N1={speech_low_quality:Ms(16e3,!1),speech_standard:Ms(32e3,!1,18),music_standard:Ms(48e3,!1),standard_stereo:Ms(48e3,!0,56),high_quality:Ms(48e3,!1,128),high_quality_stereo:Ms(48e3,!0,192)};function A0(e){return typeof e=="string"?Object.assign({},N1[e]):e}const _d=[];function O1(e){_d.includes(e)||_d.push(e)}function b1(e){const t=_d.indexOf(e);t!==-1&&_d.splice(t,1)}function KS(e){return Xt(e,"mediaSource",["screen","window","application"]),!0}let W=function(e){return e.NEED_RENEGOTIATE="@need_renegotiate",e.NEED_REPLACE_TRACK="@need_replace_track",e.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",e.NEED_CLOSE="@need_close",e.NEED_ENABLE_TRACK="@need_enable_track",e.NEED_DISABLE_TRACK="@need_disable_track",e.NEED_SESSION_ID="@need_sid",e.SET_OPTIMIZATION_MODE="@set_optimization_mode",e.GET_STATS="@get_stats",e.GET_RTC_STATS="@get_rtc_stats",e.GET_LOW_VIDEO_TRACK="@get_low_video_track",e.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",e.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",e.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",e.NEED_MUTE_TRACK="@need_mute_track",e.NEED_UNMUTE_TRACK="@need_unmute_track",e}({}),je=function(e){return e.SCREEN_TRACK="screen_track",e.CUSTOM_TRACK="custome_track",e.LOW_STREAM="low_stream",e}({});function D1(e){if(!e)throw new L(C.INVALID_PARAMS);return tt(e.width)||cp(e.width,"streamParameter.width"),tt(e.height)||cp(e.height,"streamParameter.height"),tt(e.framerate)||cp(e.framerate,"streamParameter.framerate"),tt(e.bitrate)||De(e.bitrate,"streamParameter.bitrate"),!0}let ba=function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e}({});(function(e){return e[e.HIGH_STREAM=0]="HIGH_STREAM",e[e.LOW_STREAM=1]="LOW_STREAM",e})({});(function(e){return e[e.DISABLE=0]="DISABLE",e[e.LOW_STREAM=1]="LOW_STREAM",e[e.AUDIO_ONLY=2]="AUDIO_ONLY",e})({});let ls=function(e){return e.TRANSCEIVER_UPDATED="transceiver-updated",e.SEI_TO_SEND="sei-to-send",e.SEI_RECEIVED="sei-received",e.TRACK_UPDATED="track-updated",e}({}),Ka=function(e){return e.SOURCE_STATE_CHANGE="source-state-change",e.TRACK_ENDED="track-ended",e.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.CLOSED="closed",e}({}),_a=function(e){return e.FIRST_FRAME_DECODED="first-frame-decoded",e.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",e.VIDEO_STATE_CHANGED="video-state-changed",e}({}),pi=function(e){return e.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",e.RECEIVE_TRACK_BUFFER="receive_track_buffer",e.ON_AUDIO_BUFFER="on_audio_buffer",e.UPDATE_SOURCE="update_source",e}({});(function(e){return e.UPDATE_TRACK_SOURCE="update-track-source",e})({});const Cf={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},vf={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},w0={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},P1={uplinkNetworkQuality:0,downlinkNetworkQuality:0},N0={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1};let Cn=function(e){return e.ON_TRACK="on_track",e.ON_NODE="on_node",e}({}),oi=function(e){return e.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",e.REQUEST_CONSTRAINTS="request_constraints",e}({}),cc=function(e){return e.IDLE="IDLE",e.INITING="INITING",e.INITEND="INITEND",e}({}),ss=function(e){return e.STATE_CHANGE="state_change",e.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",e.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",e.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",e}({}),hn=function(e){return e.NONE="none",e.INIT="init",e.CANPLAY="canplay",e.PLAYING="playing",e.PAUSED="paused",e.SUSPEND="suspend",e.STALLED="stalled",e.WAITING="waiting",e.ERROR="error",e.DESTROYED="destroyed",e.ABORT="abort",e.ENDED="ended",e.EMPTIED="emptied",e.LOADEDDATA="loadeddata",e}({}),ur=function(e){return e[e.VideoStateStopped=0]="VideoStateStopped",e[e.VideoStateStarting=1]="VideoStateStarting",e[e.VideoStateDecoding=2]="VideoStateDecoding",e[e.VideoStateFrozen=3]="VideoStateFrozen",e}({});const wp={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370};let zl=function(e){return e.OPEN="open",e.MESSAGE="message",e.CLOSE="close",e.CLOSING="closing",e.ERROR="error",e}({});function zS(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),n.push.apply(n,i)}return n}function Ze(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?zS(Object(n),!0).forEach(function(i){k(e,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):zS(Object(n)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))})}return e}function k(e,t,n){return(t=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,s||"default");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(o)}(i,"string");return typeof r=="symbol"?r:String(r)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ee(e,t,n,i,r){var o={};return Object.keys(i).forEach(function(s){o[s]=i[s]}),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce(function(s,a){return a(e,t,s)||s},o),r&&o.initializer!==void 0&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),o.initializer===void 0&&(Object.defineProperty(e,t,o),o=null),o}class O0 extends qe{set _mediaStreamTrack(t){t!==this.mediaStreamTrack&&(this.safeEmit(ls.TRACK_UPDATED,t),this.mediaStreamTrack=t)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(t,n){super(),k(this,"trackMediaType",void 0),k(this,"_ID",void 0),k(this,"_rtpTransceiver",void 0),k(this,"_lowRtpTransceiver",void 0),k(this,"_hints",[]),k(this,"_isClosed",!1),k(this,"_originMediaStreamTrack",void 0),k(this,"mediaStreamTrack",void 0),k(this,"_external",{}),this._ID=n||et(8,"track-"),this._originMediaStreamTrack=t,this.mediaStreamTrack=t,O1(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(t){return t||Mo(()=>{var n;q.reportApiInvoke(null,{name:an.GET_MEDIA_STREAM_TRACK,options:[],tag:bt.TRACER}).onSuccess(((n=this._mediaStreamTrack)===null||n===void 0?void 0:n.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(t){return t===ba.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,b1(this),this.emit(Ka.CLOSED),this.removeAllListeners(ls.SEI_RECEIVED)}_updateRtpTransceiver(t,n){if(n===ba.LOW_STREAM){if(this._lowRtpTransceiver===t)return;this._lowRtpTransceiver=t}else{if(this._rtpTransceiver===t)return;this._rtpTransceiver=t}this.emit(ls.TRANSCEIVER_UPDATED,t,n)}}class ia extends O0{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(t,n){super(t,n),k(this,"_enabled",!0),k(this,"_muted",!1),k(this,"_isExternalTrack",!1),k(this,"_isClosed",!1),k(this,"_enabledMutex",void 0),k(this,"processor",void 0),k(this,"_processorContext",void 0),k(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new Bt("".concat(this.getTrackId())),t.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var t,n;return(t=(n=this._originMediaStreamTrack)===null||n===void 0?void 0:n.label)!==null&&t!==void 0?t:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,f.debug("[".concat(this.getTrackId(),"] close")),this.emit(W.NEED_CLOSE),super.close())}async _updateOriginMediaStreamTrack(t,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=i,t!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),n&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ue(this,W.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))}_getDefaultPlayerConfig(){return{}}onTrackEnded(){f.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ka.TRACK_ENDED)}stateCheck(t,n){if(f.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(t,": ").concat(n,"]")),Fr(n,t),this._enabled&&this._muted&&t==="enabled"&&n===!1)throw new L(C.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",f);if(!this._enabled&&!this._muted&&t==="muted"&&n===!0)throw new L(C.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",f)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Promise.resolve([])}}const YS=window.AudioContext||window.webkitAudioContext;let Jn=null;const Oe=new class extends qe{constructor(){super(...arguments),k(this,"prevState",void 0),k(this,"curState",void 0),k(this,"currentTime",void 0),k(this,"currentTimeStuckAt",void 0),k(this,"interruptDetectorTrack",void 0),k(this,"onLocalAudioTrackMute",()=>{f.info("ios15-interruption-start"),this.emit(Kt.IOS_15_16_INTERRUPTION_START)}),k(this,"onLocalAudioTrackUnmute",async()=>{f.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?f.info("ios15-interruption-end-canceled"):(Jn&&await Jn.suspend(),this.emit(Kt.IOS_15_16_INTERRUPTION_END))})}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(e){f.debug("webaudio bindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=e,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(e){f.debug("webaudio unbindInterruptDetectorTrack ".concat(e.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===e&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function L1(){if(!YS)return void f.error("your browser is not support web audio");f.info("create audio context");const e=Ze({},A("WEBAUDIO_INIT_OPTIONS"));f.debug("audio context init option:",JSON.stringify(e)),Jn=new YS(e),Oe.curState=Jn.state,Jn.onstatechange=()=>{Oe.prevState=Oe.curState,Oe.curState=Jn?Jn.state:void 0;const{prevState:t,curState:n}=Oe,i=n==="running",r=n==="interrupted",o=t==="running",s=t==="suspended",a=t==="interrupted",c=Ie().osVersion;(dn()||nr())&&o&&r&&(f.info("ios".concat(c,"-interruption-start")),Oe.emit(Kt.IOS_INTERRUPTION_START)),(dn()||nr())&&(s||a)&&i&&(f.info("ios".concat(c,"-interruption-end")),Oe.emit(Kt.IOS_INTERRUPTION_END)),t!==n&&Oe.emit(Kt.STATE_CHANGE,n,t)},setInterval(()=>{var t;const n=(t=Jn)===null||t===void 0?void 0:t.currentTime;Oe.currentTime!==n?(Oe.currentTimeStuckAt&&(f.debug("AudioContext current time resume at ".concat(n)),Oe.currentTimeStuckAt=void 0),Oe.currentTime=n):(n!==Oe.currentTimeStuckAt&&(q.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:n},tag:bt.TRACER}).onSuccess(),f.warning("AudioContext current time stuck at ".concat(n))),Oe.currentTimeStuckAt=n)},5e3),async function(t){const n=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"];let i,r=!1,o=!1,s=!1;function a(g){t.state==="running"?c(!1):dn()||nr()?t.state==="suspended"&&(c(!0),g&&t.resume().then(l,l)):t.state!=="closed"&&(c(!0),g&&t.resume().then(l,l))}function c(g){if(r!==g){r=g;for(let S=0,T=n;S<T.length;S+=1){const I=T[S];g?window.addEventListener(I,u,{capture:!0,passive:!0}):window.removeEventListener(I,u,{capture:!0,passive:!0})}}}function d(){a(!0)}function l(){a(!1)}function u(){a(!0)}function h(g){if(!s)if(i.paused)if(g){let S;p(!1),s=!0;try{S=i.play(),S?S.then(m,m):(i.addEventListener("playing",m),i.addEventListener("abort",m),i.addEventListener("error",m))}catch{m()}}else p(!0);else p(!1)}function p(g){if(o!==g){o=g;for(let S=0,T=n;S<T.length;S++){const I=T[S];g?window.addEventListener(I,E,{capture:!0,passive:!0}):window.removeEventListener(I,E,{capture:!0,passive:!0})}}}function m(){i.removeEventListener("playing",m),i.removeEventListener("abort",m),i.removeEventListener("error",m),s=!1,h(!1)}function E(){h(!0)}if(dn()){const g=t.createMediaStreamDestination(),S=document.createElement("div");S.innerHTML="<audio x-webkit-airplay='deny'></audio>",i=S.children.item(0),i.controls=!1,i.disableRemotePlayback=!0,i.preload="auto",i.srcObject=g.stream,h(!0)}Oe.on(Kt.STATE_CHANGE,d),a(!1)}(Jn)}function Md(){if(!Jn){if(L1(),!Jn)throw new L(C.NOT_SUPPORTED,"can not create audio context");return Jn}return Jn}function k1(){return!!Jn}function Yo(e){if(function(){if(Np!==null)return Np;const i=Md(),r=i.createBufferSource(),o=i.createGain(),s=i.createGain();r.connect(o),r.connect(s),r.disconnect(o);let a=!1;try{r.disconnect(o)}catch{a=!0}return r.disconnect(),Np=a,a}())return;const t=e.connect,n=e.disconnect;e.connect=(i,r,o)=>(e._inputNodes||(e._inputNodes=[]),e._inputNodes.includes(i)||(i instanceof AudioNode?(e._inputNodes.push(i),t.call(e,i,r,o)):t.call(e,i,r)),e),e.disconnect=(i,r,o)=>{n.call(e),i?Ou(e._inputNodes,i):e._inputNodes=[];for(const s of e._inputNodes)t.call(e,s)}}let Np=null;function b0(e,t){let n=!1;const i=1/t;if(A("DISABLE_WEBAUDIO")){const r=window.setInterval(()=>{n?window.clearInterval(r):e(performance.now()/1e3)},1e3*i)}else{const r=Md();let o=r.createGain();o.gain.value=0,o.connect(r.destination);const s=()=>{if(n)return void(o=null);const a=r.createOscillator();a.onended=s,a.connect(o),a.start(0),a.stop(r.currentTime+i),e(r.currentTime)};s()}return()=>{n=!0}}function M1(e){for(let t=0;t<e.outputBuffer.numberOfChannels;t+=1){const n=e.outputBuffer.getChannelData(t);for(let i=0;i<n.length;i+=1)n[i]=0}return e.inputBuffer}class D0{constructor(){k(this,"context",void 0),k(this,"analyserNode",void 0),k(this,"sourceNode",void 0),this.context=Md(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(t){if(t!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=t,t==null||t.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||dn()||nr()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;const t=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(t);else{const i=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(i);for(let r=0;r<t.length;++r)t[r]=i[r]/128-1}const n=t.reduce((i,r)=>i+r*r,0)/t.length;return Math.max(10*Math.log10(n)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var t,n;(t=this.sourceNode)===null||t===void 0||t.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(n=this.sourceNode)===null||n===void 0||n.connect(this.analyserNode)}catch{f.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class U1 extends qe{get processSourceNode(){return this.sourceNode}set processedNode(t){var n;if(!this.isDestroyed&&this._processedNode!==t){try{var i;(i=this.sourceNode)===null||i===void 0||i.disconnect(this.outputNode)}catch{}(n=this._processedNode)===null||n===void 0||n.disconnect(),this._processedNode=t,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),k(this,"outputNode",void 0),k(this,"outputTrack",void 0),k(this,"isPlayed",!1),k(this,"sourceNode",void 0),k(this,"context",void 0),k(this,"audioBufferNode",void 0),k(this,"destNode",void 0),k(this,"audioOutputLevel",0),k(this,"volumeLevelAnalyser",void 0),k(this,"_processedNode",void 0),k(this,"playNode",void 0),k(this,"isDestroyed",!1),k(this,"onNoAudioInput",void 0),k(this,"isNoAudioInput",!1),k(this,"_noAudioInputCount",0),this.context=Md(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),Yo(this.outputNode),this.volumeLevelAnalyser=new D0}startGetAudioBuffer(t){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(t),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=n=>{this.emit(pi.ON_AUDIO_BUFFER,M1(n))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!ge().webAudioMediaStreamDest)throw new L(C.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(t){this.context.state!=="running"&&hh(()=>{Oe.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=t||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}async checkHasAudioInput(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(t>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;dn()||nr()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();const n=this.volumeLevelAnalyser.getAnalyserNode();let i;n.getFloatTimeDomainData?(i=new Float32Array(n.fftSize),n.getFloatTimeDomainData(i)):(i=new Uint8Array(n.fftSize),n.getByteTimeDomainData(i));let r=!1;for(let o=0;o<i.length;o++)i[o]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(await Pt(200),await this.checkHasAudioInput(t?t+1:1)&&r)}getAudioVolume(){return this.outputNode.gain.value}setVolume(t){this.outputNode.gain.setValueAtTime(t,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var t,n;(t=this.processedNode)===null||t===void 0||t.disconnect(),(n=this.sourceNode)===null||n===void 0||n.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var t;this.processedNode?(t=this.processedNode)===null||t===void 0||t.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class P0 extends U1{get isFreeze(){return!1}constructor(t,n,i){var r;if(super(),k(this,"sourceNode",void 0),k(this,"track",void 0),k(this,"clonedTrack",void 0),k(this,"audioElement",void 0),k(this,"isCurrentTrackCloned",!1),k(this,"isRemoteTrack",!1),k(this,"originVolumeLevelAnalyser",void 0),k(this,"rebuildWebAudio",async()=>{if(f.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&await this.checkHasAudioInput(),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void f.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>f.info("resume success")),f.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();const a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;const c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),Yo(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();const d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),Yo(this.outputNode),this.emit(pi.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()}),t.kind!=="audio")throw new L(C.UNEXPECTED_ERROR);this.track=t;const o=new MediaStream([this.track]);if(this.isRemoteTrack=!!n,this.sourceNode=this.context.createMediaStreamSource(o),Yo(this.sourceNode),i){const a=i.clone();a.enabled=!0,this.clonedTrack=a,f.debug("create an unmuted track ".concat(a.id," from the original track ").concat(i.id," to get the volume"));const c=this.context.createMediaStreamSource(new MediaStream([a]));Yo(c),this.originVolumeLevelAnalyser=new D0,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;const s=Ie();n&&s.os===Ht.IOS&&Number((r=s.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(Oe.on(Kt.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(t){this.sourceNode.disconnect(),this.track=t,this.isCurrentTrackCloned=!1;const n=new MediaStream([t]);this.sourceNode=this.context.createMediaStreamSource(n),Yo(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit(pi.UPDATE_SOURCE),this.audioElement.srcObject=n}destroy(){var t;this.audioElement.srcObject=null,this.audioElement.remove(),Oe.off("state-change",this.rebuildWebAudio),(t=this.originVolumeLevelAnalyser)===null||t===void 0||t.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(t){return this.context.createMediaStreamSource(new MediaStream([t]))}updateOriginTrack(t){const n=t.clone();n.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=n),f.debug("create an unmuted track ".concat(n.id," from the original track ").concat(t.id," to get the volume"));const i=this.context.createMediaStreamSource(new MediaStream([n]));Yo(i),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(i)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}async function L0(e,t,n){const i=(o,s)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||s:o:s,r={audio:!!n&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:e,maxHeight:i(t.height,1080),maxWidth:i(t.width,1920)}}};return t.frameRate&&typeof t.frameRate!="number"?(r.video.mandatory.maxFrameRate=t.frameRate.max,r.video.mandatory.minFrameRate=t.frameRate.min):typeof t.frameRate=="number"&&(r.video.mandatory.maxFrameRate=t.frameRate),await navigator.mediaDevices.getUserMedia(r)}async function x1(e,t){const n=await V1(e.mediaSource),{sourceId:i,audio:r}=await uP(n,t);return await L0(i,e,r)}async function V1(e){let t=["window","screen"];e!=="application"&&e!=="window"||(t=["window"]),e==="screen"&&(t=["screen"]);const n=kA();if(!n)throw console.error("failed to fetch electron, please mount it to window"),new L(C.ELECTRON_IS_NULL);let i=null;try{var r;i=((r=n.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:t}))||n.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:t})}catch{i=null}i&&i.then||(i=new Promise((o,s)=>{n.desktopCapturer.getSources({types:t},(a,c)=>{a?s(a):o(c)})}));try{return await i}catch(o){throw new L(C.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}}const If=new Bt("safari");let k0=!1,M0=!1;async function Oi(e,t){let n=0,i=null;for(;n<2;)try{i=await F1(e,t,n>0);break}catch(r){if(r instanceof L)throw f.error("[".concat(t,"] ").concat(r.toString())),r;const o=Yl(r.name||r.code||r,r.message);if(o.code===C.MEDIA_OPTION_INVALID){f.debug("[".concat(t,"] detect media option invalid, retry")),n+=1,await Pt(500);continue}throw f.error("[".concat(t,"] ").concat(o.toString())),o}if(!i)throw new L(C.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return i}async function F1(e,t,n){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new L(C.NOT_SUPPORTED,"can not find getUserMedia");n&&(e.video&&(delete e.video.width,delete e.video.height),e.screen&&(delete e.screen.width,delete e.screen.height));const i=ge(),r=new MediaStream;if(e.audioSource&&r.addTrack(e.audioSource),e.videoSource&&r.addTrack(e.videoSource),!e.audio&&!e.video&&!e.screen)return f.debug("Using Video Source/ Audio Source"),r;if(e.screen)if(lP())e.screen.sourceId?Us(r,await L0(e.screen.sourceId,e.screen,e.screenAudio)):Us(r,await x1(e.screen,e.screenAudio));else if(Ns()&&e.screen.extensionId&&e.screen.mandatory){if(!i.getStreamFromExtension)throw new L(C.NOT_SUPPORTED,"This browser does not support screen sharing");f.debug("[".concat(t,'] Screen access on chrome stable, looking for extension"'));const h=await(s=e.screen.extensionId,a=t,new Promise((p,m)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},E=>{if(!E||!E.streamId)return f.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),E),void m(new L(C.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));p(E.streamId)})}catch(E){f.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),E.toString()),m(new L(C.CHROME_PLUGIN_NOT_INSTALL))}}));e.screen.mandatory.chromeMediaSourceId=h,Us(r,await navigator.mediaDevices.getUserMedia({video:{mandatory:e.screen.mandatory}}))}else if(i.getDisplayMedia){var o;e.screen.mediaSource&&KS(e.screen.mediaSource);const h={width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate,displaySurface:(o=e.screen.displaySurface)!==null&&o!==void 0?o:e.screen.mediaSource==="screen"?"monitor":e.screen.mediaSource},{selfBrowserSurface:p,surfaceSwitching:m,systemAudio:E}=e.screen,g={selfBrowserSurface:p,surfaceSwitching:m,systemAudio:E};!p&&delete g.selfBrowserSurface,!m&&delete g.surfaceSwitching,!E&&delete g.systemAudio,f.debug("[".concat(t,"] getDisplayMedia:"),JSON.stringify({video:h,audio:!!e.screenAudio,controls:g})),Us(r,await navigator.mediaDevices.getDisplayMedia(Ze({video:h,audio:!!e.screenAudio},g)))}else{if(!Me())throw f.error("[".concat(t,"] This browser does not support screenSharing")),new L(C.NOT_SUPPORTED,"This browser does not support screen sharing");{e.screen.mediaSource&&KS(e.screen.mediaSource);const h={video:{mediaSource:e.screen.mediaSource,width:e.screen.width,height:e.screen.height,frameRate:e.screen.frameRate}};f.debug("[".concat(t,"] getUserMedia: ").concat(JSON.stringify(h))),Us(r,await navigator.mediaDevices.getUserMedia(h))}}var s,a;if(!e.video&&!e.audio)return r;let c={video:e.video,audio:e.audio},d=A("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=uf(c,d)}catch{}f.debug("[".concat(t,"] GetUserMedia"),JSON.stringify(c)),Ie();let l,u=null;(Gt()||dn()||IA())&&(u=await If.lock());try{l=await navigator.mediaDevices.getUserMedia(c)}catch(h){throw u&&u(),h}return c.audio&&(k0=!0),c.video&&(M0=!0),Us(r,l),u&&u(),r}function Yl(e,t){switch(e){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new L(C.MEDIA_OPTION_INVALID,"".concat(e,": ").concat(t));case"NotFoundError":case"DevicesNotFoundError":return new L(C.DEVICE_NOT_FOUND,"".concat(e,": ").concat(t));case"NotSupportedError":return new L(C.NOT_SUPPORTED,"".concat(e,": ").concat(t));case"NotReadableError":return new L(C.NOT_READABLE,"".concat(e,": ").concat(t));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new L(C.PERMISSION_DENIED,"".concat(e,": ").concat(t));case"ConstraintNotSatisfiedError":return new L(C.CONSTRAINT_NOT_SATISFIED,"".concat(e,": ").concat(t));default:return f.error("getUserMedia unexpected error",e),new L(C.UNEXPECTED_ERROR,"".concat(e,": ").concat(t))}}function Us(e,t){const n=e.getVideoTracks()[0],i=e.getAudioTracks()[0],r=t.getVideoTracks()[0],o=t.getAudioTracks()[0];o&&(i&&e.removeTrack(i),e.addTrack(o)),r&&(n&&e.removeTrack(n),e.addTrack(r))}let B1=class extends qe{get state(){return this._state}set state(t){t!==this._state&&(this.emit(ss.STATE_CHANGE,t),this._state=t)}constructor(){super(),k(this,"_state",cc.IDLE),k(this,"isAccessMicrophonePermission",!1),k(this,"isAccessCameraPermission",!1),k(this,"lastAccessMicrophonePermission",!1),k(this,"lastAccessCameraPermission",!1),k(this,"checkdeviceMatched",!1),k(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(A("ENUMERATE_DEVICES_INTERVAL")||(uh()||aP())&&ko())&&this.updateDevicesInfo()},A("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>f.error(t.toString()))}async enumerateDevices(t,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new L(C.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();const r=await navigator.mediaDevices.enumerateDevices(),o=this.checkMediaDeviceInfoIsOk(r);let s=!this.isAccessMicrophonePermission&&t,a=!this.isAccessCameraPermission&&n;o.audio&&(s=!1),o.video&&(a=!1);let c=null,d=null,l=null;if(!i&&(s||a)){if(If.isLocked&&(f.debug("[device manager] wait GUM lock"),(await If.lock())(),f.debug("[device manager] GUM unlock")),k0&&(s=!1,this.isAccessMicrophonePermission=!0),M0&&(a=!1,this.isAccessCameraPermission=!0),f.debug("[device manager] check media device permissions",t,n,s,a),s&&a){try{l=await navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(u){const h=Yl(u.name||u.code||u,u.message);if(h.code===C.PERMISSION_DENIED)throw h;f.warning("getUserMedia failed in getDevices",h)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(s){try{c=await navigator.mediaDevices.getUserMedia({audio:t})}catch(u){const h=Yl(u.name||u.code||u,u.message);if(h.code===C.PERMISSION_DENIED)throw h;f.warning("getUserMedia failed in getDevices",h)}this.isAccessMicrophonePermission=!0}else if(a){try{d=await navigator.mediaDevices.getUserMedia({video:n})}catch(u){const h=Yl(u.name||u.code||u,u.message);if(h.code===C.PERMISSION_DENIED)throw h;f.warning("getUserMedia failed in getDevices",h)}this.isAccessCameraPermission=!0}f.debug("[device manager] mic permission",t,"cam permission",n)}try{const u=await navigator.mediaDevices.enumerateDevices();return c&&c.getTracks().forEach(h=>h.stop()),d&&d.getTracks().forEach(h=>h.stop()),l&&l.getTracks().forEach(h=>h.stop()),c=null,d=null,l=null,u}catch(u){return c&&c.getTracks().forEach(h=>h.stop()),d&&d.getTracks().forEach(h=>h.stop()),l&&l.getTracks().forEach(h=>h.stop()),c=null,d=null,l=null,new L(C.ENUMERATE_DEVICES_FAILED,u.toString()).throw()}}async getRecordingDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(n=>n.kind==="audioinput")}async getCamerasDevices(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!1,!0,t)).filter(n=>n.kind==="videoinput")}async getSpeakers(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(await this.enumerateDevices(!0,!1,t)).filter(n=>n.kind==="audiooutput")}searchDeviceIdByName(t){let n=null;return this.deviceInfoMap.forEach(i=>{i.device.label===t&&(n=i.device.deviceId)}),n}async getDeviceById(t){const n=(await this.enumerateDevices(!0,!0,!0)).find(i=>i.deviceId===t);if(!n)throw new L(C.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return n}async init(){this.state=cc.INITING;try{await this.updateDevicesInfo(),this.state=cc.INITEND}catch(t){throw f.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=cc.IDLE,!EP()&&new L(C.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}}async updateDevicesInfo(){const t=await this.enumerateDevices(!0,!0,!0),n=Date.now(),i=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;const o=t.find(a=>a.kind==="audioinput"&&a.deviceId==="default"),s=t.find(a=>a.kind==="audiooutput"&&a.deviceId==="default");o&&s?s.groupId===o.groupId?f.debug("[device-check] default input ".concat(o.label," and output ").concat(s.label," is the same group")):f.warning("[device-check] default input ".concat(o.label," and output ").concat(s.label," is not the same group")):f.debug("[device-check] default input or output not found")}const r=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(o=>{if(!o.deviceId)return;const s=this.deviceInfoMap.get("".concat(o.kind,"_").concat(o.deviceId));if((s?s.state:"INACTIVE")!=="ACTIVE"){const a={initAt:n,updateAt:n,device:o,state:"ACTIVE"};this.deviceInfoMap.set("".concat(o.kind,"_").concat(o.deviceId),a),i.push(a)}s&&(s.updateAt=n)}),this.deviceInfoMap.forEach((o,s)=>{o.state==="ACTIVE"&&o.updateAt!==n&&(o.state="INACTIVE",i.push(o))}),this.state!==cc.INITEND)return r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach(o=>{switch(o.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(ss.RECORDING_DEVICE_CHANGED,o);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(ss.CAMERA_DEVICE_CHANGED,o);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(ss.PLAYOUT_DEVICE_CHANGED,o)}}),r.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),r.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)}checkMediaDeviceInfoIsOk(t){const n=t.filter(o=>o.kind==="audioinput"),i=t.filter(o=>o.kind==="videoinput"),r={audio:!1,video:!1};for(const o of n)if(o.label&&o.deviceId){r.audio=!0;break}for(const o of i)if(o.label&&o.deviceId){r.video=!0;break}return r}};const Rr=new B1;let Op=!1;const Zn=new class extends qe{constructor(){super(...arguments),k(this,"onAutoplayFailed",void 0),k(this,"onAudioAutoplayFailed",void 0)}};function U0(){if(Ie(),!Op){const e=t=>{t.preventDefault(),Op=!1,od()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};Op=!0,od()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),f.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),Zn.onAutoplayFailed?Zn.onAutoplayFailed():Zn.onAudioAutoplayFailed?f.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):f.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),Zn.emit("autoplay-failed")}}function x0(e,t,n,i){if(!e)return;const r=q.getBaseInfoBySessionId(e);if(!r)return;const o=r.info,s=Date.now(),a=Ze(Ze({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:Zn.onAutoplayFailed||Zn.onAudioAutoplayFailed?1:-1,errorMsg:n,mediaType:t,trackId:i,extend:void 0});q.send({type:Qe.AUTOPLAY_FAILED,data:a},!0)}const G1=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Bn=new class{constructor(){k(this,"onAutoplayFailed",void 0),k(this,"elementMap",new Map),k(this,"elementStateMap",new Map),k(this,"elementsNeedToResume",[]),k(this,"sinkIdMap",new Map),k(this,"autoResumeAfterInterruption",e=>{Array.from(this.elementMap.entries()).forEach(t=>{let[n,i]=t;const r=this.elementStateMap.get(n),o=i.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(f.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(s," ").concat(e)),s==="live"){if(e)return i.pause(),void i.play();if(Oe.curState==="running")return ya()?(i.pause(),void i.play()):void(r&&r==="paused"&&i.play())}})}),k(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(e=>{let[t,n]=e;const i=n.srcObject.getAudioTracks()[0];i&&i.readyState==="live"&&(f.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),n.pause(),n.play())})}),this.autoResumeAudioElement(),Oe.on(Kt.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Oe.on(Kt.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Oe.on(Kt.STATE_CHANGE,()=>{dn()&&Oe.prevState==="suspended"&&Oe.curState==="running"&&this.autoResumeAfterInterruption()})}async setSinkID(e,t){const n=this.elementMap.get(e);if(this.sinkIdMap.set(e,t),n)try{await n.setSinkId(t)}catch(i){throw new L(C.PERMISSION_DENIED,"can not set sink id: "+i.toString())}}play(e,t,n,i){if(this.elementMap.has(t))return;const r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([e]),this.bindAudioElementEvents(t,r),this.elementMap.set(t,r),this.elementStateMap.set(t,hn.INIT),this.setVolume(t,n);const o=this.sinkIdMap.get(t);if(o)try{r.setSinkId(o).catch(a=>{f.warning("[".concat(t,"] set sink id failed"),a.toString())})}catch(a){f.warning("[".concat(t,"] set sink id failed"),a.toString())}const s=r.play();s&&s.then&&s.catch(a=>{i&&x0(i,"audio",a.message,t),f.warning("audio element play warning",a.toString()),this.elementMap.has(t)&&a.name==="NotAllowedError"&&(f.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),hh(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),U0()}))})}updateTrack(e,t){const n=this.elementMap.get(e);n&&(n.srcObject=new MediaStream([t]))}isPlaying(e){return this.elementMap.has(e)&&this.elementStateMap.get(e)==="playing"}setVolume(e,t){const n=this.elementMap.get(e);n&&(t=Math.max(0,Math.min(100,t)),n.volume=t/100)}stop(e){const t=this.elementMap.get(e);if(this.sinkIdMap.delete(e),!t)return;const n=this.elementsNeedToResume.indexOf(t);this.elementsNeedToResume.splice(n,1),t.srcObject=null,t.remove(),this.elementMap.delete(e),this.elementStateMap.delete(e)}bindAudioElementEvents(e,t){G1.forEach(n=>{t.addEventListener(n,i=>{const r=this.elementStateMap.get(e),o=i.type==="pause"?"paused":i.type;if(f.debug("[".concat(e,"] audio-element-status change ").concat(r," => ").concat(o)),i.type==="error"){const s=t==null?void 0:t.error;s&&f.error("[".concat(e,"] media error, code: ").concat(s.code,", message: ").concat(s.message))}this.elementStateMap.set(e,o)})})}getPlayerState(e){return this.elementStateMap.get(e)||"uninit"}autoResumeAudioElement(){const e=()=>{this.elementsNeedToResume.forEach(t=>{t.play().then(n=>{f.debug("Auto resume audio element success")}).catch(n=>{f.warning("Auto resume audio element failed!",n)})}),this.elementsNeedToResume=[]};wP().then(()=>{od()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0))})}};function lt(){return function(e,t,n){const i=n.value;return typeof i=="function"&&(n.value=function(){this._isClosed&&new L(C.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",f);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];const a=i.apply(this,o);return a instanceof Promise?new Promise((c,d)=>{a.then(c).catch(d)}):a}),n}}let V0=class extends qe{constructor(t){super(),k(this,"name","VideoProcessorDestination"),k(this,"ID","0"),k(this,"_source",void 0),k(this,"videoContext",void 0),k(this,"inputTrack",void 0),this.videoContext=t}get kind(){return"video"}get enabled(){return!0}pipe(){throw new L(C.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new L(C.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(t){if(t.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);t.track&&t.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=t.track,this.emit(Cn.ON_TRACK,t.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(Cn.ON_TRACK,void 0)}},F0=class extends qe{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,n){super(),k(this,"constraintsMap",new Map),k(this,"statsRegistry",[]),k(this,"usageRegistry",[]),k(this,"trackId",void 0),k(this,"direction",void 0),k(this,"_chained",!1),this.trackId=t,this.direction=n}async getConstraints(){return await Tt(this,oi.REQUEST_CONSTRAINTS)}async requestApplyConstraints(t,n){return f.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(n,t),Ue(this,oi.REQUEST_UPDATE_CONSTRAINTS,Array.from(this.constraintsMap.values()))}async requestRevertConstraints(t){if(this.constraintsMap.has(t))return f.info("processor ".concat(t.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(t),Ue(this,oi.REQUEST_UPDATE_CONSTRAINTS,Array.from(this.constraintsMap.values()))}registerStats(t,n,i){this.statsRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:n,cb:i})}unregisterStats(t,n){const i=this.statsRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:n,processorName:i,type:r,cb:o}of this.statsRegistry)try{const s=o();t.push({processorID:n,processorName:i,type:r,stats:s})}catch(s){f.error(new L(C.UNEXPECTED_ERROR,s.message))}return t}registerUsage(t,n){this.usageRegistry.find(i=>i.processorID===t.ID&&i.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:n})}unregisterUsage(t){const n=this.usageRegistry.findIndex(i=>i.processorID===t.ID&&i.processorName===t.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof Promise&&(i=await i),t.push(Ze(Ze({},i),{},{direction:this.direction}))}catch(i){f.error("gather extension usage error",i)}return t}getDirection(){return this.direction}},B0=class extends qe{constructor(t){super(),k(this,"name","AudioProcessorDestination"),k(this,"ID","0"),k(this,"inputTrack",void 0),k(this,"inputNode",void 0),k(this,"audioProcessorContext",void 0),k(this,"_source",void 0),this.audioProcessorContext=t}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new L(C.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new L(C.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(Cn.ON_TRACK,void 0),this.emit(Cn.ON_NODE,void 0)}updateInput(t){if(t.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);t.track&&this.inputTrack!==t.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=t.track,this.emit(Cn.ON_TRACK,this.inputTrack)),t.node&&this.inputNode!==t.node&&(this.audioProcessorContext.chained=!0,this.inputNode=t.node,this.emit(Cn.ON_NODE,this.inputNode))}},G0=class extends qe{set chained(t){this._chained=t}get chained(){return this._chained}constructor(t,n,i){super(),k(this,"constraintsMap",new Map),k(this,"statsRegistry",[]),k(this,"audioContext",void 0),k(this,"trackId",void 0),k(this,"direction",void 0),k(this,"usageRegistry",[]),k(this,"_chained",!1),this.audioContext=t,this.trackId=n,this.direction=i}async getConstraints(){return Tt(this,oi.REQUEST_CONSTRAINTS)}getAudioContext(){return this.audioContext}async requestApplyConstraints(t,n){return f.info("processor ".concat(n.name," requestApplyConstraints for ").concat(this.trackId)),t&&this.constraintsMap.set(n,t),Ue(this,oi.REQUEST_UPDATE_CONSTRAINTS,Array.from(this.constraintsMap.values()))}async requestRevertConstraints(t){if(this.constraintsMap.has(t))return this.constraintsMap.delete(t),Ue(this,oi.REQUEST_UPDATE_CONSTRAINTS,Array.from(this.constraintsMap.values()))}registerStats(t,n,i){this.statsRegistry.find(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n)||this.statsRegistry.push({processorName:t.name,processorID:t.ID,type:n,cb:i})}unregisterStats(t,n){const i=this.statsRegistry.findIndex(r=>r.processorID===t.ID&&r.processorName===t.name&&r.type===n);i!==-1&&this.statsRegistry.splice(i,1)}gatherStats(){const t=[];for(const{processorID:n,processorName:i,type:r,cb:o}of this.statsRegistry)try{const s=o();t.push({processorID:n,processorName:i,type:r,stats:s})}catch(s){f.error(new L(C.UNEXPECTED_ERROR,s.message))}return t}registerUsage(t,n){this.usageRegistry.find(i=>i.processorID===t.ID&&i.processorName===t.name)||this.usageRegistry.push({processorID:t.ID,processorName:t.name,cb:n})}unregisterUsage(t){const n=this.usageRegistry.findIndex(i=>i.processorID===t.ID&&i.processorName===t.name);n!==-1&&this.usageRegistry.splice(n,1)}async gatherUsage(){const t=[];if(!this.chained)return[];for(const{cb:n}of this.usageRegistry)try{let i=n();i instanceof Promise&&(i=await i),t.push(Ze(Ze({},i),{},{direction:this.direction}))}catch(i){f.error("gather extension usage error",i)}return t}getDirection(){return this.direction}},yf=class extends qe{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),k(this,"context",void 0),k(this,"processSourceNode",void 0),k(this,"outputTrack",void 0),k(this,"processedNode",void 0),k(this,"clonedTrack",void 0),k(this,"outputNode",void 0),this.outputNode=new j1}setVolume(){}createOutputTrack(){throw new L(C.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}},j1=class{disconnect(){}connect(){}};function j0(e){return new Promise((t,n)=>{let i=!1;const r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);const o=dn()?"canplay":"playing";r.addEventListener(o,()=>{const s=r.videoWidth,a=r.videoHeight;!s&&Me()||(i=!0,r.srcObject=null,r.remove(),t([s,a]))}),r.srcObject=new MediaStream([e]),r.play().catch(ph),setTimeout(()=>{i||(r.srcObject=null,r.remove(),t([r.videoWidth,r.videoHeight]))},4e3)})}function zE(e){const t={};e.facingMode&&(t.facingMode=e.facingMode),e.cameraId&&(t.deviceId={exact:e.cameraId});const n=jr(e.encoderConfig);return n.width!=null&&(t.width=n.width),n.height!=null&&(t.height=n.height),!bA()&&n.frameRate&&(t.frameRate=n.frameRate),yA()&&typeof t.frameRate=="object"&&(t.frameRate.max=60),Me()&&(t.frameRate={ideal:30,max:30}),t}function W1(e){const t={};if(bA()||(e.AGC!==void 0&&(t.autoGainControl=e.AGC),e.AEC!==void 0&&(t.echoCancellation=e.AEC),e.ANS!==void 0&&(t.noiseSuppression=e.ANS,Ns()&&e.ANS&&(t.googHighpassFilter=e.ANS))),e.encoderConfig){const n=A0(e.encoderConfig);t.channelCount=n.stereo?2:1,t.sampleRate=n.sampleRate,t.sampleSize=n.sampleSize}return e.microphoneId&&(t.deviceId={exact:e.microphoneId}),uh()&&(t.sampleRate=void 0),t}function H1(e,t,n,i,r){const o=A("BITRATE_ADAPTER_TYPE");if(o==="DEFAULT_BITRATE")return{min:i,max:r};if(r===void 0){var s;const c=Math.floor(200*Math.pow(n/15,.6)*Math.pow(e*t/640/360,.75));r=o==="STANDARD_BITRATE"?4*c:2*c,i=(s=i)!==null&&s!==void 0?s:c}else{var a;i=(a=i)!==null&&a!==void 0?a:Math.floor(r/10)}return{min:i,max:r}}function K1(e,t,n){const i=200*Math.pow(n/15,.6)*Math.pow(e*t/640/360,.75);return{min:Math.floor(i),max:Math.floor(4*i)}}const z1=e=>{const t=e._encoderConfig;if(!t)return;const{frameRate:n,width:i,height:r}=e.getMediaStreamTrackSettings();let{frameRate:o=n,width:s=i,height:a=r}=t;if(!o||!s||!a)return;s=dp(s),a=dp(a),o=dp(o);const{max:c,min:d}=K1(s,a,o),{bitrateMax:l,bitrateMin:u}=t||{};l||f.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(a,", fps: ").concat(o,"] => [brMax: ").concat(l,", brMin: ").concat(u,"]"));const{maxFramerate:h}=A("ENCODER_CONFIG_LIMIT");return h&&typeof h=="number"&&(o=Math.min(o,h)),{frameRate:o,bitrateMax:l||c,bitrateMin:u||d,scaleResolutionDownBy:1,scale:0}},W0=async(e,t,n)=>await(async(i,r,o)=>{const s=CP(FA(""+r+o)).slice(0,16),a=s.slice(0,12),c=await window.crypto.subtle.importKey("raw",s,"AES-GCM",!0,["encrypt"]);return new Uint8Array(await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,i))})(e.buffer,t,n),YE=e=>{const t=document.createElement("canvas");return t.width=2,t.height=2,new Promise((n,i)=>{t.toBlob(async r=>{if(t.remove(),r){const o=await H0(r);n({buffer:o,width:t.width,height:t.height})}else i(new L(C.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},e,1)})},H0=async e=>{const t=await e.arrayBuffer();return new Uint8Array(t)};function Y1(e,t){if("VideoFrame"in window&&"TransformStream"in window&&ge().supportWebRTCInsertableStream){const n=new MediaStreamTrackProcessor(e),i=new MediaStreamTrackGenerator({kind:"video"});let r,o,s=Date.now();const a=()=>{c&&(clearInterval(c),c=void 0),r&&(r.close(),r=void 0),e.stop(),o=void 0,i.removeEventListener("ended",a)};let c=window.setInterval(()=>{if(o&&r&&Date.now()-s>(t??1e3))try{i.readyState==="live"?o.enqueue(r.clone()):a()}catch{a()}},t??1e3);const d=new TransformStream({transform:(l,u)=>{i.readyState==="live"?(o=u,s=Date.now(),r===void 0?(r=l,u.enqueue(l.clone())):(u.enqueue(r),r=l)):l.close()}});return i.addEventListener("ended",a),n.readable.pipeThrough(d).pipeTo(i.writable),i}}var $S,qS,JS,XS,QS,ZS,eT,tT,nT,iT,rT,oT,sT,aT,cT,dT,lT,uT,Je,hT,pT,_T,fT,ET,mT,hr,gT,ST,TT,RT,CT,vT,IT,yT,AT,wT,NT,OT,bT,$t;let St=($S=Z({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),qS=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),JS=lt(),XS=Aa("LocalAudioTrack","_enabledMutex"),QS=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),ZS=lt(),eT=Aa("LocalAudioTrack","_enabledMutex"),tT=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),nT=lt(),iT=lt(),rT=lt(),oT=Z({argsMap:e=>[e.getTrackId()]}),sT=lt(),aT=Z({argsMap:e=>[e.getTrackId()]}),cT=lt(),dT=Z({argsMap:e=>[e.getTrackId()]}),lT=Z({argsMap:(e,t)=>[e.getTrackId(),t.name]}),uT=Z({argsMap:e=>[e.getTrackId()]}),Ee((Je=class extends ia{get _source(){return this.initWebAudio()}set _source(e){this._trackSource=e}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?Bn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(e,t,n,i){super(e,n),k(this,"trackMediaType","audio"),k(this,"_encoderConfig",void 0),k(this,"_trackSource",void 0),k(this,"_enabled",!0),k(this,"_volume",100),k(this,"_useAudioElement",!0),k(this,"_bypassWebAudio",!1),k(this,"processor",void 0),k(this,"_processorContext",void 0),k(this,"_processorDestination",void 0),k(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=t,this._getOriginVolumeLevel=!!i,this._trackSource=new yf,A("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),A("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Gt()&&!k1()?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(e){De(e,"volume",0,1e3),this._volume=e,this._source.setVolume(e/100),this._useAudioElement&&Bn.setVolume(this.getTrackId(),e);try{if(this._bypassWebAudio)return void f.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));const t=this._source.createOutputTrack();this._mediaStreamTrack!==t&&(this._mediaStreamTrack=t,Ue(this,W.NEED_REPLACE_TRACK,this).then(()=>{f.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(n=>{f.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),n)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}async setPlaybackDevice(e){if(!this._useAudioElement||!y0())throw new L(C.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Bn.setSinkID(this.getTrackId(),e)}async setEnabled(e,t,n){return this._setEnabled(e,t,n)}async _setEnabled(e,t,n){if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(f.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){this._originMediaStreamTrack.enabled=!0;try{n||(this._enabled=!0),await Ue(this,W.NEED_ENABLE_TRACK,this),f.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(e," success"))}catch(i){throw n||(this._enabled=!1),f.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}}else{this._originMediaStreamTrack.enabled=!1,n||(this._enabled=!1);try{await Ue(this,W.NEED_DISABLE_TRACK,this)}catch(i){throw n||(this._enabled=!0),f.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}}}async setMuted(e){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,f.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?await Ue(this,W.NEED_MUTE_TRACK,this):await Ue(this,W.NEED_UNMUTE_TRACK,this))}getStats(){return Mo(()=>{f.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Gn(this,W.GET_STATS)||Ze({},Cf)}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(pi.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(pi.ON_AUDIO_BUFFER),this._source.on(pi.ON_AUDIO_BUFFER,n=>e(n))}play(){f.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(f.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Bn.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){f.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Bn.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];f.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Bn.updateTrack(this.getTrackId(),this._mediaStreamTrack)}async _updateOriginMediaStreamTrack(e,t){this._originMediaStreamTrack!==e&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),t&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:e,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ue(this,W.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(e))}renewMediaStreamTrack(e){return Promise.resolve(void 0)}pipe(e){if(this._bypassWebAudio)throw new L(C.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===e)return e;if(e._source)throw new L(C.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(e){e.on(Cn.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t),await Ue(this,W.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ue(this,W.NEED_REPLACE_TRACK,this))}),e.on(Cn.ON_NODE,t=>{this._source.processedNode=t})}unbindProcessorDestinationEvents(e){e.removeAllListeners(Cn.ON_TRACK),e.removeAllListeners(Cn.ON_NODE)}bindProcessorContextEvents(e){e.on(oi.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}unbindProcessorContextEvents(e){e.removeAllListeners(oi.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof yf&&(this._trackSource=new P0(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){const e=new G0(this._source.context,this.getTrackId(),"local"),t=new B0(e);return this._processorContext=e,this._processorDestination=t,this.bindProcessorContextEvents(e),this.bindProcessorDestinationEvents(t),this._source.on(pi.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:e})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(Bn.stop(this.getTrackId()),this._source.play()),Ue(this,W.NEED_REPLACE_MIXING_TRACK,this).then(()=>{f.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(n=>{f.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),n)})),{processorContext:e,processorDestination:t}}}).prototype,"setVolume",[$S],Object.getOwnPropertyDescriptor(Je.prototype,"setVolume"),Je.prototype),Ee(Je.prototype,"setPlaybackDevice",[qS,JS],Object.getOwnPropertyDescriptor(Je.prototype,"setPlaybackDevice"),Je.prototype),Ee(Je.prototype,"setEnabled",[XS,QS,ZS],Object.getOwnPropertyDescriptor(Je.prototype,"setEnabled"),Je.prototype),Ee(Je.prototype,"setMuted",[eT,tT,nT],Object.getOwnPropertyDescriptor(Je.prototype,"setMuted"),Je.prototype),Ee(Je.prototype,"getStats",[iT],Object.getOwnPropertyDescriptor(Je.prototype,"getStats"),Je.prototype),Ee(Je.prototype,"setAudioFrameCallback",[rT],Object.getOwnPropertyDescriptor(Je.prototype,"setAudioFrameCallback"),Je.prototype),Ee(Je.prototype,"play",[oT,sT],Object.getOwnPropertyDescriptor(Je.prototype,"play"),Je.prototype),Ee(Je.prototype,"stop",[aT,cT],Object.getOwnPropertyDescriptor(Je.prototype,"stop"),Je.prototype),Ee(Je.prototype,"close",[dT],Object.getOwnPropertyDescriptor(Je.prototype,"close"),Je.prototype),Ee(Je.prototype,"pipe",[lT],Object.getOwnPropertyDescriptor(Je.prototype,"pipe"),Je.prototype),Ee(Je.prototype,"unpipe",[uT],Object.getOwnPropertyDescriptor(Je.prototype,"unpipe"),Je.prototype),Je),$E=(hT=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),pT=lt(),_T=Aa("MicrophoneAudioTrack","_enabledMutex"),fT=Z({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),ET=lt(),mT=Z({argsMap:e=>[e.getTrackId()]}),Ee((hr=class extends St{get __className__(){return"MicrophoneAudioTrack"}constructor(e,t,n,i){super(e,t.encoderConfig?A0(t.encoderConfig):{},i,A("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),k(this,"_config",void 0),k(this,"_deviceName","default"),k(this,"_constraints",void 0),k(this,"_originalConstraints",void 0),k(this,"_enabled",!0),this._config=t,this._constraints=n,this._originalConstraints=n,this._deviceName=e.label,typeof t.bypassWebAudio=="boolean"&&(this._bypassWebAudio=t.bypassWebAudio),(ya()||cf())&&Oe.bindInterruptDetectorTrack(this)}async setDevice(e){if(f.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{const t=await Rr.getDeviceById(e),n={};n.audio=Ze({},this._constraints),n.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let i=null;try{i=await Oi(n,this.getTrackId())}catch(r){throw f.error("[".concat(this.getTrackId(),"] setDevice failed"),r.toString()),i=await Oi({audio:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!1),this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw f.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}else try{const t=await Rr.getDeviceById(e);this._deviceName=t.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(t){throw f.error("[".concat(this.getTrackId(),"] setDevice error"),t.toString()),t}f.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))}async setEnabled(e,t,n){if(t)return f.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),await super._setEnabled(e);if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(f.info("[".concat(this.getTrackId(),"] start setEnabled"),e),A("AUTO_RESET_AUDIO_ROUTE")&&(dn()||nr())){const s=navigator.audioSession;s&&(e||(s.type="playback"),s.type="auto")}if(!e){var i;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(i=this._source.clonedTrack)===null||i===void 0||i.stop(),n||(this._enabled=!1);try{await Ue(this,W.NEED_DISABLE_TRACK,this)}catch(s){throw f.error("[".concat(this.getTrackId(),"] setEnabled false failed"),s.toString()),s}return}const r=Ze({},this._constraints),o=Rr.searchDeviceIdByName(this._deviceName);o&&!r.deviceId&&(r.deviceId=o);try{n||(this._enabled=!0);const s=await Oi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(s.getAudioTracks()[0],!1),await Ue(this,W.NEED_ENABLE_TRACK,this)}catch(s){throw n||(this._enabled=!1),f.error("[".concat(this.getTrackId(),"] setEnabled true failed"),s.toString()),s}f.info("[".concat(this.getTrackId(),"] setEnabled success"))}close(){super.close(),(ya()||cf())&&Oe.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((dn()||nr())&&this._enabled&&!this._isClosed&&Oe.duringInterruption){const e=async()=>{Oe.off(Kt.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(f.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Oe.on(Kt.IOS_INTERRUPTION_END,e)}else f.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ka.TRACK_ENDED)}async renewMediaStreamTrack(e){const t=e||this._constraints,n=Rr.searchDeviceIdByName(this._deviceName);if(n&&!t.deviceId&&(t.deviceId=n),this._constraints=t,this._enabled){this._originMediaStreamTrack.stop();const i=await Oi({audio:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getAudioTracks()[0],!0)}}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(oi.REQUEST_UPDATE_CONSTRAINTS,async(t,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}})}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(oi.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[hT,pT],Object.getOwnPropertyDescriptor(hr.prototype,"setDevice"),hr.prototype),Ee(hr.prototype,"setEnabled",[_T,fT,ET],Object.getOwnPropertyDescriptor(hr.prototype,"setEnabled"),hr.prototype),Ee(hr.prototype,"close",[mT],Object.getOwnPropertyDescriptor(hr.prototype,"close"),hr.prototype),hr);gT=Z({argsMap:(e,t)=>[e.getTrackId(),t,e.duration]}),ST=lt(),TT=Z({argsMap:e=>[e.getTrackId()]}),RT=lt(),CT=Z({argsMap:e=>[e.getTrackId()]}),vT=lt(),IT=Z({argsMap:e=>[e.getTrackId()]}),yT=lt(),AT=Z({argsMap:e=>[e.getTrackId()]}),wT=lt(),NT=Z({argsMap:e=>[e.getTrackId()]}),OT=Z({argsMap:e=>[e.getTrackId()]}),bT=lt(),Ee(($t=class extends St{get __className__(){return"BufferSourceAudioTrack"}constructor(e,t,n,i){super(t.createOutputTrack(),n,i),k(this,"source",void 0),k(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=e,this._bufferSource=t,this._bufferSource.on(pi.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(Ka.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(e){e&&this._bufferSource.updateOptions(e),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(e){this._bufferSource.seekAudioBuffer(e)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(e){De(e,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(e)}}).prototype,"startProcessAudioBuffer",[gT,ST],Object.getOwnPropertyDescriptor($t.prototype,"startProcessAudioBuffer"),$t.prototype),Ee($t.prototype,"pauseProcessAudioBuffer",[TT,RT],Object.getOwnPropertyDescriptor($t.prototype,"pauseProcessAudioBuffer"),$t.prototype),Ee($t.prototype,"seekAudioBuffer",[CT,vT],Object.getOwnPropertyDescriptor($t.prototype,"seekAudioBuffer"),$t.prototype),Ee($t.prototype,"resumeProcessAudioBuffer",[IT,yT],Object.getOwnPropertyDescriptor($t.prototype,"resumeProcessAudioBuffer"),$t.prototype),Ee($t.prototype,"stopProcessAudioBuffer",[AT,wT],Object.getOwnPropertyDescriptor($t.prototype,"stopProcessAudioBuffer"),$t.prototype),Ee($t.prototype,"close",[NT],Object.getOwnPropertyDescriptor($t.prototype,"close"),$t.prototype),Ee($t.prototype,"setAudioBufferPlaybackSpeed",[OT,bT],Object.getOwnPropertyDescriptor($t.prototype,"setAudioBufferPlaybackSpeed"),$t.prototype);let Ot=class K0 extends St{get __className__(){return"MixingAudioTrack"}get isActive(){for(const t of this.trackList)if(t._enabled&&!t._isClosed&&!t.muted)return!0;return!1}constructor(){const t=Md().createMediaStreamDestination();super(t.stream.getAudioTracks()[0],void 0,et(8,"track-mix-")),k(this,"trackList",void 0),k(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=t,this.trackList=[]}hasAudioTrack(t){return this.trackList.indexOf(t)!==-1}addAudioTrack(t){this.trackList.indexOf(t)===-1?(f.debug("add ".concat(t.getTrackId()," to mixing track")),t._source.outputNode.connect(this.destNode),this.trackList.push(t),this.updateEncoderConfig()):f.debug("track ".concat(t.getTrackId()," is already added"))}removeAudioTrack(t){if(this.trackList.indexOf(t)!==-1){f.debug("remove ".concat(t.getTrackId()," from mixing track"));try{t._source.outputNode.disconnect(this.destNode)}catch{}Ou(this.trackList,t),this.updateEncoderConfig()}}updateEncoderConfig(){const t={};this.trackList.forEach(n=>{n._encoderConfig&&((n._encoderConfig.bitrate||0)>(t.bitrate||0)&&(t.bitrate=n._encoderConfig.bitrate),(n._encoderConfig.sampleRate||0)>(t.sampleRate||0)&&(t.sampleRate=n._encoderConfig.sampleRate),(n._encoderConfig.sampleSize||0)>(t.sampleSize||0)&&(t.sampleSize=n._encoderConfig.sampleSize),n._encoderConfig.stereo&&(t.stereo=!0))}),this._encoderConfig=t}_updateRtpTransceiver(t){this._rtpTransceiver!==t&&(this._rtpTransceiver=t,this.trackList.forEach(n=>{n instanceof K0?n.emit(ls.TRANSCEIVER_UPDATED,t):n._updateRtpTransceiver(t)}))}},qE=class{get rendFrameRate(){if(this.renderStats&&this.renderStats.curTs!==this.renderStats.lastTs){const t=this.renderStats.curTs-this.renderStats.lastTs,n=(this.renderStats.renderNum-this.renderStats.lastRenderNum)/t;return this.renderStats.lastRenderNum=this.renderStats.renderNum,this.renderStats.lastTs=this.renderStats.curTs,n}return 0}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(t){t!==this._videoElementStatus&&(f.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(t)),this._videoElementStatus=t)}get videoState(){return this._videoState}set videoState(t){var n;t!==this._videoState&&(this._videoState=t,(n=this.onVideoStateChanged)===null||n===void 0||n.call(this,this.videoState))}constructor(t){k(this,"trackId",void 0),k(this,"config",void 0),k(this,"onFirstVideoFrameDecoded",void 0),k(this,"onVideoStateChanged",void 0),k(this,"freezeTimeCounterList",[]),k(this,"renderFreezeAccTime",0),k(this,"isKeepLastFrame",!1),k(this,"timeUpdatedCount",0),k(this,"freezeTime",0),k(this,"playbackTime",0),k(this,"lastTimeUpdatedTime",0),k(this,"autoplayFailed",!1),k(this,"videoTrack",void 0),k(this,"videoElement",void 0),k(this,"cacheVideoElement",void 0),k(this,"renderStats",void 0),k(this,"_videoState",ur.VideoStateStopped),k(this,"videoElementCheckInterval",void 0),k(this,"videoElementFreezeTimeout",void 0),k(this,"_videoElementStatus",hn.NONE),k(this,"isGettingVideoDimensions",!1),k(this,"startGetVideoDimensions",()=>{const n=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return f.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(n,500)};!this.isGettingVideoDimensions&&n()}),k(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Oe.curState==="running"&&(f.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(jg())),Hg()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),k(this,"handleVideoEvents",n=>{switch(n.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=hn.PLAYING;break;case"loadeddata":if(this.videoState=ur.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=hn.CANPLAY;break;case"stalled":this.videoElementStatus=hn.STALLED;break;case"suspend":this.videoElementStatus=hn.SUSPEND;break;case"pause":this.videoElementStatus=hn.PAUSED,dn()||nr()||Gt()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(f.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=hn.WAITING;break;case"abort":this.videoElementStatus=hn.ABORT;break;case"ended":this.videoElementStatus=hn.ENDED;break;case"emptied":this.videoElementStatus=hn.EMPTIED;break;case"error":{const i=this.videoElement.error;i?(this.videoElementStatus=hn.ERROR,f.error("[".concat(this.trackId,"] media error: ").concat(i.message," (").concat(i.code,")"))):f.debug("[".concat(this.trackId,"] media not been an error."));break}case"timeupdate":{const i=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=i);const r=i-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=i,Lr.lastVisibleTime<Lr.lastHiddenTime||o<Lr.lastHiddenTime||o<Lr.lastVisibleTime)return;for(r>A("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;const s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),k(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(f.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(jg())),Hg()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=t.trackId,this.config=t,t.element instanceof HTMLVideoElement?this.videoElement=t.element:this.videoElement=document.createElement("video"),Oe.on(Kt.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Oe.on(Kt.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var t;return(t=this.videoElement.parentElement)!==null&&t!==void 0?t:void 0}updateConfig(t){this.config=t,this.trackId=t.trackId,t.element!==this.videoElement&&(this.destroy(),this.videoElement=t.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.initVideoElement())}play(t){const n=this.videoElement.play();n&&n.catch&&n.catch(r=>{t&&x0(t,"video",r.message,this.trackId),r.name==="NotAllowedError"?(f.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):f.warning("[".concat(this.trackId,"] play warning: "),r)});const i=Ie();if((i.name==="Safari"&&Number(i.version)===15||ya())&&n&&n.then){const r=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};n.then(r).catch(r)}}getCurrentFrame(){const t=document.createElement("canvas");t.width=this.videoElement.videoWidth,t.height=this.videoElement.videoHeight;const n=t.getContext("2d");if(!n)return f.error("create canvas context failed!"),new ImageData(2,2);n.drawImage(this.videoElement,0,0,t.width,t.height);const i=n.getImageData(0,0,t.width,t.height);return t.remove(),i}async getCurrentFrameToUint8Array(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;const i=document.createElement("canvas");i.width=this.videoElement.videoWidth,i.height=this.videoElement.videoHeight;const r=i.getContext("2d");return r?(r.drawImage(this.videoElement,0,0,i.width,i.height),new Promise((o,s)=>{i.toBlob(async a=>{if(i.remove(),a){const c=await H0(a);o({buffer:c,width:i.width,height:i.height})}else s(new L(C.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))},t,n<0?.1:n>1?1:n)})):await YE(t)}destroy(){this.renderStats=void 0,Oe.off(Kt.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Oe.off(Kt.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=ur.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=hn.INIT,!this.videoElementCheckInterval&&(DT.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{RP(this.videoElement)||(this.videoElementStatus=hn.DESTROYED)},1e3),A("ENABLE_VIDEO_FRAME_CALLBACK"))){var t,n;let o;const s=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",s),this.videoElementFreezeTimeout=window.setTimeout(a,A("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===ur.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=ur.VideoStateFrozen:document.addEventListener("visibilitychange",s))},c=(d,l)=>{if(this.videoElementStatus===hn.PLAYING){if(this.renderStats?(this.renderStats.renderNum++,this.renderStats.curTs=l.mediaTime):this.renderStats={lastTs:l.mediaTime,curTs:l.mediaTime,lastRenderNum:0,renderNum:0},o){const p=l.presentationTime-o.presentationTime;this.videoState===ur.VideoStateStarting&&(this.videoState=ur.VideoStateDecoding),this.videoState===ur.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,A("VIDEO_FREEZE_DURATION"))),p<A("VIDEO_FREEZE_DURATION")&&this.videoState===ur.VideoStateFrozen&&(this.videoState=ur.VideoStateDecoding),p>A("VIDEO_FREEZE_DURATION")&&Lr.lastVisibleTime>=Lr.lastHiddenTime&&o.timestamp>Lr.lastVisibleTime&&o.timestamp>Lr.lastHiddenTime&&(this.renderFreezeAccTime+=p)}o=Ze(Ze({},l),{},{timestamp:d})}var u,h;A("ENABLE_VIDEO_FRAME_CALLBACK")&&((u=(h=this.videoElement).requestVideoFrameCallback)===null||u===void 0||u.call(h,c))};(t=(n=this.videoElement).requestVideoFrameCallback)===null||t===void 0||t.call(n,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),uh()&&!A("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");const i=Ie();i.name==="Safari"&&Number(i.version)===15||ya()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Me()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,Me()&&this.videoElement.load());const r=this.videoElement.play();r!==void 0&&r.catch(o=>{f.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){DT.forEach(t=>{this.videoElement&&this.videoElement.removeEventListener(t,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=hn.NONE}handleAutoPlayFailed(){const t=n=>{n.preventDefault(),this.videoElement.play().then(()=>{f.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(i=>{f.error(i)}),this.autoplayFailed=!1,od()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};od()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),U0()}};const DT=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];let z0=class extends qE{constructor(t){super(t),k(this,"container",void 0),k(this,"slot",void 0),this.slot=t.element,this.updateConfig(t)}updateConfig(t){this.config=t,this.trackId=t.trackId;const n=t.element;n!==this.slot&&(this.destroy(),this.slot=n),this.createElements()}updateVideoTrack(t){this.videoTrack!==t&&(this.videoTrack=t,this.createElements())}play(t){var n;(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)&&super.play(t)}getCurrentFrame(){var t;return(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameToUint8Array(t){var n;let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?await super.getCurrentFrameToUint8Array(t,i):await YE(t)}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",A("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var t;!this.container||(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var t;if((t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var t;(t=this.container)!==null&&t!==void 0&&t.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}};var PT,LT,kT,MT,UT,xT,VT,FT,BT,GT,jT,WT,HT,KT,zT,YT,$T,qT,JT,XT,QT,ZT,eR,tR,nR,pe,iR,rR,oR,sR,aR,cR,dR,lR,Yn;let Ge=(PT=Z({argsMap:(e,t,n)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),LT=lt(),kT=Z({argsMap:e=>[e.getTrackId()]}),MT=Aa("LocalVideoTrack","_enabledMutex"),UT=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),xT=lt(),VT=Aa("LocalVideoTrack","_enabledMutex"),FT=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),BT=lt(),GT=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),jT=lt(),WT=lt(),HT=Z({argsMap:(e,t,n)=>[e.getTrackId(),t,n]}),KT=lt(),zT=lt(),YT=lt(),$T=lt(),qT=lt(),JT=lt(),XT=lt(),QT=Z({argsMap:(e,t)=>[e.getTrackId(),t.name]}),ZT=Z({argsMap:e=>[e.getTrackId()]}),eR=Z({argsMap:e=>[e.getTrackId()]}),tR=Z({argsMap:(e,t,n)=>[e.getTrackId(),t.label,n]}),nR=Z(),pe=class Y0 extends ia{get videoHeight(){if(Gt()){const{height:t}=this._mediaStreamTrack.getSettings();return this._videoHeight=t,this._videoHeight}return this._videoHeight}get videoWidth(){if(Gt()){const{width:t}=this._mediaStreamTrack.getSettings();return this._videoWidth=t,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==hn.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(t){this._processorContext=t}get __className__(){return"LocalVideoTrack"}constructor(t,n,i,r,o,s){if(super(t,o),k(this,"trackMediaType","video"),k(this,"_player",void 0),k(this,"isUseScaleResolutionDownBy",!1),k(this,"_videoVisibleTimer",null),k(this,"_statsTimer",null),k(this,"_previousVideoVisibleStatus",void 0),k(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),k(this,"_encoderConfig",void 0),k(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),k(this,"_optimizationMode",void 0),k(this,"_videoHeight",void 0),k(this,"_videoWidth",void 0),k(this,"_forceBitrateLimit",void 0),k(this,"_enabled",!0),k(this,"_processorDestination",void 0),k(this,"_processorContext",void 0),Gt()){const{width:a,height:c}=t.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._encoderConfig=n,this._scalabilityMode=i,this._optimizationMode=r,this._hints=s||[],this._hints.indexOf(je.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(ZD(Ke.CHROME,115)&&oP()){const a=Y1(t);a&&(f.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}n&&this._hints.indexOf(je.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(n),this._processorContext=new F0(this.getTrackId(),"local"),this._processorDestination=new V0(this.processorContext),this.bindProcessorDestinationEvents()}play(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){const r=document.getElementById(t);r?t=r:(f.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}f.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(n));const i=Ze(Ze(Ze({},this._getDefaultPlayerConfig()),n),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new qE(i):this._player=new z0(i),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const r=this.getVideoElementVisibleStatus();this.safeEmit(Ka.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},A("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._statsTimer&&(this.isUseScaleResolutionDownBy=!1,window.clearInterval(this._statsTimer),this._statsTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,f.debug("[".concat(this.getTrackId(),"] stop video playback")))}async setEnabled(t,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(f.info("[".concat(this.getTrackId(),"] start setEnabled"),t),!t){this._originMediaStreamTrack.enabled=!1;try{await Ue(this,W.NEED_DISABLE_TRACK,this)}catch(i){throw f.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}return n||(this._enabled=!1),void f.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{await Ue(this,W.NEED_ENABLE_TRACK,this)}catch(i){throw f.error("[".concat(this.getTrackId(),"] setEnabled to true error"),i.toString()),i}f.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}async setMuted(t){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,f.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?await Ue(this,W.NEED_MUTE_TRACK,this):await Ue(this,W.NEED_UNMUTE_TRACK,this))}async setEncoderConfiguration(t,n){if(!this._enabled)throw new L(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=jr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),t.width||t.height||t.frameRate){const i=zE({encoderConfig:t});(Gt()||dn()||nr())&&(i.deviceId=void 0),f.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(i));try{await this._originMediaStreamTrack.applyConstraints(i),this.updateMediaStreamTrackResolution()}catch(r){const o=new L(C.UNEXPECTED_ERROR,r.toString());throw f.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=t,this._hints.indexOf(je.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ue(this,W.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(f)}}getStats(){return Mo(()=>{f.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Gn(this,W.GET_STATS)||Ze({},vf)}async setBeautyEffect(t){f.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}async getCurrentFrameImage(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(t,n):await YE(t)}async setBitrateLimit(t){if(f.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(t))),t){this._forceBitrateLimit=t,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<t.max_bitrate?this._encoderConfig.bitrateMax:t.max_bitrate:this._encoderConfig.bitrateMax=t.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=t.min_bitrate);try{await Ue(this,W.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(f)}}}async setOptimizationMode(t){if(t!=="motion"&&t!=="detail"&&t!=="balanced")return void f.error(C.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");const n=this._optimizationMode;try{this._optimizationMode=t,await Ue(this,W.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(i){throw this._optimizationMode=n,f.error("[".concat(this.getTrackId(),"] set optimization mode failed"),i.toString()),i}f.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(t,")"))}setScalabiltyMode(t){if(t.numSpatialLayers===1&&t.numTemporalLayers!==1)return f.error(C.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=t,f.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(t,")"))}updateMediaStreamTrackResolution(){j0(this._originMediaStreamTrack).then(t=>{let[n,i]=t;this._videoHeight=i,this._videoWidth=n}).catch(ph)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}async setSenderConfiguration(t){if(!this._enabled)throw new L(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");f.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(t)),t=jr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:t.bitrateMin),this._encoderConfig=t,this._hints.indexOf(je.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ue(this,W.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(f)}}updateBitrateFromProfile(){if(!this._encoderConfig)return;const{width:t,height:n,frameRate:i}=this.getMediaStreamTrackSettings();if(!t||!n||!i)return;const{bitrateMax:r,bitrateMin:o}=this._encoderConfig;if(o==null||r==null){const{max:s,min:a}=H1(t,n,i,o,r);this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=s,f.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(t,", h: ").concat(n,", fps: ").concat(i,"] => [brMax: ").concat(s,", brMin: ").concat(a,"]"))}}getVideoElementVisibleStatus(){try{var t,n;const i=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),r={track:this,element:this==null||(n=this._player)===null||n===void 0?void 0:n.getVideoElement(),slot:i==null?void 0:i.parentElement},{element:o,slot:s}=r;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){const a=LA.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;const d=q.reportApiInvoke(null,{tag:bt.TRACER,name:an.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(i){throw new L(C.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}async renewMediaStreamTrack(t){}pipe(t){if(this.processor===t)return t;if(t._source)throw new L(C.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;const t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;t&&(i=Ze(Ze({},i),jr(t))),i=ts(i);const r=et(8,"track-video-cloned-"),o=new Y0(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,i,ts(this._scalabilityMode),this._optimizationMode,r,ts(this._hints));return t&&i&&o.setEncoderConfiguration(i),f.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}async replaceTrack(t,n){if(!(t instanceof MediaStreamTrack))throw new L(C.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(t.kind!=="video")throw new L(C.INVALID_PARAMS,"track should be a video MediaStreamTrack");await this._updateOriginMediaStreamTrack(t,n,!0),this.updateMediaStreamTrackResolution()}startMonitorStats(){if(!Gt()&&!dn())return;this._statsTimer&&window.clearInterval(this._statsTimer);let t=2,n=pl[t],i=-1,r=Date.now();const o=s=>{s>2||s<0||(r=Date.now(),n=pl[s],this.setSenderConfiguration(n))};this.isUseScaleResolutionDownBy=!0,this._statsTimer=window.setInterval(()=>{const s=this.getStats(),a=Gn(this,W.GET_RTC_STATS);if(s.sendPackets>0&&a){i===-1&&(i=Date.now());const c=Date.now();if(c-i<1e3||c-r<A("PROFILE_SWITCH_INTERVAL"))return;const d=s.sendFrameRate,l=.6*n.frameRate,u=.9*n.frameRate;typeof d=="number"&&d>0&&d<l?t>0&&(t--,o(t),f.debug("[".concat(this.getTrackId(),"] step down for fps ").concat(d,", switchProfile to ").concat(t))):a.OutgoingAvailableBandwidth<n.bitrateMin?t>0&&(t--,o(t),f.debug("[".concat(this.getTrackId(),"] step down for OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", bitrateMin ").concat(n.bitrateMin,", switchProfile to ").concat(t))):typeof d=="number"&&d>u&&t<pl.length-1&&a.OutgoingAvailableBandwidth>1.2*pl[t+1].bitrateMin&&(t++,o(t),f.debug("[".concat(this.getTrackId(),"] step up for fps ").concat(d,", OutgoingAvailableBandwidth ").concat(a.OutgoingAvailableBandwidth,", switchProfile to ").concat(t)))}},A("CHECK_LOCAL_STATS_INTERVAL"))}sendSeiData(t){if(Mo(()=>{q.reportApiInvoke(null,{name:an.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:bt.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!A("ENABLE_VIDEO_SEI")||!A("ENABLE_ENCODED_TRANSFORM"))return void f.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(!(t instanceof Uint8Array))return new L(C.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();const n=this.getRTCRtpTransceiver();if(!n)return void f.warning("Video track is not published, SEI can not be send");const i=n.sender.getParameters();if(i.codecs.length===0)return;const r=i.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"?this.safeEmit("sei-to-send",t):f.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(Cn.ON_TRACK,async t=>{t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(),await Ue(this,W.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),await Ue(this,W.NEED_REPLACE_TRACK,this))})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Cn.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(oi.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(oi.REQUEST_CONSTRAINTS)}},Ee(pe.prototype,"play",[PT,LT],Object.getOwnPropertyDescriptor(pe.prototype,"play"),pe.prototype),Ee(pe.prototype,"stop",[kT],Object.getOwnPropertyDescriptor(pe.prototype,"stop"),pe.prototype),Ee(pe.prototype,"setEnabled",[MT,UT,xT],Object.getOwnPropertyDescriptor(pe.prototype,"setEnabled"),pe.prototype),Ee(pe.prototype,"setMuted",[VT,FT,BT],Object.getOwnPropertyDescriptor(pe.prototype,"setMuted"),pe.prototype),Ee(pe.prototype,"setEncoderConfiguration",[GT,jT],Object.getOwnPropertyDescriptor(pe.prototype,"setEncoderConfiguration"),pe.prototype),Ee(pe.prototype,"getStats",[WT],Object.getOwnPropertyDescriptor(pe.prototype,"getStats"),pe.prototype),Ee(pe.prototype,"setBeautyEffect",[HT,KT],Object.getOwnPropertyDescriptor(pe.prototype,"setBeautyEffect"),pe.prototype),Ee(pe.prototype,"getCurrentFrameData",[zT],Object.getOwnPropertyDescriptor(pe.prototype,"getCurrentFrameData"),pe.prototype),Ee(pe.prototype,"getCurrentFrameImage",[YT],Object.getOwnPropertyDescriptor(pe.prototype,"getCurrentFrameImage"),pe.prototype),Ee(pe.prototype,"setBitrateLimit",[$T],Object.getOwnPropertyDescriptor(pe.prototype,"setBitrateLimit"),pe.prototype),Ee(pe.prototype,"setOptimizationMode",[qT],Object.getOwnPropertyDescriptor(pe.prototype,"setOptimizationMode"),pe.prototype),Ee(pe.prototype,"setScalabiltyMode",[JT],Object.getOwnPropertyDescriptor(pe.prototype,"setScalabiltyMode"),pe.prototype),Ee(pe.prototype,"updateMediaStreamTrackResolution",[XT],Object.getOwnPropertyDescriptor(pe.prototype,"updateMediaStreamTrackResolution"),pe.prototype),Ee(pe.prototype,"pipe",[QT],Object.getOwnPropertyDescriptor(pe.prototype,"pipe"),pe.prototype),Ee(pe.prototype,"unpipe",[ZT],Object.getOwnPropertyDescriptor(pe.prototype,"unpipe"),pe.prototype),Ee(pe.prototype,"close",[eR],Object.getOwnPropertyDescriptor(pe.prototype,"close"),pe.prototype),Ee(pe.prototype,"replaceTrack",[tR],Object.getOwnPropertyDescriptor(pe.prototype,"replaceTrack"),pe.prototype),Ee(pe.prototype,"startMonitorStats",[nR],Object.getOwnPropertyDescriptor(pe.prototype,"startMonitorStats"),pe.prototype),pe),$0=(iR=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),rR=lt(),oR=Aa("CameraVideoTrack","_enabledMutex"),sR=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),aR=lt(),cR=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),dR=lt(),lR=Z({argsMap:e=>[e.getTrackId()]}),Yn=class q0 extends Ge{get __className__(){return"CameraVideoTrack"}constructor(t,n,i,r,o,s){super(t,jr(n.encoderConfig),r,o,s),k(this,"_config",void 0),k(this,"_originalConstraints",void 0),k(this,"_constraints",void 0),k(this,"_enabled",!0),k(this,"_deviceName","default"),k(this,"tryResumeVideoForIOS15_16WeChat",async()=>{(ya()||cf())&&!iP()&&rP()&&this._enabled&&!this._isClosed&&(f.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),await this.renewMediaStreamTrack())}),this._config=n,this._originalConstraints=i,this._constraints=i,this._deviceName=t.label,this._encoderConfig=jr(this._config.encoderConfig),Oe.on(Kt.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Oe.on(Kt.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}async setDevice(t){return typeof t=="string"?this._setDeviceById(t):t.deviceId?this._setDeviceById(t.deviceId):t.facingMode?this._setDeviceByFacingModel(t.facingMode):void 0}async _setDeviceById(t){if(f.info("[".concat(this.getTrackId(),"] set device to ").concat(t)),this._enabled)try{const n=await Rr.getDeviceById(t),i={};i.video=Ze({},this._constraints),i.video.deviceId={exact:t},i.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=await Oi(i,this.getTrackId())}catch(o){throw f.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),r=await Oi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),o}await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=n.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(n){throw f.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}else try{const n=await Rr.getDeviceById(t);this._deviceName=n.label,this._config.cameraId=t,this._constraints.deviceId={exact:t}}catch(n){throw f.error("[".concat(this.getTrackId(),"] setDevice error"),n.toString()),n}f.info("[".concat(this.getTrackId(),"] setDevice success"))}async _setDeviceByFacingModel(t){f.info("[".concat(this.getTrackId(),"] set facingMode ").concat(t));const n={video:Ze(Ze({},this._constraints),{},{deviceId:void 0,facingMode:{exact:t}})};if(this._enabled){this._originMediaStreamTrack.stop();let i=null;try{i=await Oi(n,this.getTrackId())}catch(r){throw f.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),i=await Oi({video:this._constraints},this.getTrackId()),await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),r}await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=t,this._config.cameraId=void 0,this._constraints=Ze({},n.video),f.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))}async setEnabled(t,n){if(!n){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(f.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{const i=await Oi({video:this._constraints},this.getTrackId());await this._updateOriginMediaStreamTrack(i.getVideoTracks()[0],!1)}await Ue(this,W.NEED_ENABLE_TRACK,this)}catch(i){throw f.error("[".concat(this.getTrackId(),"] setEnabled true error"),i.toString()),i}this.updateMediaStreamTrackResolution(),f.info("[".concat(this.getTrackId(),"] setEnabled to true success")),n||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),n||(this._enabled=!1);try{await Ue(this,W.NEED_DISABLE_TRACK,this)}catch(i){throw f.error("[".concat(this.getTrackId(),"] setEnabled to false error"),i.toString()),i}f.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}}async setEncoderConfiguration(t,n){if(!this._enabled)throw new L(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");t==="720p_auto"?this.startMonitorStats():this._statsTimer&&(window.clearInterval(this._statsTimer),this._statsTimer=null),t=jr(t),this._forceBitrateLimit&&(t.bitrateMax=this._forceBitrateLimit.max_bitrate||t.bitrateMax,t.bitrateMin=this._forceBitrateLimit.min_bitrate||t.bitrateMin);const i=xe(this._config);i.encoderConfig=t;const r=zE(i);(Gt()||dn()||nr())&&(r.deviceId=void 0),f.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(t),JSON.stringify(r));try{await this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(o){const s=new L(C.UNEXPECTED_ERROR,o.toString());throw f.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}this._config=i,this._constraints=r,this._originalConstraints=r,this._encoderConfig=t,this._hints.indexOf(je.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{await Ue(this,W.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(f)}}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((dn()||nr())&&this._enabled&&!this._isClosed&&Oe.duringInterruption){const t=async()=>{Oe.off(Kt.IOS_INTERRUPTION_END,t),this._enabled&&!this._isClosed&&(f.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),await this.setEnabled(!1),await this.setEnabled(!0))};Oe.on(Kt.IOS_INTERRUPTION_END,t)}else f.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(Ka.TRACK_ENDED)}async renewMediaStreamTrack(t){const n=t||this._constraints,i=Rr.searchDeviceIdByName(this._deviceName);if(i&&!n.deviceId&&(n.deviceId={exact:i}),this._enabled){const r=await Oi({video:n},this.getTrackId());this._constraints=n,await this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}}close(){super.close(),Oe.off(Kt.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Oe.off(Kt.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],i=this._encoderConfig;t&&(i=Ze(Ze({},i),jr(t))),i=ts(i);const r=et(8,"track-cam-cloned-"),o=new q0(n?this._mediaStreamTrack.clone():this._mediaStreamTrack,ts(Ze(Ze({},this._config),{},{encoderConfig:i})),ts(this._constraints),ts(this._scalabilityMode),this._optimizationMode,r);return t&&i&&o.setEncoderConfiguration(i),f.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(n)),o}bindProcessorContextEvents(){this.processorContext.on(oi.REQUEST_UPDATE_CONSTRAINTS,async(t,n,i)=>{try{const r=Object.assign({},this._originalConstraints,...t);await this.renewMediaStreamTrack(r),n()}catch(r){i(r)}}),this.processorContext.on(oi.REQUEST_CONSTRAINTS,async t=>{t(this._originMediaStreamTrack.getSettings())})}},Ee(Yn.prototype,"setDevice",[iR,rR],Object.getOwnPropertyDescriptor(Yn.prototype,"setDevice"),Yn.prototype),Ee(Yn.prototype,"setEnabled",[oR,sR,aR],Object.getOwnPropertyDescriptor(Yn.prototype,"setEnabled"),Yn.prototype),Ee(Yn.prototype,"setEncoderConfiguration",[cR,dR],Object.getOwnPropertyDescriptor(Yn.prototype,"setEncoderConfiguration"),Yn.prototype),Ee(Yn.prototype,"close",[lR],Object.getOwnPropertyDescriptor(Yn.prototype,"close"),Yn.prototype),Yn);async function $1(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=q.reportApiInvoke(null,{tag:bt.TRACER,name:an.CREATE_MIC_AUDIO_TRACK,options:[e]}),n=W1(e),i=et(8,"track-mic-");let r=null;f.info("start create microphone audio track with config",JSON.stringify(e),"trackId",i);try{r=(await Oi({audio:n},i)).getAudioTracks()[0]||null}catch(s){throw t.onError(s),s}if(!r){const s=new L(C.UNEXPECTED_ERROR,"can not find track in media stream");return t.onError(s),s.throw(f)}const o=new $E(r,e,n,i);return t.onSuccess(o.getTrackId()),f.info("create microphone audio track success, trackId:",i),o}async function q1(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};const t=A("CAMERA_CAPTURE_CONFIG"),n=q.reportApiInvoke(null,{tag:bt.TRACER,name:an.CREATE_CAM_VIDEO_TRACK,options:[Ze({},e),t]});t&&(e.encoderConfig=t);const i=zE(e),r=et(8,"track-cam-");let o=null;const s=e.encoderConfig==="720p_auto";f.info("start create camera video track with config",JSON.stringify(e),"trackId",r);try{o=(await Oi({video:i},r)).getVideoTracks()[0]||null}catch(c){throw n.onError(c),c}if(!o){const c=new L(C.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(c),c.throw(f)}e.optimizationMode&&J1(r,o,e,jr(e.encoderConfig));const a=new $0(o,e,i,e.scalabiltyMode?w1(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return s&&a.startMonitorStats(),n.onSuccess(a.getTrackId()),f.info("create camera video success, trackId:",r),a}function J1(e,t,n,i){n.optimizationMode&&(i&&i.width&&i.height?(n.encoderConfig=Ze(Ze({},i),{},{bitrateMin:i.bitrateMin,bitrateMax:i.bitrateMax}),n.optimizationMode!=="motion"&&n.optimizationMode!=="detail"||(t.contentHint=n.optimizationMode,t.contentHint===n.optimizationMode?f.debug("[".concat(e,"] set content hint to"),n.optimizationMode):f.debug("[".concat(e,"] set content hint failed")))):f.warning("[".concat(e,"] can not apply optimization mode bitrate config, no encoderConfig")))}var uR,hR,pR,_R,si,fR,ER,mR,gR,SR,TR,un;let J0=class extends O0{getUserId(){return this._userId}constructor(t,n,i,r){super(t,"track-".concat(t.kind,"-").concat(n,"-").concat(r.clientId,"_").concat(et(5,""))),k(this,"_userId",void 0),k(this,"_uintId",void 0),k(this,"_isDestroyed",!1),k(this,"store",void 0),k(this,"processor",void 0),k(this,"processorContext",void 0),this._userId=n,this._uintId=i,this.store=r}_updateOriginMediaStreamTrack(t){this._originMediaStreamTrack=t,this._mediaStreamTrack=t,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,f.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}},Vc=(uR=Z({argsMap:(e,t,n)=>[e.getTrackId(),typeof t=="string"?t:t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",n]}),hR=Z({argsMap:e=>[e.getTrackId()]}),pR=Z({argsMap:(e,t)=>[e.getTrackId(),t.name]}),_R=Z({argsMap:e=>[e.getTrackId()]}),Ee((si=class extends J0{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==hn.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(e,t,n,i){super(e,t,n,i),k(this,"_videoVisibleTimer",null),k(this,"_previousVideoVisibleStatus",void 0),k(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),k(this,"trackMediaType","video"),k(this,"_videoWidth",void 0),k(this,"_videoHeight",void 0),k(this,"_player",void 0),k(this,"processorDestination",void 0),k(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new F0(this.getTrackId(),"remote"),this.processorDestination=new V0(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Mo(()=>{f.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Gn(this,W.GET_STATS)||Ze({},N0)}play(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){const i=document.getElementById(e);i?e=i:(f.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}f.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(t));const n=Ze(Ze({fit:"cover"},t),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(n):(e instanceof HTMLVideoElement?this._player=new qE(n):this._player=new z0(n),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(_a.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=i=>{this.safeEmit(_a.VIDEO_STATE_CHANGED,i)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{const i=this.getVideoElementVisibleStatus();this.safeEmit(_a.VIDEO_ELEMENT_VISIBLE_STATUS,i)}catch{}},A("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,f.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){j0(this._originMediaStreamTrack).then(e=>{let[t,n]=e;this._videoHeight=n,this._videoWidth=t}).catch(ph)}_updatePlayerSource(){f.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var e,t;const n=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),i={track:this,element:this==null||(t=this._player)===null||t===void 0?void 0:t.getVideoElement(),slot:n==null?void 0:n.parentElement},{element:r,slot:o}=i;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){const s=LA.checkOneElementVisible(r),a=Object.assign({},s);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;const c=q.reportApiInvoke(null,{tag:bt.TRACER,name:an.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(n){throw new L(C.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}pipe(e){if(this.processor===e)return e;if(e._source)throw new L(C.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;const e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Cn.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Cn.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(e){this.emit(ls.SEI_RECEIVED,e)}}).prototype,"play",[uR],Object.getOwnPropertyDescriptor(si.prototype,"play"),si.prototype),Ee(si.prototype,"stop",[hR],Object.getOwnPropertyDescriptor(si.prototype,"stop"),si.prototype),Ee(si.prototype,"pipe",[pR],Object.getOwnPropertyDescriptor(si.prototype,"pipe"),si.prototype),Ee(si.prototype,"unpipe",[_R],Object.getOwnPropertyDescriptor(si.prototype,"unpipe"),si.prototype),si),Fc=(fR=Z({argsMap:(e,t)=>[e.getTrackId(),t],throttleTime:300}),ER=Z({argsMap:(e,t)=>[e.getTrackId(),t]}),mR=Z({argsMap:e=>[e.getTrackId()]}),gR=Z({argsMap:e=>[e.getTrackId()]}),SR=Z({argsMap:(e,t)=>[e.getTrackId(),t.name]}),TR=Z({argsMap:e=>[e.getTrackId()]}),Ee((un=class extends J0{get isPlaying(){return this._useAudioElement?Bn.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(e,t,n,i){super(e,t,n,i),k(this,"trackMediaType","audio"),k(this,"_source",void 0),k(this,"_useAudioElement",!0),k(this,"_volume",100),k(this,"processorContext",void 0),k(this,"processorDestination",void 0),k(this,"_played",!1),k(this,"_bypassWebAudio",!1),A("DISABLE_WEBAUDIO")?(this._source=new yf,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new P0(e,!0),A("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once(pi.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(_a.FIRST_FRAME_DECODED)}),this.processorContext=new G0(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new B0(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on(pi.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!e)return this._source.removeAllListeners(pi.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(t),this._source.removeAllListeners(pi.ON_AUDIO_BUFFER),this._source.on(pi.ON_AUDIO_BUFFER,n=>e(n))}setVolume(e){this._volume=e,this._useAudioElement?Bn.setVolume(this.getTrackId(),e):this._source.setVolume(e/100)}async setPlaybackDevice(e){if(!this._useAudioElement||!y0())throw new L(C.NOT_SUPPORTED,"your browser does not support setting the audio output device");await Bn.setSinkID(this.getTrackId(),e)}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Mo(()=>{f.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Gn(this,W.GET_STATS)||Ze({},w0)}play(){f.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(f.debug("[".concat(this.getTrackId(),"] use audio element to play")),Bn.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){f.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Bn.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let e=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];f.debug("[".concat(this.getTrackId(),"] update player source track")),e&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Bn.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(e){if(this._bypassWebAudio)throw new L(C.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===e)return e;if(e._source)throw new L(C.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),e}unpipe(){var e;if(this._bypassWebAudio)throw new L(C.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;const t=this.processor;(e=this._source.processSourceNode)===null||e===void 0||e.disconnect(),this.processor._source=!1,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(Cn.ON_TRACK,async e=>{e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}),this.processorDestination.on(Cn.ON_NODE,e=>{this._source.processedNode=e;const t=!e;this._useAudioElement!==t&&(this._played?(this.stop(),this._useAudioElement=t,this.play()):this._useAudioElement=t)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(Cn.ON_TRACK),this.processorDestination.removeAllListeners(Cn.ON_NODE)}}).prototype,"setVolume",[fR],Object.getOwnPropertyDescriptor(un.prototype,"setVolume"),un.prototype),Ee(un.prototype,"setPlaybackDevice",[ER],Object.getOwnPropertyDescriptor(un.prototype,"setPlaybackDevice"),un.prototype),Ee(un.prototype,"play",[mR],Object.getOwnPropertyDescriptor(un.prototype,"play"),un.prototype),Ee(un.prototype,"stop",[gR],Object.getOwnPropertyDescriptor(un.prototype,"stop"),un.prototype),Ee(un.prototype,"pipe",[SR],Object.getOwnPropertyDescriptor(un.prototype,"pipe"),un.prototype),Ee(un.prototype,"unpipe",[TR],Object.getOwnPropertyDescriptor(un.prototype,"unpipe"),un.prototype),un);const Lr=new class extends qe{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),k(this,"_lastHiddenTime",0),k(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),f.debug("document visibility went ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};var X0=function(e){return e[e.ONE_BYTE=0]="ONE_BYTE",e[e.TWO_BYTE=1]="TWO_BYTE",e}(X0||{});let X1=class{constructor(){k(this,"_sequence",0),k(this,"_startTime",Date.now()),k(this,"isUseOneByte",!0)}get startTime(){const t=Date.now()-this._startTime;return t<Math.pow(2,16)?t:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(t){const n={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:t};if(t.byteLength>128){const a=new Uint8Array(4);a.set([1,0,0,0]);const c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};n.commonPacketHeader.extension=1,n.extension=d,n.payload=this.compress(t),n.commonPacketHeader.length=8+(n.extension.length+2)+n.payload.byteLength}else n.commonPacketHeader.length=8+n.payload.byteLength;A("SHOW_DATASTREAM2_LOG")&&f.debug("send data header: ".concat(JSON.stringify(n.commonPacketHeader)));const i=new ArrayBuffer(n.commonPacketHeader.length),r=new Uint8Array(i),o=new DataView(i);let s=0;if(o.setUint16(s,n.commonPacketHeader.extension<<15|n.commonPacketHeader.reserved<<14|n.commonPacketHeader.length,!0),s+=2,o.setUint32(s,n.commonPacketHeader.sequence,!0),s+=4,o.setUint16(s,n.commonStreamHeader,!0),s+=2,n.extension){const a=this.serializeExtension(n.extension);r.set(new Uint8Array(a),s),s+=a.byteLength}if(r.set(new Uint8Array(n.payload),s),s+=n.payload.byteLength,s!==n.commonPacketHeader.length)throw Error("serialize error!");return i}deserialize(t){if(t.byteLength<4)return new ArrayBuffer(0);const n=new DataView(t);let i=0;const r=n.getUint16(i,!0);i+=2;const o={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:n.getUint16(i+2,!0)<<16|n.getUint16(i,!0)};let s,a;if(i+=4,A("SHOW_DATASTREAM2_LOG")&&f.debug("receive data header: ".concat(JSON.stringify(o))),n.getUint16(i,!0),i+=2,o.extension){a=this.deserializeExtension(t.slice(i)),i+=2+a.length,s=t.slice(i);let c=!1;if(a.datas.length>0){const d=a.datas.find(l=>l.id===0);d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}s=c?this.decompress(s):s}else s=t.slice(8);return s}serializeExtension(t){const{profile:n,length:i,datas:r}=t,o=new ArrayBuffer(i+2),s=new Uint8Array(o),a=new DataView(o);let c=0;if(a.setUint8(c++,n),a.setUint8(c++,i),r.forEach(d=>{n?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==i+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(i+2));return o}deserializeExtension(t){const n=new DataView(t);let i=0;const r=n.getUint8(i);i++;const o=n.getUint8(i);i++;const s=r===X0.TWO_BYTE,a=[],c=new DataView(t,2);let d=0;for(;d<o;){let l=0,u=0,h=new ArrayBuffer(0);s?(l=c.getUint8(d),d++,u=c.getUint8(d),d++):(l=15&c.getUint8(d),u=c.getUint8(d)>>4,d++),u>0&&(h=c.buffer.slice(d+2,d+2+u),d+=h.byteLength),a.push({id:l,length:u,data:h})}if(d!==o)throw Error("parse error");return{profile:r,length:o,datas:a}}decompress(t){return v1(new Uint8Array(t))}compress(t){return C1(new Uint8Array(t))}},Q0=class extends qe{constructor(t,n){super(),k(this,"_version",1),k(this,"_type",3),k(this,"_config",void 0),k(this,"_originDataChannel",void 0),k(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),k(this,"_dataStreamPacketHandler",void 0),k(this,"_datachannelEventMap",new Map),this._config=t,n&&(this._originDataChannel=n,this._bandDataChannelEvents(n)),this._initPacketHeader(),this._dataStreamPacketHandler=new X1}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return A("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var t,n;return(t=(n=this._originDataChannel)===null||n===void 0?void 0:n.readyState)!==null&&t!==void 0?t:"connecting"}get _originDataChannelId(){var t,n;return(t=(n=this._originDataChannel)===null||n===void 0?void 0:n.id)!==null&&t!==void 0?t:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}async _waitTillOpen(){return new Promise((t,n)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&t();const i=setTimeout(()=>{var r;n(new L(C.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(i),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),t()},this._originDataChannel.onerror=()=>{throw clearTimeout(i),new L(C.DATACHANNEL_CONNECTION_TIMEOUT)}}else n(new L(C.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})}_updateOriginDataChannel(t){this._originDataChannel=t,this._bandDataChannelEvents(t)}_initPacketHeader(){const t=new DataView(this._dataStreamPacketHeader);t.setUint16(0,this._version),t.setUint8(2,this._type),t.setUint8(3,this._config.id)}_bandDataChannelEvents(t){this._unbindDataChannelEvents(t),[zl.OPEN,zl.CLOSE,zl.ERROR].forEach(n=>{const i=()=>{this.emit(n)};this._datachannelEventMap.set(n,i),t.addEventListener(n,i)})}_unbindDataChannelEvents(t){Array.from(this._datachannelEventMap.entries()).forEach(n=>{let[i,r]=n;t.removeEventListener(i,r)}),this._datachannelEventMap.clear()}},Q1=class extends Q0{constructor(t){super(t),k(this,"_messageListener",void 0),this._messageListener=n=>{if(n.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);const i=n.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(i).getUint8(3);if(r!==this.id)return void(A("SHOW_DATASTREAM2_LOG")&&f.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let o=n.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit(zl.MESSAGE,o)}}_updateOriginDataChannel(t){super._updateOriginDataChannel(t),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}},RR=class extends Q0{send(t){if(this._originDataChannel){let n=t;n=this._dataStreamPacketHandler.serialize(t);const i=new Uint8Array(this._dataStreamPacketHeader.byteLength+n.byteLength);i.set(new Uint8Array(this._dataStreamPacketHeader),0),i.set(new Uint8Array(n),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(i.buffer)}}};function gh(){const e=new Blob([atob("ZnVuY3Rpb24gZShlKXtjb25zdCB0PW5ldyBEYXRhVmlldyhlLmRhdGEpO2lmKDA9PT10LmdldFVpbnQ4KDApJiYwPT09dC5nZXRVaW50OCgxKSYmMD09PXQuZ2V0VWludDgoMikmJjE9PT10LmdldFVpbnQ4KDMpJiY2PT09dC5nZXRVaW50OCg0KSl7bGV0IG49NixyPTAsbz0wO2Zvcig7MjU1PT09KG89dC5nZXRVaW50OChuKyspKTspcis9MjU1O3IrPW87Y29uc3QgYT1mdW5jdGlvbihlLHQsbil7bGV0IHI9bmV3IFVpbnQ4QXJyYXkoZSx0LG4pLG89W10sYT0wO2Zvcig7YTxuOylhKzM8biYmMD09PXJbYV0mJjA9PT1yW2ErMV0mJjM9PT1yW2ErMl0mJigwPT09clthKzNdfHwxPT09clthKzNdfHwyPT09clthKzNdfHwzPT09clthKzNdKT8oby5wdXNoKHJbYV0sclthKzFdLHJbYSszXSksYSs9NCk6KG8ucHVzaChyW2FdKSxhKyspO3JldHVybiBuZXcgVWludDhBcnJheShvKX0oZS5kYXRhLG4scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGEpfXJldHVybiBudWxsfWZ1bmN0aW9uIHQoZSx0KXtjb25zdCBuPWZ1bmN0aW9uKGUpe2NvbnN0IHQ9ZS5sZW5ndGg7bGV0IG49W10scj0wO2Zvcig7cjx0OylyKzI8dCYmMD09PWVbcl0mJjA9PT1lW3IrMV0mJigwPT09ZVtyKzJdfHwxPT09ZVtyKzJdfHwyPT09ZVtyKzJdfHwzPT09ZVtyKzJdKT8obi5wdXNoKGVbcl0sZVtyKzFdLDMsZVtyKzJdKSxyKz0zKToobi5wdXNoKGVbcl0pLHIrKyk7cmV0dXJuIG5ldyBVaW50OEFycmF5KG4pfSh0KSxyPW4ubGVuZ3RoLG89TWF0aC5mbG9vcihyLzI1NSksYT1yJTI1NSxzPW5ldyBVaW50OEFycmF5KDYrbysxK3IrZS5ieXRlTGVuZ3RoKTtzWzBdPTAsc1sxXT0wLHNbMl09MCxzWzNdPTEsc1s0XT02LHNbNV09MTAxO2xldCBpPTA7Zm9yKDtpPG87KXNbNitpXT0yNTUsaSsrO3JldHVybiBzWzYraV09YSxpKysscy5zZXQobiw2K2kpLHMuc2V0KG5ldyBVaW50OEFycmF5KGUpLDYraStyKSxzLmJ1ZmZlcn1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIlNhZmFyaSIpPi0xJiYtMT09PW5hdmlnYXRvci51c2VyQWdlbnQuaW5kZXhPZigiQ2hyb21lIikmJihzZWxmLm9ucnRjdHJhbnNmb3JtPW49Pntjb25zdCByPW4udHJhbnNmb3JtZXI7bGV0IG89W107ci5vcHRpb25zLnBvcnQub25tZXNzYWdlPWU9PntlLmRhdGEuc2VpJiZvLnB1c2goZS5kYXRhLnNlaSl9LHNlbGYucG9zdE1lc3NhZ2UoInN0YXJ0ZWQiKTtjb25zdCBhPXIucmVhZGFibGUuZ2V0UmVhZGVyKCkscz1yLndyaXRhYmxlLmdldFdyaXRlcigpOyJyeCI9PT1yLm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2EucmVhZCgpLnRoZW4oKHI9PntpZighci5kb25lKXtpZihyLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZShyLnZhbHVlKTt0JiZuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7c2VpOnR9KX1zLndyaXRlKHIudmFsdWUpLG4ub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQobil9fSkpfShyKToidHgiPT09ci5vcHRpb25zLm5hbWUmJmZ1bmN0aW9uIGUobil7YS5yZWFkKCkudGhlbigocj0+e2lmKCFyLmRvbmUpe2lmKHIudmFsdWUgaW5zdGFuY2VvZiBSVENFbmNvZGVkVmlkZW9GcmFtZSl7Y29uc3QgZT1vLnNoaWZ0KCk7ZSYmKHIudmFsdWUuZGF0YT10KHIudmFsdWUuZGF0YSxlKSl9cy53cml0ZShyLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0ocil9LHNlbGYucG9zdE1lc3NhZ2UoInJlZ2lzdGVyZWQiKSk7Cg==")],{type:"text/javascript"});return setTimeout(()=>URL.revokeObjectURL(e),0),new Worker(URL.createObjectURL(e))}const _l=new Map;async function Z1(e){if(!ge().supportWebRTCEncodedTransform)return void f.warning("browser not support audio encoded transform");if(_l.has(e)||!e.track)return;const t={track:e.track};if(Ns()){if(!e.createEncodedStreams)return void f.warning("browser not support createEncodedStreams() API");let i=null;try{i=e.createEncodedStreams()}catch(o){return void f.error("create audio-encoded-streams error",o&&o.message)}const r=new TransformStream({transform(o,s){t.controller||(t.controller=s),e.track&&e.track.id!==t.track.id&&(f.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",n),t.track=e.track,t.track.addEventListener("ended",n)),s.enqueue(o)}});i.readable.pipeThrough(r).pipeTo(i.writable)}else if(Gt()){if(typeof RTCRtpScriptTransform>"u")return void f.warning("browser not support RTCRtpScriptTransform");const i=gh(),r=new MessageChannel;await new Promise(s=>i.onmessage=a=>{a.data==="registered"&&s(void 0)});const o=new RTCRtpScriptTransform(i,{name:"tx",port:r.port2},[r.port2]);e.transform=o,await new Promise(s=>i.onmessage=a=>{a.data==="started"&&s(void 0)}),r.port1.onmessage=s=>{var a;s.data.transformed&&e.track&&((a=e.track)===null||a===void 0?void 0:a.id)!==t.track.id&&(f.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",n),t.track=e.track,t.track.addEventListener("ended",n))},t.worker=i}function n(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",n)}const i=_l.get(e);if(i){_l.delete(e);try{var r,o;(r=i.controller)===null||r===void 0||r.terminate(),(o=i.worker)===null||o===void 0||o.terminate()}catch(s){f.warning(s&&s.message)}}}_l.set(e,t),e.track.addEventListener("ended",n)}const fl=new Map;async function eM(e){if(!ge().supportWebRTCEncodedTransform)return void f.warning("browser not support audio encoded transform");if(fl.has(e))return;const t={track:e.track};if(Ns()){if(!e.createEncodedStreams)return void f.warning("browser not support createEncodedStreams() API");let i=null;try{i=e.createEncodedStreams()}catch(o){return void f.error("create audio-encoded-streams error",o&&o.message)}const r=new TransformStream({transform(o,s){t.controller||(t.controller=s),e.track&&e.track.id!==t.track.id&&(f.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",n),t.track=e.track,t.track.addEventListener("ended",n)),s.enqueue(o)}});i.readable.pipeThrough(r).pipeTo(i.writable)}else if(Gt()){if(typeof RTCRtpScriptTransform>"u")return void f.warning("browser not support RTCRtpScriptTransform");const i=gh(),r=new MessageChannel;await new Promise(s=>i.onmessage=a=>{a.data==="registered"&&s(void 0)});const o=new RTCRtpScriptTransform(i,{name:"rx",port:r.port2},[r.port2]);e.transform=o,await new Promise(s=>i.onmessage=a=>{a.data==="started"&&s(void 0)}),r.port1.onmessage=s=>{var a;s.data.transformed&&e.track&&((a=e.track)===null||a===void 0?void 0:a.id)!==t.track.id&&(f.debug("audio track changed: ".concat(t.track.id," => ").concat(e.track.id)),t.track.removeEventListener("ended",n),t.track=e.track,t.track.addEventListener("ended",n))},t.worker=i}function n(){e.track.removeEventListener("ended",n),function(i){const r=fl.get(i);if(r){fl.delete(i);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate()}catch(a){f.warning(a&&a.message)}}}(e)}fl.set(e,t),e.track.addEventListener("ended",n)}function tM(e){const t=new DataView(e.data);if(t.getUint8(0)===0&&t.getUint8(1)===0&&t.getUint8(2)===0&&t.getUint8(3)===1&&t.getUint8(4)===6){let n=6,i=0,r=0;for(;(r=t.getUint8(n++))===255;)i+=255;i+=r;const o=function(s,a,c){let d=new Uint8Array(s,a,c),l=[],u=0;for(;u<c;)u+3<c&&d[u]===0&&d[u+1]===0&&d[u+2]===3&&(d[u+3]===0||d[u+3]===1||d[u+3]===2||d[u+3]===3)?(l.push(d[u],d[u+1],d[u+3]),u+=4):(l.push(d[u]),u++);return new Uint8Array(l)}(e.data,n,i);return new Uint8Array(o)}return null}function nM(e,t){const n=function(c){const d=c.length;let l=[],u=0;for(;u<d;)u+2<d&&c[u]===0&&c[u+1]===0&&(c[u+2]===0||c[u+2]===1||c[u+2]===2||c[u+2]===3)?(l.push(c[u],c[u+1],3,c[u+2]),u+=3):(l.push(c[u]),u++);return new Uint8Array(l)}(t),i=n.length,r=Math.floor(i/255),o=i%255,s=new Uint8Array(6+r+1+i+e.byteLength);s[0]=0,s[1]=0,s[2]=0,s[3]=1,s[4]=6,s[5]=101;let a=0;for(;a<r;)s[6+a]=255,a++;return s[6+a]=o,a++,s.set(n,6+a),s.set(new Uint8Array(e),6+a+i),s.buffer}const El=new Map;async function iM(e,t){if(!ge().supportWebRTCEncodedTransform)return void f.warning("browser not support video encoded transform");if(El.has(e)||!e.track)return;const n={track:e.track};if(Ns()){if(!e.createEncodedStreams)return void f.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(a){return void f.error("create video-encoded-streams error",a&&a.message)}let o=[];t.on("sei-to-send",a=>{o.push(a)});const s=new TransformStream({transform(a,c){n.controller||(n.controller=c),e.track&&e.track.id!==n.track.id&&(f.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const d=o.shift();d&&(a.data=nM(a.data,d)),c.enqueue(a)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(!Gt())return;{if(typeof RTCRtpScriptTransform>"u")return void f.warning("browser not support RTCRtpScriptTransform");const r=gh(),o=new MessageChannel;await new Promise(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});const s=new RTCRtpScriptTransform(r,{name:"tx",port:o.port2},[o.port2]);e.transform=s,await new Promise(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),t.on("sei-to-send",a=>{o.port1.postMessage({sei:a})}),o.port1.onmessage=a=>{var c;a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id&&(f.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i))},n.worker=r}}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}const r=El.get(e);if(r){El.delete(e);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate()}catch(a){f.warning(a&&a.message)}}}El.set(e,n),e.track.addEventListener("ended",i)}const dc=new Map;async function rM(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!ge().supportWebRTCEncodedTransform)return void f.warning("browser not support video encoded transform");if(!e.track)return;if(dc.has(e)){const r=dc.get(e);return void(r&&(r.onSei=t.onSei))}const n={track:e.track,onSei:t.onSei};if(Ns()){if(!e.createEncodedStreams)return void f.warning("browser not support createEncodedStreams() API");let r=null;try{r=e.createEncodedStreams()}catch(s){return void f.error("create video-encoded-streams error",s&&s.message)}const o=new TransformStream({transform(s,a){n.controller||(n.controller=a),e.track&&e.track.id!==n.track.id&&(f.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i));const c=tM(s);c&&n.onSei&&n.onSei(c),a.enqueue(s)}});r.readable.pipeThrough(o).pipeTo(r.writable)}else if(Gt()){if(typeof RTCRtpScriptTransform>"u")return void f.warning("browser not support RTCRtpScriptTransform");const r=gh(),o=new MessageChannel;await new Promise(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});const s=new RTCRtpScriptTransform(r,{name:"rx",port:o.port2},[o.port2]);e.transform=s,await new Promise(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),o.port1.onmessage=a=>{var c;a.data.transformed&&e.track&&((c=e.track)===null||c===void 0?void 0:c.id)!==n.track.id?(f.debug("video track changed: ".concat(n.track.id," => ").concat(e.track.id)),n.track.removeEventListener("ended",i),n.track=e.track,n.track.addEventListener("ended",i)):a.data.sei&&n.onSei&&n.onSei(a.data.sei)},n.worker=r}function i(){if(e.track){if(this.id!==e.track.id)return;e.track.removeEventListener("ended",i)}(function(r){const o=dc.get(r);if(o){dc.delete(r);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){f.warning(c&&c.message)}}})(e)}dc.set(e,n),e.track.addEventListener("ended",i)}I1();const oM=["CHINA","GLOBAL"],Jt=function(){const e="us".concat("erna","me"),t="pa".concat("sswo","rd"),n=["t","s","t"];n.splice(1,0,"e");const i=n.join(""),r=[];for(let a=0;a<6;a++)r.push("1");const o=r.join(""),s={};return s[e]=i,s[t]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=Jt,xE||(Ct.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],Ct.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],Ct.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],Ct.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],Ct.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],Ct.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],Ct.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",Ct.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",Ct.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",Ct.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",Ct.AREAS=["NORTH_AMERICA","OVERSEA"]);const Z0=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],as=[];function Go(e,t){return!!t&&as.some(n=>n.uid===e&&n.channelName===t)}function Tc(e){var t,n;function i(o,s){try{var a=e[o](s),c=a.value,d=c instanceof JE;Promise.resolve(d?c.v:c).then(function(l){if(d){var u=o==="return"?"return":"next";if(!c.k||l.done)return i(u,l);l=e[u](l).value}r(a.done?"return":"normal",l)},function(l){i("throw",l)})}catch(l){r("throw",l)}}function r(o,s){switch(o){case"return":t.resolve({value:s,done:!0});break;case"throw":t.reject(s);break;default:t.resolve({value:s,done:!1})}(t=t.next)?i(t.key,t.arg):n=null}this._invoke=function(o,s){return new Promise(function(a,c){var d={key:o,arg:s,resolve:a,reject:c,next:null};n?n=n.next=d:(t=n=d,i(o,s))})},typeof e.return!="function"&&(this.return=void 0)}function JE(e,t){this.v=e,this.k=t}function Lu(e){var t={},n=!1;function i(r,o){return n=!0,o=new Promise(function(s){s(e[r](o))}),{done:!1,value:new JE(o,1)}}return t[typeof Symbol<"u"&&Symbol.iterator||"@@iterator"]=function(){return this},t.next=function(r){return n?(n=!1,r):i("next",r)},typeof e.throw=="function"&&(t.throw=function(r){if(n)throw n=!1,r;return i("throw",r)}),typeof e.return=="function"&&(t.return=function(r){return n?(n=!1,r):i("return",r)}),t}function ku(e){var t,n,i,r=2;for(typeof Symbol<"u"&&(n=Symbol.asyncIterator,i=Symbol.iterator);r--;){if(n&&(t=e[n])!=null)return t.call(e);if(i&&(t=e[i])!=null)return new $l(t.call(e));n="@@asyncIterator",i="@@iterator"}throw new TypeError("Object is not async iterable")}function $l(e){function t(n){if(Object(n)!==n)return Promise.reject(new TypeError(n+" is not an object."));var i=n.done;return Promise.resolve(n.value).then(function(r){return{value:r,done:i}})}return $l=function(n){this.s=n,this.n=n.next},$l.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(n){var i=this.s.return;return i===void 0?Promise.resolve({value:n,done:!0}):t(i.apply(this.s,arguments))},throw:function(n){var i=this.s.return;return i===void 0?Promise.reject(n):t(i.apply(this.s,arguments))}},new $l(e)}function ae(e){return new JE(e,0)}function CR(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),n.push.apply(n,i)}return n}function F(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?CR(Object(n),!0).forEach(function(i){sM(e,i,n[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):CR(Object(n)).forEach(function(i){Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(n,i))})}return e}function Wn(e){return function(){return new Tc(e.apply(this,arguments))}}function sM(e,t,n){return(t=function(i){var r=function(o,s){if(typeof o!="object"||o===null)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,s||"default");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(o)}(i,"string");return typeof r=="symbol"?r:String(r)}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function aM(e,t){if(e==null)return{};var n,i,r=function(s,a){if(s==null)return{};var c,d,l={},u=Object.keys(s);for(d=0;d<u.length;d++)c=u[d],a.indexOf(c)>=0||(l[c]=s[c]);return l}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}function B(e,t,n,i,r){var o={};return Object.keys(i).forEach(function(s){o[s]=i[s]}),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce(function(s,a){return a(e,t,s)||s},o),r&&o.initializer!==void 0&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),o.initializer===void 0&&(Object.defineProperty(e,t,o),o=null),o}bd.__CLIENT_LIST__=as,Tc.prototype[typeof Symbol=="function"&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},Tc.prototype.next=function(e){return this._invoke("next",e)},Tc.prototype.throw=function(e){return this._invoke("throw",e)},Tc.prototype.return=function(e){return this._invoke("return",e)};let cM=function(e){return e.L1T1="L1T1",e.L1T2="L1T2",e.L1T3="L1T3",e.L2T1_KEY="L2T1_KEY",e.L2T2_KEY="L2T2_KEY",e.L2T3_KEY="L2T3_KEY",e.L3T1_KEY="L3T1_KEY",e.L3T2_KEY="L3T2_KEY",e.L3T3_KEY="L3T3_KEY",e}({}),$n=function(e){return e.CERTIFICATE="certificate",e.CODEC="codec",e.CANDIDATE_PAIR="candidate-pair",e.LOCAL_CANDIDATE="local-candidate",e.REMOTE_CANDIDATE="remote-candidate",e.INBOUND="inbound-rtp",e.TRACK="track",e.OUTBOUND="outbound-rtp",e.PC="peer-connection",e.REMOTE_INBOUND="remote-inbound-rtp",e.REMOTE_OUTBOUND="remote-outbound-rtp",e.TRANSPORT="transport",e.CSRC="csrc",e.DATA_CHANNEL="data-channel",e.STREAM="stream",e.SENDER="sender",e.RECEIVER="receiver",e}({}),ql=function(e){return e[e.ACCESS_POINT=101]="ACCESS_POINT",e[e.UNILBS=201]="UNILBS",e[e.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",e}({}),bp=function(e){return e[e.IIIEGAL_APPID=1]="IIIEGAL_APPID",e[e.IIIEGAL_UID=2]="IIIEGAL_UID",e[e.INTERNAL_ERROR=3]="INTERNAL_ERROR",e}({}),Ri=function(e){return e[e.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",e[e.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",e[e.INTERNAL_ERROR=8]="INTERNAL_ERROR",e[e.NO_AUTHORIZED=9]="NO_AUTHORIZED",e[e.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",e[e.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",e[e.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",e[e.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",e[e.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",e[e.USER_OVERLOAD=16]="USER_OVERLOAD",e[e.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",e[e.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",e}({}),En=function(e){return e[e.NO_FLAG_SET=100]="NO_FLAG_SET",e[e.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",e[e.INVALID_FALG_SET=102]="INVALID_FALG_SET",e[e.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",e[e.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",e[e.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",e[e.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",e[e.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",e[e.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",e[e.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",e[e.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",e[e.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",e[e.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",e[e.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",e[e.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",e[e.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",e[e.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",e[e.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",e[e.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",e}({}),Q=function(e){return e[e.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",e[e.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",e[e.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",e[e.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",e[e.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",e[e.K_TICKET_INVALID=7]="K_TICKET_INVALID",e[e.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",e[e.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",e[e.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",e[e.K_UID_BANNED=14]="K_UID_BANNED",e[e.K_IP_BANNED=15]="K_IP_BANNED",e[e.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",e[e.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",e[e.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",e[e.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",e[e.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",e[e.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",e[e.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",e[e.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",e[e.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",e[e.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",e[e.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",e[e.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",e[e.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",e[e.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",e[e.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",e[e.ERR_INVALID_UID=117]="ERR_INVALID_UID",e[e.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",e[e.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",e[e.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",e[e.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",e[e.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",e[e.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",e[e.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",e[e.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",e[e.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",e[e.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",e[e.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",e[e.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",e[e.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",e[e.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",e[e.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",e[e.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",e[e.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",e[e.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",e[e.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",e[e.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",e[e.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",e[e.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",e[e.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",e[e.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",e[e.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",e[e.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",e[e.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",e[e.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",e[e.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",e[e.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",e[e.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",e[e.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",e[e.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",e[e.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",e[e.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",e[e.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",e[e.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",e}({}),he=function(e){return e.CONNECTING="connecting",e.CONNECTED="connected",e.RECONNECTING="reconnecting",e.CLOSED="closed",e}({}),H=function(e){return e.WS_CONNECTED="ws_connected",e.WS_RECONNECTING="ws_reconnecting",e.WS_CLOSED="ws_closed",e.WS_RECONNECT_WAITTING_FINISH="ws_reconnect_waitting_finish",e.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",e.ON_BINARY_DATA="on_binary_data",e.REQUEST_RECOVER="request_recover",e.REQUEST_JOIN_INFO="request_join_info",e.REQUEST_REJOIN_INFO="req_rejoin_info",e.IS_P2P_DISCONNECTED="is_p2p_dis",e.DISCONNECT_P2P="dis_p2p",e.ABORT_P2P_EXECUTION="abort_p2p_execution",e.NEED_RENEW_SESSION="need-sid",e.REPORT_JOIN_GATEWAY="report_join_gateway",e.REQUEST_TIMEOUT="request_timeout",e.REQUEST_SUCCESS="request_success",e.JOIN_RESPONSE="join_response",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_CONNECTING="datachannel_connecting",e.DATACHANNEL_FAILBACK="datachannel_failback",e.P2P_CONNECTION="p2p_connection",e.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",e.P2P_SUBSCRIBE="p2p_subscribe",e.P2P_UNSUBSCRIBE="p2p_unsubscribe",e.P2P_EXCHANGE_SDP="p2p_exchange_sdp",e.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",e.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",e}({}),$=function(e){return e.PING="ping",e.PING_BACK="ping_back",e.JOIN="join_v3",e.REJOIN="rejoin_v3",e.LEAVE="leave",e.SET_CLIENT_ROLE="set_client_role",e.PUBLISH="publish",e.PUBLISH_DATASTREAM="publish_datastream",e.UNPUBLISH="unpublish",e.UNPUBLISH_DATASTREAM="unpublish_datastream",e.SUBSCRIBE="subscribe",e.PRE_SUBSCRIBE="pre_subscribe",e.SUBSCRIBE_DATASTREAM="subscribe_datastream",e.SUBSCRIBE_STREAMS="subscribe_streams",e.UNSUBSCRIBE="unsubscribe",e.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",e.UNSUBSCRIBE_STREAMS="unsubscribe_streams",e.SUBSCRIBE_CHANGE="subscribe_change",e.TRAFFIC_STATS="traffic_stats",e.RENEW_TOKEN="renew_token",e.SWITCH_VIDEO_STREAM="switch_video_stream",e.DEFAULT_VIDEO_STREAM="default_video_stream",e.SET_FALLBACK_OPTION="set_fallback_option",e.GATEWAY_INFO="gateway_info",e.CONTROL="control",e.SEND_METADATA="send_metadata",e.DATA_STREAM="data_stream",e.PICK_SVC_LAYER="pick_svc_layer",e.RESTART_ICE="restart_ice",e.CONNECT_PC="connect_pc",e.SET_VIDEO_PROFILE="set_video_profile",e.SET_PARAMETER="set_parameter",e.SET_RTM2_FLAG="set_rtm2_flag",e}({}),Cs=function(e){return e.WRTC_STATS="wrtc_stats",e.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",e.DENOISER_STATS="denoiser_stats",e.EXTENSION_USAGE_STATS="extension_usage_stats",e}({}),ie=function(e){return e.ON_USER_ONLINE="on_user_online",e.ON_USER_OFFLINE="on_user_offline",e.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",e.ON_PUBLISH_STREAM="on_publish_stream",e.ON_UPLINK_STATS="on_uplink_stats",e.ON_P2P_LOST="on_p2p_lost",e.ON_REMOVE_STREAM="on_remove_stream",e.ON_ADD_AUDIO_STREAM="on_add_audio_stream",e.ON_ADD_VIDEO_STREAM="on_add_video_stream",e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",e.ON_USER_BANNED="on_user_banned",e.ON_USER_LICENSE_BANNED="on_user_license_banned",e.ON_NOTIFICATION="on_notification",e.ON_CRYPT_ERROR="on_crypt_error",e.MUTE_AUDIO="mute_audio",e.MUTE_VIDEO="mute_video",e.UNMUTE_AUDIO="unmute_audio",e.UNMUTE_VIDEO="unmute_video",e.ON_P2P_OK="on_p2p_ok",e.RECEIVE_METADATA="receive_metadata",e.ON_DATA_STREAM="on_data_stream",e.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",e.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",e.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",e.ENABLE_LOCAL_VIDEO="enable_local_video",e.DISABLE_LOCAL_VIDEO="disable_local_video",e.ENABLE_LOCAL_AUDIO="enable_local_audio",e.DISABLE_LOCAL_AUDIO="disable_local_audio",e.ON_PUBLISHED_USER_LIST="on_published_user_list",e}({}),Rn=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({}),ne=function(e){return e.CONNECTED="websocket:connected",e.RECONNECTING="websocket:reconnecting",e.WILL_RECONNECT="websocket:will_reconnect",e.CLOSED="websocket:closed",e.FAILED="websocket:failed",e.ON_MESSAGE="websocket:on_message",e.REQUEST_NEW_URLS="websocket:request_new_urls",e.RECONNECT_WAITTING_FINISH="websocket:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",e}({});class N extends L{constructor(t){super(t,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),this.name="AgoraRTCException"}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(t,f)}throw(){super.throw(f)}}function Sh(e){if(typeof e!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(e))throw f.error("Invalid Channel Name ".concat(e)),new N(C.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function Th(e){if(t=e,!(typeof t=="number"&&Math.floor(t)===t&&0<=t&&t<=4294967295||PA(e,1,255)))throw new N(C.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var t;typeof e=="string"&&f.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Vt=function(e){return e.TRANSCODE="mix_streaming",e.RAW="raw_streaming",e.INJECT="inject_streaming",e}({}),xs=function(e){return e[e.INJECT_STREAM_STATUS_START_SUCCESS=0]="INJECT_STREAM_STATUS_START_SUCCESS",e[e.INJECT_STREAM_STATUS_START_ALREADY_EXISTS=1]="INJECT_STREAM_STATUS_START_ALREADY_EXISTS",e[e.INJECT_STREAM_STATUS_START_UNAUTHORIZED=2]="INJECT_STREAM_STATUS_START_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_START_TIMEOUT=3]="INJECT_STREAM_STATUS_START_TIMEOUT",e[e.INJECT_STREAM_STATUS_START_FAILED=4]="INJECT_STREAM_STATUS_START_FAILED",e[e.INJECT_STREAM_STATUS_STOP_SUCCESS=5]="INJECT_STREAM_STATUS_STOP_SUCCESS",e[e.INJECT_STREAM_STATUS_STOP_NOT_FOUND=6]="INJECT_STREAM_STATUS_STOP_NOT_FOUND",e[e.INJECT_STREAM_STATUS_STOP_UNAUTHORIZED=7]="INJECT_STREAM_STATUS_STOP_UNAUTHORIZED",e[e.INJECT_STREAM_STATUS_STOP_TIMEOUT=8]="INJECT_STREAM_STATUS_STOP_TIMEOUT",e[e.INJECT_STREAM_STATUS_STOP_FAILED=9]="INJECT_STREAM_STATUS_STOP_FAILED",e[e.INJECT_STREAM_STATUS_BROKEN=10]="INJECT_STREAM_STATUS_BROKEN",e}({});const dM={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},Dp={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function Pp(e,t){jt(e.url,"".concat(t,".url"),1,1e3,!1),tt(e.x)||De(e.x,"".concat(t,".x"),0,1e4),tt(e.y)||De(e.y,"".concat(t,".y"),0,1e4),tt(e.width)||De(e.width,"".concat(t,".width"),0,1e4),tt(e.height)||De(e.height,"".concat(t,".height"),0,1e4),tt(e.zOrder)||De(e.zOrder,"".concat(t,".zOrder"),0,255),tt(e.alpha)||De(e.alpha,"".concat(t,".alpha"),0,1,!1)}const lM={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},uM={audioBitrate:48,audioChannels:2,audioVolume:100,audioSampleRate:48e3,height:0,width:0,videoBitrate:400,videoFramerate:15,videoGop:30};let fr=function(e){return e.WARNING="@live_uap-warning",e.ERROR="@line_uap-error",e.PUBLISH_STREAM_STATUS="@live_uap-publish-status",e.INJECT_STREAM_STATUS="@live_uap-inject-status",e.WORKER_STATUS="@live_uap-worker-status",e.REQUEST_NEW_ADDRESS="@live_uap-request-address",e}({}),Mu=function(e){return e.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",e}({}),Rt=function(e){return e[e.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",e[e.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",e[e.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",e[e.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",e[e.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",e[e.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",e[e.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",e[e.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",e[e.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",e[e.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",e[e.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",e[e.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",e[e.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",e[e.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",e[e.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",e[e.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",e[e.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",e[e.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",e}({});function vR(e){if(!e.channelName)throw new N(C.INVALID_PARAMS,"invalid channelName in info");if(typeof e.uid!="number")throw new N(C.INVALID_PARAMS,"invalid uid in info, uid must be a number");return e.token&&jt(e.token,"info.token",1,2047),Th(e.uid),Sh(e.channelName),!0}let mn=function(e){return e[e.SetSdkProfile=0]="SetSdkProfile",e[e.SetSourceChannel=1]="SetSourceChannel",e[e.SetSourceUserId=2]="SetSourceUserId",e[e.SetDestChannel=3]="SetDestChannel",e[e.StartPacketTransfer=4]="StartPacketTransfer",e[e.StopPacketTransfer=5]="StopPacketTransfer",e[e.UpdateDestChannel=6]="UpdateDestChannel",e[e.Reconnect=7]="Reconnect",e[e.SetVideoProfile=8]="SetVideoProfile",e}({}),Qr=function(e){return e.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",e.NETWORK_CONNECTED="NETWORK_CONNECTED",e.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",e.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",e.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",e.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",e.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",e.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",e.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",e.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",e}({}),xn=function(e){return e.RELAY_STATE_IDLE="RELAY_STATE_IDLE",e.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",e.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",e.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",e}({}),lc=function(e){return e.RELAY_OK="RELAY_OK",e.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",e.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",e.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",e}({}),ve=function(e){return e.High="high",e.Low="low",e.Audio="audio",e.Screen="screen",e.ScreenLow="screen_low",e}({}),ct=function(e){return e.DISCONNECT="disconnect",e.CONNECTION_STATE_CHANGE="connection-state-change",e.NETWORK_QUALITY="network-quality",e.STREAM_TYPE_CHANGE="stream-type-change",e.IS_P2P_DISCONNECTED="is-p2p-dis",e.DISCONNECT_P2P="dis-p2p",e.REQUEST_NEW_GATEWAY_LIST="req-gate-url",e.NEED_RENEW_SESSION="need-sid",e.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",e.JOIN_RESPONSE="join-response",e.REQUEST_DC_CONNECTION_PARAMS="request-dc-connection-params",e.RESET_CONNECTION_EVENTS="reset-connection-events",e.DATACHANNEL_PRECONNECT="datachannel_preconnect",e.DATACHANNEL_FAILBACK="datachannel_failback",e.RESET_SIGNAL="reset-signal",e}({}),Rc=function(e){return e.P2P_DISCONNECTED="P2P_DISCONNECTED",e.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",e.TIMEOUT="TIMEOUT",e.UNKNOWN_REASON="UNKNOWN_REASON",e}({}),Nt=function(e){return e[e.Nothing=0]="Nothing",e[e.Audio=1]="Audio",e[e.LwoVideo=2]="LwoVideo",e[e.Video=4]="Video",e[e.Data=8]="Data",e[e.DataStream0=256]="DataStream0",e[e.DataStream1=512]="DataStream1",e[e.DataStream2=1024]="DataStream2",e[e.DataStream3=2048]="DataStream3",e[e.DataStream4=4096]="DataStream4",e[e.DataStream5=8192]="DataStream5",e[e.DataStream6=16384]="DataStream6",e[e.DataStream7=32768]="DataStream7",e}({}),ew=function(e){return e[e.websocket=0]="websocket",e[e.datachannel=1]="datachannel",e}({}),Re=function(e){return e.CHINA="CHINA",e.ASIA="ASIA",e.NORTH_AMERICA="NORTH_AMERICA",e.EUROPE="EUROPE",e.JAPAN="JAPAN",e.INDIA="INDIA",e.KOREA="KOREA",e.HKMC="HKMC",e.US="US",e.OCEANIA="OCEANIA",e.SOUTH_AMERICA="SOUTH_AMERICA",e.AFRICA="AFRICA",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="EXTENSIONS",e}({});const hM=[Re.AFRICA,Re.ASIA,Re.CHINA,Re.EUROPE,Re.GLOBAL,Re.INDIA,Re.JAPAN,Re.NORTH_AMERICA,Re.OCEANIA,Re.OVERSEA,Re.SOUTH_AMERICA];let tn=function(e){return e.CHINA="CN",e.ASIA="AS",e.NORTH_AMERICA="NA",e.EUROPE="EU",e.JAPAN="JP",e.INDIA="IN",e.KOREA="KR",e.HKMC="HK",e.US="US",e.OCEANIA="OC",e.SOUTH_AMERICA="SA",e.AFRICA="AF",e.OVERSEA="OVERSEA",e.GLOBAL="GLOBAL",e.EXTENSIONS="GLOBAL",e}({});const Rh={CHINA:{},ASIA:{CODE:tn.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:tn.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:tn.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:tn.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:tn.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:tn.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:tn.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:tn.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:tn.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:tn.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:tn.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:tn.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:tn.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};xE&&(Rh.CHINA={CODE:tn.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let Af=function(e){return e.UPDATE_BITRATE_LIMIT="update_bitrate_limit",e}({});class tw extends qe{constructor(t,n){super(),this.onICEConnectionStateChange=void 0,this.onConnectionStateChange=void 0,this.onDTLSTransportStateChange=void 0,this.onDTLSTransportError=void 0,this.onICETransportStateChange=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoReceived=void 0,this.onFirstAudioDecoded=void 0,this.onFirstVideoDecoded=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.getLocalVideoStats=void 0}}class Ch extends tw{constructor(t,n){super(t,n),this.establishPromise=void 0}}let z=function(e){return e.VIDEO="video",e.AUDIO="audio",e}({}),_n=function(e){return e[e.UDP=0]="UDP",e[e.TCP=1]="TCP",e[e.RELAY=2]="RELAY",e}({}),br=function(e){return e[e.FIRST_CONNECTION=0]="FIRST_CONNECTION",e[e.TCP_RESTART=1]="TCP_RESTART",e[e.RELAY_RESTART=2]="RELAY_RESTART",e[e.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",e[e.OLD_RESTART=11]="OLD_RESTART",e[e.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",e}({}),M=function(e){return e.LocalVideoTrack="videoTrack",e.LocalAudioTrack="audioTrack",e.LocalVideoLowTrack="videoLowTrack",e}({}),we=function(e){return e.New="new",e.Connected="connected",e.Reconnecting="reconnecting",e.Disconnected="disconnected",e}({}),ee=function(e){return e.StateChange="stateChange",e.IceConnectionStateChange="iceConnectionStateChange",e.RequestMuteLocal="requestMuteLocal",e.RequestUnmuteLocal="requestUnmuteLocal",e.RequestRePublish="requestRePublish",e.RequestRePublishDataChannel="requestRePublishDataChannel",e.RequestReSubscribe="requestReSubscribe",e.RequestUploadStats="requestUploadStats",e.RequestUpload="requestUpload",e.MediaReconnectStart="MediaReconnectStart",e.MediaReconnectEnd="MediaReconnectEnd",e.NeedSignalRTT="NeedSignalRTT",e.RequestRestartICE="RequestRestartIce",e.PeerConnectionStateChange="PeerConnectionStateChange",e.RequestReconnect="RequestReconnect",e.RequestReconnectPC="RequestReconnectPC",e.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",e.P2PLost="P2PLost",e.UpdateVideoEncoder="UpdateVideoEncoder",e.ConnectionTypeChange="ConnectionTypeChange",e.RequestLowStreamParameter="RequestLowStreamParameter",e.QueryClientConnectionState="QueryClientConnectionState",e.LocalCandidate="LocalCandidate",e.RequestP2PMuteLocal="requestP2PMuteLocal",e.RequestP2PUnPublish="RequestP2PUnPublish",e.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",e.RequestP2PMuteRemote="RequestP2PMuteRemote",e.RequestP2PRestartICE="RequestP2PRestartICE",e}({}),Ii=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Ci=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),Ut=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),Zr=function(e){return e.NETWORK_ERROR="NETWORK_ERROR",e.SERVER_ERROR="SERVER_ERROR",e.MULTI_IP="MULTI_IP",e.TIMEOUT="TIMEOUT",e.OFFLINE="OFFLINE",e.LEAVE="LEAVE",e.P2P_FAILED="P2P_FAILED",e.FALLBACK="FALLBACK",e}({}),gt=function(e){return e.CONNECTED="transmitter:connected",e.RECONNECTING="transmitter:reconnecting",e.WILL_RECONNECT="transmitter:will_reconnect",e.CLOSED="transmitter:closed",e.FAILED="transmitter:failed",e.ON_MESSAGE="transmitter:on_message",e.REQUEST_NEW_URLS="transmitter:request_new_urls",e.RECONNECT_WAITTING_FINISH="transmitter:reconnect_waitting_finish",e.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",e.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",e.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",e.FAILBACK="transmitter:failback",e}({}),gr=function(e){return e.CAMERA_CHANGED="camera-changed",e.MICROPHONE_CHANGED="microphone-changed",e.PLAYBACK_DEVICE_CHANGED="playback-device-changed",e.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",e.AUTOPLAY_FAILED="autoplay-failed",e.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",e.SECURITY_POLICY_VIOLATION="security-policy-violation",e}({}),ci=function(e){return e.CONNECTING="CONNECTING",e.RECONNECTING="RECONNECTING",e.CONNECTED="CONNECTED",e.CLOSED="CLOSED",e}({}),Hi=function(e){return e.CONNECTION_STATE_CHANGE="connection-state-change",e.STATE_CHANGE="state-change",e.INSPECT_RESULT="inspect-result",e.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",e.REQUEST_NEW_WORKER_URL="request-new-worker-url",e}({}),Vs=function(e){return e[e.CONNECT_AP=0]="CONNECT_AP",e[e.AP_CONNECTED=1]="AP_CONNECTED",e[e.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",e[e.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",e[e.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",e[e.CONNECT_WORKER=5]="CONNECT_WORKER",e[e.WORKER_CONNECTED=6]="WORKER_CONNECTED",e[e.CLOSED=7]="CLOSED",e}({}),at=function(e){return e.CALL="call",e.CANDIDATE="candidate",e.PUBLISH="publish",e.UNPUBLISH="unpublish",e.CONTROL="control",e.RESTART_ICE="restart_ice",e.ACK="ack",e.RESPONSE="response",e.JOIN="join",e.CHECK="check",e}({}),Fs=function(e){return e.ABORT="abort",e}({}),mo=function(e){return e.MUTE_LOCAL_AUDIO="mute_local_audio",e.MUTE_LOCAL_VIDEO="mute_local_video",e.UNMUTE_LOCAL_AUDIO="unmute_local_audio",e.UNMUTE_LOCAL_VIDEO="unmute_local_video",e}({}),pM=function(e){return e.P2P_TOKEN_TIMEOUT="p2p_token_timeout",e.P2P_TOKEN_CHANGED="p2p_token_changed",e}({});const _M={[ql.ACCESS_POINT]:{[En.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[En.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[En.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[En.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[En.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[En.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[En.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[En.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[En.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[En.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[En.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[En.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[En.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[En.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[En.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[En.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[En.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[En.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[ql.UNILBS]:{[Ri.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Ri.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Ri.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Ri.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Ri.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Ri.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Ri.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Ri.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Ri.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Ri.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Ri.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Ri.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[ql.STRING_UID_ALLOCATOR]:{[bp.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[bp.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[bp.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function Da(e){const t=_M[Math.floor(e/1e4)];if(!t)return{desc:"unknown error",retry:!1};const n=t[e%1e4];if(!n){if(Math.floor(e/1e4)===ql.ACCESS_POINT){const i=e%1e4;if(i.toString()[0]==="1")return{desc:e.toString(),retry:!1};if(i.toString()[0]==="2")return{desc:e.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return n}const fM={[Q.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[Q.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[Q.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[Q.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[Q.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[Q.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[Q.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[Q.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[Q.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[Q.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[Q.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[Q.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[Q.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[Q.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[Q.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[Q.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[Q.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[Q.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[Q.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[Q.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[Q.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[Q.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[Q.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[Q.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[Q.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[Q.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[Q.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[Q.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[Q.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[Q.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[Q.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[Q.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[Q.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[Q.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[Q.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[Q.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[Q.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[Q.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[Q.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[Q.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[Q.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Q.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[Q.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[Q.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[Q.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[Q.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[Q.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[Q.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[Q.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[Q.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[Q.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[Q.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[Q.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[Q.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[Q.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[Q.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[Q.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[Q.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[Q.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[Q.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[Q.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[Q.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[Q.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function vs(e){return fM[e]||{desc:"UNKNOW_ERROR_".concat(e),action:"failed"}}function IR(e){return e.every(t=>t.readyState===WebSocket.CLOSED||t.readyState===WebSocket.CLOSING)}function yR(e,t){if(typeof e=="string")return e;const{proxy:n,host:i,port:r}=e;if(t){const o=A("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(i,"/ws/?p=").concat(Number(r)+150):"wss://".concat(i,":").concat(o,"/ws/?p=").concat(Number(r)+150)}return n?"wss://".concat(n,"/ws/?h=").concat(i,"&p=").concat(r):"wss://".concat(i,":").concat(r)}const EM=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,mM=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,gM=/wss:\/\/(.+):([0-9]+)\/?/,SM=/wss:\/\/(.[^\/]+)\/?/;let TM=0;class RM{constructor(t,n){this.id=0,this.store=void 0,this.recordIndex=void 0,this.websockets=[],this.try443PortDuration=2e3,this.forceCloseWSDuration=5e3,this.try443PortTimeout=null,this.forceCloseTimeout=null,this.isTry443PortFailed=!1,this.isNormalPortFailed=!1,this.useDoubleDomain=!1,this.useProxy=!1,this.startTime=Date.now(),this.id=++TM,this.try443PortDuration=A("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=t||5e3,this.store=n}closeAllWebsockets(){this.websockets.forEach(t=>{t.onopen=null,t.onclose=null,t.onmessage=null,t.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout)}logger(){var t;const n=Date.now()-this.startTime;for(var i=arguments.length,r=new Array(i),o=0;o<i;o++)r[o]=arguments[o];f.debug("[choose-best-ws ".concat((t=this.store)===null||t===void 0?void 0:t.clientId," ").concat(this.id,"] ").concat(n,"ms:"),...r)}createWebSocket(t,n,i){this.logger("createWebSocket:",t,{isTry443Port:n,hasTimeoutDetection:i});const r=A("GATEWAY_DOMAINS"),o=Date.now(),s=[],a=r.find(l=>t.host.includes(l));a||(this.useDoubleDomain=!1);const c=[];if(this.useDoubleDomain)r.forEach(l=>{c.push(yR(F(F({},t),{},{host:t.host.replace(a,l)}),n))});else{const l=F({},t);if(n&&a){const u=r.find(h=>h!==a);u&&(l.host=l.host.replace(a,u))}c.push(yR(l,n))}try{c.forEach(l=>{const u=new WebSocket(l);u.binaryType="arraybuffer",s.push(u),this.logger("ws is connecting:",u.url)})}catch(l){if(this.logger("ws create failed"),s.forEach(u=>u.close()),s.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(t,n,i);if(!n&&Number(t.port)!==443)return this.createWebSocket(t,!0,i);throw new N(C.WS_ERR,"init websocket failed! Error: ".concat(l.toString()))}const d=rd();return this.store&&this.store.recordJoinChannelService({urls:s.map(l=>l.url),service:"gateway"},this.recordIndex),s.forEach(l=>{l.onopen=()=>{this.logger("onopen: ws ".concat(l.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(u=>{u!==l&&(u.onopen=null,u.onclose=null,u.onmessage=null,u.close(),this.logger("close backup websocket: ".concat(u.url)))}),this.websockets.length=0,d.resolve(l)},l.onclose=u=>{this.logger("onclose: ws ".concat(l.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(l.readyState)),n?this.isTry443PortFailed=IR(s):this.isNormalPortFailed=IR(s),this.logger("443: ".concat(this.useProxy?"not try":this.isTry443PortFailed?"failed":"trying"," 47xx: ").concat(this.isNormalPortFailed?"failed":"trying")),(n&&this.isTry443PortFailed||!n&&(this.isTry443PortFailed||this.useProxy)&&this.isNormalPortFailed)&&(this.logger("onclose: all websocket is closed, ".concat(u.reason)),d.reject({code:u.code,reason:Rc.A_ROUND_WS_FAILED}))},l.onmessage=u=>this.logger("".concat(l.url," onmessage: ").concat(u.data))}),this.websockets.push(...s),i||(()=>{const l=()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.websockets.forEach(u=>u.readyState!==WebSocket.OPEN&&u.close())};if(n||this.useProxy)return this.logger("add 5s timeout at ".concat(n?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(l,this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{if(this.logger("2s timeout, isWebsocket created: ",d.isResolved),d.isResolved)return l();nP()&&Me()&&l(),this.createWebSocket(t,!0,!0).then(u=>d.resolve(u)).catch(u=>{this.isNormalPortFailed&&d.reject(u),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(l,this.forceCloseWSDuration)},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(t,n,i,r){return this.useDoubleDomain=!!n,typeof t=="string"&&(t=function(o){let s,a,c;return[,s,a,c]=o.match(EM)||[],s||([,a,c]=o.match(mM)||[]),a&&c||([,a,c]=o.match(gM)||[]),a&&c||([,a]=o.match(SM)||[]),a||f.warning("un-destructible url: ",o),{proxy:s,host:a,port:c||"443"}}(t)),this.recordIndex=r,this.useProxy=!!t.proxy,i&&this.useProxy&&(f.warn("cannot use 443 only when use proxy"),i=!1),this.createWebSocket(t,!!i,!1).finally(()=>this.clearTimeout())}}class nw extends qe{get url(){return this.websocket&&this.websocket.url||null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){["tryNext","recover"].includes(t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(ne.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(ne.CONNECTED):this._state==="closed"?this.emit(ne.CLOSED):this._state==="failed"&&this.emit(ne.FAILED))}resetReconnectCount(t){f.debug("websocket reset reconnect count, reason: "+t),this.reconnectCount=0}constructor(t,n){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],s=arguments.length>5?arguments[5]:void 0;super(),this.connectionID=0,this.currentURLIndex=0,this.urls=[],this._reconnectMode="tryNext",this.reconnectReason=void 0,this._initMutex=new Bt("websocket"),this.name=void 0,this._state="closed",this.reconnectInterrupter=void 0,this.websocket=void 0,this.retryConfig=void 0,this.reconnectCount=0,this.forceCloseTimeout=5e3,this.onlineReconnectListener=void 0,this.useCompress=void 0,this.tryDoubleDomain=!1,this.use443PortOnly=!1,this.wsInflateLength=0,this.wsDeflateLength=0,this.closeEstablishingWs=()=>{},this.store=void 0,this.joinGatewayRecordIndex=void 0,this.store=s,this.name=t,this.retryConfig=F({},n),this.useCompress=i,this.tryDoubleDomain=r,this.use443PortOnly=o;const{timeout:a,timeoutFactor:c}=n,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);Tn.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),it.on(es.NETWORK_STATE_CHANGE,(u,h)=>{u!==h&&(this.resetReconnectCount("network state change: ".concat(h," -> ").concat(u)),u===Tn.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}async init(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;const i=await this._initMutex.lock();this.forceCloseTimeout=n,this.urls=t,this.state="connecting";try{const r=rd(),o=this.urls[this.currentURLIndex];this.createWebSocketConnection(o).then(r.resolve).catch(r.reject),this.once(ne.CLOSED,()=>{r.reject(new L(C.WS_DISCONNECT))}),this.once(ne.CONNECTED,r.resolve),await r.promise}catch{}finally{i()}}close(t,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;const i=this.websocket;n?setTimeout(()=>i.close(),500):i.close(),this.websocket=void 0}this.state=t?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(t,n){if(!this.websocket)return void f.warning("[".concat(this.name,"] can not reconnect, no websocket"));t!==void 0&&(this.reconnectMode=t),f.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(n)]},this.joinGatewayRecordIndex);const i=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),i&&i.bind(this.websocket)({code:9999,reason:n})}sendMessage(t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new L(C.WS_ABORT,"websocket is not ready");try{n||(t=JSON.stringify(t)),this.websocket.send(t)}catch(i){throw new L(C.WS_ERR,"send websocket message error"+i.toString())}}setWsInflateData(t){this.wsDeflateLength=this.wsDeflateLength+t.originLength,this.wsInflateLength=this.wsInflateLength+t.compressedLength}getWsInflateData(){const t=this.wsInflateLength,n=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:t,wsDeflateLength:n}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}async createWebSocketConnection(t){var n;const i=rd();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;const r=l=>{var u;(u=this.store)===null||u===void 0||u.signalChannelOpen(),f.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),i.resolve()},o=async l=>{var u;if(f.debug("[".concat(this.name,"] websocket close ").concat((u=this.websocket)===null||u===void 0?void 0:u.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)i.reject(new L(C.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const h=Gn(this,ne.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void f.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!p)return i.reject(new L(C.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);i.resolve()}},s=l=>{this.emit(ne.ON_MESSAGE,l)},a=l=>{f.warn("[".concat(this.connectionID,"] ws open error ").concat(l))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),A("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(t=A("GATEWAY_WSS_ADDRESS")),f.debug("[".concat(this.name,"] start connect, url:"),t);const c=(n=this.store)===null||n===void 0?void 0:n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;const l=await this.chooseBestWebsocketConnection(t);this.websocket=l,r&&r(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=s,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(l){const u=this.state==="closed",h=l instanceof L,p=h&&l.code===C.WS_ABORT,m=h&&l.code===C.WS_ERR,E=h?l.message:l&&(l.reason||l.toString());f.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(E)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:p?"aborted":"error",errors:[l]},c),u||m?(i.reject(u?new L(C.WS_DISCONNECT,"websocket is closed: ".concat(E)):new L(C.WS_ERR,"init websocket failed: ".concat(E))),m&&f.error("[".concat(this.name,"] init websocket failed: ").concat(E))):o&&o(l)}return i.promise}async reconnectWithAction(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;f.warning("[choose-best-ws] action: =>",t),this.onlineReconnectListener||it.isOnline||!it.onlineWaiter||(this.onlineReconnectListener=it.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let i=!0;if(this.reconnectInterrupter=()=>i=!1,n){const s=_h(this.reconnectCount,this.retryConfig);f.debug("[".concat(this.name,"] wait ").concat(s,"ms to reconnect websocket, mode: ").concat(t)),await Promise.race([Pt(s),this.onlineReconnectListener||new Promise(()=>{})])}if(this._state==="closed"||!i)return!1;this.reconnectCount+=1;const r=async(s,a)=>{this.emit(ne.RECONNECT_CREATE_CONNECTION,a),await this.createWebSocketConnection(s)};try{if(t==="retry")this.emit(ne.RECONNECT_WAITTING_FINISH,t),await r(this.urls[this.currentURLIndex],t);else if(t==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);f.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),this.emit(ne.RECONNECT_WAITTING_FINISH,t),await r(this.urls[this.currentURLIndex],t)}else t==="recover"&&(f.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.emit(ne.RECONNECT_WAITTING_FINISH,t),this.urls=await Tt(this,ne.REQUEST_NEW_URLS),this.currentURLIndex=0,await r(this.urls[this.currentURLIndex],t))}catch(s){var o;f.error("[".concat(this.name,"] reconnect failed ").concat(s&&s.toString()));const a=s==null||(o=s.data)===null||o===void 0?void 0:o.desc;return Array.isArray(a)&&a.includes("dynamic key expired")?(this.emit(ne.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(t,n)}return!0}}class fd extends nw{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){const i=rd(),r=(o=this.forceCloseTimeout,s=this.store,new RM(o,s));var o,s;this.closeEstablishingWs=()=>{f.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),i.reject(new L(C.WS_ABORT,"choose best websocket aborted"))};const a=A("GATEWAY_DOMAINS");return f.debug("[choose-best-ws] currentDomain: ",t,", domains: ",a,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(t,this.tryDoubleDomain,this.use443PortOnly,n).then(i.resolve).catch(i.reject),i.promise.finally(()=>{this.closeEstablishingWs=void 0})}}class Ed extends nw{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}async chooseBestWebsocketConnection(t,n){return new Promise((i,r)=>{let o=!1;const s=[];this.closeEstablishingWs=()=>{f.debug("[choose-best-ws] close establishing websockets"),s.forEach(m=>{m.onclose=null,m.onopen=null,m.onmessage=null,m.close()}),r(new L(C.WS_ABORT,"choose best websocket aborted"))};const a=A("GATEWAY_DOMAINS");let c;const d=t.indexOf("?h="),l=a.find(m=>d!==-1?t.includes(m,d):t.includes(m));f.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let u=!this.tryDoubleDomain||!l;if(!u&&l){var h;const m=Date.now();try{a.forEach(E=>{const g=d===-1?t.replace(l,E):t.substr(0,d)+t.substr(d).replace(l,E),S=new WebSocket(g);S.binaryType="arraybuffer",s.push(S),f.debug("[choose-best-ws] ws is connecting:",S.url)})}catch{for(f.debug("[choose-best-ws] ws create failed, fallback to single url"),s.forEach(g=>g.close());s.length;)s.pop();u=!0}(h=this.store)===null||h===void 0||h.recordJoinChannelService({urls:s.map(E=>E.url),service:"gateway"},n),s.forEach(E=>{E.onopen=()=>{if(o)return;const g=Date.now()-m;f.debug("[choose-best-ws] ws open cost ".concat(g,"ms")),s.filter(S=>S!==E).forEach(S=>{f.debug("[choose-best-ws]close backup websocket: ".concat(S.url)),S.close()}),o=!0,i(E)},E.onclose=g=>{c=g,!o&&(s.find(S=>!(S.readyState===WebSocket.CLOSED||S.readyState===WebSocket.CLOSING))||(f.debug("[choose-best-ws] all websocket is closed"),o=!0,r(c)))},E.onmessage=g=>{f.debug("[choose-best-ws]".concat(E.url," onmessage: ").concat(g.data))}}),Pt(this.forceCloseTimeout).then(()=>{s.forEach(E=>{E.readyState!==WebSocket.OPEN&&E.close()})})}if(u){var p;let m;f.debug("[choose-best-ws] use single url: ",t),(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:[t],service:"gateway"},n);try{m=new WebSocket(t),s.push(m),m.binaryType="arraybuffer"}catch(E){const g=new L(C.WS_ERR,"init websocket failed! Error: ".concat(E.toString()));return f.error("[".concat(this.name,"]").concat(g)),void r(g)}m.onopen=()=>{i(m)},m.onclose=E=>{r(E)},m.onmessage=E=>{f.debug("[choose-best-ws]".concat(m.url," onmessage: ").concat(E.data))},Pt(this.forceCloseTimeout).then(()=>{m&&m.readyState!==WebSocket.OPEN&&m.close()})}}).then(i=>(this.closeEstablishingWs=void 0,i)).catch(i=>{throw this.closeEstablishingWs=void 0,i})}}class AR extends qe{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===he.CONNECTED?this.emit(H.WS_CONNECTED):t===he.RECONNECTING?this.emit(H.WS_RECONNECTING,this._websocketReconnectReason):t===he.CLOSED&&this.emit(H.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=he.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new UE(5),this.pingpongTimer=void 0,this.wsInflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=i=>{if(i.data instanceof ArrayBuffer)return void this.emit(H.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===ie.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ie.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(fe.UID_BANNED);break;case 15:this.close(fe.IP_BANNED);break;case 16:this.close(fe.CHANNEL_BANNED)}if(r._type===ie.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case Q.ERR_LICENSE_MISSING:this.close(fe.LICENSE_MISSING);break;case Q.ERR_LICENSE_EXPIRED:this.close(fe.LICENSE_EXPIRED);break;case Q.ERR_LICENSE_MINUTES_EXCEEDED:this.close(fe.LICENSE_MINUTES_EXCEEDED);break;case Q.ERR_LICENSE_PERIOD_INVALID:this.close(fe.LICENSE_PERIOD_INVALID);break;case Q.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(fe.LICENSE_MULTIPLE_SDK_SERVICE);break;case Q.ERR_LICENSE_ILLEGAL:this.close(fe.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new fd("gateway-".concat(this.clientId),this.spec.retryConfig,!0,A("JOIN_GATEWAY_USE_DUAL_DOMAIN"),A("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===he.CONNECTED&&this.reconnect("retry",Zt.OFFLINE)})}async request(t,n,i,r){const o=et(6,""),s={_id:o,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new Promise((m,E)=>{if(this.connectionState===he.CONNECTED)return m();const g=()=>{this.off(H.WS_CLOSED,S),m()},S=()=>{this.off(H.WS_CONNECTED,g),E(new N(C.WS_ABORT))};this.once(H.WS_CONNECTED,g),this.once(H.WS_CLOSED,S),t!==$.PUBLISH&&t!==$.PUBLISH_DATASTREAM&&t!==$.SUBSCRIBE&&t!==$.SUBSCRIBE_DATASTREAM&&t!==$.UNSUBSCRIBE&&t!==$.UNSUBSCRIBE_DATASTREAM&&t!==$.UNPUBLISH&&t!==$.UNPUBLISH_DATASTREAM&&t!==$.CONTROL&&t!==$.RESTART_ICE||this.once(H.DISCONNECT_P2P,()=>{E(new N(C.DISCONNECT_P2P))}),t!==$.PUBLISH&&t!==$.RESTART_ICE||this.once(H.ABORT_P2P_EXECUTION,()=>{E(new N(C.DISCONNECT_P2P))})});if(this.connectionState!==he.CONNECTING&&this.connectionState!==he.RECONNECTING||t===$.JOIN||t===$.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;const d=new Promise((m,E)=>{let g=!1;const S=(I,y)=>{g=!0,m({isSuccess:I==="success",message:y||{}}),this.off(H.WS_CLOSED,T),this.off(H.WS_RECONNECTING,T),this.emit(H.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(o),S);const T=()=>{E(new N(C.WS_ABORT,"type: ".concat(t))),this.off(H.WS_CLOSED,T),this.off(H.WS_RECONNECTING,T),this.off("res-@".concat(o),S)};this.once(H.WS_CLOSED,T),this.once(H.WS_RECONNECTING,T),Pt(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(f.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(H.REQUEST_TIMEOUT,t,n))})});let l=null;try{l=await d}catch(m){if(this.connectionState===he.CLOSED||t===$.LEAVE)throw new N(C.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?m.throw():t===$.JOIN||t===$.REJOIN?null:(await c(),await this.request(t,n))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),h=vs(u),p=new N(C.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return h.action==="success"?l.message:(f.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===Q.ERR_TOO_MANY_BROADCASTERS?((t===$.JOIN||t===$.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===Q.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,f.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Zt.MULTI_IP)):this.reconnect(h.action,Zt.SERVER_ERROR),t===$.JOIN||t===$.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new Promise(i=>{const r=o=>{(!n||n(o))&&(this.off(t,r),i(o))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void f.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Cs.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const o=A("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==he.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},A("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const i={_type:t,_message:n};this.websocket.sendMessage(i)}init(t,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise((i,r)=>{this.once(H.WS_CONNECTED,()=>i(this.joinResponse)),this.once(H.WS_CLOSED,()=>r(this.initError||new N(C.WS_ABORT))),this.connectionState=he.CONNECTING,this.websocket.init(t).catch(r),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||fe.LEAVE,this.connectionState=he.CLOSED,f.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===fe.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new fd("gateway-".concat(this.clientId),this.spec.retryConfig,!0,A("JOIN_GATEWAY_USE_DUAL_DOMAIN"),A("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(H.ABORT_P2P_EXECUTION);const t=await Tt(this,H.REQUEST_JOIN_INFO),n=await this.request($.JOIN,t);if(!n)return this.emit(H.REPORT_JOIN_GATEWAY,Rc.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(H.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=he.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new N(C.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=gs(this,H.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const n=await this.request($.REJOIN,t);return!!n&&(this.connectionState=he.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(i=>{this.emit(ie.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(ie.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(ie.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(ie.MUTE_AUDIO,{uid:i.uid}):this.emit(ie.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(ie.MUTE_VIDEO,{uid:i.uid}):this.emit(ie.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(ie.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(ie.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(ie.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(ie.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(ie.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}handleNotification(t){f.debug("[".concat(this.clientId,"] receive notification: "),t);const n=vs(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(fe.UID_BANNED),void this.close()):void this.reconnect(n.action,Zt.SERVER_ERROR);f.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=A("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(f.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>A("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Zt.TIMEOUT):this.request($.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),A("REPORT_STATS")&&this.send($.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWsInflateData(){const{wsInflateLength:t,wsDeflateLength:n}=this.websocket.getWsInflateData();t!==0&&n!==0&&this.upload(Cs.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(ne.RECONNECT_WAITTING_FINISH,t=>{this.emit(H.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(ne.RECONNECT_CREATE_CONNECTION,t=>{this.emit(H.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(ne.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ne.CLOSED,()=>{this.connectionState=he.CLOSED}),this.websocket.on(ne.FAILED,()=>{this._disconnectedReason=fe.NETWORK_ERROR,this.connectionState=he.CLOSED}),this.websocket.on(ne.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===he.CONNECTED?this.connectionState=he.RECONNECTING:this.connectionState=he.CONNECTING}),this.websocket.on(ne.WILL_RECONNECT,(t,n,i)=>{const r=gs(this,H.IS_P2P_DISCONNECTED),o=r||t!=="retry";r&&t==="retry"&&(f.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),t="tryNext",n=Rc.P2P_DISCONNECTED),o&&(f.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(t)),this.emit(H.REPORT_JOIN_GATEWAY,n||Rc.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(H.NEED_RENEW_SESSION,this.websocket.currentURLIndex>=this.websocket.urls.length-1?"recover":t),this.emit(H.DISCONNECT_P2P)),i(t)}),this.websocket.on(ne.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{f.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Zt.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(H.REPORT_JOIN_GATEWAY,t.message||t.code||Rc.UNKNOWN_REASON,this.url||""),t instanceof N){if(t.code===C.UNEXPECTED_RESPONSE&&t.data.code===Q.ERR_NO_AUTHORIZED)return this.initError=new N(C.CAN_NOT_GET_GATEWAY_SERVER,"AgoraRTCError CAN_NOT_GET_GATEWAY_SERVER: dynamic key expired"),f.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Zt.SERVER_ERROR);f.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Zt.SERVER_ERROR):(this.initError=t,this.close())}})}),this.websocket.on(ne.REQUEST_NEW_URLS,(t,n)=>{Tt(this,H.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)}),this.websocket.on(ne.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ie.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}let ft=function(e){return e[e.CHOOSE_SERVER=11]="CHOOSE_SERVER",e[e.CLOUD_PROXY=18]="CLOUD_PROXY",e[e.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",e[e.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",e}({});function go(e){return e.match(/^[\.\:\d]+$/)?"".concat(e.replace(/[^\d]/g,"-"),".").concat(A("TURN_DOMAIN")):(f.info("Unidentified as ip: ".concat(e,", use as host")),e)}function XE(e,t){e.addresses||(e.addresses=[]);const n=function(r,o){if(A("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return r.map(c=>{let{ip:d,port:l}=c;return{address:"".concat(d,":").concat(l)}});const s=A("GATEWAY_DOMAINS");let a=s[1]&&o.includes(s[1])?1:0;return r.map(c=>{let{domain_prefix:d,port:l,ip:u}=c;if(d)return{address:"".concat(d,".").concat(s[a++%s.length],":").concat(l)};const h=/^[\.\:\d]+$/.test(u),p=h?"".concat(u.replace(/[^\d]/g,"-"),".").concat(s[a++%s.length],":").concat(l):"".concat(u,":").concat(l);return h||f.info("Unidentified as ip: ".concat(u,", use as host")),{ip:u,port:l,address:p}})}(e.addresses,t),i=Array.isArray(e.detail)&&e.detail[18];if(i&&typeof i=="string"){const r=i.split(";");for(let o=0;o<r.length;o++){const s=r[o].trim();n[o]&&s&&(n[o].ip6=s)}}return{gatewayAddrs:n,uid:e.uid,cid:e.cid,cert:e.cert,vid:e.detail&&e.detail[8],uni_lbs_ip:e.detail&&e.detail[1],res:e,csIp:e.detail&&e.detail[502]}}function kn(e){return typeof e=="number"?e:e.exact||e.ideal||e.max||e.min||0}function wR(e){const t=e._encoderConfig;if(!t)return{};const n={resolution:t.width&&t.height?"".concat(kn(t.width),"x").concat(kn(t.height)):void 0,maxVideoBW:t.bitrateMax,minVideoBW:t.bitrateMin};return typeof t.frameRate=="number"?(n.maxFrameRate=t.frameRate,n.minFrameRate=t.frameRate):t.frameRate&&(n.maxFrameRate=t.frameRate.max||t.frameRate.ideal||t.frameRate.exact||t.frameRate.min,n.minFrameRate=t.frameRate.min||t.frameRate.ideal||t.frameRate.exact||t.frameRate.max),n}function NR(e){return e>=0&&e<.17?1:e>=.17&&e<.36?2:e>=.36&&e<.59?3:e>=.59&&e<=1?4:e>1?5:0}function md(e,t){let n,i,r;switch(t){case ft.CHOOSE_SERVER:i=4096,r="choose server";break;case ft.CLOUD_PROXY:i=1048576,r="proxy";break;case ft.CLOUD_PROXY_5:i=4194304,r="proxy5";break;case ft.CLOUD_PROXY_FALLBACK:i=4194310,r="proxy fallback";break;default:throw new N(C.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:e.detail&&e.detail[502],retry:!1})}if(e.response_body.forEach(o=>{o.buffer&&o.buffer.flag===i&&(n={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>F(F({},s),{},{ticket:o.buffer.cert})),server_ts:e.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:F(F({},o.buffer.detail),e.detail),flag:o.buffer.flag,opid:e.opid,cert:o.buffer.cert})}),!n)throw new N(C.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:e.detail&&e.detail[502]});return n}async function iw(e,t){return await Promise.all(e.addresses.map(async n=>({address:go(n.ip),tcpport:n.port,udpport:n.port,username:t&&A("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?t.toString():Jt.username,password:t&&A("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?await lf(t.toString()):Jt.password})))}function wf(e,t){const n=t.getMediaStreamTrack(!0).getSettings(),i=t.videoHeight||n.height,r=t.videoWidth||n.width;return i&&r?Math.max(Math.min(i,r)/Math.min(kn(e.height),kn(e.width)),1):(f.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function So(e){let{candidateType:t,relayProtocol:n,type:i,address:r,port:o,protocol:s}=e;return i==="local-candidate"?{candidateType:t,relayProtocol:n,protocol:s}:{candidateType:t,relayProtocol:n,address:r,port:o,protocol:s}}class CM extends qe{get url(){return this._url?this._url:null}get reconnectMode(){return this._reconnectMode}set reconnectMode(t){["tryNext","recover"].includes(t)&&this.resetReconnectCount(t),this._reconnectMode=t}get state(){return this._state}set state(t){t!==this._state&&(this._state=t,this._state==="reconnecting"?this.emit(gt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(gt.CONNECTED):this._state==="closed"?this.emit(gt.CLOSED):this._state==="failed"&&this.emit(gt.FAILED))}constructor(t,n,i,r){super(),this.connectionID=0,this.currentURLIndex=0,this.reconnectReason=void 0,this._reconnectMode="tryNext",this._initMutex=void 0,this._name=void 0,this._state="closed",this._reconnectInterrupter=void 0,this._url=void 0,this._retryConfig=void 0,this._reconnectCount=0,this._forceCloseTimeout=5e3,this._onlineReconnectListener=void 0,this._closeEstablishingTransmitter=()=>{},this._store=void 0,this._joinChannelServiceRecordIndex=void 0,this._transmitter=void 0,this._useCompress=void 0,this._inflateLength=0,this._deflateLength=0,this._store=r,this._name=t,this._retryConfig=F({},n),this._useCompress=i}resetReconnectCount(t){f.debug("".concat(this._name," reset reconnect count, reason: ").concat(t)),this._reconnectCount=0}close(t,n){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this._reconnectInterrupter&&this._reconnectInterrupter(),this._transmitter){this._transmitter.onclose=null,this._transmitter.onopen=null,this._transmitter.onmessage=null;const i=this._transmitter;n?setTimeout(()=>i.close(),500):i.close(),this._transmitter=void 0}this.state=t?"failed":"closed",this._closeEstablishingTransmitter&&this._closeEstablishingTransmitter()}reconnect(t,n){if(!this._transmitter)return void f.warning("[".concat(this._name,"] can not reconnect, no websocket"));var i;t!==void 0&&(this.reconnectMode=t),f.debug("[".concat(this._name,"] reconnect is triggered initiative")),typeof this._joinChannelServiceRecordIndex=="number"&&((i=this._store)===null||i===void 0||i.recordJoinChannelService({status:"error",errors:[new Error(n)]},this._joinChannelServiceRecordIndex));const r=this._transmitter.onclose;this._transmitter.onclose=null,this._transmitter.close(),r&&r.bind(this._transmitter)({code:9999,reason:n})}getInflateData(){const t=this._inflateLength,n=this._deflateLength;return this.clearInflateData(),{inflateLength:t,deflateLength:n}}setInflateData(t){this._deflateLength=this._deflateLength+t.originLength,this._inflateLength=this._inflateLength+t.compressedLength}clearInflateData(){this._inflateLength=0,this._deflateLength=0}}let Gi=function(e){return e[e.Default=0]="Default",e[e.Ack=1]="Ack",e}({});class vM{constructor(t,n,i){this.version=1,this.initialRTO=void 0,this.maxBatchAckCount=void 0,this.maxRTO=void 0,this.initialRTT=void 0,this.ID=void 0,this.rtt=void 0,this.packetNumber=1,this.rtoRatioMap=new Map,this.timeoutMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer=void 0,this.sendImpl=void 0,this.receiveImpl=void 0,this.sendImpl=t,this.receiveImpl=n,this.ID=et(7,"transmitter-"),this.initialRTO=(i==null?void 0:i.initialRTO)!==void 0?i.initialRTO:A("TRANSMITTER_INITIAL_RTO"),this.initialRTT=(i==null?void 0:i.initialRTT)!==void 0?i.initialRTT:A("TRANSMITTER_INITIAL_RTT"),this.rtt=(i==null?void 0:i.initialRTT)!==void 0?i.initialRTT:A("TRANSMITTER_INITIAL_RTT"),this.maxBatchAckCount=(i==null?void 0:i.maxBatchAckCount)!==void 0?i.maxBatchAckCount:A("TRANSMITTER_MAX_BATCH_ACK_COUNT"),this.maxRTO=(i==null?void 0:i.maxRTO)!==void 0?i.maxRTO:A("TRANSMITTER_MAX_RTO")}packetize(t,n){return{type:Gi.Default,version:this.version,packetNumber:n,payload:t}}serialize(t){switch(t.type){case Gi.Default:{let n;typeof t.payload=="string"?n=new TextEncoder().encode(t.payload):n=t.payload;const i=new ArrayBuffer(n.length+15),r=new DataView(i);return r.setUint16(0,t.version),r.setUint8(2,t.type),r.setUint32(3,t.packetNumber),Yg(r,7,BigInt(t.sendTs)),new Uint8Array(r.buffer).set(n,15),i}case Gi.Ack:{const n=new ArrayBuffer(16),i=new DataView(n);return i.setUint16(0,t.version),i.setUint8(2,t.type),i.setUint32(3,t.maxAckPacketNumber),i.setUint8(7,t.shift),Yg(i,8,BigInt(t.ackSendTs)),n}}}deserialize(t){const n=new DataView(t),i=n.getUint16(0),r=n.getUint8(2);switch(r){case Gi.Default:{const o=n.getUint32(3),s=zg(n,7),a=t.slice(15),c=new TextDecoder().decode(a);return{version:i,type:r,packetNumber:o,sendTs:Number(s),payload:c}}case Gi.Ack:{const o=n.getUint32(3),s=n.getUint8(7),a=zg(n,8);return{version:i,type:r,maxAckPacketNumber:o,shift:s,ackSendTs:Number(a)}}default:throw f.error("[".concat(this.ID,"] Unrecognized packet type ").concat(r)),new Error("Unrecognized packet type ".concat(r))}}sendMessage(t){const n=this.packetize(t,this.packetNumber);this.packetNumber=this.packetNumber===4294967295?1:this.packetNumber+1;const i=this.calculateRTO(n),r=window.setTimeout(()=>{this.resendMessage(n)},i);this.timeoutMap.set(n.packetNumber,r),this.sendPacket(n)}onData(t){const n=this.deserialize(t);n.type===Gi.Default?this.ack(n):n.type===Gi.Ack&&(this.updateRTT(n,Math.round(performance.now())),this.clearRTO(n))}close(){this.rtt=this.initialRTT,this.packetNumber=1,Array.from(this.timeoutMap.entries()).forEach(t=>{let[n,i]=t;window.clearTimeout(i)}),this.timeoutMap=new Map,this.rtoRatioMap=new Map,this.unorderedPacketQueue=[],this.batchAckPacketQueue=[],this.lastOrderedPacketNumber=0,this.batchAckTimer!==void 0&&window.clearTimeout(this.batchAckTimer)}resendMessage(t){const n=this.calculateRTO(t),i=window.setTimeout(()=>{this.resendMessage(t)},n);this.timeoutMap.set(t.packetNumber,i),this.sendPacket(t)}calculateRTO(t){const n=this.rtoRatioMap.get(t.packetNumber);if(n===void 0)return this.rtoRatioMap.set(t.packetNumber,1),this.initialRTO;{const i=9*this.rtt/8*n;return this.rtoRatioMap.set(t.packetNumber,n+1),i>this.maxRTO?this.maxRTO:i}}updateRTT(t,n){const i=t.ackSendTs;this.rtt=this.rtt*(7/8)+(n-i-this.rtt)/8}ack(t){if(t.packetNumber===this.lastOrderedPacketNumber+1)for(this.batchAckPacketQueue.length>=this.maxBatchAckCount&&this.batchAck(),this.batchAckTimer?this.batchAckPacketQueue.push(t):(this.batchAckPacketQueue.push(t),this.batchAckTimer=window.setTimeout(()=>{this.batchAck()},this.rtt/8)),this.lastOrderedPacketNumber+=1,this.receiveImpl(t.payload);;){const n=this.unorderedPacketQueue[0];if(!n){this.unorderedPacketQueue.shift();break}this.batchAckTimer&&this.batchAck(),this.receiveImpl(n.payload),this.unorderedPacketQueue.shift(),this.lastOrderedPacketNumber+=1}else if(t.packetNumber<=this.lastOrderedPacketNumber){const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Gi.Ack,version:this.version};this.sendPacket(n)}else if(t.packetNumber>this.lastOrderedPacketNumber){this.unorderedPacketQueue[t.packetNumber-this.lastOrderedPacketNumber-2]=t;const n={ackSendTs:t.sendTs,maxAckPacketNumber:t.packetNumber,shift:0,type:Gi.Ack,version:this.version};this.sendPacket(n)}}batchAck(){window.clearTimeout(this.batchAckTimer),this.batchAckTimer=void 0;const t={ackSendTs:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].sendTs,maxAckPacketNumber:this.batchAckPacketQueue[this.batchAckPacketQueue.length-1].packetNumber,shift:this.batchAckPacketQueue.length-1,type:Gi.Ack,version:this.version};this.sendPacket(t),this.batchAckPacketQueue=[]}sendPacket(t){t.type===Gi.Default&&(t.sendTs=Math.round(performance.now()));const n=this.serialize(t);this.sendImpl(n)}clearRTO(t){for(let n=t.maxAckPacketNumber-t.shift;n<=t.maxAckPacketNumber;n++){const i=this.timeoutMap.get(n);i!==void 0&&window.clearTimeout(i),this.timeoutMap.delete(n),this.rtoRatioMap.delete(n)}}}class OR extends CM{constructor(t,n){super(t,n,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3?arguments[3]:void 0),this._initMutex=void 0,this._reconnectInterrupter=void 0,this._url=void 0,this._transmitter=void 0,this._addresses=void 0,this._reliableTransmission=void 0,this._initMutex=new Bt("datachannel");const{timeout:i,timeoutFactor:r}=n,o=Math.max(300,Math.floor(3*i/5)),s=Math.max(1.2,Math.floor(8*r)/10);Tn.ONLINE&&(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s),it.on(es.NETWORK_STATE_CHANGE,(a,c)=>{a!==c&&(this.resetReconnectCount("network state change: ".concat(c," -> ").concat(a)),a===Tn.ONLINE?(this._retryConfig.timeout=o,this._retryConfig.timeoutFactor=s):(this._retryConfig.timeout=i,this._retryConfig.timeoutFactor=r))})}getConnection(){if(this._reliableTransmission)return this._reliableTransmission}async init(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3;this._forceCloseTimeout=n;const i=(r,o)=>{this._addresses=t,this.currentURLIndex=this._addresses.findIndex(a=>a.fingerprint||A("FINGERPRINT"));const s=this._addresses[this.currentURLIndex];this.state="connecting",this.createTransmitterConnection(s).then(r).catch(o),this.once(gt.CLOSED,()=>o(new N(C.WS_DISCONNECT))),this.once(gt.CONNECTED,()=>r())};return this._initMutex.lock().then(r=>new Promise((o,s)=>{i(o,s)}).then(()=>{r()}).catch(()=>{r()}))}sendMessage(t){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this._transmitter||!this._reliableTransmission)throw new N(C.WS_ABORT,"datachannel is not ready");try{n||(t=JSON.stringify(t)),this._reliableTransmission.sendMessage(t)}catch(i){throw new N(C.WS_ERR,"send datachannel signal message error"+i.toString())}}unbindDcCloseEventListener(){this._transmitter&&(this._transmitter.onclose=null)}sendMessageWithJSON(t){const n=JSON.stringify(t);return{compressed:n,compressedLength:n.length,origin:t}}sendMessageWithUint8Array(t){return{compressed:t,compressedLength:t.byteLength,origin:t}}createTransmitterConnection(t){return this.connectionID+=1,this._joinChannelServiceRecordIndex=void 0,this._url="dc://".concat(t.ip,":").concat(t.port),new Promise((n,i)=>{var r;const o=()=>{f.debug("[".concat(this._name,"] datachannel opened:"),this._url),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n()},s=async l=>{var u;if((u=this._closeEstablishingTransmitter)===null||u===void 0||u.call(this),f.debug("[".concat(this._name,"] datachannel close ").concat(this._url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this._reconnectCount<this._retryConfig.maxRetryCount){this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");const h=Gn(this,gt.WILL_RECONNECT,this.reconnectMode)||this.reconnectMode,p=await this.reconnectWithAction(h);if(this.state==="closed")return void f.debug("[".concat(this.connectionID,"] dc is closed, no need to reconnect"));if(!p)return i(new N(C.WS_DISCONNECT,"datachannel reconnect failed: ".concat(l.code))),void this.close(!0);n()}else i(new N(C.WS_DISCONNECT,"datachannel close: ".concat(l.code))),this.close()},a=l=>{var u;(u=this._reliableTransmission)===null||u===void 0||u.onData(l.data)};this._transmitter&&(this._transmitter.onclose=null,this._transmitter.close()),this._reliableTransmission&&(this._reliableTransmission.close(),this._reliableTransmission=void 0),f.debug("[".concat(this._name,"] start connect, address: ").concat(JSON.stringify(t)));const c=(r=this._store)===null||r===void 0?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"}),d=Date.now();Tt(this,gt.TO_CONNECT_DATACHANNEL,t).then(l=>{var u,h;if(!l)throw new Error("transmissonInfo not exist yet");const{transmitter:p,close:m}=l;this._transmitter=p,(u=this._store)===null||u===void 0||u.signalChannelOpen();const E=Date.now()-d;f.debug("[choose dc] dc open cost ".concat(E,"ms")),this._reliableTransmission=new vM(g=>{var S;this._transmitter&&this._transmitter.readyState==="open"&&((S=this._transmitter)===null||S===void 0||S.send(g))},g=>{typeof g=="string"&&this.emit(gt.ON_MESSAGE,g)}),this._closeEstablishingTransmitter=()=>{var g;(g=this._reliableTransmission)===null||g===void 0||g.close(),this._reliableTransmission=void 0,m()},o&&o(),p.onclose=s,p.onmessage=a,(h=this._store)===null||h===void 0||h.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this._joinChannelServiceRecordIndex=c}).catch(l=>{var u;if((u=this._store)===null||u===void 0||u.recordJoinChannelService({endTs:Date.now(),status:l instanceof N&&l.code===C.WS_ABORT?"aborted":"error",errors:[l]},c),this.state!=="closed"){if(l instanceof N&&l.code===C.WS_ERR){const h=new N(C.WS_ERR,"init datachannel failed! Error: ".concat(l.toString()));return f.error("[".concat(this._name,"]").concat(h)),void i(h)}s&&s(l)}else i(new N(C.WS_DISCONNECT,"datachannel is closed: ".concat(l.toString())))})})}async reconnectWithAction(t){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this._reconnectCount>=this._retryConfig.maxRetryCount||!this._addresses||this.state==="closed")return!1;this._onlineReconnectListener||it.networkState!==Tn.OFFLINE||(this._onlineReconnectListener=it.onlineWaiter&&it.onlineWaiter.then(()=>{this._onlineReconnectListener=void 0}));let i=!0;if(this._reconnectInterrupter=()=>{i=!1},n){const s=_h(this._reconnectCount,this._retryConfig);f.debug("[".concat(this._name,"] wait ").concat(s,"ms to reconnect datachannel, mode: ").concat(t)),await Promise.race([Pt(s),this._onlineReconnectListener||new Promise(()=>{})])}if(this.state==="closed"||!i)return!1;this._reconnectCount+=1;const r=async(s,a)=>{this.emit(gt.RECONNECT_CREATE_CONNECTION,a),await this.createTransmitterConnection(s)};try{if(t==="retry"){const s=this._addresses[this.currentURLIndex];this.emit(gt.RECONNECT_WAITTING_FINISH,t),await r(s,t)}else if(t==="tryNext"){this.currentURLIndex+=1;for(let a=this.currentURLIndex;a<this._addresses.length;a++){if(this._addresses[a].fingerprint||A("FINGERPRINT")){this.currentURLIndex=a;break}this.currentURLIndex+=1}if(this.currentURLIndex>=this._addresses.length)return f.debug("[".concat(this._name,"] the available addresses are exhausted, change to recover")),await this.reconnectWithAction("recover",!1);f.debug("[".concat(this._name,"] datachannel url length: ").concat(this._addresses.length," current index: ").concat(this.currentURLIndex));const s=this._addresses[this.currentURLIndex];this.emit(gt.RECONNECT_WAITTING_FINISH,t),await r(s,t)}else t==="recover"&&(f.debug("[".concat(this._name,"] start to failback to websocket")),this.resetReconnectCount("recover mode"),this.emit(gt.RECONNECT_WAITTING_FINISH,t),this.emit(gt.FAILBACK));return!0}catch(s){var o;return f.error("[".concat(this._name,"] reconnect failed"),s.toString()),s!=null&&(o=s.data)!==null&&o!==void 0&&o.desc&&Array.isArray(s.data.desc)&&s.data.desc.length&&s.data.desc.includes("dynamic key expired")?(this.emit(gt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):await this.reconnectWithAction(t,n)}}}class Dr extends qe{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===he.CONNECTED?this.emit(H.WS_CONNECTED):t===he.RECONNECTING?this.emit(H.WS_RECONNECTING,this._websocketReconnectReason):t===he.CLOSED&&this.emit(H.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket?this.websocket.url:null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=he.CLOSED,this.reconnectToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new UE(5),this.pingpongTimer=void 0,this.inflateDataTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this.onWebsocketMessage=i=>{if(i instanceof ArrayBuffer)return void this.emit(H.ON_BINARY_DATA,i);const r=JSON.parse(i);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")&&(this.emit(r._type,r._message),r._type===ie.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ie.ON_USER_BANNED))switch(r._message.error_code){case 14:this.close(fe.UID_BANNED);break;case 15:this.close(fe.IP_BANNED);break;case 16:this.close(fe.CHANNEL_BANNED)}},this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new OR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===he.CONNECTED&&this.reconnect("retry",Zr.OFFLINE)})}async request(t,n,i,r){const o=et(6,""),s={_id:o,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new Promise((m,E)=>{if(this.connectionState===he.CONNECTED)return m();const g=()=>{this.off(H.WS_CLOSED,S),m()},S=()=>{this.off(H.WS_CONNECTED,g),E(new N(C.WS_ABORT))};this.once(H.WS_CONNECTED,g),this.once(H.WS_CLOSED,S),t!==$.PUBLISH&&t!==$.SUBSCRIBE&&t!==$.UNSUBSCRIBE&&t!==$.UNPUBLISH&&t!==$.CONTROL&&t!==$.RESTART_ICE||this.once(H.DISCONNECT_P2P,()=>{E(new N(C.DISCONNECT_P2P))}),t!==$.PUBLISH&&t!==$.RESTART_ICE||this.once(H.ABORT_P2P_EXECUTION,()=>{E(new N(C.DISCONNECT_P2P))})});if(this.connectionState!==he.CONNECTING&&this.connectionState!==he.RECONNECTING||t===$.JOIN||t===$.REJOIN||await c(),t===$.LEAVE&&(this.websocket.unbindDcCloseEventListener(),r=!0),this.websocket.sendMessage(s,!0,!1),r)return;const d=new Promise((m,E)=>{let g=!1;const S=(I,y)=>{g=!0,m({isSuccess:I==="success",message:y||{}}),this.off(H.WS_CLOSED,T),this.off(H.WS_RECONNECTING,T),this.emit(H.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(o),S);const T=()=>{E(new N(C.WS_ABORT,"type: ".concat(t))),this.off(H.WS_CLOSED,T),this.off(H.WS_RECONNECTING,T),this.off("res-@".concat(o),S)};this.once(H.WS_CLOSED,T),this.once(H.WS_RECONNECTING,T),Pt(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(f.warning("dc request timeout, type: ".concat(t)),this.emit(H.REQUEST_TIMEOUT,t,n))})});let l=null;try{l=await d}catch(m){if(this.connectionState===he.CLOSED||t===$.LEAVE)throw new N(C.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?m.throw():t===$.JOIN||t===$.REJOIN?null:(await c(),await this.request(t,n))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),h=vs(u),p=new N(C.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return h.action==="success"?l.message:(f.warning("[".concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===Q.ERR_TOO_MANY_BROADCASTERS?((t===$.JOIN||t===$.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===Q.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,f.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Zr.MULTI_IP)):this.reconnect(h.action,Zr.SERVER_ERROR),t===$.JOIN||t===$.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new Promise(i=>{const r=o=>{(!n||n(o))&&(this.off(t,r),i(o))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void f.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Cs.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const o=A("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==he.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},A("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const i={_type:t,_message:n};this.websocket.sendMessage(i)}init(t,n){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise((i,r)=>{this.once(H.WS_CONNECTED,()=>i(this.joinResponse)),this.once(H.WS_CLOSED,()=>r(this.initError||new N(C.WS_ABORT))),this.connectionState=he.CONNECTING,this.websocket.init(t).catch(r),this.websocket.once(gt.FAILBACK,()=>{this.openConnectionTime===void 0&&r(new N(C.INIT_DATACHANNEL_TIMEOUT))}),this.inflateDataTimer&&window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=window.setInterval(()=>{this.handleInflateData()},2e4),setTimeout(()=>{n&&this.openConnectionTime===void 0&&(f.debug("[".concat(this.clientId,"] init datachannel timeout while join with failback to websocket")),r(new N(C.INIT_DATACHANNEL_TIMEOUT)))},A("DC_JOIN_WITH_FAILBACK"))})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.inflateDataTimer&&(this.handleInflateData(),window.clearInterval(this.inflateDataTimer),this.inflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=t||fe.LEAVE,this.connectionState=he.CLOSED,f.debug("[".concat(this.clientId,"] ")+"will close datachannel in signal"),this.websocket.close(),t===fe.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new OR("gateway-".concat(this.clientId),this.spec.retryConfig,!0,this.store),this.handleWebsocketEvents())}async join(){if(!this.joinResponse){this.emit(H.ABORT_P2P_EXECUTION);const t=await Tt(this,H.DATACHANNEL_CONNECTING),n=await this.request($.JOIN,t);if(!n)return this.emit(H.REPORT_JOIN_GATEWAY,C.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(H.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=he.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}async rejoin(){if(!this.reconnectToken)throw new N(C.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");const t=gs(this,H.REQUEST_REJOIN_INFO);t.token=this.reconnectToken;const n=await this.request($.REJOIN,t);return!!n&&(this.connectionState=he.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),n.peers&&n.peers.forEach(i=>{this.emit(ie.ON_USER_ONLINE,{uid:i.uid}),i.audio&&this.emit(ie.ON_ADD_AUDIO_STREAM,{uid:i.uid,uint_id:i.uint_id,audio:!0,ssrcId:i.audio_ssrc}),i.video&&this.emit(ie.ON_ADD_VIDEO_STREAM,{uid:i.uid,uint_id:i.uint_id,video:!0,ssrcId:i.video_ssrc}),i.audio_mute?this.emit(ie.MUTE_AUDIO,{uid:i.uid}):this.emit(ie.UNMUTE_AUDIO,{uid:i.uid}),i.video_mute?this.emit(ie.MUTE_VIDEO,{uid:i.uid}):this.emit(ie.UNMUTE_VIDEO,{uid:i.uid}),i.audio_enable_local?this.emit(ie.ENABLE_LOCAL_AUDIO,{uid:i.uid}):this.emit(ie.DISABLE_LOCAL_AUDIO,{uid:i.uid}),i.video_enable_local?this.emit(ie.ENABLE_LOCAL_VIDEO,{uid:i.uid}):this.emit(ie.DISABLE_LOCAL_VIDEO,{uid:i.uid}),i.audio||i.video||this.emit(ie.ON_REMOVE_STREAM,{uid:i.uid,uint_id:i.uint_id})}),!0)}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}handleNotification(t){f.debug("[".concat(this.clientId,"] receive notification: "),t);const n=vs(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(fe.UID_BANNED),void this.close()):void this.reconnect(n.action,Zr.SERVER_ERROR);f.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=A("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(f.warning("PINGPONG Timeout. Last Socket Message: ".concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>A("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Zr.TIMEOUT):this.request($.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),A("REPORT_STATS")&&this.send($.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleInflateData(){const{inflateLength:t,deflateLength:n}=this.websocket.getInflateData();t!==0&&n!==0&&this.upload(Cs.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:n,ws_inflate_length:t})}handleWebsocketEvents(){this.websocket.on(gt.RECONNECT_WAITTING_FINISH,t=>{this.emit(H.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(gt.RECONNECT_CREATE_CONNECTION,t=>{this.emit(H.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(gt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(gt.CLOSED,()=>{this.connectionState=he.CLOSED}),this.websocket.on(gt.FAILED,()=>{this._disconnectedReason=fe.NETWORK_ERROR,this.connectionState=he.CLOSED}),this.websocket.on(gt.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===he.CONNECTED?this.connectionState=he.RECONNECTING:this.connectionState=he.CONNECTING}),this.websocket.on(gt.WILL_RECONNECT,(t,n)=>{if(gs(this,H.IS_P2P_DISCONNECTED)&&t==="retry")return f.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),this.reconnectToken=void 0,this.emit(H.NEED_RENEW_SESSION),this.emit(H.DISCONNECT_P2P),n("tryNext");t!=="retry"&&(f.debug("".concat(this.clientId," websockt will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(H.NEED_RENEW_SESSION),this.emit(H.DISCONNECT_P2P)),n(t)}),this.websocket.on(gt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(t=>{f.warning("[".concat(this.clientId,"] rejoin failed ").concat(t)),this.reconnect("tryNext",Zr.SERVER_ERROR)}):this.join().catch(t=>{if(this.emit(H.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof N&&t.code===C.UNEXPECTED_RESPONSE&&t.data.code===Q.ERR_NO_AUTHORIZED)return f.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Zr.SERVER_ERROR);f.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Zr.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(gt.REQUEST_NEW_URLS,(t,n)=>{Tt(this,H.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)}),this.websocket.on(gt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ie.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(gt.TO_CONNECT_DATACHANNEL,async(t,n,i)=>Tt(this,H.DATACHANNEL_PRECONNECT,t).then(n).catch(i)),this.websocket.on(gt.FAILBACK,()=>{this.openConnectionTime!==void 0&&this.emit(H.DATACHANNEL_FAILBACK)})}}class Is extends qe{constructor(t,n){super(),this.signal=void 0,this.token=void 0,this.tokenTimeout=void 0,this.tokenInterval=void 0,this._sequence=0,this.userMap=new Map,this.encoder=new TextEncoder,this.signal=t,this.token=n;const i=()=>{this.signal.connectionState===he.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(i,1e3):this.tokenInterval=window.setTimeout(i,3*A("P2P_TOKEN_INTERVAL"))};i()}async send(t,n,i,r,o){var s,a;if(this.userMap.size===0)return;const c=Array.from(this.userMap.values())[0].token;typeof n!="string"&&(n=JSON.stringify(n)),r=(s=r)!==null&&s!==void 0?s:et(6,""),o=(a=o)!==null&&a!==void 0?a:this._sequence++;const d={_id:r,_type:t,_seq:o,_message:n,token:"".concat(this.token,"_").concat(c)};A("SHOW_P2P_LOG")&&f.debug("send message",d,"noNeedResponse : ".concat(i)),this.splitMessage(JSON.stringify(d)).forEach(u=>{this.signal.request($.DATA_STREAM,{payload:No(this.encoder.encode(u))})});const l=new Promise((u,h)=>{const p=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),m),this.off("res-@".concat(r),g),this.off(Fs.ABORT,E),f.debug("[external-signal] request timeout, type: ".concat(t,", requestId: ").concat(r)),this.userMap.size===0?h(new L(C.INVALID_REMOTE_USER)):h(new L(C.TIMEOUT))},A("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),m=()=>{p&&window.clearTimeout(p),this.off(Fs.ABORT,E),i&&u()},E=()=>{p&&window.clearTimeout(p),this.off("res-@".concat(r,"_ack"),m),this.off("res-@".concat(r),g),h(new L(C.EXTERNAL_SIGNAL_ABORT,"type: ".concat(t,", requestId: ").concat(r)))};this.once(Fs.ABORT,E),this.once("res-@".concat(r,"_ack"),m);const g=(T,I)=>{S=!0,p&&window.clearTimeout(p),this.off("res-@".concat(r,"_ack"),m),this.off(Fs.ABORT,E),T==="success"?u(I):h(new L(C.P2P_MESSAGE_FAILED,"request ".concat(t," failed, requestId: ").concat(r)))};let S=!1;i||(this.once("res-@".concat(r),g),Pt(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{S||f.warning("external_signal request timeout, type: ".concat(t,", requestId: ").concat(r,", ").concat(d))}))});try{return await l}catch(u){if(u.code===C.TIMEOUT)return await this.send(t,n,i,r,o);throw u}}onMessage(t){const{_uid:n}=t;let i,r=this.userMap.get(n);if(r)i=r.splitMessageMap;else{if(this.userMap.size>0||!("_type"in t)||t._type!==at.CHECK)return;const{token:c}=t;i=new Map,r={uid:n,isStart:!0,token:c,splitMessageMap:i,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(n,r),this.signal.emit(ie.ON_USER_ONLINE,{uid:n}),this.handleUserOnline()}if("id"in t&&"total"in t){var o;const{id:c,total:d}=t,l=(o=i.get(c))!==null&&o!==void 0?o:[];if(l.push(t),i.has(c)||i.set(c,l),l.length!==d)return;{const u=l.sort((h,p)=>h.index-p.index).map(h=>h.payload).join("");i.delete(c),(t=JSON.parse(u))._uid=n}}const{_type:s,token:a}=t;if([at.ACK,at.CHECK].includes(s))return s===at.CHECK&&this.handleCheckToken(r,a),void this.receiveMessage(t);a==="".concat(r.token,"_").concat(this.token)?this.handleReceivedMessage(t):f.debug('Receive unexpected message", '.concat(a,", cur_token: ").concat(r.token,"_").concat(this.token),t)}check(){const t={_id:et(6,""),token:this.token,_type:at.CHECK};A("SHOW_P2P_LOG")&&f.debug("send message",t),this.signal.request($.DATA_STREAM,{payload:No(this.encoder.encode(JSON.stringify(t)))})}ack(t){const n={_id:t,_type:at.ACK,token:this.token};A("SHOW_P2P_LOG")&&f.debug("send message",n),this.signal.request($.DATA_STREAM,{payload:No(this.encoder.encode(JSON.stringify(n)))})}response(t,n,i){this.send(at.RESPONSE,JSON.stringify({success:!i,message:n}),!0,t)}handleReceivedMessage(t){const n=()=>{this.userMap.forEach(d=>{const{receivedMessagesMap:l,nextExpectedSequenceNumber:u}=d;for(;l.has(u);){const h=l.get(u);l.delete(u),this.receiveMessage(h),d.nextExpectedSequenceNumber++}})};if(!t)return void n();const{_uid:i,_seq:r}=t,o=this.userMap.get(i),{receivedMessagesMap:s,isStart:a,nextExpectedSequenceNumber:c}=o;if(r<c)return this.ack(t._id),void f.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(t._message));s.set(r,t),a&&r===c&&(this.receiveMessage(t),s.delete(c),o.nextExpectedSequenceNumber++,n())}receiveMessage(t){const{_id:n,_type:i,_message:r,_uid:o}=t;if(A("SHOW_P2P_LOG")&&f.debug("receive message",t),n){let s;switch(t._type!==at.ACK&&(r&&(s=JSON.parse(r)),this.ack(t._id)),t._type){case at.CANDIDATE:case at.CONTROL:this.signal.emit(i,s,o);break;case at.PUBLISH:case at.UNPUBLISH:case at.RESTART_ICE:case at.CALL:s.uid=o,Tt(this.signal,i,s).then(a=>{this.response(t._id,a)}).catch(()=>{this.response(t._id,void 0,!0)});break;case at.ACK:this.getListeners("res-@".concat(n,"_ack")).length>0&&this.emit("res-@".concat(n,"_ack"));break;case at.RESPONSE:{const{success:a,message:c}=s;this.emit("res-@".concat(n),a?"success":"failed",c);break}}}}splitMessage(t){if(t.length<Is.MAX_MESSAGE_SIZE)return[t];const n=[],{remoteToken:i}=JSON.parse(t),r=et(6,"");let o=0,s=800;const a=Math.ceil(t.length/s);for(;t.length>0;){o++;const c={id:r,index:o,total:a,payload:t.slice(0,s),token:"".concat(this.token,"_").concat(i)};JSON.stringify(c).length>Is.MAX_MESSAGE_SIZE?s-=50:(n.push(c),t=t.slice(s))}return n.map(c=>JSON.stringify(c))}handleCheckToken(t,n){return t.token!==n?(f.debug("token changed, from ".concat(t.token," to ").concat(n)),this.reset(t.uid,n),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{f.debug("token timeout, ".concat(n)),this.reset(t.uid)},A("MAX_P2P_TIMEOUT")),!0)}async handleUserOnline(){const t=await Tt(this.signal,at.CALL,void 0),n=await this.send(at.CALL,t);this.signal.emit(H.P2P_CONNECTION,n,!0)}async reset(t,n){const i=this.userMap.get(t);i&&(this.emit(Fs.ABORT),this.signal.emit(ie.ON_USER_OFFLINE,{uid:i.uid,reason:pM.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),n||(f.debug("change local token from ".concat(n," to ").concat(n)),this.token=et(6,"")))}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit(Fs.ABORT)}}Is.MAX_SIZE=1,Is.MAX_MESSAGE_SIZE=1024;class bR extends qe{get connectionState(){return this._connectionState}set connectionState(t){t!==this._connectionState&&(this._connectionState=t,t===he.CONNECTED?this.emit(H.WS_CONNECTED):t===he.RECONNECTING?this.emit(H.WS_RECONNECTING,this._websocketReconnectReason):t===he.CLOSED&&this.emit(H.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(t,n){super(),this._disconnectedReason=void 0,this._websocketReconnectReason=void 0,this._connectionState=he.CLOSED,this.reconnectToken=void 0,this.p2pToken=void 0,this.websocket=void 0,this.openConnectionTime=void 0,this.clientId=void 0,this.lastMsgTime=Date.now(),this.uploadCache=[],this.uploadCacheInterval=void 0,this.rttRolling=new UE(5),this.pingpongTimer=void 0,this.pingpongTimeoutCount=0,this.joinResponse=void 0,this.multiIpOption=void 0,this.initError=void 0,this.spec=void 0,this.store=void 0,this._external_signal=void 0,this.onWebsocketMessage=i=>{if(i.data instanceof ArrayBuffer)return void this.emit(H.ON_BINARY_DATA,i.data);const r=JSON.parse(i.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){const o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case ie.ON_DATA_STREAM:return void this.handleDataStream(r._message);case ie.MUTE_AUDIO:case ie.MUTE_VIDEO:case ie.ON_P2P_LOST:case ie.ON_USER_ONLINE:return;case ie.ON_USER_OFFLINE:const{uid:o}=r._message;return f.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(r._type,r._message),r._type===ie.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===ie.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(fe.UID_BANNED);break;case 15:this.close(fe.IP_BANNED);break;case 16:this.close(fe.CHANNEL_BANNED)}if(r._type===ie.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case Q.ERR_LICENSE_MISSING:this.close(fe.LICENSE_MISSING);break;case Q.ERR_LICENSE_EXPIRED:this.close(fe.LICENSE_EXPIRED);break;case Q.ERR_LICENSE_MINUTES_EXCEEDED:this.close(fe.LICENSE_MINUTES_EXCEEDED);break;case Q.ERR_LICENSE_PERIOD_INVALID:this.close(fe.LICENSE_PERIOD_INVALID);break;case Q.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(fe.LICENSE_MULTIPLE_SDK_SERVICE);break;case Q.ERR_LICENSE_ILLEGAL:this.close(fe.LICENSE_ILLEGAL);break;default:this.close()}}},this.clientId=t.clientId,this.spec=t,this.store=n,this.websocket=new fd("gateway-".concat(this.clientId),this.spec.retryConfig,!0,A("JOIN_GATEWAY_USE_DUAL_DOMAIN"),A("JOIN_GATEWAY_USE_443PORT_ONLY"),n),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===he.CONNECTED&&this.reconnect("retry",Zt.OFFLINE)}),this.p2pToken=et(6,""),this._external_signal=new Is(this,this.p2pToken)}async request(t,n,i,r){const o=et(6,""),s={_id:o,_type:t,_message:n},a=this.websocket.connectionID,c=()=>new Promise((m,E)=>{if(this.connectionState===he.CONNECTED)return m();const g=()=>{this.off(H.WS_CLOSED,S),m()},S=()=>{this.off(H.WS_CONNECTED,g),E(new L(C.WS_ABORT))};this.once(H.WS_CONNECTED,g),this.once(H.WS_CLOSED,S)});if(this.connectionState!==he.CONNECTING&&this.connectionState!==he.RECONNECTING||t===$.JOIN||t===$.REJOIN||await c(),this.websocket.sendMessage(s,!0),r)return;const d=new Promise((m,E)=>{let g=!1;const S=(I,y)=>{g=!0,m({isSuccess:I==="success",message:y||{}}),this.off(H.WS_CLOSED,T),this.off(H.WS_RECONNECTING,T),this.emit(H.REQUEST_SUCCESS,t,n)};this.once("res-@".concat(o),S);const T=()=>{E(new L(C.WS_ABORT,"type: ".concat(t))),this.off(H.WS_CLOSED,T),this.off(H.WS_RECONNECTING,T),this.off("res-@".concat(o),S)};this.once(H.WS_CLOSED,T),this.once(H.WS_RECONNECTING,T),Pt(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||g||(f.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(t)),this.emit(H.REQUEST_TIMEOUT,t,n))})});let l=null;try{l=await d}catch(m){if(this.connectionState===he.CLOSED||t===$.LEAVE)throw new L(C.WS_ABORT);return!this.spec.forceWaitGatewayResponse||i?m.throw():t===$.JOIN||t===$.REJOIN?null:(await c(),await this.request(t,n))}if(l.isSuccess)return l.message;const u=Number(l.message.error_code||l.message.code),h=vs(u),p=new L(C.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message});return h.action==="success"?l.message:(f.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(t,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===Q.ERR_TOO_MANY_BROADCASTERS?((t===$.JOIN||t===$.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===Q.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,f.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Zt.MULTI_IP)):this.reconnect(h.action,Zt.SERVER_ERROR),t===$.JOIN||t===$.REJOIN?null:await this.request(t,n)))}waitMessage(t,n){return new Promise(i=>{const r=o=>{(!n||n(o))&&(this.off(t,r),i(o))};this.on(t,r)})}uploadWRTCStats(t){if(!this.store.sessionId)return void f.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));const n={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:t};this.upload(Cs.WRTC_STATS,n)}upload(t,n){const i={_type:t,_message:n};try{this.websocket.sendMessage(i)}catch{const o=A("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(i),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==he.CONNECTED)return;const s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},A("UPLOAD_CACHE_INTERVAL")||2e3))}}send(t,n){const i={_type:t,_message:n};this.websocket.sendMessage(i)}async sendExtensionMessage(t,n,i){return await this._external_signal.send(t,n,i)}init(t){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Promise((n,i)=>{this.once(H.WS_CONNECTED,()=>n(this.joinResponse)),this.once(H.WS_CLOSED,()=>i(this.initError||new L(C.WS_ABORT))),this.connectionState=he.CONNECTING,this.websocket.init(t).catch(i)})}close(t){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=t||fe.LEAVE,this.connectionState=he.CLOSED,f.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),t===fe.FALLBACK&&(this.websocket.removeAllListeners(),this.websocket=new fd("gateway-".concat(this.clientId),this.spec.retryConfig,!0,A("JOIN_GATEWAY_USE_DUAL_DOMAIN"),A("JOIN_GATEWAY_USE_443PORT_ONLY"),this.store),this.handleWebsocketEvents()),this.p2pToken=et(6,""),this._external_signal.clear(),this._external_signal=new Is(this,this.p2pToken)}async join(){if(!this.joinResponse){this.emit(H.ABORT_P2P_EXECUTION);const t=await Tt(this,H.REQUEST_JOIN_INFO),n=await this.request($.JOIN,t);if(!n)return this.emit(H.REPORT_JOIN_GATEWAY,C.TIMEOUT,this.url||""),!1;this.joinResponse=n,this.emit(H.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=he.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0}reconnect(t,n){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(t,n)}handleDataStream(t){try{const n=ns(t.payload),i=new TextDecoder().decode(n),r=JSON.parse(i);"total"in r&&"id"in r||Object.values(at).includes(r._type)?(r._uid=t.uid,this._external_signal.onMessage(r)):this.emit(ie.ON_DATA_STREAM,t)}catch{this.emit(ie.ON_DATA_STREAM,t)}}handleNotification(t){f.debug("[".concat(this.clientId,"] receive notification: "),t);const n=vs(t.code);if(n.action!=="success"){if(n.action!=="failed")return n.action==="quit"?(n.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(fe.UID_BANNED),void this.close()):void this.reconnect(n.action,Zt.SERVER_ERROR);f.error("[".concat(this.clientId,"] ignore error: "),n.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;const t=A("PING_PONG_TIME_OUT"),n=Date.now();this.pingpongTimeoutCount>=t&&(f.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(n-this.lastMsgTime,"ms")),n-this.lastMsgTime>A("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Zt.TIMEOUT):this.request($.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;const i=Date.now()-n;this.rttRolling.add(i),A("REPORT_STATS")&&this.send($.PING_BACK,{pingpongElapse:i})}).catch(i=>{})}handleWebsocketEvents(){this.websocket.on(ne.RECONNECT_WAITTING_FINISH,t=>{this.emit(H.WS_RECONNECT_WAITTING_FINISH,t)}),this.websocket.on(ne.RECONNECT_CREATE_CONNECTION,t=>{this.emit(H.WS_RECONNECT_CREATE_CONNECTION,t)}),this.websocket.on(ne.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(ne.CLOSED,()=>{this.connectionState=he.CLOSED}),this.websocket.on(ne.FAILED,()=>{this._disconnectedReason=fe.NETWORK_ERROR,this.connectionState=he.CLOSED}),this.websocket.on(ne.RECONNECTING,t=>{this._websocketReconnectReason=t,this.joinResponse=void 0,this.connectionState===he.CONNECTED?this.connectionState=he.RECONNECTING:this.connectionState=he.CONNECTING}),this.websocket.on(ne.WILL_RECONNECT,(t,n,i)=>{t!=="retry"?(f.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(t)),this.reconnectToken=void 0,this.emit(H.NEED_RENEW_SESSION)):f.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),i(t)}),this.websocket.on(ne.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(t=>{if(this.emit(H.REPORT_JOIN_GATEWAY,t.message||t.code,this.url||""),t instanceof L&&t.code===C.UNEXPECTED_RESPONSE&&t.data.code===Q.ERR_NO_AUTHORIZED)return f.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Zt.SERVER_ERROR);f.error("[".concat(this.clientId,"] join gateway request failed"),t.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Zt.SERVER_ERROR):(this.initError=t,this.close())})}),this.websocket.on(ne.REQUEST_NEW_URLS,(t,n)=>{Tt(this,H.REQUEST_RECOVER,this.multiIpOption).then(t).catch(n)}),this.websocket.on(ne.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(ie.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}const Lp=new Map;class IM extends qe{get state(){return this._state}set state(t){if(t===this._state)return;const n=this._state;this._state=t,t==="DISCONNECTED"&&this._disconnectedReason?this.emit(ct.CONNECTION_STATE_CHANGE,t,n,this._disconnectedReason):this.emit(ct.CONNECTION_STATE_CHANGE,t,n)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(t){f.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(t)),this._joinGatewayStartTime=t}constructor(t,n){super(),this.store=void 0,this.joinInfo=void 0,this.key=void 0,this.ntpOffset=0,this.signal=void 0,this.role=void 0,this.inChannelInfo={joinAt:null,duration:0},this.spec=void 0,this._state="DISCONNECTED",this._statsCollector=void 0,this._disconnectedReason=void 0,this.isSignalRecover=!1,this.hasChangeBGPAddress=!1,this.trafficStatsInterval=void 0,this.networkQualityInterval=void 0,this._joinGatewayStartTime=0,this._signalTimeout=!1,this._clientRoleOptions=void 0,this._isProactiveJoin=!1,this.store=t,this.spec=n,this.signal=this.store.useP2P?new bR(F(F({},n),{},{retryConfig:n.websocketRetryConfig}),t):this.store.useDataChannel?new Dr(F(F({},n),{},{retryConfig:n.websocketRetryConfig}),t):new AR(F(F({},n),{},{retryConfig:n.websocketRetryConfig}),t),this._statsCollector=n.statsCollector,this.role=n.role||"audience",this._clientRoleOptions=n.clientRoleOptions,this.handleSignalEvents()}async join(t,n,i){if(this.signal instanceof Dr){let c=!1;t.cloudProxyServer!=="disabled"?(f.debug("[".concat(this.store.clientId,"] Dc is not supported, because cloudProxyServer are not supported (").concat(t.cloudProxyServer,")")),c=!0):"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length>255||"".concat(t.apResponse.cid,"_").concat(t.apResponse.cert).length<22?(f.debug("[".concat(this.store.clientId,"] Dc is not supported, because ticket length is incorrect, it has to be between 22 and 255")),c=!0):t.apResponse.addresses.some(d=>d.fingerprint)||A("FINGERPRINT")||(f.debug("[".concat(this.store.clientId,"] Dc is not supported, because fingerprint does not exist")),c=!0),c&&this.resetSignal()}this.store.joinGatewayStart(),t.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);const r=Date.now();let o=Lp.get(t.cname);if(o||(o=new Map,Lp.set(t.cname,o)),this._isProactiveJoin=!0,o.has(t.uid)){const c=new N(C.UID_CONFLICT);throw q.joinGateway(t.sid,{lts:r,succ:!1,ec:c.message,addr:null,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!t.proxyServer,signalChannel:this.signal instanceof Dr?"1":"0"}),this._isProactiveJoin=!1,c}o.set(t.uid,!0),this.joinInfo=t,this.key=n;let s=0;this.joinGatewayStartTime=r;const a=t.proxyServer;try{let c;if(f.debug("[".concat(this.store.clientId,"] use ").concat(this.signal instanceof Dr?"datachannel":"websocket"," join uid ").concat(s)),this.signal instanceof Dr)c=await this.signal.init(t.apResponse.addresses,i);else{const d=t.gatewayAddrs.map(l=>{let{address:u}=l;const[h,p]=u.split(":"),m={host:h,port:p};return t.proxyServer&&(m.proxy=t.proxyServer),m});c=await this.signal.init(d,i)}s=c.uid,f.debug("[".concat(this.store.clientId,"] ").concat(this.signal instanceof Dr?"datachannel":"websocket"," join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(c){throw c&&c.code===C.INIT_WEBSOCKET_TIMEOUT?(f.warning("[".concat(this.store.clientId,"] User join failed"),c.toString()),c):c&&c.code===C.INIT_DATACHANNEL_TIMEOUT?(f.warning("[".concat(this.store.clientId,"] User join datachannel failed"),c.toString()),this.resetSignal(),c):(f.error("[".concat(this.store.clientId,"] User join failed"),c.toString()),q.joinGateway(t.sid,{lts:r,succ:!1,ec:c.message,addr:this.signal.url,uid:t.uid,cid:t.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!a,signalChannel:this.signal instanceof Dr?"1":"0"}),this._isProactiveJoin=!1,o.delete(t.uid),this.signal.close(),c)}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),f.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(c=>{f.warning("[".concat(this.store.clientId,"] get traffic stats error"),c.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(ct.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(ct.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(ct.NETWORK_QUALITY,{uplinkNetworkQuality:NR(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:NR(this._statsCollector.trafficStats.B_dnq)}):this.emit(ct.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),s}async leave(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0],n=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){n!==fe.FALLBACK&&(this.state="DISCONNECTING");try{t||this.signal.connectionState!==he.CONNECTED||await SP(this.signal.request($.LEAVE,void 0,!0),3e3)}catch(i){f.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),i)}this.signal.close(n),n!==fe.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}}async publish(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const r={state:"offer",p2p_id:this.store.p2pId,ortc:n,mode:this.spec.mode,extend:A("PUB_EXTEND"),twcc:!!A("PUBLISH_TWCC"),rtx:!!A("USE_PUB_RTX")};try{return(await this.signal.request($.PUBLISH,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===Q.ERR_PUBLISH_REQUEST_INVALID)return f.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),await this.tryUnpubBeforeRepub(t,n),this.publish(t,n,!1);throw o}}async publishDataChannel(t,n,i){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));const o={stream_id:n.streamId,ordered:n.ordered?1:0,max_retrans_times:(r=n.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:n.channelId,metadata:n.metadata};try{await this.signal.request($.PUBLISH_DATASTREAM,o,!0)}catch(s){if(i&&s.data&&s.data.code===Q.ERR_PUBLISH_REQUEST_INVALID)return f.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),await this.tryUnpubDataChannelBeforeRepub(t,n),this.publishDataChannel(t,n,!1);throw s}}async unpublish(t,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await this.signal.request($.UNPUBLISH,{stream_id:n,ortc:t},!0)}catch(i){f.warning("[".concat(this.store.clientId,"] unpublish warning: "),i)}}async unpublishDataChannel(t){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Promise.all(t.map(n=>this.signal.request($.UNPUBLISH_DATASTREAM,{channel_id:n},!0)))}catch(n){f.warning("unpublish datachannels warning: ",n)}}async presubscribe(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:n,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!A("SUBSCRIBE_TWCC"),rtx:!!A("USE_SUB_RTX")||void 0,extend:A("SUB_EXTEND"),svc:Array.isArray(A("SVC"))&&A("SVC").length!==0?A("SVC"):void 0};try{return await this.signal.request($.PRE_SUBSCRIBE,r,!0)}catch(o){if(i&&o.data&&o.data.code===Q.ERR_SUBSCRIBE_REQUEST_INVALID)return f.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(t,n,!1);throw o}}async subscribe(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));const r={stream_id:t,stream_type:n.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!A("SUBSCRIBE_TWCC"),rtx:!!A("USE_SUB_RTX"),extend:A("SUB_EXTEND"),ssrcId:n.ssrcId,svc:Array.isArray(A("SVC"))&&A("SVC").length!==0?A("SVC"):void 0};try{return(await this.signal.request($.SUBSCRIBE,r,!0))._message}catch(o){if(i&&o.data&&o.data.code===Q.ERR_SUBSCRIBE_REQUEST_INVALID)return f.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),await this.tryUnsubBeforeResub(t,n),await this.subscribe(t,n,!1);throw o}}async subscribeDataChannel(t,n,i){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));const r={uid:t,stream_id:n.id,channel_id:n.datachannelId};try{return void await this.signal.request($.SUBSCRIBE_DATASTREAM,r,!0)}catch(o){if(i&&o.data&&o.data.code===Q.ERR_SUBSCRIBE_REQUEST_INVALID)return f.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),await this.tryUnsubDataChannelBeforeResub(t,n),await this.subscribeDataChannel(t,n,!1);throw o}}async subscribeAll(t,n){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));const i={p2p_id:this.store.p2pId,users:t,dtx:!1,rtx:!!A("USE_SUB_RTX"),twcc:!!A("SUBSCRIBE_TWCC"),svc:Array.isArray(A("SVC"))&&A("SVC").length!==0?A("SVC"):void 0};try{return await this.signal.request($.SUBSCRIBE_STREAMS,i,!0)}catch(r){if(n&&r.data&&r.data.code===Q.ERR_SUBSCRIBE_REQUEST_INVALID)return f.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),await this.tryMassUnsubBeforeResub(t),await this.subscribeAll(t,!1);throw r}}async setVideoProfile(t){const n=function(i){if(!(i.bitrateMax&&i.bitrateMin&&i.frameRate&&i.height&&i.width))return;let r=i.frameRate,o=i.width,s=i.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,r||(a=!1)),a?{stream_type:0,width:o,height:s,fps:r,start_bps:1e3*i.bitrateMax,min_bps:1e3*i.bitrateMin,target_bps:1e3*i.bitrateMax}:void 0}(t);if(n)return this.signal.request($.SET_VIDEO_PROFILE,n);f.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))}async unsubscribe(t,n){try{await this.signal.request($.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:t,stream_id:n},!0)}catch(i){f.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),i)}}async unsubscribeDataChannel(t,n){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));await Promise.all(t.map(i=>this.signal.request($.UNSUBSCRIBE_DATASTREAM,{stream_id:i,uid:n},!0)))}catch(i){f.warning("unsubscribeDataChannel warning: ",i)}}async massUnsubscribe(t){try{await this.signal.request($.UNSUBSCRIBE_STREAMS,t,!0)}catch(n){f.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),n)}}async reconnectPC(t){const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=t;return{gatewayEstablishParams:await this.signal.request($.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}}getGatewayInfo(){return this.signal.request($.GATEWAY_INFO)}async renewToken(t){await this.signal.request($.RENEW_TOKEN,t),this.key=t.token}async setClientRole(t,n){if(n&&(this._clientRoleOptions=Object.assign({},n)),this.state!=="CONNECTED")return void(this.role=t);let i,r=0;t==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(i=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0,await this.signal.request($.SET_CLIENT_ROLE,{role:t,level:r,delay:i,client_ts:Date.now()}),this.role=t}async setRemoteVideoStreamType(t,n){await this.signal.request($.SWITCH_VIDEO_STREAM,{stream_id:t,stream_type:n})}async setDefaultRemoteVideoStreamType(t){await this.signal.request($.DEFAULT_VIDEO_STREAM,{stream_type:t})}async setStreamFallbackOption(t,n){await this.signal.request($.SET_FALLBACK_OPTION,{stream_id:t,fallback_type:n})}async pickSVCLayer(t,n){await this.signal.request($.PICK_SVC_LAYER,{stream_id:t,spatial_layer:n.spatialLayer,temporal_layer:n.temporalLayer})}async setRTM2Flag(t){await this.signal.request($.SET_RTM2_FLAG,{rtm2_flag:t})}async sendExtensionMessage(t,n,i){if(this.signal instanceof bR)return this.signal.sendExtensionMessage(t,n,i)}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),F({},this.inChannelInfo)}async getGatewayVersion(){return(await this.signal.request($.GATEWAY_INFO)).version}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){const t=Lp.get(this.joinInfo.cname);t&&t.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;const t=function(n){let i;return i=n.startsWith("dc")?n.match(/(dc\:\/\/)?([^:]+):(\d+)/):n.match(/(wss\:\/\/)?([^:]+):(\d+)/),i?{username:Jt.username,password:Jt.password,turnServerURL:i[2],tcpport:parseInt(i[3])+30,udpport:parseInt(i[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],t&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(F(F({},Jt),{},{turnServerURL:t.turnServerURL,tcpport:t.tcpport,udpport:t.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}async updateTrafficStats(){if(this.state!=="CONNECTED")return;const t=await this.signal.request($.TRAFFIC_STATS,void 0,!0);t.timestamp=Date.now(),t.ntp_offset!=null&&(this.ntpOffset=t.ntp_offset),t.peer_delay.forEach(n=>{const i=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===n.peer_uid);i&&i.B_st!==n.B_st&&hh(()=>{this.emit(ct.STREAM_TYPE_CHANGE,n.peer_uid,n.B_st)})}),this._statsCollector.updateTrafficStats(t)}getJoinMessage(t){if(!this.joinInfo||!this.key)throw new N(C.UNEXPECTED_ERROR,"can not generate join message, no join info");const n=Object.assign({},this.joinInfo.apResponse);let i=A("REPORT_APP_SCENARIO");if(typeof i!="string")try{i=JSON.stringify(i)}catch{i=void 0}i&&i.length>128&&(i=void 0);const r=F({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:fi,browser:navigator.userAgent,process_id:A("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:n,extend:A("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:i,attributes:{userAttributes:{enablePublishedUserList:A("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:A("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:typeof A("SUBSCRIBE_AUDIO_FILTER_TOPN")=="number"?A("SUBSCRIBE_AUDIO_FILTER_TOPN"):void 0,enablePublishAudioFilter:typeof A("ENABLE_PUBLISH_AUDIO_FILTER")=="boolean"?A("ENABLE_PUBLISH_AUDIO_FILTER"):void 0,enableUserLicenseCheck:typeof A("ENABLE_USER_LICENSE_CHECK")=="boolean"?A("ENABLE_USER_LICENSE_CHECK"):void 0,enableRTX:A("USE_PUB_RTX")===!0||A("USE_SUB_RTX")===!0||void 0,disableFEC:A("DISABLE_FEC"),enableNTPReport:!!A("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!A("ENABLE_INSTANT_VIDEO")||void 0,enableDataStream2:typeof A("ENABLE_DATASTREAM_2")=="boolean"?A("ENABLE_DATASTREAM_2"):void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!A("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:typeof A("USE_XR")=="boolean"?A("USE_XR"):void 0,enableLossbasedBwe:typeof A("ENABLE_LOSSBASED_BWE")=="boolean"?A("ENABLE_LOSSBASED_BWE"):void 0,enableAutCC:typeof A("ENABLE_AUT_CC")=="boolean"?A("ENABLE_AUT_CC"):void 0,enableCCFallback:typeof A("ENABLE_CC_FALLBACK")=="boolean"?A("ENABLE_CC_FALLBACK"):void 0}},join_ts:this.joinGatewayStartTime},t);return this.joinInfo.stringUid&&(r.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(r.aes_mode=this.joinInfo.aesmode,A("ENCRYPT_AES")?(r.aes_secret=this.joinInfo.aespassword,r.aes_encrypt=!0):r.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(r.aes_salt=this.joinInfo.aessalt)),n.addresses[this.signal.websocket.currentURLIndex]&&(r.ap_response.ticket=n.addresses[this.signal.websocket.currentURLIndex].ticket,delete n.addresses),this.joinInfo.defaultVideoStream!==void 0&&(r.default_video_stream=this.joinInfo.defaultVideoStream),r}getRejoinMessage(){if(!this.joinInfo)throw new N(C.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(H.WS_RECONNECT_WAITTING_FINISH,t=>{["tryNext","recover"].includes(t)&&this.joinInfo&&q.adjustSessionStartTime(this.joinInfo.sid)}),this.signal.on(H.WS_RECONNECT_CREATE_CONNECTION,t=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(H.WS_RECONNECTING,t=>{this.joinInfo&&q.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:t||Zt.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",q.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:3}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(H.WS_CLOSED,t=>{let n;switch(t){case fe.LEAVE:n=Zt.LEAVE;break;case fe.UID_BANNED:case fe.IP_BANNED:case fe.CHANNEL_BANNED:case fe.SERVER_ERROR:n=Zt.SERVER_ERROR;break;case fe.FALLBACK:n=Zt.FALLBACK;break;case fe.LICENSE_MISSING:case fe.LICENSE_EXPIRED:case fe.LICENSE_MINUTES_EXCEEDED:case fe.LICENSE_PERIOD_INVALID:case fe.LICENSE_MULTIPLE_SDK_SERVICE:case fe.LICENSE_ILLEGAL:case fe.TOKEN_EXPIRE:n=t;break;default:n=Zt.NETWORK_ERROR}f.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(n||"undefined -> "+Zt.NETWORK_ERROR)),this.joinInfo&&q.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:t===fe.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:n}),this._disconnectedReason=t,t!==fe.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(H.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo&&(this.role==="audience"&&this._clientRoleOptions&&(this._clientRoleOptions.level||this._clientRoleOptions.delay)&&(f.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(this._clientRoleOptions.level,", delay: ").concat(this._clientRoleOptions.delay)),this.setClientRole(this.role,this._clientRoleOptions)),q.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Dr?"1":"0"}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1)){const t=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!t)return void f.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(t));Fe("EVENT_REPORT_DOMAIN",t[1]),Fe("EVENT_REPORT_BACKUP_DOMAIN",t[1]),Fe("LOG_UPLOAD_SERVER","".concat(t[1],":6444"))}}),this.signal.on(ie.ON_UPLINK_STATS,t=>{this._statsCollector.updateUplinkStats(t)}),this.signal.on(H.REQUEST_RECOVER,(t,n,i)=>{if(!this.joinInfo)return i(new N(C.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));t&&(this.joinInfo.multiIP=t,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,Tt(this,ct.REQUEST_NEW_GATEWAY_LIST).then(n).catch(i)}),this.signal.on(H.REQUEST_JOIN_INFO,async t=>{var n;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void t(this.getJoinMessage({ortc:{}}));const{iceParameters:i,dtlsParameters:r,rtpCapabilities:o}=await Tt(this,ct.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:(n=this.joinInfo)===null||n===void 0?void 0:n.turnServer});t(this.getJoinMessage({ortc:{iceParameters:i,dtlsParameters:r,rtpCapabilities:o,version:"2"}}))}),this.signal.on(H.REQUEST_REJOIN_INFO,t=>{t(this.getRejoinMessage())}),this.signal.on(H.REPORT_JOIN_GATEWAY,(t,n)=>{this.joinInfo&&(q.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:t,addr:n,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,avoidJoinStartTime:this.store.avoidJoinStart,isProxy:!!this.joinInfo.proxyServer,signalChannel:this.signal instanceof Dr?"1":"0"}),this._isProactiveJoin=!1)}),this.signal.on(H.IS_P2P_DISCONNECTED,t=>{t(gs(this,ct.IS_P2P_DISCONNECTED))}),this.signal.on(H.DISCONNECT_P2P,()=>{this.emit(ct.DISCONNECT_P2P)}),this.signal.on(H.NEED_RENEW_SESSION,t=>{this.emit(ct.NEED_RENEW_SESSION,t)}),this.signal.on(H.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(H.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(H.JOIN_RESPONSE,t=>{const n=this.getCurrentGatewayAddress();this.emit(ct.JOIN_RESPONSE,t,n)}),this.signal.on(H.DATACHANNEL_PRECONNECT,async(t,n,i)=>{this.updateTurnConfigFromSignal();const r=this.getCurrentGatewayAddress();return Tt(this,ct.DATACHANNEL_PRECONNECT,t,r).then(n).catch(i)}),this.signal.on(H.DATACHANNEL_CONNECTING,async t=>{const{iceParameters:n,dtlsParameters:i,rtpCapabilities:r}=await Tt(this,ct.REQUEST_DC_CONNECTION_PARAMS);t(this.getJoinMessage({ortc:{iceParameters:n,dtlsParameters:i,rtpCapabilities:r,version:"2"}}))}),this.signal.on(H.DATACHANNEL_FAILBACK,()=>{f.warning("[".concat(this.store.clientId,"] User join datachannel failed")),this.reset(),this.resetSignal(),this.emit(ct.DATACHANNEL_FAILBACK)})}async tryUnsubBeforeResub(t,n){try{await this.signal.request($.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:t,ortc:[n]},!0)}catch(i){throw f.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),i),i}}async tryUnsubDataChannelBeforeResub(t,n){try{await this.signal.request($.UNSUBSCRIBE,{stream_id:n.id},!0)}catch(i){throw f.warning("unsubscribe datachannel warning",i),i}}async tryUnpubBeforeRepub(t,n){try{await this.signal.request($.UNPUBLISH,{stream_id:t,ortc:n},!0)}catch(i){throw f.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),i),i}}async tryUnpubDataChannelBeforeRepub(t,n){try{await this.signal.request($.UNPUBLISH_DATASTREAM,{channnel_id:n.channelId},!0)}catch(i){throw f.warning("unpublish datastream warning: ",i),i}}async tryMassUnsubBeforeResub(t){const n={users:t.map(i=>({stream_id:i.stream_id,stream_type:i.stream_type}))};try{await this.signal.request($.UNSUBSCRIBE_STREAMS,n,!0)}catch(i){throw f.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),i),i}}async muteLocal(t,n){const i={action:t.find(r=>r.stream_type===ve.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:n};try{await this.signal.request($.CONTROL,i,!0,!0)}catch(r){throw f.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}}async unmuteLocal(t,n){const i={action:t.find(r=>r.stream_type===ve.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:t,stream_id:n};try{await this.signal.request($.CONTROL,i,!0,!0)}catch(r){throw f.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}}async muteRemote(t,n){const i={action:t===z.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request($.CONTROL,i,!0,!0)}catch(r){throw f.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}}async unmuteRemote(t,n){const i={action:t===z.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:n};try{await this.signal.request($.CONTROL,i,!0,!0)}catch(r){throw f.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}}uploadWRTCStats(t){this.signal.uploadWRTCStats(t)}upload(t,n){this.signal.upload(t,n)}getSignalRTT(){return this.signal.rtt}async restartICE(t){const n={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:t};try{return await this.signal.request($.RESTART_ICE,n,!0)}catch(i){throw f.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),i),i}}reconnect(){this.state==="CONNECTED"&&this.signal.reconnect(void 0,Zt.P2P_FAILED)}getCurrentGatewayAddress(){var t;if(!A("GATEWAY_WSS_ADDRESS"))return(t=this.joinInfo)!==null&&t!==void 0&&t.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}async setPublishAudioFilterEnabled(t){await this.signal.request($.SET_PARAMETER,{enablePublishAudioFilter:t})}resetSignal(){this.signal&&(this.signal.removeAllListeners(),this.signal.close(fe.FALLBACK)),this.store.useDataChannel=!1,this.signal=new AR(F(F({},this.spec),{},{retryConfig:this.spec.websocketRetryConfig}),this.store),this.handleSignalEvents(),this.emit(ct.RESET_SIGNAL,ew.websocket)}}let ml=0,kp=0;function or(e,t,n,i){return new Promise((r,o)=>{t.timeout=t.timeout||A("HTTP_CONNECT_TIMEOUT"),t.responseType=t.responseType||"json",t.data&&!n?(t.data=JSON.stringify(t.data),ml+=Tr(t.data)):n&&(t.data.size?ml+=t.data.size:t.data instanceof FormData?ml+=xA(t.data):ml+=Tr(JSON.stringify(t.data))),t.headers=t.headers||{},t.headers["Content-Type"]=t.headers["Content-Type"]||"application/json",t.method="POST",t.url=e,Un.request(t).then(s=>{typeof s.data=="string"?kp+=Tr(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?kp+=s.data.byteLength:kp+=Tr(JSON.stringify(s.data)),i&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{Un.isCancel(s)?o(new N(C.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new N(C.NETWORK_TIMEOUT,s.message)):s.response?o(new N(C.NETWORK_RESPONSE_ERROR,s.response.status)):o(new N(C.NETWORK_ERROR,s.message))})})}const gd=()=>{const e=A("AREAS");return e.length===0&&e.push(Re.GLOBAL),e.reduce((t,n,i)=>{const r=rw(n);return r?i===0?r:"".concat(t,",").concat(r):t},"")},rw=e=>e===Re.OVERSEA?"".concat(tn.ASIA,",").concat(tn.EUROPE,",").concat(tn.AFRICA,",").concat(tn.NORTH_AMERICA,",").concat(tn.SOUTH_AMERICA,",").concat(tn.OCEANIA):tn[e],yM=e=>{const t={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return e.map(n=>{const i=Rh[n],r=Object.keys(i);r&&r.map(o=>{o!=="CODE"&&(t[o]=t[o].concat(i[o]))})}),t},Jl={GLOBAL:{ASIA:[Re.CHINA,Re.JAPAN,Re.INDIA,Re.KOREA,Re.HKMC],EUROPE:[],NORTH_AMERICA:[Re.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},Mp=Object.keys(Jl[Re.GLOBAL]),DR=[Re.CHINA,Re.NORTH_AMERICA,Re.EUROPE,Re.ASIA,Re.JAPAN,Re.INDIA,Re.OCEANIA,Re.SOUTH_AMERICA,Re.AFRICA,Re.KOREA,Re.HKMC,Re.US],AM=function(e,t){let n=[];if(e.includes(Re.GLOBAL)){const o=[Re.GLOBAL,Re.OVERSEA],s=Object.keys(Rh);if(t===Re.GLOBAL)throw new N(C.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(t===Re.CHINA)n=[Re.OVERSEA];else if(r=t,Mp.includes(r)){const a=(i=t,Jl[Re.GLOBAL][i]||[]),c=[...o,t,...a];n=s.filter(d=>!c.includes(d))}else if(function(a){let c=!1;return Mp.forEach(d=>{Jl[Re.GLOBAL][d].includes(a)&&(c=!0)}),c}(t)){const a=function(d){let l;return Mp.forEach(u=>{Jl[Re.GLOBAL][u].includes(d)&&(l=u)}),l}(t),c=[...o,a,t];n=s.filter(d=>!c.includes(d))}else n=e;n=function(a){const c=[];return DR.forEach(d=>{a.includes(d)&&c.push(d)}),c.concat(a.filter(d=>!DR.includes(d)))}(n)}else n=e;var i,r;return n};function PR(e){if(!e&&A("AREAS").includes(Re.EXTENSIONS))return f.debug("update area from ap : reset"),void ow(oM,!0);if(!A("AREAS").includes(Re.GLOBAL)||!e)return;let t=Rh.EXTENSIONS;t&&(t={CODE:rw(Re.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(e,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(e,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(e,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(e,".agora.io"),"cds-ap-web-2-".concat(e,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(e,".agora.io"),"sua-ap-web-2-".concat(e,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(e,".agora.io"),"uap-ap-web-2-".concat(e,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(e,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(e,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(e,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(e,".agora.io")]},f.debug("update area from ap success: ".concat(e,",config is "),t),Fe("AREAS",[Re.EXTENSIONS],!0),Object.keys(t).map(n=>{if(n==="LOG_UPLOAD_SERVER"||n==="EVENT_REPORT_DOMAIN"||n==="EVENT_REPORT_BACKUP_DOMAIN"||n==="PROXY_SERVER_TYPE3"){const i=t[n];Fe(n,i[0])}else Fe(n,t[n])}))}function ow(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];const n=q.reportApiInvoke(null,{name:an.SET_AREA,options:e,tag:bt.TRACER});try{let i=[];if(typeof e=="string"&&(i=[e]),Array.isArray(e)&&(e.forEach(o=>{if(!hM.includes(o))throw new N(C.INVALID_PARAMS,"invalid area code")}),i=e),Object.prototype.toString.call(e)==="[object Object]"){const{areaCode:o,excludedArea:s}=e;if(!o)throw new N(C.INVALID_PARAMS,"area code is needed");let a=o;typeof o=="string"&&(a=[o]),i=s?AM(a,s):a}if(!t){if(fo.AREAS){const o=new N(C.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return n.onError(o),void f.warning("setArea is prohibited because of config-distribute")}if(i.includes(Re.GLOBAL)&&A("AREAS")===Re.EXTENSIONS){const o=new N(C.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return n.onError(o),void f.warning("setArea is prohibited because of ap extensions")}}Fe("AREAS",i,t);const r=yM(i);Object.keys(r).map(o=>{if(o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"){const s=r[o];Fe(o,s[0])}else Fe(o,r[o])}),f.debug("set area success:",i.join(","))}catch(i){throw n.onError(i),i}n.onSuccess()}let Up=1;function wM(e,t,n,i,r){Up+=1;const o={sid:n.sid,command:"convergeAllocateEdge",uid:"666",appId:n.appId,ts:Math.floor(Date.now()/1e3),seq:Up,requestId:Up,version:fi,cname:n.cname},s={service_name:t,json_body:JSON.stringify(o)};let a,c,d=e[0];return wr(async()=>{a=Date.now();const l=await or(d,{data:s,cancelToken:i,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){const p=new N(C.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw f.error(p.toString()),p}const u=JSON.parse(l.json_body);if(u.code!==200){const p=new N(C.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(u.code,", reason: ").concat(u.reason),{code:u.code,responseTime:c});throw f.error(p.toString()),p}if(!u.servers||u.servers.length===0){const p=new N(C.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:u.code,responseTime:c});throw f.error(p.toString()),p}const h=function(p,m){return{addressList:p.servers.map(E=>"wss://".concat(E.address.replace(/\./g,"-"),".").concat(A("WORKER_DOMAIN"),":").concat(E.wss,"?serviceName=").concat(encodeURIComponent(m))),workerToken:p.workerToken,vid:p.vid}}(u,t);return A("LIVE_STREAMING_ADDRESS")&&(h.addressList=A("LIVE_STREAMING_ADDRESS")instanceof Array?A("LIVE_STREAMING_ADDRESS"):[A("LIVE_STREAMING_ADDRESS")]),F(F({},h),{},{responseTime:c})},(l,u)=>(q.apworkerEvent(n.sid,{success:!0,sc:200,serviceName:t,responseDetail:JSON.stringify(l.addressList),firstSuccess:u===0,responseTime:c,serverIp:e[u%e.length]}),!1),(l,u)=>(q.apworkerEvent(n.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:t,responseTime:c,serverIp:e[u%e.length]}),!!(l.code!==C.OPERATION_ABORTED&&l.code!==C.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=e[(u+1)%e.length],!0)),r)}let xp=1;function LR(e,t,n,i){let{url:r,areaCode:o}=e;const{clientId:s,sid:a}=t,c=Date.now();let d;const[l,u]=ZE(t,o,[ft.CHOOSE_SERVER]);let h=it.networkState;return wr(async()=>{h&&it.networkState===Tn.OFFLINE&&it.onlineWaiter&&await Promise.race([it.onlineWaiter,Pt(i&&i.maxRetryTimeout||_t.maxRetryTimeout)]),h=it.networkState;const{data:p,headers:m}=await or(r,{data:l,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=m.http3==="1"?1:-1,q.reportResourceTiming(r,a),sw(p,r,t,c,[ft.CHOOSE_SERVER],d);const E=md(p,ft.CHOOSE_SERVER);return QE(E),XE(E,r)},p=>(p&&q.joinChooseServer(a,{lts:c,succ:!0,csAddr:r,opid:u,serverList:p.gatewayAddrs.map(m=>m.address),ec:null,cid:p.cid.toString(),uid:p.uid.toString(),csIp:p.csIp,unilbsServerIds:[ft.CHOOSE_SERVER].toString(),isHttp3:d}),!1),p=>p.code!==C.OPERATION_ABORTED&&(p.code===C.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(q.joinChooseServer(a,{lts:c,succ:!1,csAddr:r,serverList:null,opid:u,ec:p.code,csIp:p.data&&p.data.csIp,unilbsServerIds:[ft.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:h}),isHttp3:d}),f.warning("[".concat(s||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),p),!0)),i)}function kR(e,t,n,i){let r,{url:o,areaCode:s,serviceIds:a}=e;const c=Date.now(),[d,l]=ZE(t,s,a);let u;return wr(async()=>{u&&it.networkState===Tn.OFFLINE&&it.onlineWaiter&&await Promise.race([it.onlineWaiter,Pt(i&&i.maxRetryTimeout||_t.maxRetryTimeout)]),u=it.networkState;const{data:h,headers:p}=await or(o,{data:d,cancelToken:n,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=p.http3==="1"?1:-1,q.reportResourceTiming(o,t.sid),sw(h,o,t,c,a,r);const m=md(h,ft.CHOOSE_SERVER),E=md(h,t.cloudProxyServer==="proxy5"?ft.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?ft.CLOUD_PROXY:ft.CLOUD_PROXY_FALLBACK);return QE(m),{gatewayInfo:XE(m,o),proxyInfo:E,url:o}},h=>(h.gatewayInfo&&q.joinChooseServer(t.sid,{lts:c,succ:!0,csAddr:o,serverList:h.gatewayInfo.gatewayAddrs.map(p=>p.address),ec:null,opid:l,cid:h.gatewayInfo.cid.toString(),uid:h.gatewayInfo.uid.toString(),csIp:h.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r}),h.proxyInfo&&q.joinWebProxyAP(t.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:h.proxyInfo.addresses.map(p=>p.ip).join(","),errorCode:null,eventType:t.cloudProxyServer,unilbsServerIds:a.toString()}),!1),h=>h.code!==C.OPERATION_ABORTED&&(h.code===C.CAN_NOT_GET_GATEWAY_SERVER?h.data.retry:(q.joinWebProxyAP(t.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:h.code,eventType:t.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:u})}),f.warning("[".concat(t.clientId,"] multi unilbs network error, retry"),h),!0)),i)}const sw=(e,t,n,i,r,o)=>{const{sid:s,clientId:a,cloudProxyServer:c}=n,d=[],l=u=>{u.flag===4096?q.joinChooseServer(s,{lts:i,succ:!1,csAddr:t,opid:e.opid,serverList:null,ec:u.error.message,csIp:u.error.data&&u.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o}):u.flag!==1048576&&u.flag!==4194304&&u.flag!==4194310||q.joinWebProxyAP(s,{lts:i,sucess:0,apServerAddr:t,turnServerAddrList:null,errorCode:u.error.code,eventType:c,unilbsServerIds:r.toString()})};if(e.response_body.forEach(u=>{const h=u.buffer.code;if(u.uri===23&&h===0&&!u.buffer.edges_services)if(u.buffer.flag===4194310)f.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),u.buffer.edges_services=[];else{const p={error:new N(C.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:e.detail[502]}),flag:u.buffer.flag};d.push(p),l(p)}if(h!==0){const p=Da(h),m={error:new N(C.CAN_NOT_GET_GATEWAY_SERVER,p.desc,{desc:p.desc,retry:p.retry,csIp:e.detail[502]}),flag:u.buffer.flag};u.buffer.flag===4194310?f.warning(m.error.toString()):d.push(m),l(m)}}),d.length)throw f.warning("[".concat(a||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(t," failed, ").concat(d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message,", retry: ").concat(u.error.data.retry)).join(" | "))),new N(C.CAN_NOT_GET_GATEWAY_SERVER,d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message)).join(" | "),{retry:!!d.find(u=>u.error.data.retry),csIp:e.detail[502],desc:[...new Set(d.map(u=>{var h;return u==null||(h=u.error)===null||h===void 0||(h=h.data)===null||h===void 0?void 0:h.desc}).filter(u=>!!u))]})},QE=e=>{var t,n,i,r;if(e.addresses&&e.addresses.length===0&&e.code===0)throw new N(C.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:e.detail&&e.detail[502]});if(A("AP_AREA")&&((i=e.detail)!==null&&i!==void 0&&i[23]&&typeof((r=e.detail)===null||r===void 0?void 0:r[23])=="string"?PR(e.detail[23].toLowerCase()):PR()),(t=e.detail)!==null&&t!==void 0&&t[19]&&typeof((n=e.detail)===null||n===void 0?void 0:n[19])=="string"){const o=e.detail[19],s=o==null?void 0:o.split(";");for(let a=0;a<s.length;a++){const c=s[a].trim();e.addresses[a]&&s&&(e.addresses[a].fingerprint=c)}}if(A("GATEWAY_ADDRESS")&&A("GATEWAY_ADDRESS").length>0){f.debug("assign gateway address to",A("GATEWAY_ADDRESS"));const o=A("GATEWAY_ADDRESS").map(s=>{var a,c;const d=(a=(c=e.addresses.find(l=>l.ip===s.ip&&l.port===s.port))===null||c===void 0?void 0:c.fingerprint)!==null&&a!==void 0?a:"";return{ip:s.ip,port:s.port,ticket:e.addresses[0]&&e.addresses[0].ticket,fingerprint:d}});e.addresses=o}},NM=(e,t)=>{if(e.response_body&&e.response_body.length){const n=e.response_body[0];if(n.buffer.code!==0){const i=Da(n.buffer.code);throw new N(C.UPDATE_TICKET_FAILED,"[".concat(n.buffer.code,"]: ").concat(i.desc),{retry:i.retry})}return n.buffer.ticket}throw f.debug("update ticket request received ap response without response body:",t),new N(C.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},ZE=(e,t,n)=>{const i=Math.floor(Math.random()*1e12),r={appid:e.appId,client_ts:Date.now(),opid:i,sid:e.sid,request_bodies:[{uri:22,buffer:{cname:e.cname,detail:F({6:e.stringUid,11:t,12:A("USE_NEW_TOKEN")?"1":void 0,22:t},e.apRTM?{26:"RTM2"}:{}),key:e.token,service_ids:n,uid:e.uid||0}}]};r.request_bodies.forEach(s=>{e.multiIP&&e.multiIP.gateway_ip&&(s.buffer.detail[5]=JSON.stringify({vocs_ip:[e.multiIP.uni_lbs_ip],vos_ip:[e.multiIP.gateway_ip]}))});const o=new FormData;return o.append("request",JSON.stringify(r)),[o,i]},OM=(e,t)=>{const n=Math.floor(Math.random()*1e12),i={appid:e.appId,client_ts:Date.now(),opid:n,sid:e.sid,request_bodies:[{uri:28,buffer:{cname:e.cname,detail:{1:"",6:e.stringUid,12:"1"},token:e.token,service_ids:t,uid:e.uid||0,edges_services:e.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(i)),[r,n]};let fa=0;function za(e){return Promise.all(e.map(t=>t.then(n=>{throw n},n=>n))).then(t=>{throw t},t=>t)}const Sd=async e=>{let{fragementLength:t,referenceList:n,asyncMapHandler:i,allFailedhandler:r,promisesCollector:o}=e,s=0;const a=t;let c,d=0;const l=async()=>{const u=(()=>{const h=s*a,p=h+a;return n.slice(h,p).map(i)})();o&&o.push(...u);try{c=await za(u)}catch(h){if(d+=a,s++,!(d>=n.length))return void await l();r(h)}u.forEach(h=>h.cancel())};return await l(),c},aw=async e=>{let{referenceList:t,asyncMapHandler:n,closeFn:i}=e;const r=t.length;let o=0;const s=async()=>{const a=n(t.shift());try{return await a}catch(c){if(o++,o>=r||i!=null&&i(c))throw c;return s()}};return s()};async function Nf(e,t,n,i){return{gatewayInfo:await async function(o,s,a,c){let d=null;const l=[],u=async()=>{const p=A("WEBCS_DOMAIN").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(g=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(g+"/api/v2/transpond/webrtc?v=2"):"https://".concat(g,"/api/v2/transpond/webrtc?v=2"),areaCode:gd()})),m=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(g=>g.url)}),E=await Sd({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:g=>(f.debug("[".concat(o.clientId,"] Connect to choose_server:"),g.url),LR(g,o,s,a)),allFailedhandler:g=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},m),g[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},m),E},h=async()=>{if(await Pt(1e3),d!==null)return d;const p=A("WEBCS_DOMAIN_BACKUP_LIST").map(g=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(g+"/api/v2/transpond/webrtc?v=2"):"https://".concat(g,"/api/v2/transpond/webrtc?v=2"),areaCode:gd()})),m=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(g=>g.url)}),E=await Sd({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:g=>(f.debug("[".concat(o.clientId,"] Connect to backup choose_server:"),g.url),LR(g,o,s,a)),allFailedhandler:g=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},m),g[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},m),E};try{return d=await za([u(),h()]),l.length&&l.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),d}catch(p){throw p[0]}}(e,t,n,i)}}async function MR(e,t,n,i,r){const o=e.cloudProxyServer;if(o==="disabled"){if(!i)return;if(e.useLocalAccessPoint)return await Nf(e,t,n,r);if(A("JOIN_WITH_FALLBACK_MEDIA_PROXY")){const{gatewayInfo:h,proxyInfo:p}=await xR(e,t,n,r);if(e.turnServer&&e.turnServer.mode!=="auto")return{gatewayInfo:h};const m=p.map(E=>({turnServerURL:E.address,tcpport:E.tcpport||Jt.tcpport,udpport:E.udpport||Jt.udpport,username:E.username||Jt.username,password:E.password||Jt.password,forceturn:!1,security:!0}));if(r.useP2P){var s;const E=(s=e.uid)!==null&&s!==void 0?s:h.uid,g="glb:".concat(E.toString()),S=await lf(g),T=p.map(I=>({turnServerURL:I.address,tcpport:I.tcpport||Jt.tcpport,udpport:I.udpport||Jt.udpport,username:g,password:S,forceturn:!1,security:!0}));m.push(...T)}return e.turnServer={mode:"manual",servers:m},{gatewayInfo:h}}return await Nf(e,t,n,r)}const{proxyInfo:a,gatewayInfo:c}=await xR(e,t,n,r),d={gatewayInfo:c},l=a.map(h=>({turnServerURL:h.address,tcpport:o==="proxy3"?void 0:h.tcpport?h.tcpport:Jt.tcpport,udpport:o==="proxy4"?void 0:h.udpport?h.udpport:Jt.udpport,username:h.username||Jt.username,password:h.password||Jt.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(r.useP2P){var u;const h=(u=e.uid)!==null&&u!==void 0?u:c.uid,p="glb:".concat(h.toString()),m=await lf(p),E=a.map(g=>({turnServerURL:g.address,tcpport:o==="proxy3"?void 0:g.tcpport||Jt.tcpport,udpport:o==="proxy4"?void 0:g.udpport||Jt.udpport,username:p,password:m,forceturn:o!=="proxy4",security:o==="proxy5"}));l.push(...E)}return e.turnServer={mode:"manual",servers:l},f.debug("[".concat(e.clientId,"] set proxy server: ").concat(e.proxyServer,", mode: ").concat(o)),d}async function cw(e,t,n,i,r){const o=A("ACCOUNT_REGISTER").slice(0,A("AJAX_REQUEST_CONCURRENT"));let s=[];s=t.proxyServer?o.map(c=>"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1")):o.map(c=>"https://".concat(c,"/api/v1"));const a=r==null?void 0:r.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{const c=await async function(d,l,u,h,p){const m=Date.now(),E={sid:u.sid,opid:10,appid:u.appId,string_uid:l};let g=d[0];const S=await wr(()=>or(g+"".concat(g.indexOf("?")===-1?"?":"&","action=stringuid"),{data:E,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(T,I)=>{if(T.code===0){if(T.uid<=0||T.uid>=Math.pow(2,32))throw f.error("Invalid Uint Uid ".concat(l," => ").concat(T.uid),T),q.reqUserAccount(E.sid,{lts:m,success:!1,serverAddr:g,stringUid:E.string_uid,uid:T.uid,errorCode:C.INVALID_UINT_UID_FROM_STRING_UID,extend:E}),new N(C.INVALID_UINT_UID_FROM_STRING_UID);return q.reqUserAccount(E.sid,{lts:m,success:!0,serverAddr:g,stringUid:E.string_uid,uid:T.uid,errorCode:null,extend:E}),!1}const y=Da(T.code);return y.retry&&(g=d[(I+1)%d.length]),q.reqUserAccount(E.sid,{lts:m,success:!1,serverAddr:g,stringUid:E.string_uid,uid:T.uid,errorCode:y.desc,extend:E}),y.retry},(T,I)=>T.code!==C.OPERATION_ABORTED&&(q.reqUserAccount(E.sid,{lts:m,success:!1,serverAddr:g,stringUid:E.string_uid,uid:null,errorCode:T.code,extend:E}),g=d[(I+1)%d.length],!0),p);if(S.code!==0){const T=Da(S.code);throw new N(C.UNEXPECTED_RESPONSE,T.desc)}return S}(s,e,t,n,i);return r==null||r.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r==null||r.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}}async function bM(e,t,n){const i=A("ACCOUNT_REGISTER");let r=[];r=t.proxyServer?i.map(o=>"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1")):i.map(o=>"https://".concat(o,"/api/v1"));try{return await aw({referenceList:r,asyncMapHandler:s=>async function(a,c,d,l){const u=Date.now(),h={sid:d.sid,opid:10,appid:d.appId,string_uid:c};try{const p=await or(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:h,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(p.code!==0){const m=Da(p.code);throw new N(C.UNEXPECTED_RESPONSE,"preload sua error:".concat(m.desc),m)}if(p.uid<=0||p.uid>=Math.pow(2,32))throw new N(C.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:u,url:a,req:h,uid:p.uid,elapse:Date.now()-u}}catch(p){throw p}}(s,e,t,n),closeFn:s=>s.code===C.OPERATION_ABORTED||s.code===C.UNEXPECTED_RESPONSE&&!s.data.retry})}catch(o){throw o}}async function DM(e,t,n){const i=A("CDS_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(a=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(a+"/api/v1"):"https://".concat(a,"/api/v1?action=config")).map(a=>function(c,d,l,u){const h=Ie(),p={flag:64,cipher_method:0,features:{device:h.name,system:h.os,system_general:navigator.userAgent,vendor:d.appId,version:fi,cname:d.cname,sid:d.sid,session_id:d.sid,detail:"",proxyServer:d.proxyServer}};return wr(()=>or(c,{data:p,timeout:1e3,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,m=>m.code!==C.OPERATION_ABORTED,u)}(a,e,t,n));let r=null,o=null,s={};try{r=await za(i)}catch(a){if(a.code===C.OPERATION_ABORTED)throw a;o=a}if(i.forEach(a=>a.cancel()),q.reportApiInvoke(e.sid,{name:an.REQUEST_CONFIG_DISTRIBUTE,options:{error:o,res:r}}).onSuccess(),r&&r.test_tags)try{s=function(a){if(!a.test_tags)return{};const c=a.test_tags,d=Object.keys(c),l={};return d.forEach(u=>{const h=u.slice(4).trim(),p=JSON.parse(c[u])[1];l[h]=p}),l}(r)}catch{}return s}async function UR(e,t){const n=A("WEBCS_DOMAIN").concat(A("WEBCS_DOMAIN_BACKUP_LIST")).map(i=>({url:"https://".concat(i,"/api/v2/transpond/webrtc?v=2"),areaCode:gd(),serviceIds:[ft.CHOOSE_SERVER,ft.CLOUD_PROXY_FALLBACK]}));try{return await aw({referenceList:n,asyncMapHandler:r=>async function(o,s,a){let c,{url:d,areaCode:l,serviceIds:u}=o;const h=Date.now(),[p,m]=ZE(s,l,u);let E=it.networkState;try{E&&it.networkState===Tn.OFFLINE&&it.onlineWaiter&&await Promise.race([it.onlineWaiter,Pt(_t.maxRetryTimeout)]),E=it.networkState;const{data:g,headers:S}=await or(d,{data:p,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=S.http3==="1"?1:-1,(y=>{const w=[];if(y.response_body.forEach(D=>{const O=D.buffer.code;if(D.uri===23&&O===0&&!D.buffer.edges_services)if(D.buffer.flag===4194310)D.buffer.edges_services=[];else{const P={error:new N(C.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:y.detail[502]}),flag:D.buffer.flag};w.push(P)}if(O!==0){const P=Da(O),x={error:new N(C.CAN_NOT_GET_GATEWAY_SERVER,P.desc,{desc:P.desc,retry:P.retry,csIp:y.detail[502]}),flag:D.buffer.flag};D.buffer.flag===4194310?f.warning(x.error.toString()):w.push(x)}}),w.length)throw new N(C.CAN_NOT_GET_GATEWAY_SERVER,w.map(D=>"flag: ".concat(D.flag,", message: ").concat(D.error.message)).join(" | "),{retry:!!w.find(D=>D.error.data.retry),csIp:y.detail[502],desc:[...new Set(w.map(D=>{var O;return D==null||(O=D.error)===null||O===void 0||(O=O.data)===null||O===void 0?void 0:O.desc}).filter(D=>!!D))]})})(g);const T=md(g,ft.CHOOSE_SERVER),I=md(g,ft.CLOUD_PROXY_FALLBACK);return QE(T),{gatewayInfo:XE(T,d),proxyInfo:I,opid:m,requestTime:h,url:d,isHttp3:c,elapse:Date.now()-h}}catch(g){throw g}}(r,e,t),closeFn:r=>r.code===C.OPERATION_ABORTED||r.code===C.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(i){throw i}}async function xR(e,t,n,i){const r=A("PROXY_SERVER_TYPE3"),o=(p,m,E)=>{let g=E||r;return Array.isArray(g)&&(g=m%2==0?r[1]:r[0]),"https://".concat(g,"/ap/?url=").concat(p)};let s=null;const a=[],c=async()=>{const p=A("WEBCS_DOMAIN").slice(0,A("AJAX_REQUEST_CONCURRENT")).map((g,S)=>{let T;return T=e.cloudProxyServer==="disabled"&&e.proxyServer?o("".concat(g,"/api/v2/transpond/webrtc?v=2"),S,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(g,"/api/v2/transpond/webrtc?v=2"):o("".concat(g,"/api/v2/transpond/webrtc?v=2"),S),{url:T,areaCode:gd(),serviceIds:[ft.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?ft.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?ft.CLOUD_PROXY:ft.CLOUD_PROXY_FALLBACK]}}),m=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(g=>g.url)}),E=await Sd({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:g=>(f.debug("[".concat(e.clientId,"] Connect to choose_server:"),g.url),kR(g,e,t,n)),allFailedhandler:g=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},m),g[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},m),E},d=async()=>{if(await Pt(1e3),s!==null)return s;const p=A("WEBCS_DOMAIN_BACKUP_LIST").map((g,S)=>{let T;return T=e.cloudProxyServer==="disabled"&&e.proxyServer?o("".concat(g,"/api/v2/transpond/webrtc?v=2"),S,e.proxyServer):e.cloudProxyServer==="disabled"||e.cloudProxyServer==="fallback"?"https://".concat(g,"/api/v2/transpond/webrtc?v=2"):o("".concat(g,"/api/v2/transpond/webrtc?v=2"),S),{url:T,areaCode:gd(),serviceIds:[ft.CHOOSE_SERVER,e.cloudProxyServer==="proxy5"?ft.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?ft.CLOUD_PROXY:ft.CLOUD_PROXY_FALLBACK]}}),m=i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(g=>g.url)}),E=await Sd({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:g=>(f.debug("[".concat(e.clientId,"] Connect to backup choose_server:"),g.url),kR(g,e,t,n)),allFailedhandler:g=>{throw i.recordJoinChannelService({endTs:Date.now(),status:"error",errors:g},m),g[0]},promisesCollector:a});return i.recordJoinChannelService({endTs:Date.now(),status:"success"},m),E};let l,u,h;try{({gatewayInfo:l,proxyInfo:u,url:h}=await za([c(),d()]))}catch(p){throw p[0]}if(a.length&&a.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),!l||!u)throw new N(C.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(e.apUrl=h,e.cloudProxyServer!=="disabled"&&Array.isArray(r)&&h){const p=/^https?:\/\/(.+?)(\/.*)?$/.exec(h)[1];r.includes(p)&&(e.proxyServer=p,f.setProxyServer(p),q.setProxyServer(p))}return s={gatewayInfo:l,proxyInfo:await iw(u,l.uid)},s}async function VR(e,t,n,i){const r=A("UAP_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(o=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap"));return await wM(r,e,t,n,i)}async function PM(e,t,n){const i=A("UAP_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(r=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(r+"/api/v1?action=uap"):"https://".concat(r,"/api/v1?action=uap")).map(r=>function(o,s,a,c){const d={command:"convergeAllocateEdge",sid:s.sid,appId:s.appId,token:s.token,ts:Date.now(),version:fi,cname:s.cname,uid:s.uid.toString(),requestId:xp,seq:xp};xp+=1;const l={service_name:"tele_channel",json_body:JSON.stringify(d)};return wr(async()=>{const u=await or(o,{data:l,cancelToken:a,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(u.code!==0){const p=new N(C.UNEXPECTED_RESPONSE,"cross channel ap error, code"+u.code,{retry:!0});throw f.error(p.toString()),p}const h=JSON.parse(u.json_body);if(h.code!==200){const p=new N(C.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(h.code,", reason: ").concat(h.reason));throw f.error(p.toString()),p}if(!h.servers||h.servers.length===0){const p=new N(C.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw f.error(p.toString()),p}return{vid:h.vid,workerToken:h.workerToken,addressList:(A("CHANNEL_MEDIA_RELAY_SERVERS")||h.servers).map(p=>"wss://".concat(p.address.replace(/\./g,"-"),".").concat(A("WORKER_DOMAIN"),":").concat(p.wss))}},void 0,u=>!!(u.code!==C.OPERATION_ABORTED&&u.code!==C.UNEXPECTED_RESPONSE||u.data&&u.data.retry),c)}(r,e,t,n));try{const r=await za(i);return i.forEach(o=>o.cancel()),r}catch(r){throw r[0]}}async function LM(e,t,n){let i=null;const r=[],o=async s=>{const a=A(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>e.proxyServer?"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return s&&(await Pt(1e3),i!==null)?i:await Sd({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(f.debug("[".concat(e.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),c),function(d,l,u,h){const[p]=OM(l,[ft.CHOOSE_SERVER]);let m=it.networkState;return wr(async()=>{m&&it.networkState===Tn.OFFLINE&&it.onlineWaiter&&await Promise.race([it.onlineWaiter,Pt(h&&h.maxRetryTimeout||_t.maxRetryTimeout)]),m=it.networkState;const E=await or(d,{data:p,cancelToken:u,headers:{"Content-Type":"multipart/form-data;"}},!0);return NM(E,d)},()=>!1,E=>E.code!==C.OPERATION_ABORTED&&(E.code===C.UPDATE_TICKET_FAILED?E.data.retry:(f.warning("[".concat(l.clientId,"] update ticket network error, retry"),E),!0)),h)}(c,e,t,n)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})};try{return i=await za([o(!1),o(!0)]),r.length&&r.forEach(s=>s.cancel&&typeof s.cancel=="function"&&s.cancel()),i}catch(s){throw s[0]}}class kM extends qe{get isSuccess(){return!!this.configs}constructor(){super(),this.configs=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.retryConfig={timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4},this.interval=void 0,this.mutex=new Bt("config-distribute"),this.mutableParamsRead=!1}startGetConfigDistribute(t,n){this.joinInfo=t,this.cancelToken=n,this.interval&&this.stopGetConfigDistribute(),A("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},A("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0}async awaitConfigDistributeComplete(){this.mutex.isLocked&&(await this.mutex.lock())()}async updateConfigDistribute(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,q.reportApiInvoke(null,{options:void 0,name:an.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:bt.TRACER}).onSuccess(JSON.stringify(fo))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void f.debug("[config-distribute] get config distribute interrupted have no joininfo");let t;const n=await this.mutex.lock();try{t=await DM(this.joinInfo,this.cancelToken,this.retryConfig),f.debug("[config-distribute] get config distribute",JSON.stringify(t)),t.limit_bitrate&&this.handleBitrateLimit(t.limit_bitrate),this.cacheGlobalParameterConfig(t),this.configs=t}catch(i){const r=new N(C.NETWORK_RESPONSE_ERROR,i);f.warning("[config-distribute] ".concat(r.toString()))}finally{n()}}getBitrateLimit(){return this.configs?this.configs.limit_bitrate:void 0}handleBitrateLimit(t){var n;(n=t)&&n.uplink&&n.id&&n.uplink.max_bitrate!==void 0&&n.uplink.min_bitrate!==void 0&&(this.configs&&this.configs.limit_bitrate?this.configs&&this.configs.limit_bitrate&&this.configs.limit_bitrate.id!==t.id&&this.emit(Af.UPDATE_BITRATE_LIMIT,t):this.emit(Af.UPDATE_BITRATE_LIMIT,t))}getLowStreamConfigDistribute(){return this.configs&&this.configs.limit_bitrate&&F({},this.configs.limit_bitrate.low_stream_uplink)}cacheGlobalParameterConfig(t){const n=Object.keys(t).filter(r=>/^webrtc_ng_global_parameter/.test(r)).sort();for(let r=0;r<n.length;r++)for(let o=n.length-1;o>r;o--){const s=n[o];if(typeof t[s].__priority=="number"){const a=t[s].__priority,c=n[o-1];if(typeof t[c].__priority=="number"){if(!(a>t[c].__priority))continue;{const d=s;n[o]=n[o-1],n[o-1]=d}}else{const d=s;n[o]=n[o-1],n[o-1]=d}}}const i={};n.forEach(r=>{const o=t[r],s=o.__expires;Object.keys(o).forEach(a=>{a==="__priority"||a==="__expires"||Object.prototype.hasOwnProperty.call(i,a)||(i[a]=F({value:o[a]},s&&{expires:s}))})});try{(function(s){try{const a=Date.now();Object.keys(s).forEach(c=>{switch(c){case"ENABLE_EVENT_REPORT":case"UPLOAD_LOG":case"ENABLE_AG_ADAPTATION":case"FORCE_AG_HIGH_FRAMERATE":case"FORCE_SUPPORT_AG_ADAPTATION":case"ENCODER_CONFIG_LIMIT":case"CAMERA_CAPTURE_CONFIG":case"ENABLE_PRELOAD":if(Object.prototype.hasOwnProperty.call(Ct,c)){const{value:d,expires:l}=s[c];if(l&&l<=a)return;fo[c]=d,Ct[c]=d,f.debug("Update global parameters from config distribute",c,d)}}})}catch(a){f.error("Error update config immediately: ".concat(s),a.message)}})(i);const r=JSON.stringify(i),o=window.btoa(r);window.localStorage.setItem("websdk_ng_global_parameter",o),f.debug("Caching global parameters ".concat(r))}catch(r){f.error("Error caching global parameters:",r.message)}}}class MM extends qe{constructor(){super(...arguments),this.resultStorage=new Map}setLocalAudioStats(t,n,i){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",t,this.checkAudioInputLevel(i,n)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",t,this.checkSendAudioBitrate(i,n))}setLocalVideoStats(t,n,i){this.record("SEND_VIDEO_BITRATE_TOO_LOW",t,this.checkSendVideoBitrate(i,n)),this.record("FRAMERATE_INPUT_TOO_LOW",t,this.checkFramerateInput(i,n)),this.record("FRAMERATE_SENT_TOO_LOW",t,this.checkFramerateSent(i))}setRemoteAudioStats(t,n){const i=t.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",i,this.checkAudioOutputLevel(n))}setRemoteVideoStats(t,n){const i=t.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",i,this.checkVideoDecode(n))}record(t,n,i){if(A("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(t)||this.resultStorage.set(t,{result:[],isPrevNormal:!0});const r=this.resultStorage.get(t);if(r&&(r.result.push(i),r.result.length>=5)){const o=r.result.includes(!0);r.isPrevNormal&&!o&&this.emit("exception",FR[t],t,n),!r.isPrevNormal&&o&&this.emit("exception",FR[t]+2e3,t+"_RECOVER",n),r.isPrevNormal=o,r.result=[]}}checkAudioOutputLevel(t){return!(t.receiveBitrate>0&&t.receiveLevel===0)}checkAudioInputLevel(t,n){return n instanceof Ot&&!n.isActive||!!n.muted||t.sendVolumeLevel!==0}checkFramerateInput(t,n){let i=null;n._encoderConfig&&n._encoderConfig.frameRate&&(i=kn(n._encoderConfig.frameRate));const r=t.captureFrameRate;return!i||!r||!(i>10&&r<5||i<10&&i>=5&&r<=1)}checkFramerateSent(t){return!(t.captureFrameRate&&t.sendFrameRate&&t.captureFrameRate>5&&t.sendFrameRate<=1)}checkSendVideoBitrate(t,n){return!!n.muted||t.sendBitrate!==0}checkSendAudioBitrate(t,n){return n instanceof Ot&&!n.isActive||!!n.muted||t.sendBitrate!==0}checkVideoDecode(t){return t.receiveBitrate===0||t.decodeFrameRate!==0}}const FR={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},nn=new class{markSubscribeStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/subscribe-").concat(t))}markPublishStart(e,t){performance.mark("agora-web-sdk/".concat(e,"/publish-").concat(t))}measureFromSubscribeStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/subscribe-").concat(t));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}measureFromPublishStart(e,t){const n=performance.getEntriesByName("agora-web-sdk/".concat(e,"/publish-").concat(t));if(n.length>0){const i=n[n.length-1];return Math.round(performance.now()-i.startTime)}return 0}};var $e=(()=>{var e={8:(i,r,o)=>{o.r(r),o.d(r,{Parser:()=>x,Printer:()=>ot,parse:()=>te,print:()=>le});const s=`
`,a="".concat("\r").concat(s),c=" ";let d;function l(V){return V>="0"&&V<="9"}function u(V){return V>="!"&&V<="~"}function h(V){return u(V)||V>=""&&V<=""}function p(V){return V==="!"||V>="#"&&V<="'"||V>="*"&&V<="+"||V>="-"&&V<="."||V>="0"&&V<="9"||V>="A"&&V<="Z"||V>="^"&&V<="~"}function m(V){return V>="1"&&V<="9"}function E(V){return V>="A"&&V<="Z"||V>="a"&&V<="z"}function g(V){return V==="d"||V==="h"||V==="m"||V==="s"}function S(V){return V>""&&V<"	"||V>"\v"&&V<"\f"||V>""&&V<""}function T(V){return E(V)||l(V)||V==="+"||V==="/"}function I(V){return l(V)||E(V)||V==="+"||V==="/"||V==="-"||V==="_"}function y(V){return E(V)||l(V)||V==="+"||V==="/"}function w(V,_){var R=Object.keys(V);if(Object.getOwnPropertySymbols){var v=Object.getOwnPropertySymbols(V);_&&(v=v.filter(function(b){return Object.getOwnPropertyDescriptor(V,b).enumerable})),R.push.apply(R,v)}return R}function D(V){for(var _=1;_<arguments.length;_++){var R=arguments[_]!=null?arguments[_]:{};_%2?w(Object(R),!0).forEach(function(v){O(V,v,R[v])}):Object.getOwnPropertyDescriptors?Object.defineProperties(V,Object.getOwnPropertyDescriptors(R)):w(Object(R)).forEach(function(v){Object.defineProperty(V,v,Object.getOwnPropertyDescriptor(R,v))})}return V}function O(V,_,R){return _ in V?Object.defineProperty(V,_,{value:R,enumerable:!0,configurable:!0,writable:!0}):V[_]=R,V}(function(V){V.VERSION="v",V.ORIGIN="o",V.SESSION_NAME="s",V.INFORMATION="i",V.URI="u",V.EMAIL="e",V.PHONE="p",V.CONNECTION="c",V.BANDWIDTH="b",V.TIME="t",V.REPEAT="r",V.ZONE_ADJUSTMENTS="z",V.KEY="k",V.ATTRIBUTE="a",V.MEDIA="m"})(d||(d={}));class P{consumeText(_,R){let v=R;for(;v<_.length;){const b=_[v];if(b==="\0"||b==="\r"||b===s)break;v+=1}if(v-R==0)throw new Error("Invalid text, at ".concat(_));return v}consumeUnicastAddress(_,R,v){return this.consumeTill(_,R,c)}consumeOneOrMore(_,R,v){let b=R;for(;v(_[b]);)b++;if(b-R==0)throw new Error("Invalid rule at ".concat(R,"."));return b}consumeSpace(_,R){if(_[R]===c)return R+1;throw new Error("Invalid space at ".concat(R,"."))}consumeIP4Address(_,R){let v=R;for(let b=0;b<4;b++)if(v=this.consumeDecimalUChar(_,v),b!==3){if(_[v]!==".")throw new Error("Invalid IP4 address.");v++}return v}consumeDecimalUChar(_,R){let v=R;for(let K=0;K<3&&l(_[v]);K++,v++);if(v-R==0)throw new Error("Invalid decimal uchar.");const b=parseInt(_.slice(R,v));if(b>=0&&b<=255)return v;throw new Error("Invalid decimal uchar")}consumeIP6Address(_,R){let v=this.consumeHexpart(_,R);return _[v]===":"&&(v+=1,v=this.consumeIP4Address(_,v)),v}consumeHexpart(_,R){let v=R;if(_[v]===":"&&_[v+1]===":"){v+=2;try{v=this.consumeHexseq(_,v)}catch{}return v}if(v=this.consumeHexseq(_,v),_[v]===":"&&_[v+1]===":"){v+=2;try{v=this.consumeHexseq(_,v)}catch{}return v}return v}consumeHexseq(_,R){let v=R;for(;v=this.consumeHex4(_,v),_[v]===":"&&_[v+1]!==":";)v+=1;return v}consumeHex4(_,R){let v=0;for(;v<4;v++)if(!((b=_[R+v])>="0"&&b<="9"||b>="a"&&b<="f"||b>="A"&&b<="F")){if(v===0)throw new Error("Invalid hex 4");break}var b;return R+v}consumeFQDN(_,R){let v=R;for(;l(_[v])||E(_[v])||_[v]==="-"||_[v]===".";)v+=1;if(v-R<4)throw new Error("Invalid FQDN");return v}consumeExtnAddr(_,R){return this.consumeOneOrMore(_,R,h)}consumeMulticastAddress(_,R,v){switch(v){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(_,R);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(_,R);default:try{return this.consumeFQDN(_,R)}catch{return this.consumeExtnAddr(_,R)}}}consumeIP6MulticastAddress(_,R){const v=this.consumeHexpart(_,R);return _[v]==="/"?this.consumeInteger(_,v+1):v}consumeIP4MulticastAddress(_,R){let v=R+3;const b=_.slice(R,v),K=parseInt(b);if(K<224||K>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let re=0;re<3;re++){if(_[v]!==".")throw new Error("Invalid IP4 multicast address.");v+=1,v=this.consumeDecimalUChar(_,v)}return _[v]==="/"&&(v+=1),v=this.consumeTTL(_,v),_[v]==="/"&&(v=this.consumeInteger(_,v)),v}consumeInteger(_,R){if(!m(_[R]))throw new Error("Invalid integer.");for(R+=1;l(_[R]);)R+=1;return R}consumeTTL(_,R){if(_[R]==="0")return R+1;if(!m(_[R]))throw new Error("Invalid TTL.");R+=1;for(let v=0;v<2&&l(_[R]);v++)R+=1;return R}consumeToken(_,R){return this.consumeOneOrMore(_,R,p)}consumeTime(_,R){let v=R;if(_[v]==="0")return v+1;for(m(_[v])&&(v+=1);l(_[v]);)v++;if(v-R<10)throw new Error("Invalid time");return v}consumeAddress(_,R){return this.consumeTill(_,R,c)}consumeTypedTime(_,R){let v=R;return v=this.consumeOneOrMore(_,v,l),g(_[v])?v+1:v}consumeRepeatInterval(_,R){if(!m(_[R]))throw new Error("Invalid repeat interval");for(R+=1;l(_[R]);)R+=1;return g(_[R])&&(R+=1),R}consumePort(_,R){return this.consumeOneOrMore(_,R,l)}consume(_,R,v){for(let b=0;b<v.length;b++){if(R+b>=_.length)throw new Error("consume exceeding value length");if(_[R+b]!==v[b])throw new Error("consume ".concat(v," failed at ").concat(b))}return R+v.length}consumeTill(_,R,v){let b=R;for(;b<_.length&&(typeof v!="string"||_[b]!==v)&&(typeof v!="function"||!v(_[b]));)b++;return b}}class x extends P{constructor(){super(),O(this,"records",[]),O(this,"currentLine",0)}parse(_){const R=this.probeEOL(_);this.records=_.split(R).filter($a=>!!$a.trim()).map(this.parseLine),this.currentLine=0;const v=this.parseVersion(),b=this.parseOrigin(),K=this.parseSessionName(),re=this.parseInformation(),Ne=this.parseUri(),kt=this.parseEmail(),qr=this.parsePhone(),Ud=this.parseConnection(),wh=this.parseBandWidth(),bs=this.parseTimeFields(),xd=this.parseKey(),Bo=this.parseSessionAttribute(),Nh=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:v,origin:b,sessionName:K,information:re,uri:Ne,emails:kt,phones:qr,connection:Ud,bandwidths:wh,timeFields:bs,key:xd,attributes:Bo,mediaDescriptions:Nh}}getCurrentRecord(){const _=this.records[this.currentLine];if(!_)throw new Error("Record doesn't exit.");return _}probeEOL(_){for(let R=0;R<_.length;R++)if(_[R]===s)return _[R-1]==="\r"?a:s;throw new Error("Invalid newline character.")}parseLine(_,R){if(_.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");const v=_[0];if(_[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:v,value:_.slice(2),line:R,cur:0}}parseSessionAttribute(){const _=new J;for(;this.currentLine<this.records.length;){const R=this.getCurrentRecord();if(R.type!==d.ATTRIBUTE)break;const v={attField:this.extractOneOrMore(R,b=>p(b)&&b!==":"),_cur:0};R.value[R.cur]===":"&&(R.cur+=1,v.attValue=this.extractOneOrMore(R,S)),_.parse(v),this.currentLine++}return _.digest()}parseMediaAttributes(_){const R=new Le(_);for(;this.currentLine<this.records.length;){const v=this.getCurrentRecord();if(v.type!==d.ATTRIBUTE)break;const b={attField:this.extractOneOrMore(v,K=>p(K)&&K!==":"),_cur:0};v.value[v.cur]===":"&&(v.cur+=1,b.attValue=this.extractOneOrMore(v,S)),R.parse(b),this.currentLine++}return R.digest()}parseKey(){const _=this.getCurrentRecord();if(_.type===d.KEY){if(_.value==="prompt"||_.value==="clear:"||_.value==="base64:"||_.value==="uri:")return _.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){const _=this.getCurrentRecord();if(_.type===d.ZONE_ADJUSTMENTS){const R=[];for(;;)try{const v=this.extract(_,this.consumeTime);this.consumeSpaceForRecord(_);let b=!1;_.value[_.cur]==="-"&&(b=!0,_.cur+=1);const K=this.extract(_,this.consumeTypedTime);R.push({time:v,typedTime:K,back:b})}catch{break}if(R.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,R}return[]}parseRepeat(){const _=[];for(;;){const R=this.getCurrentRecord();if(R.type!==d.REPEAT)break;{const v=this.extract(R,this.consumeRepeatInterval),b=this.parseTypedTime(R);_.push({repeatInterval:v,typedTimes:b}),this.currentLine++}}return _}parseTypedTime(_){const R=[];for(;;)try{this.consumeSpaceForRecord(_),R.push(this.extract(_,this.consumeTypedTime))}catch{break}if(R.length===0)throw new Error("Invalid typed time.");return R}parseTime(){const _=this.getCurrentRecord(),R=this.extract(_,this.consumeTime);this.consumeSpaceForRecord(_);const v=this.extract(_,this.consumeTime);return this.currentLine++,{startTime:R,stopTime:v}}parseBandWidth(){const _=[];for(;this.currentLine<this.records.length;){const R=this.getCurrentRecord();if(R.type!==d.BANDWIDTH)break;{const v=this.extractOneOrMore(R,p);if(R.value[R.cur]!==":")throw new Error("Invalid bandwidth field.");R.cur++;const b=this.extractOneOrMore(R,l);_.push({bwtype:v,bandwidth:b}),this.currentLine++}}return _}parseVersion(){const _=this.getCurrentRecord();if(_.type!==d.VERSION)throw new Error("first sdp record must be version");const R=_.value.slice(0,this.consumeOneOrMore(_.value,0,l));if(R.length!==_.value.length)throw new Error('invalid proto version, "v='.concat(_.value,'"'));return this.currentLine++,R}parseOrigin(){const _=this.getCurrentRecord();if(_.type!==d.ORIGIN)throw new Error("second line of sdp must be origin");const R=this.extractOneOrMore(_,h);this.consumeSpaceForRecord(_);const v=this.extractOneOrMore(_,l);this.consumeSpaceForRecord(_);const b=this.extractOneOrMore(_,l);this.consumeSpaceForRecord(_);const K=this.extractOneOrMore(_,p);this.consumeSpaceForRecord(_);const re=this.extractOneOrMore(_,p);this.consumeSpaceForRecord(_);const Ne=this.extract(_,this.consumeUnicastAddress);return this.currentLine++,{username:R,sessId:v,sessVersion:b,nettype:K,addrtype:re,unicastAddress:Ne}}parseSessionName(){const _=this.getCurrentRecord();if(_.type===d.SESSION_NAME){const R=this.extract(_,this.consumeText);return this.currentLine++,R}}parseInformation(){const _=this.getCurrentRecord();if(_.type!==d.INFORMATION)return;const R=this.extract(_,this.consumeText);return this.currentLine++,R}parseUri(){const _=this.getCurrentRecord();if(_.type===d.URI)return this.currentLine++,_.value}parseEmail(){const _=[];for(;;){const R=this.getCurrentRecord();if(R.type!==d.EMAIL)break;_.push(R.value),this.currentLine++}return _}parsePhone(){const _=[];for(;;){const R=this.getCurrentRecord();if(R.type!==d.PHONE)break;_.push(R.value),this.currentLine++}return _}parseConnection(){const _=this.getCurrentRecord();if(_.type===d.CONNECTION){const R=this.extractOneOrMore(_,p);this.consumeSpaceForRecord(_);const v=this.extractOneOrMore(_,p);this.consumeSpaceForRecord(_);const b=this.extract(_,this.consumeAddress);return this.currentLine++,{nettype:R,addrtype:v,address:b}}}parseMedia(){const _=this.getCurrentRecord(),R=this.extract(_,this.consumeToken);this.consumeSpaceForRecord(_);let v=this.extract(_,this.consumePort);_.value[_.cur]==="/"&&(_.cur+=1,v+=this.extract(_,this.consumeInteger)),this.consumeSpaceForRecord(_);const b=[];for(b.push(this.extract(_,this.consumeToken));_.value[_.cur]==="/";)_.cur+=1,b.push(this.extract(_,this.consumeToken));if(b.length===0)throw new Error("Invalid proto");const K=this.parseFmt(_);return this.currentLine++,{mediaType:R,port:v,protos:b,fmts:K}}parseTimeFields(){const _=[];for(;this.getCurrentRecord().type===d.TIME;){const R=this.parseTime(),v=this.parseRepeat(),b=this.parseZone();_.push({time:R,repeats:v,zones:b})}return _}parseMediaDescription(){const _=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.MEDIA;){const R=this.parseMedia(),v=this.parseInformation(),b=this.parseConnections(),K=this.parseBandWidth(),re=this.parseKey(),Ne=this.parseMediaAttributes(R);_.push({media:R,information:v,connections:b,bandwidths:K,key:re,attributes:Ne})}return _}parseConnections(){const _=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.CONNECTION;)_.push(this.parseConnection());return _}parseFmt(_){const R=[];for(;;)try{this.consumeSpaceForRecord(_),R.push(this.extract(_,this.consumeToken))}catch{break}if(R.length===0)throw new Error("Invalid fmts");return R}extract(_,R){for(var v=arguments.length,b=new Array(v>2?v-2:0),K=2;K<v;K++)b[K-2]=arguments[K];const re=R.call(this,_.value,_.cur,...b),Ne=_.value.slice(_.cur,re);return _.cur=re,Ne}extractOneOrMore(_,R){const v=this.consumeOneOrMore(_.value,_.cur,R),b=_.value.slice(_.cur,v);return _.cur=v,b}consumeSpaceForRecord(_){if(_.value[_.cur]!==c)throw new Error("Invalid space at ".concat(_.cur,"."));_.cur+=1}}class U extends P{constructor(){super(...arguments),O(this,"attributes",void 0),O(this,"digested",!1)}extractOneOrMore(_,R,v){const b=this.consumeOneOrMore(_.attValue,_._cur,R),K=_.attValue.slice(_._cur,b),[re,Ne]=v||[];if(typeof re=="number"&&K.length<re)throw new Error("error in length, should be more or equal than ".concat(re," characters."));if(typeof Ne=="number"&&K.length>Ne)throw new Error("error in length, should be less or equal than ".concat(Ne," characters."));return _._cur=b,K}consumeAttributeSpace(_){if(_.attValue[_._cur]!==c)throw new Error("Invalid space at ".concat(_._cur,"."));_._cur+=1}extract(_,R){if(!_.attValue)throw new Error("Nothing to extract from attValue.");for(var v=arguments.length,b=new Array(v>2?v-2:0),K=2;K<v;K++)b[K-2]=arguments[K];const re=R.call(this,_.attValue,_._cur,...b),Ne=_.attValue.slice(_._cur,re);return _._cur=re,Ne}atEnd(_){if(!_.attValue)throw new Error;return _._cur>=_.attValue.length}peekChar(_){if(!_.attValue)throw new Error;return _.attValue[_._cur]}peek(_,R){if(!_.attValue)throw new Error;for(let v=0;v<R.length;v++)if(R[v]!==_.attValue[_._cur+v])return!1;return!0}parseIceUfrag(_){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(_,T,[4,256])}parseIcePwd(_){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(_,T,[22,256])}parseIceOptions(_){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");const R=[];for(;!this.atEnd(_);){R.push(this.extractOneOrMore(_,T));try{this.consumeAttributeSpace(_)}catch(v){if(this.atEnd(_))break;throw v}}this.attributes.iceOptions=R}parseFingerprint(_){const R=this.extract(_,this.consumeToken);this.consumeAttributeSpace(_);const v=this.extract(_,this.consumeTill);this.attributes.fingerprints.push({hashFunction:R,fingerprint:v})}parseExtmap(_){const R=this.extractOneOrMore(_,l);let v;this.peekChar(_)==="/"&&(this.extract(_,this.consume,"/"),v=this.extract(_,this.consumeToken)),this.consumeAttributeSpace(_);const b=this.extract(_,this.consumeTill,c),K=D(D({entry:parseInt(R,10)},v&&{direction:v}),{},{extensionName:b});this.peekChar(_)===c&&(this.consumeAttributeSpace(_),K.extensionAttributes=this.extract(_,this.consumeTill)),this.attributes.extmaps.push(K)}parseSetup(_){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");const R=this.extract(_,this.consumeTill);if(R!=="active"&&R!=="passive"&&R!=="actpass"&&R!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=R}}class J extends U{constructor(){super(...arguments),O(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(_){if(this.digested)throw new Error("already digested");try{switch(_.attField){case"group":this.parseGroup(_);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(_);break;case"ice-pwd":this.parseIcePwd(_);break;case"ice-options":this.parseIceOptions(_);break;case"fingerprint":this.parseFingerprint(_);break;case"setup":this.parseSetup(_);break;case"tls-id":this.parseTlsId(_);break;case"identity":this.parseIdentity(_);break;case"extmap":this.parseExtmap(_);break;case"msid-semantic":this.parseMsidSemantic(_);break;default:_.ignored=!0,this.attributes.unrecognized.push(_)}}catch(R){throw console.error("parsing session attribute ".concat(_.attField,' error, "a=').concat(_.attField,":").concat(_.attValue,'"')),R}if(!_.ignored&&_.attValue&&!this.atEnd(_))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(_){const R=this.extract(_,this.consumeToken),v=[];for(;!this.atEnd(_)&&this.peekChar(_)===c;)this.consumeAttributeSpace(_),v.push(this.extract(_,this.consumeToken));this.attributes.groups.push({semantic:R,identificationTag:v})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(_){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(_,I)}parseIdentity(_){const R=this.extractOneOrMore(_,y),v=[];for(;!this.atEnd(_)&&this.peekChar(_)===c;){this.consumeAttributeSpace(_);const b=this.extract(_,this.consumeToken);this.extract(_,this.consume,"=");const K=this.extractOneOrMore(_,re=>re!==c&&S(re));v.push({name:b,value:K})}this.attributes.identities.push({assertionValue:R,extensions:v})}parseMsidSemantic(_){this.peekChar(_)===c&&this.consumeAttributeSpace(_);const R={semantic:this.extract(_,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(_)}catch{break}if(this.peekChar(_)==="*"){this.extract(_,this.consume,"*"),R.applyForAll=!0;break}{const v=this.extract(_,this.consumeTill,c);R.identifierList.push(v)}}this.attributes.msidSemantic=R}}class Le extends U{constructor(_){super(),O(this,"attributes",void 0),_.protos.indexOf("RTP")!==-1||_.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(_){if(this.digested)throw new Error("already digested");try{switch(_.attField){case"extmap":this.parseExtmap(_);break;case"setup":this.parseSetup(_);break;case"ice-ufrag":this.parseIceUfrag(_);break;case"ice-pwd":this.parseIcePwd(_);break;case"ice-options":this.parseIceOptions(_);break;case"candidate":this.parseCandidate(_);break;case"remote-candidate":this.parseRemoteCandidate(_);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(_);break;case"rtpmap":this.parseRtpmap(_);break;case"ptime":this.parsePtime(_);break;case"maxptime":this.parseMaxPtime(_);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(_);break;case"ssrc":this.parseSSRC(_);break;case"fmtp":this.parseFmtp(_);break;case"rtcp-fb":this.parseRtcpFb(_);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(_);break;case"mid":this.parseMid(_);break;case"msid":this.parseMsid(_);break;case"imageattr":this.parseImageAttr(_);break;case"rid":this.parseRid(_);break;case"simulcast":this.parseSimulcast(_);break;case"sctp-port":this.parseSctpPort(_);break;case"max-message-size":this.parseMaxMessageSize(_);break;case"ssrc-group":this.parseSSRCGroup(_);break;default:_.ignored=!0,this.attributes.unrecognized.push(_)}}catch(R){throw console.error("parsing media attribute ".concat(_.attField,' error, "a=').concat(_.attField,":").concat(_.attValue,'"')),R}if(!_.ignored&&_.attValue&&!this.atEnd(_))throw new Error("attribute parsing error")}parseCandidate(_){const R=this.extractOneOrMore(_,T,[1,32]);this.consumeAttributeSpace(_);const v=this.extractOneOrMore(_,l,[1,5]);this.consumeAttributeSpace(_);const b=this.extract(_,this.consumeToken);this.consumeAttributeSpace(_);const K=this.extractOneOrMore(_,l,[1,10]);this.consumeAttributeSpace(_);const re=this.extract(_,this.consumeAddress);this.consumeAttributeSpace(_);const Ne=this.extract(_,this.consumePort);this.consumeAttributeSpace(_),this.extract(_,this.consume,"typ"),this.consumeAttributeSpace(_);const kt={foundation:R,componentId:v,transport:b,priority:K,connectionAddress:re,port:Ne,type:this.extract(_,this.consumeToken),extension:{}};for(this.peek(_," raddr")&&(this.extract(_,this.consume," raddr"),this.consumeAttributeSpace(_),kt.relAddr=this.extract(_,this.consumeAddress)),this.peek(_," rport")&&(this.extract(_,this.consume," rport"),this.consumeAttributeSpace(_),kt.relPort=this.extract(_,this.consumePort));this.peekChar(_)===c;){this.consumeAttributeSpace(_);const qr=this.extract(_,this.consumeToken);this.consumeAttributeSpace(_),kt.extension[qr]=this.extractOneOrMore(_,u)}this.attributes.candidates.push(kt)}parseRemoteCandidate(_){const R=[];for(;;){const v=this.extractOneOrMore(_,l,[1,5]);this.consumeAttributeSpace(_);const b=this.extract(_,this.consumeAddress);this.consumeAttributeSpace(_);const K=this.extract(_,this.consumePort);R.push({componentId:v,connectionAddress:b,port:K});try{this.consumeAttributeSpace(_)}catch{break}}this.attributes.remoteCandidatesList.push(R)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(_){const R=this.extract(_,this.consumeToken);this.consumeAttributeSpace(_);const v=this.extract(_,this.consumeTill,"/");this.extract(_,this.consume,"/");const b={encodingName:v,clockRate:this.extractOneOrMore(_,l)};this.atEnd(_)||this.peekChar(_)!=="/"||(this.extract(_,this.consume,"/"),b.encodingParameters=parseInt(this.extract(_,this.consumeTill),10));const K=this.attributes.payloads.find(re=>re.payloadType===parseInt(R,10));K?K.rtpMap=b:this.attributes.payloads.push({payloadType:parseInt(R,10),rtpMap:b,rtcpFeedbacks:[]})}parsePtime(_){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(_,this.consumeTill)}parseMaxPtime(_){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(_,this.consumeTill)}parseDirection(_){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=_.attField}parseSSRC(_){const R=this.extractOneOrMore(_,l);this.consumeAttributeSpace(_);const v=this.extract(_,this.consumeTill,":");let b;this.peekChar(_)===":"&&(this.extract(_,this.consume,":"),b=this.extract(_,this.consumeTill));const K=this.attributes.ssrcs.find(re=>re.ssrcId===parseInt(R,10));K?K.attributes[v]=b:this.attributes.ssrcs.push({ssrcId:parseInt(R,10),attributes:{[v]:b}})}parseFmtp(_){const R=this.extract(_,this.consumeTill,c);this.consumeAttributeSpace(_);const v=this.extract(_,this.consumeTill),b={};v.split(";").forEach(re=>{let[Ne,kt]=re.split("=");Ne=Ne.trim();const qr=typeof kt=="string"?kt.trim():null;typeof Ne=="string"&&Ne.length>0&&(b[Ne]=qr)});const K=this.attributes.payloads.find(re=>re.payloadType===parseInt(R,10));K?K.fmtp={parameters:b}:this.attributes.payloads.push({payloadType:parseInt(R,10),rtcpFeedbacks:[],fmtp:{parameters:b}})}parseFmtParameters(_){const R={},v=this.extract(_,this.consumeTill,"=");_._cur++;const b=this.extract(_,this.consumeTill,";");for(R[v]=b;_.attValue[_._cur]===";";){const K=this.extract(_,this.consumeTill,"=");_._cur++;const re=this.extract(_,this.consumeTill,";");R[K]=re}return R}parseRtcpFb(_){let R="";R=this.peekChar(_)==="*"?this.extract(_,this.consume,"*"):this.extract(_,this.consumeTill,c),this.consumeAttributeSpace(_);const v=this.extract(_,this.consumeTill,c);let b;if(v==="trr-int")b={type:v,interval:this.extract(_,this.consumeTill)};else{const K={type:v};this.peekChar(_)===c&&(this.consumeAttributeSpace(_),K.parameter=this.extract(_,this.consumeToken),this.peekChar(_)===c&&(K.additional=this.extract(_,this.consumeTill))),b=K}if(R==="*")this.attributes.rtcpFeedbackWildcards.push(b);else{const K=this.attributes.payloads.find(re=>re.payloadType===parseInt(R,10));K?K.rtcpFeedbacks.push(b):this.attributes.payloads.push({payloadType:parseInt(R,10),rtcpFeedbacks:[b]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(_){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");const R={port:this.extract(_,this.consumePort)};this.peekChar(_)===c&&(this.consumeAttributeSpace(_),R.netType=this.extractOneOrMore(_,p),this.consumeAttributeSpace(_),R.addressType=this.extractOneOrMore(_,p),this.consumeAttributeSpace(_),R.address=this.extract(_,this.consumeAddress)),this.attributes.rtcp=R}parseMsid(_){const R={id:this.extractOneOrMore(_,p,[1,64])};this.peekChar(_)===c&&(this.consumeAttributeSpace(_),R.appdata=this.extractOneOrMore(_,p,[1,64])),this.attributes.msids.push(R)}parseImageAttr(_){this.attributes.imageattr.push(_.attValue)}parseRid(_){const R=this.extractOneOrMore(_,b=>E(b)||l(b)||b==="_"||b==="-");this.consumeAttributeSpace(_);const v={id:R,direction:this.extract(_,this.consumeToken),params:[]};if(this.peekChar(_)===c){if(this.consumeAttributeSpace(_),this.peek(_,"pt=")){this.extract(_,this.consume,"pt=");const b=[];for(;;){const K=this.extract(_,this.consumeToken);b.push(K);try{this.extract(_,this.consume,",")}catch{break}}v.payloads=b,this.peekChar(_)===c&&this.extract(_,this.consume,c)}for(;;){const b=this.extract(_,this.consumeToken);switch(b){case"depend":{const K={type:b,rids:this.extract(_,this.consume,"=").split(",")};v.params.push(K);break}default:{const K={type:b};this.peekChar(_)==="="&&(this.extract(_,this.consume,"="),K.val=this.extract(_,this.consumeTill,";")),v.params.push(K)}}try{this.extract(_,this.consume,";")}catch{break}}}this.attributes.rids.push(v)}parseSimulcast(_){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=_.attValue,this.extract(_,this.consumeTill)}parseSctpPort(_){this.attributes.sctpPort=this.extractOneOrMore(_,l,[1,5])}parseMaxMessageSize(_){this.attributes.maxMessageSize=this.extractOneOrMore(_,l,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(_){this.attributes.mid=this.extract(_,this.consumeToken)}parseSSRCGroup(_){const R=this.extract(_,this.consumeToken),v=[];for(;;)try{this.consumeAttributeSpace(_);const b=this.extract(_,this.consumeInteger);v.push(parseInt(b,10))}catch{break}this.attributes.ssrcGroups.push({semantic:R,ssrcIds:v})}}function Be(V,_,R){return _ in V?Object.defineProperty(V,_,{value:R,enumerable:!0,configurable:!0,writable:!0}):V[_]=R,V}class ot{constructor(){Be(this,"eol",a)}print(_,R){let v="";return R&&(this.eol=R),v+=this.printVersion(_.version),v+=this.printOrigin(_.origin),v+=this.printSessionName(_.sessionName),v+=this.printInformation(_.information),v+=this.printUri(_.uri),v+=this.printEmail(_.emails),v+=this.printPhone(_.phones),v+=this.printConnection(_.connection),v+=this.printBandwidth(_.bandwidths),v+=this.printTimeFields(_.timeFields),v+=this.printKey(_.key),v+=this.printSessionAttributes(_.attributes),v+=this.printMediaDescription(_.mediaDescriptions),v}printVersion(_){return"v=".concat(_).concat(this.eol)}printOrigin(_){return"o=".concat(_.username," ").concat(_.sessId," ").concat(_.sessVersion," ").concat(_.nettype," ").concat(_.addrtype," ").concat(_.unicastAddress).concat(this.eol)}printSessionName(_){return _?"s=".concat(_).concat(this.eol):""}printInformation(_){return _?"i=".concat(_).concat(this.eol):""}printUri(_){return _?"u=".concat(_).concat(this.eol):""}printEmail(_){let R="";for(const v of _)R+="e=".concat(v).concat(this.eol);return R}printPhone(_){let R="";for(const v of _)R+="e=".concat(v).concat(this.eol);return R}printConnection(_){return _?"c=".concat(_.nettype," ").concat(_.addrtype," ").concat(_.address).concat(this.eol):""}printBandwidth(_){let R="";for(const v of _)R+="b=".concat(v.bwtype,":").concat(v.bandwidth).concat(this.eol);return R}printTimeFields(_){let R="";for(const v of _){R+="t=".concat(v.time.startTime," ").concat(v.time.startTime).concat(this.eol);for(const b of v.repeats)R+="r=".concat(b.repeatInterval," ").concat(b.typedTimes.join(" ")).concat(this.eol);v.zoneAdjustments&&(R+="z=",R+="z=".concat(v.zoneAdjustments.map(b=>"".concat(b.time," ").concat(b.back?"-":""," ").concat(b.typedTime)).join(" ")).concat(this.eol),R+=this.eol)}return R}printKey(_){return _?"k=".concat(_).concat(this.eol):""}printAttributes(_){let R="";for(const v of _)R+="a=".concat(v.attField).concat(v.attValue?":".concat(v.attValue):"").concat(this.eol);return R}printMediaDescription(_){let R="";for(const v of _)R+=this.printMedia(v.media),R+=this.printInformation(v.information),R+=this.printConnections(v.connections),R+=this.printBandwidth(v.bandwidths),R+=this.printKey(v.key),R+=this.printMediaAttributes(v);return R}printConnections(_){let R="";for(const v of _)R+=this.printConnection(v);return R}printMedia(_){return"m=".concat(_.mediaType," ").concat(_.port," ").concat(_.protos.join("/")," ").concat(_.fmts.join(" ")).concat(this.eol)}printSessionAttributes(_){return new Lt(this.eol).print(_)}printMediaAttributes(_){return new mt(this.eol).print(_)}}class vt{constructor(_){Be(this,"eol",void 0),this.eol=_}printIceUfrag(_){return _===void 0?"":"a=ice-ufrag:".concat(_).concat(this.eol)}printIcePwd(_){return _===void 0?"":"a=ice-pwd:".concat(_).concat(this.eol)}printIceOptions(_){return _===void 0?"":"a=ice-options:".concat(_.join(c)).concat(this.eol)}printFingerprints(_){return _.length>0?_.map(R=>"a=fingerprint:".concat(R.hashFunction).concat(c).concat(R.fingerprint)).join(this.eol)+this.eol:""}printExtmap(_){return _.map(R=>"a=extmap:".concat(R.entry).concat(R.direction?"/".concat(R.direction):"").concat(c).concat(R.extensionName).concat(R.extensionAttributes?"".concat(c).concat(R.extensionAttributes):"").concat(this.eol)).join("")}printSetup(_){return _===void 0?"":"a=setup:".concat(_).concat(this.eol)}printUnrecognized(_){return _.map(R=>"a=".concat(R.attField).concat(R.attValue?":".concat(R.attValue):"").concat(this.eol)).join("")}}class Lt extends vt{print(_){let R="";return R+=this.printGroups(_.groups),R+=this.printMsidSemantic(_.msidSemantic),R+=this.printIceLite(_.iceLite),R+=this.printIceUfrag(_.iceUfrag),R+=this.printIcePwd(_.icePwd),R+=this.printIceOptions(_.iceOptions),R+=this.printFingerprints(_.fingerprints),R+=this.printSetup(_.setup),R+=this.printTlsId(_.tlsId),R+=this.printIdentity(_.identities),R+=this.printExtmap(_.extmaps),R+=this.printUnrecognized(_.unrecognized),R}printGroups(_){let R="";return _.length>0&&(R+=_.map(v=>"a=group:".concat(v.semantic).concat(v.identificationTag.map(b=>"".concat(c).concat(b)).join("")).concat(this.eol)).join("")),R}printIceLite(_){return _===void 0?"":"a=ice-lite"+this.eol}printTlsId(_){return _?"a=tls-id:".concat(_).concat(this.eol):""}printIdentity(_){return _.length===0?"":_.map(R=>"a=identity:".concat(R.assertionValue).concat(R.extensions.map(v=>"".concat(c).concat(v.name).concat(v.value?"=".concat(v.value):"")))).join(this.eol)+this.eol}printMsidSemantic(_){if(!_)return"";let R="a=msid-semantic:".concat(_.semantic);return _.applyForAll?R+="".concat(c,"*"):_.identifierList.length>0&&(R+=_.identifierList.map(v=>"".concat(c).concat(v))),R+this.eol}}class mt extends vt{print(_){const R=_.attributes;let v="";return v+=this.printRTCP(R.rtcp),v+=this.printIceUfrag(R.iceUfrag),v+=this.printIcePwd(R.icePwd),v+=this.printIceOptions(R.iceOptions),v+=this.printCandidates(R.candidates),v+=this.printRemoteCandidatesList(R.remoteCandidatesList),v+=this.printEndOfCandidates(R.endOfCandidates),v+=this.printFingerprints(R.fingerprints),v+=this.printSetup(R.setup),v+=this.printMid(R.mid),v+=this.printExtmap(R.extmaps),v+=this.printRTPRelated(R),v+=this.printPtime(R.ptime),v+=this.printMaxPtime(R.maxPtime),v+=this.printDirection(R.direction),v+=this.printSSRCGroups(R.ssrcGroups),v+=this.printSSRC(R.ssrcs),v+=this.printRTCPMux(R.rtcpMux),v+=this.printRTCPMuxOnly(R.rtcpMuxOnly),v+=this.printRTCPRsize(R.rtcpRsize),v+=this.printMSId(R.msids),v+=this.printImageattr(R.imageattr),v+=this.printRid(R.rids),v+=this.printSimulcast(R.simulcast),v+=this.printSCTPPort(R.sctpPort),v+=this.printMaxMessageSize(R.maxMessageSize),v+=this.printUnrecognized(R.unrecognized),v}printCandidates(_){return _.map(R=>"a=candidate:".concat(R.foundation).concat(c).concat(R.componentId).concat(c).concat(R.transport).concat(c).concat(R.priority).concat(c).concat(R.connectionAddress).concat(c).concat(R.port).concat(c,"typ").concat(c).concat(R.type).concat(R.relAddr?"".concat(c,"raddr").concat(c).concat(R.relAddr):"").concat(R.relPort?"".concat(c,"rport").concat(c).concat(R.relPort):"").concat(Object.keys(R.extension).map(v=>"".concat(c).concat(v).concat(c).concat(R.extension[v])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(_){return _.map(R=>"a=remote-candidates:".concat(R.join(c)).concat(this.eol)).join("")}printEndOfCandidates(_){return _===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(_){if(!_.payloads)return"";const R=_.payloads;let v="";v+=_.rtcpFeedbackWildcards.map(b=>this.printRTCPFeedback("*",b)).join("");for(const b of R)v+=this.printRtpMap(b.payloadType,b.rtpMap),v+=this.printFmtp(b.payloadType,b.fmtp),v+=b.rtcpFeedbacks.map(K=>this.printRTCPFeedback(b.payloadType,K)).join("");return v}printFmtp(_,R){if(!R)return"";const v=Object.keys(R.parameters);return v.length===1&&R.parameters[v[0]]===null?"a=fmtp:".concat(_).concat(c).concat(v[0]).concat(this.eol):"a=fmtp:".concat(_).concat(c).concat(Object.keys(R.parameters).map(b=>"".concat(b,"=").concat(R.parameters[b])).join(";")).concat(this.eol)}printRtpMap(_,R){return R?"a=rtpmap:".concat(_).concat(c).concat(R.encodingName,"/").concat(R.clockRate).concat(R.encodingParameters?"/".concat(R.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(_,R){let v="a=rtcp-fb:".concat(_).concat(c),b=R;return b.type==="trr-int"?v+="ttr-int".concat(c).concat(b.interval):(v+="".concat(b.type),b.parameter&&(v+="".concat(c).concat(b.parameter),b.additional&&(v+="".concat(c).concat(b.additional)))),v+this.eol}printPtime(_){return _===void 0?"":"a=ptime:".concat(_).concat(this.eol)}printMaxPtime(_){return _===void 0?"":"a=maxptime:".concat(_).concat(this.eol)}printDirection(_){return _===void 0?"":"a=".concat(_).concat(this.eol)}printSSRC(_){return _.map(R=>Object.keys(R.attributes).map(v=>"a=ssrc:".concat(R.ssrcId.toString(10)).concat(c).concat(v).concat(R.attributes[v]?":".concat(R.attributes[v]):"").concat(this.eol)).join("")).join("")}printRTCPMux(_){return _===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(_){return _===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(_){return _===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(_){if(_===void 0)return"";let R="a=rtcp:".concat(_.port);return _.netType&&(R+="".concat(c).concat(_.netType)),_.addressType&&(R+="".concat(c).concat(_.addressType)),_.address&&(R+="".concat(c).concat(_.address)),R+this.eol}printMSId(_){return _.map(R=>"a=msid:".concat(R.id).concat(R.appdata?"".concat(c).concat(R.appdata):"").concat(this.eol)).join("")}printImageattr(_){return _.map(R=>"a=imageattr:".concat(R).concat(this.eol)).join("")}printRid(_){return _.map(R=>{let v="a=rid:".concat(R.id).concat(c).concat(R.direction);return R.payloads&&(v+="".concat(c,"pt=").concat(R.payloads.join(","))),R.params.length>0&&(v+="".concat(c).concat(R.params.map(b=>b.type==="depend"?"depend=".concat(b.rids.join(",")):"".concat(b.type,"=").concat(b.val)).join(";"))),v+this.eol}).join("")}printSimulcast(_){return _===void 0?"":"a=simulcast:".concat(_).concat(this.eol)}printSCTPPort(_){return _===void 0?"":"a=sctp-port:".concat(_).concat(this.eol)}printMaxMessageSize(_){return _===void 0?"":"a=max-message-size:".concat(_).concat(this.eol)}printMid(_){return _===void 0?"":"a=mid:".concat(_).concat(this.eol)}printSSRCGroups(_){return _.map(R=>"a=ssrc-group:".concat(R.semantic).concat(R.ssrcIds.map(v=>"".concat(c).concat(v.toString(10))).join("")).concat(this.eol)).join("")}}function te(V){return new x().parse(V)}function le(V,_){return new ot().print(V,_)}}},t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}return n.d=(i,r)=>{for(var o in r)n.o(r,o)&&!n.o(i,o)&&Object.defineProperty(i,o,{enumerable:!0,get:r[o]})},n.o=(i,r)=>Object.prototype.hasOwnProperty.call(i,r),n.r=i=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(i,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(i,"__esModule",{value:!0})},n(8)})();function Di(e){if(Array.isArray(e))return e.map(n=>n);if(!BR(e))return e;const t={};for(const n in e){const i=e[n];BR(i)||Array.isArray(i)?t[n]=Di(i):t[n]=i}return t}function BR(e){return!(typeof e!="object"||Array.isArray(e)||!e)}class Vp{constructor(t){this.input=[],this.size=void 0,this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}}const Ar={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Td={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:Ar,remoteCandidate:Ar}},dw={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0},lw={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},uw={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},hw={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0};class em{constructor(t,n){this.onFirstVideoReceived=void 0,this.onFirstVideoDecoded=void 0,this.onFirstAudioReceived=void 0,this.onFirstVideoDecodedTimeout=void 0,this.onFirstAudioDecoded=void 0,this.onSelectedLocalCandidateChanged=void 0,this.onSelectedRemoteCandidateChanged=void 0,this.videoIsReady=!1,this.videoIsReady2={},this.pc=void 0,this.options=void 0,this.intervalTimer=void 0,this.stats=Di(Td),this.isFirstVideoReceived={},this.isFirstVideoDecoded={},this.isFirstAudioReceived={},this.isFirstAudioDecoded={},this.isFirstVideoDecodedTimeout={},this.lossRateWindowStats=[],this.pc=t,this.options=n,this.intervalTimer=window.setInterval(async()=>{this.updateStats()},this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Promise(t=>{t({local:F({},Ar),remote:F({},Ar)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,n){this.videoIsReady2[t]=n}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);const n=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"];let r=0,o=0,s=0,a=0;for(const c of i)t[c].forEach((d,l)=>{if(!this.lossRateWindowStats[n-1][c][l]||!this.lossRateWindowStats[0][c][l])return;const u=this.lossRateWindowStats[n-1][c][l].packets-this.lossRateWindowStats[0][c][l].packets,h=this.lossRateWindowStats[n-1][c][l].packetsLost-this.lossRateWindowStats[0][c][l].packetsLost;c==="videoSend"||c==="audioSend"?(r+=u,s+=h):(o+=u,a+=h),Number.isNaN(u)||Number.isNaN(u)?d.packetLostRate=0:d.packetLostRate=u<=0||h<=0?0:h/(u+h)});t.sendPacketLossRate=r<=0||s<=0?0:s/(r+s),t.recvPacketLossRate=o<=0||a<=0?0:a/(o+a)}}class UM extends em{constructor(){super(...arguments),this._stats=Td,this.lastDecodeVideoReceiverStats=new Map}async updateStats(){const t=await this._getStats(),n=this.statsResponsesToObjects(t);this._stats=Di(Td);const i=n.filter(o=>o.type==="ssrc");this.processSSRCStats(i);const r=n.find(o=>o.type==="VideoBwe");r&&this.processBandwidthStats(r),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(n=>{const i=n.id.includes("send");switch("".concat(n.mediaType,"_").concat(i?"send":"recv")){case"video_send":{const r=Di(lw);r.codec=n.googCodecName,r.adaptionChangeReason="none",n.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),n.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(n.googAvgEncodeMs),r.inputFrame={width:Number(n.googFrameWidthInput)||Number(n.googFrameWidthSent),height:Number(n.googFrameHeightInput)||Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},r.sentFrame={width:Number(n.googFrameWidthSent),height:Number(n.googFrameHeightSent),frameRate:Number(n.googFrameRateInput)},r.firsCount=Number(n.googFirReceived),r.nacksCount=Number(n.googNacksReceived),r.plisCount=Number(n.googPlisReceived),r.frameCount=Number(n.framesEncoded),r.bytes=Number(n.bytesSent),r.packets=Number(n.packetsSent),r.packetsLost=Number(n.packetsLost),r.ssrc=Number(n.ssrc),r.rttMs=Number(n.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{const r=Di(dw),o=this.lastDecodeVideoReceiverStats.get(Number(n.ssrc));if(r.codec=n.googCodecName,r.targetDelayMs=Number(n.googTargetDelayMs),r.renderDelayMs=Number(n.googRenderDelayMs),r.currentDelayMs=Number(n.googCurrentDelayMs),r.minPlayoutDelayMs=Number(n.googMinPlayoutDelayMs),r.decodeMs=Number(n.googDecodeMs),r.maxDecodeMs=Number(n.googMaxDecodeMs),r.receivedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateReceived)},r.decodedFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateDecoded)},r.decodeFrameRate=Number(n.googFrameRateDecoded),r.outputFrame={width:Number(n.googFrameWidthReceived),height:Number(n.googFrameHeightReceived),frameRate:Number(n.googFrameRateOutput)},r.jitterBufferMs=Number(n.googJitterBufferMs),r.firsCount=Number(n.googFirsSent),r.nacksCount=Number(n.googNacksSent),r.plisCount=Number(n.googPlisSent),r.framesDecodeCount=Number(n.framesDecoded),r.bytes=Number(n.bytesReceived),r.packets=Number(n.packetsReceived),r.packetsLost=Number(n.packetsLost),r.ssrc=Number(n.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),o){const s=o.stats,a=Date.now()-o.lts;r.framesDecodeFreezeTime=s.framesDecodeFreezeTime,r.framesDecodeInterval=s.framesDecodeInterval,r.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(o.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(n.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(n.ssrc,10),!0))):r.framesDecodeCount<o.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:F({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{const r=Di(hw);r.codec=n.googCodecName,r.outputLevel=Math.abs(Number(n.audioOutputLevel))/32767,r.decodingCNG=Number(n.googDecodingCNG),r.decodingCTN=Number(n.googDecodingCTN),r.decodingCTSG=Number(n.googDecodingCTSG),r.decodingNormal=Number(n.googDecodingNormal),r.decodingPLC=Number(n.googDecodingPLC),r.decodingPLCCNG=Number(n.googDecodingPLCCNG),r.expandRate=Number(n.googExpandRate),r.accelerateRate=Number(n.googAccelerateRate),r.preemptiveExpandRate=Number(n.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(n.googSecondaryDecodedRate),r.speechExpandRate=Number(n.googSpeechExpandRate),r.preferredJitterBufferMs=Number(n.googPreferredJitterBufferMs),r.jitterBufferMs=Number(n.googJitterBufferMs),r.jitterMs=Number(n.googJitterReceived),r.bytes=Number(n.bytesReceived),r.packets=Number(n.packetsReceived),r.packetsLost=Number(n.packetsLost),r.ssrc=Number(n.ssrc),r.receivedFrames=Number(n.googDecodingCTN)||Number(n.packetsReceived),r.droppedFrames=Number(n.googDecodingPLC)+Number(n.googDecodingPLCCNG)||Number(n.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{const r=Di(uw);r.codec=n.googCodecName,r.inputLevel=Math.abs(Number(n.audioInputLevel))/32767,r.aecReturnLoss=Number(n.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(n.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(n.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(n.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(n.bytesSent),r.packets=Number(n.packetsSent),r.packetsLost=Number(n.packetsLost),r.ssrc=Number(n.ssrc),r.rttMs=Number(n.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}})}_getStats(){return new Promise((t,n)=>{this.pc.getStats(t,n)})}statsResponsesToObjects(t){const n=[];return t.result().forEach(i=>{const r={id:i.id,timestamp:i.timestamp.valueOf().toString(),type:i.type};i.names().forEach(o=>{r[o]=i.stat(o)}),n.push(r)}),n}}class GR extends em{constructor(){super(...arguments),this._stats=Td,this.report=void 0,this.lastDecodeVideoReceiverStats=new Map,this.lastVideoFramesRecv=new Map,this.lastVideoFramesSent=new Map,this.lastVideoFramesDecode=new Map,this.lastVideoFramesOutput=new Map,this.lastVideoJBDelay=new Map,this.lastAudioJBDelay=new Map,this.mediaBytesSent=new Map,this.mediaBytesRetransmit=new Map,this.mediaBytesTargetEncode=new Map,this.lastEncoderMs=new Map}async updateStats(){this.report=await this.pc.getStats(),this._stats=Di(Td),this.report.forEach(t=>{switch(t.type){case $n.OUTBOUND:case $n.INBOUND:{const n=t.mediaType||t.kind,i=!n&&"frameWidth"in t,r=!n&&!("frameWidth"in t);t.type===$n.OUTBOUND?n==="audio"||r?this.processAudioOutboundStats(t):(n==="video"||i)&&this.processVideoOutboundStats(t):t.type===$n.INBOUND&&(n==="audio"||r?this.processAudioInboundStats(t):(n==="video"||i)&&this.processVideoInboundStats(t));break}case $n.TRANSPORT:{const n=this.report.get(t.selectedCandidatePairId);n&&this.processCandidatePairStats(n);break}case $n.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats}async getSelectedCandidatePair(){const t=await this.pc.getStats(),n={local:F({},Ar),remote:F({},Ar)};return t.forEach(i=>{let r;if(i.type===$n.TRANSPORT&&(r=t.get(i.selectedCandidatePairId)),i.type===$n.CANDIDATE_PAIR&&i.selected&&(r=i),r){const o=(s,a)=>{s.type=a.type,s.id=a.id,a.address&&(s.address=a.address),a.candidateType&&(s.candidateType=a.candidateType),a.port&&(s.port=a.port),a.priority&&(s.priority=a.priority),a.protocol&&(s.protocol=a.protocol),a.relayProtocol&&(s.relayProtocol=a.relayProtocol)};if(r.localCandidateId){const s=t.get(r.localCandidateId);s&&o(n.local,s)}if(r.remoteCandidateId){const s=t.get(r.remoteCandidateId);s&&o(n.remote,s)}}}),n}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(n=>{t.currentRoundTripTime&&(n.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(n=>{t.currentRoundTripTime&&(n.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){const n=this.report.get(t.localCandidateId);n&&this.processCandidateStats(n)}if(t.remoteCandidateId){const n=this.report.get(t.remoteCandidateId);n&&this.processCandidateStats(n)}}processCandidateStats(t){let n;t.type===$n.LOCAL_CANDIDATE&&(n=this._stats.selectedCandidatePair.localCandidate),t.type===$n.REMOTE_CANDIDATE&&(n=this._stats.selectedCandidatePair.remoteCandidate),n&&(n.type=t.type,n.id=t.id,t.address&&(n.address=t.address),t.candidateType&&(n.candidateType=t.candidateType),t.port&&(n.port=t.port),t.priority&&(n.priority=t.priority),t.protocol&&(n.protocol=t.protocol),t.relayProtocol&&(n.relayProtocol=t.relayProtocol),t.type===$n.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==n.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(F({},n),F({},this.stats.selectedCandidatePair.localCandidate)),t.type===$n.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==n.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(F({},n),F({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let n=this._stats.audioRecv.find(i=>i.ssrc===t.ssrc);n||(n=Di(hw),this._stats.audioRecv.push(n)),n.ssrc=t.ssrc,n.packets=t.packetsReceived,n.packetsLost=t.packetsLost,n.bytes=t.bytesReceived,n.jitterMs=1e3*t.jitter,this.processAudioTrackReceiverStats(t,t.trackId,n),t.codecId&&(n.codec=this.getCodecFromCodecStats(t.codecId)),n.receivedFrames||(n.receivedFrames=t.packetsReceived),n.droppedFrames||(n.droppedFrames=t.packetsLost),n.receivedFrames>0&&!this.isFirstAudioReceived[n.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(n.ssrc),this.isFirstAudioReceived[n.ssrc]=!0),n.outputLevel&&n.outputLevel>0&&!this.isFirstAudioDecoded[n.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(n.ssrc),this.isFirstAudioDecoded[n.ssrc]=!0),typeof t.concealedSamples=="number"&&(n.concealedSamples=t.concealedSamples)}processVideoInboundStats(t){let n=this._stats.videoRecv.find(a=>a.ssrc===t.ssrc);n||(n=Di(dw),this._stats.videoRecv.push(n)),n.ssrc=t.ssrc,n.packets=t.packetsReceived,n.packetsLost=t.packetsLost,n.bytes=t.bytesReceived,n.firsCount=t.firCount,n.nacksCount=t.nackCount,n.plisCount=t.pliCount,n.framesDecodeCount=t.framesDecoded,n.framesDroppedCount=t.framesDropped,n.totalInterFrameDelay=t.totalInterFrameDelay,n.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay,n.totalFreezesDuration=t.totalFreezesDuration;const i=this.lastDecodeVideoReceiverStats.get(n.ssrc),r=this.lastVideoFramesDecode.get(n.ssrc),o=this.lastVideoFramesOutput.get(n.ssrc),s=Date.now();if(n.framesDecodeCount>0&&!this.isFirstVideoDecoded[n.ssrc]){const a=n.decodedFrame?n.decodedFrame.width:0,c=n.decodedFrame?n.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(n.ssrc,a,c),this.isFirstVideoDecoded[n.ssrc]=!0}if(i){const a=i.stats,c=s-i.lts;n.framesDecodeFreezeTime=a.framesDecodeFreezeTime,n.framesDecodeInterval=a.framesDecodeInterval,!this.isFirstVideoDecoded[n.ssrc]&&c>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[n.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(n.ssrc),this.isFirstVideoDecodedTimeout[n.ssrc]=!0),n.framesDecodeCount>a.framesDecodeCount&&this.isFirstVideoDecoded[n.ssrc]?(i.lts=Date.now(),n.framesDecodeInterval=c,n.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?n.framesDecodeFreezeTime+=n.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):n.framesDecodeCount<a.framesDecodeCount&&(n.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(i.stats.framesDecodeCount>t.framesDecoded?n.qpSumPerFrame=t.qpSum/t.framesDecoded:n.qpSumPerFrame=(t.qpSum-i.qpSum)/(t.framesDecoded-i.stats.framesDecodeCount))}r&&s-r.lts>=800?(n.decodeFrameRate=Math.round((n.framesDecodeCount-r.count)/((s-r.lts)/1e3)),this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:s,rate:n.decodeFrameRate})):r?n.decodeFrameRate=r.rate:this.lastVideoFramesDecode.set(n.ssrc,{count:n.framesDecodeCount,lts:s,rate:0}),n.framesDroppedCount&&t.framesReceived&&(o&&s-o.lts>=800?(n.outputFrameRate=Math.round((t.framesReceived-n.framesDroppedCount-o.count)/((s-o.lts)/1e3)),this.lastVideoFramesOutput.set(n.ssrc,{count:t.framesReceived-n.framesDroppedCount,lts:s,rate:Math.max(n.outputFrameRate,0)})):o?n.outputFrameRate=o.rate:this.lastVideoFramesOutput.set(n.ssrc,{count:t.framesReceived-n.framesDroppedCount,lts:s,rate:0})),t.totalDecodeTime&&(n.decodeMs=1e3*t.totalDecodeTime),this.processVideoTrackReceiverStats(t,t.trackId,n),t.codecId&&(n.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(n.framesRateFirefox=t.framerateMean),n.packets>0&&!this.isFirstVideoReceived[n.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(n.ssrc),this.isFirstVideoReceived[n.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(n.ssrc,{stats:F({},n),lts:i?i.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let n=this._stats.videoSend.find(r=>r.ssrc===t.ssrc);n||(n=Di(lw),this._stats.videoSend.push(n));const i=this.mediaBytesSent.get(t.ssrc);if(i)i.add(t.bytesSent);else{const r=new Vp(10);r.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,r)}if(t.retransmittedBytesSent!==void 0){const r=this.mediaBytesRetransmit.get(t.ssrc);if(r)r.add(t.retransmittedBytesSent);else{const o=new Vp(10);o.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,o)}}if(t.totalEncodedBytesTarget){const r=this.mediaBytesTargetEncode.get(t.ssrc);if(r)r.add(t.totalEncodedBytesTarget);else{const o=new Vp(10);o.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,o)}}if(n.ssrc=t.ssrc,n.bytes=t.bytesSent,n.packets=t.packetsSent,n.firsCount=t.firCount,n.nacksCount=t.nackCount,n.plisCount=t.pliCount,n.frameCount=t.framesEncoded,n.adaptionChangeReason=t.qualityLimitationReason,n.scalabilityMode=t.scalabilityMode,t.totalEncodeTime&&t.framesEncoded){const r=this.lastEncoderMs.get(t.ssrc);if(!r||r.lastFrameCount>t.framesEncoded)n.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{const o=t.framesEncoded-r.lastFrameCount,s=t.totalEncodeTime-r.lastEncoderTime;n.avgEncodeMs=1e3*s/o}}if(t.framesEncoded&&t.qpSum){const r=this.lastEncoderMs.get(t.ssrc);!r||r.lastFrameCount>t.framesEncoded?n.qpSumPerFrame=t.qpSum/t.framesEncoded:n.qpSumPerFrame=(t.qpSum-r.lastQpSum)/(t.framesEncoded-r.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(n.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,n),this.processVideoTrackSenderStats(t,t.trackId,n),t.remoteId)this.processRemoteInboundStats(t.remoteId,n);else{const r=this.findRemoteStatsId(t.ssrc,$n.REMOTE_INBOUND);r&&this.processRemoteInboundStats(r,n)}}processAudioOutboundStats(t){let n=this._stats.audioSend.find(i=>i.ssrc===t.ssrc);if(n||(n=Di(uw),this._stats.audioSend.push(n)),n.ssrc=t.ssrc,n.packets=t.packetsSent,n.bytes=t.bytesSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,n),t.codecId&&(n.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,n),t.remoteId)this.processRemoteInboundStats(t.remoteId,n);else{const i=this.findRemoteStatsId(t.ssrc,$n.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,n)}}findRemoteStatsId(t,n){const i=Array.from(this.report.values()).find(r=>r.type===n&&r.ssrc===t);return i?i.id:null}processVideoMediaSource(t,n){const i=this.report.get(t);i&&i.width&&i.height&&i.framesPerSecond&&(n.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(t,n){const i=this.report.get(t);i&&(n.inputLevel=i.audioLevel)}processVideoTrackSenderStats(t,n,i){var r,o,s,a;const c=n?this.report.get(n):void 0,d=(r=c==null?void 0:c.framesSent)!==null&&r!==void 0?r:t.framesSent;if(typeof d!="number")return;let l=(o=c==null?void 0:c.frameWidth)!==null&&o!==void 0?o:t.frameWidth,u=(s=c==null?void 0:c.frameHeight)!==null&&s!==void 0?s:t.frameHeight,h=(a=c==null?void 0:c.framesPerSecond)!==null&&a!==void 0?a:t.framesPerSecond;if(typeof l=="number"&&typeof u=="number"||(l=0,u=0),h==null){const p=Date.now(),m=this.lastVideoFramesSent.get(i.ssrc);m&&p-m.lts>=800?(h=Math.round((d-m.count)/((p-m.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:p,rate:h})):m?h=m.rate:this.lastVideoFramesSent.set(i.ssrc,{count:d,lts:p,rate:0})}i.sentFrame={width:l,height:u,frameRate:Math.max(0,h)}}processVideoTrackReceiverStats(t,n,i){var r,o,s,a,c;const d=n?this.report.get(n):void 0,l=(r=d==null?void 0:d.framesReceived)!==null&&r!==void 0?r:t.framesReceived,u=(o=d==null?void 0:d.frameWidth)!==null&&o!==void 0?o:t.frameWidth,h=(s=d==null?void 0:d.frameHeight)!==null&&s!==void 0?s:t.frameHeight,p=(a=d==null?void 0:d.jitterBufferDelay)!==null&&a!==void 0?a:t.jitterBufferDelay,m=(c=d==null?void 0:d.jitterBufferEmittedCount)!==null&&c!==void 0?c:t.jitterBufferEmittedCount;if(typeof l=="number"){const E=this.lastVideoFramesRecv.get(i.ssrc),g=Date.now();i.framesReceivedCount=l;let S=0;E&&g-E.lts>=800?(S=Math.round((l-E.count)/((g-E.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:l,lts:g,rate:S})):E?S=E.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:l,lts:g,rate:0}),i.receivedFrame={width:u||0,height:h||0,frameRate:S||0},i.decodedFrame={width:u||0,height:h||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:u||0,height:h||0,frameRate:i.outputFrameRate||i.decodeFrameRate||0}}if(p&&m){const E=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let g=E.jitterBufferMs;const S=m-E.jitterBufferEmittedCount;S>0&&(g=1e3*(p-E.jitterBufferDelay)/S),i.jitterBufferMs=g,i.currentDelayMs=Math.round(g),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:p,jitterBufferEmittedCount:m,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(t,n,i){var r,o,s,a;const c=n?this.report.get(n):void 0,d=(r=(o=c==null?void 0:c.echoReturnLoss)!==null&&o!==void 0?o:t.echoReturnLoss)!==null&&r!==void 0?r:0,l=(s=(a=c==null?void 0:c.echoReturnLossEnhancement)!==null&&a!==void 0?a:t.echoReturnLossEnhancement)!==null&&s!==void 0?s:0;i.aecReturnLoss=d,i.aecReturnLossEnhancement=l}processAudioTrackReceiverStats(t,n,i){var r,o,s,a,c,d,l;const u=n?this.report.get(n):void 0,h=(r=u==null?void 0:u.removedSamplesForAcceleration)!==null&&r!==void 0?r:t.removedSamplesForAcceleration,p=(o=u==null?void 0:u.totalSamplesReceived)!==null&&o!==void 0?o:t.totalSamplesReceived,m=(s=u==null?void 0:u.jitterBufferDelay)!==null&&s!==void 0?s:t.jitterBufferDelay,E=(a=u==null?void 0:u.jitterBufferEmittedCount)!==null&&a!==void 0?a:t.jitterBufferEmittedCount,g=(c=u==null?void 0:u.audioLevel)!==null&&c!==void 0?c:t==null?void 0:t.audioLevel,S=(d=u==null?void 0:u.totalSamplesDuration)!==null&&d!==void 0?d:t==null?void 0:t.totalSamplesDuration,T=(l=u==null?void 0:u.concealedSamples)!==null&&l!==void 0?l:t.concealedSamples;if(h&&p&&(i.accelerateRate=h/p),m&&E){const y=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0};let w=y.jitterBufferMs;const D=E-y.jitterBufferEmittedCount;D>0&&(w=1e3*(m-y.jitterBufferDelay)/D),i.jitterBufferMs=Math.round(w),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:m,jitterBufferEmittedCount:E,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=g;let I=1920;S&&p&&(I=p/S/50,i.receivedFrames=Math.round(p/I)),T&&(i.droppedFrames=Math.round(T/I))}processRemoteInboundStats(t,n){const i=this.report.get(t);i&&(n.packetsLost=i.packetsLost,i.roundTripTime&&(n.rttMs=1e3*i.roundTripTime),i.jitter&&(n.jitterMs=1e3*i.jitter),i.timestamp&&(n.timestamp=i.timestamp))}getCodecFromCodecStats(t){const n=this.report.get(t);if(!n)return"";const i=n.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let t=0,n=null,i=null;this.mediaBytesSent.forEach(o=>{t+=o.diffMean()}),this.mediaBytesRetransmit.forEach(o=>{n=n===null?o.diffMean():n+o.diffMean()}),this.mediaBytesTargetEncode.forEach(o=>{i=i===null?o.diffMean():i+o.diffMean()});const r=n!==null?t-n:t;this._stats.bitrate={actualEncoded:8*r/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},n!==null&&(this._stats.bitrate.retransmit=8*n/(this.options.updateInterval/1e3)),i!==null&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}}class xM extends em{updateStats(){return Promise.resolve()}}function vh(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4;const o=function(){const s=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return s&&s[0]?Number(s[0].split("/")[1]):null}();return o?o<76?new UM(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new GR(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):function(s){return!!window.RTCStatsReport&&s.getStats()instanceof Promise}(e)?new GR(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r}):new xM(e,{updateInterval:t,lossRateInterval:n,freezeRateLimit:i,firstVideoDecodedTimeout:r})}function Rd(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},i=arguments.length>3?arguments[3]:void 0;const{filterRTX:r,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c}=t,{useXR:d}=n;let l=[],u=[],h=[],p=[],m=!1,E=!1;if($e.parse(e).mediaDescriptions.forEach(S=>{i&&i!==S.attributes.direction||(S.media.mediaType!=="video"||m||(u=S.attributes.payloads,p=S.attributes.extmaps,m=!0),S.media.mediaType!=="audio"||E||(l=S.attributes.payloads,h=S.attributes.extmaps,E=!0))}),!p||u.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!h||l.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(u.forEach(S=>{var T;(T=S.rtpMap)!==null&&T!==void 0&&T.clockRate&&(S.rtpMap.clockRate=parseInt(S.rtpMap.clockRate)),d&&S.rtcpFeedbacks.push({type:"rrtr"})}),l.forEach(S=>{var T;(T=S.rtpMap)!==null&&T!==void 0&&T.clockRate&&(S.rtpMap.clockRate=parseInt(S.rtpMap.clockRate)),d&&S.rtcpFeedbacks.push({type:"rrtr"})}),r&&(l=l.filter(S=>{var T;return((T=S.rtpMap)===null||T===void 0?void 0:T.encodingName.toLowerCase())!=="rtx"}),u=u.filter(S=>{var T;return((T=S.rtpMap)===null||T===void 0?void 0:T.encodingName.toLowerCase())!=="rtx"})),o&&(u=u.filter(S=>{var T;return!/(red)|(ulpfec)|(flexfec)/i.test(((T=S.rtpMap)===null||T===void 0?void 0:T.encodingName)||"")})),s&&(l=l.filter(S=>{var T;return!/(red)|(ulpfec)|(flexfec)/i.test(((T=S.rtpMap)===null||T===void 0?void 0:T.encodingName)||"")})),a&&(a==null?void 0:a.length)>0&&(l=l.filter(S=>{var T;return a.includes(((T=S.rtpMap)===null||T===void 0?void 0:T.encodingName.toLowerCase())||"")})),c&&(c==null?void 0:c.length)>0){const S=u.filter(T=>{var I;return c.includes(((I=T.rtpMap)===null||I===void 0?void 0:I.encodingName.toLowerCase())||"")});u=S.concat(r?[]:om(S,u))}const g=A("UNSUPPORTED_VIDEO_CODEC");return g&&g.length>0&&(u=u.filter(S=>!(S.rtpMap&&g.includes(S.rtpMap.encodingName.toLowerCase())))),{audioCodecs:l,videoCodecs:u,audioExtensions:h,videoExtensions:p}}function Ji(e){const t=$e.parse(e);let n,i;for(const r of t.mediaDescriptions){if(!n){const o=r.attributes.iceUfrag,s=r.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");n={iceUfrag:o,icePwd:s}}if(!i){const o=r.attributes.fingerprints;o.length>0&&(i={fingerprints:o})}}if(!i&&t.attributes.fingerprints.length>0&&(i={fingerprints:t.attributes.fingerprints}),!i||!n)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:n,dtlsParameters:i}}function tm(e,t){const n=[],i=e.attributes.ssrcGroups.filter(s=>s.semantic==="FID"),r=e.attributes.ssrcGroups.find(s=>s.semantic==="SIM"),o=e.attributes.ssrcs;if(r)r.ssrcIds.forEach(s=>{var a;const c=(a=i.find(d=>d.ssrcIds[0]===s))===null||a===void 0?void 0:a.ssrcIds[1];n.push({ssrcId:s,rtx:t?c:void 0})});else if(i.length>0){const s=i[0].ssrcIds[0],a=i[0].ssrcIds[1];n.push({ssrcId:s,rtx:t?a:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");n.push({ssrcId:o[0].ssrcId})}return n}function jR(e,t){const{cname:n}=e;let i;t&&t.ip&&typeof t.port=="number"?(i=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],f.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(i.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),f.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))):i=e.iceParameters.candidates.map(a=>({foundation:a.foundation,componentId:"1",transport:a.protocol,priority:a.priority.toString(),connectionAddress:a.ip,port:a.port.toString(),type:a.type,extension:{}}));const r={fingerprints:e.dtlsParameters.fingerprints.map(a=>({hashFunction:a.algorithm,fingerprint:a.fingerprint}))},o={iceUfrag:e.iceParameters.iceUfrag,icePwd:e.iceParameters.icePwd};let s;switch(e.dtlsParameters.role){case"server":s="passive";break;case"client":s="active";break;case"auto":s="actpass"}return{dtlsParameters:r,iceParameters:o,candidates:i,rtpCapabilities:La(e.rtpCapabilities),setup:s,cname:n}}function Xn(e,t,n){const i=[],r=[];return e.forEach(o=>{let{ssrcId:s,rtx:a}=o;const c=et(8,"track-"),d={ssrcId:s,attributes:F({label:c,mslabel:n=n||et(10,""),msid:"".concat(n," ").concat(c)},t&&{cname:t})};if(i.push(d),a!==void 0){const l={ssrcId:a,attributes:F({label:c,mslabel:n,msid:"".concat(n," ").concat(c)},t&&{cname:t})};i.push(l),r.push({semantic:"FID",ssrcIds:[s,a]})}}),e.length>1&&r.push({semantic:"SIM",ssrcIds:e.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:i,ssrcGroups:r}}function Uo(e,t){t instanceof St&&e.attributes.payloads.forEach(n=>{var i;const r=(i=n.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;n.fmtp||(n.fmtp={parameters:{}}),n.fmtp.parameters.minptime="10",n.fmtp.parameters.useinbandfec="1";const o=t._encoderConfig;o&&r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(o.bitrate&&!Me()&&(n.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(n.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),n.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(n.fmtp.parameters.stereo="1",n.fmtp.parameters["sprop-stereo"]="1"))})}function Ih(e){const t=e.attributes.unrecognized.findIndex(n=>n.attField==="x-google-flag"&&n.attValue==="conference");t!==-1&&e.attributes.unrecognized.splice(t,1)}function yh(e,t){if(!(t instanceof Ge&&t._encoderConfig&&t._hints.indexOf(je.SCREEN_TRACK)===-1))return;const n=t._encoderConfig;ge().supportMinBitrate&&n.bitrateMin&&e.attributes.payloads.forEach(i=>{var r;["h264","h265","vp8","vp9","av1"].includes(((r=i.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase())||"")&&(i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))}),ge().supportMinBitrate&&!t._hints.includes(je.LOW_STREAM)&&n.bitrateMax&&e.attributes.payloads.forEach(i=>{var r;["h264","h265","vp8","vp9","av1"].includes(((r=i.rtpMap)===null||r===void 0?void 0:r.encodingName.toLowerCase())||"")&&(i.fmtp||(i.fmtp={parameters:{}}),i.fmtp.parameters["x-google-start-bitrate"]="".concat(A("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))})}function nm(e){if(e.media.mediaType!=="video")return;const t=Ie();if(t.name!==Ke.SAFARI&&t.os!==Ht.IOS)return;const n=e.attributes.extmaps.findIndex(i=>/video-orientation/g.test(i.extensionName));n!==-1&&e.attributes.extmaps.splice(n,1)}function Pa(e,t,n){if(!t)return;let i,r;if(e.media.mediaType==="video"?(i=n.videoExtensions,r=n.videoCodecs):(i=n.audioExtensions,r=n.audioCodecs),t.twcc===!0){const o=i.find(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o&&(e.attributes.extmaps.find(a=>a.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01")||e.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"}),function(a,c){return c.filter(d=>!!a.find(l=>l.payloadType===d.payloadType&&!!l.rtcpFeedbacks.find(u=>u.type==="transport-cc")))}(r,e.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="transport-cc")||a.rtcpFeedbacks.push({type:"transport-cc"})}))}else if(t.twcc===!1){const o=e.attributes.extmaps.findIndex(s=>s.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");o!==-1&&e.attributes.extmaps.splice(o,1),e.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}if(t.remb===!0){const o=i.find(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o&&(e.attributes.extmaps.find(a=>a.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time")||e.attributes.extmaps.push({entry:o.entry,extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}),function(a,c){return c.filter(d=>!!a.find(l=>l.payloadType===d.payloadType&&!!l.rtcpFeedbacks.find(u=>u.type==="goog-remb")))}(r,e.attributes.payloads).forEach(a=>{a.rtcpFeedbacks.find(c=>c.type==="goog-remb")||a.rtcpFeedbacks.push({type:"goog-remb"})}))}else if(t.remb===!1){const o=e.attributes.extmaps.findIndex(s=>s.extensionName==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time");o!==-1&&e.attributes.extmaps.splice(o,1),e.attributes.payloads.forEach(s=>{const a=s.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}}function im(e,t,n){if(Me()||e.media.mediaType!=="video"||!(t instanceof Ge)||n!=="vp9"&&n!=="vp8"||n==="vp8"&&!A("SIMULCAST")||t._scalabilityMode===void 0||t._scalabilityMode.numSpatialLayers<=1)return;const i=n==="vp8"?2:t._scalabilityMode.numSpatialLayers,r=e.attributes.ssrcs[0],o=e.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<i;a++)e.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:xe(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(e.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:xe(r.attributes)}),e.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));e.attributes.ssrcGroups.unshift(s)}async function rm(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};const n=new RTCPeerConnection;n.addTransceiver("video",{direction:"sendonly"}),n.addTransceiver("audio",{direction:"sendonly"}),n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"});const i=(await n.createOffer()).sdp,{send:r,recv:o,sendrecv:s}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0;const l=Rd(d,a,c,"sendonly"),u=Rd(d,a,c,"recvonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Li(l,u,"videoExtensions",h,p,m),Li(l,u,"videoCodecs",h,p,m),Li(l,u,"audioExtensions",h,p,m),Li(l,u,"audioCodecs",h,p,m),A("RAISE_H264_BASELINE_PRIORITY")){const E=m.videoCodecs.findIndex(g=>{var S,T;return((S=g.rtpMap)===null||S===void 0?void 0:S.encodingName.toLocaleLowerCase())==="h264"&&((T=g.fmtp)===null||T===void 0?void 0:T.parameters["profile-level-id"])==="42001f"});if(E!==-1){const g=m.videoCodecs.findIndex(S=>{var T;return((T=S.rtpMap)===null||T===void 0?void 0:T.encodingName.toLocaleLowerCase())==="h264"});if(g<E){f.debug("raising H264 baseline profile priority");const S=m.videoCodecs[E];m.videoCodecs.splice(E,1),m.videoCodecs.splice(g,0,S)}g!==-1&&(p.videoCodecs=p.videoCodecs.filter(S=>{var T,I;return!(((T=S.rtpMap)===null||T===void 0?void 0:T.encodingName.toLocaleLowerCase())==="h264"&&((I=S.fmtp)===null||I===void 0?void 0:I.parameters["profile-level-id"])!=="42001f")})),g!==-1&&A("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(S=>{var T,I;return!(((T=S.rtpMap)===null||T===void 0?void 0:T.encodingName.toLocaleLowerCase())==="h264"&&((I=S.fmtp)===null||I===void 0?void 0:I.parameters["profile-level-id"])!=="42001f")}))}}return{send:h,recv:p,sendrecv:m}}(e,t,i);try{n.close()}catch{}return{send:r,recv:o,sendrecv:s}}function WR(){const e={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},t=Rd(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Li(e,t,"videoExtensions",n,i,r),Li(e,t,"videoCodecs",n,i,r),Li(e,t,"audioExtensions",n,i,r),Li(e,t,"audioCodecs",n,i,r),A("RAISE_H264_BASELINE_PRIORITY")){const o=r.videoCodecs.findIndex(s=>s.rtpMap&&s.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&s.fmtp&&s.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){const s=r.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(s<o){f.debug("raising H264 baseline profile priority");const a=r.videoCodecs[o];r.videoCodecs.splice(o,1),r.videoCodecs.splice(s,0,a)}s!==-1&&(i.videoCodecs=i.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:n,recv:i,sendrecv:r}}function Li(e,t,n,i,r,o){if(n==="videoExtensions"||n==="audioExtensions"){const s=[];return e[n].forEach(a=>{t[n].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return s.push(d),!0})?o[n].push(a):i[n].push(a)}),void t[n].forEach((a,c)=>{s.indexOf(c)===-1&&r[n].push(a)})}if(n==="videoCodecs"||n==="audioCodecs"){const s=[];return e[n].forEach(a=>{t[n].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return s.push(d),!0})?o[n].push(a):i[n].push(a)}),void t[n].forEach((a,c)=>{s.indexOf(c)===-1&&r[n].push(a)})}}function La(e){const{send:t,recv:n,sendrecv:i}=e;if(!i){if(!t||!n)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:t,recv:n}}let r,o;return t?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...t.audioCodecs,...i.audioCodecs],r.videoCodecs=[...t.videoCodecs,...i.videoCodecs],r.audioExtensions=[...t.audioExtensions,...i.audioExtensions],r.videoExtensions=[...t.videoExtensions,...i.videoExtensions]):r=i,n?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...n.audioCodecs,...i.audioCodecs],o.videoCodecs=[...n.videoCodecs,...i.videoCodecs],o.audioExtensions=[...n.audioExtensions,...i.audioExtensions],o.videoExtensions=[...n.videoExtensions,...i.videoExtensions]):o=i,{send:r,recv:o}}function Xi(e){e.media.mediaType==="audio"&&e.attributes.payloads.filter(t=>{var n;return((n=t.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase())==="opus"}).forEach(t=>{t.fmtp||(t.fmtp={parameters:{}}),t.fmtp.parameters.stereo="1",t.fmtp.parameters["sprop-stereo"]="1"})}function Uu(e){e.mediaDescriptions.forEach(t=>{t.media.mediaType!=="video"&&t.media.mediaType!=="audio"||t.attributes.payloads.forEach(n=>{n.rtcpFeedbacks.findIndex(i=>i.type==="rrtr")===-1&&n.rtcpFeedbacks.push({type:"rrtr"})})})}function us(e,t,n,i){let r=[];if(e===z.VIDEO){if(A("H264_PROFILE_LEVEL_ID")&&i==="h264"&&(r=t.videoCodecs.filter(o=>(o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").includes(i)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===A("H264_PROFILE_LEVEL_ID"))),!Array.isArray(r)||r.length===0){let o=[];const s=[],a=[],c=[];if(n.videoCodecs.forEach(d=>{const l=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";l.includes(i)?o.push(d):l.includes("vp9")?s.push(d):l.includes("vp8")?a.push(d):l.includes("h264")&&c.push(d)}),o.length===0){let d="";s.length!==0?(o=s,d="vp9"):a.length!==0?(o=a,d="vp8"):c.length!==0&&(o=c,d="h264"),f.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}o.length!==0&&(r=t.videoCodecs.filter(d=>o.some(l=>l.payloadType===d.payloadType)))}if(r.length===0&&(f.warning("codec ".concat(i," not included in rtpCapabilities, fallback to default payloads: ").concat(t.videoCodecs[0].rtpMap&&t.videoCodecs[0].rtpMap.encodingName)),r=t.videoCodecs),A("USE_PUB_RTX")||A("USE_SUB_RTX")){const o=om(r,t.videoCodecs);r=[...r,...o]}}else r=t.audioCodecs.filter(o=>(o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").includes(i)),r.length===0&&(f.warning("codec ".concat(i," not included in rtpCapabilities, fallback to opus")),r=t.audioCodecs.filter(o=>(o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").includes("opus")));return r}function om(e,t){const n=e.map(i=>i.payloadType.toString());return t.filter(i=>i.rtpMap&&i.rtpMap.encodingName==="rtx"&&i.fmtp&&i.fmtp.parameters.apt&&n.includes(i.fmtp&&i.fmtp.parameters.apt))}let HR=class{get localCapabilities(){return xe(this._localCapabilities)}get rtpCapabilities(){return xe(this._rtpCapabilities)}get candidates(){return xe(this._candidates)}get iceParameters(){return xe(this._iceParameters)}get dtlsParameters(){return xe(this._dtlsParameters)}constructor(e){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname="o/i14u9pJrxRKAsu",this.firefoxSsrcMidMap=new Map,e=xe(e);const{remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:d}=e;let l;this.setup=a,l=s===Rn.RECEIVE_ONLY?$e.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):$e.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=i,this._iceParameters=t,this._dtlsParameters=n,this._localCapabilities=o;const u=s===Rn.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,h=s===Rn.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=s===Rn.RECEIVE_ONLY?r.send.videoCodecs:us(z.VIDEO,u,h,c),m=s===Rn.RECEIVE_ONLY?r.send.audioCodecs:us(z.AUDIO,u,h,d);for(const E of l.mediaDescriptions)E.attributes.iceUfrag=t.iceUfrag,E.attributes.icePwd=t.icePwd,E.attributes.fingerprints=n.fingerprints,E.attributes.candidates=i,E.attributes.setup=this.setup,E.media.mediaType==="application"&&(E.attributes.sctpPort="5000"),E.media.mediaType==="video"&&(E.media.fmts=p.map(g=>g.payloadType.toString(10)),E.attributes.payloads=p,E.attributes.extmaps=u.videoExtensions),E.media.mediaType==="audio"&&(E.media.fmts=m.map(g=>g.payloadType.toString(10)),E.attributes.payloads=m,E.attributes.extmaps=u.audioExtensions,Xi(E));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return $e.print(this.sessionDesc)}hasMid(e){return Array.isArray(e)?e.every(t=>this.hasMid(t)):this.sessionDesc.mediaDescriptions.some(t=>t.attributes.mid===e)}send(e,t,n,i,r){n=n.replace(/ /g,"-");const{ssrcs:o,ssrcGroups:s}=Xn(t,this.cname,A("SYNC_GROUP")?n:void 0),a=this.findPreloadMediaDesc(o);if(a){if(Me()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(e,o,i);let d;return c===-1?(d=this.createOrRecycleSendMedia(e,o,s,"sendonly",i,r),this.updateBundleMids()):(d=xe(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Me()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>n.attributes.mid&&e.indexOf(n.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");t.forEach(n=>{n.attributes.ssrcs=[]}),this.updateBundleMids()}receive(e,t,n){const i=[];return e.forEach(r=>{const o=r._mediaStreamTrack.kind,s=this.findAvailableRecvMediaIndex(o);let a,c=!1;s===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",t,n),this.updateBundleMids()):(a=xe(this.sessionDesc.mediaDescriptions[s]),a.attributes.direction="recvonly"),i.push({mid:a.attributes.mid,needCreateTransceiver:c})}),i}stopReceiving(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>e.indexOf(n.attributes.mid)!==-1);if(t.length!==e.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");t.forEach(n=>{n.media.port="0",n.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(e){const{foundation:t,protocol:n,address:i,port:r,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(e),d={foundation:t??"",componentId:"1",transport:n??"",priority:c?c+"":"",connectionAddress:i??"",port:r?r+"":"",type:o?o+"":"",relAddr:s??"",relPort:a?a+"":"",extension:{}};this.candidates.some(l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(l=>{l.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(e,t,n,i,r){const o=e._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=us(o,s,this.localCapabilities.send,o===z.AUDIO?r:i),c=o===z.VIDEO?s.videoExtensions:s.audioExtensions,d="".concat(++this.currentMidIndex);let l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,e);const u=this.findFirstClosedMedia(o);if(u){const h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>e.includes(n.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(n=>{n.attributes.direction="inactive"})}unmuteRemote(e){const t=this.sessionDesc.mediaDescriptions.filter(n=>e.includes(n.attributes.mid||""));if(t.length!==e.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");t.forEach(n=>{n.attributes.direction="recvonly"})}findAvailableMediaIndex(e,t,n){return this.sessionDesc.mediaDescriptions.findIndex(i=>{const r=i.media.mediaType===e&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(Me()){if(r){const o=this.firefoxSsrcMidMap.get(t[0].ssrcId);return!(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return!1}return r&&i.attributes.mid===n})}findAvailableRecvMediaIndex(e){return this.sessionDesc.mediaDescriptions.findIndex(t=>{const n=t.media.mediaType===e&&t.media.port!=="0"&&(t.attributes.direction==="recvonly"||t.attributes.direction==="sendrecv");return t.attributes.mid!=="0"&&t.attributes.mid!=="1"&&n})}predictReceivingMids(e){const t=[];for(let n=0;n<e;n++)t.push((this.currentMidIndex+n+1).toString(10));return t}restartICE(e){e=xe(e),this._iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(t=>{t.attributes.iceUfrag=e.iceUfrag,t.attributes.icePwd=e.icePwd})}createOrRecycleSendMedia(e,t,n,i,r,o){const s=this.rtpCapabilities.send,a=e===z.VIDEO?s.videoCodecs:s.audioCodecs,c=e===z.VIDEO?s.videoExtensions:s.audioExtensions;Me()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:e,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(u=>u.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:t,ssrcGroups:n,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,o);const l=this.findFirstClosedMedia(e);if(l){const u=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[u]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(e,t,n){const i=xe(e);return Ih(i),Uo(i,t),yh(i,t),nm(i),Pa(i,n,this.localCapabilities.send),i}mungSendMediaDesc(e,t){const n=xe(e);return Pa(n,t,this.localCapabilities.recv),Xi(n),n}updateRecvMedia(e,t){const n=this.sessionDesc.mediaDescriptions.findIndex(i=>i.attributes.mid===e);if(n!==-1){const i=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],t);this.sessionDesc.mediaDescriptions[n]=i}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(e=>e.media.port!=="0").map(e=>e.attributes.mid)}findPreloadMediaDesc(e){return this.sessionDesc.mediaDescriptions.find(t=>{var n;return((n=t.attributes)===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId)===e[0].ssrcId})}findFirstClosedMedia(e){return this.sessionDesc.mediaDescriptions.find(t=>Me()?t.media.port==="0"&&t.media.mediaType===e:t.media.port==="0")}};const VM=["sdp"];var Ve;let KR=(Ve=class Ws extends tw{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[]}set isInRestartIce(t){this._isInRestartIce=t}get isInRestartIce(){return this._isInRestartIce}constructor(t,n,i){super(t,n),this.direction=void 0,this.name=void 0,this.store=void 0,this.spec=void 0,this.peerConnection=void 0,this.initialOffer=void 0,this.transport=void 0,this.statsFilter=void 0,this.localCandidateCount=0,this._isInRestartIce=!1,this.mutex=new Bt("P2PConnection-mutex"),this.onLocalCandidate=void 0,this.remoteSDP=void 0,this.pendingCandidates=[],this.localCapabilities=void 0,this.isReady=!1,this.restartCnt=0,this.curTurnServerIndex=0,this.store=n,this.spec=t,this.peerConnection=new RTCPeerConnection(Ws.resolvePCConfiguration(t,n.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=i??Rn.SEND_ONLY,this.name=this.direction===Rn.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=vh(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,Me()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}async establish(t){try{const n=await rm();if(this.localCapabilities=La(n),t){const{sdp:i}=t,r=aM(t,VM),o=function(){const l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},u=Rd(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},m={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Li(u,l,"videoExtensions",h,p,m),Li(u,l,"videoCodecs",h,p,m),Li(u,l,"audioExtensions",h,p,m),Li(u,l,"audioCodecs",h,p,m),A("RAISE_H264_BASELINE_PRIORITY")){const E=m.videoCodecs.findIndex(g=>g.rtpMap&&g.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&g.fmtp&&g.fmtp.parameters["profile-level-id"]==="42001f");if(E!==-1){const g=m.videoCodecs.findIndex(S=>S.rtpMap&&S.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(g<E){f.debug("raising H264 baseline profile priority");const S=m.videoCodecs[E];m.videoCodecs.splice(E,1),m.videoCodecs.splice(g,0,S)}g!==-1&&A("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(S=>!(S.rtpMap&&S.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&S.fmtp&&S.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:h,recv:p,sendrecv:m}}({},{},i);this.remoteSDP=new HR({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;const s=await this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");const a=Ji(s.sdp);await this.peerConnection.setLocalDescription(s);const c=await WR({},{},s.sdp);this.localCapabilities=La(c);const d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),F(F({},a),{},{sdp:s.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});const i=await this.peerConnection.createOffer();if(!i.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const r=Ji(i.sdp);return this.initialOffer=i,F(F({},r),{},{sdp:i.sdp})}}catch(n){throw new L(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");await this.peerConnection.setLocalDescription(this.initialOffer);const{sdp:n,iceParameters:i,dtlsParameters:r}=t,o=await WR({},{},n);this.remoteSDP=new HR({remoteIceParameters:i,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});const s=this.peerConnection.getTransceivers()[0];s!=null&&s.sender&&s.sender.transport&&this.tryBindTransportEvents(s.sender.transport)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(n.toString()))}}async addRemoteCandidate(t){try{t&&this.pendingCandidates.push(t),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(n=>{this.peerConnection.addIceCandidate(n)}),this.pendingCandidates=[])}catch(n){throw new L(C.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(n.toString()))}}send(t,n,i){var r=this;return Wn(function*(){const o=yield ae(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[],a=r.remoteSDP.receive(t,n,i);t.forEach((g,S)=>{if(a[S].needCreateTransceiver){const T=r.peerConnection.addTransceiver(g._mediaStreamTrack,{direction:"sendonly"});s.push(T),g._updateRtpTransceiver(T)}else{const T=r.peerConnection.getTransceivers().find(I=>I.mid===a[S].mid);if(!T)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[S].mid));s.push(T),g._updateRtpTransceiver(T)}}),Me()&&A("SIMULCAST")===!0&&(yield ae(r.applySimulcastForFirefox(s,t)));const c=a.map(g=>g.mid),d=yield ae(r.peerConnection.createOffer()),l=r.mungSendOfferSDP(d.sdp,t,c),u=$e.parse(l),h=c.map(g=>{const S=u.mediaDescriptions.find(T=>T.attributes.mid===g);if(!S)throw new Error("Cannot extract ssrc from mediaDescription.");return tm(S,A("USE_PUB_RTX"))}),p=s.map((g,S)=>{const T=c[S];return{localSSRC:h[S],id:T}});yield ae(r.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield p}catch(g){const S=r.remoteSDP.toString();throw yield ae(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield ae(r.peerConnection.setRemoteDescription({type:"answer",sdp:S})),yield ae(r.stopSending(c,!0)),g}yield ae(r.applySimulcastEncodings(s,t)),yield ae(r.applySendEncodings(s,t));const m=r.remoteSDP.toString(),E=r.logSDPExchange(l,"offer","local","send");return E==null||E(m),yield ae(r.setRemoteDescription({type:"answer",sdp:m})),s.map((g,S)=>{const T=c[S];return{localSSRC:h[S],id:T}})}catch(s){throw s instanceof L?s:new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(t.length,") when trying to call P2PConnection.stopSending."));r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();s==null||s(a),await this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(t,n,i,r);if(s){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,o,t);d==null||d(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),f.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else f.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async mockReceive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(t,n,i,r);if(s){const a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");await this.setRemoteDescription({type:"offer",sdp:a});const d=await this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,o,t);c==null||c(l||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:l}),f.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else f.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."))}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async restartICE(t){try{if(this.store.p2pTransport===zo.Auto&&(this.store.p2pTransport=zo.SdRtn,ge().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Ws.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,ge().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Ws.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!t){this.restartCnt++,this.isReady=!1;const n=await this.peerConnection.createOffer({iceRestart:!0});if(!n.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const{iceParameters:i}=Ji(n.sdp);return this.store.descriptionStart(),this.direction===Rn.SEND_ONLY&&await this.peerConnection.setLocalDescription(n),i}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(t),this.store.descriptionStart(),this.direction===Rn.RECEIVE_ONLY){this.restartCnt++,await this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});const n=await this.peerConnection.createAnswer();if(!n.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");const{iceParameters:i}=Ji(n.sdp);return await this.peerConnection.setLocalDescription(n),i}await this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}close(){var t;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new L(C.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===t);i.length===1&&(this.isVP8Simulcast(n)?Me()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:F(F({},Ar),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:F(F({},Ar),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;["connected","completed"].includes(this.peerConnection.iceConnectionState)&&(this.isReady=!1),(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=t=>{if(t.candidate){var n;t.candidate.candidate&&((n=this.onLocalCandidate)===null||n===void 0||n.call(this,t.candidate.toJSON())),this.localCandidateCount+=1}else f.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r={iceServers:[]};return t.iceServers?r.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Ba(t.turnServer.servers)?r.iceServers=t.turnServer.servers:(r.iceServers&&r.iceServers.push(...Ws.turnServerConfigToIceServers(t.turnServer.servers,n,i)),A("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&t.turnServer.serversFromGateway&&r.iceServers.push(...Ws.turnServerConfigToIceServers(t.turnServer.serversFromGateway,n,i)),[zo.Relay,zo.SdRtn].includes(n)&&(r.iceTransportPolicy="relay"),A("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(o=>{o.forceturn&&(r.iceTransportPolicy="relay")}))),A("ENABLE_ENCODED_TRANSFORM")&&ge().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),f.debug("P2PConnection p2pTransport is ".concat(n)),r}static turnServerConfigToIceServers(t,n){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0;const r=[],o=t.filter(a=>a.tcpport);f.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(i));const s=o.length>i?o[i]:o[0];switch(n){case zo.SdRtn:const a=t.filter(d=>d.username.includes("glb:")&&d.turnServerURL==d.turnServerURL),c=a.length>i?a[i]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(go(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(go(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case zo.Relay:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(go(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;default:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(go(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"stun:".concat(s.turnServerURL,":").concat(s.tcpport)}))}return r}tryBindTransportEvents(t){if(t){this.transport=t,t.onstatechange=()=>{var i;t!=null&&t.state&&((i=this.onDTLSTransportStateChange)===null||i===void 0||i.call(this,t.state))},t.onerror=i=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in i?i.error:i)};const n=t.iceTransport;n&&(n.onstatechange=()=>{const i=t==null?void 0:t.iceTransport.state;var r;i&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,i))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){const{local:i,remote:r}=n.getSelectedCandidatePair();f.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:i.type,protocol:i.protocol}),", remote ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i;if(n||(n=this.peerConnection.getSenders().find(c=>c.track===t._mediaStreamTrack)),!n)return f.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return f.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!ge().supportSetRtpSenderParameters)return f.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},o={};switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(t._encoderConfig){const{bitrateMax:c,frameRate:d,scaleResolutionDownBy:l}=t._encoderConfig;c&&(o.maxBitrate=1e3*c),t._hints.includes(je.LOW_STREAM)&&(d&&(o.maxFramerate=kn(d)),l&&l>=1&&(o.scaleResolutionDownBy=l))}if(A("DSCP_TYPE")&&ko()){const c=A("DSCP_TYPE");["very-low","low","medium","high"].includes(c)&&(o.networkPriority=c)}const s=n.getParameters(),a=(i=s.encodings)===null||i===void 0?void 0:i[0];Me()&&!a&&(r.encodings=[o]),a&&Object.assign(a,o),Object.assign(s,r),f.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(s.encodings))),await n.setParameters(s)}async applySendEncodings(t,n){try{if(!ge().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],o=n[i];o instanceof Ge&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{f.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,i){const r=$e.parse(t);return n.forEach((o,s)=>{const a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Uo(c,o),im(c,o,this.store.codec))}),$e.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let a=0;a<t.length;a++){var i,r,o,s;const c=t[a],d=n[a];if(d instanceof Ge&&!d._hints.includes(je.LOW_STREAM)&&(i=d._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=d._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=d._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=d._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},u={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:u.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:u.high}];const h=c.sender.getParameters();await c.sender.setParameters(Object.assign(h,l))}}}async applySimulcastEncodings(t,n){if(!Me()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof Ge&&this.isVP8Simulcast(r)){const o=t[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(t){var n,i,r,o;return!!(t instanceof Ge&&A("SIMULCAST")&&this.store.codec==="vp8"&&!t._hints.includes(je.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((i=t._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(r=t._scalabilityMode)!==null&&r!==void 0&&r.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(A("SDP_LOGGING"))return f.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),t),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const o=this.remoteSDP.toString();r==null||r(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async s=>{s.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const o=this.remoteSDP.toString();r==null||r(o),await this.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}async getRemoteSSRC(t,n){var i,r;if(n=(i=n)!==null&&i!==void 0?i:(r=this.currentRemoteDescription)===null||r===void 0?void 0:r.sdp){var o;const s=(o=$e.parse(n).mediaDescriptions.find(a=>a.attributes.mid===t))===null||o===void 0?void 0:o.attributes.ssrcs;return s==null?void 0:s[0].ssrcId}}async setRemoteDescription(t){await this.peerConnection.setRemoteDescription(t),["connected","completed"].includes(this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())}mungReceiveAnswerSDP(t,n,i){const r=$e.parse(t),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&i===z.AUDIO&&o.media.mediaType==="audio"&&Xi(o),$e.print(r)}},B(Ve.prototype,"establish",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"establish"),Ve.prototype),B(Ve.prototype,"connect",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"connect"),Ve.prototype),B(Ve.prototype,"receive",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"receive"),Ve.prototype),B(Ve.prototype,"mockReceive",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"mockReceive"),Ve.prototype),B(Ve.prototype,"stopReceiving",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"stopReceiving"),Ve.prototype),B(Ve.prototype,"restartICE",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"restartICE"),Ve.prototype),B(Ve.prototype,"close",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"close"),Ve.prototype),B(Ve.prototype,"updateEncoderConfig",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"updateEncoderConfig"),Ve.prototype),B(Ve.prototype,"updateSendParameters",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"updateSendParameters"),Ve.prototype),B(Ve.prototype,"replaceTrack",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"replaceTrack"),Ve.prototype),B(Ve.prototype,"muteLocal",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"muteLocal"),Ve.prototype),B(Ve.prototype,"unmuteLocal",[vi],Object.getOwnPropertyDescriptor(Ve.prototype,"unmuteLocal"),Ve.prototype),Ve);function vi(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function Of(e,t){let n=document.createElement("video"),i=document.createElement("canvas");n.setAttribute("style","display:none"),i.setAttribute("style","display:none"),n.setAttribute("muted",""),n.muted=!0,n.setAttribute("autoplay",""),n.autoplay=!0,n.setAttribute("playsinline",""),i.width=kn(t.width),i.height=kn(t.height);const r=kn(t.framerate||15);document.body.append(n),document.body.append(i);let o=e._mediaStreamTrack;n.srcObject=new MediaStream([o]),n.play();const s=i.getContext("2d");if(!s)throw new N(C.UNEXPECTED_ERROR,"can not get canvas context");const a=ge(),c=i.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=i),i.startCapture=()=>{if(!n)return i.stopCapture&&i.stopCapture();if(n.paused&&n.play(),n.videoHeight>2&&n.videoWidth>2){const l=n.videoWidth,u=n.videoHeight/l,h=i.width*u;Math.abs(h-i.height)>=2&&(f.debug("adjust low stream resolution","".concat(i.width,"x").concat(i.height," -> ").concat(i.width,"x").concat(h)),i.height=h)}s.drawImage(n,0,0,i.width,i.height),c.requestFrame&&c.requestFrame(),o!==e._mediaStreamTrack&&(o=e._mediaStreamTrack,n.srcObject=new MediaStream([o]))},i.stopCapture=b0(()=>i.startCapture&&i.startCapture(),r);const d=c.stop;return c.stop=()=>{d.call(c),n&&(n.remove(),n.srcObject=null,n=null),i&&(i.width=0,i.remove(),i.stopCapture&&i.stopCapture(),i.startCapture=void 0,i.stopCapture=void 0,i=null),f.debug("clean low stream renderer")},c}var Xl=function(e){return e[e.HEIGHT=2033]="HEIGHT",e[e.FRAME_RATE=2034]="FRAME_RATE",e[e.WIDTH=2035]="WIDTH",e}(Xl||{}),wt=function(e){return e[e.FRAME_RATE=2002]="FRAME_RATE",e[e.WIDTH=2003]="WIDTH",e[e.HEIGHT=2004]="HEIGHT",e[e.PACKAGE_LOST=2005]="PACKAGE_LOST",e[e.AVG_ENCODE=2007]="AVG_ENCODE",e[e.NACKS=2009]="NACKS",e[e.PLIS=2010]="PLIS",e[e.FIRS=2011]="FIRS",e[e.BITRATE=2012]="BITRATE",e[e.PACKAGE_RATE=2031]="PACKAGE_RATE",e[e.ADAPTATION=2032]="ADAPTATION",e[e.ACTUAL_ENCODED=2060]="ACTUAL_ENCODED",e[e.BANDWIDTH=2061]="BANDWIDTH",e[e.RETRANSMIT=2062]="RETRANSMIT",e[e.TARGET_ENCODED=2064]="TARGET_ENCODED",e[e.TRANSMIT=2066]="TRANSMIT",e[e.FREEZE=2082]="FREEZE",e[e.DISABLED=2095]="DISABLED",e[e.PLAYER_STATUS=2128]="PLAYER_STATUS",e[e.QP_SUM=2143]="QP_SUM",e}(wt||{}),$o=function(e){return e[e.BITRATE=2069]="BITRATE",e[e.PACKAGE_LOST=2070]="PACKAGE_LOST",e[e.PACKAGE_RATE=2071]="PACKAGE_RATE",e[e.HEIGHT=2073]="HEIGHT",e[e.FRAME_RATE=2075]="FRAME_RATE",e[e.WIDTH=2077]="WIDTH",e}($o||{}),sn=function(e){return e[e.JITTER=-1]="JITTER",e[e.PACKAGE_LOST=2014]="PACKAGE_LOST",e[e.WIDTH=2018]="WIDTH",e[e.HEIGHT=2019]="HEIGHT",e[e.FRAME_RATE=2020]="FRAME_RATE",e[e.JITTER_BUFFER=2023]="JITTER_BUFFER",e[e.CURRENT_DELAY=2024]="CURRENT_DELAY",e[e.NACKS=2026]="NACKS",e[e.PLIS=2027]="PLIS",e[e.FIRS=2028]="FIRS",e[e.BITRATE=2029]="BITRATE",e[e.PACKAGE_RATE=2078]="PACKAGE_RATE",e[e.FREEZE=2084]="FREEZE",e[e.DISABLED=2101]="DISABLED",e[e.PLAYER_STATUS=2129]="PLAYER_STATUS",e[e.QP_SUM=2144]="QP_SUM",e[e.I_FRAME_DELAY=2149]="I_FRAME_DELAY",e}(sn||{}),qo=function(e){return e[e.FRAME_RATE_DECODE=2021]="FRAME_RATE_DECODE",e[e.FRAME_RATE_RENDER=2022]="FRAME_RATE_RENDER",e[e.FRAME_RATE_OUTPUT=2155]="FRAME_RATE_OUTPUT",e[e.FREEZE_TIME=2109]="FREEZE_TIME",e[e.FREEZE_TIME_RENDER=2147]="FREEZE_TIME_RENDER",e[e.FREEZE_DURATION=2156]="FREEZE_DURATION",e}(qo||{}),pw=function(e){return e[e.PCM_LEVEL=2104]="PCM_LEVEL",e}(pw||{}),oo=function(e){return e[e.PACKAGE_LOST=-1]="PACKAGE_LOST",e[e.LEVEL=2038]="LEVEL",e[e.BITRATE=2039]="BITRATE",e[e.PACKAGE_RATE=2040]="PACKAGE_RATE",e[e.AEC_RETURN_LOSS=2041]="AEC_RETURN_LOSS",e[e.AEC_RETURN_LOSS_ENH=2042]="AEC_RETURN_LOSS_ENH",e[e.FREEZE=2081]="FREEZE",e[e.DISABLED=2096]="DISABLED",e}(oo||{}),yi=function(e){return e[e.BITRATE=2044]="BITRATE",e[e.PACKAGE_LOST=2045]="PACKAGE_LOST",e[e.PACKAGE_RATE=2046]="PACKAGE_RATE",e[e.CURRENT_DELAY=2047]="CURRENT_DELAY",e[e.JITTER_BUFFER=2054]="JITTER_BUFFER",e[e.JITTER=2055]="JITTER",e[e.FREEZE=2083]="FREEZE",e[e.DISABLED=2102]="DISABLED",e[e.PCM_LEVEL=2105]="PCM_LEVEL",e[e.PLAYER_STATUS=2130]="PLAYER_STATUS",e[e.CONCEALED_SAMPLES=2148]="CONCEALED_SAMPLES",e}(yi||{}),_w=function(e){return e[e.FREEZE_TIME=-1]="FREEZE_TIME",e[e.LEVEL=2043]="LEVEL",e}(_w||{}),hi=function(e){return e[e.RTT=2006]="RTT",e[e.CONN_TYPE=801]="CONN_TYPE",e}(hi||{});const Pr=1e3,jo=3;function ce(e,t,n){n!=null&&Number.isFinite(n)&&(e[t]=Math.round(Math.max(0,n)))}function zR(e){const t={[hi.CONN_TYPE]:0,[hi.RTT]:e.rtt};switch(e.selectedCandidatePair.localCandidate.candidateType){case"relay":{const n=e.selectedCandidatePair.localCandidate.relayProtocol;n==="udp"&&(t[hi.CONN_TYPE]=1),n==="tcp"&&(t[hi.CONN_TYPE]=3),n==="tls"&&(t[hi.CONN_TYPE]=4);break}case"srflx":t[hi.CONN_TYPE]=2}return t}function YR(e){let t=0;switch(e){case"none":t=0;break;case"cpu":t=1;break;case"bandwidth":t=2;break;case"other":t=3}return t}class fw extends qe{constructor(t){super(),this.store=void 0,this.uploadWRTCStatsTimer=void 0,this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer=void 0,this.uploadExtUsageStatsTimer=void 0,this.uploadInboundExtStatsTimer=void 0,this.requestStats=void 0,this.requestTransportStats=void 0,this.requestLocalMedia=void 0,this.requestRemoteMedia=void 0,this.requestAllTracks=void 0,this.requestVideoIsReady=void 0,this.requestUploadStats=void 0,this.requestUpload=void 0,this.uploadOutboundStarted=!1,this.uploadInboundStarted=!1,this.uploadTransportStarted=!1,this.uploadExtensionUsageStarted=!1,this.lastRecvStats=void 0,this.lastSendStats=void 0,this.lastFullRecvStats=void 0,this.lastFullSendStats=void 0,this.needUploadRenderFreezeTime=!0,this.store=t}uploadWRTCStats(t){if(!this.requestStats||!this.requestUploadStats)return;let n,i;if(this.uploadTransportStarted&&(n=this.requestStats(),this.store.useP2P&&(i=this.requestStats(!0))),!n&&this.uploadOutboundStarted&&(n=this.requestStats()),!i&&this.uploadInboundStarted&&(i=this.requestStats(!0)),n||i){const r={};if(this.uploadTransportStarted&&n){const o=this.getTransportStats(n,i,t);o&&(r.misc=[o])}if(this.uploadOutboundStarted&&n){const o=this.getOutboundStats(n,t?this.lastSendStats:this.lastFullSendStats,t);o&&(r.outbound=[o])}if(this.uploadInboundStarted&&i){const o=this.getInboundStats(i,t?this.lastRecvStats:this.lastFullRecvStats,t);o&&(r.inbound=o)}this.requestUploadStats(r)}this.lastRecvStats=i,this.lastSendStats=n,t||(this.lastFullRecvStats=i,this.lastFullSendStats=n)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;let t=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted)return this.stopUploadWRTCStats();this.uploadWRTCStats(t!==jo),++t===jo+1&&(t=1)},Pr)}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0)}getTransportStats(t,n,i){if(!this.requestStats)return;if(i)return t.rtt==null?void 0:{addition:{[hi.RTT]:t.rtt,[hi.CONN_TYPE]:void 0}};const r=zR(t);if(this.store.useP2P){if(n){const o=zR(n);r[hi.CONN_TYPE]+=o[hi.CONN_TYPE]<<3}r[hi.CONN_TYPE]+=110}else r[hi.CONN_TYPE]+=100;return{addition:r}}getOutboundStats(t,n,i){if(!this.requestUploadStats||!this.requestLocalMedia)return;const r=this.requestLocalMedia();if(!r||r.length===0)return;let o,s,a;return r.forEach(c=>{let[d,{track:l,ssrcs:u}]=c;switch(d){case M.LocalVideoLowTrack:case M.LocalVideoTrack:if(d===M.LocalVideoTrack){const h=function(E,g,S,T,I){const y=g.videoSend.find(U=>U.ssrc===E);if(!y)return;const w={},{sentFrame:D,inputFrame:O}=y;if(O&&D){const U=O.frameRate,J=D.frameRate;w[wt.FREEZE]=function(Le,Be){let ot=!0;return ot=!(Le<=5)&&(Le<=10?Be<3:Le<=20?Be<4:Be<5),ot}(U,J)?1:0}if(ce(w,wt.QP_SUM,y.qpSumPerFrame),I)return w;switch(D&&(ce(w,wt.HEIGHT,D.height),ce(w,wt.WIDTH,D.width),ce(w,wt.FRAME_RATE,D.frameRate)),w[wt.DISABLED]=T._originMediaStreamTrack&&!T._originMediaStreamTrack.enabled||T._mediaStreamTrack&&!T._mediaStreamTrack.enabled?1:0,y.adaptionChangeReason){case"none":w[wt.ADAPTATION]=0;break;case"cpu":w[wt.ADAPTATION]=1;break;case"bandwidth":w[wt.ADAPTATION]=2;break;case"other":w[wt.ADAPTATION]=3}let P=0;y.adaptionChangeReason&&(P+=YR(y.adaptionChangeReason)),g.qualityLimitationReason&&(P+=YR(g.qualityLimitationReason)<<3),w[wt.ADAPTATION]=P,w[wt.PLAYER_STATUS]=wp[T._player?T._player.videoElementStatus:"uninit"],ce(w,wt.NACKS,y.nacksCount),ce(w,wt.PLIS,y.plisCount),ce(w,wt.FIRS,y.firsCount),ce(w,wt.AVG_ENCODE,y.avgEncodeMs);const x=S&&S.videoSend.find(U=>U.ssrc===E);if(x){let U=I?Pr:Pr*jo;x.timestamp&&y.timestamp&&(U=y.timestamp-x.timestamp),x.packets!=null&&y.packets!=null&&ce(w,wt.PACKAGE_RATE,1e3*(y.packets-x.packets)/U),y.packetsLost!=null&&x.packetsLost!=null&&ce(w,wt.PACKAGE_LOST,y.packetsLost-x.packetsLost),x.bytes!=null&&y.bytes!=null&&ce(w,wt.BITRATE,8*(y.bytes-x.bytes)/U)}return w}(u[0].ssrcId,t,n,l,i),p=i?null:function(E,g,S){const T=g.videoSend.find(P=>P.ssrc===E);if(!T)return null;const I={},y=T.inputFrame,w=y&&y.height||S&&S.videoHeight||0,D=y&&y.width||S&&S.videoWidth||0,O=y&&y.frameRate||0;return ce(I,Xl.HEIGHT,w),ce(I,Xl.WIDTH,D),ce(I,Xl.FRAME_RATE,O),I}(u[0].ssrcId,t,l),m=i?null:function(E){const g={};return ce(g,wt.RETRANSMIT,E.bitrate.retransmit),ce(g,wt.TARGET_ENCODED,E.bitrate.targetEncoded),ce(g,wt.ACTUAL_ENCODED,E.bitrate.actualEncoded),ce(g,wt.TRANSMIT,E.bitrate.transmit),ce(g,wt.BANDWIDTH,E.sendBandwidth),g}(t);s=Object.assign({},h,p,m)}else a=i?void 0:function(h,p,m){const E=p.videoSend.find(T=>T.ssrc===h);if(!E)return;const g={},S=E.sentFrame;if(S&&(ce(g,$o.HEIGHT,S.height),ce(g,$o.WIDTH,S.width),ce(g,$o.FRAME_RATE,S.frameRate)),m){const T=m.videoSend.find(I=>I.ssrc===h);if(T){let I=Pr*jo;T.timestamp&&E.timestamp&&(I=E.timestamp-T.timestamp),T.packets!=null&&E.packets!=null&&ce(g,$o.PACKAGE_RATE,1e3*(E.packets-T.packets)/I),E.packetsLost!=null&&T.packetsLost!=null&&ce(g,$o.PACKAGE_LOST,E.packetsLost-T.packetsLost),T.bytes!=null&&E.bytes!=null&&ce(g,$o.BITRATE,8*(E.bytes-T.bytes)/I)}}return g}(u[0].ssrcId,t,n);break;case M.LocalAudioTrack:o=i?void 0:function(h,p,m,E){const g=p.audioSend.find(w=>w.ssrc===h);if(!g)return;const S={};S[oo.DISABLED]=E._originMediaStreamTrack&&!E._originMediaStreamTrack.enabled||E._mediaStreamTrack&&!E._mediaStreamTrack.enabled?1:0;const T=100*E._source.getAccurateVolumeLevel(),I=g.inputLevel;if(I!=null){const w=Math.ceil(50*Math.log10(100*I+1));ce(S,oo.LEVEL,w)}ce(S,pw.PCM_LEVEL,T),ce(S,oo.AEC_RETURN_LOSS,g.aecReturnLoss),ce(S,oo.AEC_RETURN_LOSS_ENH,g.aecReturnLossEnhancement),S[oo.FREEZE]=0;const y=m&&m.audioSend.find(w=>w.ssrc===h);if(y){let w=Pr*jo;y.timestamp&&g.timestamp&&(w=g.timestamp-y.timestamp),y.bytes!=null&&g.bytes!=null&&ce(S,oo.BITRATE,8*(g.bytes-y.bytes)/w),y.packets!=null&&g.packets!=null&&ce(S,oo.PACKAGE_RATE,1e3*(g.packets-y.packets)/w)}return S}(u[0].ssrcId,t,n,l)}}),{high:s,low:a,audio:o}}getInboundStats(t,n,i){if(!this.requestRemoteMedia)return;const r=this.requestRemoteMedia()||[],o=[];return r.forEach(s=>{let[a,c]=s;const d={peer:a.uid};if(c.has(z.VIDEO)&&a.videoTrack){const l=a._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(a._videoSSRC)||!1,u=a.videoTrack?function(h,p,m,E,g,S,T){var I;const y=p.videoRecv.find(J=>J.ssrc===h);if(!y)return;const w={},{receivedFrame:D,outputFrame:O,decodeFrameRate:P}=y,x=m&&m.videoRecv.find(J=>J.ssrc===h);if(w[sn.FREEZE]=g&&Cd.isRemoteVideoFreeze(E,y,x)?1:0,ce(w,qo.FRAME_RATE_DECODE,P),ce(w,sn.QP_SUM,y.qpSumPerFrame),y.framesRateFirefox&&ce(w,sn.FRAME_RATE,y.framesRateFirefox),D&&ce(w,sn.FRAME_RATE,D.frameRate),x){const J=p.timestamp-m.timestamp||(T?Pr:jo*Pr);y.packetsLost!=null&&x.packetsLost!=null&&ce(w,sn.PACKAGE_LOST,y.packetsLost-x.packetsLost),x.bytes!=null&&y.bytes!=null&&ce(w,sn.BITRATE,8*(y.bytes-x.bytes)/J),x.packets!=null&&y.packets!=null&&ce(w,sn.PACKAGE_RATE,1e3*(y.packets-x.packets)/J)}if(T)return w;D?(ce(w,sn.HEIGHT,D.height),ce(w,sn.WIDTH,D.width)):E&&(ce(w,sn.HEIGHT,E._videoHeight||0),ce(w,sn.WIDTH,E._videoWidth||0)),O&&ce(w,qo.FRAME_RATE_OUTPUT,O.frameRate);const U=(I=E._player)===null||I===void 0?void 0:I.rendFrameRate.toFixed(0);if(U&&ce(w,qo.FRAME_RATE_RENDER,+U),ce(w,sn.JITTER_BUFFER,y.jitterBufferMs),ce(w,sn.CURRENT_DELAY,y.currentDelayMs),ce(w,sn.FIRS,y.firsCount),ce(w,sn.NACKS,y.nacksCount),ce(w,sn.PLIS,y.plisCount),E){w[sn.DISABLED]=E._originMediaStreamTrack.enabled&&E._mediaStreamTrack.enabled?0:1;const J=E._player;if(J){const{freezeTimeCounterList:Le,renderFreezeAccTime:Be,videoElementStatus:ot}=J;if(Le&&Le.length>0&&ce(w,qo.FREEZE_TIME,Le.splice(0,1)[0]),S&&Lr.visibility==="visible"&&ot===hn.PLAYING&&ge().supportRequestVideoFrameCallback){const vt=Math.min(6e3,Be);J.renderFreezeAccTime=Math.max(0,Be-vt),ce(w,qo.FREEZE_TIME_RENDER,vt)}if(typeof y.totalFreezesDuration=="number"){const vt=x&&x.totalFreezesDuration?y.totalFreezesDuration-x.totalFreezesDuration:y.totalFreezesDuration;ce(w,qo.FREEZE_DURATION,1e3*vt)}}}if(w[sn.PLAYER_STATUS]=wp[E._player?E._player.videoElementStatus:"uninit"],x&&y.totalInterFrameDelay!==void 0&&y.totalSquaredInterFrameDelay!==void 0&&x.totalInterFrameDelay!==void 0&&x.totalSquaredInterFrameDelay!==void 0){const J=y.totalInterFrameDelay-x.totalInterFrameDelay,Le=y.totalSquaredInterFrameDelay-x.totalSquaredInterFrameDelay,Be=y.framesDecodeCount-x.framesDecodeCount,ot=J/Be*1e3,vt=Math.round(1e3*Math.sqrt((Le-Math.pow(J,2)/Be)/Be));!isNaN(vt)&&ot+vt>Math.max(3*ot,ot+150)&&(w[sn.I_FRAME_DELAY]=vt)}return w}(a._videoSSRC,t,n,a.videoTrack,l===!0,this.needUploadRenderFreezeTime,i):void 0;u&&(d.video=u)}if(c.has(z.AUDIO)&&a.audioTrack){const l=a.audioTrack?function(u,h,p,m,E){const g=h.audioRecv.find(x=>x.ssrc===u);if(!g)return;const S={},T=p&&p.audioRecv.find(x=>x.ssrc===u),{receivedFrames:I,droppedFrames:y}=g;var w,D;if(ce(S,yi.JITTER,g.jitterMs),I!=null&&y!=null&&(S[yi.FREEZE]=(D=y,(w=I)===0||100*D/w>20?1:0)),T){const x=h.timestamp-p.timestamp||(E?Pr:Pr*jo);g.packets!=null&&T.packets!=null&&ce(S,yi.PACKAGE_RATE,1e3*(g.packets-T.packets)/x),T.bytes!=null&&g.bytes!=null&&ce(S,yi.BITRATE,8*(g.bytes-T.bytes)/x),g.packetsLost!=null&&T.packetsLost!=null&&ce(S,yi.PACKAGE_LOST,g.packetsLost-T.packetsLost)}if(E)return S;const O=100*m._source.getAccurateVolumeLevel(),P=g.outputLevel;if(P!=null){const x=Math.ceil(50*Math.log10(100*P+1));ce(S,_w.LEVEL,x)}if(ce(S,yi.PCM_LEVEL,O),m&&(S[yi.DISABLED]=m._originMediaStreamTrack.enabled&&m._mediaStreamTrack.enabled?0:1),ce(S,yi.JITTER_BUFFER,g.jitterBufferMs),ce(S,yi.CURRENT_DELAY,g.jitterBufferMs),S[yi.PLAYER_STATUS]=wp[Bn.getPlayerState(m.getTrackId())],T){const x=g.concealedSamples-T.concealedSamples;x>0&&ce(S,yi.CONCEALED_SAMPLES,x)}return S}(a._audioSSRC,t,n,a.audioTrack,i):void 0;l&&(d.audio=l)}(d.video||d.audio)&&o.push(d)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,o}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;const t=(this.requestAllTracks()||[]).find(n=>n instanceof $E);if(t&&t._external.getDenoiserStats){const n=t._external.getDenoiserStats();n&&this.requestUpload(Cs.DENOISER_STATS,n)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(t=>{t.getProcessorStats().forEach(n=>{this.requestUpload&&this.requestUpload(n.type,n.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(t=>{let[n,i]=t;i.has(z.VIDEO)&&n.videoTrack&&n.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}),i.has(z.AUDIO)&&n.audioTrack&&n.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0))}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);const t=new Map;this.uploadExtUsageStatsTimer=window.setInterval(async()=>{const n=Date.now(),i={connectionInterval:A("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:n};let r=[];const o=this.requestAllTracks&&this.requestAllTracks()||[];for(const d of o)!d.muted&&d.enabled&&(r=r.concat(await d.getProcessorUsage()));const s=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(const[d,l]of s)l.has(z.VIDEO)&&d.videoTrack&&(r=r.concat(await d.videoTrack.getProcessorUsage())),l.has(z.AUDIO)&&d.audioTrack&&(r=r.concat(await d.audioTrack.getProcessorUsage()));if(r.length===0)return;i.details=function(d,l){const u={};for(const{id:E,value:g,level:S,direction:T}of d){var h;const I=(h=l.get(E))!==null&&h!==void 0?h:0,y=g===2?I+A("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:I;var p,m;l.set(E,y),u[E]?(g===2&&(u[E].value=g),S>u[E].level&&(u[E].level=S),T==="remote"&&(u[E].remoteUidCount+=1),u[E].totalTs=(p=l.get(E))!==null&&p!==void 0?p:0):u[E]={value:g,level:S,remoteUidCount:T==="local"?0:1,totalTs:(m=l.get(E))!==null&&m!==void 0?m:0}}return Object.keys(u).map(E=>{const{level:g,value:S,totalTs:T}=u[E];return{id:E,level:g,value:S,totalTs:T}})}(r,t);const a=Date.now(),c=a>n?a:n+1;this.requestUpload&&this.requestUpload(Cs.EXTENSION_USAGE_STATS,{usageStats:i,sendTs:c})},A("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}}class ho{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(t,n){this.uid=void 0,this._uintid=void 0,this._trust_in_room_=!0,this._trust_audio_enabled_state_=!0,this._trust_video_enabled_state_=!0,this._trust_audio_mute_state_=!0,this._trust_video_mute_state_=!0,this._audio_muted_=!1,this._video_muted_=!1,this._audio_enabled_=!0,this._video_enabled_=!0,this._audio_added_=!1,this._video_added_=!1,this._is_pre_created=!1,this._video_pre_subscribed=!1,this._audio_pre_subscribed=!1,this._trust_video_stream_added_state_=!0,this._trust_audio_stream_added_state_=!0,this._audioTrack=void 0,this._videoTrack=void 0,this._dataChannels=[],this._audioSSRC=void 0,this._videoSSRC=void 0,this._audioOrtc=void 0,this._videoOrtc=void 0,this._cname=void 0,this._rtxSsrcId=void 0,this._videoMid=void 0,this._audioMid=void 0,this.uid=t,this._uintid=n}}let Ki=function(e){return e.SEND_ONLY="SEND_ONLY",e.RECEIVE_ONLY="RECEIVE_ONLY",e}({});function FM(e,t){let n;switch(t){case M.LocalAudioTrack:n=ve.Audio;break;case M.LocalVideoTrack:n=e._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High;break;case M.LocalVideoLowTrack:n=ve.Low}return n}function bf(e){const t=ge();if(e.some(n=>n._bypassWebAudio))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!t.webAudioMediaStreamDest)throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function Fp(e,t){bf(e);const n=t||new Ot;return e.forEach(i=>n.addAudioTrack(i)),n}var $R,qR,JR,XR,QR,ZR,eC,tC,nC,iC,rC,Xe;let Vn=($R=ji(Ki.SEND_ONLY),qR=ji(Ki.SEND_ONLY),JR=ji(),XR=ji(Ki.RECEIVE_ONLY),QR=ji(Ki.RECEIVE_ONLY),ZR=ji(Ki.RECEIVE_ONLY),eC=ji(Ki.RECEIVE_ONLY),tC=ji(Ki.RECEIVE_ONLY),nC=ji(Ki.RECEIVE_ONLY),iC=ji(),rC=ji(Ki.RECEIVE_ONLY),B((Xe=class extends qe{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(ee.StateChange,t,this._state)}constructor(e,t){super(),this.store=void 0,this.statsUploader=void 0,this.sendConnection=void 0,this.recvConnection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.statsCollector=void 0,this.dtlsFailedCount=0,this.sendMutex=new Bt("P2PChannel2-send-mutex"),this.recvMutex=new Bt("P2PChannel2-recv-mutex"),this._state=we.Disconnected,this._restartStates=["disconnected","failed"],this.reconnectInterval=void 0,this.uploadUnplinkStarted=!1,this.uploadDownlinkStarted=!1,this.uplinkStateUploadInterval=void 0,this.downlinkStatsUploadInterval=void 0,this.handleMuteLocalTrack=async(n,i,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==we.Connected)return void r(new L(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));const c=this.filterTobeMutedTracks(n);if(c.length===0)return void i();const d=c.find(p=>p[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),await this.sendConnection.muteLocal(c.map(p=>{let[,{id:m}]=p;return m}));let l=!1;var s,a;n.trackMediaType==="video"?l=!((s=this.localTrackMap.get(M.LocalAudioTrack))===null||s===void 0||!s.track._muted):l=((a=this.localTrackMap.get(M.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;const u=this.createMuteMessage(c);await Ue(this,ee.RequestMuteLocal,u);const h=n.trackMediaType==="video"?mo.MUTE_LOCAL_VIDEO:mo.MUTE_LOCAL_AUDIO;await Ue(this,ee.RequestP2PMuteLocal,{action:h,message:u,isMuteAll:l}),i()}catch(c){r(c)}finally{o()}},this.handleUnmuteLocalTrack=async(n,i,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==we.Connected)return void r(new L(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));const s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void i();await this.sendConnection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));const a=this.createUnmuteMessage(s),c=n.trackMediaType==="video"?mo.UNMUTE_LOCAL_VIDEO:mo.UNMUTE_LOCAL_AUDIO;await Ue(this,ee.RequestP2PMuteLocal,{action:c,message:a}),i()}catch(s){r(s)}finally{o()}},this.handleUpdateVideoEncoder=async(n,i,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleSetVideoEncoder");try{const s=this.localTrackMap.get(M.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==n||this.state!==we.Connected)return void i();const{id:a,track:c}=s;a&&(await this.sendConnection.updateSendParameters(a,c),await this.sendConnection.updateEncoderConfig(a,c),this.emit(ee.UpdateVideoEncoder,c)),i()}catch(s){r(s)}finally{o()}},this.handleUpdateVideoSendParameters=async(n,i,r)=>{const o=await this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{const s=this.localTrackMap.get(M.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==n||this.state!==we.Connected)return void i();const{id:a,track:c}=s;a&&await this.sendConnection.updateSendParameters(a,c),i()}catch(s){r(s)}finally{o()}},this.handleReplaceTrack=async(n,i,r,o)=>{let s;f.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return n===u});if(!this.sendConnection||!d||d[1].id===void 0||this.state!==we.Connected)return void i();if(await((a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),d[0]===M.LocalVideoTrack&&ge().supportDualStreamEncoding){const l=this.localTrackMap.get(M.LocalVideoLowTrack);if(l){const u=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new Promise((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}i()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}},this.handleGetLocalVideoStats=n=>{n(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=n=>{n(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid],this.handleGetRemoteAudioStats=n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid],this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new fw(e),this.bindStatsUploaderEvents(),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(n=>{n&&(n.iceConnectionState!=="disconnected"&&n.iceConnectionState!=="failed"||this.handleDisconnect(n.direction))})},A("ICE_RESTART_INTERVAL"))}async startP2PConnection(e,t){throw new L(C.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")}async connect(e,t,n,i,r,o){throw new L(C.NOT_SUPPORTED,"p2p mode does not support connect.")}async startP2P(e,t){let n;try{if(t){this.recvConnection&&(f.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),n=await this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new KR(e,this.store,Rn.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);const i=await this.recvConnection.establish(t);return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}{this.state=we.New,this.sendConnection&&(f.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),n=await this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new KR(e,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);const i=await this.sendConnection.establish();return{iceParameters:i.iceParameters,dtlsParameters:i.dtlsParameters,sdp:i.sdp}}}finally{n&&n()}}async p2pConnect(e){if(!this.sendConnection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),await this.sendConnection.connect(e),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=we.Connected}async addRemoteCandidate(e,t){if(t===Rn.RECEIVE_ONLY){if(!this.sendConnection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.sendConnection.addRemoteCandidate(e)}else{if(!this.recvConnection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");await this.recvConnection.addRemoteCandidate(e)}}publish(e,t,n){var i=this;return Wn(function*(){const r=yield ae(i.sendMutex.lock("From P2PChannel.publish"));try{if(!i.sendConnection||i.state!==we.Connected){i.throwIfTrackTypeNotMatch(e);const d=e.filter(l=>i.pendingLocalTracks.indexOf(l)===-1);return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(d))}i.store.pubId=i.store.pubId+1,nn.markPublishStart(i.store.clientId,i.store.pubId);const o=i.filterTobePublishedTracks(e,t,n);if(o.length===0)return void(yield ae(i.tryToUnmuteAudio(e)));o.forEach(d=>{let{track:l,type:u}=d;const h=Date.now();i.store.publish(l.getTrackId(),u===M.LocalAudioTrack?"audio":"video",h)}),i.bindLocalTrackEvents(o);const s=yield ae(i.sendConnection.send(o.map(d=>{let{track:l}=d;return l}),i.store.codec,i.store.audioCodec)),a=(yield ae(s.next())).value,c=i.createGatewayPublishMessage(o,a);try{yield c}catch(d){throw s.throw(d),(d==null?void 0:d.code)===C.WS_ABORT&&o.forEach(l=>{let{track:u}=l;i.pendingLocalTracks.indexOf(u)===-1&&i.pendingLocalTracks.push(u)}),i.unbindLocalTrackEvents(o),d}yield ae(s.next()),o.forEach(d=>{let{type:l}=d;i.statsCollector.addLocalStats(l)}),i.statsUploader.startUploadOutboundStats(),i.assignLocalTracks(o,a),o.forEach(d=>{let{track:l,type:u}=d;const h=Date.now();i.store.publish(l.getTrackId(),u===M.LocalAudioTrack?"audio":"video",void 0,h)}),i.startUploadUplinkState()}finally{r()}})()}async unpublish(e){if(!this.sendConnection||this.state!==we.Connected)return void(e.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!e.includes(r)));const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const n=t.find(r=>r[0]==="videoLowTrack");n&&n[1].track.close();const i=this.createGatewayUnpublishMessage(t);if(await this.sendConnection.stopSending(t.map(r=>{let[,{id:o}]=r;return o})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(r=>{let[o,{track:s}]=r;return{type:o,track:s}})),t.forEach(r=>{let[o]=r;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===we.Connected)return n&&n[1].track.close(),i;e.forEach(r=>{const o=this.pendingLocalTracks.indexOf(r);o!==-1&&this.pendingLocalTracks.splice(o,1)})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);const e=()=>{const t=[],n=[];Array.from(this.localTrackMap.entries()).forEach(i=>{let[r,{track:o,ssrcs:s}]=i;const a={stream_type:FM(o,r),ssrcs:s};o._muted||!o._enabled?t.push(a):n.push(a)}),t.length>0&&t.forEach(i=>{Ue(this,ee.RequestMuteLocal,[i])}),n.length>0&&n.forEach(i=>{Ue(this,ee.RequestUnmuteLocal,[i])})};e(),this.uplinkStateUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(e){return Wn(function*(){throw new L(C.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}async republish(){this.pendingLocalTracks.length>0&&(f.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Tt(this,ee.RequestRePublish,this.pendingLocalTracks),this.emit(ee.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])}async unpublishLowStream(){throw new L(C.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")}async subscribe(e,t,n,i){var r;if(!this.recvConnection)throw new L(C.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(e))!==null&&r!==void 0&&r.has(t))return;const{track:o,mid:s,transceiver:a}=await this.recvConnection.receive(t,[{ssrcId:n}],String(e.uid),i);t===z.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(o):(e._audioTrack=new Fc(o,e.uid,e._uintid,this.store),f.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),a&&e._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoSSRC=n,e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(o):(e._videoTrack=new Vc(o,e.uid,e._uintid,this.store),f.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),a&&e._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(e,e._videoTrack));const c=this.remoteUserMap.get(e);c?c.set(t,s):this.remoteUserMap.set(e,new Map([[t,s]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();const d=this.pendingRemoteTracks.findIndex(l=>{let{user:u,kind:h}=l;return u.uid===e.uid&&t===h});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(ee.MediaReconnectEnd,e.uid))}async mockSubscribe(e,t,n,i){if(!this.recvConnection)throw new L(C.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");await this.recvConnection.mockReceive(t,[{ssrcId:n}],String(e.uid),i)}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter(o=>{let{user:s,kind:a}=o;return t!==void 0?s.uid===e.uid&&t===a:s.uid===e.uid});if(i.forEach(o=>{const s=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(s,1)}),this.recvConnection||n||i.forEach(o=>{let{kind:s}=o;var a;if(s===z.AUDIO)(a=e._audioTrack)===null||a===void 0||a._destroy(),e._audioTrack=void 0;else if(s===z.VIDEO){var c;(c=e._videoTrack)===null||c===void 0||c._destroy(),e._videoTrack=void 0}}),!this.recvConnection)return;const r=this.filterTobeUnSubscribedTracks(e,t);r.length!==0&&(await this.recvConnection.stopReceiving(r.map(o=>{let[,{id:s}]=o;return s})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(o=>{let[s,{kind:a}]=o;var c,d;if(a===z.VIDEO&&s._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),a===z.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),n||((d=s._videoTrack)===null||d===void 0||d._destroy(),s._videoTrack=void 0);else if(a===z.AUDIO){var l;this.unbindRemoteTrackEvents(s._audioTrack),!n&&((l=s._audioTrack)===null||l===void 0||l._destroy(),s._audioTrack=void 0)}}),r.forEach(o=>{let[,{kind:s}]=o;Ue(this,ee.RequestP2PMuteRemote,s)}))}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);const e=()=>Array.from(this.remoteUserMap.entries()).forEach(t=>{let[,n]=t;[z.VIDEO,z.AUDIO].forEach(i=>{n.has(i)?Ue(this,ee.RequestP2PUnmuteRemote,i):Ue(this,ee.RequestP2PMuteRemote,i)})});e(),this.downlinkStatsUploadInterval=window.setInterval(()=>{e()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}async massSubscribe(e){throw new L(C.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")}async massSubscribeNoLock(e){throw new L(C.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")}async massUnsubscribe(e){throw new L(C.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")}async massUnsubscribeNoLock(e){throw new L(C.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")}async muteRemote(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void f.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void f.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===z.VIDEO?e._videoSSRC:e._audioSSRC;i!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.recvConnection)return;const n=this.remoteUserMap.get(e);if(!n)return void f.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(t)||f.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){const t=this.localTrackMap.get(M.LocalAudioTrack);if((t==null?void 0:t.track)instanceof Ot){const n=t.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==M.LocalAudioTrack}).filter(i=>{let[r]=i;return!(e&&r===M.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[i]=n;return!(e&&i===M.LocalVideoLowTrack)}).map(n=>{let[,{track:i}]=n;return i})}reportPublishEvent(e,t,n,i,r){if(e){const s=this.localTrackMap.get(M.LocalAudioTrack),a=i?this.localTrackMap.get(M.LocalVideoLowTrack):this.localTrackMap.get(M.LocalVideoTrack);q.publish(this.store.sessionId,{eventElapse:nn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(je.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const s=n.find(c=>c instanceof St),a=i?(o=this.localTrackMap.get(M.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(c=>c instanceof Ge);q.publish(this.store.sessionId,{eventElapse:nn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:s==null?void 0:s.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(je.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===z.VIDEO?n._videoSSRC:n._audioSSRC;r&&q.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===z.VIDEO,audio:i===z.AUDIO,peerid:n.uid,subscribeRequestid:i===z.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:nn.measureFromSubscribeStart(this.store.clientId,r)})}reset(){f.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new Bt("P2PChannel2-send-mutex"),this.sendMutex=new Bt("P2PChannel2-recv-mutex"),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(M.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Ot){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach(n=>{t.removeAudioTrack(n)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=we.Disconnected}getStats(e){var t,n;return e?(n=this.recvConnection)===null||n===void 0?void 0:n.getStats():(t=this.sendConnection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.recvConnection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(M.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(M.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof Ge||t&&t.track instanceof St?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find(n=>n.uid===e);return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}});const t=this.localTrackMap.get(M.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort((n,i)=>n.level-i.level),e}async disconnectForReconnect(){this.sendConnection&&this.recvConnection&&(f.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=we.Reconnecting,A("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&((n=t._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:n}]=e;switch(t){case M.LocalVideoTrack:n._hints.includes(je.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case M.LocalAudioTrack:n instanceof Ot?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case M.LocalVideoLowTrack:}}),this.emit(ee.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,n]=e;Array.from(n.keys()).forEach(i=>{this.setPendingRemoteMedia(t,i)}),this.emit(ee.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),f.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof ho?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}async restartICE(e,t){let n,i;if(e===Rn.SEND_ONLY){if(!this.sendConnection)throw new L(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");n=await this.sendMutex.lock("From P2PChannel.restartICE"),i=this.sendConnection}else{if(!this.recvConnection)throw new L(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");n=await this.recvMutex.lock("From P2PChannel.restartICE"),i=this.recvConnection}try{if(t){const r=await i.restartICE(t);return i.isInRestartIce=!1,r}{const r=await i.restartICE();if(r){const o=await Tt(this,ee.RequestP2PRestartICE,{direction:Rn.RECEIVE_ONLY,iceParameter:r});await i.restartICE(o),i.isInRestartIce=!1}}}finally{n()}}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;const e=this.sendConnection.getStats(),t=this.localTrackMap.get(M.LocalVideoTrack),n=this.localTrackMap.get(M.LocalAudioTrack),i=e.videoSend.find(p=>{var m;return p.ssrc===(t==null||(m=t.ssrcs)===null||m===void 0?void 0:m[0].ssrcId)}),r=e.audioSend.find(p=>{var m;return p.ssrc===(n==null||(m=n.ssrcs)===null||m===void 0?void 0:m[0].ssrcId)});if(!i||!r)return 1;const o=Gn(this,ee.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=t==null?void 0:t.track;if(h&&h._encoderConfig&&h._hints.indexOf(je.SCREEN_TRACK)===-1){const p=h._encoderConfig.bitrateMax,m=e.bitrate.actualEncoded;if(p&&m){const E=(1e3*p-m)/(1e3*p);return Z0[E<.15?0:E<.3?1:E<.45?2:E<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;const e=this.recvConnection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[i]=n;const r=i._audioSSRC,o=i._videoSSRC,s=e.audioRecv.find(m=>m.ssrc===r),a=e.videoRecv.find(m=>m.ssrc===o);if(!s&&!a)return void(t+=1);const c=Gn(this,ee.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=e.recvPacketLossRate;let p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise((t,n)=>{this.handleMuteLocalTrack(e,t,n)})}filterTobePublishedTracks(e,t,n){const i=[],r=ge(),o=this.getAllTracks();e=e.filter(c=>o.indexOf(c)===-1),e=na(e);let s=!1,a=!1;for(const c of e){if(c instanceof Ge&&(this.localTrackMap.has(M.LocalVideoTrack)||s?new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:M.LocalVideoTrack}),s=!0),t)){const d=this.getLowVideoTrack(c,n);i.push({track:d,type:M.LocalVideoLowTrack})}if(c instanceof St){const d=this.localTrackMap.get(M.LocalAudioTrack);if(d){if(!(d.track instanceof Ot))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){const l=i.find(u=>{let{type:h}=u;return h===M.LocalAudioTrack});if(!(l.track instanceof Ot))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof Ot||c._bypassWebAudio)i.push({track:c,type:M.LocalAudioTrack});else{const l=new Ot;l.addAudioTrack(c),i.push({track:l,type:M.LocalAudioTrack})}a=!0}}}return i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=e.filter(i=>n.indexOf(i)!==-1),e=na(e);for(const i of e){if(i instanceof St){const r=this.localTrackMap.get(M.LocalAudioTrack);if(!r)continue;r.track instanceof Ot?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(t.push([M.LocalAudioTrack,r]),r.track.close())):t.push([M.LocalAudioTrack,r])}if(i instanceof Ge){const r=this.localTrackMap.get(M.LocalVideoTrack);if(!r)continue;t.push([M.LocalVideoTrack,r]);const o=this.localTrackMap.get(M.LocalVideoLowTrack);o&&t.push([M.LocalVideoLowTrack,o])}}return t}bindLocalTrackEvents(e){e.forEach(t=>{let{track:n,type:i}=t;switch(i){case M.LocalVideoTrack:n.addListener(W.GET_STATS,this.handleGetLocalVideoStats),n.addListener(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(W.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(W.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(W.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case M.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case M.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof Ot?e.trackList.forEach(n=>{n.addListener(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(W.GET_STATS,this.handleGetLocalAudioStats),n.addListener(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(W.GET_STATS,this.handleGetLocalAudioStats),e.addListener(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||e.addListener(W.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[n,{track:i}]=t;return{track:i,type:n}})),e.forEach(t=>{let{track:n,type:i}=t;switch(i){case M.LocalVideoTrack:n.off(W.GET_STATS,this.handleGetLocalVideoStats),n.off(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(W.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(W.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(W.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case M.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case M.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof Ot?e.trackList.forEach(t=>{t.off(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(W.GET_STATS,this.handleGetLocalAudioStats),t.off(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(W.GET_STATS,this.handleGetLocalAudioStats),e.off(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(W.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Vc&&t.addListener(W.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(e))}),t instanceof Fc&&t.addListener(W.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(W.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,n]=e;n.has(z.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(z.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((n,i)=>{let r,{track:o,type:s}=n;switch(s){case M.LocalAudioTrack:r=ve.Audio;break;case M.LocalVideoTrack:r=o._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High;break;case M.LocalVideoLowTrack:r=ve.Low}return{kind:s===M.LocalAudioTrack?z.AUDIO:z.VIDEO,stream_type:r,mid:t[i].id,ssrcs:t[i].localSSRC,isMuted:o.muted||!o.enabled}})}createGatewayUnpublishMessage(e){return e.map(t=>{let n,[i,{track:r,ssrcs:o,id:s}]=t;switch(i){case M.LocalVideoTrack:n=r._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High;break;case M.LocalAudioTrack:n=ve.Audio;break;case M.LocalVideoLowTrack:n=ve.Low}return{stream_type:n,ssrcs:o,mid:s}})}assignLocalTracks(e,t){e.forEach((n,i)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:t[i].id,ssrcs:t[i].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[n]=t;this.localTrackMap.delete(n)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(e.name,".onConnectionStateChange(").concat(t,")")),this.emit(ee.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(e.isInRestartIce=!1),this._restartStates.includes(t)&&!e.isInRestartIce&&(t==="disconnected"&&await Pt(800),e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="failed"||this.handleDisconnect(e.direction))},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),q.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:bt.TRACER}).onSuccess(),this.emit(ee.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{const n=Array.from(this.remoteUserMap.keys()).find(r=>r._audioSSRC===t);var i;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(i=n.audioTrack)===null||i===void 0||i.emit(_a.FIRST_FRAME_DECODED),q.firstRemoteFrame(this.store.sessionId,xt.FIRST_AUDIO_DECODE,Qe.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:nn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{const n=Array.from(this.remoteUserMap.keys()).find(i=>i._audioSSRC===t);n&&q.firstRemoteFrame(this.store.sessionId,xt.FIRST_AUDIO_RECEIVED,Qe.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:nn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,n,i)=>{this.reportVideoFirstFrameDecoded(t,n,i)},e.onFirstVideoReceived=t=>{const n=Array.from(this.remoteUserMap.keys()).find(i=>i._videoSSRC===t);n&&q.firstRemoteFrame(this.store.sessionId,xt.FIRST_VIDEO_RECEIVED,Qe.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:nn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,n)=>{const i=t.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(ee.ConnectionTypeChange,i),f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(So(n))," -> ").concat(JSON.stringify(So(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,n)=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(So(n))," -> ").concat(JSON.stringify(So(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.onLocalCandidate=t=>{this.emit(ee.LocalCandidate,{candidate:t,direction:e.direction})}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.onLocalCandidate=void 0}async handleDisconnect(e){const t=e===Rn.SEND_ONLY?this.sendConnection:this.recvConnection;t&&!t.isInRestartIce&&(t.isInRestartIce=!0,f.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(t.name,"] start use restartICE")),e===Rn.SEND_ONLY?this.restartICE(e):Tt(this,ee.RequestP2PRestartICE,{direction:Rn.SEND_ONLY}))}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const n=this.localTrackMap.get(M.LocalAudioTrack);if(e instanceof St&&(n==null?void 0:n.track)instanceof Ot)return n.track.isActive||t.push([M.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return e===o});if(i&&(t.push(i),i[0]===M.LocalVideoTrack)){const r=this.localTrackMap.get(M.LocalVideoLowTrack);r&&t.push([M.LocalVideoLowTrack,r])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(M.LocalAudioTrack);if(e instanceof St&&(n==null?void 0:n.track)instanceof Ot)return n.track.isActive&&t.push([M.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return e===o});if(i)if(i[0]===M.LocalVideoTrack){t.push(i);const r=this.localTrackMap.get(M.LocalVideoLowTrack);r&&t.push([M.LocalVideoLowTrack,r])}else t.push(i);return t}createMuteMessage(e){return e.map(t=>{let n,[i,{track:r,ssrcs:o,id:s}]=t;switch(i){case M.LocalAudioTrack:n=ve.Audio;break;case M.LocalVideoTrack:n=r._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High;break;case M.LocalVideoLowTrack:n=ve.Low}return{stream_type:n,ssrcs:o,mid:s}})}createUnmuteMessage(e){return e.map(t=>{let n,[i,{track:r,ssrcs:o,id:s}]=t;switch(i){case M.LocalAudioTrack:n=ve.Audio;break;case M.LocalVideoTrack:n=r._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High;break;case M.LocalVideoLowTrack:n=ve.Low}return{stream_type:n,ssrcs:o,mid:s}})}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;n.push([e,{kind:o,id:s}])});return n}createUnsubscribeMessage(e){const t=[];return e.forEach(n=>{let[i,{kind:r,id:o}]=n;switch(r){case z.VIDEO:return void(i._videoSSRC&&t.push({stream_type:z.VIDEO,ssrcId:i._videoSSRC}));case z.AUDIO:return void(i._audioSSRC&&t.push({stream_type:z.AUDIO,ssrcId:i._audioSSRC}))}}),t}withdrawRemoteTracks(e){e.forEach(t=>{let[n,{kind:i}]=t;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(e){const t=this.localTrackMap.get(M.LocalVideoTrack),n=this.localTrackMap.get(M.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),n&&e.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){const e=this.sendConnection.peerConnectionState,t=this.recvConnection.peerConnectionState;return e!=="connected"&&t!=="connected"}return!0}async tryToUnmuteAudio(e){for(let t=0;t<e.length;t++)if(e[t]instanceof St){const n=this.filterTobeUnmutedTracks(e[t]);if(n.length===0)continue;const i=this.createUnmuteMessage(n);return void await Ue(this,ee.RequestUnmuteLocal,i)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=e=>this.getStats(e),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(e=>{let[,{ssrcs:t}]=e;return!!t}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.recvConnection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(ee.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(ee.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Pt(_h(this.dtlsFailedCount,_t)),this.emit(ee.RequestReconnect)}async reconnectP2P(){}canPublishLowStream(){return this.localTrackMap.has(M.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof Ge)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof Ge).length>1)throw new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof St).length>1&&(e.some(t=>t instanceof St&&t._bypassWebAudio)||!ge().webAudioMediaStreamDest))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof Ge&&this.pendingLocalTracks.some(n=>n instanceof Ge))throw new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof St&&this.pendingLocalTracks.some(n=>n instanceof St)&&(!ge().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof St&&n._bypassWebAudio)))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&ge().supportDualStreamEncoding,i=F(F({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=n?e._mediaStreamTrack.clone():Of(e,i);const o=et(8,"track-low-"),s=new Ge(r,F(F({},n&&{scaleResolutionDownBy:wf(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(ls.TRANSCEIVER_UPDATED,a=>{e._updateRtpTransceiver(a,ba.LOW_STREAM)}),s._hints.push(je.LOW_STREAM),e.addListener(W.NEED_CLOSE,()=>{s.close()}),s}async globalLock(){return this.recvMutex.lock("From P2PChannel2.globalLock")}reportVideoFirstFrameDecoded(e,t,n,i){const r=Array.from(this.remoteUserMap.keys()).find(o=>o._videoSSRC===e);if(r){i||this.store.subscribe(r.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,s=o.subscribe.find(a=>a.userId===r.uid&&a.type==="video");q.firstRemoteVideoDecode(this.store.sessionId,xt.FIRST_VIDEO_DECODE,Qe.FIRST_VIDEO_DECODE,{peer:r._uintid,videowidth:t,videoheight:n,subscribeElapse:nn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:(s==null?void 0:s.subscribeEnd)||0,subscriberStart:(s==null?void 0:s.subscribeStart)||0,videoAddNotify:(s==null?void 0:s.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.recvConnection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const o=await this.recvConnection.getRemoteSSRC(r);return o!==void 0&&o!==n}resetConnection(e){f.debug("[".concat(this.store.clientId,"] [P2PChannel2] reset connection to ").concat(e)),this.state===we.Connected?(f.debug("[".concat(this.store.clientId,"] [P2PChannel2] fallback to websocket but P2PChannel2 state still connected, disconnect first")),this.disconnectForReconnect()):(this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0))}async publishDataChannel(e){throw new L(C.NOT_SUPPORTED)}async unpublishDataChannel(e){throw new L(C.NOT_SUPPORTED)}async subscribeDataChannel(e,t){throw new L(C.NOT_SUPPORTED)}async unsubscribeDataChannel(e,t){throw new L(C.NOT_SUPPORTED)}hasPendingRemoteDataChannel(e,t){throw new L(C.NOT_SUPPORTED)}setPendingRemoteDataChannel(e,t){throw new L(C.NOT_SUPPORTED)}async preConnect(e,t,n,i,r,o){throw new L(C.NOT_SUPPORTED)}getEstablishParams(){throw new L(C.NOT_SUPPORTED)}async reSubscribe(e){throw new L(C.NOT_SUPPORTED)}async updateVideoStreamParameter(e,t){throw new L(C.NOT_SUPPORTED)}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:n}]=e;t===M.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,ba.LOW_STREAM):n._updateRtpTransceiver(void 0)})}}).prototype,"p2pConnect",[$R],Object.getOwnPropertyDescriptor(Xe.prototype,"p2pConnect"),Xe.prototype),B(Xe.prototype,"unpublish",[qR],Object.getOwnPropertyDescriptor(Xe.prototype,"unpublish"),Xe.prototype),B(Xe.prototype,"unpublishLowStream",[JR],Object.getOwnPropertyDescriptor(Xe.prototype,"unpublishLowStream"),Xe.prototype),B(Xe.prototype,"subscribe",[XR],Object.getOwnPropertyDescriptor(Xe.prototype,"subscribe"),Xe.prototype),B(Xe.prototype,"mockSubscribe",[QR],Object.getOwnPropertyDescriptor(Xe.prototype,"mockSubscribe"),Xe.prototype),B(Xe.prototype,"unsubscribe",[ZR],Object.getOwnPropertyDescriptor(Xe.prototype,"unsubscribe"),Xe.prototype),B(Xe.prototype,"muteRemote",[eC],Object.getOwnPropertyDescriptor(Xe.prototype,"muteRemote"),Xe.prototype),B(Xe.prototype,"unmuteRemote",[tC],Object.getOwnPropertyDescriptor(Xe.prototype,"unmuteRemote"),Xe.prototype),B(Xe.prototype,"hasRemoteMediaWithLock",[nC],Object.getOwnPropertyDescriptor(Xe.prototype,"hasRemoteMediaWithLock"),Xe.prototype),B(Xe.prototype,"disconnectForReconnect",[iC],Object.getOwnPropertyDescriptor(Xe.prototype,"disconnectForReconnect"),Xe.prototype),B(Xe.prototype,"remoteMediaSsrcChanged",[rC],Object.getOwnPropertyDescriptor(Xe.prototype,"remoteMediaSsrcChanged"),Xe.prototype),Xe);function ji(e){return function(t,n,i){const r=t[n];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return i.value=async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];switch(e){case Ki.SEND_ONLY:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c()}}case Ki.RECEIVE_ONLY:{const c=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c()}}default:{const c=await this.sendMutex.lock("From P2PChannel2.".concat(n)),d=await this.recvMutex.lock("From P2PChannel2.".concat(n));try{return await r.apply(this,s)}finally{c(),d()}}}},i}}class Cd{constructor(t){this.store=void 0,this.onStatsException=void 0,this.onUploadPublishDuration=void 0,this.onStatsChanged=void 0,this.localStats=new Map,this.remoteStats=new Map,this.updateStatsInterval=void 0,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0,this.exceptionMonitor=void 0,this.p2pChannel=void 0,this.scalabilityMode=cM.L1T1,this.updateStats=()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))},this.store=t,this.exceptionMonitor=new MM,this.exceptionMonitor.on("exception",(n,i,r)=>{this.onStatsException&&this.onStatsException(n,i,r)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(M.LocalAudioTrack)||F({},Cf)}getLocalVideoTrackStats(){return this.localStats.get(M.LocalVideoTrack)||F({},vf)}getRemoteAudioTrackStats(t){const n=(o,s)=>{if(!this.trafficStats)return s;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},i={};if(t){var r;const o=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.audioStats;o&&(i[t]=n(t,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:a}]=o;a&&(i[s]=n(s,a))});return i}getRemoteNetworkQualityStats(t){const n={};if(t){var i;const r=(i=this.remoteStats.get(t))===null||i===void 0?void 0:i.networkStats;r&&(n[t]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{networkStats:s}]=r;s&&(n[o]=s)});return n}getRemoteVideoTrackStats(t){const n=(o,s)=>{if(!this.trafficStats)return s;const a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},i={};if(t){var r;const o=(r=this.remoteStats.get(t))===null||r===void 0?void 0:r.videoStats;o&&(i[t]=n(t,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:a}]=o;a&&(i[s]=n(s,a))});return i}getRTCStats(){let t=0,n=0,i=0,r=0;const o=this.localStats.get(M.LocalAudioTrack);o&&(t+=o.sendBytes,n+=o.sendBitrate);const s=this.localStats.get(M.LocalVideoTrack);s&&(t+=s.sendBytes,n+=s.sendBitrate);const a=this.localStats.get(M.LocalVideoLowTrack);a&&(t+=a.sendBytes,n+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:l,videoStats:u}=d;l&&(i+=l.receiveBytes,r+=l.receiveBitrate),u&&(i+=u.receiveBytes,r+=u.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:n,SendBytes:t,RecvBytes:i,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(t){this.localStats.set(t,void 0)}removeLocalStats(t){t?this.localStats.delete(t):this.localStats.clear()}addRemoteStats(t){this.remoteStats.set(t,{})}removeRemoteStats(t){t?this.remoteStats.delete(t):this.remoteStats.clear()}addP2PChannel(t){this.p2pChannel=t}updateTrafficStats(t){t.peer_delay=t.peer_delay.filter(n=>n.B_ppad!==void 0||n.B_ppvd!==void 0),t.peer_delay.filter(n=>this.trafficStatsPeerList.indexOf(n.peer_uid)===-1).forEach(n=>{var i;const r=(i=this.p2pChannel)===null||i===void 0?void 0:i.getRemoteMedia(n.peer_uid),o=r!=null&&r.videoSSRC?nn.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,s=r!=null&&r.audioSSRC?nn.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;n.B_ppad!==void 0&&n.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(n.peer_uid,n.B_ppad,n.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(n.peer_uid))}),this.trafficStats=t}updateUplinkStats(t){this.uplinkStats&&this.uplinkStats.B_fir!==t.B_fir&&f.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(t.B_fir)),this.uplinkStats=t}static isRemoteVideoFreeze(t,n,i){if(!t)return!1;const r=!!i&&n.framesDecodeFreezeTime>i.framesDecodeFreezeTime,o=!i||n.framesDecodeCount>i.framesDecodeCount;return r||!o}static isRemoteAudioFreeze(t){return!!t&&t._isFreeze()}isLocalVideoFreeze(t){return!(!t.inputFrame||!t.sentFrame)&&t.inputFrame.frameRate>5&&t.sentFrame.frameRate<3}updateLocalStats(t){Array.from(this.localStats.entries()).forEach(n=>{let[i,r]=n;switch(i){case M.LocalVideoTrack:case M.LocalVideoLowTrack:{const s=r,a=F({},vf),c=t.getStats(),d=t.getLocalMedia(i);if(c){const l=c.videoSend.find(u=>u.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(l){const u=t.getLocalVideoSize(),h=t.getEncoderConfig(M.LocalVideoTrack);l.codec!=="H264"&&l.codec!=="H265"&&l.codec!=="VP8"&&l.codec!=="VP9"&&l.codec!=="AV1X"&&l.codec!=="AV1"||(a.codecType=l.codec),a.sendBytes=l.bytes,a.sendBitrate=s?8*Math.max(0,a.sendBytes-s.sendBytes):0,l.inputFrame?(a.captureFrameRate=l.inputFrame.frameRate,a.captureResolutionHeight=l.inputFrame.height,a.captureResolutionWidth=l.inputFrame.width):u&&(a.captureResolutionWidth=u.width,a.captureResolutionHeight=u.height),l.sentFrame?(a.sendFrameRate=l.sentFrame.frameRate,a.sendResolutionHeight=l.sentFrame.height,a.sendResolutionWidth=l.sentFrame.width):u&&(a.sendResolutionWidth=u.width,a.sendResolutionHeight=u.height),l.avgEncodeMs&&(a.encodeDelay=l.avgEncodeMs),h&&h.bitrateMax&&(a.targetSendBitrate=1e3*h.bitrateMax),a.sendPackets=l.packets,a.sendPacketsLost=l.packetsLost,a.sendJitterMs=l.jitterMs,a.sendRttMs=l.rttMs,a.totalDuration=s?s.totalDuration+1:1,a.totalFreezeTime=s?s.totalFreezeTime:0,this.isLocalVideoFreeze(l)&&(a.totalFreezeTime+=1),l.scalabilityMode&&this.scalabilityMode!==l.scalabilityMode&&(f.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(l.scalabilityMode)),this.scalabilityMode=l.scalabilityMode)}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var o;this.localStats.set(i,a),((s==null?void 0:s.sendResolutionWidth)!==a.sendResolutionWidth||(s==null?void 0:s.sendResolutionHeight)!==a.sendResolutionHeight)&&((o=this.onStatsChanged)===null||o===void 0||o.call(this,"resolution",{width:a.sendResolutionWidth,height:a.sendResolutionHeight})),a&&d&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,d.track,a);break}case M.LocalAudioTrack:{const s=r,a=F({},Cf),c=t.getStats(),d=t.getLocalMedia(i);if(c){const l=c.audioSend.find(u=>u.ssrc===(d==null?void 0:d.ssrcs[0].ssrcId));if(l){if(l.codec!=="opus"&&l.codec!=="aac"&&l.codec!=="PCMU"&&l.codec!=="PCMA"&&l.codec!=="G722"||(a.codecType=l.codec),l.inputLevel)a.sendVolumeLevel=Math.round(32767*l.inputLevel);else{const u=t.getLocalAudioVolume();u&&(a.sendVolumeLevel=Math.round(32767*u))}a.sendBytes=l.bytes,a.sendPackets=l.packets,a.sendPacketsLost=l.packetsLost,a.sendJitterMs=l.jitterMs,a.sendRttMs=l.rttMs,a.sendBitrate=s?8*Math.max(0,a.sendBytes-s.sendBytes):0}}this.trafficStats&&(a.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(M.LocalAudioTrack,a),a&&d&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,d.track,a);break}}})}updateRemoteStats(t){Array.from(this.remoteStats.entries()).forEach(n=>{var i,r;let[o,{videoStats:s,audioStats:a,videoPcStats:c}]=n;const d=a,l=s,u=c,h=F({},w0),p=F({},N0),m=F({},P1),{audioTrack:E,videoTrack:g,audioSSRC:S,videoSSRC:T}=t.getRemoteMedia(o);let I;I=t instanceof Vn?t.getStats(!0):t.getStats();const y=(i=I)===null||i===void 0?void 0:i.audioRecv.find(O=>O.ssrc===S),w=(r=I)===null||r===void 0?void 0:r.videoRecv.find(O=>O.ssrc===T),D=this.trafficStats&&this.trafficStats.peer_delay.find(O=>O.peer_uid===o);if(y&&(y.codec!=="opus"&&y.codec!=="aac"&&y.codec!=="PCMU"&&y.codec!=="PCMA"&&y.codec!=="G722"||(h.codecType=y.codec),y.outputLevel?h.receiveLevel=Math.round(32767*y.outputLevel):E&&(h.receiveLevel=Math.round(32767*E.getVolumeLevel())),h.receiveBytes=y.bytes,h.receivePackets=y.packets,h.receivePacketsLost=y.packetsLost,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=d?8*Math.max(0,h.receiveBytes-d.receiveBytes):0,h.totalDuration=d?d.totalDuration+1:1,h.totalFreezeTime=d?d.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=y.jitterBufferMs,h.totalDuration>10&&Cd.isRemoteAudioFreeze(E)&&(h.totalFreezeTime+=1)),w){w.codec!=="H264"&&w.codec!=="H265"&&w.codec!=="VP8"&&w.codec!=="VP9"&&w.codec!=="AV1X"&&w.codec!=="AV1"||(p.codecType=w.codec),p.receiveBytes=w.bytes,p.receiveBitrate=l?8*Math.max(0,p.receiveBytes-l.receiveBytes):0,p.decodeFrameRate=w.decodeFrameRate<0?0:w.decodeFrameRate,p.renderFrameRate=w.decodeFrameRate<0?0:w.decodeFrameRate,w.outputFrame&&(p.renderFrameRate=w.outputFrame.frameRate),w.receivedFrame?(p.receiveFrameRate=w.receivedFrame.frameRate,p.receiveResolutionHeight=w.receivedFrame.height,p.receiveResolutionWidth=w.receivedFrame.width):g&&(p.receiveResolutionHeight=g._videoHeight||0,p.receiveResolutionWidth=g._videoWidth||0),w.framesRateFirefox!==void 0&&(p.receiveFrameRate=Math.round(w.framesRateFirefox)),p.receivePackets=w.packets,p.receivePacketsLost=w.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost),p.totalDuration=l?l.totalDuration+1:1,p.totalFreezeTime=l?l.totalFreezeTime:0,p.receiveDelay=w.jitterBufferMs||0;const O=!!T&&t.getRemoteVideoIsReady(T);g&&O&&Cd.isRemoteVideoFreeze(g,w,u)&&(p.totalFreezeTime+=1),p.freezeRate=p.totalFreezeTime/p.totalDuration}D&&(h.end2EndDelay=D.B_ad,p.end2EndDelay=D.B_vd,h.transportDelay=D.B_ed,p.transportDelay=D.B_ed,h.currentPacketLossRate=D.B_ealr4/100,p.currentPacketLossRate=D.B_evlr4/100,m.uplinkNetworkQuality=D.B_punq?D.B_punq:0,m.downlinkNetworkQuality=D.B_pdnq?D.B_pdnq:0),this.remoteStats.set(o,{audioStats:h,videoStats:p,videoPcStats:w,networkStats:m}),E&&this.exceptionMonitor.setRemoteAudioStats(E,h),g&&this.exceptionMonitor.setRemoteVideoStats(g,p)})}}class BM extends qe{constructor(t,n,i,r){super(),this.spec=void 0,this.token=void 0,this.websocket=void 0,this.pingpongTimer=void 0,this.reconnectMode="retry",this.serviceMode=void 0,this.reqId=0,this.commandReqId=0,this.handleWebSocketOpen=()=>{this.reconnectMode="retry",this.startPingPong()},this.handleWebSocketMessage=o=>{if(!o.data)return;const s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):this.serviceMode===Vt.INJECT?this.emit(fr.INJECT_STREAM_STATUS,s):(q.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===Vt.TRANSCODE?1:2}),this.emit(fr.PUBLISH_STREAM_STATUS,s))},this.spec=n,this.token=t,this.serviceMode=r,this.websocket=new Ed("live-streaming",i),this.websocket.on(ne.CONNECTED,this.handleWebSocketOpen),this.websocket.on(ne.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(ne.REQUEST_NEW_URLS,(o,s)=>{Tt(this,fr.REQUEST_NEW_ADDRESS).then(o).catch(s)}),this.websocket.on(ne.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(t){return this.websocket.init(t)}async request(t,n,i,r){this.reqId+=1,t==="request"&&(this.commandReqId+=1);const o=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new N(C.UNEXPECTED_ERROR);const a=F({command:t,sdkVersion:fi==="4.21.0"?"0.0.1":fi,seq:s,requestId:s,allocate:i,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},n);if(this.websocket.state==="closed")throw new N(C.WS_DISCONNECT);const c=()=>new Promise((h,p)=>{this.websocket.once(ne.CLOSED,()=>p(new N(C.WS_ABORT))),this.websocket.once(ne.CONNECTED,h)});this.websocket.state!=="connected"&&await c(),a.clientRequest&&(a.clientRequest.workerToken=this.token);const d=new Promise((h,p)=>{const m=()=>{p(new N(C.WS_ABORT))};this.websocket.once(ne.RECONNECTING,m),this.websocket.once(ne.CLOSED,m),this.once("@".concat(s,"-").concat(this.spec.sid),E=>{h(E)})});r&&q.workerEvent(this.spec.sid,F(F({},r),{},{requestId:o,actionType:"request",payload:JSON.stringify(n.clientRequest),serverCode:0,code:0}));const l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=await d}catch(h){if(this.websocket.state==="closed")throw h;return await c(),await this.request(t,n,i)}return r&&q.workerEvent(this.spec.sid,F(F({},r),{},{requestId:o,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:u.code===200,responseTime:Date.now()-l})),u.code!==200&&this.handleResponseError(u),u}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){const t=fi==="4.21.0"?"0.0.1":fi;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:t,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(t){switch(t.code){case Rt.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void f.warning("live stream response already exists stream");case Rt.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case Rt.LIVE_STREAM_RESPONSE_BAD_STREAM:case Rt.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new N(C.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:t.code}).throw();case Rt.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new N(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Rt.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new N(C.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:t.code}).throw();case Rt.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const n=new N(C.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(fr.WARNING,n,t.serverResponse.url)}case Rt.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{const n=new N(C.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(fr.WARNING,n,t.serverResponse.url)}case Rt.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new N(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case Rt.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new N(C.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:t.code}).throw();case Rt.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{const n=new N(C.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(fr.WARNING,n,t.serverResponse.url)}case Rt.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new N(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code}).throw();case Rt.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new N(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case Rt.LIVE_STREAM_RESPONSE_WORKER_LOST:case Rt.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;throw new N(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Rt.ERROR_FAIL_SEND_MESSAGE:if(t.serverResponse.command==="UnpublishStream"||t.serverResponse.command==="UninjectStream")return;if(t.serverResponse.command==="UpdateTranscoding"||t.serverResponse.command==="ControlStream")return new N(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:t.code}).throw();throw new N(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case Rt.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Rt.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Rt.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Rt.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new N(C.LIVE_STREAMING_CDN_ERROR,"",{code:t.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(ph)},6e3)}}class GM extends qe{constructor(t){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:_t,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:_t;super(),this.onLiveStreamWarning=void 0,this.onLiveStreamError=void 0,this.onInjectStatusChange=void 0,this.spec=void 0,this.retryTimeout=1e4,this.connection=void 0,this.httpRetryConfig=void 0,this.wsRetryConfig=void 0,this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.taskMutex=new Bt("live-streaming"),this.cancelToken=Un.CancelToken.source(),this.transcodingConfig=void 0,this.injectConfig=F({},uM),this.injectLoopTimes=0,this.uapResponse=void 0,this.lastTaskId=1,this.statusError=new Map,this.spec=t,this.httpRetryConfig=i,this.wsRetryConfig=n}async setTranscodingConfig(t){const n=F(F({},lM),t);n.videoCodecProfile!==66&&n.videoCodecProfile!==77&&n.videoCodecProfile!==100&&(f.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(n.videoCodecProfile," -> 100")),n.videoCodecProfile=100),n.transcodingUsers||(n.transcodingUsers=n.userConfigs),n.transcodingUsers&&(n.transcodingUsers=n.transcodingUsers.map(o=>F(F(F({},dM),o),{},{zOrder:o.zOrder?o.zOrder+1:1}))),function(o){tt(o.width)||De(o.width,"config.width",0,1e4),tt(o.height)||De(o.height,"config.height",0,1e4),tt(o.videoBitrate)||De(o.videoBitrate,"config.videoBitrate",1,1e6),tt(o.videoFrameRate)||De(o.videoFrameRate,"config.videoFrameRate"),tt(o.lowLatency)||Fr(o.lowLatency,"config.lowLatency"),tt(o.audioSampleRate)||Xt(o.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),tt(o.audioBitrate)||De(o.audioBitrate,"config.audioBitrate",1,128),tt(o.audioChannels)||Xt(o.audioChannels,"config.audioChannels",[1,2,3,4,5]),tt(o.videoGop)||De(o.videoGop,"config.videoGop"),tt(o.videoCodecProfile)||Xt(o.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),tt(o.userCount)||De(o.userCount,"config.userCount",0,17),tt(o.backgroundColor)||De(o.backgroundColor,"config.backgroundColor",0,16777215),tt(o.userConfigExtraInfo)||jt(o.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),o.transcodingUsers&&!tt(o.transcodingUsers)&&(Mr(o.transcodingUsers,"config.transcodingUsers"),o.transcodingUsers.forEach((s,a)=>{Th(s.uid),tt(s.x)||De(s.x,"transcodingUser[".concat(a,"].x"),0,1e4),tt(s.y)||De(s.y,"transcodingUser[".concat(a,"].y"),0,1e4),tt(s.width)||De(s.width,"transcodingUser[".concat(a,"].width"),0,1e4),tt(s.height)||De(s.height,"transcodingUser[".concat(a,"].height"),0,1e4),tt(s.zOrder)||De(s.zOrder-1,"transcodingUser[".concat(a,"].zOrder"),0,100),tt(s.alpha)||De(s.alpha,"transcodingUser[".concat(a,"].alpha"),0,1,!1)})),tt(o.watermark)||Pp(o.watermark,"watermark"),tt(o.backgroundImage)||Pp(o.backgroundImage,"backgroundImage"),o.images&&!tt(o.images)&&(Mr(o.images,"config.images"),o.images.forEach((s,a)=>{Pp(s,"images[".concat(a,"]"))}))}(n);const i=[];n.images&&i.push(...n.images.map(o=>F(F(F({},Dp),o),{},{zOrder:255}))),n.backgroundImage&&(i.push(F(F(F({},Dp),n.backgroundImage),{},{zOrder:0})),delete n.backgroundImage),n.watermark&&(i.push(F(F(F({},Dp),n.watermark),{},{zOrder:255})),delete n.watermark),n.images=i,n.transcodingUsers&&(n.userConfigs=n.transcodingUsers.map(o=>F({},o)),n.userCount=n.transcodingUsers.length,delete n.transcodingUsers);const r=(n.userConfigs||[]).map(o=>typeof o.uid=="number"?Promise.resolve(o.uid):cw(o.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((await Promise.all(r)).forEach((o,s)=>{n.userConfigs&&n.userConfigs[s]&&(n.userConfigs[s].uid=o)}),this.transcodingConfig=n,this.connection)try{const o=await this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(this.streamingTasks.values()).map(s=>s.taskId).join("#")});f.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(o.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(o){if(!o.data||!o.data.retry)throw o;o.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(s=>{f.warning("[".concat(this.spec.clientId,"] live streaming receive error"),o.toString(),"try to republish",s.url),this.startLiveStreamingTask(s.url,s.mode,o).then(()=>{f.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(s.url," success"))}).catch(a=>{f.error("[".concat(this.spec.clientId,"] live streaming republish failed"),s.url,a.toString()),this.onLiveStreamError&&this.onLiveStreamError(s.url,a)})})}}setInjectStreamConfig(t,n){this.injectConfig=Object.assign({},this.injectConfig,t),this.injectLoopTimes=n}async startLiveStreamingTask(t,n,i){if(Array.from(this.streamingTasks.values()).find(a=>a.mode===Vt.INJECT)&&n===Vt.INJECT)return new N(C.LIVE_STREAMING_TASK_CONFLICT,"inject stream over limit").throw();if(!this.transcodingConfig&&n===Vt.TRANSCODE)throw new N(C.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let r={command:"PublishStream",ts:Date.now(),url:t,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};f.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(t,", mode: ").concat(n));const o=await this.taskMutex.lock();if(!this.connection&&i)return void o();if(this.streamingTasks.get(t)&&!i)return o(),new N(C.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=await this.connect(n))}catch(a){throw o(),a}switch(n){case Vt.TRANSCODE:r.transcodingConfig=F({},this.transcodingConfig);break;case Vt.RAW:break;case Vt.INJECT:r={cname:this.spec.cname,command:"InjectStream",sid:this.spec.sid,transcodingConfig:this.injectConfig,ts:Date.now(),url:t,loopTimes:this.injectLoopTimes}}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;const s=this.lastTaskId++;try{const a=new Promise((d,l)=>{Pt(this.retryTimeout).then(()=>{if(i)return l(i);const u=this.statusError.get(t);return u?(this.statusError.delete(t),l(u)):void 0})}),c=await Promise.race([this.connection.request("request",{clientRequest:r},!0,{url:t,command:"PublishStream",workerType:n===Vt.TRANSCODE?1:2,requestByUser:!i,tid:s.toString()}),a]);this.isStartingStreamingTask=!1,f.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(t,{clientRequest:r,mode:n,url:t,taskId:s}),o()}catch(a){if(o(),this.isStartingStreamingTask=!1,!a.data||!a.data.retry||i)throw a;return a.data.changeAddress?(this.connection.tryNextAddress(),await this.startLiveStreamingTask(t,n,a)):await this.startLiveStreamingTask(t,n,a)}}stopLiveStreamingTask(t){return new Promise((n,i)=>{const r=this.streamingTasks.get(t);if(!r||!this.connection)return new N(C.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();const o=r.mode;r.abortTask=()=>{f.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(t),n()},this.connection.request("request",{clientRequest:{command:o===Vt.INJECT?"UninjectStream":"UnpublishStream",url:r.url}},!1,{url:t,command:"UnPublishStream",workerType:o===Vt.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{f.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(t),this.streamingTasks.size===0&&o!==Vt.INJECT&&(this.connection&&this.connection.close(),this.connection=void 0),n(),o===Vt.INJECT&&this.onInjectStatusChange&&this.onInjectStatusChange(xs.INJECT_STREAM_STATUS_STOP_SUCCESS,this.spec.uid,t)}).catch(i)})}async controlInjectStream(t,n,i,r){const o=this.streamingTasks.get(t);if(!o||!this.connection||o.mode!==Vt.INJECT)throw new N(C.INVALID_OPERATION,"can not find inject stream task to control");return(await this.connection.request("request",{clientRequest:{command:"ControlStream",url:t,control:n,audioVolume:i,position:r}})).serverResponse}resetAllTask(){const t=Array.from(this.streamingTasks.values());this.terminate();for(const n of t)this.startLiveStreamingTask(n.url,n.mode).catch(i=>{this.onLiveStreamError&&this.onLiveStreamError(n.url,i)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=Un.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}async connect(t){if(this.connection)throw new N(C.UNEXPECTED_ERROR,"live streaming connection has already connected");const n=await Tt(this,Mu.REQUEST_WORKER_MANAGER_LIST,t);return this.uapResponse=n,this.connection=new BM(n.workerToken,this.spec,this.wsRetryConfig,t),this.connection.on(fr.WARNING,(i,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,i)),this.connection.on(fr.PUBLISH_STREAM_STATUS,i=>this.handlePublishStreamServer(i)),this.connection.on(fr.INJECT_STREAM_STATUS,i=>this.handleInjectStreamServerStatus(i)),this.connection.on(fr.REQUEST_NEW_ADDRESS,(i,r)=>{if(!this.connection)return r(new N(C.UNEXPECTED_ERROR,"can not get new live streaming address list"));Tt(this,Mu.REQUEST_WORKER_MANAGER_LIST,t).then(o=>{this.uapResponse=o,i(o.addressList)}).catch(r)}),await this.connection.init(n.addressList),this.connection}handlePublishStreamServer(t){const n=t.serverStatus&&t.serverStatus.url||"empty_url",i=this.streamingTasks.get(n),r=t.reason;switch(t.code){case Rt.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case Rt.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case Rt.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case Rt.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{const o=new N(C.LIVE_STREAMING_CDN_ERROR,"",{code:t.code});if(i)return f.error(o.toString()),this.onLiveStreamError&&this.onLiveStreamError(n,o);if(!this.isStartingStreamingTask)return;this.statusError.set(n,o)}case Rt.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{const o=new N(C.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(n,o)}case Rt.LIVE_STREAM_RESPONSE_WORKER_LOST:case Rt.LIVE_STREAM_RESPONSE_WORKER_QUIT:{if(!this.connection)return;this.connection.tryNextAddress();const o=Array.from(this.streamingTasks.values());for(const s of o)s.abortTask?s.abortTask():(f.warning("[".concat(this.spec.clientId,"] publish stream status code"),t.code,"try to republish",s.url),this.startLiveStreamingTask(s.url,s.mode,new N(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:t.code})).then(()=>{f.debug("[".concat(this.spec.clientId,"] republish live stream success"),s.url)}).catch(a=>{f.error(a.toString()),this.onLiveStreamError&&this.onLiveStreamError(s.url,a)}));return}}}handleInjectStreamServerStatus(t){const n=Number(t.uid),i=t.serverStatus&&t.serverStatus.url;switch(t.code){case 200:return void(this.onInjectStatusChange&&this.onInjectStatusChange(xs.INJECT_STREAM_STATUS_START_SUCCESS,n,i));case 451:return this.onInjectStatusChange&&this.onInjectStatusChange(xs.INJECT_STREAM_STATUS_START_ALREADY_EXISTS,n,i),void this.streamingTasks.delete(i);case 453:return this.onInjectStatusChange&&this.onInjectStatusChange(xs.INJECT_STREAM_STATUS_START_UNAUTHORIZED,n,i),void this.streamingTasks.delete(i);case 470:return this.onInjectStatusChange&&this.onInjectStatusChange(xs.INJECT_STREAM_STATUS_BROKEN,n,i),void this.streamingTasks.delete(i);case 499:return this.onInjectStatusChange&&this.onInjectStatusChange(xs.INJECT_STREAM_STATUS_START_TIMEOUT,n,i),void this.streamingTasks.delete(i);default:return void f.debug("inject stream server status",t)}}hasUrl(t){return this.streamingTasks.has(t)}}class jM{constructor(){this.destChannelMediaInfos=new Map,this.srcChannelMediaInfo=void 0}setSrcChannelInfo(t){vR(t),this.srcChannelMediaInfo=t}addDestChannelInfo(t){vR(t),this.destChannelMediaInfos.set(t.channelName,t)}removeDestChannelInfo(t){Sh(t),this.destChannelMediaInfos.delete(t)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function oC(e){if(!(e instanceof jM))return new N(C.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();const t=e.getSrcChannelMediaInfo(),n=e.getDestChannelMediaInfo();if(!t)return new N(C.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(n.size===0)return new N(C.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class WM extends qe{constructor(t,n,i){super(),this.ws=void 0,this.requestId=1,this.heartBeatTimer=void 0,this.joinInfo=void 0,this.clientId=void 0,this.onOpen=()=>{this.emit("open"),this.startHeartBeatCheck()},this.onClose=r=>{this.emit("close"),this.dispose()},this.onMessage=r=>{const o=JSON.parse(r.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)},this.joinInfo=t,this.clientId=n,this.ws=new Ed("cross-channel-".concat(this.clientId),i),this.ws.on(ne.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(ne.CONNECTED,this.onOpen),this.ws.on(ne.ON_MESSAGE,this.onMessage),this.ws.on(ne.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(t){const n=this.requestId++;return t.requestId=n,t.seq=n,this.ws.sendMessage(t),n}waitStatus(t){return new Promise((n,i)=>{const r=window.setTimeout(()=>{i(new N(C.TIMEOUT,"wait status timeout, status: ".concat(t)))},5e3);this.once(t,o=>{window.clearTimeout(r),o.state&&o.state!==0?i(new N(C.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(t))):n(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),i(new N(C.WS_ABORT))})})}async request(t){if(this.ws.state==="closed")throw new N(C.WS_DISCONNECT);const n=()=>new Promise((s,a)=>{this.ws.once(ne.CLOSED,()=>a(new N(C.WS_ABORT))),this.ws.once(ne.CONNECTED,s)});this.ws.state!=="connected"&&await n();const i=this.sendMessage(t),r=new Promise((s,a)=>{const c=()=>{a(new N(C.WS_ABORT))};this.ws.once(ne.RECONNECTING,c),this.ws.once(ne.CLOSED,c),this.once("req_".concat(i),s),Pt(3e3).then(()=>{this.removeAllListeners("req_".concat(i)),this.ws.off(ne.RECONNECTING,c),this.ws.off(ne.CLOSED,c),a(new N(C.TIMEOUT,"cross channel ws request timeout"))})}),o=await r;if(!o||o.code!==200)throw new N(C.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o}async connect(t){this.ws.removeAllListeners(ne.REQUEST_NEW_URLS),this.ws.on(ne.REQUEST_NEW_URLS,n=>{n(t)}),await this.ws.init(t)}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(t){const n=this.requestId++;return t.requestId=n,this.ws.sendMessage(t),n}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class HM extends qe{set state(t){t!==this._state&&(t!==xn.RELAY_STATE_FAILURE&&(this.errorCode=lc.RELAY_OK),this.emit("state",t,this.errorCode),this._state=t)}get state(){return this._state}constructor(t,n,i,r,o){super(),this.joinInfo=void 0,this.sid=void 0,this.clientId=void 0,this.cancelToken=Un.CancelToken.source(),this.workerToken=void 0,this.requestId=0,this.signal=void 0,this.prevChannelMediaConfig=void 0,this.httpRetryConfig=void 0,this._resolution=void 0,this._state=xn.RELAY_STATE_IDLE,this.errorCode=lc.RELAY_OK,this.onStatus=s=>{f.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(s))),s&&s.command&&(s.command==="onAudioPacketReceived"&&this.emit("event",Qr.PACKET_RECEIVED_AUDIO_FROM_SRC),s.command==="onVideoPacketReceived"&&this.emit("event",Qr.PACKET_RECEIVED_VIDEO_FROM_SRC),s.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=lc.SRC_TOKEN_EXPIRED,this.state=xn.RELAY_STATE_FAILURE),s.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=lc.DEST_TOKEN_EXPIRED,this.state=xn.RELAY_STATE_FAILURE))},this.onReconnect=async()=>{f.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",Qr.NETWORK_DISCONNECTED),this.state=xn.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(s=>{this.state!==xn.RELAY_STATE_IDLE&&(f.error("auto restart channel media relay failed",s.toString()),this.errorCode=lc.SERVER_CONNECTION_LOST,this.state=xn.RELAY_STATE_FAILURE)})},this.joinInfo=t,this.clientId=n,this.sid=kc(),this.signal=new WM(this.joinInfo,this.clientId,i),this.httpRetryConfig=r,this._resolution=o}async startChannelMediaRelay(t){if(this.state!==xn.RELAY_STATE_IDLE)throw new N(C.INVALID_OPERATION);this.state=xn.RELAY_STATE_CONNECTING,await this.connect(),f.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{await this.sendStartRelayMessage(t)}catch(n){throw n.data&&n.data.serverResponse&&n.data.serverResponse.command==="SetSourceChannel"?new N(C.CROSS_CHANNEL_FAILED_JOIN_SRC):n.data&&n.data.serverResponse&&n.serverResponse.command==="SetDestChannelStatus"?new N(C.CROSS_CHANNEL_FAILED_JOIN_DEST):n.data&&n.data.serverResponse&&n.serverResponse.command==="StartPacketTransfer"?new N(C.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):n}this.prevChannelMediaConfig=t}async updateChannelMediaRelay(t){if(this.state!==xn.RELAY_STATE_RUNNING)throw new N(C.INVALID_OPERATION);await this.sendUpdateMessage(t),this.prevChannelMediaConfig=t}async setVideoProfile(t){if(this._resolution=t,this.state!==xn.RELAY_STATE_RUNNING)throw new N(C.INVALID_OPERATION);const n=this.genMessage(mn.SetVideoProfile);await this.signal.request(n),f.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))}async stopChannelMediaRelay(){await this.sendStopRelayMessage(),f.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=xn.RELAY_STATE_IDLE,this.dispose()}dispose(){f.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=Un.CancelToken.source(),this.state=xn.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}async connect(){const t=await PM(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=t.workerToken,await this.signal.connect(t.addressList),this.emit("event",Qr.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)}async sendStartRelayMessage(t){const n=this.genMessage(mn.StopPacketTransfer);await this.signal.request(n),await this.signal.waitStatus("Normal Quit"),f.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));const i=this.genMessage(mn.SetSdkProfile,t);await this.signal.request(i),f.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));const r=this.genMessage(mn.SetSourceChannel,t);await this.signal.request(r),await this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",Qr.PACKET_JOINED_SRC_CHANNEL),f.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));const o=this.genMessage(mn.SetSourceUserId,t);await this.signal.request(o),f.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));const s=this.genMessage(mn.SetDestChannel,t);await this.signal.request(s),await this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",Qr.PACKET_JOINED_DEST_CHANNEL),f.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));const a=this.genMessage(mn.StartPacketTransfer,t);await this.signal.request(a),this.emit("event",Qr.PACKET_SENT_TO_DEST_CHANNEL),this.state=xn.RELAY_STATE_RUNNING,f.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)}async sendUpdateMessage(t){const n=this.genMessage(mn.UpdateDestChannel,t);await this.signal.request(n),this.emit("event",Qr.PACKET_UPDATE_DEST_CHANNEL),f.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))}async sendStopRelayMessage(){const t=this.genMessage(mn.StopPacketTransfer);await this.signal.request(t),f.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))}genMessage(t,n){const i=[],r=[],o=[];this.requestId+=1;const s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:fi,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};s.sdkVersion==="4.21.0"&&(s.sdkVersion="0.0.1");let a=null,c=null;switch(t){case mn.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case mn.SetSourceChannel:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new N(C.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},s;case mn.SetSourceUserId:if(c=n&&n.getSrcChannelMediaInfo(),!c)throw new N(C.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:c.uid+""},s;case mn.SetDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new N(C.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"SetDestChannel",channelName:i,uid:r,token:o},s;case mn.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case mn.Reconnect:return s.clientRequest={command:"Reconnect"},s;case mn.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case mn.UpdateDestChannel:if(a=n&&n.getDestChannelMediaInfo(),!a)throw new N(C.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{i.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"UpdateDestChannel",channelName:i,uid:r,token:o},s;case mn.SetVideoProfile:s.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return s}}var ke;let Bs=(ke=class Cc extends Ch{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>Object.keys(wa).includes(t)))]}constructor(t,n){super(t,n),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.statsFilter=void 0,this.useRTX=!1,this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.establishPromise=void 0,this.mutex=new Bt("P2PConnection-mutex"),this.store=n,this.peerConnection=new RTCPeerConnection(Cc.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=vh(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,Me()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(){try{const t=await this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=Ji(t.sdp),i=Rd(t.sdp,{filterRTX:!this.useRTX,filterVideoFec:A("FILTER_VIDEO_FEC"),filterAudioFec:A("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=i,this.initialOffer=t,F(F({},n),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:i},offerSDP:t.sdp})}catch(t){throw new L(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{constructor(c){this.sessionDesc=void 0,this.localCapabilities=void 0,this.rtpCapabilities=void 0,this.candidates=void 0,this.iceParameters=void 0,this.dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,c=xe(c);const{remoteIceParameters:d,remoteDtlsParameters:l,candidates:u,remoteRTPCapabilities:h,remoteSetup:p,localCapabilities:m,sdkCodec:E,cname:g}=c,S=$e.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=h,this.candidates=u,this.iceParameters=d,this.dtlsParameters=l,this.setup=p,this.localCapabilities=m,this.cname=g;for(let T=0;T<S.mediaDescriptions.length;T++){const I=S.mediaDescriptions[T];if(I.attributes.iceUfrag=d.iceUfrag,I.attributes.icePwd=d.icePwd,I.attributes.fingerprints=l.fingerprints,I.attributes.candidates=u,I.attributes.setup=p,I.media.mediaType==="video"){I.media.fmts=h.videoCodecs.map(w=>w.payloadType.toString(10));let y=h.videoCodecs.filter(w=>{var D;return(D=w.rtpMap)===null||D===void 0?void 0:D.encodingName.toLowerCase().includes(E)});y.length===0&&(y=h.videoCodecs),I.attributes.payloads=y,I.attributes.extmaps=h.videoExtensions}I.media.mediaType==="audio"&&(I.media.fmts=h.audioCodecs.map(y=>y.payloadType.toString(10)),I.attributes.payloads=h.audioCodecs,I.attributes.extmaps=h.audioExtensions),S.mediaDescriptions[T]=this.mungMediaDesc(I)}this.sessionDesc=S,this.currentMidIndex=S.mediaDescriptions.length-1}toString(){return $e.print(this.sessionDesc)}send(c,d,l){const{ssrcs:u,ssrcGroups:h}=Xn(d,this.cname),p=this.sessionDesc.mediaDescriptions.find(g=>c===z.VIDEO?g.media.mediaType==="video":g.media.mediaType==="audio"),m=u[0].attributes.label,E=u[0].attributes.mslabel;return p.attributes.ssrcs=p.attributes.ssrcs.concat(u),p.attributes.ssrcGroups=p.attributes.ssrcGroups.concat(h),{id:m,mslabel:E}}batchSend(c){return c.map(d=>{let{kind:l,ssrcMsg:u}=d;return this.send(l,u,void 0)})}stopSending(c){this.sessionDesc.mediaDescriptions.forEach(d=>{const l=[],u=[],h=[];d.attributes.ssrcs.forEach(p=>{c.includes(p.attributes.label||"")?h.push(p):l.push(p)}),d.attributes.ssrcGroups.forEach(p=>{h.map(m=>m.ssrcId).includes(p.ssrcIds[0])||u.push(p)}),d.attributes.ssrcs=l,d.attributes.ssrcGroups=u})}mute(c){const d=this.sessionDesc.mediaDescriptions.find(l=>l.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.mute."));d.attributes.direction="inactive"}unmute(c){const d=this.sessionDesc.mediaDescriptions.find(l=>l.attributes.mid===c);if(!d)throw new Error("mediaDescription not found with ".concat(c," in remote SDP when calling RemoteSDP.unmute."));d.attributes.direction="sendonly"}receive(c,d,l){c.forEach((u,h)=>{const p=u._mediaStreamTrack,m=this.sessionDesc.mediaDescriptions.findIndex(g=>g.attributes.mid===p.kind),E=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[m],u);this.sessionDesc.mediaDescriptions[m]=E})}stopReceiving(c){}updateCandidates(c){c===_n.TCP?this.candidates.forEach(d=>{this.candidates.findIndex(l=>l.transport==="tcp"&&l.connectionAddress===d.connectionAddress&&l.port===d.port)===-1&&this.candidates.push(F(F({},d),{},{foundation:"tcpcandidate",priority:Number(d.priority)-1+"",transport:"tcp",port:Number(d.port)+90+""}))}):this.candidates=this.candidates.filter(d=>d.transport!=="tcp");for(const d of this.sessionDesc.mediaDescriptions)d.attributes.candidates=this.candidates}restartICE(c){c=xe(c),this.iceParameters=c,this.sessionDesc.mediaDescriptions.forEach(d=>{d.attributes.iceUfrag=c.iceUfrag,d.attributes.icePwd=c.icePwd})}predictReceivingMids(c){const d=[];for(let l=0;l<c;l++)d.push((this.currentMidIndex+l+1).toString(10));return d}mungRecvMediaDsec(c,d){const l=xe(c);return Uo(l,d),yh(l,d),l}updateRecvMedia(c,d){const l=this.sessionDesc.mediaDescriptions.findIndex(u=>u.attributes.mid===c);if(l!==-1){const u=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[l],d);this.sessionDesc.mediaDescriptions[l]=u}}bumpMid(c){this.currentMidIndex+=c}updateTrackLabel(c,d,l){const u=this.sessionDesc.mediaDescriptions.find(p=>c===z.VIDEO?p.attributes.mid==="video":p.attributes.mid==="audio");if(u){const p=u.attributes.ssrcs.find(m=>m.attributes.label===d);var h;p&&(p.attributes.label=l,(h=p.attributes.msid)===null||h===void 0||h.replace(d,l))}}mungMediaDesc(c){const d=xe(c);return Ih(d),function(l){const u=l.attributes.extmaps.find(h=>h.extensionName==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01");u&&l.attributes.extmaps.splice(l.attributes.extmaps.indexOf(u),1),l.attributes.payloads.forEach(h=>{const p=h.rtcpFeedbacks.findIndex(m=>m.type==="transport-cc");p!==-1&&h.rtcpFeedbacks.splice(p,1)})}(d),d}getSSRC(c){for(const d of this.sessionDesc.mediaDescriptions)for(const l of d.attributes.ssrcs)if(l.attributes.label===c)return[l]}}({remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r.send,remoteSetup:o,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec,cname:s});const a=this.remoteSDP.toString();await this.peerConnection.setLocalDescription(this.initialOffer),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(t,n){throw new L(C.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}send(t,n){var i=this;return Wn(function*(){const r=yield ae(i.mutex.lock());try{if(!i.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const o=t.map(h=>i.peerConnection.addTrack(h._mediaStreamTrack)),s=yield ae(i.peerConnection.createOffer()),a=$e.parse(s.sdp),c=t.map(h=>{const p=h._mediaStreamTrack,m=a.mediaDescriptions.find(E=>E.attributes.mid===p.kind);if(!m)throw new Error("Cannot extract ssrc from mediaDescription.");return function(E,g,S){const T=E.attributes.ssrcs.filter(y=>y.attributes.label===g),I=E.attributes.ssrcGroups;if(T.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(I&&T.length>1){const y=I.find(w=>w.ssrcIds.indexOf(T[0].ssrcId)!==-1);return y?[{ssrcId:y.ssrcIds[0],rtx:S?y.ssrcIds[1]:void 0}]:[{ssrcId:T[0].ssrcId}]}return[{ssrcId:T[0].ssrcId}]}(m,p.id,i.useRTX)});let d;try{d=yield c}catch(h){throw o.forEach(p=>{Gt()&&p.replaceTrack(null),i.peerConnection.removeTrack(p)}),h}const l=i.mungSendOfferSDP(s.sdp,t);i.remoteSDP.receive(t,n,d);const u=i.remoteSDP.toString();return yield ae(i.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield ae(i.applySendEncodings(o,t)),yield ae(i.peerConnection.setRemoteDescription({type:"answer",sdp:u})),t.map((h,p)=>{const m=h._mediaStreamTrack.id;return{localSSRC:c[p],id:m}})}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r()}})()}async stopSending(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const n=this.peerConnection.getSenders().filter(o=>{var s;return t.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");n.map(o=>{Gt()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i),this.remoteSDP.stopReceiving(t);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(n.toString()))}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{id:o,mslabel:s}=this.remoteSDP.send(t,n,r),a=new Promise((l,u)=>{const h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(o)))},1e4),p=m=>{const E=Ie();if((E.name==="Safari"&&Number(E.version)===11||dn())&&m.track.id!==o&&m.streams[0].id===s){var g;const S=m.streams[0].getTracks()[0];return(g=this.remoteSDP)===null||g===void 0||g.updateTrackLabel(t,o,m.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(S)}if(m.track.id===o)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(m.track)};this.peerConnection.addEventListener("track",p)}),c=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const d=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(d),{track:await a,id:o}}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const i=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(i)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){}async unmuteRemote(t){}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(i=>{var r;return t.indexOf(((r=i.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(n.length!==t.length)throw new Error("sender' length doesn't match mids' length.");n.map(i=>{if(Gt()&&i.track)i.track.enabled=!1;else{const r=i.getParameters();r.encodings.forEach(o=>o.active=!1),i.setParameters(r)}})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getSenders().filter(o=>{var s;return t.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(n.length!==t.length)throw new Error("Senders' length doesn't match mids' length.");n.map(async o=>{if(Gt()&&o.track)o.track.enabled=!0;else{const s=o.getParameters();s.encodings.forEach(a=>a.active=!0),await o.setParameters(s)}});const i=await this.peerConnection.createOffer();await this.peerConnection.setLocalDescription(i);const r=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return Wn(function*(){const i=yield ae(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(ge().supportPCSetConfiguration){const c=n.peerConnection.getConfiguration(),d=t===_n.RELAY?"relay":"all";c.iceTransportPolicy!==d&&(f.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(c.iceTransportPolicy,"] to [").concat(d,"]")),c.iceTransportPolicy=d,n.peerConnection.setConfiguration(c))}else if(t===_n.RELAY)return;t!==_n.RELAY&&n.remoteSDP.updateCandidates(t);const r=yield ae(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=Ji(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);const a=n.remoteSDP.toString();yield ae(n.peerConnection.setLocalDescription(r)),yield ae(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){f.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}close(){var t;this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n]);this.remoteSDP.updateRecvMedia(n._mediaStreamTrack.kind,n);const o=this.remoteSDP.toString();await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new L(C.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getSenders().filter(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===t});i.length===1&&await this.applySendEncodings(i,[n])}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getSenders().find(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===n});i&&await i.replaceTrack(t._mediaStreamTrack)}createDataChannels(t,n){throw new L(C.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(t){throw new L(C.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,f.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,f.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},A("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[],sdpSemantics:"plan-b"};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Ba(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...Cc.turnServerConfigToIceServers(t.turnServer.servers)),A("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...Cc.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}async updateRtpSenderEncodings(t,n){var i;if(n||(n=this.peerConnection.getSenders().find(c=>{var d;return((d=c.track)===null||d===void 0?void 0:d.id)===t._mediaStreamTrack.id})),!n)return f.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(!ge().supportSetRtpSenderParameters)return f.warn("Browser not support set rtp-sender parameters");const r={},o={};if(t instanceof Ge)switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(A("DSCP_TYPE")&&ko()){const c=A("DSCP_TYPE");["very-low","low","medium","high"].includes(c)&&(o.networkPriority=c)}const s=n.getParameters(),a=(i=s.encodings)===null||i===void 0?void 0:i[0];a&&Object.assign(a,o),Object.assign(s,r),f.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(s.encodings))),await n.setParameters(s)}async applySendEncodings(t,n){try{if(!ge().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],o=n[i];r&&o&&await this.updateRtpSenderEncodings(o,r)}}catch{f.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n){const i=$e.parse(t);return n.forEach((r,o)=>{const s=r._mediaStreamTrack,a=i.mediaDescriptions.find(c=>c.attributes.mid===s.kind);a&&Uo(a,r)}),$e.print(i)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const n=this.remoteSDP.batchSend(t).map((o,s)=>{let{id:a,mslabel:c}=o;const{kind:d}=t[s];return new Promise((l,u)=>{const h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(a)))},1e4),p=m=>{const E=Ie();if(E.name==="Safari"&&Number(E.version)===11&&m.track.id!==a&&m.streams[0].id===c){var g;const S=m.streams[0].getTracks()[0];return(g=this.remoteSDP)===null||g===void 0||g.updateTrackLabel(d,a,m.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:S,id:a})}if(m.track.id===a)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:m.track,id:a})};this.peerConnection.addEventListener("track",p)})}),i=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:i});const r=await this.peerConnection.createAnswer();return await this.peerConnection.setLocalDescription(r),await Promise.all(n)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n==null?void 0:n[0].ssrcId}setConfiguration(t){if(ge().supportPCSetConfiguration){const n=Cc.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},B(ke.prototype,"connect",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"connect"),ke.prototype),B(ke.prototype,"stopSending",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"stopSending"),ke.prototype),B(ke.prototype,"receive",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"receive"),ke.prototype),B(ke.prototype,"stopReceiving",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"stopReceiving"),ke.prototype),B(ke.prototype,"muteRemote",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"muteRemote"),ke.prototype),B(ke.prototype,"unmuteRemote",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"unmuteRemote"),ke.prototype),B(ke.prototype,"muteLocal",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"muteLocal"),ke.prototype),B(ke.prototype,"unmuteLocal",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"unmuteLocal"),ke.prototype),B(ke.prototype,"close",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"close"),ke.prototype),B(ke.prototype,"updateEncoderConfig",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"updateEncoderConfig"),ke.prototype),B(ke.prototype,"updateSendParameters",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"updateSendParameters"),ke.prototype),B(ke.prototype,"replaceTrack",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"replaceTrack"),ke.prototype),B(ke.prototype,"getRemoteSSRC",[ai],Object.getOwnPropertyDescriptor(ke.prototype,"getRemoteSSRC"),ke.prototype),ke);function ai(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("Locking from P2PConnection.".concat(t));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}const uc="9",sC=4e4;let Ql=function(e){return e.BANDWIDTH="bandwidth",e.CPU="cpu",e.NONE="none",e.OTHER="other",e}({});var Ea=function(e){return e[e.DOWN=0]="DOWN",e[e.UP=1]="UP",e}(Ea||{});const xu=new Map;function aC(e,t,n,i){let{scale:r}=e;if(r===0&&i===Ea.UP||r>=t.length-1&&i===Ea.DOWN)return e;let o=F(F({},e),{},{scale:i===Ea.DOWN?++r:--r});switch(n){case"maintain-framerate":o=F(F({},o),t[r].motion);break;case"maintain-resolution":o=F(F({},o),t[r].detail);break;case"balanced":o=F(F({},o),t[r].balanced)}return o}function Ew(e,t){if(t){const n={overUse:0,underUse:0,adaptationList:mw(t)};xu.set(e,n)}else xu.delete(e)}function mw(e){const t=F({},e),{bitrateMax:n,frameRate:i,scaleResolutionDownBy:r,bitrateMin:o}=t,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:u,BWE_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:m,BALANCE_BITRATE_FACTOR:E,BALANCE_FRAMERATE_FACTOR:g,BALANCE_RESOLUTION_FACTOR:S,MOTION_RESOLUTION_FACTOR:T,MOTION_BITRATE_FACTOR:I,DETAIL_FRAMERATE_FACTOR:y,DETAIL_BITRATE_FACTOR:w}=VE,D=Math.min(t.frameRate,a),O=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(h,1)*n),bwe_up:n,fps_down:Math.round(Math.pow(p,1)*D),fps_up:i},balanced:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:i,bitrateMax:n,bitrateMin:o}}];for(let P=1;P<=c;P++){const x={bwe_up:Math.round(Math.pow(u,P)*n),bwe_down:Math.round(Math.pow(h,P+1)*n),fps_up:Math.round(Math.pow(m,P)*D),fps_down:Math.round(Math.pow(p,P+1)*D)},U={scaleResolutionDownBy:r/Math.pow(S,P),frameRate:Math.max(Math.round(Math.pow(g,P)*i),s),bitrateMax:Math.max(Math.round(Math.pow(E,P)*n),l),bitrateMin:Math.max(Math.round(Math.pow(E,P)*o),d)},J={scaleResolutionDownBy:r/Math.pow(T,P),frameRate:i,bitrateMax:Math.max(Math.round(Math.pow(I,P)*n),l),bitrateMin:Math.max(Math.round(Math.pow(I,P)*o),d)},Le={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(y,P)*i),s),bitrateMax:Math.max(Math.round(Math.pow(w,P)*n),l),bitrateMin:Math.max(Math.round(Math.pow(w,P)*o),d)};O.push({scale:P,threshold:x,balanced:U,motion:J,detail:Le})}return O}function KM(e,t,n,i,r,o){const s=xu.get(e)||{overUse:0,underUse:0,adaptationList:mw(r)},{adaptationList:a}=s;xu.set(e,s);const{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=VE,{scale:l}=i;let u,h;return typeof t=="number"&&t>0&&function(p,m,E,g){if(m>=E.length)return!1;let{threshold:{fps_down:S}}=E[m];return A("FORCE_AG_HIGH_FRAMERATE")&&g==="maintain-framerate"&&(S=E[0].threshold.fps_down),p<S}(t,l,a,o)&&(s.overUse++,h=Ql.CPU,s.overUse>c)||typeof n=="number"&&n>0&&function(p,m,E){if(m>=E.length)return!1;const{threshold:{bwe_down:g}}=E[m];return p<g}(n,l,a)&&(s.overUse++,h=Ql.BANDWIDTH,s.overUse>c)?(s.overUse=0,s.underUse=0,u=aC(i,a,o,Ea.DOWN),[u,h]):(typeof t=="number"&&t>0&&typeof n=="number"&&n>0&&function(p,m,E,g){if(m===0)return;let{threshold:{fps_up:S}}=E[m];return A("FORCE_AG_HIGH_FRAMERATE")&&g==="maintain-framerate"&&(S=E[1].threshold.fps_up),p>S}(t,l,a,o)&&function(p,m,E){if(m===0)return;const{threshold:{bwe_up:g}}=E[m];return p>g}(n,l,a)&&(s.underUse++,s.underUse>d&&(s.overUse=0,s.underUse=0,u=aC(i,a,o,Ea.UP),u.scale===0&&(h=Ql.NONE))),[u,h])}const Vu=new Map;function gl(e){const t=Vu.get(e);if(t){const{timer:n,adaptationFunc:i,originConfig:r}=t;window.clearTimeout(n),i(r),Vu.delete(e)}Ew(e)}var Se;let Wi=(Se=class vc extends Ch{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var t,n;return(t=(n=this.peerConnection.getReceivers()[0])===null||n===void 0||(n=n.transport)===null||n===void 0?void 0:n.state)!==null&&t!==void 0?t:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(t=>t.rtpMap&&t.rtpMap.encodingName.toLowerCase()||"").filter(t=>Object.keys(wa).includes(t)))]}constructor(t,n){super(t,n),this.store=void 0,this.peerConnection=void 0,this.id=et(5,"connection-"),this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=A("USE_XR"),this.localCapabilities=void 0,this.remoteCodecs=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.recoveredDataChannelIds=[],this.currentDataChannelId=1,this.mutex=new Bt("P2PConnection-mutex"),this.qualityLimitationReason=Ql.NONE,this.store=n,this.peerConnection=new RTCPeerConnection(vc.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.statsFilter=vh(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,Me()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void f.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else f.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async establish(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});const t=await this.peerConnection.createOffer();if(!t.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const n=Ji(t.sdp),i=await rm({filterRTX:!A("USE_PUB_RTX")&&!A("USE_SUB_RTX"),filterVideoFec:A("FILTER_VIDEO_FEC"),filterAudioFec:A("FILTER_AUDIO_FEC"),filterVideoCodec:A("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=La(i),this.initialOffer=t,F(F({},n),{},{rtpCapabilities:i,offerSDP:t.sdp})}catch(t){throw new L(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,t.toString())}}async connect(t,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new class{get localCapabilities(){return xe(this._localCapabilities)}get rtpCapabilities(){return xe(this._rtpCapabilities)}get candidates(){return xe(this._candidates)}get iceParameters(){return xe(this._iceParameters)}get dtlsParameters(){return xe(this._dtlsParameters)}constructor(p){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,p=xe(p);const{remoteIceParameters:m,remoteDtlsParameters:E,candidates:g,remoteRTPCapabilities:S,remoteSetup:T,localCapabilities:I,cname:y}=p,w=$e.parse(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`);this._rtpCapabilities=S,this._candidates=g,this._iceParameters=m,this._dtlsParameters=E,this._localCapabilities=I,this.setup=T,this.cname=y;const D=this.rtpCapabilities.send;for(const O of w.mediaDescriptions){if(O.attributes.iceUfrag=m.iceUfrag,O.attributes.icePwd=m.icePwd,O.attributes.fingerprints=E.fingerprints,O.attributes.candidates=g,O.attributes.setup=T,O.media.mediaType==="video"&&(O.media.fmts=D.videoCodecs.map(P=>P.payloadType.toString(10)),O.attributes.payloads=D.videoCodecs,O.attributes.extmaps=D.videoExtensions,A("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:P,ssrcGroups:x}=Xn([{ssrcId:sC,rtx:A("USE_SUB_RTX")?40001:void 0}],this.cname);O.attributes.ssrcs=P,O.attributes.ssrcGroups=x}if(O.media.mediaType==="audio"&&(O.media.fmts=D.audioCodecs.map(P=>P.payloadType.toString(10)),O.attributes.payloads=D.audioCodecs,O.attributes.extmaps=D.audioExtensions,Xi(O),A("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:P,ssrcGroups:x}=Xn([{ssrcId:2e4}],this.cname);O.attributes.ssrcs=P,O.attributes.ssrcGroups=x}}this.sessionDesc=w,this.currentMidIndex=w.mediaDescriptions.length-1}preloadRemoteMedia(){const p=A("PRELOAD_MEDIA_COUNT");this.rtpCapabilities;const m=this.candidates,E=this.dtlsParameters,g=this.iceParameters,S=this.rtpCapabilities.send;for(let T=1;T<p;T++){const I=2*T+2e4,y=2*T+sC,{ssrcs:w,ssrcGroups:D}=Xn([{ssrcId:I}],this.cname),{ssrcs:O,ssrcGroups:P}=Xn([{ssrcId:y,rtx:A("USE_SUB_RTX")?y+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:uc,protos:["UDP","TLS","RTP","SAVPF"],fmts:S.videoCodecs.map(x=>x.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:g.iceUfrag,icePwd:g.icePwd,unrecognized:[],candidates:m,extmaps:S.videoExtensions,fingerprints:E.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:O,ssrcGroups:P,rtcpFeedbackWildcards:[],payloads:S.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*T)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:uc,protos:["UDP","TLS","RTP","SAVPF"],fmts:S.audioCodecs.map(x=>x.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:g.iceUfrag,icePwd:g.icePwd,unrecognized:[],candidates:m,extmaps:S.audioExtensions,fingerprints:E.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:w,ssrcGroups:D,rtcpFeedbackWildcards:[],payloads:S.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*T+1)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return $e.print(this.sessionDesc)}send(p,m,E,g){const{ssrcs:S,ssrcGroups:T}=Xn(m,this.cname,A("SYNC_GROUP")?E:void 0),I=this.findPreloadMediaDesc(S);if(I){if(Me()&&this.firefoxSsrcMidMap.set(S[0].ssrcId,I.attributes.mid),g&&(g.twcc||g.remb)){const y=this.sessionDesc.mediaDescriptions.indexOf(I);return this.sessionDesc.mediaDescriptions[y]=this.mungSendMediaDesc(I,g),{mid:I.attributes.mid,needExchangeSDP:!0}}return{mid:I.attributes.mid,needExchangeSDP:!1}}{const y=this.findAvailableMediaIndex(p,S);let w;return y===-1||y===1&&(Gt()||OA())||y===0&&A("USE_SUB_RTX")||Wg()?(w=this.createOrRecycleSendMedia(p,S,T,"sendonly",g),this.updateBundleMids()):(w=xe(this.sessionDesc.mediaDescriptions[y]),w.attributes.direction="sendonly",w.attributes.ssrcs=S,w.attributes.ssrcGroups=T,this.sessionDesc.mediaDescriptions[y]=this.mungSendMediaDesc(w,g)),Me()&&this.firefoxSsrcMidMap.set(S[0].ssrcId,w.attributes.mid),{mid:w.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){const{mediaDesc:p,needExchangeSDP:m}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:p.attributes.mid,needExchangeSDP:m}}batchSend(p){const m=p.map(S=>{let{kind:T,ssrcMsg:I,mslabel:y}=S;return this.send(T,I,y)}),E=[];let g=!1;return m.forEach(S=>{let{mid:T,needExchangeSDP:I}=S;I&&(g=!0),E.push(T)}),{mids:E,needExchangeSDP:g}}stopSending(p){const m=this.sessionDesc.mediaDescriptions.filter(E=>E.attributes.mid&&p.indexOf(E.attributes.mid)!==-1);if(m.length!==p.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");m.forEach(E=>{E.attributes.mid==="0"||Me()||Wg()?E.attributes.ssrcs=[]:(E.attributes.ssrcs=[],E.attributes.direction="inactive",E.media.port="0")}),this.updateBundleMids()}mute(p){const m=this.sessionDesc.mediaDescriptions.find(E=>E.attributes.mid===p);if(!m)throw new Error("mediaDescription not found with ".concat(p," in remote SDP when calling RemoteSDP.mute."));m.attributes.direction="inactive"}unmute(p){const m=this.sessionDesc.mediaDescriptions.find(E=>E.attributes.mid===p);if(!m)throw new Error("mediaDescription not found with ".concat(p," in remote SDP when calling RemoteSDP.unmute."));m.attributes.direction="sendonly"}muteRemote(p){const m=this.sessionDesc.mediaDescriptions.filter(E=>p.includes(E.attributes.mid||""));if(m.length!==p.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");m.forEach(E=>{E.attributes.direction="inactive"})}unmuteRemote(p){const m=this.sessionDesc.mediaDescriptions.filter(E=>p.includes(E.attributes.mid||""));if(m.length!==p.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");m.forEach(E=>{E.attributes.direction="recvonly"})}receive(p,m,E,g){p.forEach((S,T)=>{this.createOrRecycleRecvMedia(S,[],"recvonly",m,E,g[T])}),this.updateBundleMids()}stopReceiving(p){const m=this.sessionDesc.mediaDescriptions.filter(E=>p.indexOf(E.attributes.mid)!==-1);if(m.length!==p.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");m.forEach(E=>{E.media.port="0",E.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(p){const m=this._candidates.filter(E=>E.transport==="udp");if(p===_n.TCP){if(m.length===0)return;if(A("TCP_CANDIDATE_ONLY")){const E=this._candidates.filter(g=>g.transport==="tcp");m.forEach(g=>{E.findIndex(S=>S.connectionAddress===g.connectionAddress)===-1&&E.push(F(F({},g),{},{foundation:"tcpcandidate",priority:Number(g.priority)-1+"",transport:"tcp",port:Number(g.port)+90+""}))}),this._candidates=E}else{const E=[];m.forEach(g=>{E.push(F(F({},g),{},{foundation:"tcpcandidate",priority:Number(g.priority)-1+"",transport:"tcp",port:Number(g.port)+90+""}))}),this._candidates=[...m,...E]}}else if(p===_n.RELAY){if(m.length!==0)return;{const E=this._candidates.filter(g=>g.transport==="tcp");E.forEach(g=>{m.push(F(F({},g),{},{foundation:"udpcandidate",priority:Number(g.priority)+1+"",transport:"udp",port:Number(g.port)-90+""}))}),this._candidates=[...m,...E]}}else m.length===0?(this._candidates.filter(E=>E.transport==="tcp").forEach(E=>{m.push(F(F({},E),{},{foundation:"udpcandidate",priority:Number(E.priority)+1+"",transport:"udp",port:Number(E.port)-90+""}))}),this._candidates=m):this._candidates=this._candidates.filter(E=>E.transport!=="tcp");for(const E of this.sessionDesc.mediaDescriptions)E.attributes.candidates=this.candidates}restartICE(p){p=xe(p),this._iceParameters=p,this.sessionDesc.mediaDescriptions.forEach(m=>{m.attributes.iceUfrag=p.iceUfrag,m.attributes.icePwd=p.icePwd})}predictReceivingMids(p){const m=[];for(let E=0;E<p;E++)m.push((this.currentMidIndex+E+1).toString(10));return m}findAvailableMediaIndex(p,m){return this.sessionDesc.mediaDescriptions.findIndex(E=>{const g=E.media.mediaType===p&&E.media.port!=="0"&&(E.attributes.direction==="sendonly"||E.attributes.direction==="sendrecv")&&E.attributes.ssrcs.length===0;if(Me()){if(g){const S=this.firefoxSsrcMidMap.get(m[0].ssrcId);return!(S||E.attributes.mid!=="0"&&E.attributes.mid!=="1")||!(!S||S!==E.attributes.mid)}return!1}return g})}createOrRecycleDataChannel(){for(const E of this.sessionDesc.mediaDescriptions)if(E.media.mediaType==="application")return{mediaDesc:E,needExchangeSDP:!1};this.currentMidIndex+=1;const p="".concat(this.currentMidIndex),m={media:{mediaType:"application",port:uc,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(p),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(m),{mediaDesc:m,needExchangeSDP:!0}}createOrRecycleRecvMedia(p,m,E,g,S,T){const I=p._mediaStreamTrack.kind,y=this.rtpCapabilities.recv,w=us(I,y,this.localCapabilities.send,I===z.VIDEO?g:S),D=I===z.VIDEO?y.videoExtensions:y.audioExtensions;this.currentMidIndex+=1;const O="".concat(this.currentMidIndex);let P={media:{mediaType:I,port:uc,protos:["UDP","TLS","RTP","SAVPF"],fmts:w.map(U=>U.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:D,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:m,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:w,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:E,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(O)}};P=this.mungRecvMediaDsec(P,p,T);const x=this.findFirstClosedMedia(I);if(x){const U=this.sessionDesc.mediaDescriptions.indexOf(x);this.sessionDesc.mediaDescriptions[U]=P}else this.sessionDesc.mediaDescriptions.push(P);return P}updateRemoteCodec(p,m,E){const g=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(P=>P.rtpMap&&P.rtpMap.encodingName.toLowerCase()||"").filter(P=>Object.keys(wa).includes(P)))],S=new Set(m);if(g.every(P=>S.has(P)))return f.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(m)),!1;const T=this._rtpCapabilities.recv.videoCodecs.filter(P=>m.some(x=>(P.rtpMap&&P.rtpMap.encodingName.toLowerCase()||"").includes(x)));if(T.length===0)return f.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(g," codecs: ").concat(m)),!1;const I=[...new Set(T.map(P=>P.rtpMap&&P.rtpMap.encodingName.toLowerCase()||""))];let y;if(f.debug("updateRemoteCodec, from ".concat(g," to ").concat(I)),p.length===0)y=this.sessionDesc.mediaDescriptions.filter(P=>P.media.mediaType==="video"&&P.attributes.direction==="recvonly");else if(y=this.sessionDesc.mediaDescriptions.filter(P=>P.attributes.mid&&p.includes(P.attributes.mid)&&P.attributes.direction==="recvonly"),y.length!==p.length)return f.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(p,", codecs: ").concat(m)),!1;if(A("USE_PUB_RTX")||A("USE_SUB_RTX")){const P=om(T,this.rtpCapabilities.recv.videoCodecs);T.push(...P)}this._rtpCapabilities.recv.videoCodecs=T;const w=this.localCapabilities.send,D=this.rtpCapabilities.recv,O=us(z.VIDEO,D,w,E);return y.forEach(P=>{const x=O.map(U=>U.payloadType.toString(10));f.debug("updateRemoteCodec mid: ".concat(P.attributes.mid,", from ").concat(P.attributes.payloads," to ").concat(O)),P.attributes.payloads=O,P.media.fmts=x}),!0}createOrRecycleSendMedia(p,m,E,g,S){const T=this.rtpCapabilities.send,I=p===z.VIDEO?T.videoCodecs:T.audioCodecs,y=p===z.VIDEO?T.videoExtensions:T.audioExtensions;this.currentMidIndex+=1;const w="".concat(this.currentMidIndex);let D={media:{mediaType:p,port:uc,protos:["UDP","TLS","RTP","SAVPF"],fmts:I.map(P=>P.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:y,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:m,ssrcGroups:E,rtcpFeedbackWildcards:[],payloads:I,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:g,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(w)}};D=this.mungSendMediaDesc(D,S);const O=this.findFirstClosedMedia(p);if(O){const P=this.sessionDesc.mediaDescriptions.indexOf(O);this.sessionDesc.mediaDescriptions[P]=D}else this.sessionDesc.mediaDescriptions.push(D);return D}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(p=>p.media.port!=="0").map(p=>p.attributes.mid)}mungRecvMediaDsec(p,m,E){const g=xe(p);return Ih(g),Uo(g,m),yh(g,m),nm(g),Pa(g,E,this.localCapabilities.send),g}mungSendMediaDesc(p,m){const E=xe(p);return Pa(E,m,this.localCapabilities.recv),Xi(E),E}updateRecvMedia(p,m){const E=this.sessionDesc.mediaDescriptions.findIndex(g=>g.attributes.mid===p);if(E!==-1){const g=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[E],m);this.sessionDesc.mediaDescriptions[E]=g}}bumpMid(p){this.currentMidIndex+=p}findFirstClosedMedia(p){return this.sessionDesc.mediaDescriptions.find(m=>Me()?m.media.port==="0"&&m.media.mediaType===p:m.media.port==="0")}findPreloadMediaDesc(p){return this.sessionDesc.mediaDescriptions.find(m=>{var E;return((E=m.attributes)===null||E===void 0||(E=E.ssrcs[0])===null||E===void 0?void 0:E.ssrcId)===p[0].ssrcId})}getSSRC(p){var m;return(m=this.sessionDesc.mediaDescriptions.find(E=>E.attributes.mid===p))===null||m===void 0?void 0:m.attributes.ssrcs}}({remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:this.localCapabilities,cname:s}),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);const a=this.remoteSDP.toString(),c=$e.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(p=>p.media.mediaType==="audio");d&&Xi(d),this.useXR&&Uu(c);const l=$e.print(c),u=this.logSDPExchange(l||"","offer","local","connect");this.store.descriptionStart(),await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),u==null||u(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a});const h=this.peerConnection.getTransceivers()[0];if(h!=null&&h.receiver&&this.tryBindTransportEvents(h.receiver),A("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia();const p=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:p});const m=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(m)}}catch(a){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(a.toString()))}}send(t,n,i){var r=this;return Wn(function*(){const o=yield ae(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");const s=[];t.forEach(E=>{const g=r.peerConnection.addTransceiver(E._mediaStreamTrack,{direction:"sendonly"});s.push(g),E._updateRtpTransceiver(g)}),Me()&&A("SIMULCAST")===!0&&(yield ae(r.applySimulcastForFirefox(s,t)));const a=yield ae(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(t.length),d=r.mungSendOfferSDP(a.sdp,t,c),l=$e.parse(d),u=c.map(E=>{const g=l.mediaDescriptions.find(S=>S.attributes.mid===E);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return tm(g,A("USE_PUB_RTX"))});let h;try{h=yield u}catch(E){h=[],r.remoteSDP.receive(t,n,i,h);const g=r.remoteSDP.toString();throw yield ae(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield ae(r.peerConnection.setRemoteDescription({type:"answer",sdp:g})),yield ae(r.stopSending(c,!0)),E}r.remoteSDP.receive(t,n,i,h);const p=r.remoteSDP.toString(),m=r.logSDPExchange(d,"offer","local","send");return yield ae(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield ae(r.applySimulcastEncodings(s,t)),yield ae(r.applySendEncodings(s,t)),m==null||m(p),yield ae(r.peerConnection.setRemoteDescription({type:"answer",sdp:p})),s.map((E,g)=>{const S=c[g];return{localSSRC:u[g],id:S,transceiver:E}})}catch(s){throw s instanceof L?s:new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);if(i&&i.readyState==="open")f.debug("[P2PConnection] Channels are already available and can be reused directly.");else{const o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");i=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:A("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)}n.forEach(o=>{o._updateOriginDataChannel(i)});const{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){const o=this.remoteSDP.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:o});const s=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(s),f.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else f.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(i){throw i instanceof L?i:new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(t){try{const n=this.dataStreamChannelMap.get(t);return n&&(n.id&&this.recoveredDataChannelIds.push(n.id),n.close()),void this.dataStreamChannelMap.delete(t)}catch(n){throw n instanceof L?n:new L(C.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(n.toString()))}}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;gl(this.id+c.mid),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();s==null||s(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(t,n,i,r);if(s){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,o,t);d==null||d(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),f.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," by exchanging SDP."))}else f.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(o){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(t);if(i){const r=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const s=await this.peerConnection.createAnswer();o==null||o(s.sdp||""),await this.peerConnection.setLocalDescription(s),f.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))}else f.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive no need to exchange SDP."));return n.map(r=>{const o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r,transceiver:o}})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,a)=>{s.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new L(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return Wn(function*(){const i=yield ae(n.mutex.lock("From P2PConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(ge().supportPCSetConfiguration){const d=n.peerConnection.getConfiguration(),l=t===_n.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(f.debug("[".concat(n.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,n.peerConnection.setConfiguration(d))}else if(t===_n.RELAY)return;n.remoteSDP.updateCandidates(t);const r=yield ae(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=Ji(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);const a=n.remoteSDP.toString(),c=n.logSDPExchange(r.sdp||"","offer","local","restartICE");n.store.descriptionStart(),yield ae(n.peerConnection.setLocalDescription(r)),c==null||c(a),yield ae(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){f.warning("[".concat(n.store.clientId,"] restart ICE failed, abort operation"),r)}finally{i()}})()}close(){var t;this.peerConnection.getTransceivers().forEach(n=>{gl(this.id+n.mid)}),this.peerConnection.close(),(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return F(F({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new L(C.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===t);i.length===1&&(this.isVP8Simulcast(n)?Me()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(t._mediaStreamTrack)}async getSelectedCandidatePair(){const t=this.peerConnection.getReceivers();if(t.length>0&&t[0].transport&&t[0].transport.iceTransport&&t[0].transport.iceTransport.getSelectedCandidatePair&&t[0].transport.iceTransport.getSelectedCandidatePair()){const n=t[0].transport.iceTransport,{local:i,remote:r}=n.getSelectedCandidatePair();return{local:F(F({},Ar),{},{candidateType:i.type,protocol:i.protocol,address:i.address,port:i.port}),remote:F(F({},Ar),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,f.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,f.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},A("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Ba(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...vc.turnServerConfigToIceServers(t.turnServer.servers)),A("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...vc.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),A("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),A("ENABLE_ENCODED_TRANSFORM")&&ge().supportWebRTCEncodedTransform&&(n.encodedInsertableStreams=!0),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(go(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!A("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}tryBindTransportEvents(t){const n=t.transport;if(n){this.transportEventReceiver=t,n.onstatechange=()=>{var r;n!=null&&n.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,n.state))},n.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r)};const i=n.iceTransport;i&&(i.onstatechange=()=>{const r=n==null?void 0:n.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){const{local:r,remote:o}=i.getSelectedCandidatePair();f.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}async updateRtpSenderEncodings(t,n){var i;if(n||(n=this.peerConnection.getSenders().find(h=>h.track===t._mediaStreamTrack)),!n)return f.warn("[".concat(t.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(t))return f.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!ge().supportSetRtpSenderParameters)return f.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");const r={},o={};switch(t._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;case"balanced":r.degradationPreference="balanced"}const s=function(u,h){return u.getTransceivers().find(p=>p.sender.track===h||p.receiver.track===h)}(this.peerConnection,t._mediaStreamTrack),a=z1(t);if(function(u){return!(!A("ENABLE_AG_ADAPTATION")||!(u instanceof $0||u._hints.includes(je.CUSTOM_TRACK))||!A("FORCE_SUPPORT_AG_ADAPTATION")&&!(tP(14)&&wA(17,4,!0)||AA(14)&&NA(17,4,!0)))}(t)&&s&&n&&a&&this.getLocalVideoStats&&["vp8","vp9"].includes(this.store.codec)){const u=r.degradationPreference||(t._hints.includes(je.CUSTOM_TRACK)?A("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");(function(h,p,m,E,g,S){if(gl(h),E!=="balanced"&&E!=="maintain-framerate"&&E!=="maintain-resolution")return;let T=-1;Ew(h,p);const I=window.setInterval(()=>{const w=Vu.get(h);if(!A("ENABLE_AG_ADAPTATION")||!w)return void gl(h);const D=S();if(D.sendPackets>0&&D.OutgoingAvailableBandwidth>0){if(T===-1)return void(T=Date.now());if(Date.now()-T<1e3)return;const O=D.sendFrameRate,P=D.OutgoingAvailableBandwidth,[x,U]=KM(h,O,P,w.adaptationConfig,p,E);U&&(m.qualityLimitationReason=U),x&&w.adaptationConfig.scale!==x.scale&&(f.debug("[".concat(h,"] applyAdaptation: ").concat(m.qualityLimitationReason,`
           sendFps `).concat(O,", bwe ").concat(P,", switch from ").concat(w.adaptationConfig.scale," to ").concat(x.scale," ")),w.adaptationConfig=F(F({},w.adaptationConfig),x),g(x))}},A("CHECK_LOCAL_STATS_INTERVAL")),y=F({},p);Vu.set(h,{timer:I,adaptationConfig:y,originConfig:p,adaptationFunc:g}),f.debug("[".concat(h,"] start adaptation, originConfig: ").concat(JSON.stringify(p),", degradationPreference: ").concat(E))})(this.id+s.mid,a,this,u,h=>{n&&this.updateAdaptation(n,h)},this.getLocalVideoStats.bind(this))}if(t._encoderConfig){const{bitrateMax:u,frameRate:h,scaleResolutionDownBy:p}=t._encoderConfig;u&&(o.maxBitrate=1e3*u),(t._hints.includes(je.LOW_STREAM)||t.isUseScaleResolutionDownBy)&&(h&&(o.maxFramerate=kn(h)),p&&p>=1&&(o.scaleResolutionDownBy=p))}const{maxFramerate:c}=A("ENCODER_CONFIG_LIMIT");if(c&&typeof c=="number"&&(o.maxFramerate=o.maxFramerate?Math.min(o.maxFramerate,c):c),A("DSCP_TYPE")&&ko()){const u=A("DSCP_TYPE");["very-low","low","medium","high"].includes(u)&&(o.networkPriority=u)}const d=n.getParameters(),l=(i=d.encodings)===null||i===void 0?void 0:i[0];Me()&&!l&&(r.encodings=[o]),l&&Object.assign(l,o),Object.assign(d,r),f.debug("[".concat(t.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(d.encodings))),await n.setParameters(d)}async updateAdaptation(t,n){var i;if(!t)return f.debug("[updateAdaptation] no rtpSender found");if(!ge().supportSetRtpSenderParameters)return f.debug("[updateAdaptation] Browser not support set rtp-sender parameters");const r={},{bitrateMax:o,frameRate:s,scaleResolutionDownBy:a}=n;o&&(r.maxBitrate=1e3*o),s&&(r.maxFramerate=kn(s)),a&&a>=1&&["vp8","vp9"].includes(this.store.codec)&&(r.scaleResolutionDownBy=a);const c=t.getParameters(),d=(i=c.encodings)===null||i===void 0?void 0:i[0];d&&Object.assign(d,r),Object.assign(c,{});try{await t.setParameters(c),f.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(c.encodings)))}catch(l){!("transport"in t)||t.transport&&t.transport.state==="connected"?this.peerConnectionState!=="connected"?f.debug("[updateAdaptation] peerConnection not connected}"):f.debug("[updateAdaptation] updateRtpSenderEncodings failed",l):f.debug("[updateAdaptation] rtpSender transport not connected}")}}async applySendEncodings(t,n){try{if(!ge().supportSetRtpSenderParameters||t.length!==n.length)return;for(let i=0;i<t.length;i++){const r=t[i],o=n[i];o instanceof Ge&&!this.isVP8Simulcast(o)&&await this.updateRtpSenderEncodings(o,r.sender)}}catch{f.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}}mungSendOfferSDP(t,n,i){const r=$e.parse(t);return n.forEach((o,s)=>{const a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Uo(c,o),im(c,o,this.store.codec))}),$e.print(r)}mungReceiveAnswerSDP(t,n,i){const r=$e.parse(t),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&(i===z.AUDIO&&o.media.mediaType==="audio"&&Xi(o),this.useXR&&Uu(r)),$e.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let a=0;a<t.length;a++){var i,r,o,s;const c=t[a],d=n[a];if(d instanceof Ge&&!d._hints.includes(je.LOW_STREAM)&&(i=d._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=d._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=d._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=d._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},u={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:u.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:u.high}];const h=c.sender.getParameters();await c.sender.setParameters(Object.assign(h,l))}}}async applySimulcastEncodings(t,n){if(!Me()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof Ge&&this.isVP8Simulcast(r)){const o=t[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(t){var n,i,r,o;return!!(t instanceof Ge&&A("SIMULCAST")&&this.store.codec==="vp8"&&!t._hints.includes(je.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((i=t._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(r=t._scalabilityMode)!==null&&r!==void 0&&r.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(A("SDP_LOGGING"))return f.upload("[".concat(this.store.clientId,"] exchanging ").concat(i," ").concat(n," SDP during P2PConnection.").concat(r,`
`),t),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n==null?void 0:n[0].ssrcId}setConfiguration(t){if(ge().supportPCSetConfiguration){const n=vc.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},B(Se.prototype,"updateRemoteRTPCapabilities",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"updateRemoteRTPCapabilities"),Se.prototype),B(Se.prototype,"connect",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"connect"),Se.prototype),B(Se.prototype,"createDataChannels",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"createDataChannels"),Se.prototype),B(Se.prototype,"receive",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"receive"),Se.prototype),B(Se.prototype,"batchReceive",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"batchReceive"),Se.prototype),B(Se.prototype,"stopReceiving",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"stopReceiving"),Se.prototype),B(Se.prototype,"muteRemote",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"muteRemote"),Se.prototype),B(Se.prototype,"unmuteRemote",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"unmuteRemote"),Se.prototype),B(Se.prototype,"muteLocal",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"muteLocal"),Se.prototype),B(Se.prototype,"unmuteLocal",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"unmuteLocal"),Se.prototype),B(Se.prototype,"close",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"close"),Se.prototype),B(Se.prototype,"updateEncoderConfig",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"updateEncoderConfig"),Se.prototype),B(Se.prototype,"updateSendParameters",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"updateSendParameters"),Se.prototype),B(Se.prototype,"replaceTrack",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"replaceTrack"),Se.prototype),B(Se.prototype,"updateAdaptation",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"updateAdaptation"),Se.prototype),B(Se.prototype,"getRemoteSSRC",[bn],Object.getOwnPropertyDescriptor(Se.prototype,"getRemoteSSRC"),Se.prototype),Se);function bn(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From P2PConnection.".concat(t));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}const cC=`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0
a=msid-semantic: WMS
a=ice-lite
m=application 9 UDP/DTLS/SCTP webrtc-datachannel
c=IN IP4 127.0.0.1
a=mid:0
`,Sl="9",Bp=2e4,Gp=4e4;class zM{get localCapabilities(){return xe(this._localCapabilities)}get rtpCapabilities(){return xe(this._rtpCapabilities)}get candidates(){return xe(this._candidates)}get iceParameters(){return xe(this._iceParameters)}get dtlsParameters(){return xe(this._dtlsParameters)}constructor(t){this.sessionDesc=void 0,this._localCapabilities=void 0,this._rtpCapabilities=void 0,this._candidates=void 0,this._iceParameters=void 0,this._dtlsParameters=void 0,this.setup=void 0,this.currentMidIndex=void 0,this.cname=void 0,this.firefoxSsrcMidMap=new Map,t=xe(t);const{remoteIceParameters:n,remoteDtlsParameters:i,candidates:r,remoteRTPCapabilities:o,remoteSetup:s,localCapabilities:a,cname:c}=t,d=$e.parse(cC);this._rtpCapabilities=o,this._candidates=r,this._iceParameters=n,this._dtlsParameters=i,this._localCapabilities=a,this.setup=s,this.cname=c;const l=this.rtpCapabilities.send;for(const u of d.mediaDescriptions){if(u.attributes.iceUfrag=n.iceUfrag,u.attributes.icePwd=n.icePwd,u.attributes.fingerprints=i.fingerprints,u.attributes.candidates=r,u.attributes.setup=s,u.media.mediaType==="application"&&(u.attributes.sctpPort="5000"),u.media.mediaType==="video"&&(u.media.fmts=l.videoCodecs.map(h=>h.payloadType.toString(10)),u.attributes.payloads=l.videoCodecs,u.attributes.extmaps=l.videoExtensions,A("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:h,ssrcGroups:p}=Xn([{ssrcId:Gp,rtx:A("USE_SUB_RTX")?40001:void 0}],this.cname);u.attributes.ssrcs=h,u.attributes.ssrcGroups=p}if(u.media.mediaType==="audio"&&(u.media.fmts=l.audioCodecs.map(h=>h.payloadType.toString(10)),u.attributes.payloads=l.audioCodecs,u.attributes.extmaps=l.audioExtensions,Xi(u),A("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:h,ssrcGroups:p}=Xn([{ssrcId:Bp}],this.cname);u.attributes.ssrcs=h,u.attributes.ssrcGroups=p}}this.sessionDesc=d,this.currentMidIndex=d.mediaDescriptions.length-1}updateRemoteRTPCapabilities(t){const n=$e.parse(cC);this._rtpCapabilities=t;const i=this.rtpCapabilities.send;for(const r of n.mediaDescriptions){if(r.attributes.iceUfrag=this._iceParameters.iceUfrag,r.attributes.icePwd=this._iceParameters.icePwd,r.attributes.fingerprints=this._dtlsParameters.fingerprints,r.attributes.candidates=this._candidates,r.attributes.setup=this.setup,r.media.mediaType==="application"&&(r.attributes.sctpPort="5000"),r.media.mediaType==="video"&&(r.media.fmts=i.videoCodecs.map(o=>o.payloadType.toString(10)),r.attributes.payloads=i.videoCodecs,r.attributes.extmaps=i.videoExtensions,A("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:o,ssrcGroups:s}=Xn([{ssrcId:Gp,rtx:A("USE_SUB_RTX")?40001:void 0}],this.cname);r.attributes.ssrcs=o,r.attributes.ssrcGroups=s}if(r.media.mediaType==="audio"&&(r.media.fmts=i.audioCodecs.map(o=>o.payloadType.toString(10)),r.attributes.payloads=i.audioCodecs,r.attributes.extmaps=i.audioExtensions,A("PRELOAD_MEDIA_COUNT")>0)){const{ssrcs:o,ssrcGroups:s}=Xn([{ssrcId:Bp}],this.cname);r.attributes.ssrcs=o,r.attributes.ssrcGroups=s}}this.sessionDesc=n,this.currentMidIndex=n.mediaDescriptions.length-1}preloadRemoteMedia(t){this.rtpCapabilities;const n=this.candidates,i=this.dtlsParameters,r=this.iceParameters,o=this.rtpCapabilities.send;for(let s=1;s<t;s++){const a=2*s+Bp,c=2*s+Gp,{ssrcs:d,ssrcGroups:l}=Xn([{ssrcId:a}],this.cname),{ssrcs:u,ssrcGroups:h}=Xn([{ssrcId:c,rtx:A("USE_SUB_RTX")?c+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Sl,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.videoCodecs.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:n,extmaps:o.videoExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:u,ssrcGroups:h,rtcpFeedbackWildcards:[],payloads:o.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s-1)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Sl,protos:["UDP","TLS","RTP","SAVPF"],fmts:o.audioCodecs.map(p=>p.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:r.iceUfrag,icePwd:r.icePwd,unrecognized:[],candidates:n,extmaps:o.audioExtensions,fingerprints:i.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:d,ssrcGroups:l,rtcpFeedbackWildcards:[],payloads:o.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(2*s)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return $e.print(this.sessionDesc)}send(t,n,i,r){const{ssrcs:o,ssrcGroups:s}=Xn(n,this.cname,A("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(o);if(a){if(Me()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){const c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{const c=this.findAvailableMediaIndex(t,o);let d;return c===-1||Gt()||dn()||OA()||c===0&&A("USE_SUB_RTX")?(d=this.createOrRecycleSendMedia(t,o,s,"sendonly",r),this.updateBundleMids()):(d=xe(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),Me()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{mid:d.attributes.mid,needExchangeSDP:!0}}}batchSend(t){const n=t.map(o=>{let{kind:s,ssrcMsg:a,mslabel:c}=o;return this.send(s,a,c)}),i=[];let r=!1;return n.forEach(o=>{let{mid:s,needExchangeSDP:a}=o;a&&(r=!0),i.push(s)}),{mids:i,needExchangeSDP:r}}stopSending(t){const n=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&t.indexOf(i.attributes.mid)!==-1);if(n.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");n.forEach(i=>{i.attributes.mid==="0"||Me()||Gt()||dn()?i.attributes.ssrcs=[]:(i.attributes.ssrcs=[],i.attributes.direction="inactive",i.media.port="0")}),this.updateBundleMids()}mute(t){const n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t);if(!n)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.mute."));n.attributes.direction="inactive"}unmute(t){const n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t);if(!n)throw new Error("mediaDescription not found with ".concat(t," in remote SDP when calling RemoteSDP.unmute."));n.attributes.direction="sendonly"}muteRemote(t){const n=this.sessionDesc.mediaDescriptions.filter(i=>t.includes(i.attributes.mid||""));if(n.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(t){const n=this.sessionDesc.mediaDescriptions.filter(i=>t.includes(i.attributes.mid||""));if(n.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");n.forEach(i=>{i.attributes.direction="recvonly"})}receive(t,n,i,r){t.forEach((o,s)=>{this.createOrRecycleRecvMedia(o,[],"recvonly",n,i,r[s])}),this.updateBundleMids()}stopReceiving(t){const n=this.sessionDesc.mediaDescriptions.filter(i=>t.indexOf(i.attributes.mid)!==-1);if(n.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");n.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}updateCandidates(t){t===_n.TCP?this._candidates.forEach(n=>{this._candidates.findIndex(i=>i.transport==="tcp"&&i.connectionAddress===n.connectionAddress&&i.port===n.port)===-1&&this._candidates.push(F(F({},n),{},{foundation:"tcpcandidate",priority:Number(n.priority)-1+"",transport:"tcp",port:Number(n.port)+90+""}))}):this._candidates=this._candidates.filter(n=>n.transport!=="tcp");for(const n of this.sessionDesc.mediaDescriptions)n.attributes.candidates=this.candidates}restartICE(t){t=xe(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(n=>{n.attributes.iceUfrag=t.iceUfrag,n.attributes.icePwd=t.icePwd})}predictReceivingMids(t){const n=[];for(let i=0;i<t;i++)n.push((this.currentMidIndex+i+1).toString(10));return n}findAvailableMediaIndex(t,n){return this.sessionDesc.mediaDescriptions.findIndex(i=>{const r=i.media.mediaType===t&&i.media.port!=="0"&&(i.attributes.direction==="sendonly"||i.attributes.direction==="sendrecv")&&i.attributes.ssrcs.length===0;if(Me()){if(r){const o=this.firefoxSsrcMidMap.get(n[0].ssrcId);return!(o||i.attributes.mid!=="0"&&i.attributes.mid!=="1")||!(!o||o!==i.attributes.mid)}return!1}return r})}createOrRecycleRecvMedia(t,n,i,r,o,s){const a=t._mediaStreamTrack.kind,c=this.rtpCapabilities.recv,d=us(a,c,this.localCapabilities.send,a===z.VIDEO?r:o),l=a===z.VIDEO?c.videoExtensions:c.audioExtensions;this.currentMidIndex+=1;const u="".concat(this.currentMidIndex);let h={media:{mediaType:a,port:Sl,protos:["UDP","TLS","RTP","SAVPF"],fmts:d.map(m=>m.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:l,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:d,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(u)}};h=this.mungRecvMediaDsec(h,t,s);const p=this.findFirstClosedMedia(a);if(p){const m=this.sessionDesc.mediaDescriptions.indexOf(p);this.sessionDesc.mediaDescriptions[m]=h}else this.sessionDesc.mediaDescriptions.push(h);return h}updateRemoteCodec(t,n,i){const r=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(h=>h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"").filter(h=>Object.keys(wa).includes(h)))],o=new Set(n);if(r.every(h=>o.has(h)))return f.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(n)),!1;const s=this._rtpCapabilities.recv.videoCodecs.filter(h=>n.some(p=>(h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||"").includes(p)));if(s.length===0)return f.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(r," codecs: ").concat(n)),!1;const a=[...new Set(s.map(h=>h.rtpMap&&h.rtpMap.encodingName.toLowerCase()||""))];let c;if(f.debug("updateRemoteCodec, from ".concat(r," to ").concat(a)),t.length===0)c=this.sessionDesc.mediaDescriptions.filter(h=>h.media.mediaType==="video"&&h.attributes.direction==="recvonly");else if(c=this.sessionDesc.mediaDescriptions.filter(h=>h.attributes.mid&&t.includes(h.attributes.mid)&&h.attributes.direction==="recvonly"),c.length!==t.length)return f.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(t,", codecs: ").concat(n)),!1;this._rtpCapabilities.recv.videoCodecs=s;const d=this.localCapabilities.send,l=this.rtpCapabilities.recv,u=us(z.VIDEO,l,d,i);return c.forEach(h=>{const p=u.map(m=>m.payloadType.toString(10));f.debug("updateRemoteCodec mid: ".concat(h.attributes.mid,", from ").concat(h.attributes.payloads," to ").concat(u)),h.attributes.payloads=u,h.media.fmts=p}),!0}createOrRecycleSendMedia(t,n,i,r,o){const s=this.rtpCapabilities.send,a=t===z.VIDEO?s.videoCodecs:s.audioCodecs,c=t===z.VIDEO?s.videoExtensions:s.audioExtensions;this.currentMidIndex+=1;const d="".concat(this.currentMidIndex);let l={media:{mediaType:t,port:Sl,protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:n,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:r,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungSendMediaDesc(l,o);const u=this.findFirstClosedMedia(t);if(u){const h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}mungRecvMediaDsec(t,n,i){const r=xe(t);return Ih(r),Uo(r,n),yh(r,n),nm(r),Pa(r,i,this.localCapabilities.send),r}mungSendMediaDesc(t,n){const i=xe(t);return Pa(i,n,this.localCapabilities.recv),Xi(i),i}updateRecvMedia(t,n){const i=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===t);if(i!==-1){const r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],n);this.sessionDesc.mediaDescriptions[i]=r}}bumpMid(t){this.currentMidIndex+=t}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(n=>Me()?n.media.port==="0"&&n.media.mediaType===t:n.media.port==="0")}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(n=>{var i;return((i=n.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===t[0].ssrcId})}getSSRC(t){var n;return(n=this.sessionDesc.mediaDescriptions.find(i=>i.attributes.mid===t))===null||n===void 0?void 0:n.attributes.ssrcs}}var Te;let YM=(Te=class Zl extends Ch{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){let t;return this.localCapabilities&&(t=La(this.localCapabilities)),[...new Set(t&&t.send.videoCodecs.map(n=>n.rtpMap&&n.rtpMap.encodingName.toLowerCase()||"").filter(n=>Object.keys(wa).includes(n)))]}constructor(t,n,i){super(t,n),this.store=void 0,this.peerConnection=void 0,this.remoteSDP=void 0,this.initialOffer=void 0,this.transportEventReceiver=void 0,this.statsFilter=void 0,this.useXR=A("USE_XR"),this.localCapabilities=void 0,this.localCandidateCount=0,this.allCandidatesReceived=!1,this.remoteCodecs=void 0,this.dataStreamChannelMap=new Map,this.establishPromise=void 0,this.mutex=new Bt("NVExtentionsConnection-mutex"),this.rtcMedia=void 0,this.store=n,this.peerConnection=i,this.statsFilter=vh(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,Me()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}async establish(t){try{const n=await this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");const i=Ji(n.sdp),r=await rm({filterRTX:!A("USE_PUB_RTX")&&!A("USE_SUB_RTX"),filterVideoFec:A("FILTER_VIDEO_FEC"),filterAudioFec:A("FILTER_AUDIO_FEC"),filterVideoCodec:A("FILTER_VIDEO_CODEC")},{useXR:this.useXR});return this.localCapabilities=r,this.initialOffer=n,F(F({},i),{},{rtpCapabilities:r,offerSDP:n.sdp})}catch(n){throw new N(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}}async connect(t,n,i,r,o,s){try{if(!this.initialOffer)throw new Error("Cannot establish NVConnection without initial offer.");this.remoteSDP=new zM({remoteIceParameters:t,remoteDtlsParameters:n,candidates:i,remoteRTPCapabilities:r,remoteSetup:o,localCapabilities:La(this.localCapabilities),cname:s});const a=this.remoteSDP.toString(),c=$e.parse(this.initialOffer.sdp),d=c.mediaDescriptions.find(h=>h.media.mediaType==="audio");d&&Xi(d),this.useXR&&Uu(c);const l=$e.print(c),u=this.logSDPExchange(l||"","offer","local","connect");await this.peerConnection.setLocalDescription({type:"offer",sdp:l}),u==null||u(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(a){throw new N(C.EXCHANGE_SDP_FAILED,"NV.connect failed; ".concat(a.toString()))}}async updateRemoteRTPCapabilities(t,n){if(this.remoteCodecs=n,!this.remoteSDP)return void f.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(n));if(this.remoteSDP.updateRemoteCodec(t,n,this.store.codec)){const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else f.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")}async updateRemoteConnect(t){var n,i,r,o;(n=this.remoteSDP)===null||n===void 0||n.updateRemoteRTPCapabilities(t),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&((o=this.remoteSDP)===null||o===void 0||o.updateRemoteCodec([],this.remoteCodecs,this.store.codec)),(i=this.remoteSDP)===null||i===void 0||i.preloadRemoteMedia(2);const s=(r=this.remoteSDP)===null||r===void 0?void 0:r.toString();await this.peerConnection.setRemoteDescription({type:"offer",sdp:s});const a=await this.peerConnection.createAnswer();await this.peerConnection.setLocalDescription(a),f.debug("[NVExtentionsConnection] updateRemoteRTPCapabilities by exchanging SDP.")}send(t,n,i){var r=this;return Wn(function*(){const o=yield ae(r.mutex.lock("From NVExtentionsConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.send before remote SDP created");const s=[];t.forEach(E=>{const g=r.peerConnection.addTransceiver(E._mediaStreamTrack,{direction:"sendonly"});s.push(g)}),Me()&&A("SIMULCAST")===!0&&(yield ae(r.applySimulcastForFirefox(s,t)));const a=yield ae(r.peerConnection.createOffer()),c=r.remoteSDP.predictReceivingMids(t.length),d=r.mungSendOfferSDP(a.sdp,t,c),l=$e.parse(d),u=c.map(E=>{const g=l.mediaDescriptions.find(S=>S.attributes.mid===E);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return tm(g,A("USE_PUB_RTX"))});let h;try{h=yield u}catch(E){h=[],r.remoteSDP.receive(t,n,i,h);const g=r.remoteSDP.toString();throw yield ae(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield ae(r.peerConnection.setRemoteDescription({type:"answer",sdp:g})),yield ae(r.stopSending(c,!0)),E}r.remoteSDP.receive(t,n,i,h);const p=r.remoteSDP.toString(),m=r.logSDPExchange(d,"offer","local","send");return yield ae(r.peerConnection.setLocalDescription({type:"offer",sdp:d})),yield ae(r.applySimulcastEncodings(s,t)),yield ae(r.applySendEncodings(s,t)),m==null||m(p),yield ae(r.peerConnection.setRemoteDescription({type:"answer",sdp:p})),s.map((E,g)=>{const S=c[g];return{localSSRC:u[g],id:S,transceiver:E}})}catch(s){throw s instanceof N?s:new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.send failed; ".concat(s.toString()))}finally{o()}})()}async stopSending(t,n){const i=n?void 0:await this.mutex.lock("From NVExtentionsConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopSending before remote SDP created");const r=this.peerConnection.getTransceivers().filter(c=>t.indexOf(c.mid)!==-1);if(r.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call NVExtentionsConnection.stopSending.");r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});const o=await this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");await this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(t);const a=this.remoteSDP.toString();s==null||s(a),await this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.stopSending failed; ".concat(r.toString()))}finally{i&&i()}}async createDataChannels(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.createDataChannels before remote SDP created");let i=this.dataStreamChannelMap.get(t);return i&&i.readyState==="open"?f.debug("[P2PConnection] Channels are already available and can be reused directly."):(i=this.peerConnection.createDataChannel("datastream-channel",{ordered:!1,maxRetransmits:A("DATASTREAM_MAX_RETRANSMITS")}),i.binaryType="arraybuffer",this.dataStreamChannelMap.set(t,i)),void n.forEach(r=>{r._updateOriginDataChannel(i)})}catch(i){throw i instanceof N?i:new N(C.DATACHANNEL_FAILED,"NVExtentionsConnection.createDataChannels failed; ".concat(i.toString()))}}async stopDataChannels(t){try{const n=this.dataStreamChannelMap.get(t);return n==null||n.close(),void this.dataStreamChannelMap.delete(t)}catch(n){throw n instanceof N?n:new N(C.DATACHANNEL_FAILED,"NVExtentionsConnection.stopDataChannels failed; ".concat(n.toString()))}}async receive(t,n,i,r){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.receive ".concat(t," before remoteSDP created."));const{mid:o,needExchangeSDP:s}=this.remoteSDP.send(t,n,i,r);if(s){const c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:c});const l=await this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,o,t);d==null||d(u||""),await this.peerConnection.setLocalDescription({type:"answer",sdp:u}),f.debug("[NVExtentionsConnection] receive ".concat(t," by exchanging SDP."))}else f.debug("[NVExtentionsConnection] receive ".concat(t," no need to exchange SDP."));const a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o}}catch(o){throw new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(o.toString()))}}async batchReceive(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.batchReceive before remoteSDP created.");const{mids:n,needExchangeSDP:i}=this.remoteSDP.batchSend(t);if(i){const r=this.remoteSDP.toString(),o=this.logSDPExchange(r,"offer","remote","receive");await this.peerConnection.setRemoteDescription({type:"offer",sdp:r});const s=await this.peerConnection.createAnswer();o==null||o(s.sdp||""),await this.peerConnection.setLocalDescription(s),f.debug("[NVExtentionsConnection] batchReceive by exchanging SDP.")}else f.debug("[NVExtentionsConnection] batchReceive no need to exchange SDP.");return n.map(r=>{const o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r}})}catch(n){throw new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.receive failed; ".concat(n.toString()))}}async stopReceiving(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","stopReceiving");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection stopReceiving failed; ".concat(n.toString()))}}async muteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.mute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","muteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteRemote failed; ".concat(n.toString()))}}async unmuteRemote(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteRemote mid=".concat(t," before remote SDP created."));this.remoteSDP.unmute(t);const n=this.remoteSDP.toString(),i=this.logSDPExchange(n,"offer","remote","unmuteRemote");await this.peerConnection.setRemoteDescription({type:"offer",sdp:n});const r=await this.peerConnection.createAnswer();i==null||i(r.sdp||""),await this.peerConnection.setLocalDescription(r)}catch(n){throw new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteRemote failed; ".concat(n.toString()))}}async muteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.muteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(s=>{s.direction="inactive"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","muteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.muteRemote(t);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.muteLocal failed; ".concat(n.toString()))}}async unmuteLocal(t){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.unmuteLocal before remote SDP created.");const n=this.peerConnection.getTransceivers().filter(s=>s.mid&&t.indexOf(s.mid)!==-1);if(n.length!==t.length)throw new Error("Transceivers' length doesn't match mids' length.");n.map(async(s,a)=>{s.direction="sendonly"});const i=await this.peerConnection.createOffer(),r=this.logSDPExchange(i.sdp||"","offer","local","unmuteLocal");await this.peerConnection.setLocalDescription(i),this.remoteSDP.unmuteRemote(t);const o=this.remoteSDP.toString();r==null||r(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new N(C.EXCHANGE_SDP_FAILED,"NVExtentionsConnection.unmuteLocal failed; ".concat(n.toString()))}}restartICE(t){var n=this;return Wn(function*(){const i=yield ae(n.mutex.lock("From NVExtentionsConnection.restartICE"));try{if(!n.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");if(ge().supportPCSetConfiguration){const d=n.peerConnection.getConfiguration(),l=t===_n.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(f.debug("restartICE change iceTransportPolicy from [".concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,n.peerConnection.setConfiguration(d))}else if(t===_n.RELAY)return;t!==_n.RELAY&&n.remoteSDP.updateCandidates(t);const r=yield ae(n.peerConnection.createOffer({iceRestart:!0}));if(!r.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");const o=Ji(r.sdp),{remoteIceParameters:s}=yield o.iceParameters;n.remoteSDP.restartICE(s);const a=n.remoteSDP.toString(),c=n.logSDPExchange(r.sdp||"","offer","local","restartICE");yield ae(n.peerConnection.setLocalDescription(r)),c==null||c(a),yield ae(n.peerConnection.setRemoteDescription({type:"answer",sdp:a}))}catch(r){f.warning("restart ICE failed, abort operation",r)}finally{i()}})()}close(){var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(t){return this.statsFilter.getVideoIsReady(t)}async updateEncoderConfig(t,n){try{if(!this.remoteSDP)throw new Error("Cannot call NVExtentionsConnection.updateEncoderConfig before remote SDP created.");const i=await this.peerConnection.createOffer(),r=this.mungSendOfferSDP(i.sdp,[n],[t]);this.remoteSDP.updateRecvMedia(t,n);const o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");await this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s==null||s(o),await this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new N(C.EXCHANGE_SDP_FAILED,i.toString())}}async updateSendParameters(t,n){const i=this.peerConnection.getTransceivers().filter(r=>r.mid===t);i.length===1&&(this.isVP8Simulcast(n)?Me()||await this.applySimulcastEncodings(i,[n]):await this.applySendEncodings(i,[n]))}setStatsRemoteVideoIsReady(t,n){this.statsFilter.setVideoIsReady2(t,n)}async replaceTrack(t,n){const i=this.peerConnection.getTransceivers().find(r=>r.mid===n);i&&await i.sender.replaceTrack(t._mediaStreamTrack)}getP2PConnectionParams(){var t;if((t=this.peerConnection.currentLocalDescription)===null||t===void 0||!t.sdp||!this.localCapabilities)throw new Error;return F(F({},Ji(this.peerConnection.currentLocalDescription.sdp)),{},{rtpCapabilities:this.localCapabilities})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var t;(t=this.onICEConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=t=>{t.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,f.debug("[pc-".concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,f.debug("[pc-".concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},A("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Ba(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...Zl.turnServerConfigToIceServers(t.turnServer.servers)),A("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...Zl.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),A("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(go(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!A("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}async applySendEncodings(t,n){try{if(!ge().supportSetRtpSenderParameters||t.length!==n.length)return;for(let d=0;d<t.length;d++){const l=t[d],u=n[d];if(u&&u instanceof Ge){var i,r;if(this.isVP8Simulcast(u))continue;const h={},p={};switch(u._optimizationMode){case"motion":h.degradationPreference="maintain-framerate";break;case"detail":h.degradationPreference="maintain-resolution";break;default:h.degradationPreference="balanced"}var o,s,a,c;if((i=u._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&(p.maxBitrate=1e3*((o=u._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)),u._hints.includes(je.LOW_STREAM)&&((s=u._encoderConfig)!==null&&s!==void 0&&s.frameRate&&(p.maxFramerate=kn(u._encoderConfig.frameRate)),(a=u._encoderConfig)!==null&&a!==void 0&&a.scaleResolutionDownBy&&((c=u._encoderConfig)===null||c===void 0?void 0:c.scaleResolutionDownBy)>1&&(p.scaleResolutionDownBy=u._encoderConfig.scaleResolutionDownBy)),A("DSCP_TYPE")&&ko()){const g=A("DSCP_TYPE");["very-low","low","medium","high"].includes(g)&&(p.networkPriority=g)}const m=l.sender.getParameters(),E=(r=m.encodings)===null||r===void 0?void 0:r[0];Me()&&!E&&(h.encodings=[p]),E&&Object.assign(E,p),Object.assign(m,h),await l.sender.setParameters(m)}}}catch{f.debug("Apply RTPSendEncodings failed.")}}mungSendOfferSDP(t,n,i){const r=$e.parse(t);return n.forEach((o,s)=>{const a=i[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(Uo(c,o),im(c,o,this.store.codec))}),$e.print(r)}mungReceiveAnswerSDP(t,n,i){const r=$e.parse(t),o=r.mediaDescriptions.find(s=>s.attributes.mid===n);return o&&i===z.AUDIO&&o.media.mediaType==="audio"&&Xi(o),this.useXR&&Uu(r),$e.print(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=t=>{var n;(n=this.onFirstAudioReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoReceived=t=>{var n;(n=this.onFirstVideoReceived)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstAudioDecoded=t=>{var n;(n=this.onFirstAudioDecoded)===null||n===void 0||n.call(this,t)},this.statsFilter.onFirstVideoDecoded=(t,n,i)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,t,n,i)},this.statsFilter.onSelectedLocalCandidateChanged=(t,n)=>{var i;(i=this.onSelectedLocalCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onSelectedRemoteCandidateChanged=(t,n)=>{var i;(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0||i.call(this,t,n)},this.statsFilter.onFirstVideoDecodedTimeout=t=>{var n;(n=this.onFirstVideoDecodedTimeout)===null||n===void 0||n.call(this,t)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}async applySimulcastForFirefox(t,n){if(t.length===n.length)for(let a=0;a<t.length;a++){var i,r,o,s;const c=t[a],d=n[a];if(d instanceof Ge&&!d._hints.includes(je.LOW_STREAM)&&(i=d._encoderConfig)!==null&&i!==void 0&&i.bitrateMax&&((r=d._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=d._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=d._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1&&this.store.codec==="vp8"){const l={},u={high:1e3*(d._encoderConfig.bitrateMax-50),medium:5e4};l.encodings=[{rid:"m",active:!0,maxBitrate:u.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:u.high}];const h=c.sender.getParameters();await c.sender.setParameters(Object.assign(h,l))}}}async applySimulcastEncodings(t,n){if(!Me()&&t.length===n.length)for(let i=0;i<t.length;i++){const r=n[i];if(r instanceof Ge&&this.isVP8Simulcast(r)){const o=t[i],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];const c=o.sender.getParameters();await o.sender.setParameters(Object.assign(c,s))}}}isVP8Simulcast(t){var n,i,r,o;return!!(t instanceof Ge&&A("SIMULCAST")&&this.store.codec==="vp8"&&!t._hints.includes(je.LOW_STREAM)&&(n=t._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((i=t._encoderConfig)===null||i===void 0?void 0:i.bitrateMax)>200&&(r=t._scalabilityMode)!==null&&r!==void 0&&r.numSpatialLayers&&((o=t._scalabilityMode)===null||o===void 0?void 0:o.numSpatialLayers)>1)}logSDPExchange(t,n,i,r){if(A("SDP_LOGGING"))return f.upload("exchanging ".concat(i," ").concat(n," SDP during NVExtentionsConnection.").concat(r,`
`),t),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}async getRemoteSSRC(t){if(!this.remoteSDP)return;const n=this.remoteSDP.getSSRC(t);return n==null?void 0:n[0].ssrcId}setConfiguration(t){if(ge().supportPCSetConfiguration){const n=Zl.resolvePCConfiguration(t);this.peerConnection.setConfiguration(n)}}},B(Te.prototype,"connect",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"connect"),Te.prototype),B(Te.prototype,"updateRemoteRTPCapabilities",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"updateRemoteRTPCapabilities"),Te.prototype),B(Te.prototype,"updateRemoteConnect",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"updateRemoteConnect"),Te.prototype),B(Te.prototype,"createDataChannels",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"createDataChannels"),Te.prototype),B(Te.prototype,"receive",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"receive"),Te.prototype),B(Te.prototype,"batchReceive",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"batchReceive"),Te.prototype),B(Te.prototype,"stopReceiving",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"stopReceiving"),Te.prototype),B(Te.prototype,"muteRemote",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"muteRemote"),Te.prototype),B(Te.prototype,"unmuteRemote",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"unmuteRemote"),Te.prototype),B(Te.prototype,"muteLocal",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"muteLocal"),Te.prototype),B(Te.prototype,"unmuteLocal",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"unmuteLocal"),Te.prototype),B(Te.prototype,"close",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"close"),Te.prototype),B(Te.prototype,"updateEncoderConfig",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"updateEncoderConfig"),Te.prototype),B(Te.prototype,"updateSendParameters",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"updateSendParameters"),Te.prototype),B(Te.prototype,"replaceTrack",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"replaceTrack"),Te.prototype),B(Te.prototype,"getRemoteSSRC",[Dn],Object.getOwnPropertyDescriptor(Te.prototype,"getRemoteSSRC"),Te.prototype),Te);function Dn(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From NVExtentionsConnection.".concat(t));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}var ye;let eo=(ye=class eu extends Ch{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get localCodecs(){return this._p2pConnection.localCodecs}constructor(t,n){super(t,n),this.store=void 0,this.peerConnection=void 0,this.cname=void 0,this.mutex=new Bt("DataChannelConnection-mutex"),this.dataChannel=void 0,this._p2pConnection=void 0,this.establishPromise=void 0,this._nvMedia=void 0,this.store=n,this.store.dcId=this.store.dcId+1,this.peerConnection=new RTCPeerConnection(eu.resolvePCConfiguration(t),{optional:[{googDscp:!0}]}),this.dataChannel=this.peerConnection.createDataChannel("agora-signal",{ordered:!1,maxPacketLifeTime:50}),this.dataChannel.binaryType="arraybuffer",this._p2pConnection=new YM(t,n,this.peerConnection),this.bindPCEvents(),this.establishPromise=this._p2pConnection.establishPromise}async establish(){var t;const n=(t=this._nvMedia)===null||t===void 0?void 0:t.getLocalRtpCapabilities();return await this._p2pConnection.establish(n)}getP2PConnectionParams(){return this._p2pConnection.getP2PConnectionParams()}async connect(t,n,i,r,o,s){return this.cname=s,await this._p2pConnection.connect(t,n,i,r,o,s),await new Promise((a,c)=>{const d=setTimeout(()=>{this.closeSignal(),c(new N(C.DATACHANNEL_CONNECTION_TIMEOUT,"Datachannel connection timed out, candidates: ".concat(JSON.stringify(i))))},2e3);this.dataChannel.onopen=()=>{if(this.dataChannel.readyState==="open")return clearTimeout(d),void a()},this.dataChannel.onerror=l=>{this.closeSignal(),c(l)}}),{transmitter:this.dataChannel,close:this.closeSignal.bind(this)}}async updateRemoteRTPCapabilities(t,n){return this._p2pConnection.updateRemoteRTPCapabilities(t,n)}send(t,n,i){var r=this;return Wn(function*(){const o=yield ae(r.mutex.lock("From DataChannelConnection.send"));try{return yield*Lu(ku(r._p2pConnection.send(t,n,i)))}finally{o()}})()}async stopSending(t,n){return this._p2pConnection.stopSending(t,n)}async createDataChannels(t,n){return this._p2pConnection.createDataChannels(t,n)}async stopDataChannels(t){return this._p2pConnection.stopDataChannels(t)}async receive(t,n,i,r){return this._nvMedia?(f.debug("[DataChannelConnection] receive ".concat(t," by DataChannel.")),await this._nvMedia.reveiveByRTCMedia(t,n,this.cname)):(f.debug("[DataChannelConnection] receive ".concat(t," by WebRTC.")),await this._p2pConnection.receive(t,n,i,r))}async batchReceive(t){return[...await this._p2pConnection.batchReceive(t)]}async stopReceiving(t){return await this._p2pConnection.stopReceiving(t)}async muteRemote(t){return await this._p2pConnection.muteRemote(t)}async unmuteRemote(t){return await this._p2pConnection.unmuteRemote(t)}async muteLocal(t){return await this._p2pConnection.muteLocal(t)}async unmuteLocal(t){return await this._p2pConnection.unmuteLocal(t)}restartICE(t){var n=this;return Wn(function*(){return yield*Lu(ku(n._p2pConnection.restartICE(t)))})()}close(){var t;(t=this._nvMedia)===null||t===void 0||t.close(),this._p2pConnection.close(),this.unbindConnectionEvents(this._p2pConnection)}getStats(){return this._p2pConnection.getStats()}getRemoteVideoIsReady(t){return this._p2pConnection.getRemoteVideoIsReady(t)}updateRemoteConnect(t){var n;(n=this._nvMedia)===null||n===void 0||n.setRemoteRtpCapabilities(t),this._p2pConnection.updateRemoteConnect(t)}async updateEncoderConfig(t,n){return await this._p2pConnection.updateEncoderConfig(t,n)}async updateSendParameters(t,n){return await this._p2pConnection.updateSendParameters(t,n)}setStatsRemoteVideoIsReady(t,n){this._p2pConnection.setStatsRemoteVideoIsReady(t,n)}async replaceTrack(t,n){return await this._p2pConnection.replaceTrack(t,n)}async getRemoteSSRC(t){return this._p2pConnection.getRemoteSSRC(t)}logSDPExchange(t,n,i,r){if(A("SDP_LOGGING"))return f.upload("exchanging ".concat(i," ").concat(n," SDP during DataChannelConnection.").concat(r,`
`),t),n==="offer"?o=>{this.logSDPExchange(o,"answer",i==="local"?"remote":"local",r)}:void 0}static resolvePCConfiguration(t){const n={iceServers:[]};return t.iceServers?n.iceServers=t.iceServers:t.turnServer&&t.turnServer.mode!=="off"&&(Ba(t.turnServer.servers)?n.iceServers=t.turnServer.servers:(n.iceServers&&n.iceServers.push(...eu.turnServerConfigToIceServers(t.turnServer.servers)),A("USE_TURN_SERVER_OF_GATEWAY")&&n.iceServers&&t.turnServer.serversFromGateway&&n.iceServers.push(...eu.turnServerConfigToIceServers(t.turnServer.serversFromGateway)),A("FORCE_TURN_TCP")?n.iceTransportPolicy="relay":t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).forEach(i=>{i.forceturn&&(n.iceTransportPolicy="relay")}))),n}static turnServerConfigToIceServers(t){const n=[];return t.forEach(i=>{i.security?i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turns:".concat(go(i.turnServerURL),":").concat(i.tcpport,"?transport=tcp")}):(i.udpport&&!A("FORCE_TURN_TCP")&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.udpport,"?transport=udp")}),i.tcpport&&n.push({username:i.username,credential:i.password,credentialType:"password",urls:"turn:".concat(i.turnServerURL,":").concat(i.tcpport,"?transport=tcp")}))}),n}bindPCEvents(){this._p2pConnection.onICEConnectionStateChange=t=>{var n;return(n=this.onICEConnectionStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onConnectionStateChange=t=>{var n;return(n=this.onConnectionStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onDTLSTransportStateChange=t=>{var n;return(n=this.onDTLSTransportStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onDTLSTransportError=t=>{var n;return(n=this.onDTLSTransportError)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onICETransportStateChange=t=>{var n;return(n=this.onICETransportStateChange)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstAudioReceived=t=>{var n;return(n=this.onFirstAudioReceived)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoReceived=t=>{var n;return(n=this.onFirstVideoReceived)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstAudioDecoded=t=>{var n;return(n=this.onFirstAudioDecoded)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onFirstVideoDecoded=(t,n,i)=>{var r;return(r=this.onFirstVideoDecoded)===null||r===void 0?void 0:r.call(this,t,n,i)},this._p2pConnection.onFirstVideoDecodedTimeout=t=>{var n;return(n=this.onFirstVideoDecodedTimeout)===null||n===void 0?void 0:n.call(this,t)},this._p2pConnection.onSelectedLocalCandidateChanged=(t,n)=>{var i;return(i=this.onSelectedLocalCandidateChanged)===null||i===void 0?void 0:i.call(this,t,n)},this._p2pConnection.onSelectedRemoteCandidateChanged=(t,n)=>{var i;return(i=this.onSelectedRemoteCandidateChanged)===null||i===void 0?void 0:i.call(this,t,n)}}closeSignal(){this.dataChannel.close(),this.peerConnection.close()}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0}setConfiguration(t){this._p2pConnection.setConfiguration(t)}},B(ye.prototype,"connect",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"connect"),ye.prototype),B(ye.prototype,"updateRemoteRTPCapabilities",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"updateRemoteRTPCapabilities"),ye.prototype),B(ye.prototype,"createDataChannels",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"createDataChannels"),ye.prototype),B(ye.prototype,"receive",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"receive"),ye.prototype),B(ye.prototype,"stopReceiving",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"stopReceiving"),ye.prototype),B(ye.prototype,"muteRemote",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"muteRemote"),ye.prototype),B(ye.prototype,"unmuteRemote",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"unmuteRemote"),ye.prototype),B(ye.prototype,"muteLocal",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"muteLocal"),ye.prototype),B(ye.prototype,"unmuteLocal",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"unmuteLocal"),ye.prototype),B(ye.prototype,"close",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"close"),ye.prototype),B(ye.prototype,"updateEncoderConfig",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"updateEncoderConfig"),ye.prototype),B(ye.prototype,"updateSendParameters",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"updateSendParameters"),ye.prototype),B(ye.prototype,"replaceTrack",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"replaceTrack"),ye.prototype),B(ye.prototype,"getRemoteSSRC",[qn],Object.getOwnPropertyDescriptor(ye.prototype,"getRemoteSSRC"),ye.prototype),ye);function qn(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From DataChannelConnection.".concat(t));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}var de;let Tl=(B((de=class extends qe{get state(){return this._state}set state(e){const t=this._state;this._state=e,this.emit(ee.StateChange,t,this._state)}constructor(e,t){super(),this.store=void 0,this.statsUploader=void 0,this.connection=void 0,this.localTrackMap=new Map,this.remoteUserMap=new Map,this.localDataChannels=[],this.remoteDataChannelMap=new Map,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.statsCollector=void 0,this.isPlanB=!1,this.shouldForwardP2PCreation=void 0,this.iceFailedCount=0,this.dtlsFailedCount=0,this.mutex=new Bt("P2PChannel-mutex"),this._state=we.Disconnected,this._pcStatsUploadType=A("NEW_ICE_RESTART")?br.FIRST_CONNECTION:br.OLD_FIRST_CONNECTION,this._isInRestartIce=!1,this._isStartRestartIce=!1,this._restartStates=["disconnected","failed"],this._restartTimer=void 0,this._isFirstConnected=!0,this.handleMuteLocalTrack=async(n,i,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==we.Connected)return void r(new L(C.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));const s=this.filterTobeMutedTracks(n);if(s.length===0)return void i();const a=s.find(d=>d[0]==="videoLowTrack");a&&a[1].track._originMediaStreamTrack.stop(),await this.connection.muteLocal(s.map(d=>{let[,{id:l}]=d;return l}));const c=this.createMuteMessage(s);await Ue(this,ee.RequestMuteLocal,c),i()}catch(s){r(s)}finally{o()}},this.handleUnmuteLocalTrack=async(n,i,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==we.Connected)return void r(new L(C.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));const s=this.filterTobeUnmutedTracks(n);if(s.length===0)return void i();const a=s.find(d=>d[0]==="videoLowTrack");if(a){const d=a[1];if(d.track._originMediaStreamTrack.stop(),!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&ge().supportDualStreamEncoding){const l=n._mediaStreamTrack.clone();d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}else{const l=Of(n,gs(this,ee.RequestLowStreamParameter));d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}await new Promise((l,u)=>{this.handleReplaceTrack(d.track,l,u,!0)})}await this.connection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));const c=this.createUnmuteMessage(s);await Ue(this,ee.RequestUnmuteLocal,c),i()}catch(s){r(s)}finally{o()}},this.handleUpdateVideoEncoder=async(n,i,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleSetVideoEncoder");try{const s=this.localTrackMap.get(M.LocalVideoTrack);if(!this.connection||!s||s.track!==n||this.state!==we.Connected)return void i();const{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),await this.connection.updateEncoderConfig(a,c),this.emit(ee.UpdateVideoEncoder,c),i()}catch(s){r(s)}finally{o()}},this.handleUpdateVideoSendParameters=async(n,i,r)=>{const o=await this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{const s=this.localTrackMap.get(M.LocalVideoTrack);if(!this.connection||!s||s.track!==n||this.state!==we.Connected)return void i();const{id:a,track:c}=s;await this.connection.updateSendParameters(a,c),i()}catch(s){r(s)}finally{o()}},this.handleReplaceMixingTrack=async(n,i,r,o)=>{if(!this.connection||this.state!==we.Connected)return void i();const s=Fp([n]);let a;f.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(s.getTrackId(),"]")),typeof o=="boolean"&&o||(a=await this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{await this.replaceTrack(n,s),i()}catch(d){r(d)}finally{var c;(c=a)===null||c===void 0||c()}},this.handleReplaceTrack=async(n,i,r,o)=>{let s;f.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(n.getTrackId(),"]")),typeof o=="boolean"&&o||(s=await this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;const d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return n===u});if(!this.connection||!d||this.state!==we.Connected)return void i();if(await((a=this.connection)===null||a===void 0?void 0:a.replaceTrack(n,d[1].id)),this.isPlanB){const l=d[1];l.id=n._mediaStreamTrack.id,this.localTrackMap.set(d[0],l)}if(d[0]===M.LocalVideoTrack&&!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&ge().supportDualStreamEncoding){const l=this.localTrackMap.get(M.LocalVideoLowTrack);if(l){const u=n._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,await new Promise((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}i()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}},this.handleGetRTCStats=n=>{n(this.statsCollector.getRTCStats())},this.handleGetLocalVideoStats=n=>{n(this.statsCollector.getLocalVideoTrackStats())},this.handleGetLocalAudioStats=n=>{n(this.statsCollector.getLocalAudioTrackStats())},this.handleGetRemoteVideoStats=n=>this.statsCollector.getRemoteVideoTrackStats(n.uid)[n.uid],this.handleGetRemoteAudioStats=n=>this.statsCollector.getRemoteAudioTrackStats(n.uid)[n.uid],this.store=e,this.statsCollector=t,this.statsCollector.addP2PChannel(this),this.statsUploader=new fw(this.store),this.bindStatsUploaderEvents(),this.isPlanB=!ge().supportUnifiedPlan||A("CHROME_FORCE_PLAN_B")&&ko(),this.shouldForwardP2PCreation=A("FORWARD_P2P_CREATION")&&ge().supportPCSetConfiguration&&DA(),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new eo({},this.store):this.isPlanB?new Bs({},this.store):new Wi({},this.store),this.bindConnectionEvents(this.connection))}async startP2PConnection(e,t){var n;this.state=we.New;const i=this.shouldForwardP2PCreation&&((n=this.connection)===null||n===void 0?void 0:n.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!i||(i&&this.connection&&(f.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.connection.close(),this.unbindConnectionEvents(this.connection)),this.connection=this.store.useDataChannel?new eo(e,this.store):this.isPlanB?new Bs(e,this.store):new Wi(e,this.store),this.bindConnectionEvents(this.connection)),!this.connection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=A("NEW_ICE_RESTART")?br.FIRST_CONNECTION:br.OLD_FIRST_CONNECTION,this._isFirstConnected=!0,this._isInRestartIce=!1,this._isStartRestartIce=!1,this.connection.setConfiguration(e),this.connection.establishPromise}async connect(e,t,n,i,r,o){if(!this.connection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.connection instanceof eo?this.connection.updateRemoteConnect(i):(this.store.peerConnectionStart(),await this.connection.connect(e,t,n,i,r,o),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=we.Connected)}updateRemoteRTPCapabilities(e){const t=Array.from(this.localTrackMap.entries()).filter(r=>{let[o]=r;return[M.LocalVideoLowTrack,M.LocalVideoTrack].includes(o)}),n=t.map(r=>{let[,{id:o}]=r;return o}),i=t.map(r=>{let[o]=r;return o});if(this.connection instanceof Wi){if(q.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(i),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(e)}),!e.includes(this.store.codec)){const r=["vp9","vp8","h264"].find(o=>e.includes(o));r&&(this.store.codec=r,f.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(n,e)}}async preConnect(e,t,n,i,r,o){if(!this.connection)throw new L(C.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");this.store.peerConnectionStart();const s=await this.connection.connect(e,t,n,i,r,o);return this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=we.Connected,s}getEstablishParams(){if(this.connection instanceof eo)return this.connection.getP2PConnectionParams();throw new Error("Only DataChannelConnection needs to obtain establishParams")}async publishDataChannel(e){if(!this.connection||this.state!==we.Connected){if(this.state===we.Disconnected)throw new L(C.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return void e.forEach(n=>{this.pendingLocalDataChannels.includes(n)||this.pendingLocalDataChannels.push(n)})}const t=this.filterTobePublishedDataChannels(e);t.length!==0&&(t.forEach(n=>{const i=Date.now();this.store.publish(n.id.toString(),"datachannel",i)}),await this.connection.createDataChannels(this.store.uid,t),t.forEach(n=>{this.localDataChannels.push(n);const i=Date.now();this.store.publish(n.id+"","datachannel",void 0,i)}))}publish(e,t,n){var i=this;return Wn(function*(){const r=yield ae(i.mutex.lock("From P2PChannel.publish"));try{if(!i.connection||i.state!==we.Connected){if(i.state===we.Disconnected)throw new L(C.UNEXPECTED_ERROR,"PeerConnection already disconnected.");i.throwIfTrackTypeNotMatch(e);const s=e.filter(a=>i.pendingLocalTracks.indexOf(a)===-1);return void(i.pendingLocalTracks=i.pendingLocalTracks.concat(s))}i.store.pubId=i.store.pubId+1,nn.markPublishStart(i.store.clientId,i.store.pubId);const o=i.filterTobePublishedTracks(e,t,n);if(o.length===0)return void(yield ae(i.tryToUnmuteAudio(e)));yield*Lu(ku(i.doPublish(i.connection,o)))}finally{r()}})()}doPublish(e,t){var n=this;return Wn(function*(){t.forEach(u=>{let{track:h,type:p}=u;const m=Date.now();n.store.publish(h.getTrackId(),p===M.LocalAudioTrack?"audio":"video",m)}),n.bindLocalTrackEvents(t);const i=t.map(u=>{let{track:h}=u;return h}),r=yield ae(e.send(t.map(u=>{let{track:h}=u;return h}),n.store.codec,n.store.audioCodec)),o=(yield ae(r.next())).value,s=n.createGatewayPublishMessage(t,o);let a;try{a=yield s}catch(u){throw r.throw(u),(u==null?void 0:u.code)===C.WS_ABORT&&t.forEach(h=>{let{track:p}=h;n.pendingLocalTracks.indexOf(p)===-1&&n.pendingLocalTracks.push(p)}),n.unbindLocalTrackEvents(t),u}const c=n.mapPubResToRemoteConfig(s,a),d=(yield ae(r.next(c))).value,l=A("ENABLE_VIDEO_SEI");i.forEach(async u=>{const h=u.getRTCRtpTransceiver();h&&l&&(u.trackMediaType===z.VIDEO?await iM(h.sender,u):u.trackMediaType===z.AUDIO&&await Z1(h.sender))}),t.forEach(u=>{let{type:h}=u;n.statsCollector.addLocalStats(h)}),n.assignLocalTracks(t,d),n.statsUploader.startUploadOutboundStats(),t.forEach(u=>{let{track:h,type:p}=u;const m=Date.now();n.store.publish(h.getTrackId(),p===M.LocalAudioTrack?"audio":"video",void 0,m)})})()}async updateVideoStreamParameter(e,t){const n=this.localTrackMap.get(t);if(!n)return;if(!(n.track instanceof Ge))return f.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");if(!(this.connection instanceof Wi||this.connection instanceof Bs))return f.warn("[updateVideoStreamParameter]: connection is not P2PConnection or P2PConnectionPlanB");const{track:i}=n,r=function(o,s){const a={};return o.height&&o.width&&(a.scaleResolutionDownBy=wf(o,s)),a.maxFramerate=o.framerate?kn(o.framerate):void 0,a.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,a}(e,i);if(i._encoderConfig||(i._encoderConfig={}),t!==M.LocalVideoLowTrack||!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&ge().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(i._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{const o=i._originMediaStreamTrack;if(!o.canvas)return f.warn("[".concat(i.getTrackId(),"] no canvas on track"));(function(s,a){const c=s.canvas;a.width&&(c.width=kn(a.width)),a.height&&(c.height=kn(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=b0(()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()},kn(a.framerate)))})(o,e)}r.maxBitrate!=null&&(i._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(i._encoderConfig.frameRate&&typeof i._encoderConfig.frameRate=="object"?i._encoderConfig.frameRate.max=r.maxFramerate:i._encoderConfig.frameRate={max:r.maxFramerate}),f.debug("[".concat(i.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(i._encoderConfig))),await this.connection.updateRtpSenderEncodings(i)}publishLowStream(e){var t=this;return Wn(function*(){if(!t.connection||t.state!==we.Connected)return;const n=yield ae(t.mutex.lock("Locking from P2PChannel.publishLowStream"));try{const r=t.localTrackMap.get(M.LocalVideoTrack);if(!r)throw new L(C.UNEXPECTED_ERROR,"Could not find high stream");if(t.localTrackMap.has(M.LocalVideoLowTrack))throw new L(C.UNEXPECTED_ERROR,"[".concat(t.store.clientId,"] Can't publish low stream when stream already publish"));const o=[{track:t.getLowVideoTrack(r.track,e),type:M.LocalVideoLowTrack}];if(yield*Lu(ku(t.doPublish(t.connection,o))),r.track.muted||!r.track.enabled){var i;const s=(i=t.localTrackMap.get(M.LocalVideoLowTrack))===null||i===void 0?void 0:i.id;s!==void 0&&(yield ae(t.connection.muteLocal([s])))}}finally{n()}})()}async republish(){this.pendingLocalTracks.length>0&&(f.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),await Tt(this,ee.RequestRePublish,this.pendingLocalTracks),this.emit(ee.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(f.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),await Tt(this,ee.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[])}async reSubscribe(e){for(let t=this.pendingRemoteTracks.length-1;t>=0;t--){const{user:n,kind:i}=this.pendingRemoteTracks[t];(i!==z.AUDIO||n._audio_added_&&n._audioSSRC)&&(i!==z.VIDEO||n._video_added_&&n._videoSSRC)||this.pendingRemoteTracks.splice(t,1)}if(e)await Tt(this,ee.RequestReSubscribe,this.pendingRemoteTracks);else for(const{user:t,kind:n}of this.pendingRemoteTracks)await this.subscribe(t,n,n===z.VIDEO?t._videoSSRC:t._audioSSRC);this.pendingRemoteTracks.forEach(t=>{let{user:n}=t;this.emit(ee.MediaReconnectEnd,n.uid)}),this.pendingRemoteTracks=[]}async unpublish(e){if(!this.connection||this.state!==we.Connected)return void e.forEach(i=>{const r=this.pendingLocalTracks.indexOf(i);r!==-1&&this.pendingLocalTracks.splice(r,1)});const t=this.filterTobeUnpublishedTracks(e);if(t.length===0)return;const n=t.find(i=>i[0]==="videoLowTrack");return n&&n[1].track.close(),this.doUnpublish(this.connection,t)}async unpublishDataChannel(e){if(!this.connection||this.state!==we.Connected)return void e.forEach(n=>{const i=this.pendingLocalDataChannels.indexOf(n);i!==-1&&this.pendingLocalDataChannels.splice(i,1)});const t=this.filterTobeUnpublishedDataChannels(e);return t.length!==0?(t.forEach(n=>{const i=this.localDataChannels.indexOf(n);i!==-1&&this.localDataChannels.splice(i,1)}),this.localDataChannels.length===0&&await this.connection.stopDataChannels(this.store.uid),t.map(n=>n.id)):void 0}async unpublishLowStream(){if(!this.connection||this.state!==we.Connected)return;const e=this.localTrackMap.get(M.LocalVideoLowTrack);if(!e)return;e.track.close();const t=[[M.LocalVideoLowTrack,e]];return this.doUnpublish(this.connection,t)}async doUnpublish(e,t){const n=this.createGatewayUnpublishMessage(t);return await e.stopSending(t.map(i=>{let[,{id:r}]=i;return r})),this.withdrawLocalTracks(t),this.unbindLocalTrackEvents(t.map(i=>{let[r,{track:o}]=i;return{type:r,track:o}})),t.forEach(i=>{let[r]=i;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),n}async subscribeDataChannel(e,t){if(!this.connection||this.state!==we.Connected)throw new L(C.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");const n=t.filter(i=>{var r;return!((r=this.remoteDataChannelMap.get(e))!==null&&r!==void 0&&r.get(i.id))});if(n.length!==0)return await this.connection.createDataChannels(e.uid,n),n.forEach(i=>{var r;this.remoteDataChannelMap.has(e)?(r=this.remoteDataChannelMap.get(e))===null||r===void 0||r.set(i.id,i):this.remoteDataChannelMap.set(e,new Map([[i.id,i]]));const o=this.pendingRemoteDataChannels.findIndex(s=>{let{user:a,id:c}=s;return a.uid===e.uid&&c===i.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),n.map(i=>i.id)}async subscribe(e,t,n,i,r){var o;if(!this.connection||this.state!==we.Connected)throw new L(C.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(e))!==null&&o!==void 0&&o.has(t))return;let s,a,c;if(r){const u=r.find(p=>{let{stream_type:m}=p;return m===t});if(!u)throw new L(C.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(t," for user: ").concat(e.uid," because subscribe answer from gateway does not contain stream_type: ").concat(t,"."));const h=await this.connection.receive(t,u.ssrcs,String(e._uintid),u.attributes);this.connection instanceof Wi&&(c=h.transceiver),s=h.track,a=h.id}else{const u=await this.connection.receive(t,[{ssrcId:n,rtx:i}],String(e._uintid),void 0);this.connection instanceof Wi&&(c=u.transceiver),s=u.track,a=u.id}t===z.AUDIO?(e._audioTrack?e._audioTrack._updateOriginMediaStreamTrack(s):(e._audioTrack=new Fc(s,e.uid,e._uintid,this.store),f.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(e._audioTrack.getTrackId()))),c&&e._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._audioTrack)):(e._videoTrack?e._videoTrack._updateOriginMediaStreamTrack(s):(e._videoTrack=new Vc(s,e.uid,e._uintid,this.store),f.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(e._videoTrack.getTrackId()))),c&&e._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(e,e._videoTrack)),A("ENABLE_VIDEO_SEI")&&c&&(t==z.VIDEO?await rM(c.receiver,{onSei:u=>{var h;(h=e._videoTrack)===null||h===void 0||h._onSei(u)}}):t==z.AUDIO&&await eM(c.receiver));const d=this.remoteUserMap.get(e);d?d.set(t,a):this.remoteUserMap.set(e,new Map([[t,a]])),this.statsCollector.addRemoteStats(e.uid),this.statsUploader.startUploadInboundStats();const l=this.pendingRemoteTracks.findIndex(u=>{let{user:h,kind:p}=u;return h.uid===e.uid&&t===p});l!==-1&&(this.pendingRemoteTracks.splice(l,1),this.emit(ee.MediaReconnectEnd,e.uid))}async massSubscribe(e){return this.massSubscribeNoLock(e)}async massSubscribeNoLock(e){if(!this.connection||this.state!==we.Connected)throw new L(C.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");e=e.filter(n=>{var i;let{user:r,mediaType:o}=n;return!((i=this.remoteUserMap.get(r))!==null&&i!==void 0&&i.has(o))});const t=await this.connection.batchReceive(e.map(n=>{let{user:i,mediaType:r,ssrcId:o,rtxSsrcId:s}=n;return{kind:r,ssrcMsg:[{ssrcId:o,rtx:s}],mslabel:String(i._uintid)}}));e.forEach((n,i)=>{let{user:r,mediaType:o}=n;const{track:s,id:a,transceiver:c}=t[i];o===z.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(s):(r._audioTrack=new Fc(s,r.uid,r._uintid,this.store),f.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),c&&r._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(s):(r._videoTrack=new Vc(s,r.uid,r._uintid,this.store),f.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),c&&r._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(r,r._videoTrack));const d=this.remoteUserMap.get(r);d?d.set(o,a):this.remoteUserMap.set(r,new Map([[o,a]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();const l=this.pendingRemoteTracks.findIndex(u=>{let{user:h,kind:p}=u;return h.uid===r.uid&&o===p});l!==-1&&(this.pendingRemoteTracks.splice(l,1),this.emit(ee.MediaReconnectEnd,r.uid))})}async unsubscribe(e,t,n){const i=this.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return t!==void 0?a.uid===e.uid&&t===c:a.uid===e.uid});if(i.forEach(s=>{const a=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(a,1)}),this.connection&&this.state===we.Connected||n||i.forEach(s=>{let{kind:a}=s;var c;if(a===z.AUDIO)(c=e._audioTrack)===null||c===void 0||c._destroy(),e._audioTrack=void 0;else if(a===z.VIDEO){var d;(d=e._videoTrack)===null||d===void 0||d._destroy(),e._videoTrack=void 0}}),!this.connection||this.state!==we.Connected)return;const r=this.filterTobeUnSubscribedTracks(e,t);if(r.length===0)return;await this.connection.stopReceiving(r.map(s=>{let[,{id:a}]=s;return a}));const o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(s=>{let[a,{kind:c}]=s;var d,l;if(c===z.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===z.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),n||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===z.AUDIO){var u;this.unbindRemoteTrackEvents(a._audioTrack),!n&&((u=a._audioTrack)===null||u===void 0||u._destroy(),a._audioTrack=void 0)}}),o}async unsubscribeDataChannel(e,t){if(t.forEach(r=>{const o=this.pendingRemoteDataChannels.findIndex(s=>s.id===r.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;const n=this.filterTobeUnSubscribedDataChannels(e,t);if(n.length===0)return;t.forEach(r=>{r._close()});const i=this.remoteDataChannelMap.get(e);return n.forEach(r=>{i&&i.delete(r.id)}),i&&i.size===0&&(this.remoteDataChannelMap.delete(e),await this.connection.stopDataChannels(e.uid)),n.map(r=>r.id)}async massUnsubscribe(e){return this.massUnsubscribeNoLock(e)}async massUnsubscribeNoLock(e){let t=[];for(const{user:r,mediaType:o}of e){const s=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return o!==void 0?c.uid===r.uid&&o===d:c.uid===r.uid});s.forEach(a=>{const c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),t=t.concat(s)}if(!this.connection||this.state!==we.Connected)return void t.forEach(r=>{let{user:o,kind:s}=r;var a;if(s===z.AUDIO)(a=o._audioTrack)===null||a===void 0||a._destroy(),o._audioTrack=void 0;else if(s===z.VIDEO){var c;(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0}});const n=e.reduce((r,o)=>{let{user:s,mediaType:a}=o;const c=this.filterTobeUnSubscribedTracks(s,a);return r.concat(c)},[]);if(n.length===0)return;await this.connection.stopReceiving(n.map(r=>{let[,{id:o}]=r;return o}));const i=this.createUnsubscribeAllMessage(n);return this.withdrawRemoteTracks(n),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),n.forEach(r=>{let[o,{kind:s}]=r;var a,c;if(s===z.VIDEO&&o._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),s===z.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0;else if(s===z.AUDIO){var d;this.unbindRemoteTrackEvents(o._audioTrack),(d=o._audioTrack)===null||d===void 0||d._destroy(),o._audioTrack=void 0}}),i}async muteRemote(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void f.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid,"."));if(!n.get(t))return void f.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."));const i=t===z.VIDEO?e._videoSSRC:e._audioSSRC;i!==void 0&&this.connection.setStatsRemoteVideoIsReady(i,!1)}async unmuteRemote(e,t){return this.unmuteRemoteNoLock(e,t)}async unmuteRemoteNoLock(e,t){if(!this.connection)return;const n=this.remoteUserMap.get(e);if(!n)return void f.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid,"."));n.get(t)||f.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(e.uid," media type ").concat(t,"."))}getAllTracks(e){const t=this.localTrackMap.get(M.LocalAudioTrack);if((t==null?void 0:t.track)instanceof Ot){const n=t.track;return Array.from(this.localTrackMap.entries()).filter(i=>{let[r]=i;return r!==M.LocalAudioTrack}).filter(i=>{let[r]=i;return!(e&&r===M.LocalVideoLowTrack)}).map(i=>{let[,{track:r}]=i;return r}).concat(n.trackList)}return Array.from(this.localTrackMap.entries()).filter(n=>{let[i]=n;return!(e&&i===M.LocalVideoLowTrack)}).map(n=>{let[,{track:i}]=n;return i})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(e,t,n,i,r){if(e){const s=this.localTrackMap.get(M.LocalAudioTrack),a=i?this.localTrackMap.get(M.LocalVideoLowTrack):this.localTrackMap.get(M.LocalVideoTrack);q.publish(this.store.sessionId,{eventElapse:nn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:s==null?void 0:s.track.getTrackLabel(),videoName:a==null?void 0:a.track.getTrackLabel(),screenshare:(a==null?void 0:a.track._hints.indexOf(je.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;n||(n=[]);const s=n.find(c=>c instanceof St),a=i?(o=this.localTrackMap.get(M.LocalVideoTrack))===null||o===void 0?void 0:o.track:n.find(c=>c instanceof Ge);q.publish(this.store.sessionId,{eventElapse:nn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:e,ec:t,audioName:s==null?void 0:s.getTrackLabel(),videoName:a==null?void 0:a.getTrackLabel(),screenshare:(a==null?void 0:a._hints.indexOf(je.SCREEN_TRACK))!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(e,t,n,i){const r=i===z.VIDEO?n._videoSSRC:n._audioSSRC;r&&q.subscribe(this.store.sessionId,{succ:e,ec:t,video:i===z.VIDEO,audio:i===z.AUDIO,peerid:n.uid,subscribeRequestid:i===z.VIDEO?n._videoSSRC:n._audioSSRC,p2pid:this.store.p2pId,eventElapse:nn.measureFromSubscribeStart(this.store.clientId,r)})}reset(){f.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new Bt("P2PChannel-mutex"),this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new eo({},this.store):this.isPlanB?new Bs({},this.store):new Wi({},this.store),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();const e=this.localTrackMap.get(M.LocalAudioTrack);if((e==null?void 0:e.track)instanceof Ot){if(e.track.trackList.length>0){const t=e.track;e.track.trackList.forEach(n=>{t.removeAudioTrack(n)})}e.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=we.Disconnected}getStats(){var e;return(e=this.connection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(e){var t;return((t=this.connection)===null||t===void 0?void 0:t.getRemoteVideoIsReady(e))||!1}getLocalAudioVolume(){const e=this.localTrackMap.get(M.LocalAudioTrack);if(e)return e.track.getVolumeLevel()}getLocalVideoSize(){const e=this.localTrackMap.get(M.LocalVideoTrack);if(e)return{width:e.track.videoWidth||0,height:e.track.videoHeight||0}}getEncoderConfig(e){const t=this.localTrackMap.get(e);return t&&t.track instanceof Ge||t&&t.track instanceof St?t.track._encoderConfig:void 0}getLocalMedia(e){return this.localTrackMap.get(e)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}async hasRemoteMediaWithLock(e,t){if(!e)return this.remoteUserMap.size>0;const n=this.remoteUserMap.get(e);return!!n&&(!t||n.has(t))}getRemoteMedia(e){const t=Array.from(this.remoteUserMap.keys()).find(n=>n.uid===e);return t?{audioTrack:t.audioTrack,audioSSRC:t._audioSSRC,videoTrack:t.videoTrack,videoSSRC:t._videoSSRC}:{}}getAudioLevels(){let e=Array.from(this.remoteUserMap.entries()).map(n=>{let[i]=n;return{uid:i.uid,level:i.audioTrack?100*i.audioTrack._source.getAccurateVolumeLevel():0}});const t=this.localTrackMap.get(M.LocalAudioTrack);return t&&e.push({level:100*t.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),e=e.sort((n,i)=>n.level-i.level),e}async disconnectForReconnect(){this.connection&&(f.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=we.Reconnecting,A("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t]=e;var n;t._videoTrack&&t._videoTrack._player&&((n=t._videoTrack._player.getVideoElement())===null||n===void 0||n.pause(),t._videoTrack._player.isKeepLastFrame=!0,t._videoTrack._originMediaStreamTrack.stop())}),this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=this.store.useDataChannel?new eo({},this.store):this.isPlanB?new Bs({},this.store):new Wi({},this.store),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:n}]=e;switch(t){case M.LocalVideoTrack:n._hints.includes(je.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case M.LocalAudioTrack:n instanceof Ot?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case M.LocalVideoLowTrack:}}),this.emit(ee.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,n]=e;Array.from(n.keys()).forEach(i=>{this.setPendingRemoteMedia(t,i)}),this.emit(ee.MediaReconnectStart,t.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(e=>{this.pendingLocalDataChannels.push(e)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(e=>{let[t,n]=e;Array.from(n.keys()).forEach(i=>{this.setPendingRemoteDataChannel(t,i)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),f.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))}hasPendingRemoteDataChannel(e,t){for(const n of this.pendingRemoteDataChannels){const{user:i,id:r}=n;if((e instanceof ho?e.uid:e)===i.uid&&r===t)return!0}return!1}setPendingRemoteDataChannel(e,t){this.hasPendingRemoteDataChannel(e,t)||this.pendingRemoteDataChannels.push({user:e,id:t})}hasPendingRemoteMedia(e,t){for(const n of this.pendingRemoteTracks){const{user:i,kind:r}=n;if((e instanceof ho?e.uid:e)===i.uid&&t===r)return!0}return!1}setPendingRemoteMedia(e,t){this.hasPendingRemoteMedia(e,t)||this.pendingRemoteTracks.push({user:e,kind:t})}restartICE(e){var t=this;return Wn(function*(){if(!t.connection||t.state!==we.Connected||t.connection instanceof eo)return;const n=yield ae(t.mutex.lock("From P2PChannel.restartICE"));let i;try{i=yield ae(t.connection.restartICE(e));const o=yield ae(i.next());if(o.done)return;const s=o.value,a=yield s;switch(t.reportPCDisconnectedOrFailed(e),e){case _n.TCP:t._pcStatsUploadType=br.TCP_RESTART;break;case _n.RELAY:t._pcStatsUploadType=br.RELAY_RESTART;break;default:t._pcStatsUploadType=br.OLD_RESTART}t._isInRestartIce=!0,i.next(a)}catch(o){var r;(r=i)===null||r===void 0||r.throw(o)}finally{n()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats(),t=this.localTrackMap.get(M.LocalVideoTrack),n=this.localTrackMap.get(M.LocalAudioTrack),i=e.videoSend.find(p=>p.ssrc===(t==null?void 0:t.ssrcs[0].ssrcId)),r=e.audioSend.find(p=>p.ssrc===(n==null?void 0:n.ssrcs[0].ssrcId));if(!i||!r)return 1;const o=Gn(this,ee.NeedSignalRTT),s=i?i.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*e.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=t==null?void 0:t.track;if(h&&h._encoderConfig&&h._hints.indexOf(je.SCREEN_TRACK)===-1){const p=h._encoderConfig.bitrateMax,m=e.bitrate.actualEncoded;if(p&&m){const E=(1e3*p-m)/(1e3*p);return Z0[E<.15?0:E<.3?1:E<.45?2:E<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.connection)return 0;const e=this.connection.getStats();let t=0;return Array.from(this.remoteUserMap.entries()).forEach(n=>{let[i]=n;const r=i._audioSSRC,o=i._videoSSRC,s=e.audioRecv.find(m=>m.ssrc===r),a=e.videoRecv.find(m=>m.ssrc===o);if(!s&&!a)return void(t+=1);const c=Gn(this,ee.NeedSignalRTT),d=e.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=e.recvPacketLossRate;let p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),t+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5}),this.remoteUserMap.size>0?Math.round(t/this.remoteUserMap.size):t}async muteLocalTrack(e){return new Promise((t,n)=>{this.handleMuteLocalTrack(e,t,n)})}async replaceTrack(e,t){var n;if(f.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(e.getTrackId(),"] to [").concat(t.getTrackId(),"]")),!this.connection||this.state!==we.Connected)return;const i=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return e===s});if(!i)return;const r=i[0];if(e!==t&&(this.unbindLocalTrackEvents([{track:e,type:r}]),this.bindLocalTrackEvents([{track:t,type:r}]),i[1].track=t),await((n=this.connection)===null||n===void 0?void 0:n.replaceTrack(t,i[1].id)),this.isPlanB){const o=i[1];o.id=t._mediaStreamTrack.id,this.localTrackMap.set(r,o)}if(r===M.LocalVideoTrack&&!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&ge().supportDualStreamEncoding){const o=this.localTrackMap.get(M.LocalVideoLowTrack);if(o){const s=e._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=s,o.track._originMediaStreamTrack=s,await new Promise((a,c)=>{this.handleReplaceTrack(o.track,a,c,!0)})}}}filterTobePublishedTracks(e,t,n){const i=[],r=this.getAllTracks();e=e.filter(c=>r.indexOf(c)===-1),e=na(e);let o,s=!1;const a=this.localTrackMap.get(M.LocalAudioTrack);for(const c of e){if(c instanceof Ge&&(this.localTrackMap.has(M.LocalVideoTrack)||s?new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(i.push({track:c,type:M.LocalVideoTrack}),s=!0),t)){const d=this.getLowVideoTrack(c,n);i.push({track:d,type:M.LocalVideoLowTrack})}if(c instanceof St)if(a){const d=a.track;if(d instanceof Ot)bf([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{const l=Fp([d,c]);f.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(l.getTrackId(),"]")),this.replaceTrack(d,l)}}else o instanceof Ot?(bf([c]),o.addAudioTrack(c)):o||!c._useAudioElement&&ge().webAudioMediaStreamDest&&!c._bypassWebAudio?o=Fp(o?[c,o]:[c]):o=c}return o&&(f.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),i.push({track:o,type:M.LocalAudioTrack})),i}filterTobeUnpublishedTracks(e){const t=[],n=this.getAllTracks();e=e.filter(i=>n.indexOf(i)!==-1),e=na(e);for(const i of e){if(i instanceof St){const r=this.localTrackMap.get(M.LocalAudioTrack);if(!r)continue;r.track instanceof Ot?(r.track.removeAudioTrack(i),this.unbindLocalAudioTrackEvents(i),r.track.trackList.length===0&&(t.push([M.LocalAudioTrack,r]),r.track.close())):t.push([M.LocalAudioTrack,r])}if(i instanceof Ge){const r=this.localTrackMap.get(M.LocalVideoTrack);if(!r)continue;t.push([M.LocalVideoTrack,r]);const o=this.localTrackMap.get(M.LocalVideoLowTrack);o&&t.push([M.LocalVideoLowTrack,o])}}return t}filterTobePublishedDataChannels(e){return e=(e=na(e)).filter(t=>this.localDataChannels.findIndex(n=>n.id===t.id)===-1)}filterTobeUnpublishedDataChannels(e){return e=(e=(e=na(e)).filter(t=>this.localDataChannels.indexOf(t)!==-1)).filter(t=>t._originDataChannel)}bindLocalTrackEvents(e){e.forEach(t=>{let{track:n,type:i}=t;switch(i){case M.LocalVideoTrack:n.addListener(W.GET_STATS,this.handleGetLocalVideoStats),n.addListener(W.GET_RTC_STATS,this.handleGetRTCStats),n.addListener(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(W.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.addListener(W.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.addListener(W.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.addListener(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case M.LocalAudioTrack:this.bindLocalAudioTrackEvents(n);case M.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(e,t){e instanceof Ot?e.trackList.forEach(n=>{n.addListener(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.addListener(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.addListener(W.GET_STATS,this.handleGetLocalAudioStats),n.addListener(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.addListener(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.addListener(W.GET_STATS,this.handleGetLocalAudioStats),e.addListener(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.addListener(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.addListener(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.addListener(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),t||(e.addListener(W.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.addListener(W.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(e){e||(e=Array.from(this.localTrackMap.entries()).map(t=>{let[n,{track:i}]=t;return{track:i,type:n}})),e.forEach(t=>{let{track:n,type:i}=t;switch(i){case M.LocalVideoTrack:n.off(W.GET_STATS,this.handleGetLocalVideoStats),n.off(W.GET_RTC_STATS,this.handleGetRTCStats),n.off(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),n.off(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),n.off(W.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),n.off(W.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),n.off(W.NEED_REPLACE_TRACK,this.handleReplaceTrack),n.off(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),n.off(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case M.LocalAudioTrack:this.unbindLocalAudioTrackEvents(n);case M.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(e){e instanceof Ot?e.trackList.forEach(t=>{t.off(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(W.GET_STATS,this.handleGetLocalAudioStats),t.off(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(e.off(W.GET_STATS,this.handleGetLocalAudioStats),e.off(W.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(W.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(W.NEED_REPLACE_TRACK,this.handleReplaceTrack),e.off(W.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),e.off(W.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(W.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(e,t){t instanceof Vc&&t.addListener(W.GET_STATS,n=>{n(this.handleGetRemoteVideoStats(e))}),t instanceof Fc&&t.addListener(W.GET_STATS,n=>{n(this.handleGetRemoteAudioStats(e))})}unbindRemoteTrackEvents(e){e&&e.removeAllListeners(W.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(e=>{let[t,n]=e;n.has(z.AUDIO)&&this.unbindRemoteTrackEvents(t._audioTrack),n.has(z.VIDEO)&&this.unbindRemoteTrackEvents(t._videoTrack)})}createGatewayPublishMessage(e,t){return e.map((n,i)=>{let r,o,{track:s,type:a}=n;switch(a){case M.LocalAudioTrack:r=ve.Audio,o={dtx:s instanceof $E&&s._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case M.LocalVideoTrack:r=s._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High,o=F(F({},wR(s)),{},{codec:this.store.codec});break;case M.LocalVideoLowTrack:r=ve.Low,o=F(F({},wR(s)),{},{codec:this.store.codec})}return{stream_type:r,attributes:o,ssrcs:t[i]}})}createGatewayUnpublishMessage(e){return e.map(t=>{let n,[i,{track:r,ssrcs:o,id:s}]=t;switch(i){case M.LocalVideoTrack:n=r._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High;break;case M.LocalAudioTrack:n=ve.Audio;break;case M.LocalVideoLowTrack:n=ve.Low}return{stream_type:n,ssrcs:o,mid:s}})}assignLocalTracks(e,t){e.forEach((n,i)=>{let{track:r,type:o}=n;this.localTrackMap.set(o,{track:r,id:t[i].id,ssrcs:t[i].localSSRC})})}withdrawLocalTracks(e){e.forEach(t=>{let[n]=t;this.localTrackMap.delete(n)})}bindConnectionEvents(e){e.onConnectionStateChange=async t=>{if(f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(t,")")),this.emit(ee.PeerConnectionStateChange,t),t!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),t==="connected"&&(this._restartTimer&&(clearTimeout(this._restartTimer),this._restartTimer=void 0),(this._isFirstConnected||this._isInRestartIce)&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isInRestartIce=!1,this._isFirstConnected=!1,this._isStartRestartIce=!1),A("NEW_ICE_RESTART")){if(this._restartStates.includes(t)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;const n=o=>{(e.iceConnectionState==="disconnected"||e.iceConnectionState==="checking"||e.iceConnectionState==="failed")&&(f.debug("[".concat(this.store.clientId,"] [P2PChannel] start use restartICE, type is ").concat(o)),Gn(this,ee.QueryClientConnectionState)==="CONNECTED"&&this.emit(ee.RequestRestartICE,o))},i=()=>{e.iceConnectionState!=="disconnected"&&e.iceConnectionState!=="checking"&&e.iceConnectionState!=="failed"||(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),f.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(ee.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},r=A("ICE_RESTART_INTERVAL");return void(this._restartTimer=window.setTimeout(()=>{if(A("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&ge().supportPCSetConfiguration)n(_n.RELAY),this._restartTimer=window.setTimeout(i,r);else if(Me())n(_n.UDP),this._restartTimer=window.setTimeout(i,4e3);else{if(n(_n.TCP),ge().supportPCSetConfiguration)return void(this._restartTimer=window.setTimeout(()=>{n(_n.RELAY),this._restartTimer=window.setTimeout(i,r)},r));this._restartTimer=window.setTimeout(i,r)}},800))}}else{if(t==="disconnected"&&e.iceConnectionState==="disconnected")return setTimeout(()=>{e.iceConnectionState==="disconnected"&&A("ICE_RESTART")&&Gn(this,ee.QueryClientConnectionState)==="CONNECTED"&&this.emit(ee.RequestRestartICE)},800),void setTimeout(()=>{e.peerConnectionState==="disconnected"&&(f.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isInRestartIce=!1,setTimeout(()=>this.emit(ee.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);t==="failed"&&(f.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCDisconnectedOrFailed(),setTimeout(()=>this.emit(ee.P2PLost),0),this.iceFailedCount+=1,await this.requestReconnect())}},e.onICEConnectionStateChange=t=>{t!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(t,")")),q.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:t,tag:bt.TRACER}).onSuccess(),this.emit(ee.IceConnectionStateChange,t)},e.onICETransportStateChange=t=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(t,")"))},e.onDTLSTransportStateChange=t=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(t,")"))},e.onDTLSTransportError=t=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(t,")"))},e.onFirstAudioDecoded=t=>{const n=Array.from(this.remoteUserMap.keys()).find(r=>r._audioSSRC===t);var i;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(i=n.audioTrack)===null||i===void 0||i.emit(_a.FIRST_FRAME_DECODED),q.firstRemoteFrame(this.store.sessionId,xt.FIRST_AUDIO_DECODE,Qe.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:nn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId}))},e.onFirstAudioReceived=t=>{const n=Array.from(this.remoteUserMap.keys()).find(i=>i._audioSSRC===t);n&&q.firstRemoteFrame(this.store.sessionId,xt.FIRST_AUDIO_RECEIVED,Qe.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:nn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onFirstVideoDecoded=(t,n,i)=>{this.reportVideoFirstFrameDecoded(t,n,i)},e.onFirstVideoReceived=t=>{const n=Array.from(this.remoteUserMap.keys()).find(i=>i._videoSSRC===t);n&&q.firstRemoteFrame(this.store.sessionId,xt.FIRST_VIDEO_RECEIVED,Qe.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:nn.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId})},e.onSelectedLocalCandidateChanged=(t,n)=>{const i=t.candidateType==="relay",r=n.candidateType==="relay";n.candidateType!=="unknown"&&i===r||this.emit(ee.ConnectionTypeChange,i),f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(So(n))," -> ").concat(JSON.stringify(So(t)),")"))},e.onSelectedRemoteCandidateChanged=(t,n)=>{f.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(So(n))," -> ").concat(JSON.stringify(So(t)),")"))},e.onFirstVideoDecodedTimeout=t=>{this.reportVideoFirstFrameDecoded(t,void 0,void 0,!0)},e.getLocalVideoStats=()=>{const t=this.statsCollector.getLocalVideoTrackStats(),n=this.statsCollector.getRTCStats();return F(F({},t),n)}}unbindConnectionEvents(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}filterTobeMutedTracks(e){const t=[];if(this.getAllTracks().indexOf(e)===-1)return t;const n=this.localTrackMap.get(M.LocalAudioTrack);if(e instanceof St&&(n==null?void 0:n.track)instanceof Ot)return n.track.isActive||t.push([M.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return e===o});if(i&&(t.push(i),i[0]===M.LocalVideoTrack)){const r=this.localTrackMap.get(M.LocalVideoLowTrack);r&&t.push([M.LocalVideoLowTrack,r])}return t}filterTobeUnmutedTracks(e){const t=[],n=this.localTrackMap.get(M.LocalAudioTrack);if(e instanceof St&&(n==null?void 0:n.track)instanceof Ot)return n.track.isActive&&t.push([M.LocalAudioTrack,n]),t;const i=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return e===o});if(i)if(i[0]===M.LocalVideoTrack){t.push(i);const r=this.localTrackMap.get(M.LocalVideoLowTrack);r&&t.push([M.LocalVideoLowTrack,r])}else t.push(i);return t}createMuteMessage(e){return e.map(t=>{let n,[i,{track:r,ssrcs:o,id:s}]=t;switch(i){case M.LocalAudioTrack:n=ve.Audio;break;case M.LocalVideoTrack:n=r._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High;break;case M.LocalVideoLowTrack:n=ve.Low}return{stream_type:n,ssrcs:o,mid:s}})}createUnmuteMessage(e){return e.map(t=>{let n,[i,{track:r,ssrcs:o,id:s}]=t;switch(i){case M.LocalAudioTrack:n=ve.Audio;break;case M.LocalVideoTrack:n=r._hints.includes(je.SCREEN_TRACK)?ve.Screen:ve.High;break;case M.LocalVideoLowTrack:n=ve.Low}return{stream_type:n,ssrcs:o,mid:s}})}filterTobeUnSubscribedTracks(e,t){const n=[],i=this.remoteUserMap.get(e);if(!i)return n;if(t){const r=i.get(t);if(!r)return n;n.push([e,{kind:t,id:r}])}else Array.from(i.entries()).forEach(r=>{let[o,s]=r;n.push([e,{kind:o,id:s}])});return n}filterTobeUnSubscribedDataChannels(e,t){const n=[];return t.forEach(i=>{var r;(r=this.remoteDataChannelMap.get(e))!==null&&r!==void 0&&r.has(i.id)&&n.push(i)}),n}createUnsubscribeMessage(e){const t=[];return e.forEach(n=>{let[i,{kind:r,id:o}]=n;switch(r){case z.VIDEO:return void(i._videoSSRC&&t.push({stream_type:z.VIDEO,ssrcId:i._videoSSRC}));case z.AUDIO:return void(i._audioSSRC&&t.push({stream_type:z.AUDIO,ssrcId:i._audioSSRC}))}}),t}createUnsubscribeAllMessage(e){const t=new Map;return e.forEach(n=>{let[i,{kind:r}]=n;if(t.has(i)){let o=t.get(i);r===z.VIDEO?o|=Nt.Video:o|=Nt.Audio,t.set(i,o)}else r===z.VIDEO?t.set(i,Nt.Video):t.set(i,Nt.Audio)}),{users:Array.from(t.entries()).map(n=>{let[i,r]=n;return{stream_id:i.uid,stream_type:r}})}}withdrawRemoteTracks(e){e.forEach(t=>{let[n,{kind:i}]=t;const r=this.remoteUserMap.get(n);r&&(r.delete(i),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(n))})}async updateBitrateLimit(e){const t=this.localTrackMap.get(M.LocalVideoTrack),n=this.localTrackMap.get(M.LocalVideoLowTrack);t&&await t.track.setBitrateLimit(e.uplink),n&&e.low_stream_uplink&&await n.track.setBitrateLimit({max_bitrate:e.low_stream_uplink.bitrate,min_bitrate:e.low_stream_uplink.bitrate||0})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(e,t){return e.map((n,i)=>{var r;let{stream_type:o}=n;return(r=t.find(s=>{let{stream_type:a}=s;return o===a}))===null||r===void 0?void 0:r.attributes})}async tryToUnmuteAudio(e){for(let n=0;n<e.length;n++)if(e[n]instanceof St){var t;const i=this.filterTobeUnmutedTracks(e[n]);if(i.length===0)continue;await((t=this.connection)===null||t===void 0?void 0:t.unmuteLocal(i.map(o=>{let[,{id:s}]=o;return s})));const r=this.createUnmuteMessage(i);return void await Ue(this,ee.RequestUnmuteLocal,r)}}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=e=>{var t;return!((t=this.connection)===null||t===void 0||!t.getRemoteVideoIsReady(e))},this.statsUploader.requestUpload=(e,t)=>this.emit(ee.RequestUpload,e,t),this.statsUploader.requestUploadStats=e=>this.emit(ee.RequestUploadStats,e),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}async requestReconnect(){this.dtlsFailedCount+=1,await Pt(_h(this.dtlsFailedCount,_t)),this.emit(ee.RequestReconnect)}async reconnectP2P(){const e=Array.from(this.localTrackMap.entries()),t=this.createGatewayUnpublishMessage(e);Array.from(this.remoteUserMap.entries()),t.length>0&&await Tt(this,ee.RequestUnpublishForReconnectPC,t),this.disconnectForReconnect(),this.emit(ee.RequestReconnectPC)}canPublishLowStream(){return this.localTrackMap.has(M.LocalVideoTrack)||this.pendingLocalTracks.some(e=>e instanceof Ge)}throwIfTrackTypeNotMatch(e){if(e.filter(t=>t instanceof Ge).length>1)throw new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e.filter(t=>t instanceof St).length>1&&(e.some(t=>t instanceof St&&t._bypassWebAudio)||!ge().webAudioMediaStreamDest))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(const t of e){if(t instanceof Ge&&this.pendingLocalTracks.some(n=>n instanceof Ge))throw new L(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t instanceof St&&this.pendingLocalTracks.some(n=>n instanceof St)&&(!ge().webAudioMediaStreamDest||t._bypassWebAudio||this.pendingLocalTracks.some(n=>n instanceof St&&n._bypassWebAudio)))throw new L(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(e,t){const n=!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&ge().supportDualStreamEncoding,i=F(F({},{width:160,height:120,framerate:15,bitrate:50}),t);let r;r=n?e._mediaStreamTrack.clone():Of(e,i);const o=et(8,"track-low-"),s=new Ge(r,F(F({},n&&{scaleResolutionDownBy:wf(i,e)}),{},{frameRate:i.framerate,bitrateMax:i.bitrate,bitrateMin:i.bitrate}),void 0,void 0,o);return s.on(ls.TRANSCEIVER_UPDATED,a=>{e._updateRtpTransceiver(a,ba.LOW_STREAM)}),s._hints.push(je.LOW_STREAM),e.on("sei-to-send",a=>{s.emit("sei-to-send",a)}),e.addListener(W.NEED_CLOSE,()=>{s.close()}),s}async globalLock(){return this.mutex.lock("From P2PChannel.globalLock")}async reportPCStats(e,t,n){let i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Wi){var r,o,s,a;const c=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:d,dtlsTransportState:l,peerConnectionState:u}=this.connection,{local:h,remote:p}=await this.connection.getSelectedCandidatePair();q.pcStats(this.store.sessionId,{startTime:c,eventElapse:e-c||0,iceconnectionsate:d,dtlsstate:l,connectionstate:u,intSucc:t?1:2,error:i,selectedLocalCandidateProtocol:(r=h==null?void 0:h.protocol)!==null&&r!==void 0?r:"",selectedLocalCandidateType:(o=h.candidateType)!==null&&o!==void 0?o:"",selectedLocalCandidateAddress:"".concat(h.address,":").concat(h.port),selectedRemoteCandidateProtocol:(s=p.protocol)!==null&&s!==void 0?s:"",selectedRemoteCandidateType:(a=p.candidateType)!==null&&a!==void 0?a:"",selectedRemoteCandidateAddress:"".concat(p.address,":").concat(p.port),restartCnt:n})}}reportVideoFirstFrameDecoded(e,t,n,i){const r=Array.from(this.remoteUserMap.keys()).find(o=>o._videoSSRC===e);if(r){i||this.store.subscribe(r.uid,"video",void 0,void 0,void 0,void 0,Date.now());const o=this.store.keyMetrics,s=o.subscribe.find(a=>a.userId===r.uid&&a.type==="video");q.firstRemoteVideoDecode(this.store.sessionId,xt.FIRST_VIDEO_DECODE,Qe.FIRST_VIDEO_DECODE,{peer:r._uintid,videowidth:t,videoheight:n,subscribeElapse:nn.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId,apEnd:o.requestAPEnd||0,apStart:o.requestAPStart||0,joinGwEnd:o.joinGatewayEnd||0,joinGwStart:o.joinGatewayStart||0,pcEnd:o.peerConnectionEnd||0,pcStart:o.peerConnectionStart||0,subscriberEnd:(s==null?void 0:s.subscribeEnd)||0,subscriberStart:(s==null?void 0:s.subscribeStart)||0,videoAddNotify:(s==null?void 0:s.streamAdded)||0,state:i?1:0})}}async remoteMediaSsrcChanged(e,t,n){if(!this.connection)return!1;const i=this.remoteUserMap.get(e);if(!i)return!1;const r=i.get(t);if(!r)return!1;const o=await this.connection.getRemoteSSRC(r);return o!==void 0&&o!==n}resetConnection(e){f.debug("[".concat(this.store.clientId,"] [P2PChannel] reset connection to ").concat(e)),this.state===we.Connected?(f.debug("[".concat(this.store.clientId,"] [P2PChannel] fallback to websocket but P2PChannel state still connected, disconnect first")),this.disconnectForReconnect()):(this.connection&&(this.connection.close(),this.unbindConnectionEvents(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=e===ew.datachannel?new eo({},this.store):this.isPlanB?new Bs({},this.store):new Wi({},this.store),this.bindConnectionEvents(this.connection)))}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(e=>{let[t,{track:n}]=e;t===M.LocalVideoLowTrack?n._updateRtpTransceiver(void 0,ba.LOW_STREAM):n._updateRtpTransceiver(void 0)})}reportPCDisconnectedOrFailed(e){this.connection&&this.connection instanceof Wi&&(this.connection.iceConnectionState!=="disconnected"&&this.connection.iceConnectionState!=="checking"&&this.connection.iceConnectionState!=="failed"||(this._isFirstConnected?(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isFirstConnected=!1):this._pcStatsUploadType===br.TCP_RESTART&&e===_n.RELAY?this.reportPCStats(Date.now(),!1,this._pcStatsUploadType):this.reportPCStats(Date.now(),!1,br.DISCONNECTED_OR_FAILED)))}}).prototype,"startP2PConnection",[on],Object.getOwnPropertyDescriptor(de.prototype,"startP2PConnection"),de.prototype),B(de.prototype,"connect",[on],Object.getOwnPropertyDescriptor(de.prototype,"connect"),de.prototype),B(de.prototype,"updateRemoteRTPCapabilities",[on],Object.getOwnPropertyDescriptor(de.prototype,"updateRemoteRTPCapabilities"),de.prototype),B(de.prototype,"preConnect",[on],Object.getOwnPropertyDescriptor(de.prototype,"preConnect"),de.prototype),B(de.prototype,"publishDataChannel",[on],Object.getOwnPropertyDescriptor(de.prototype,"publishDataChannel"),de.prototype),B(de.prototype,"unpublish",[on],Object.getOwnPropertyDescriptor(de.prototype,"unpublish"),de.prototype),B(de.prototype,"unpublishDataChannel",[on],Object.getOwnPropertyDescriptor(de.prototype,"unpublishDataChannel"),de.prototype),B(de.prototype,"unpublishLowStream",[on],Object.getOwnPropertyDescriptor(de.prototype,"unpublishLowStream"),de.prototype),B(de.prototype,"subscribeDataChannel",[on],Object.getOwnPropertyDescriptor(de.prototype,"subscribeDataChannel"),de.prototype),B(de.prototype,"subscribe",[on],Object.getOwnPropertyDescriptor(de.prototype,"subscribe"),de.prototype),B(de.prototype,"massSubscribe",[on],Object.getOwnPropertyDescriptor(de.prototype,"massSubscribe"),de.prototype),B(de.prototype,"unsubscribe",[on],Object.getOwnPropertyDescriptor(de.prototype,"unsubscribe"),de.prototype),B(de.prototype,"unsubscribeDataChannel",[on],Object.getOwnPropertyDescriptor(de.prototype,"unsubscribeDataChannel"),de.prototype),B(de.prototype,"massUnsubscribe",[on],Object.getOwnPropertyDescriptor(de.prototype,"massUnsubscribe"),de.prototype),B(de.prototype,"muteRemote",[on],Object.getOwnPropertyDescriptor(de.prototype,"muteRemote"),de.prototype),B(de.prototype,"unmuteRemote",[on],Object.getOwnPropertyDescriptor(de.prototype,"unmuteRemote"),de.prototype),B(de.prototype,"hasRemoteMediaWithLock",[on],Object.getOwnPropertyDescriptor(de.prototype,"hasRemoteMediaWithLock"),de.prototype),B(de.prototype,"disconnectForReconnect",[on],Object.getOwnPropertyDescriptor(de.prototype,"disconnectForReconnect"),de.prototype),B(de.prototype,"updateBitrateLimit",[on],Object.getOwnPropertyDescriptor(de.prototype,"updateBitrateLimit"),de.prototype),B(de.prototype,"remoteMediaSsrcChanged",[on],Object.getOwnPropertyDescriptor(de.prototype,"remoteMediaSsrcChanged"),de.prototype),de);function on(e,t,n){const i=e[t];if(typeof i!="function")throw new Error("Cannot use mutex on object property.");return n.value=async function(){const r=this.mutex,o=await r.lock("From P2PChannel.".concat(t));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return await i.apply(this,a)}finally{o()}},n}function $M(e){let t=dC();return function(n,i){let r=n.appId;r!==void 0&&(Ae(i,10),_r(i,r));let o=n.cid;o!==void 0&&(Ae(i,16),Ae(i,o));let s=n.cname;s!==void 0&&(Ae(i,26),_r(i,s));let a=n.deviceId;a!==void 0&&(Ae(i,34),_r(i,a));let c=n.elapse;c!==void 0&&(Ae(i,40),to(i,c));let d=n.fileSize;d!==void 0&&(Ae(i,48),to(i,Gs(d)));let l=n.height;l!==void 0&&(Ae(i,56),to(i,Gs(l)));let u=n.jpg;u!==void 0&&(Ae(i,66),Ae(i,u.length),function(Lt,mt){let te=Ya(Lt,mt.length);Lt.bytes.set(mt,te)}(i,u));let h=n.networkType;h!==void 0&&(Ae(i,72),to(i,Gs(h)));let p=n.osType;p!==void 0&&(Ae(i,80),to(i,Gs(p)));let m=n.requestId;m!==void 0&&(Ae(i,90),_r(i,m));let E=n.sdkVersion;E!==void 0&&(Ae(i,98),_r(i,E));let g=n.sequence;g!==void 0&&(Ae(i,104),to(i,Gs(g)));let S=n.sid;S!==void 0&&(Ae(i,114),_r(i,S));let T=n.timestamp;T!==void 0&&(Ae(i,120),to(i,T));let I=n.uid;I!==void 0&&(Ae(i,128),Ae(i,I));let y=n.vid;y!==void 0&&(Ae(i,136),Ae(i,y));let w=n.width;w!==void 0&&(Ae(i,144),to(i,Gs(w)));let D=n.service;D!==void 0&&(Ae(i,152),Ae(i,D));let O=n.callbackData;O!==void 0&&(Ae(i,162),_r(i,O));let P=n.jpgEncryption;P!==void 0&&(Ae(i,168),Ae(i,P));let x=n.requestType;x!==void 0&&(Ae(i,176),Ae(i,x));let U=n.scorePorn;U!==void 0&&(Ae(i,185),Hp(i,U));let J=n.scoreSexy;J!==void 0&&(Ae(i,193),Hp(i,J));let Le=n.scoreNeutral;Le!==void 0&&(Ae(i,201),Hp(i,Le));let Be=n.scene;Be!==void 0&&(Ae(i,208),Ae(i,Be));let ot=n.ossFilePrefix;ot!==void 0&&(Ae(i,218),_r(i,ot));let vt=n.serviceVendor;if(vt!==void 0)for(let Lt of vt){Ae(i,226);let mt=dC();XM(Lt,mt),Ae(i,mt.limit),tU(i,mt),eU(mt)}}(e,t),function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)}(t)}function qM(e){return function(n){let i={};e:for(;!Tw(n);){let r=Sr(n);switch(r>>>3){case 0:break e;case 1:i.code=Sr(n);break;case 2:i.msg=Rw(n,Sr(n));break;case 3:{let o=QM(n);i.data=JM(n),n.limit=o;break}default:gw(n,7&r)}}return i}({bytes:t=e,offset:0,limit:t.length});var t}function JM(e){let t={};e:for(;!Tw(e);){let n=Sr(e);switch(n>>>3){case 0:break e;case 1:t.requestId=Rw(e,Sr(e));break;case 2:t.requestType=Sr(e)>>>0;break;case 3:t.scorePorn=Wp(e);break;case 4:t.scoreSexy=Wp(e);break;case 5:t.scoreNeutral=Wp(e);break;case 6:t.requestScene=Sr(e)>>>0;break;case 7:t.scene=Sr(e)>>>0;break;default:gw(e,7&n)}}return t}function XM(e,t){let n=e.service;n!==void 0&&(Ae(t,8),Ae(t,n));let i=e.vendor;i!==void 0&&(Ae(t,16),Ae(t,i));let r=e.token;r!==void 0&&(Ae(t,26),_r(t,r));let o=e.callbackUrl;o!==void 0&&(Ae(t,34),_r(t,o))}function QM(e){let t=Sr(e),n=e.limit;return e.limit=e.offset+t,n}function gw(e,t){switch(t){case 0:for(;128&Cw(e););break;case 2:jp(e,Sr(e));break;case 5:jp(e,4);break;case 1:jp(e,8);break;default:throw new Error("Unimplemented type: "+t)}}let ZM=new Float32Array(1);new Uint8Array(ZM.buffer);let sm=new Float64Array(1),Pn=new Uint8Array(sm.buffer);function Gs(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let Sw=[];function dC(){const e=Sw.pop();return e?(e.offset=e.limit=0,e):{bytes:new Uint8Array(64),offset:0,limit:0}}function eU(e){Sw.push(e)}function jp(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function Tw(e){return e.offset>=e.limit}function Ya(e,t){let n=e.bytes,i=e.offset,r=e.limit,o=i+t;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),e.bytes=s}return e.offset=o,o>r&&(e.limit=o),i}function am(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function Rw(e,t){let n=am(e,t),i=String.fromCharCode,r=e.bytes,o="",s="";for(let a=0;a<t;a++){let c,d,l,u,h=r[a+n];128&h?(224&h)==192?a+1>=t?s+=o:(c=r[a+n+1],(192&c)!=128?s+=o:(u=(31&h)<<6|63&c,u<128?s+=o:(s+=i(u),a++))):(240&h)==224?a+2>=t?s+=o:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?s+=o:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?s+=o:(s+=i(u),a+=2))):(248&h)==240?a+3>=t?s+=o:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?s+=o:(u-=65536,s+=i(55296+(u>>10),56320+(1023&u)),a+=3))):s+=o:s+=i(h)}return s}function _r(e,t){let n=t.length,i=0;for(let s=0;s<n;s++){let a=t.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+t.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}Ae(e,i);let r=Ya(e,i),o=e.bytes;for(let s=0;s<n;s++){let a=t.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+t.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function tU(e,t){let n=Ya(e,t.limit),i=e.bytes,r=t.bytes;for(let o=0,s=t.limit;o<s;o++)i[o+n]=r[o]}function Cw(e){return e.bytes[am(e,1)]}function lC(e,t){let n=Ya(e,1);e.bytes[n]=t}function Wp(e){let t=am(e,8),n=e.bytes;return Pn[0]=n[t++],Pn[1]=n[t++],Pn[2]=n[t++],Pn[3]=n[t++],Pn[4]=n[t++],Pn[5]=n[t++],Pn[6]=n[t++],Pn[7]=n[t++],sm[0]}function Hp(e,t){let n=Ya(e,8),i=e.bytes;sm[0]=t,i[n++]=Pn[0],i[n++]=Pn[1],i[n++]=Pn[2],i[n++]=Pn[3],i[n++]=Pn[4],i[n++]=Pn[5],i[n++]=Pn[6],i[n++]=Pn[7]}function Sr(e){let t,n=0,i=0;do t=Cw(e),n<32&&(i|=(127&t)<<n),n+=7;while(128&t);return i}function Ae(e,t){for(t>>>=0;t>=128;)lC(e,127&t|128),t>>>=7;lC(e,t)}function to(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,o=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=Ya(e,o),a=e.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:a[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:a[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:a[s]=o!==1?128|n:127&n}}const nU=new Map([["moderation",1],["supervise",2]]);class Fu extends qe{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const n=this._connectionState;this._connectionState=t,this.emit(Ut.CONNECTION_STATE_CHANGE,n,t)}get inspectType(){return this._inspectType}set inspectType(t){this._inspectMode=t.map(n=>nU.get(n)||0).reduce((n,i)=>n+i),this._inspectType=t}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(t){super(),this.name="AgoraRTCVideoContentInspect",this._connectionState=Ii.CONNECTING,this._innerConnectionState=void 0,this.sequence=0,this.inspectStartTime=void 0,this.workerManagerConnection=void 0,this.workerConnection=void 0,this.workerMessageLengthLimit=void 0,this.inspectIntervalMinimum=void 0,this.qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=Un.CancelToken.source(),this._retryConfig=void 0,this.wmSequence=0,this.inspectInterval=void 0,this.inspectTimer=null,this.ossFilePrefix=void 0,this.extraInfo=void 0,this._inspectType=void 0,this._inspectMode=void 0,this._quality=1,this.qualityTimer=null,this._inspectId=void 0,this._needWorkUrlOnly=!1,this.inspectImage=()=>{if(this.connectionState!==Ii.CONNECTED)throw new N(C.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===Ii.CONNECTED?this.requestToInspectImage():f.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()},this._inspectId=et(5,"inspect-"),this.workerMessageLengthLimit=A("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=A("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=A("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=t.interval,this.ossFilePrefix=t.ossFilePrefix,this.extraInfo=t.extraInfo,this.inspectType=t.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Ed("worker-manager-"+this._inspectId,_t),this.on(Ut.STATE_CHANGE,(n,i)=>{this._innerConnectionState=n,f.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Ci[n]," ").concat(i||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Ed("worker-"+this._inspectId,_t),this.handleWorkerEvents()}async init(t,n){this.emit(Ut.STATE_CHANGE,Ci.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=n,new Promise((r,o)=>{this.on(Ut.CONNECTION_STATE_CHANGE,(s,a)=>{a===Ii.CONNECTED&&r()}),this.requestAP(t,i,n).then(s=>{this.connectWorkerManager(s)}).catch(s=>{o(s)})})}async requestAP(t,n,i){const r=A("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),o=await function(a,c,d,l){let{appId:u,areaCode:h,cname:p,sid:m,token:E,uid:g}=c;fa++;const S="image_moderation_api",T={service_name:S,json_body:JSON.stringify({appId:u,areaCode:h,cname:p,command:"allocateEdge",requestId:fa,seq:fa,sid:m,token:E,ts:Date.now(),uid:g+""})};let I,y,w=a[0];return wr(async()=>{I=Date.now();const D=await or(w,{data:T,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(y=Date.now()-I,D.code!==0){const U=new N(C.UNEXPECTED_RESPONSE,"image inspect ap error, code"+D.code,{retry:!0,responseTime:y});throw f.error(U.toString()),U}const O=JSON.parse(D.json_body);if(O.code!==200){const U=new N(C.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(O.code,", reason: ").concat(O.reason),{code:O.code,responseTime:y});throw f.error(U.toString()),U}if(!O.servers||!Array.isArray(O.servers)||O.servers.length===0){const U=new N(C.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:O.code,responseTime:y});throw f.error(U.toString()),U}const P=A("VIDEO_INSPECT_WORKER_MANAGER_HOST"),x=A("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:O.servers.map(U=>{let{address:J,wss:Le}=U;if(J&&Le)return"wss://".concat(J.replace(/\./g,"-"),".").concat(P,":").concat(x||Le)}).filter(U=>!!U),workerToken:O.workerToken,vid:O.vid,responseTime:y}},(D,O)=>(q.apworkerEvent(m,{success:!0,sc:200,serviceName:S,responseDetail:JSON.stringify(D.addressList),firstSuccess:O===0,responseTime:y,serverIp:a[O%a.length]}),!1),(D,O)=>(q.apworkerEvent(m,{success:!1,sc:D.data&&D.data.code||200,serviceName:S,responseTime:y,serverIp:a[O%a.length]}),!!(D.code!==C.OPERATION_ABORTED&&D.code!==C.UNEXPECTED_RESPONSE||D.data&&D.data.retry)&&(w=a[(O+1)%a.length],!0)),l)}(r,t,n,i);this.emit(Ut.STATE_CHANGE,Ci.AP_CONNECTED);const{addressList:s}=o;return this.wmSequence++,s}async connectWorkerManager(t){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(Ut.STATE_CHANGE,Ci.CONNECT_WORKER_MANAGER),await this.workerManagerConnection.init(t,1e4)}async connectWorker(t){await this.workerConnection.init([t])}handleWorkerManagerEvents(){this.workerManagerConnection.on(ne.CONNECTED,async()=>{this.emit(Ut.STATE_CHANGE,Ci.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.21.0",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)}),this.workerManagerConnection.on(ne.CLOSED,()=>{this._innerConnectionState<Ci.GET_WORKER_MANAGER_RESPONSE&&f.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(ne.FAILED,()=>{this._innerConnectionState<Ci.GET_WORKER_MANAGER_RESPONSE&&f.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(ne.RECONNECTING,()=>{this._innerConnectionState<Ci.GET_WORKER_MANAGER_RESPONSE&&f.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(ne.ON_MESSAGE,async t=>{this.emit(Ut.STATE_CHANGE,Ci.GET_WORKER_MANAGER_RESPONSE);const n=this.workerManagerConnection.url;this.workerManagerConnection.close();const i=JSON.parse(t.data);if(i.code!==200)throw f.error("[".concat(this._inspectId,"] Unexpected code ").concat(i.code," from worker manager")),new N(C.UNEXPECTED_RESPONSE,"response code of worker is unexpected",i);if(!(i.serverResponse&&i.serverResponse.portWss&&n))throw f.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(i))),new N(C.UNEXPECTED_RESPONSE,"response content of worker is unexpected",i);{const r=A("VIDEO_INSPECT_WORKER_PORT")||i.serverResponse.portWss,o=n.replace(/:\d+\/?$/,":".concat(r));this.emit(Ut.STATE_CHANGE,Ci.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(Ut.REQUEST_NEW_WORKER_URL,o):await this.connectWorker(o)}}),this.workerManagerConnection.on(ne.WILL_RECONNECT,(t,n,i)=>{i(t)}),this.workerManagerConnection.on(ne.REQUEST_NEW_URLS,(t,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(n)})}handleWorkerEvents(){this.workerConnection.on(ne.CONNECTED,async()=>{this.emit(Ut.STATE_CHANGE,Ci.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=Ii.CONNECTED}),this.workerConnection.on(ne.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const n=qM(new Uint8Array(t.data));if(A("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&f.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),n.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Ut.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){const i={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},r=Object.keys(i).reduce((s,a)=>i[s]>i[a]?s:a,"porn"),o=Object.keys(i).find(s=>s===r);this.emit(Ut.INSPECT_RESULT,o)}else this.emit(Ut.INSPECT_RESULT,void 0,new N(C.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(Ut.INSPECT_RESULT,void 0,new N(C.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else f.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Ut.INSPECT_RESULT,void 0,new N(C.UNEXPECTED_RESPONSE,"invalid worker message type"))}),this.workerConnection.on(ne.CLOSED,()=>{this.connectionState=Ii.CLOSED}),this.workerConnection.on(ne.FAILED,()=>{this.connectionState=Ii.CLOSED}),this.workerConnection.on(ne.RECONNECTING,()=>{this.connectionState=this.connectionState===Ii.CONNECTED?Ii.RECONNECTING:Ii.CONNECTING}),this.workerConnection.on(ne.WILL_RECONNECT,(t,n,i)=>{t==="recover"&&i(t),i("tryNext")}),this.workerConnection.on(ne.REQUEST_NEW_URLS,(t,n)=>{this.workerManagerConnection.close(),this.once(Ut.REQUEST_NEW_WORKER_URL,i=>{t([i])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(i=>{this.connectWorkerManager(i,!0)}).catch(i=>{n(i)})})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){this.sequence++;const t=Gn(this,Ut.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void this.emit(Ut.INSPECT_RESULT,void 0,new N(C.INVALID_OPERATION,"Only the track being played can be inspected"));const i=await this.generateRequestData(t,n);this.workerConnection.sendMessage(i,!0,!0)}else this.emit(Ut.INSPECT_RESULT,void 0,new N(C.INVALID_OPERATION,"Only the track being published can be inspected"))}async generateRequestData(t,n){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=n;const d=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),u=await W0(l,i,r),h=this.sequence+"-"+o+"-"+c+"-"+d+"-"+et(12,""),p={appId:i,cid:o,cname:r,deviceId:"",elapse:Fu.intToLong(Number(d-this.inspectStartTime)),fileSize:u.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.21.0",sequence:this.sequence,sid:a,timestamp:Fu.intToLong(d),uid:c,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};this.extraInfo===void 0&&delete p.callbackData,this.ossFilePrefix===void 0&&delete p.ossFilePrefix;const m=$M(p);if(m.byteLength<this.workerMessageLengthLimit){if(A("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){const E=F({},p);delete E.jpg,f.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(E))}return m}{const E=this.quality*this.qualityRatio;return this.quality=E,await this.generateRequestData(t,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Un.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=Ii.CLOSED,this.emit(Ut.STATE_CHANGE,Ci.CLOSED)}}function iU(e){let t=function(){const n=sU.pop();return n?(n.offset=n.limit=0,n):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(n,i){let r=n.appId;r!==void 0&&(ht(i,10),no(i,r));let o=n.cid;o!==void 0&&(ht(i,16),ht(i,o));let s=n.cname;s!==void 0&&(ht(i,26),no(i,s));let a=n.deviceId;a!==void 0&&(ht(i,34),no(i,a));let c=n.elapse;c!==void 0&&(ht(i,40),io(i,c));let d=n.fileSize;d!==void 0&&(ht(i,48),io(i,js(d)));let l=n.height;l!==void 0&&(ht(i,56),io(i,js(l)));let u=n.jpg;u!==void 0&&(ht(i,66),ht(i,u.length),uC(i,u));let h=n.networkType;h!==void 0&&(ht(i,72),io(i,js(h)));let p=n.osType;p!==void 0&&(ht(i,80),io(i,js(p)));let m=n.requestId;m!==void 0&&(ht(i,90),no(i,m));let E=n.sdkVersion;E!==void 0&&(ht(i,98),no(i,E));let g=n.sequence;g!==void 0&&(ht(i,104),io(i,js(g)));let S=n.sid;S!==void 0&&(ht(i,114),no(i,S));let T=n.timestamp;T!==void 0&&(ht(i,120),io(i,T));let I=n.uid;I!==void 0&&(ht(i,128),ht(i,I));let y=n.vid;y!==void 0&&(ht(i,136),ht(i,y));let w=n.width;w!==void 0&&(ht(i,144),io(i,js(w)));let D=n.service;D!==void 0&&(ht(i,152),ht(i,D));let O=n.callbackData;O!==void 0&&(ht(i,162),ht(i,O.length),uC(i,O));let P=n.ticket;P!==void 0&&(ht(i,170),no(i,P));let x=n.vendorConfigs;x!==void 0&&(ht(i,178),no(i,x))}(e,t),function(n){let i=n.bytes,r=n.limit;return i.length===r?i:i.subarray(0,r)}(t)}function rU(e){return function(n){let i={};e:for(;!aU(n);){let r=Ic(n);switch(r>>>3){case 0:break e;case 1:i.code=Ic(n);break;case 2:i.msg=hC(n,Ic(n));break;case 3:i.requestId=hC(n,Ic(n));break;case 4:i.timestamp=cU(n,!1);break;default:oU(n,7&r)}}return i}({bytes:t=e,offset:0,limit:t.length});var t}function oU(e,t){switch(t){case 0:for(;128&Ai(e););break;case 2:Kp(e,Ic(e));break;case 5:Kp(e,4);break;case 1:Kp(e,8);break;default:throw new Error("Unimplemented type: "+t)}}function js(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}let sU=[];function Kp(e,t){if(e.offset+t>e.limit)throw new Error("Skip past limit");e.offset+=t}function aU(e){return e.offset>=e.limit}function Ah(e,t){let n=e.bytes,i=e.offset,r=e.limit,o=i+t;if(o>n.length){let s=new Uint8Array(2*o);s.set(n),e.bytes=s}return e.offset=o,o>r&&(e.limit=o),i}function vw(e,t){let n=e.offset;if(n+t>e.limit)throw new Error("Read past limit");return e.offset+=t,n}function uC(e,t){let n=Ah(e,t.length);e.bytes.set(t,n)}function hC(e,t){let n=vw(e,t),i=String.fromCharCode,r=e.bytes,o="",s="";for(let a=0;a<t;a++){let c,d,l,u,h=r[a+n];128&h?(224&h)==192?a+1>=t?s+=o:(c=r[a+n+1],(192&c)!=128?s+=o:(u=(31&h)<<6|63&c,u<128?s+=o:(s+=i(u),a++))):(240&h)==224?a+2>=t?s+=o:(c=r[a+n+1],d=r[a+n+2],(49344&(c|d<<8))!=32896?s+=o:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?s+=o:(s+=i(u),a+=2))):(248&h)==240?a+3>=t?s+=o:(c=r[a+n+1],d=r[a+n+2],l=r[a+n+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?s+=o:(u-=65536,s+=i(55296+(u>>10),56320+(1023&u)),a+=3))):s+=o:s+=i(h)}return s}function no(e,t){let n=t.length,i=0;for(let s=0;s<n;s++){let a=t.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+t.charCodeAt(++s)-56613888),i+=a<128?1:a<2048?2:a<65536?3:4}ht(e,i);let r=Ah(e,i),o=e.bytes;for(let s=0;s<n;s++){let a=t.charCodeAt(s);a>=55296&&a<=56319&&s+1<n&&(a=(a<<10)+t.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function Ai(e){return e.bytes[vw(e,1)]}function pC(e,t){let n=Ah(e,1);e.bytes[n]=t}function Ic(e){let t,n=0,i=0;do t=Ai(e),n<32&&(i|=(127&t)<<n),n+=7;while(128&t);return i}function ht(e,t){for(t>>>=0;t>=128;)pC(e,127&t|128),t>>>=7;pC(e,t)}function cU(e,t){let n,i=0,r=0,o=0;return n=Ai(e),i=127&n,128&n&&(n=Ai(e),i|=(127&n)<<7,128&n&&(n=Ai(e),i|=(127&n)<<14,128&n&&(n=Ai(e),i|=(127&n)<<21,128&n&&(n=Ai(e),r=127&n,128&n&&(n=Ai(e),r|=(127&n)<<7,128&n&&(n=Ai(e),r|=(127&n)<<14,128&n&&(n=Ai(e),r|=(127&n)<<21,128&n&&(n=Ai(e),o=127&n,128&n&&(n=Ai(e),o|=(127&n)<<7))))))))),{low:i|r<<28,high:r>>>4|o<<24,unsigned:t}}function io(e,t){let n=t.low>>>0,i=(t.low>>>28|t.high<<4)>>>0,r=t.high>>>24,o=r===0?i===0?n<16384?n<128?1:2:n<1<<21?3:4:i<16384?i<128?5:6:i<1<<21?7:8:r<128?9:10,s=Ah(e,o),a=e.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?i>>>21|128:i>>>21&127;case 7:a[s+6]=o!==7?i>>>14|128:i>>>14&127;case 6:a[s+5]=o!==6?i>>>7|128:i>>>7&127;case 5:a[s+4]=o!==5?128|i:127&i;case 4:a[s+3]=o!==4?n>>>21|128:n>>>21&127;case 3:a[s+2]=o!==3?n>>>14|128:n>>>14&127;case 2:a[s+1]=o!==2?n>>>7|128:n>>>7&127;case 1:a[s]=o!==1?128|n:127&n}}const _C={},fC={},Bu=4294967296,Iw=Bu*Bu,EC=Iw/2,zp=yw(0,!0),mC=yw(0),dU=ka(0,-2147483648,!1),lU=ka(-1,2147483647,!1),uU=ka(-1,-1,!0);function yw(e,t){let n,i,r;return t?(r=0<=(e>>>=0)&&e<256)&&(i=fC[e],i)?i:(n=ka(e,0,!0),r&&(fC[e]=n),n):(r=-128<=(e|=0)&&e<128)&&(i=_C[e],i)?i:(n=ka(e,e<0?-1:0,!1),r&&(_C[e]=n),n)}function ka(e,t,n){return{low:0|e,high:0|t,unsigned:!!n}}function hU(e,t){if(isNaN(e))return t?zp:mC;if(t){if(e<0)return zp;if(e>=Iw)return uU}else{if(e<=-EC)return dU;if(e+1>=EC)return lU}return e<0?t?zp:mC:ka(e%Bu|0,e/Bu|0,t)}class cm extends qe{get connectionState(){return this._connectionState}set connectionState(t){if(this._connectionState===t)return;const n=this._connectionState;this._connectionState=t,this.emit(Hi.CONNECTION_STATE_CHANGE,t,n)}get quality(){return this._quality}set quality(t){this._quality=t>1?1:t<.1?.1:t,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(t){var n;super(),this.name="AgoraRTCImageModeration",this._connectionState=ci.CONNECTING,this._sequence=0,this._moderationStartTime=void 0,this._workerConnection=void 0,this._workerMessageLengthLimit=void 0,this._qualityRatio=void 0,this._connectInfo=void 0,this._cancelTokenSource=Un.CancelToken.source(),this._retryConfig=void 0,this._moderationInterval=void 0,this._moderationTimer=null,this._moderationMode=1,this._quality=1,this._qualityTimer=null,this._ticket=void 0,this._moderationIntervalMinimum=void 0,this._uploadFailedNum=0,this._uploadNum=0,this._uploadTimer=null,this._extraInfo=void 0,this._vendor="",this._encoder=new TextEncoder,this._moderationId=void 0,this.inspectImage=()=>{if(this.connectionState!==ci.CONNECTED)throw new N(C.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===ci.CONNECTED?this.requestToInspectImage():f.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()},this._moderationId=et(5,"image-moderation-"),this._workerMessageLengthLimit=A("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=A("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(n=t.interval)!==null&&n!==void 0?n:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),this._qualityRatio=A("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Ed("worker-"+this._moderationId,_t),this.on(Hi.STATE_CHANGE,(i,r)=>{f.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Vs[i]," ").concat(r||""))}),this.handleWorkerEvents()}async init(t,n){this.emit(Hi.STATE_CHANGE,Vs.CONNECT_AP),this._connectInfo=t;const i=this._cancelTokenSource.token;return this._retryConfig=n,new Promise((r,o)=>{this.on(Hi.CONNECTION_STATE_CHANGE,(s,a)=>{s===ci.CONNECTED&&r()}),this.requestAP(t,i,n).then(s=>{this.connectWorker(s)}).catch(s=>{o(s)})})}updateConfig(t){var n;this._moderationInterval=(n=t.interval)!==null&&n!==void 0?n:1e3,t.extraInfo&&(this._extraInfo=this._encoder.encode(t.extraInfo)),t.vendor&&(this._vendor=t.vendor),f.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(t))),this.connectionState===ci.CONNECTED&&this.inspectImage()}async requestAP(t,n,i){const r=A("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),o=await function(c,d,l,u){let{appId:h,areaCode:p,cname:m,sid:E,token:g,uid:S}=d;fa++;const T="moderation_plugin",I={service_name:T,json_body:JSON.stringify({appId:h,areaCode:p,cname:m,command:"allocateEdge",requestId:fa,seq:fa,sid:E,appToken:g,ts:Date.now(),uid:S+""})};let y,w,D=c[0];return wr(async()=>{y=Date.now();const O=await or(D,{data:I,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(w=Date.now()-y,O.code!==0){const U=new N(C.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+O.code,{retry:!0,responseTime:w});throw f.error(U.toString()),U}const P=JSON.parse(O.json_body);if(P.code!==200){const U=new N(C.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(P.code,", reason: ").concat(P.reason),{code:P.code,responseTime:w});throw f.error(U.toString()),U}if(!P.servers||!Array.isArray(P.servers)||P.servers.length===0){const U=new N(C.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:P.code,responseTime:w});throw f.error(U.toString()),U}if(!P.servers.some(U=>!!U.wss)){const U=new N(C.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:P.code,responseTime:w});throw f.error(U.toString()),U}const x=A("IMAGE_MODERATION_WORKER_HOST");return{addressList:P.servers.map(U=>{let{address:J,wss:Le}=U;if(J&&Le)return"wss://".concat(J.replace(/\./g,"-"),".").concat(x,":").concat(Le,"/moderation")}).filter(U=>!!U),workerToken:P.workerToken,vid:P.vid,ticket:P.appTicket,responseTime:w}},(O,P)=>(q.apworkerEvent(E,{success:!0,sc:200,serviceName:T,responseDetail:JSON.stringify(O.addressList),firstSuccess:P===0,responseTime:w,serverIp:c[P%c.length]}),!1),(O,P)=>(q.apworkerEvent(E,{success:!1,sc:O.data&&O.data.code||200,serviceName:T,responseTime:w,serverIp:c[P%c.length]}),!!(O.code!==C.OPERATION_ABORTED&&O.code!==C.UNEXPECTED_RESPONSE||O.data&&O.data.retry)&&(D=c[(P+1)%c.length],!0)),u)}(r,t,n,i);this.emit(Hi.STATE_CHANGE,Vs.AP_CONNECTED);const{addressList:s,ticket:a}=o;return this._ticket=a,s}async connectWorker(t){this.emit(Hi.STATE_CHANGE,Vs.CONNECT_WORKER),await this._workerConnection.init(t,1e4)}handleWorkerEvents(){this._workerConnection.on(ne.CONNECTED,async()=>{this.emit(Hi.STATE_CHANGE,Vs.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=ci.CONNECTED}),this._workerConnection.on(ne.CLOSED,()=>{this.connectionState=ci.CLOSED}),this._workerConnection.on(ne.FAILED,()=>{this.connectionState=ci.CLOSED}),this._workerConnection.on(ne.RECONNECTING,()=>{this.connectionState=this.connectionState===ci.CONNECTED?ci.RECONNECTING:ci.CONNECTING}),this._workerConnection.on(ne.ON_MESSAGE,async t=>{if(t.data instanceof ArrayBuffer){const n=rU(new Uint8Array(t.data));A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&f.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(n)),this._uploadNum++,n.code===void 0||n.code===0||(this._uploadFailedNum++,f.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(n.code,", msg is ").concat(n.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{q.reportApiInvoke(this._connectInfo.sid||null,{name:an.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,n.code],tag:bt.TRACER}).onError(new N(C.IMAGE_MODERATION_UPLOAD_FAILED,n.msg)),this._uploadTimer=null},A("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else f.error("[".concat(this._moderationId,"] Unexpected message type from worker"))}),this._workerConnection.on(ne.WILL_RECONNECT,(t,n,i)=>{t==="recover"&&i(t),i("tryNext")}),this._workerConnection.on(ne.REQUEST_NEW_URLS,(t,n)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(t).catch(n)})}static intToLong(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}async requestToInspectImage(){const t=Gn(this,Hi.CLIENT_LOCAL_VIDEO_TRACK),n={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(t){if(!t.isPlaying)return void(A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&f.debug("Only the track being played can be inspected"));this._sequence++;const i=await this.generateRequestData(t,n);this._workerConnection.sendMessage(i,!0,!0)}else A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&f.debug("Only the track being published can be inspected")}async generateRequestData(t,n){let{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c}=n;const d=Date.now(),l=await t.getCurrentFrameImage("image/jpeg",this.quality),u=await W0(l,i,r),h=this._sequence+"-"+o+"-"+c+"-"+d+"-"+et(12,""),p={appId:i,cid:o,cname:r,deviceId:"",elapse:cm.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.21.0",sequence:this._sequence,sid:a,timestamp:hU(d),uid:c,vid:s,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete p.callbackData;const m=iU(p);if(m.byteLength<this._workerMessageLengthLimit){if(A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){const E=F({},p);delete E.jpg,f.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(E))}return m}{const E=this.quality*this._qualityRatio;return this.quality=E,await this.generateRequestData(t,{appId:i,cname:r,cid:o,vid:s,sid:a,uid:c})}}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=Un.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=ci.CLOSED,this.emit(Hi.STATE_CHANGE,Vs.CLOSED)}}const pU=Date.now(),_U=20,Df=new Map,tu=new Map;async function Aw(e){const t=Df.get(e),n=Array.isArray(t)&&t[t.length-1],i=tu.get(e);if(!n)return void(i.isSyncing=!1);const r={uid:n.uid,payload:n.payload};i.firstRecvTs===0&&(i.firstRecvTs=n.recvTs,i.firstSendTs=n.sendTs);const o=n.sendTs-i.firstSendTs,s=o-(Date.now()-i.firstRecvTs);s>0&&(i.firstRecvTs=Date.now()-o);let a=n.mediaDelay+s;a<=0?(t.pop(),ww(n.context,r),a=0):a=Math.min(a,_U),setTimeout(()=>t.length&&Aw(e),a)}function ww(e,t){e.safeEmit(_e.STREAM_MESSAGE,t.uid,t.payload),e.onStreamMessage&&e.onStreamMessage(t)}function fU(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;if(!e.syncWithAudio)return ww(n,{uid:e.uid,payload:e.payload});const i="".concat(n.id,"-").concat(e.uid),r=Df.get(i)||[],o=r.findIndex(d=>e.sendTs>=d.sendTs),s=F(F({},e),{},{context:n,mediaDelay:t,recvTs:Date.now()});o===-1?r.push(s):r.splice(o,0,s),Df.set(i,r);let a=!1;var c;tu.has(i)?a=!((c=tu.get(i))===null||c===void 0||!c.isSyncing):tu.set(i,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||Aw(i)}Ie().name;const ma="websdk_ng_cache_parameter",EU=A("MAX_PRELOAD_ASYNC_LENGTH"),mU=1e4,Jo=new Map,ra=[];let Yp=null,$p=0,qp=0;const Rl=new Map,gU=function(e,t){const n=[];let i=0;const r=async()=>{const o=n.shift();o&&await o(),n.length>0&&i<t?r():i--};return async function(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return new Promise(async(c,d)=>{n.push(async()=>{try{const l=await e(...s);c(l)}catch(l){d(l)}}),i<t&&(i++,r())})}}(SU,EU),Jp=Un.CancelToken.source();async function SU(e,t,n,i,r){try{if(!A("ENABLE_PRELOAD"))return;if(!ge().supportWebCrypto)return void Mo(()=>{f.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!n&&n!==null)throw new L(C.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&jt(n,"token",1,2047),jt(e,"appid",1,2047),Sh(t),i&&Th(i);const o=kc();f.debug("preload channel ".concat(t,", uid is ").concat(i));const s={appId:e,cname:t,token:n||e,uid:typeof i!="string"?i:null,sid:o,proxyServer:r};let a,c;typeof i=="string"?(s.stringUid=i,[c,a]=await Promise.all([bM(i,{sid:o,appId:e},Jp.token),UR(F(F({},s),{},{token:n||e,uid:0}),Jp.token)]),s.uid=c.uid,a.gatewayInfo.uid=s.uid,a.gatewayInfo.res.uid=s.uid):a=await UR(s,Jp.token);const d={sid:o,appId:e,cname:t,token:n||e,uid:s.stringUid||i,intUid:s.uid||a.gatewayInfo.uid,stringUid:s.stringUid,ts:Date.now(),sua:c,ap:a};await async function(l){let u;try{l.uid&&Nw({appId:l.appId,cname:l.cname,token:l.token,uid:l.uid,stringUid:l.stringUid});const h=Dw(l),p=await async function(E,g){try{const S=await window.crypto.subtle.importKey("raw",UA(g),"AES-GCM",!1,["encrypt"]),T=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},S,ns(window.btoa(JSON.stringify(E))));return No(new Uint8Array(T))}catch{return}}(l,l.token||l.appId);if(!p)return;u=bw(ma);const m=u?JSON.parse(u):[];m.push({[h]:p}),m.length>A("AP_CACHE_NUM")&&m.shift(),Gu(ma,JSON.stringify(m))}catch(h){f.warn("Error caching server parameters:",h.message),Gu(ma,"")}}(d),$p++}catch(o){throw qp++,function(s){Yp||(Yp=window.setTimeout(()=>{let c="";Rl.forEach((d,l)=>{c+="".concat(l,": ").concat(d," ;")}),q.reportApiInvoke(null,{name:an.PRELOAD,options:{success:$p,failed:qp,err:c}}).onError(s),$p=0,qp=0,Rl.clear(),Yp=null},mU));const a=Rl.get(s.code)||0;Rl.set(s.code,a+1)}(o),o}}async function gC(e){try{const t=Nw(e);if(!t||e.cloudProxyServer!=="disabled")return;const n=await async function(i,r){try{const o=await window.crypto.subtle.importKey("raw",UA(r),"AES-GCM",!1,["decrypt"]),s=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},o,ns(i));return JSON.parse(window.atob(No(new Uint8Array(s))))}catch{return}}(t,e.token||e.appId);if(!n||!function(i,r){return i.cname===r.cname&&i.appId===r.appId&&i.token===r.token?r.stringUid?i.stringUid===r.stringUid:typeof r.uid=="number"?i.uid===r.uid:i.uid==r.uid:!1}(n,e))return;if(n&&Date.now()-n.ts<A("AP_CACHE_LIFETIME"))return n}catch(t){f.warn("Error get preloadInfo",t.message)}}function Nw(e){let t;try{if(t=bw(ma),!t)return;const n=JSON.parse(t),i=Dw(e),r=function(s,a){for(let c=s.length-1;c>=0;c--)if(a(s[c]))return c;return-1}(n,s=>i in s);if(r===-1)return;const o=n.splice(r,1)[0];return Gu(ma,JSON.stringify(n)),o[i]}catch(n){f.warn("Error delete preload info: ".concat(t),n.message),Gu(ma,"")}}function dm(e){if(e){let t=Jo.get(e);t&&(window.clearTimeout(t),t=null,Jo.delete(e)),ra.includes(e)||e.cloudProxyServer!=="disabled"||ra.push(e)}if(Jo.size<A("AP_CACHE_NUM")&&ra.length>0){const t=ra.shift();Jo.set(t,window.setTimeout(async()=>{const{appId:n,cname:i,token:r,uid:o,proxyServer:s}=t;try{await gU(n,i,r,o,s),Jo.has(t)&&dm(t)}catch(a){f.warn("update preload failed",a.message),Ow(t)}},A("AP_UPDATE_INTERVAL")))}}function Ow(e){const t=ra.indexOf(e);t!==-1&&ra.splice(t,1);let n=Jo.get(e);n&&(window.clearTimeout(n),n=null,Jo.delete(e),dm())}function SC(e,t){const n=e.sua,i=e.ap;t&&n&&q.reqUserAccount(e.sid,{lts:n.requestTime,elapse:n.elapse,success:!0,serverAddr:n.url,stringUid:t,uid:e.intUid,errorCode:null,extend:n.req}),q.reportResourceTiming(e.ap.url,e.sid),q.joinWebProxyAP(e.sid,{lts:i.requestTime,elapse:i.elapse,sucess:1,apServerAddr:i.url,turnServerAddrList:i.proxyInfo.addresses.map(r=>r.ip).join(","),eventType:"disabled",unilbsServerIds:[ft.CHOOSE_SERVER,ft.CLOUD_PROXY_FALLBACK].toString()}),q.joinChooseServer(e.sid,{lts:i.requestTime,elapse:i.elapse,succ:!0,csAddr:i.url,opid:i.opid,serverList:i.gatewayInfo.gatewayAddrs.map(r=>r.address),ec:null,cid:i.gatewayInfo.cid.toString(),uid:i.gatewayInfo.uid.toString(),csIp:i.gatewayInfo.csIp,unilbsServerIds:[ft.CHOOSE_SERVER].toString(),isHttp3:i.isHttp3})}function bw(e){return window.atob(window.localStorage.getItem(e)||"")}function Gu(e,t){window.localStorage.setItem(e,window.btoa(t))}function Dw(e){let t="".concat(e.appId,"_").concat(e.cname);return typeof e.uid=="string"&&(t+="_s_".concat(e.uid)),typeof e.uid=="number"&&(t+="_".concat(e.uid)),e.token&&(t+="_".concat(e.token)),FA(t)}var TC,RC,CC,vC,IC,yC,AC,wC,NC,OC,bC,DC,PC,LC,kC,MC,UC,xC,VC,FC,BC,GC,jC,WC,HC,KC,zC,YC,$C,qC,JC,XC,QC,ZC,ev,tv,nv,iv,rv,ov,sv,av,j;Bt.setLogger(f);let TU=(TC=Z(),RC=Z({argsMap:(e,t)=>{if(!Array.isArray(t)){if(!(t instanceof ia))return[t];t=[t]}return t.map(n=>n?Object(n).toString():"null")}}),CC=Z({argsMap:(e,t)=>(t||(t=[]),t instanceof RR?[t.getChannelId()]:(Array.isArray(t)||(t=[t]),t.map(n=>n.getTrackId())))}),vC=Z({argsMap:(e,t,n,i)=>[typeof t=="object"?t.uid:t,n,i]}),IC=Z({argsMap:(e,t,n)=>[t,n]}),yC=Z({argsMap:(e,t)=>t.map(n=>{let{user:i,mediaType:r}=n;return[i==null?void 0:i.uid,r]})}),AC=Z({argsMap:(e,t,n,i)=>[typeof t=="object"?t.uid:t,n,i]}),wC=Z({argsMap:(e,t)=>t.map(n=>{let{user:i,mediaType:r}=n;return{uid:i==null?void 0:i.uid,mediaType:r}})}),NC=Z(),OC=Z(),bC=Z(),DC=Z(),PC=Z(),LC=Z(),kC=Z(),MC=Z(),UC=Z(),xC=Z(),VC=Z(),FC=Z(),BC=Z(),GC=Z(),jC=Z({argsMap:(e,t)=>[t]}),WC=Z(),HC=Z(),KC=Z(),zC=Z(),YC=Z(),$C=Z(),qC=Z(),JC=Z(),XC=Z(),QC=Z(),ZC=Z({argsMap:(e,t)=>(Array.isArray(t)||(t=[t]),[JSON.stringify(t)])}),ev=Z(),tv=Z(),nv=Z(),iv=Z(),rv=Z(),ov=Z(),sv=Z({reportResult:!0}),av=Z(),B((j=class extends qe{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var e;return((e=this._config)===null||e===void 0?void 0:e.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(e){let t;if(super(),this.store=void 0,this._uid=void 0,this._channelName=void 0,this._uintUid=void 0,this._users=[],this._config=void 0,this._clientId=void 0,this._appId=void 0,this._sessionId=null,this._key=void 0,this._rtmConfig={},this._joinInfo=void 0,this._gateway=void 0,this._statsCollector=void 0,this._configDistribute=void 0,this._leaveMutex=new Bt("client-leave"),this._publishMutex=new Bt("client-publish"),this._renewTokenMutex=new Bt("client-renewtoken"),this._subscribeMutex=new Bt("client-subscribe"),this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStream=!1,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._proxyServer=void 0,this._turnServer={servers:[],mode:"auto"},this._cloudProxyServerMode="disabled",this._isDualStreamEnabled=!1,this._defaultStreamFallbackType=void 0,this._lowStreamParameter=void 0,this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._axiosCancelSource=Un.CancelToken.source(),this._audioVolumeIndicationInterval=void 0,this._networkQualityInterval=void 0,this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0,this._injectStreamingClient=void 0,this._liveTranscodeStreamingClient=void 0,this._liveRawStreamingClient=void 0,this._channelMediaRelayClient=void 0,this._networkQualitySensitivity="normal",this._p2pChannel=void 0,this._useLocalAccessPoint=!1,this._setLocalAPVersion=void 0,this._joinAndNotLeaveYet=!1,this._numberOfJoinCount=0,this._remoteDefaultVideoStreamType=void 0,this._inspect=void 0,this._moderation=void 0,this._license=void 0,this._pendingPublishedUsers=[],this.ntpAlignErrorCount=0,this.remoteInboundOffset=0,this._handleLocalTrackEnable=(n,i,r)=>{this.publish(n,!1).then(i).catch(r)},this._handleLocalTrackDisable=(n,i,r)=>{this.unpublish(n).then(i).catch(r)},this._handleUserOnline=n=>{if(A("BLOCK_LOCAL_CLIENT")&&Go(n.uid,this.channelName))return void f.debug("[".concat(n.uid,"] will be ignored in local"));this.isStringUID&&typeof n.uid!="string"&&f.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));const i=this._users.find(r=>r.uid===n.uid);if(i)i._trust_in_room_=!0,i._is_pre_created&&(i._is_pre_created=!1,this.safeEmit(_e.USER_JOINED,i));else{const r=new ho(n.uid,n.uint_id||n.uid);this._users.push(r),f.debug("[".concat(this._clientId,"] user online"),n.uid),this.safeEmit(_e.USER_JOINED,r)}},this._handleUserOffline=n=>{if(A("BLOCK_LOCAL_CLIENT")&&Go(n.uid,this.channelName))return;const i=this._users.find(r=>r.uid===n.uid);i&&(this._handleRemoveStream(n),this._handleRemoveDataChannels(n),i._audio_pre_subscribed||i._video_pre_subscribed?i._is_pre_created=!0:Ou(this._users,i),this._remoteStreamTypeCacheMap.delete(i.uid),this._streamFallbackTypeCacheMap.delete(i.uid),f.debug("[".concat(this._clientId,"] user offline"),n.uid,"reason:",n.reason),this.safeEmit(_e.USER_LEAVED,i,n.reason))},this._handleAddAudioOrVideoStream=(n,i,r,o,s,a,c)=>{if(A("BLOCK_LOCAL_CLIENT")&&Go(i,this.channelName))return;const d=this._users.find(u=>u.uid===i);if(!d)return void f.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));f.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(n)),this.store.subscribe(d.uid,n,void 0,void 0,void 0,Date.now());const l=n==="audio"?d.hasAudio:d.hasVideo;d._uintid||(d._uintid=s||i),n==="audio"?d._trust_audio_stream_added_state_=!0:d._trust_video_stream_added_state_=!0,n==="audio"?(d._audio_added_=!0,r!==void 0&&(d._audioSSRC=r),o!==void 0&&(d._cname=o),a&&(d._audioOrtc=a)):(d._video_added_=!0,r!==void 0&&(d._videoSSRC=r),o!==void 0&&(d._cname=o),c!==void 0&&(d._rtxSsrcId=c),a&&(d._videoOrtc=a)),(n==="audio"?d.hasAudio:d.hasVideo)&&!l&&(f.info("[".concat(this._clientId,"] remote user ").concat(d.uid," published ").concat(n)),this.safeEmit(_e.USER_PUBLISHED,d,n)),n==="video"?q.onGatewayStream(this._sessionId,xt.ON_ADD_VIDEO_STREAM,Qe.ON_ADD_VIDEO_STREAM,{peer:s||i,ssrc:d._videoSSRC}):q.onGatewayStream(this._sessionId,xt.ON_ADD_AUDIO_STREAM,Qe.ON_ADD_AUDIO_STREAM,{peer:s||i,ssrc:d._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(d,n,r).then(u=>{if(u&&(f.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(d.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Tl))return this._p2pChannel.unsubscribe(d,n,!0).then(()=>this._subscribe(d,n,!0).catch(h=>{f.error("[".concat(this._clientId,"] resubscribe error"),h.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(d,n)&&(f.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(d.uid," after reconnect.")),this._subscribe(d,n,!0).catch(u=>{f.error("[".concat(this._clientId,"] resubscribe error"),u.toString())}))},this._handleRemoveStream=n=>{if(A("BLOCK_LOCAL_CLIENT")&&Go(n.uid,this.channelName))return;const i=this._users.find(o=>o.uid===n.uid);if(!i)return void f.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));f.debug("[".concat(this._clientId,"] stream removed with uid ").concat(n.uid));let r=()=>{};i.hasAudio&&i.hasVideo?r=()=>{f.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(_e.USER_UNPUBLISHED,i,"audio"),f.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(_e.USER_UNPUBLISHED,i,"video")}:i.hasVideo?r=()=>{f.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished video track")),this.safeEmit(_e.USER_UNPUBLISHED,i,"video")}:i.hasAudio&&(r=()=>{f.info("[".concat(this._clientId,"] remote user ").concat(i.uid," unpublished audio track")),this.safeEmit(_e.USER_UNPUBLISHED,i,"audio")}),i._video_pre_subscribed||i._audio_pre_subscribed||(i._trust_audio_stream_added_state_=!0,i._trust_video_stream_added_state_=!0,i._audio_added_=!1,i._video_added_=!1,this._p2pChannel instanceof Tl&&this._p2pChannel.unsubscribe(i).then(o=>{if(o)return this._gateway.unsubscribe(o,i.uid)}),i._audioSSRC=void 0,i._videoSSRC=void 0,i._audioOrtc=void 0,i._videoOrtc=void 0,i._rtxSsrcId=void 0),q.onGatewayStream(this._sessionId,xt.ON_REMOVE_STREAM,Qe.ON_REMOVE_STREAM,{peer:n.uint_id||n.uid}),r()},this._handleSetStreamLocalEnable=(n,i,r)=>{if(A("BLOCK_LOCAL_CLIENT")&&Go(i,this.channelName))return;const o=this._users.find(c=>c.uid===i);if(!o)return void f.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));f.debug("[".concat(this._clientId,"] local ").concat(n," ").concat(r?"enabled":"disabled"," with uid ").concat(i));const s=n==="audio"?o.hasAudio:o.hasVideo;if(n==="audio"){o._trust_audio_enabled_state_=!0;const c=o._audio_enabled_;if(o._audio_enabled_=r,o._audio_enabled_===c)return;{const d=o._audio_enabled_?"enable-local-audio":"disable-local-audio";f.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(i,", msg: ").concat(d)),this.safeEmit(_e.USER_INFO_UPDATED,i,d)}}else{o._trust_video_enabled_state_=!0;const c=o._video_enabled_;if(o._video_enabled_=r,o._video_enabled_===c)return;{const d=o._video_enabled_?"enable-local-video":"disable-local-video";f.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(i,", msg: ").concat(d)),this.safeEmit(_e.USER_INFO_UPDATED,i,d)}}const a=n==="audio"?o.hasAudio:o.hasVideo;return s!==a?!s&&a?(f.info("[".concat(this._clientId,"] remote user ").concat(i," published ").concat(n)),void this.safeEmit(_e.USER_PUBLISHED,o,n)):(n==="video"&&o._videoTrack&&o._videoTrack._destroy(),n==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,n),f.info("[".concat(this._clientId,"] remote user ").concat(i," unpublished ").concat(n)),void this.safeEmit(_e.USER_UNPUBLISHED,o,n)):void 0},this._handleMuteStream=(n,i,r)=>{if(A("BLOCK_LOCAL_CLIENT")&&Go(n,this.channelName))return;f.debug("[".concat(this._clientId,"] receive mute message"),n,i,r);const o=this._users.find(c=>c.uid===n);if(!o)return void f.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(n));const s=i==="audio"?o.hasAudio:o.hasVideo;if(i==="audio"){o._trust_audio_mute_state_=!0;const c=o._audio_muted_;if(o._audio_muted_=r,o._audio_muted_===c)return;{const d=o._audio_muted_?"mute-audio":"unmute-audio";f.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(d)),this.safeEmit(_e.USER_INFO_UPDATED,n,d)}}else{o._trust_video_mute_state_=!0;const c=o._video_muted_;if(o._video_muted_=r,o._video_muted_===c)return;{const d=o._video_muted_?"mute-video":"unmute-video";f.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(n,", msg: ").concat(d)),this.safeEmit(_e.USER_INFO_UPDATED,n,d)}}const a=i==="audio"?o.hasAudio:o.hasVideo;if(s!==a){if(!s&&a)return(i==="audio"?o._audioSSRC:o._videoSSRC)?(f.info("[".concat(this._clientId,"] remote user ").concat(n," published ").concat(i)),void this.safeEmit(_e.USER_PUBLISHED,o,i)):void f.warning("[".concat(this._clientId,"] remote user ").concat(n," receive ").concat(i," unmute message  before add stream message, ").concat(i," SSRC doesn't exist yet."));i==="video"&&o._videoTrack&&!o._video_pre_subscribed&&o._videoTrack._destroy(),i==="audio"&&o._audioTrack,this._p2pChannel.muteRemote(o,i),f.info("[".concat(this._clientId,"] remote user ").concat(n," unpublished ").concat(i)),this.safeEmit(_e.USER_UNPUBLISHED,o,i)}},this._handleP2PLost=async n=>{f.debug("[".concat(this._clientId,"] receive p2p lost"),n),parseInt(n.p2pid,10)===this.store.p2pId?await this._p2pChannel.requestReconnect():f.warning("[".concat(this._clientId,"] P2PLost stream not found"),n)},this._handleTokenWillExpire=()=>{f.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(_e.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)},this._handleBeforeUnload=n=>{n.type==="beforeunload"&&n.returnValue!==void 0&&n.returnValue!==""||(this.leave(),f.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))},this._handleUpdateNetworkQuality=()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(_e.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});const n={downlinkNetworkQuality:0,uplinkNetworkQuality:0};n.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),n.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(_e.NETWORK_QUALITY,n)},this._handleP2PAddAudioOrVideoStream=(n,i,r,o)=>{const s=this._users.find(c=>c.uid===i);if(!s)return void f.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));f.debug("[".concat(this._clientId,"] stream added with uid ").concat(i,", type ").concat(n)),this.store.subscribe(s.uid,n,void 0,void 0,void 0,Date.now());const a=n==="audio"?s.hasAudio:s.hasVideo;n==="audio"?s._trust_audio_stream_added_state_=!0:s._trust_video_stream_added_state_=!0,n==="audio"?(s._audio_added_=!0,r!==void 0&&(s._audioSSRC=r),o!==void 0&&(s._audioMid=o)):(s._video_added_=!0,r!==void 0&&(s._videoSSRC=r),o!==void 0&&(s._videoMid=o)),(n==="audio"?s.hasAudio:s.hasVideo)&&!a&&(f.info("[".concat(this._clientId,"] remote user ").concat(s.uid," published ").concat(n)),this.safeEmit(_e.USER_PUBLISHED,s,n)),this._p2pChannel.hasPendingRemoteMedia(s,n)&&(f.debug("[".concat(this._clientId,"] resubscribe ").concat(n," for user ").concat(s.uid," after reconnect.")),this._subscribe(s,n,!0).catch(c=>{f.error("[".concat(this._clientId,"] resubscribe error"),c.toString())}))},this._config=e,this._clientId=et(5,"client-"),this.store=new OP(e.codec,e.audioCodec,e.mode,this._clientId),this.store.clientCreated(),e.proxyServer&&this.setProxyServer(e.proxyServer,!0),e.turnServer&&this.setTurnServer(e.turnServer,!0),f.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(fi," build: ").concat(BA,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),e.clientRoleOptions)try{Jg(e.clientRoleOptions),t=Object.assign({},e.clientRoleOptions)}catch(n){f.warning("[".concat(this._clientId,"] ").concat(n.toString()))}this._statsCollector=new Cd(this.store),this._statsCollector.onStatsException=(n,i,r)=>{f.debug("[".concat(this._clientId,"] receive exception msg, code: ").concat(n,", msg: ").concat(i,", uid: ").concat(r)),this.safeEmit(_e.EXCEPTION,{code:n,msg:i,uid:r})},this._statsCollector.onUploadPublishDuration=(n,i,r,o)=>{const s=this._users.find(a=>a.uid===n);s&&q.peerPublishStatus(this._sessionId,{subscribeElapse:o,audioPublishDuration:i,videoPublishDuration:r,peer:s._uintid})},this.store.useDataChannel=ge().supportDataChannel&&A("SIGNAL_CHANNEL"),this.store.useP2P=e.mode==="p2p",this._gateway=new IM(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:e.websocketRetryConfig||_t,httpRetryConfig:e.httpRetryConfig||_t,forceWaitGatewayResponse:e.forceWaitGatewayResponse===void 0||e.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:e.role,clientRoleOptions:t}),this._configDistribute=new kM,this.store.useP2P?(this._p2pChannel=new Vn(this.store,this._statsCollector),this._handleP2PEvents()):this._p2pChannel=new Tl(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}async joinMeta(e,t,n,i,r){let o=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],s=arguments.length>6&&arguments[6]!==void 0&&arguments[6];Fe("JOIN_GATEWAY_USE_443PORT_ONLY",o),Fe("JOIN_GATEWAY_USE_DUAL_DOMAIN",s);const a=this._gateway.signal.websocket;return a instanceof fd&&(a.use443PortOnly=o,a.tryDoubleDomain=s),qD("client.join",A("JOIN_MAX_CONCURRENCY"),this.join.bind(this),e,t,n,i,r)}async join(e,t,n,i,r){const o=++this._numberOfJoinCount;this.store.joinStart(),i&&(this.store.uid=i);const s=AP(),a=nS()?window.isSecureContext:"Browser Not Support";if(!nS()&&!s||!window.isSecureContext){const m="The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser";f.warning(m)}this.connectionState==="DISCONNECTED"&&(this.store.avoidJoinStart=Math.round(Date.now()),f.debug("[".concat(this._clientId,"] set avoidJoinStart to ").concat(this.store.avoidJoinStart))),q.setAppId(e);try{if(!n&&n!==null)throw new N(C.INVALID_PARAMS,"Invalid token: ".concat(n,". If you don not use token, set it to null"));n&&jt(n,"token",1,2047),jt(e,"appid",1,2047),Sh(t),i&&Th(i),r&&jt(r,"optionalInfo",1,2047)}catch(m){throw q.reportApiInvoke(kc(),{name:an.JOIN,options:[e,t,n,i],states:{isHttps:s,isSecureContext:a},tag:bt.TRACER}).onError(m),m}const c=await gC({appId:e,cname:t,uid:i,stringUid:typeof i=="string"?i:void 0,token:n||e,cloudProxyServer:this._cloudProxyServerMode}),d=(c==null?void 0:c.sid)||kc(),l=q.reportApiInvoke(d,{name:an.JOIN,options:[e,t,n,i],states:{isHttps:s,isSecureContext:a},tag:bt.TRACER});if(f.info("[".concat(this._clientId,"] start join channel ").concat(t,", join number: ").concat(o)),this._leaveMutex.isLocked&&(f.debug("[".concat(this._clientId,"] join: waiting leave operation")),(await this._leaveMutex.lock())(),f.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){const m=new N(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw l.onError(m),m}this._sessionId||(this._sessionId=d,this.store.sessionId=this._sessionId),this._gateway.state="CONNECTING";const u=F(F({},this._rtmConfig),{},{clientId:this._clientId,appId:e,sid:this._sessionId,cname:t,uid:typeof i!="string"?i:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:n||e,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!c},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType});if(this._useLocalAccessPoint&&(u.setLocalAPVersion=this._setLocalAPVersion),typeof i=="string"&&(u.stringUid=i,this._uintUid?(u.uid=this._uintUid,this._uintUid=void 0):u.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(u.aesmode=this._encryptionMode,u.aespassword=await dP(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new N(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(u.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){const m=new TextEncoder,E=A("USE_PURE_ENCRYPTION_MASTER_KEY")?m.encode(u.appId+this._encryptionSecret+this._encryptionSecret):m.encode(u.appId+u.cname+this._encryptionSecret);this._encryptDataStreamIv=await kP(this._encryptionMode,E,ns(this._encryptionSalt)),this._encryptDataStreamKey=await MP(this._encryptionMode,E,ns(this._encryptionSalt))}else a?f.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):f.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,f.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:t,appId:e,stringUid:u.stringUid,preload:u.preload});const h=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&h===this._sessionId&&q.joinChannelTimeout(this._sessionId,5)},5e3);try{let m;const E=u.cloudProxyServer;if(["proxy3","proxy4","proxy5"].includes(E)){const y=A("PROXY_SERVER_TYPE3");Array.isArray(y)?u.proxyServer=y[0]:u.proxyServer=y}if(q.setProxyServer(u.proxyServer),f.setProxyServer(u.proxyServer),this.store.requestAPStart(),c){if(f.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(u.stringUid?", ".concat(u.stringUid," => ").concat(c.intUid):""," ")),u.stringUid&&!u.uid&&(u.uid=c.intUid),m={gatewayInfo:c.ap.gatewayInfo},A("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&u.turnServer.mode==="auto")if(c.ap.proxyInfo.addresses.length===0)f.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{const y=(await iw(c.ap.proxyInfo,c.ap.gatewayInfo.uid)).map(w=>({turnServerURL:w.address,tcpport:w.tcpport||Jt.tcpport,udpport:w.udpport||Jt.udpport,username:w.username||Jt.username,password:w.password||Jt.password,forceturn:!1,security:!0}));u.turnServer={mode:"manual",servers:y}}SC(c,u.stringUid)}else{if(u.stringUid&&!u.uid){let y;[y,m]=await Promise.all([cw(u.stringUid,u,this._axiosCancelSource.token,this._config.httpRetryConfig||_t,this.store),MR(u,this._axiosCancelSource.token,this._config.httpRetryConfig||_t,!0,this.store)]),f.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(u.stringUid," => ").concat(y)),u.uid=y,m.gatewayInfo.uid=y,m.gatewayInfo.res.uid=y}else m=await MR(u,this._axiosCancelSource.token,this._config.httpRetryConfig||_t,!0,this.store);if(!this._joinAndNotLeaveYet)throw new N(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(u,this._axiosCancelSource.token),this._configDistribute.on(Af.UPDATE_BITRATE_LIMIT,y=>{this._p2pChannel.updateBitrateLimit(y)})},0),this._key=n||e;const g=m.gatewayInfo,S=u.uid?u.uid:g.uid;this._joinInfo=F(F({},u),{},{cid:g.cid,uid:S,vid:g.vid,apResponse:g.res,uni_lbs_ip:g.uni_lbs_ip,gatewayAddrs:g.gatewayAddrs}),this.store.intUid=S;const T=await this._joinGateway();if(!this._joinAndNotLeaveYet)throw new N(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));l.onSuccess(T),this._appId=e,this._channelName=u.cname,this._uid=T,this.store.uid=T,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Gt()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);const I=u.stringUid?"string uid: ".concat(u.stringUid,",uid: ").concat(u.uid):"uid: ".concat(this._uid);return f.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(t,",").concat(I)),setTimeout(()=>{f.startUpload()},5e3),this.store.joinEnd(),p=this,as.includes(p)||as.push(p),this._cloudProxyServerMode==="disabled"&&ge().supportWebCrypto&&A("ENABLE_PRELOAD")&&dm(this._joinInfo),T}catch(m){const E=Array.isArray(m)?m[0]:m;throw E&&E.code===C.OPERATION_ABORTED?f.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),E):f.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),E),E.code!==C.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),l.onError(E),E}var p}_joinGateway(){if(!this._joinInfo||!this._key)throw new N(C.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!A("JOIN_WITH_FALLBACK_SIGNAL_PROXY"))).then(e=>e).catch(e=>{if(e.code===C.INIT_WEBSOCKET_TIMEOUT)return this._gateway.leave(!0,fe.FALLBACK),e;if(e.code===C.INIT_DATACHANNEL_TIMEOUT)return this._gateway.leave(!0,fe.FALLBACK),e;throw e}).then(e=>{if(e instanceof N){if(e.code===C.INIT_WEBSOCKET_TIMEOUT){if(f.info("[".concat(this._clientId,"] join timeout, fallback to proxy")),!this._joinInfo||!this._key)throw new N(C.INVALID_OPERATION);this._joinInfo.cloudProxyServer="fallback",this._cloudProxyServerMode="fallback",this.store.cloudProxyServerMode="fallback";const t=A("PROXY_SERVER_TYPE3");if(Array.isArray(t))if(this._joinInfo.apUrl){const i=/^https?:\/\/(.+?)(\/.*)?$/.exec(this._joinInfo.apUrl)[1].split("."),r=i.slice(i.length-2).join(".");t.forEach(o=>{this._joinInfo&&o.includes(r)&&(this._joinInfo.proxyServer=o)}),this._joinInfo.proxyServer||(this._joinInfo.proxyServer=t[0])}else this._joinInfo.proxyServer=t[0];else this._joinInfo.proxyServer=t;const n=A("LOG_UPLOAD_SERVER").match(/.+:(\d{1,5})$/);return n&&n[1]&&n[1]!=="443"&&f.setProxyServer(this._joinInfo.proxyServer),A("STATS_COLLECTOR_PORT").toString()!=="443"&&q.setProxyServer(this._joinInfo.proxyServer),q.reportApiInvoke(this._sessionId,{name:an.JOIN_FALLBACK_TO_PROXY,options:[this._joinInfo.proxyServer],tag:bt.TRACER}).onSuccess(),this.safeEmit(_e.JOIN_FALLBACK_TO_PROXY,this._joinInfo.proxyServer),A("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&this._joinInfo.turnServer.servers.forEach(i=>{"forceturn"in i&&(i.forceturn=!0)}),this._gateway.join(this._joinInfo,this._key)}if(f.info("[".concat(this._clientId,"] join by datachannel timeout, fallback to websocket")),!this._joinInfo||!this._key)throw new N(C.INVALID_OPERATION);return q.reportApiInvoke(this._sessionId,{name:an.DATACHANNEL_FAILBACK,options:[this.store.clientId],tag:bt.TRACER}).onSuccess(),this._joinGateway()}return e}).then(e=>e)}async leave(){f.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Gt()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(t){const n=as.indexOf(t);n!==-1&&as.splice(n,1)}(this),this._statsCollector.stopUpdateStats();const e=await this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return f.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void e();await this._gateway.leave(this.connectionState!=="CONNECTED"),f.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),e()}async publish(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(e)){if(!(e instanceof ia))return this._publishDataChannel(e);e=[e]}if(e.length===0)throw new N(C.INVALID_PARAMS,"param list is empty");const n=e;if(this._gateway.role==="audience")throw new N(C.INVALID_OPERATION,"audience can not publish stream");for(const r of n){if(!(r instanceof ia))throw new N(C.INVALID_PARAMS,"parameter is not local track");if(!r._enabled&&t)throw new N(C.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(r.getTrackId()))}f.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))));const i=await this._publishMutex.lock();await this._configDistribute.awaitConfigDistributeComplete(),t&&n.forEach(r=>{const o=this._configDistribute.getBitrateLimit();r instanceof Ge&&o&&r.setBitrateLimit(o.uplink)});try{await this._publishHighStream(n),f.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map(r=>"".concat(r.getTrackId()," "))))}catch(r){throw f.error("[".concat(this._clientId,"] publish error"),r.toString()),r}finally{i()}}async _publishDataChannel(e){De(e.id,"id",0,65535,!0),Fr(e.ordered,"ordered"),jt(e.metadata,"metadata",0,512),f.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(e.id));const t=await this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(i=>i.id===e.id)!==-1)throw new N(C.INVALID_PARAMS,"Invalid id: ".concat(e.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new N(C.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&A("FORCE_TURN")&&!A("TURN_ENABLE_TCP")&&!A("TURN_ENABLE_UDP"))throw new N(C.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");const n=new RR(e);if(await this._p2pChannel.publishDataChannel([n]),!this._p2pChannel.isP2PDisconnected()){if(typeof n._originDataChannelId!="number")throw f.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new N(C.CREATE_DATACHANNEL_ERROR);try{const i={streamId:e.id,ordered:e.ordered,maxRetransmits:A("DATASTREAM_MAX_RETRANSMITS"),metadata:e.metadata,channelId:n._originDataChannelId};await this._gateway.publishDataChannel(this._uid,i,!0),await n._waitTillOpen()}catch(i){if(i.code!==C.DISCONNECT_P2P)throw i}}return f.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(n.id)),n}catch(n){throw f.error("[".concat(this._clientId,"] publish datachannels error"),n.toString()),n}finally{t()}}async unpublish(e){if(!this._joinInfo||this._uid===void 0)throw new N(C.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let t=[];if(e)if(Array.isArray(e))t=e;else{if(!(e instanceof ia))return this._unpublishDataChannel([e]);t=[e]}else this.store.useP2P||await this._unpublishDataChannel(),t=this._p2pChannel.getAllTracks(!0);f.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(t.map(i=>"".concat(i.getTrackId()," "))," "));const n=await this._publishMutex.lock();try{if(this._p2pChannel instanceof Vn){const i=await this._p2pChannel.unpublish(t);i&&await this._gateway.sendExtensionMessage(at.UNPUBLISH,{unpubMsg:i},!0)}else{const i=await this._p2pChannel.unpublish(t);i&&await this._gateway.unpublish(i,this._uid),f.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(t.map(r=>"".concat(r.getTrackId()))))}}catch(i){throw f.error("[".concat(this._clientId,"] unpublish error"),i.toString()),i}finally{n&&n()}}async _unpublishDataChannel(e){e!==void 0&&e.length!==0||(e=this._p2pChannel.getAllDataChannels()),f.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(e.map(n=>"".concat(n.id," "))," "));const t=await this._publishMutex.lock();try{const n=await this._p2pChannel.unpublishDataChannel(e);n&&await this._gateway.unpublishDataChannel(n),f.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(e.map(i=>"".concat(i.id))))}catch(n){throw f.error("[".concat(this._clientId,"] unpublish dataChannel error"),n.toString()),n}finally{t&&t()}}async subscribe(e,t,n){if(!(e instanceof ho)){const i=this.remoteUsers.find(r=>r.uid===e);if(!i)throw new N(C.INVALID_REMOTE_USER,"user is not in the channel");e=i}return t==="datachannel"?this._subscribeDataChannel(e,n):this._subscribe(e,t)}async presubscribe(e,t){if(Xt(t,"mediaType",["audio","video"]),this._p2pChannel instanceof Vn)throw new N(C.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new N(C.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));const n=t===z.AUDIO,i=t===z.VIDEO,r=await this._subscribeMutex.lock();try{const{ssrcId:o,ortc:s,rtxSsrcId:a,cname:c,uint_id:d}=await this._gateway.presubscribe(e,t,!0);if(o==null)throw new N(C.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find(h=>h.uid===e);l||(l=new ho(e,d||e),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||e),n&&(l._audioSSRC=o,l._audio_pre_subscribed=!0,s&&(l._audioOrtc=s)),i&&(l._videoSSRC=o,l._video_pre_subscribed=!0,s&&(l._videoOrtc=s),a!=null&&(l._rtxSsrcId=a)),f.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),await this._p2pChannel.subscribe(l,t,o,a,s);const u=n?l._audioTrack:l._videoTrack;if(!u)throw new N(C.UNEXPECTED_ERROR,"can not find remote track in user");return n&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),i&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),u}catch(o){throw f.error("[".concat(this._clientId,"] presub user ").concat(e," error"),o),o}finally{r()}}async _subscribeDataChannel(e,t){var n;if(De(t,"channelId",0,65535,!0),!this._joinInfo)throw new N(C.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(s=>s===e))throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),new N(C.INVALID_REMOTE_USER,"user is not in the channel");if(!e.hasAudio&&!e.hasVideo&&e._dataChannels.length===0)throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),new N(C.INVALID_REMOTE_USER,"user is not published");const i=(n=e._dataChannels)===null||n===void 0?void 0:n.find(s=>s.id===t);if(!i)throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, remote datachannel is not published")),new N(C.REMOTE_USER_IS_NOT_PUBLISHED);const r=await this._subscribeMutex.lock();f.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: datachannel"));try{const s=await this._p2pChannel.subscribeDataChannel(e,[i]);if(s&&s.includes(i.id))try{var o;if(typeof i._originDataChannelId!="number")throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType datachannel, cannot get RTCDatachannel")),new N(C.CREATE_DATACHANNEL_ERROR);const a={id:i.id,datachannelId:i._originDataChannelId,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:(o=i.metadata)!==null&&o!==void 0?o:""};await this._gateway.subscribeDataChannel(e.uid,a,!0),await i._waitTillOpen()}catch(a){if((a==null?void 0:a.code)!==C.WS_ABORT)throw await this._p2pChannel.unsubscribeDataChannel(e,[i]),a;await this._p2pChannel.unsubscribeDataChannel(e,[i]),this._p2pChannel.setPendingRemoteDataChannel(e,i.id)}return f.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: datachannel")),i}finally{r()}}async _p2pSubscribe(e,t,n){if(Xt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new N(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(r=>r===e)){const r=new N(C.INVALID_REMOTE_USER,"user is not in the channel");throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),r}if(!e.hasAudio&&!e.hasVideo){const r=new N(C.INVALID_REMOTE_USER,"user is not published");throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),r}if(!n&&(t==="audio"&&!e.hasAudio||t==="video"&&!e.hasVideo)){const r=new N(C.REMOTE_USER_IS_NOT_PUBLISHED);throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),r}const i=await this._subscribeMutex.lock();f.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const o=t==="audio"?e._audioSSRC:e._videoSSRC,s=t==="audio"?e._audioMid:e._videoMid;this.store.subscribe(e.uid,t,Date.now()),this._p2pChannel instanceof Vn&&await this._p2pChannel.subscribe(e,t,o,s)}catch(o){throw o}f.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(o=>{f.warning("[".concat(this._clientId,"] auto set fallback failed"),o)});const r=t==="audio"?e._audioTrack:e._videoTrack;if(!r)throw new N(C.UNEXPECTED_ERROR,"can not find remote track in user object");return r}catch(r){throw f.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),r),r}finally{i()}}async _subscribe(e,t,n){if(this._p2pChannel instanceof Vn)return this._p2pSubscribe(e,t);if(Xt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new N(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(c=>c===e)){const c=new N(C.INVALID_REMOTE_USER,"user is not in the channel");throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", this user is not in the channel")),c}if(!e.hasAudio&&!e.hasVideo){const c=new N(C.INVALID_REMOTE_USER,"user is not published");throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid,", user is not published")),c}if(!(n||(t!=="audio"||e.hasAudio&&e._audioSSRC!==void 0)&&(t!=="video"||e.hasVideo&&e._videoSSRC!==void 0))){const c=new N(C.REMOTE_USER_IS_NOT_PUBLISHED);throw f.error("[".concat(this._clientId,"] can not subscribe ").concat(e.uid," with mediaType ").concat(t,", remote track is not published")),c}let i=t==="audio"?e._audioSSRC:e._videoSSRC,r=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,s={stream_type:t==="audio"?z.AUDIO:z.VIDEO,ssrcId:i};const a=await this._subscribeMutex.lock();f.info("[".concat(this._clientId,"] subscribe user ").concat(e.uid,", mediaType: ").concat(t));try{if(await this._p2pChannel.hasRemoteMediaWithLock(e,t))await this._p2pChannel.unmuteRemote(e,t);else try{const d=t==="audio"?e._audioSSRC:e._videoSSRC;d!==void 0&&d!==i&&(i=d,r=t==="audio"?e._audioOrtc:e._videoOrtc,o=t==="video"?e._rtxSsrcId:void 0,s={stream_type:t==="audio"?z.AUDIO:z.VIDEO,ssrcId:i}),nn.markSubscribeStart(this.store.clientId,i),this.store.subscribe(e.uid,t,Date.now()),await this._p2pChannel.subscribe(e,t,i,o,r);try{await this._gateway.subscribe(e.uid,s,!0)}catch(l){if((l==null?void 0:l.code)!==C.WS_ABORT)throw await this._p2pChannel.unsubscribe(e,t),l;await this._p2pChannel.unsubscribe(e,t,!0),this._p2pChannel.setPendingRemoteMedia(e,t)}this.store.subscribe(e.uid,t,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,e,t)}catch(d){throw this._p2pChannel.reportSubscribeEvent(!1,d==null?void 0:d.code,e,t),d}f.info("[".concat(this._clientId,"] subscribe success user ").concat(e.uid,", mediaType: ").concat(t)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(e.uid,this._defaultStreamFallbackType).catch(d=>{f.warning("[".concat(this._clientId,"] auto set fallback failed"),d)});const c=t==="audio"?e._audioTrack:e._videoTrack;if(!c)throw new N(C.UNEXPECTED_ERROR,"can not find remote track in user object");return c}catch(c){throw f.error("[".concat(this._clientId,"] subscribe user ").concat(e.uid," error"),c),c}finally{a()}}async massSubscribe(e){if(Mr(e,"subscribeList"),!this._joinInfo)throw new N(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));const t=Date.now(),n=new Map,i=await this._subscribeMutex.lock();f.info("[".concat(this._clientId,"]start massSubscribe user ").concat(e.map(s=>{let{user:a,mediaType:c}=s;return"user: ".concat(a==null?void 0:a.uid,", mediaType: ").concat(c)}).join("; ")));const r=(e=[...e]).map(s=>{let{user:a,mediaType:c}=s;return{user:a,mediaType:c}}),o=await this._p2pChannel.globalLock();try{for(let a=e.length-1;a>=0;a--){const c=e[a],{user:d,mediaType:l}=c;if(Xt(l,"mediaType",["audio","video"]),!d){const p=new N(C.INVALID_PARAMS,"user property does not exist in subscribeList item");throw f.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),p}if(!this._users.find(p=>p===d)){const p=new N(C.INVALID_REMOTE_USER,"user is not in the channel");f.error("[".concat(this._clientId,"] can not massSubscribe ").concat(d.uid,", this user is not in the channel")),r[a].error=p,e.splice(a,1);continue}if(l==="audio"&&(!d.hasAudio||d._audioSSRC===void 0)||l==="video"&&(!d.hasVideo||d._videoSSRC===void 0)){const p=new N(C.REMOTE_USER_IS_NOT_PUBLISHED);f.error("[".concat(this._clientId,"] can not subscribe ").concat(d.uid," with mediaType ").concat(l,", remote user is not published")),r[a].error=p,e.splice(a,1);continue}const u=Nt.Video|Nt.LwoVideo,h=n.get(d);if(h){if(l==="video"?h&u:h&Nt.Audio){e.splice(a,1),f.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(d.uid,", mediaType:").concat(l," twice"));continue}n.set(d,h|(l==="video"?u:Nt.Audio))}else n.set(d,l==="video"?u:Nt.Audio)}for(let a=e.length-1;a>=0;a--){const c=e[a],{user:d,mediaType:l}=c,u=Nt.Video|Nt.LwoVideo;if(this._p2pChannel.hasRemoteMedia(d,l)){await this._p2pChannel.unmuteRemoteNoLock(d,l);const h=n.get(d);n.set(d,l==="video"?h^u:h^Nt.Audio),e.splice(a,1)}}this.store.massSubscribe(e.map(a=>({userId:a.user.uid,type:a.mediaType})),t);const s=Array.from(n.entries()).reduce((a,c)=>{let[d,l]=c;if(l===0)return a;const u={stream_id:d.uid,stream_type:l};return l&Nt.Audio&&(u.audio_ssrc=d._audioSSRC),l&Nt.Video&&(u.video_ssrc=d._videoSSRC),a.push(u),a},[]);try{e.length>0&&await this._p2pChannel.massSubscribeNoLock(e.map(c=>{let{user:d,mediaType:l}=c;return{user:d,mediaType:l,ssrcId:l===z.VIDEO?d._videoSSRC:d._audioSSRC,rtxSsrcId:l===z.VIDEO?d._rtxSsrcId:void 0}}));const a=new Map;if(s.length>0){const c=await this._gateway.subscribeAll(s,!0);((c==null?void 0:c.users)||[]).forEach(d=>{let{stream_id:l,video_error_code:u,audio_error_code:h,error_code:p}=d;(u||h||p)&&a.set(l,{video_error_code:u,audio_error_code:h,error_code:p})})}if(Array.from(a.entries()).length>0){const c=[];Array.from(a.entries()).forEach(d=>{let[l,u]=d;const h=this.remoteUsers.find(p=>p.uid===l);if(h){let p;u.error_code||u.video_error_code&&u.audio_error_code?p=void 0:u.video_error_code?p=z.VIDEO:u.audio_error_code&&(p=z.AUDIO),c.push({user:h,mediaType:p})}}),c.length>0&&await this._p2pChannel.massUnsubscribeNoLock(c)}for(const c of r){const d=a.get(c.user.uid);if(d){const l=d.error_code||c.mediaType==="audio"&&d.audio_error_code||c.mediaType==="video"&&d.video_error_code;if(l){const u=vs(l);f.error("user:".concat(c.user.uid," mediaType:").concat(c.mediaType," has massSubscribe error ").concat(u.desc)),c.error=new N(C.SUBSCRIBE_FAILED,"code ".concat(l,": ").concat(u.desc))}}c.error||(c.mediaType==="video"?c.track=c.user.videoTrack:c.track=c.user.audioTrack)}return this.store.massSubscribe(r.filter(c=>!c.error).map(c=>({userId:c.user.uid,type:c.mediaType})),void 0,Date.now()),r.forEach(c=>{var d;q.subscribe(this.store.sessionId,{succ:!!c.error,ec:((d=c.error)===null||d===void 0?void 0:d.code)||null,video:c.mediaType===z.VIDEO,audio:c.mediaType===z.AUDIO,peerid:c.user.uid,subscribeRequestid:c.mediaType===z.VIDEO?c.user._videoSSRC:c.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-t)},!0)}),f.info("[".concat(this._clientId,"] massSubscribe success ").concat(e.map(c=>{let{user:d,mediaType:l}=c;return"user: ".concat(d==null?void 0:d.uid,", mediaType: ").concat(l)}).join("; "))),r}catch(a){throw await this._p2pChannel.massUnsubscribeNoLock(e),a}}finally{o(),i()}}async unsubscribe(e,t,n){if(!(e instanceof ho)){const r=this.remoteUsers.find(o=>o.uid===e);if(!r)throw new N(C.INVALID_REMOTE_USER,"user is not in the channel");e=r}if(t||this.store.useP2P){if(t==="datachannel")return this._unsubscribeDataChannel(e,n)}else await this._unsubscribeDataChannel(e,n);if(t&&Xt(t,"mediaType",["audio","video"]),!this._joinInfo)throw new N(C.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(r=>r===e)){const r=new N(C.INVALID_REMOTE_USER,"user is not in the channel");throw f.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),r}f.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: ").concat(t));const i=await this._subscribeMutex.lock();try{if(this._p2pChannel instanceof Vn)await this._p2pChannel.unsubscribe(e,t);else{const r=await this._p2pChannel.unsubscribe(e,t);r&&await this._gateway.unsubscribe(r,e.uid),t&&t!=="audio"||(e._audio_pre_subscribed=!1),t&&t!=="video"||(e._video_pre_subscribed=!1),e._is_pre_created&&Ou(this._users,e),f.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(e.uid,", mediaType: ").concat(t))}}catch(r){if(r.code===C.DISCONNECT_P2P)return void f.warning("disconnecting p2p, abort unsubscribe request.");throw f.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),r.toString()),r}finally{i()}}async _unsubscribeDataChannel(e,t){if(t&&De(t,"id",0,65535,!0),!this._joinInfo)throw new N(C.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(i=>i===e)){const i=new N(C.INVALID_REMOTE_USER,"user is not in the channel");throw f.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid,", user is not in the channel")),i}let n;if(typeof t=="number"){const i=e._dataChannels.find(r=>r.id===t);i&&(n=[i])}else n=e._dataChannels;if(n===void 0){const i=new N(C.REMOTE_USER_IS_NOT_PUBLISHED);throw f.error("[".concat(this._clientId,"] can not unsubscribe ").concat(e.uid," with channelId ").concat(t,", remote datachannel is not published")),i}f.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(n.map(i=>i.id)));try{const i=await this._p2pChannel.unsubscribeDataChannel(e,n);i&&await this._gateway.unsubscribeDataChannel(i,e.uid),f.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(e.uid,", mediaType: datachannel, ids: ").concat(i))}catch(i){if(i.code===C.DISCONNECT_P2P)return void f.warning("disconnecting p2p, abort unsubscribe request.");throw f.error("[".concat(this._clientId,"] unsubscribe user ").concat(e.uid," error"),i.toString()),i}}async massUnsubscribe(e){if(Mr(e,"unsubscribeList"),!this._joinInfo)throw new N(C.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");f.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(e.map(n=>{let{user:i,mediaType:r}=n;return"user: ".concat(i==null?void 0:i.uid,", mediaType: ").concat(r,";")}).join())),e=[...e];const t=new Map;for(let n=e.length-1;n>=0;n--){const{user:i,mediaType:r}=e[n];if(!i){const s=new N(C.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw f.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),s}if(Xt(r,"mediaType",["video","audio",void 0]),!this._users.find(s=>s===i)){f.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(i.uid,", user is not in the channel")),e.splice(n,1);continue}const o=Nt.Video|Nt.LwoVideo;if(t.has(i)){const s=t.get(i);let a;switch(r){case"video":a=s&o;break;case"audio":a=s&Nt.Audio;break;default:a=s&(Nt.Audio|o)}if(a){f.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(i.uid,",mediaType:").concat(r," twice.")),e.splice(n,1);continue}r?r==="audio"?t.set(i,s|Nt.Audio):r==="video"&&t.set(i,s|o):t.set(i,s|Nt.Audio|o)}else r?r==="audio"?t.set(i,Nt.Audio):r==="video"&&t.set(i,o):t.set(i,Nt.Audio|o)}try{const n=await this._p2pChannel.massUnsubscribe(e);n&&await this._gateway.massUnsubscribe(n),f.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(e.map(i=>{let{user:r,mediaType:o}=i;return"user: ".concat(r==null?void 0:r.uid,", mediaType: ").concat(o,";")}).join()))}catch(n){if(n.code===C.DISCONNECT_P2P)return void f.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw f.error("[".concat(this._clientId,"] massUnsubscribe error"),n.toString()),n}}async setLowStreamParameter(e){D1(e),(!e.width&&e.height||e.width&&!e.height)&&f.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),f.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(e));const t=this._configDistribute.getLowStreamConfigDistribute();if(t&&t.bitrate&&e.bitrate&&t.bitrate<e.bitrate&&(e.bitrate=t.bitrate),this._lowStreamParameter=e,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(e,M.LocalVideoLowTrack)}async enableDualStream(){if(!ge().supportDualStream)throw q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new N(C.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new N(C.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{await this._publishLowStream()}catch(e){throw q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),e}this._isDualStreamEnabled=!0,q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),f.info("[".concat(this._clientId,"] enable dual stream"))}async disableDualStream(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new N(C.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(M.LocalVideoLowTrack))try{const e=await this._p2pChannel.unpublishLowStream();e&&await this._gateway.unpublish(e,this._joinInfo.stringUid||this._joinInfo.uid)}catch(e){throw q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),e}this._isDualStreamEnabled=!1,q.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),f.info("[".concat(this._clientId,"] disable dual stream"))}}async setClientRole(e,t){if(_P(e),t&&Jg(t),this.mode==="rtc"||this.mode==="p2p")throw f.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new N(C.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(t&&t.level&&e==="host")throw new N(C.INVALID_OPERATION,"host mode can not set audience latency level");if(e==="audience"&&this._p2pChannel.hasLocalMedia())throw new N(C.INVALID_OPERATION,"can not set client role to audience when publishing stream");await this._gateway.setClientRole(e,t),this._config.role=e,f.info("[".concat(this._clientId,"] set client role to ").concat(e,", level: ").concat(t&&t.level))}getRemoteInboundOffset(){var e;const t=(e=this._p2pChannel.getStats())===null||e===void 0?void 0:e.audioSend[0];if(!t||!t.timestamp)return 0;const n=t.timestamp-Date.now();return Math.abs(n)>1e3+t.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?n:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(e,t){if(jt(e,"proxyServer"),!t){if(this.connectionState!=="DISCONNECTED")throw new N(C.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new N(C.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=e,q.setProxyServer(this._proxyServer),f.setProxyServer(this._proxyServer),f.info("[".concat(this._clientId,"] Set proxy server ").concat(t?"by initialize call":""," success."))}setTurnServer(e,t){if(Array.isArray(e)||(e=[e]),!t){if(this.connectionState!=="DISCONNECTED")throw new N(C.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new N(C.INVALID_OPERATION,"You have already set the proxy")}if(Ba(e))return this._turnServer={servers:e,mode:"original-manual"},void f.info("[".concat(this._clientId,"] Set original turnserver ").concat(t?"by initialize call":""," success: ").concat(e.map(n=>n.urls).join(","),"."));e.forEach(n=>MA(n)),this._turnServer={servers:e,mode:"manual"},f.info("[".concat(this._clientId,"] Set turnserver ").concat(t?"by initialize call":""," success."))}setLicense(e){if(this.connectionState!=="DISCONNECTED")throw new N(C.INVALID_OPERATION,"you should set license before join channel");if(jt(e,"license",32,32),!/^[A-Za-z\d]+$/.test(e))throw new N(C.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=e,f.info("[".concat(this._clientId,"] set license success"),e)}startProxyServer(e){if(this.connectionState!=="DISCONNECTED")throw new N(C.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new N(C.INVALID_OPERATION,"You have already set the proxy");const t=[3,4,5];let n;switch(e===void 0&&(e=3),e){case 1:case 2:throw new N(C.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:n="proxy3";break;case 4:n="proxy4";break;case 5:n="proxy5";break;default:throw new N(C.INVALID_PARAMS,"proxy server mode must be ".concat(t.join("|")))}this._cloudProxyServerMode=n,this.store.cloudProxyServerMode=n,f.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new N(C.INVALID_OPERATION,"Stop proxy server after leave channel");q.setProxyServer(),f.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",f.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(e){if(!e.accessPoints)throw new N(C.INVALID_PARAMS,"accessPoints is required.");Mr(e.accessPoints.serverList,"accessPoints.serverList"),jt(e.accessPoints.domain,"accessPoints.domain");const t=(h,p)=>{De(h,p,0,65535,!0)};let n=443;if(e.accessPoints.port&&(t(e.accessPoints.port,"accessPoints.port"),n=e.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new N(C.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");A("CLOSE_AFB_FOR_LOCAL_AP")&&(Fe("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),Fe("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));const i=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=e.accessPoints.domain,o=e.accessPoints.serverList.map(h=>i.test(h)?"".concat(h.replace(/\./g,"-"),".").concat(r):h),s=o.map(h=>"".concat(h,":").concat(n));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,Fe("WEBCS_DOMAIN",s),Fe("WEBCS_DOMAIN_BACKUP_LIST",s),Fe("GATEWAY_DOMAINS",[r]),e.report&&e.report.hostname&&Array.isArray(e.report.hostname)&&e.report.hostname.length?(Mr(e.report.hostname,"report.hostname"),Fe("EVENT_REPORT_DOMAIN",e.report.hostname[0]),Fe("EVENT_REPORT_BACKUP_DOMAIN",e.report.hostname[1]||e.report.hostname[0])):(Fe("EVENT_REPORT_DOMAIN",o[0]),Fe("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;e.report&&e.report.port&&(t(e.report.port,"report.port"),a=e.report.port),Fe("STATS_COLLECTOR_PORT",a),e.report?Fe("ENABLE_EVENT_REPORT",!0):Fe("ENABLE_EVENT_REPORT",!1);let c="";e.log&&e.log.hostname&&Array.isArray(e.log.hostname)&&e.log.hostname.length?(Mr(e.log.hostname,"log.hostname"),c=e.log.hostname[0]):c=o[0];let d=6444;e.log&&e.log.port&&(t(e.log.port,"log.port"),d=e.log.port),Fe("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];e.cds&&e.cds.hostname&&Array.isArray(e.cds.hostname)&&e.cds.hostname.length?(Mr(e.cds.hostname,"cds.hostname"),l=e.cds.hostname):l=o;let u=443;e.cds&&e.cds.port&&(t(e.cds.port,"cds.port"),u=e.cds.port),Fe("CDS_AP",l.map(h=>"".concat(h,":").concat(u))),e.cds?Fe("ENABLE_CONFIG_DISTRIBUTE",!0):Fe("ENABLE_CONFIG_DISTRIBUTE",!1),f.info("set local access point v2 success")}setLocalAccessPoints(e,t){if(Mr(e,"serverList"),jt(t,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new N(C.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");const n=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;e=e.map(i=>n.test(i)?"".concat(i.replace(/\./g,"-"),".").concat(t):i),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,Fe("WEBCS_DOMAIN",e),Fe("WEBCS_DOMAIN_BACKUP_LIST",e),Fe("GATEWAY_DOMAINS",[t]),Fe("EVENT_REPORT_DOMAIN",e[0]),Fe("EVENT_REPORT_BACKUP_DOMAIN",e[1]||e[0]),Fe("LOG_UPLOAD_SERVER","".concat(e[0],":6444")),f.info("[".concat(this._clientId,"] set local access point success"))}async setRemoteDefaultVideoStreamType(e){if(Xt(e,"streamType",[0,1]),this._remoteDefaultVideoStreamType=e,this._joinInfo)try{await this._gateway.setDefaultRemoteVideoStreamType(e),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(t){throw f.error("[".concat(this._clientId,"] set default remote video stream type error"),t.toString()),t}else f.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(e))}async setRemoteVideoStreamType(e,t){Xt(t,"streamType",[0,1]);try{await this._gateway.setRemoteVideoStreamType(e,t),setTimeout(()=>{const n=this._users.find(i=>i.uid===e);n&&n.videoTrack&&n.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(n){throw f.error("[".concat(this._clientId,"] set remote video stream type error"),n.toString()),n}f.info("[".concat(this._clientId,"] set remote ").concat(e," video stream type to ").concat(t)),this._remoteStreamTypeCacheMap.set(e,t)}async setStreamFallbackOption(e,t){Xt(t,"fallbackType",[0,1,2]);try{await this._gateway.setStreamFallbackOption(e,t)}catch(n){throw f.error("[".concat(this._clientId,"] set stream fallback option"),n.toString()),n}f.info("[".concat(this._clientId,"] set remote ").concat(e," stream fallback type to ").concat(t)),this._streamFallbackTypeCacheMap.set(e,t)}setEncryptionConfig(e,t,n,i){pP(e),jt(t,"secret");const r=["aes-128-gcm2","aes-256-gcm2"];if(r.includes(e)){if(!n||!(n instanceof Uint8Array&&n.length===32))throw new N(C.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(n)throw new N(C.INVALID_PARAMS,"current encrypt mode does not need salt");if(i){if(Fr(i,"encryptDataStream"),!r.includes(e))throw new N(C.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(t)||f.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=e,this._encryptionSecret=t,n&&(this._encryptionSalt=No(n))}async renewToken(e){if(jt(e,"token",1,2047),!this._key||!this._joinInfo)throw new N(C.INVALID_OPERATION,"renewToken should not be called before user join");const t=this._key;this._key=e,this._joinInfo&&(this._joinInfo.token=e);const n=await this._renewTokenMutex.lock();try{if(A("USE_NEW_TOKEN")){f.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));const i=await LM(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||_t);f.debug("[".concat(this._clientId,"] get ticket from unilbs success")),await this._gateway.renewToken({token:e,ticket:i})}else f.debug("[".concat(this._clientId,"] start renew token without ticket")),await this._gateway.renewToken({token:e});f.debug("[".concat(this._clientId,"] renewToken success"))}catch(i){throw this._key=t,this._joinInfo.token=t,f.error("[".concat(this._clientId,"] renewToken failed"),i.toString()),i}finally{n()}}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?f.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{const e=this._p2pChannel.getAudioLevels();this.safeEmit(_e.VOLUME_INDICATOR,e)},A("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){const e=this._statsCollector.getRTCStats(),t=this._gateway.getInChannelInfo();return e.Duration=Math.round(t.duration/1e3),e}async startLiveStreaming(e,t){if(!t){if(this.codec!=="h264")throw new N(C.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new N(C.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(e)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(e))throw new N(C.LIVE_STREAMING_TASK_CONFLICT);const n=t?Vt.TRANSCODE:Vt.RAW;return this._createLiveStreamingClient(n).startLiveStreamingTask(e,n)}setLiveTranscoding(e){return this._createLiveStreamingClient(Vt.TRANSCODE).setTranscodingConfig(e)}async stopLiveStreaming(e){const t=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(n=>n&&n.hasUrl(e));if(!t.length)throw new N(C.INVALID_PARAMS,"can not find live streaming url to stop");await Promise.all(t.map(n=>n&&n.stopLiveStreamingTask(e)))}async addInjectStreamUrl(e,t){if(!this._joinInfo)throw new N(C.INVALID_OPERATION,"can not addInjectStreamUrl, no joininfo");const n=this._createLiveStreamingClient(Vt.INJECT);n.setInjectStreamConfig(t,0),await n.startLiveStreamingTask(e,Vt.INJECT)}async removeInjectStreamUrl(){const e=this._createLiveStreamingClient(Vt.INJECT),t=Array.from(e.streamingTasks.values()).find(n=>n.mode===Vt.INJECT);if(!this._joinInfo||!t)throw new N(C.INVALID_OPERATION,"can remove addInjectStreamUrl, no joininfo or inject task");await e.stopLiveStreamingTask(t.url)}async startChannelMediaRelay(e){oC(e),await this._createChannelMediaRelayClient().startChannelMediaRelay(e)}async updateChannelMediaRelay(e){oC(e),await this._createChannelMediaRelayClient().updateChannelMediaRelay(e)}async stopChannelMediaRelay(){await this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)}async sendStreamMessage(e){let t=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new N(C.INVALID_OPERATION,"can not send data stream, not joined");if((typeof e=="string"||e instanceof Uint8Array)&&(e={payload:e}),typeof e.payload=="string"){const i=new TextEncoder;e.payload=i.encode(e.payload)}let n=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&["aes-128-gcm2","aes-256-gcm2"].includes(this._encryptionMode)&&(n=!0,e.payload=await PP(this._encryptDataStreamIv,this._encryptDataStreamKey,e.payload)),new Blob([e.payload]).size>1024)throw new N(C.INVALID_PARAMS,n?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request($.DATA_STREAM,{payload:No(e.payload),syncWithAudio:e.syncWithAudio,sendTs:Date.now()-pU},!t)}sendMetadata(e){if(!this._joinInfo)throw new N(C.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([e]).size>1024)throw new N(C.METADATA_OUT_OF_RANGE);return this._gateway.signal.request($.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:No(e)})}async sendCustomReportMessage(e){if(Array.isArray(e)||(e=[e]),e.forEach(VP),!this._joinInfo)throw new N(C.INVALID_OPERATION,"can not send custom report, not joined");await q.sendCustomReportMessage(this._joinInfo.sid,e)}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}async pickSVCLayer(e,t){Xt(t.spatialLayer,"spatialLayer",[0,1,2,3]),Xt(t.temporalLayer,"temporalLayer",[0,1,2,3]);try{await this._gateway.pickSVCLayer(e,t)}catch(n){throw f.error("[".concat(this._clientId,"] pick SVC layer failed"),n.toString()),n}}async setRTMConfig(e){const{apRTM:t=!1,rtmFlag:n}=e;if(Fr(t,"apRTM"),De(n,"rtmFlag",0),this._rtmConfig.apRTM=t,this._rtmConfig.rtmFlag=n,f.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(e)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=t,this._joinInfo.rtmFlag=n,this._gateway.setRTM2Flag(n)}_reset(){if(f.debug("[".concat(this._clientId,"] reset client")),this._axiosCancelSource.cancel(),this._axiosCancelSource=Un.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&Ow(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(e=>{e._audioTrack&&e._audioTrack._destroy(),e._videoTrack&&e._videoTrack._destroy(),e._dataChannels&&(e._dataChannels.forEach(t=>t._close()),e._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new Bt("client-publish"),this._subscribeMutex=new Bt("client-subscribe"),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._injectStreamingClient&&(this._injectStreamingClient.terminate(),this._injectStreamingClient.removeAllListeners(),this._injectStreamingClient=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(e,t){var n;const i=e||kc();e?f.debug("[".concat(this._clientId,"] new Session ").concat(i)):f.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(i));const r=e?"":this._sessionId||"";this._sessionId=i,this.store.sessionId=i;const o={lts:new Date().getTime(),mode:this.mode,buildFormat:3,stringUid:(t==null?void 0:t.stringUid)||((n=this._joinInfo)===null||n===void 0?void 0:n.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1};t?q.sessionInit(this._sessionId,F({cname:t.channel,appid:t.appId,preload:t.preload},o)):this._joinInfo?q.sessionInit(this._sessionId,F({cname:this._joinInfo.cname,appid:this._joinInfo.appId,preload:!!this._joinInfo.recoverPreloadCache},o)):this._gateway.joinInfo&&q.sessionInit(this._sessionId,F({cname:this._gateway.joinInfo.cname,appid:this._gateway.joinInfo.appId},o)),this._joinInfo&&(this._joinInfo.sid=i),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=i)}async _publishHighStream(e){if(!this._joinInfo||this._uid===void 0)throw new N(C.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&A("FORCE_TURN")&&!A("TURN_ENABLE_TCP")&&!A("TURN_ENABLE_UDP"))throw new N(C.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");f.debug("[".concat(this._clientId,"] publish high stream"));try{const n=await this._p2pChannel.publish(e,this._isDualStreamEnabled,this._lowStreamParameter);if(this._p2pChannel instanceof Vn){const i=(await n.next()).value;if(i){try{await this._gateway.sendExtensionMessage(at.PUBLISH,i,!0)}catch(r){throw n.throw(r),r}await n.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{const i=(await n.next()).value;if(i){var t;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(o){if(o.code!==C.DISCONNECT_P2P)throw n.throw(o),o}await n.next(((t=r)===null||t===void 0?void 0:t.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(const r of e)r instanceof Ge&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig),!r.muted&&r.enabled||await this._p2pChannel.muteLocalTrack(r)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,e),(n==null?void 0:n.code)===C.WS_ABORT)return;throw n}}async _publishLowStream(){if(!this._joinInfo||this._uid===void 0)throw new N(C.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new N(C.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));f.debug("[".concat(this._clientId,"] publish low stream"));const e=this._configDistribute.getLowStreamConfigDistribute();e&&e.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&e.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=e.bitrate));try{const n=await this._p2pChannel.publishLowStream(this._lowStreamParameter),i=(await n.next()).value;if(i){var t;let r;try{r=await this._gateway.publish(this._uid,i,!0)}catch(o){if(o.code!==C.DISCONNECT_P2P)throw n.throw(o),o}n.next(((t=r)===null||t===void 0?void 0:t.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(n){if(this._p2pChannel.reportPublishEvent(!1,n==null?void 0:n.code,void 0,!0),(n==null?void 0:n.code)===C.WS_ABORT)return;throw n}}_createLiveStreamingClient(e){if(!this._joinInfo||!this._appId)return new N(C.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();const t=()=>new GM(this._joinInfo,this._config.websocketRetryConfig||_t,this._config.httpRetryConfig||_t),n=i=>{i.onLiveStreamError=(r,o)=>{q.reportApiInvoke(this._sessionId,{name:an.ON_LIVE_STREAM_ERROR,options:[r,o],tag:bt.TRACER}).onSuccess(),this.safeEmit(_e.LIVE_STREAMING_ERROR,r,o)},i.onLiveStreamWarning=(r,o)=>{q.reportApiInvoke(this._sessionId,{name:an.ON_LIVE_STREAM_WARNING,options:[r,o],tag:bt.TRACER}).onSuccess(),this.safeEmit(_e.LIVE_STREAMING_WARNING,r,o)},i.on(Mu.REQUEST_WORKER_MANAGER_LIST,(r,o,s)=>{if(!this._joinInfo)return s(new N(C.INVALID_OPERATION,"can not find join info to get worker manager"));VR(r,this._joinInfo,this._axiosCancelSource.token,_t).then(o).catch(s)})};switch(e){case Vt.RAW:return this._liveRawStreamingClient||(this._liveRawStreamingClient=t(),n(this._liveRawStreamingClient)),this._liveRawStreamingClient;case Vt.TRANSCODE:return this._liveTranscodeStreamingClient||(this._liveTranscodeStreamingClient=t(),n(this._liveTranscodeStreamingClient)),this._liveTranscodeStreamingClient;case Vt.INJECT:return this._injectStreamingClient||(this._injectStreamingClient=t(),this._injectStreamingClient.on(Mu.REQUEST_WORKER_MANAGER_LIST,(i,r,o)=>{if(!this._joinInfo)return o(new N(C.INVALID_OPERATION,"can not find join info to get worker manager"));VR(i,this._joinInfo,this._axiosCancelSource.token,_t).then(r).catch(o)}),this._injectStreamingClient.onInjectStatusChange=(i,r,o)=>{this.safeEmit(_e.INJECT_STREAM_STATUS,i,r,o)}),this._injectStreamingClient}}_createChannelMediaRelayClient(){if(!this._joinInfo)return new N(C.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){const{sendResolutionWidth:e,sendResolutionHeight:t}=this.getLocalVideoStats(),n={width:e,height:t};this._channelMediaRelayClient=new HM(this._joinInfo,this._clientId,this._config.websocketRetryConfig||_t,this._config.httpRetryConfig||_t,n),this._channelMediaRelayClient.on("state",i=>{i===xn.RELAY_STATE_FAILURE&&this._channelMediaRelayClient&&this._channelMediaRelayClient.dispose(),this.safeEmit(_e.CHANNEL_MEDIA_RELAY_STATE,i)}),this._channelMediaRelayClient.on("event",i=>{this.safeEmit(_e.CHANNEL_MEDIA_RELAY_EVENT,i)}),this._statsCollector.onStatsChanged=(i,r)=>{var o;i==="resolution"&&((o=this._channelMediaRelayClient)===null||o===void 0||o.setVideoProfile(r))}}return this._channelMediaRelayClient}_handleUpdateDataChannel(e,t){const{added:n,deleted:i}=e;Array.isArray(n)&&n.length>0&&n.forEach(r=>{const{uid:o,stream_id:s,ordered:a,max_retrans_times:c,metadata:d}=r,l=this._users.find(u=>u._uintid===o);if(!l)return void f.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(f.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(o)),l._uintid||(l._uintid=o),l._dataChannels.findIndex(u=>u.id===r.stream_id)===-1){const u={id:s,ordered:!!a,maxRetransmits:c,metadata:d},h=new Q1(u);l._dataChannels.push(h),f.info("[".concat(this._clientId,"] remote user ").concat(l.uid," published datachannel")),t||this.safeEmit(_e.USER_PUBLISHED,l,"datachannel",u)}this._p2pChannel.hasPendingRemoteDataChannel(l,r.stream_id)&&(f.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(l.uid," after reconnect.")),this._subscribeDataChannel(l,r.stream_id).catch(u=>{f.error("[".concat(this._clientId,"] resubscribe datachannel error"),u.toString())}))}),t&&(this.safeEmit(_e.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(i)&&i.length>0&&i.forEach(r=>{const{uid:o,stream_id:s}=r,a=this._users.find(d=>d._uintid===o);if(!a)return void f.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));const c=a._dataChannels.find(d=>d.id===r.stream_id);c&&(f.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(o)),this._p2pChannel.unsubscribeDataChannel(a,[c]).then(d=>{if(a._dataChannels=a._dataChannels.filter(l=>l!==c),d)return this._gateway.unsubscribeDataChannel(d,a.uid)}),f.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished datachannel ,id:").concat(c.id)),this.safeEmit(_e.USER_UNPUBLISHED,a,"datachannel",c._config))})}_handleRemoveDataChannels(e){const t=this._users.find(n=>n.uid===e.uid);if(t){if(t._dataChannels!==void 0&&t._dataChannels.length>0){f.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(e.uid));const n=()=>{f.info("[".concat(this._clientId,"] remote user ").concat(t.uid," unpublished datachannel")),t._dataChannels.forEach(i=>{this.safeEmit(_e.USER_UNPUBLISHED,t,"datachannel",i._config)})};this._p2pChannel.unsubscribeDataChannel(t,t._dataChannels).then(i=>{if(i)return this._gateway.unsubscribeDataChannel(i,t.uid)}),n()}}else f.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(ct.DISCONNECT_P2P,async()=>{await this._p2pChannel.disconnectForReconnect()}),this._gateway.on(ct.CONNECTION_STATE_CHANGE,(e,t,n)=>{var i;if(n===fe.FALLBACK)return;const r=()=>{this.safeEmit(_e.CONNECTION_STATE_CHANGE,e,t,n)};if(q.reportApiInvoke(this._sessionId||((i=this._gateway.joinInfo)===null||i===void 0?void 0:i.sid)||null,{name:an.CONNECTION_STATE_CHANGE,options:[e,t,n],tag:bt.TRACER}).onSuccess(JSON.stringify({cur:e,prev:t,reason:n})),f.info("[".concat(this._clientId,"] connection state change: ").concat(t," -> ").concat(e)),e==="DISCONNECTED")return this._reset(),void r();if(e==="RECONNECTING")this._users.forEach(s=>{s._trust_in_room_=!1,s._trust_audio_enabled_state_=!1,s._trust_video_enabled_state_=!1,s._trust_audio_mute_state_=!1,s._trust_video_mute_state_=!1,s._trust_audio_stream_added_state_=!1,s._trust_video_stream_added_state_=!1,s._is_pre_created||(s._audio_pre_subscribed||(s._audioSSRC=void 0,s._audioOrtc=void 0),s._video_pre_subscribed||(s._videoSSRC=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),s._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(e==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((s,a)=>{this._gateway.setStreamFallbackOption(a,s).catch(c=>{f.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)})}),this._remoteStreamTypeCacheMap.forEach((s,a)=>{this._gateway.setRemoteVideoStreamType(a,s).catch(c=>{f.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)})}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{f.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(s=>{f.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(s))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(s=>!s._trust_in_room_).forEach(s=>{f.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(s.uid)),this._handleUserOffline({uid:s.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(s=>{s._trust_audio_mute_state_||(f.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,z.AUDIO,!1)),s._trust_video_mute_state_||(f.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,z.VIDEO,!1)),s._trust_audio_enabled_state_||(f.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(s.uid)),this._handleSetStreamLocalEnable("audio",s.uid,!0)),s._trust_video_enabled_state_||(f.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(s.uid)),this._handleSetStreamLocalEnable("video",s.uid,!0)),s._trust_video_stream_added_state_||(f.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(s.uid)),this._handleResetAddStream(s,"video")),s._trust_audio_stream_added_state_||(f.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(s.uid)),this._handleResetAddStream(s,"audio")),s._video_added_||s._audio_added_||(f.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(s.uid)),this._handleRemoveStream({uid:s.uid,uint_id:s._uintid}))}))},1e3))}r()}),this._gateway.on(ct.REQUEST_NEW_GATEWAY_LIST,async(e,t)=>{if(!this._joinInfo)return t(new N(C.UNEXPECTED_ERROR,"can not recover, no join info"));try{let n;this._joinInfo.recoverPreloadCache?(n=this._joinInfo.recoverPreloadCache.ap,SC(this._joinInfo.recoverPreloadCache),this._joinInfo.recoverPreloadCache=void 0):n=await Nf(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||_t,this.store),this._joinInfo&&(this._joinInfo.apResponse=n.gatewayInfo.res,this._joinInfo.gatewayAddrs=n.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=n.gatewayInfo.uni_lbs_ip);const i=[];n.gatewayInfo.gatewayAddrs.forEach(r=>{let{address:o}=r;const[s,a]=o.split(":");this._joinInfo&&this._joinInfo.proxyServer?i.push({proxy:this._joinInfo.proxyServer,host:s,port:a}):i.push({host:s,port:a})}),e(i)}catch(n){t(n)}}),this._gateway.on(ct.NETWORK_QUALITY,e=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(_e.NETWORK_QUALITY,e)}),this._gateway.on(ct.STREAM_TYPE_CHANGE,(e,t)=>{this.safeEmit(_e.STREAM_TYPE_CHANGED,e,t),q.reportApiInvoke(this._sessionId,{name:an.STREAM_TYPE_CHANGE,options:[e,t],tag:bt.TRACER}).onSuccess(JSON.stringify({uid:e,streamType:t}))}),this._gateway.on(ct.IS_P2P_DISCONNECTED,e=>{this._p2pChannel.isP2PDisconnected()?e(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?e(!1):e(!0)}),this._gateway.on(ct.NEED_RENEW_SESSION,async e=>{if(e==="recover"&&this._joinInfo){const t=await gC(F(F({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));this._joinInfo.recoverPreloadCache=t,this._startSession(t==null?void 0:t.sid)}else this._startSession()}),this._gateway.on(ct.REQUEST_P2P_CONNECTION_PARAMS,async(e,t,n)=>{try{t(await this._p2pChannel.startP2PConnection(e))}catch(i){n(i)}}),this._gateway.on(ct.JOIN_RESPONSE,(e,t)=>{if(this.store.useP2P)return;const{dtlsParameters:n,iceParameters:i,candidates:r,rtpCapabilities:o,setup:s,cname:a}=jR(e.ortc,t);this._p2pChannel.connect(i,n,r,o,s,a)}),this._gateway.on(ct.REQUEST_DC_CONNECTION_PARAMS,e=>{e(this._p2pChannel.getEstablishParams())}),this._gateway.on(ct.RESET_SIGNAL,e=>{this._p2pChannel.resetConnection(e),this._handleGatewaySignalEvents()}),this._gateway.on(ct.DATACHANNEL_FAILBACK,()=>{this._joinGateway()}),this._gateway.on(ct.DATACHANNEL_PRECONNECT,async(e,t,n,i)=>{var r,o,s,a,c,d;await this._p2pChannel.startP2PConnection({turnServer:(r=this._joinInfo)===null||r===void 0?void 0:r.turnServer},!0);const l=function(u,h){let p;return h&&h.ip&&typeof h.port=="number"?(p=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:h.ip,port:h.port.toString(),type:"host",extension:{}}],f.debug("Using remote candidate from AP ".concat(h.ip,":").concat(h.port)),h.ip6&&(p.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:h.ip6,port:h.port.toString(),type:"host",extension:{}}),f.debug("Using IPV6 remote candidate from AP ".concat(h.ip6,":").concat(h.port)))):p=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:u.ip,port:u.port.toString(),type:"host",extension:{}}],p}(e,t);return this._p2pChannel.preConnect({iceUfrag:"".concat((o=this._joinInfo)===null||o===void 0?void 0:o.apResponse.cid,"_").concat((s=this._joinInfo)===null||s===void 0?void 0:s.apResponse.cert),icePwd:"".concat((a=this._joinInfo)===null||a===void 0?void 0:a.apResponse.cid,"_").concat((c=this._joinInfo)===null||c===void 0?void 0:c.apResponse.cert)},{fingerprints:[{hashFunction:"sha-256",fingerprint:(d=A("FINGERPRINT"))!==null&&d!==void 0?d:e.fingerprint}]},l,{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},"active","o/i14u9pJrxRKAsu").then(n).catch(i)})}_handleGatewaySignalEvents(){this._gateway.signal.on(ie.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(ie.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(ie.ON_ADD_AUDIO_STREAM,e=>this._handleAddAudioOrVideoStream("audio",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc)),this._gateway.signal.on(ie.ON_ADD_VIDEO_STREAM,e=>this._handleAddAudioOrVideoStream("video",e.uid,e.ssrcId,e.cname,e.uint_id,e.ortc,e.rtxSsrcId)),this._gateway.signal.on(ie.ON_REMOTE_DATASTREAM_UPDATE,e=>{this._handleUpdateDataChannel(e)}),this._gateway.signal.on(ie.ON_REMOTE_FULL_DATASTREAM_INFO,e=>{this._handleUpdateDataChannel({added:e.datastreams,deleted:[]},!0)}),this._gateway.signal.on(ie.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(ie.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(ie.MUTE_AUDIO,e=>this._handleMuteStream(e.uid,z.AUDIO,!0)),this._gateway.signal.on(ie.UNMUTE_AUDIO,e=>this._handleMuteStream(e.uid,z.AUDIO,!1)),this._gateway.signal.on(ie.MUTE_VIDEO,e=>this._handleMuteStream(e.uid,z.VIDEO,!0)),this._gateway.signal.on(ie.UNMUTE_VIDEO,e=>this._handleMuteStream(e.uid,z.VIDEO,!1)),this._gateway.signal.on(ie.RECEIVE_METADATA,e=>{const t=ns(e.metadata);this.safeEmit(_e.RECEIVE_METADATA,e.uid,t)}),this._gateway.signal.on(ie.ON_DATA_STREAM,async e=>{if(!e)return;let t=ns(e.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&["aes-128-gcm2","aes-256-gcm2"].includes(this._encryptionMode)){if(e.payload.length<ha)throw new N(C.UNEXPECTED_RESPONSE,"payload length ".concat(e.payload.length," is less than header length ").concat(ha));t=await LP(this._encryptDataStreamIv,this._encryptDataStreamKey,t)}let n=0;if(e.ordered||e.syncWithAudio){const i=this._p2pChannel.getStats(),r=this.remoteUsers.find(s=>s.uid===e.uid),o=i==null?void 0:i.audioRecv.find(s=>s.ssrc===(r==null?void 0:r._audioSSRC));n=o==null?void 0:o.jitterBufferMs}n==null&&(n=0),fU(F(F({},e),{},{payload:t}),n,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})}),this._gateway.signal.on(ie.ON_CRYPT_ERROR,()=>{Mo(()=>{f.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(_e.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(ie.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(ie.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{f.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,fe.TOKEN_EXPIRE),this.safeEmit(_e.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(ie.ON_STREAM_FALLBACK_UPDATE,e=>{f.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(e.stream_id,", attr: ").concat(e.stream_type)),this.safeEmit(_e.STREAM_FALLBACK,e.stream_id,e.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(ie.ON_PUBLISH_STREAM,e=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:e.proxy})),f.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(e))))}),this._gateway.signal.on(ie.ENABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!0)}),this._gateway.signal.on(ie.DISABLE_LOCAL_VIDEO,e=>{this._handleSetStreamLocalEnable("video",e.uid,!1)}),this._gateway.signal.on(H.REQUEST_TIMEOUT,(e,t)=>{if(this._joinInfo)switch(e){case $.PUBLISH:{if(!t)return;const r=t.ortc;if(r){var n,i;const o=r.some(c=>{let{stream_type:d}=c;return d===ve.Audio}),s=r.some(c=>{let{stream_type:d}=c;return d!==ve.Audio}),a=r.some(c=>{let{stream_type:d}=c;return d===ve.Screen||d===ve.ScreenLow});t.state==="offer"&&q.publish(this._joinInfo.sid,{eventElapse:nn.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:C.TIMEOUT,audio:o,video:s,p2pid:t.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:o?(n=r.find(c=>{let{stream_type:d}=c;return d===ve.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0,videoName:s?(i=r.find(c=>{let{stream_type:d}=c;return d!==ve.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0})}break}case $.SUBSCRIBE:t&&q.subscribe(this._joinInfo.sid,{succ:!1,ec:C.TIMEOUT,audio:t.stream_type===z.AUDIO,video:t.stream_type===z.VIDEO,peerid:t.stream_id,subscribeRequestid:t.ssrcId,p2pid:this.store.p2pId,eventElapse:nn.measureFromSubscribeStart(this.store.clientId,t.ssrcId)})}}),this._gateway.signal.on(ie.ON_P2P_OK,e=>{this.uid,this._uid}),this._gateway.signal.on(ie.ON_PUBLISHED_USER_LIST,e=>{if(e==null||!e.users)return;A("BLOCK_LOCAL_CLIENT")&&(e.users=e.users.filter(i=>!Go(i.string_id||i.stream_id,this.channelName)));const t=[],n=[];for(const i of e.users){let r=this._users.find(l=>l._uintid===i.stream_id);r?r._trust_in_room_=!0:(r=new ho(i.string_id||i.stream_id,i.stream_id),this._users.push(r),this.getListeners(_e.PUBLISHED_USER_LIST).length===0&&(f.debug("[".concat(this._clientId,"] user online"),i.stream_id),this.safeEmit(_e.USER_JOINED,r)));const o=Nt.Audio&i.stream_type,s=(Nt.Video|Nt.LwoVideo)&i.stream_type,a=(65280&i.stream_type)!=0,c=o&&r.hasAudio,d=s&&r.hasVideo;s&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=i.video_ssrc,r._rtxSsrcId=i.video_rtx),o&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=i.audio_ssrc),o&&!c&&this.getListeners(_e.PUBLISHED_USER_LIST).length===0&&(f.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(_e.USER_PUBLISHED,r,"audio")),s&&!d&&this.getListeners(_e.PUBLISHED_USER_LIST).length===0&&(f.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(_e.USER_PUBLISHED,r,"video")),(o&&!c||s&&!d||a)&&t.push(r),s&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&n.push({user:r,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&n.push({user:r,mediaType:"audio"})}n.length>0&&(f.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(n.map(i=>"user: ".concat(i.user.uid,", mediaType: ").concat(i.mediaType)).join("; ")," ")),this.massSubscribe(n).catch(i=>{f.error("[".concat(this._clientId,"] mass resubscribe error"),i.toString())})),this.getListeners(_e.PUBLISHED_USER_LIST).length>0?A("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=t:(f.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(t.map(i=>i.uid).join(", "))),this.safeEmit(_e.PUBLISHED_USER_LIST,t)):f.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(t.map(i=>i.uid).join(", ")))}),this._gateway.signal.on(ie.ON_RTP_CAPABILITY_CHANGE,e=>{const{video_codec:t}=e;this._p2pChannel instanceof Tl&&this._p2pChannel.updateRemoteRTPCapabilities(t.map(n=>n.toLowerCase()).filter(n=>Object.keys(wa).includes(n)))})}_handleP2PEvents(){this._gateway.signal.on(ie.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(at.PUBLISH,(e,t,n)=>{const{uid:i}=e;e.forEach(r=>{const{kind:o,ssrcs:s,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(o,i,s[0].ssrcId,a);const d=this._users.find(l=>l.uid===i);return d&&this._p2pChannel instanceof Vn?this._p2pChannel.mockSubscribe(d,o,s[0].ssrcId,a).then(()=>{t()}).catch(n):t(),this._handleMuteStream(i,o,!!c)})}),this._gateway.signal.on(at.CALL,async(e,t,n)=>{if(this._p2pChannel instanceof Vn)try{var i;t(await this._p2pChannel.startP2P({turnServer:(i=this._joinInfo)===null||i===void 0?void 0:i.turnServer},e))}catch(r){n(r)}}),this._gateway.signal.on(H.P2P_CONNECTION,async e=>{this._p2pChannel instanceof Vn&&await this._p2pChannel.p2pConnect(e)}),this._gateway.signal.on(at.UNPUBLISH,async(e,t,n)=>{if(this._p2pChannel instanceof Vn){const{unpubMsg:i,uid:r}=e,o=this._users.find(s=>s.uid===r);if(!o)return f.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void t();try{i.forEach(async s=>{let{stream_type:a}=s;const c=a===ve.Audio?z.AUDIO:z.VIDEO;await this._p2pChannel.unsubscribe(o,c),this._handleMuteStream(r,c,!0)}),t()}catch(s){n(s)}}}),this._gateway.signal.on(at.CONTROL,async(e,t)=>{const{action:n}=e;switch(n){case mo.MUTE_LOCAL_VIDEO:this._handleMuteStream(t,z.VIDEO,!0);break;case mo.MUTE_LOCAL_AUDIO:this._handleMuteStream(t,z.AUDIO,!0);break;case mo.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",t),this._handleMuteStream(t,z.VIDEO,!1);break;case mo.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",t),this._handleMuteStream(t,z.AUDIO,!1)}}),this._gateway.signal.on(at.RESTART_ICE,async(e,t,n)=>{if(this._p2pChannel instanceof Vn)try{const{direction:i,iceParameter:r}=e;i!==Rn.SEND_ONLY||r?t(await this._p2pChannel.restartICE(i,r)):(this._p2pChannel.handleDisconnect(i),t())}catch(i){n(i)}}),this._gateway.signal.on(at.CANDIDATE,e=>{if(this._p2pChannel instanceof Vn){const{candidate:t,direction:n}=e;this._p2pChannel.addRemoteCandidate(t,n)}}),this._p2pChannel.on(ee.RequestP2PRestartICE,async(e,t,n)=>{try{const{direction:i}=e;t(await this._gateway.sendExtensionMessage(at.RESTART_ICE,e,i===Rn.SEND_ONLY))}catch(i){n(i)}}),this._p2pChannel.on(ee.LocalCandidate,e=>{this._gateway.sendExtensionMessage(at.CANDIDATE,JSON.stringify(e),!0)}),this._p2pChannel.on(ee.RequestP2PMuteLocal,async(e,t,n)=>{try{await this._gateway.sendExtensionMessage(at.CONTROL,e,!0),t()}catch(i){n(i)}}),this._p2pChannel.on(ee.RequestP2PUnmuteRemote,async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===C.DISCONNECT_P2P?t():n(i)}else t()}),this._p2pChannel.on(ee.RequestP2PMuteRemote,async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteRemote(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===C.DISCONNECT_P2P?t():n(i)}else t()}),this._p2pChannel.on(ee.StateChange,(e,t)=>{t===we.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(ee.RequestMuteLocal,async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.muteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===C.DISCONNECT_P2P?t():n(i)}else t()}),this._p2pChannel.on(ee.RequestUnmuteLocal,async(e,t,n)=>{if(this._joinInfo)try{await this._gateway.unmuteLocal(e,this._joinInfo.stringUid||this._joinInfo.uid),t()}catch(i){i.code===C.DISCONNECT_P2P?t():n(i)}else t()}),this._p2pChannel.on(ee.RequestRePublish,(e,t,n)=>{this.publish(e,!1).then(t).catch(n)}),this._p2pChannel.on(ee.RequestRePublishDataChannel,(e,t,n)=>{Promise.all(e.map(async i=>{await this._p2pChannel.publishDataChannel([i]);const r={streamId:i.id,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:i.metadata,channelId:i._originDataChannelId};try{await this._gateway.publishDataChannel(this._uid,r,!0)}catch(o){if(o.code!==C.DISCONNECT_P2P)throw o}})).then(t).catch(n)}),this._p2pChannel.on(ee.RequestReSubscribe,async(e,t,n)=>{try{for(const{user:i,kind:r}of e)r===z.VIDEO?await this.subscribe(i,"video"):await this.subscribe(i,"audio");t()}catch(i){n(i)}}),this._p2pChannel.on(ee.RequestUpload,(e,t)=>{this._gateway.upload(e,t)}),this._p2pChannel.on(ee.RequestUploadStats,e=>{this._gateway.uploadWRTCStats(e)}),this._p2pChannel.on(ee.MediaReconnectStart,e=>{this.safeEmit(_e.MEDIA_RECONNECT_START,e)}),this._p2pChannel.on(ee.MediaReconnectEnd,e=>{this.safeEmit(_e.MEDIA_RECONNECT_END,e)}),this._p2pChannel.on(ee.NeedSignalRTT,e=>{e(this._gateway.getSignalRTT())}),this._p2pChannel.on(ee.RequestRestartICE,async e=>{if(this._p2pChannel instanceof Vn)return;const t=await this._p2pChannel.restartICE(e),n=await t.next();if(n.done)return;const i=n.value;let r;try{r=await this._gateway.restartICE({iceParameters:i})}catch(s){return void t.throw(s)}const{iceParameters:o}=function(s){const a=s.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}}(r);await t.next({remoteIceParameters:o})}),this._p2pChannel.on(ee.RequestReconnect,async()=>{this._gateway.reconnect()}),this._p2pChannel.on(ee.RequestReconnectPC,async()=>{var e;const{iceParameters:t,dtlsParameters:n,rtpCapabilities:i}=await this._p2pChannel.startP2PConnection({turnServer:(e=this._joinInfo)===null||e===void 0?void 0:e.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=await this._gateway.reconnectPC({iceParameters:t,dtlsParameters:n,rtpCapabilities:i}),{dtlsParameters:s,iceParameters:a,candidates:c,rtpCapabilities:d,setup:l,cname:u}=jR(r,o);await this._p2pChannel.connect(a,s,c,d,l,u),await this._p2pChannel.republish(),await this._p2pChannel.reSubscribe()}),this._p2pChannel.on(ee.RequestUnpublishForReconnectPC,async(e,t,n)=>{this._joinInfo&&this._uid!==void 0?(await this._gateway.unpublish(e,this._uid),t()):n()}),this._p2pChannel.on(ee.P2PLost,()=>{this.safeEmit(_e.P2P_LOST,this.store.uid)}),this._p2pChannel.on(ee.UpdateVideoEncoder,e=>{e._encoderConfig&&this._gateway.setVideoProfile(e._encoderConfig)}),this._p2pChannel.on(ee.ConnectionTypeChange,e=>{this.safeEmit(_e.IS_USING_CLOUD_PROXY,e)}),this._p2pChannel.on(ee.RequestLowStreamParameter,e=>{e(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(ee.QueryClientConnectionState,e=>{e(this.connectionState)})}getKeyMetrics(){return this.store.keyMetrics}async enableContentInspect(e){if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new N(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client did not join channel"));if(this._inspect)throw new N(C.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));if(!e)throw new N(C.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig is necessary"));if(!e.inspectType||!Array.isArray(e.inspectType))throw new N(C.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.inspectType is necessary and is an instance of Array."));{const t=[...new Set(e.inspectType)];t.forEach(n=>{if(!["supervise","moderation"].includes(n))throw new N(C.INVALID_PARAMS,"[".concat(this._clientId,"] ").concat(n," is not a valid inspect type."))}),e.inspectType=t}if(e&&e.extraInfo&&e.extraInfo.length>1024)throw new N(C.INVALID_PARAMS,"[".concat(this._clientId,"] inspectConfig.extraInfo length cannot exceed 1024 bytes"));try{const t=new Fu(e);this._inspect=t,this.handleVideoInspectEvents(this._inspect),await t.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},_t)}catch(t){throw Array.isArray(t)?t[0]:t}}async disableContentInspect(){if(!this._inspect)throw new N(C.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(e){throw Array.isArray(e)?e[0]:e}}async setImageModeration(e,t){if(Fr(e,"enabled"),e){if(!t)throw new N(C.INVALID_PARAMS,"[".concat(this._clientId,"] config is necessary"));if(De(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new N(C.INVALID_PARAMS,"[".concat(this._clientId,"] config.extraInfo length cannot exceed 1024 bytes"));if(t&&t.vendor&&t.vendor.length>1024)throw new N(C.INVALID_PARAMS,"[".concat(this._clientId,"] config.vendor length cannot exceed 1024 bytes"));if(this.connectionState!=="CONNECTED"||!this._joinInfo)throw new N(C.INVALID_OPERATION,"[".concat(this._clientId,'] can not enable image moderation, not joined"'));try{if(this._moderation)return void this._moderation.updateConfig(t);const n=new cm(t);this._moderation=n,this.handleImageModerationEvents(this._moderation),await n.init({appId:this._joinInfo.appId,areaCode:"",cname:this._joinInfo.cname,sid:this._joinInfo.sid,token:this._joinInfo.token,uid:this._joinInfo.uid,cid:this._joinInfo.cid,vid:this._joinInfo.vid?Number(this._joinInfo.vid):0},_t)}catch(n){throw Array.isArray(n)?n[0]:n}}else{if(!this._moderation)throw new N(C.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(n){throw Array.isArray(n)?n[0]:n}}}setP2PTransport(e){if(fP(e),this.mode!=="p2p")throw new N(C.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=e,f.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(e))}handleImageModerationEvents(e){e.on(Hi.CONNECTION_STATE_CHANGE,(t,n)=>{if(this.safeEmit(_e.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,t,n),t===ci.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new N(C.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");e.inspectImage()}}),e.on(Hi.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}handleVideoInspectEvents(e){e.on(Ut.CONNECTION_STATE_CHANGE,(t,n)=>{if(this.safeEmit(_e.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,t,n),n===Ii.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(_e.CONTENT_INSPECT_ERROR,new N(C.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));e.inspectImage()}}),e.on(Ut.INSPECT_RESULT,(t,n)=>{var i;if((n==null?void 0:n.code)===C.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return f.debug("Stop inspect content because that has left channel"),this==null||(i=this._inspect)===null||i===void 0||i.close(),void(this._inspect=void 0);this.safeEmit(_e.CONTENT_INSPECT_RESULT,t,n)}),e.on(Ut.CLIENT_LOCAL_VIDEO_TRACK,t=>{t(this.localTracks.filter(n=>n.trackMediaType==="video")[0])})}getJoinChannelServiceRecords(){return f.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}async setPublishAudioFilterEnabled(e){Fr(e,"enabled"),Fe("ENABLE_PUBLISH_AUDIO_FILTER",e),this._joinInfo&&await this._gateway.setPublishAudioFilterEnabled(e)}_handleResetAddStream(e,t){switch(t){case"audio":e._audio_added_=!1,e._trust_audio_stream_added_state_=!0;break;case"video":e._video_added_=!1,e._trust_video_stream_added_state_=!0}}}).prototype,"leave",[TC],Object.getOwnPropertyDescriptor(j.prototype,"leave"),j.prototype),B(j.prototype,"publish",[RC],Object.getOwnPropertyDescriptor(j.prototype,"publish"),j.prototype),B(j.prototype,"unpublish",[CC],Object.getOwnPropertyDescriptor(j.prototype,"unpublish"),j.prototype),B(j.prototype,"subscribe",[vC],Object.getOwnPropertyDescriptor(j.prototype,"subscribe"),j.prototype),B(j.prototype,"presubscribe",[IC],Object.getOwnPropertyDescriptor(j.prototype,"presubscribe"),j.prototype),B(j.prototype,"massSubscribe",[yC],Object.getOwnPropertyDescriptor(j.prototype,"massSubscribe"),j.prototype),B(j.prototype,"unsubscribe",[AC],Object.getOwnPropertyDescriptor(j.prototype,"unsubscribe"),j.prototype),B(j.prototype,"massUnsubscribe",[wC],Object.getOwnPropertyDescriptor(j.prototype,"massUnsubscribe"),j.prototype),B(j.prototype,"setLowStreamParameter",[NC],Object.getOwnPropertyDescriptor(j.prototype,"setLowStreamParameter"),j.prototype),B(j.prototype,"enableDualStream",[OC],Object.getOwnPropertyDescriptor(j.prototype,"enableDualStream"),j.prototype),B(j.prototype,"disableDualStream",[bC],Object.getOwnPropertyDescriptor(j.prototype,"disableDualStream"),j.prototype),B(j.prototype,"setClientRole",[DC],Object.getOwnPropertyDescriptor(j.prototype,"setClientRole"),j.prototype),B(j.prototype,"setProxyServer",[PC],Object.getOwnPropertyDescriptor(j.prototype,"setProxyServer"),j.prototype),B(j.prototype,"setTurnServer",[LC],Object.getOwnPropertyDescriptor(j.prototype,"setTurnServer"),j.prototype),B(j.prototype,"setLicense",[kC],Object.getOwnPropertyDescriptor(j.prototype,"setLicense"),j.prototype),B(j.prototype,"startProxyServer",[MC],Object.getOwnPropertyDescriptor(j.prototype,"startProxyServer"),j.prototype),B(j.prototype,"stopProxyServer",[UC],Object.getOwnPropertyDescriptor(j.prototype,"stopProxyServer"),j.prototype),B(j.prototype,"setLocalAccessPointsV2",[xC],Object.getOwnPropertyDescriptor(j.prototype,"setLocalAccessPointsV2"),j.prototype),B(j.prototype,"setLocalAccessPoints",[VC],Object.getOwnPropertyDescriptor(j.prototype,"setLocalAccessPoints"),j.prototype),B(j.prototype,"setRemoteDefaultVideoStreamType",[FC],Object.getOwnPropertyDescriptor(j.prototype,"setRemoteDefaultVideoStreamType"),j.prototype),B(j.prototype,"setRemoteVideoStreamType",[BC],Object.getOwnPropertyDescriptor(j.prototype,"setRemoteVideoStreamType"),j.prototype),B(j.prototype,"setStreamFallbackOption",[GC],Object.getOwnPropertyDescriptor(j.prototype,"setStreamFallbackOption"),j.prototype),B(j.prototype,"setEncryptionConfig",[jC],Object.getOwnPropertyDescriptor(j.prototype,"setEncryptionConfig"),j.prototype),B(j.prototype,"renewToken",[WC],Object.getOwnPropertyDescriptor(j.prototype,"renewToken"),j.prototype),B(j.prototype,"enableAudioVolumeIndicator",[HC],Object.getOwnPropertyDescriptor(j.prototype,"enableAudioVolumeIndicator"),j.prototype),B(j.prototype,"startLiveStreaming",[KC],Object.getOwnPropertyDescriptor(j.prototype,"startLiveStreaming"),j.prototype),B(j.prototype,"setLiveTranscoding",[zC],Object.getOwnPropertyDescriptor(j.prototype,"setLiveTranscoding"),j.prototype),B(j.prototype,"stopLiveStreaming",[YC],Object.getOwnPropertyDescriptor(j.prototype,"stopLiveStreaming"),j.prototype),B(j.prototype,"addInjectStreamUrl",[$C],Object.getOwnPropertyDescriptor(j.prototype,"addInjectStreamUrl"),j.prototype),B(j.prototype,"removeInjectStreamUrl",[qC],Object.getOwnPropertyDescriptor(j.prototype,"removeInjectStreamUrl"),j.prototype),B(j.prototype,"startChannelMediaRelay",[JC],Object.getOwnPropertyDescriptor(j.prototype,"startChannelMediaRelay"),j.prototype),B(j.prototype,"updateChannelMediaRelay",[XC],Object.getOwnPropertyDescriptor(j.prototype,"updateChannelMediaRelay"),j.prototype),B(j.prototype,"stopChannelMediaRelay",[QC],Object.getOwnPropertyDescriptor(j.prototype,"stopChannelMediaRelay"),j.prototype),B(j.prototype,"sendCustomReportMessage",[ZC],Object.getOwnPropertyDescriptor(j.prototype,"sendCustomReportMessage"),j.prototype),B(j.prototype,"pickSVCLayer",[ev],Object.getOwnPropertyDescriptor(j.prototype,"pickSVCLayer"),j.prototype),B(j.prototype,"setRTMConfig",[tv],Object.getOwnPropertyDescriptor(j.prototype,"setRTMConfig"),j.prototype),B(j.prototype,"enableContentInspect",[nv],Object.getOwnPropertyDescriptor(j.prototype,"enableContentInspect"),j.prototype),B(j.prototype,"disableContentInspect",[iv],Object.getOwnPropertyDescriptor(j.prototype,"disableContentInspect"),j.prototype),B(j.prototype,"setImageModeration",[rv],Object.getOwnPropertyDescriptor(j.prototype,"setImageModeration"),j.prototype),B(j.prototype,"setP2PTransport",[ov],Object.getOwnPropertyDescriptor(j.prototype,"setP2PTransport"),j.prototype),B(j.prototype,"getJoinChannelServiceRecords",[sv],Object.getOwnPropertyDescriptor(j.prototype,"getJoinChannelServiceRecords"),j.prototype),B(j.prototype,"setPublishAudioFilterEnabled",[av],Object.getOwnPropertyDescriptor(j.prototype,"setPublishAudioFilterEnabled"),j.prototype),j);function RU(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"};const t=q.reportApiInvoke(null,{name:an.CREATE_CLIENT,options:[e],tag:bt.TRACER});try{hP(e)}catch(n){throw t.onError(n),n}return(wA(16,0,!0)||NA(16,0,!0))&&(e.codec==="vp9"&&(e.codec="vp8",f.debug("browser not support vp9, force use vp8")),Fe("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),t.onSuccess(),new TU(F(F({forceWaitGatewayResponse:!0},e),{},{role:["rtc","p2p"].includes(e.mode)?"host":e.role||"audience"}))}class vd{constructor(t,n){this.id=0,this.element=void 0,this.peerPair=void 0,this.context=void 0,this.audioPlayerElement=void 0,this.audioTrack=void 0,vd.count+=1,this.id=vd.count,this.element=t,this.context=n}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=t=>{const n=document.createElement("audio");n.srcObject=new MediaStream([t.track]),n.play(),this.audioPlayerElement=n}}async switchSdp(){if(!this.peerPair)return;const t=async(i,r)=>{const o=r==="offer"?await i.createOffer():await i.createAnswer();return await i.setLocalDescription(o),i.iceGatheringState==="complete"?i.localDescription:new Promise(s=>{i.onicegatheringstatechange=()=>{i.iceGatheringState==="complete"&&s(i.localDescription)}})},n=async(i,r)=>await i.setRemoteDescription(r);try{const i=await t(this.peerPair[0],"offer");await n(this.peerPair[1],i);const r=await t(this.peerPair[1],"answer");await n(this.peerPair[0],r)}catch(i){throw new N(C.LOCAL_AEC_ERROR,i.toString()).print()}}async getTracksFromMediaElement(t){if(this.audioTrack)return this.audioTrack;let n;try{t instanceof HTMLVideoElement&&(t.captureStream?t.captureStream():t.mozCaptureStream()),n=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(t).connect(n)}catch(r){throw new N(C.LOCAL_AEC_ERROR,r.toString()).print()}if(!n)throw new N(C.LOCAL_AEC_ERROR,"no dest node when local aec").print();const i=n.stream.getAudioTracks()[0];return this.audioTrack=i,i}getElement(){return this.element}async startEchoCancellation(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();const t=this.element,n=await this.getTracksFromMediaElement(t);this.peerPair&&this.peerPair[0].addTrack(n),await this.switchSdp()}close(){f.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(t=>{t.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var cv,Cl;vd.count=0;const CU=window.AudioContext||window.webkitAudioContext;new(cv=Z({report:q}),B((Cl=class{constructor(){this.units=[],this.context=void 0}processExternalMediaAEC(e){if(!this._doesEnvironmentNeedAEC())return f.debug("the system does not need to process local aec"),-1;this.context||(this.context=new CU);let t=this.units.find(n=>n&&n.getElement()===e);return t||(t=new vd(e,this.context),this.units.push(t)),t.startEchoCancellation(),f.debug("start processing local audio echo cancellation, id is",t.id),t.id}_doesEnvironmentNeedAEC(){return Ie().name!==Ke.SAFARI}}).prototype,"processExternalMediaAEC",[cv],Object.getOwnPropertyDescriptor(Cl.prototype,"processExternalMediaAEC"),Cl.prototype),Cl);const Xp=window||document;function Pw(e){let t=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!Xp)return;const n=pt._cspEventHandlerPointer;if(n&&t)return void console.error(n,t);const i=r=>{if(!(r&&r.blockedURI&&(pt.onSecurityPolicyViolation||pt.getListeners(gr.SECURITY_POLICY_VIOLATION).length>0)))return;const o=r.blockedURI;A("CSP_DETECTED_HOSTNAME_LIST").some(s=>o.includes(s))&&(pt.onSecurityPolicyViolation&&typeof pt.onSecurityPolicyViolation=="function"&&pt.onSecurityPolicyViolation(r),pt.getListeners(gr.SECURITY_POLICY_VIOLATION).length>0&&pt.safeEmit(gr.SECURITY_POLICY_VIOLATION,r))};n&&Xp.removeEventListener("securitypolicyviolation",n),(t||e&&typeof e=="function"||pt.getListeners(gr.SECURITY_POLICY_VIOLATION).length>0)&&Xp.addEventListener("securitypolicyviolation",i),pt._cspEventHandlerPointer=i}Fe("PROCESS_ID",TP()),function(){let e;try{e=window.localStorage.getItem("websdk_ng_global_parameter")}catch(t){return void f.error("Error loading sdk config",t.message)}if(e)try{const t=JSON.parse(window.atob(e)),n=Date.now();f.debug("Loading global parameters from cache",t),Object.keys(t).forEach(i=>{if(Object.prototype.hasOwnProperty.call(Ct,i)){const{value:r,expires:o}=t[i];if(o&&o<=n)return;fo[i]=r,Ct[i]=r}})}catch(t){f.error("Error loading mutableParamsCache: ".concat(e),t.message)}}(),Array.isArray(fo.AREAS)&&fo.AREAS.length>0&&ow(fo.AREAS,!0);const pt=function(e){const t=new qe,n=e,i={getListeners:t.getListeners.bind(t),on:(r,o)=>(function(s,a){s===gr.SECURITY_POLICY_VIOLATION&&Pw(a,!0)}(r,o),t.on.bind(t)(r,o)),addListener:t.addListener.bind(t),once:t.once.bind(t),off:t.off.bind(t),removeAllListeners:t.removeAllListeners.bind(t),emit:t.emit.bind(t),safeEmit:t.safeEmit.bind(t)};return F(F({},n),i)}({});function vU(e){Zn.onAudioAutoplayFailed=e}function IU(e){Zn.onAutoplayFailed=e}function yU(e){pt.onCameraChanged=e}function AU(e){pt.onMicrophoneChanged=e}Object.defineProperties(pt,{onAudioAutoplayFailed:{get:()=>Zn.onAudioAutoplayFailed,set:vU},onAutoplayFailed:{get:()=>Zn.onAutoplayFailed,set:IU},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>pt._onSecurityPolicyViolation,set(e){pt._onSecurityPolicyViolation=e,Pw(e)}},__CLIENT_LIST__:{get:()=>A("SHOW_GLOBAL_CLIENT_LIST")?as:[]}}),Rr.on(ss.CAMERA_DEVICE_CHANGED,e=>{f.info("camera device changed",JSON.stringify(e)),pt.onCameraChanged&&pt.onCameraChanged(e),pt.safeEmit(gr.CAMERA_CHANGED,e)}),Rr.on(ss.RECORDING_DEVICE_CHANGED,e=>{f.info("microphone device changed",JSON.stringify(e)),pt.onMicrophoneChanged&&pt.onMicrophoneChanged(e),pt.safeEmit(gr.MICROPHONE_CHANGED,e)}),Rr.on(ss.PLAYOUT_DEVICE_CHANGED,e=>{f.debug("playout device changed",JSON.stringify(e)),pt.onPlaybackDeviceChanged&&pt.onPlaybackDeviceChanged(e),pt.safeEmit(gr.PLAYBACK_DEVICE_CHANGED,e)}),Bn.onAutoplayFailed=()=>{f.info("detect audio element autoplay failed"),Zn.onAudioAutoplayFailed&&Zn.onAudioAutoplayFailed()},Oe.on("autoplay-failed",()=>{f.info("detect webaudio autoplay failed"),Zn.onAudioAutoplayFailed&&Zn.onAudioAutoplayFailed(),pt.safeEmit(gr.AUTOPLAY_FAILED)}),Oe.on(Kt.STATE_CHANGE,(e,t)=>{f.info("audio context state changed: ".concat(t," => ").concat(e)),pt.onAudioContextStateChanged&&pt.onAudioContextStateChanged(e,t),pt.safeEmit(gr.AUDIO_CONTEXT_STATE_CHANGED,e,t)}),window&&(window.__ARTC__={ESM_BUNDLER:!0,ESM:!1,UMD:!1,DEV:!1,AgoraRTC:pt,__TRACK_LIST__:_d}),it.on(es.NETWORK_STATE_CHANGE,(e,t)=>{f.info("[network-indicator] network state changed, ".concat(t," => ").concat(e))});console.log("Current SDK VERSION: ",fi);const wU="5634944c8a88556f84e824bf36fcf12a",NU=new TextEncoder;function OU(e){const t=wU.split(""),n=NU.encode(e);return Array.from({length:32},(i,r)=>{const o=n[r]?n[r]%t.length:0,s=t[o];return t.splice(o,1),s}).join("")}yU(e=>{console.log("onCameraChanged: ",e)});AU(e=>{console.log("onMicrophoneChanged: ",e)});const Wo=RU({mode:"rtc",codec:"vp8"});let vl,hc;function bU(){const[e,t]=zi.useState(!1),[n,i]=zi.useState(!1),[r,o]=zi.useState(!1),[s,a]=zi.useState(!1),[c,d]=zi.useState(!1),l=async w=>{if(w=w??!n,i(w),hc)return hc.setEnabled(w);hc=await q1(),hc.play("camera-video")},u=async w=>{if(w=w??!e,t(w),vl)return vl.setEnabled(w);vl=await $1()},[h,p]=zi.useState(!1),m=zi.useRef("123"),E=zi.useRef(""),g=async()=>{m.current||(m.current="react-room"),h&&await S(),Wo.on("user-published",T),await Wo.join(OU(E.current),m.current,null,null),p(!0)},S=async()=>{p(!1),o(!1),a(!1),await Wo.leave()},T=async(w,D)=>{D==="video"&&((await Wo.subscribe(w,D)).play("remote-video"),d(!0)),D==="audio"&&(await Wo.subscribe(w,D)).play()},I=async()=>{await l(!0),h||await g(),await Wo.publish(hc),a(!0)},y=async()=>{await u(!0),h||await g(),await Wo.publish(vl),o(!0)};return en.jsxs(en.Fragment,{children:[en.jsxs("div",{className:"left-side",children:[en.jsx("h3",{children:"Pleat check you camera / microphone!"}),en.jsxs("div",{className:"buttons",children:[en.jsxs("button",{onClick:()=>l(),className:n?"button-on":"",children:["Turn ",n?"off":"on"," camera"]}),en.jsxs("button",{onClick:()=>u(),className:e?"button-on":"",children:["Turn ",e?"off":"on"," Microphone"]})]}),en.jsx("input",{defaultValue:E.current,placeholder:"!",onChange:w=>E.current=w.target.value}),en.jsx("br",{}),en.jsx("input",{defaultValue:m.current,placeholder:"Channel name",onChange:w=>m.current=w.target.value}),en.jsxs("div",{className:"buttons",children:[en.jsx("button",{onClick:g,className:h?"button-on":"",children:"Join Channel"}),en.jsx("button",{onClick:I,className:s?"button-on":"",children:"Publish Video"}),en.jsx("button",{onClick:y,className:r?"button-on":"",children:"Publish Audio"}),en.jsx("button",{onClick:S,children:"Leave Channel"})]})]}),en.jsxs("div",{className:"right-side",children:[en.jsx("video",{id:"camera-video",hidden:!n}),en.jsx("video",{id:"remote-video",hidden:!c}),h&&!c?en.jsxs("div",{className:"waiting",children:["You can shared channel ",m.current," to others....."]}):null]})]})}Zp.createRoot(document.getElementById("root")).render(en.jsx(Jw.StrictMode,{children:en.jsx(bU,{})}));
